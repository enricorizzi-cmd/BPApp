function Qt(){import.meta.url,import("_").catch(()=>1),(async function*(){})().next()}(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const ue of document.querySelectorAll('link[rel="modulepreload"]'))ce(ue);new MutationObserver(ue=>{for(const ve of ue)if(ve.type==="childList")for(const we of ve.addedNodes)we.tagName==="LINK"&&we.rel==="modulepreload"&&ce(we)}).observe(document,{childList:!0,subtree:!0});function U(ue){const ve={};return ue.integrity&&(ve.integrity=ue.integrity),ue.referrerPolicy&&(ve.referrerPolicy=ue.referrerPolicy),ue.crossOrigin==="use-credentials"?ve.credentials="include":ue.crossOrigin==="anonymous"?ve.credentials="omit":ve.credentials="same-origin",ve}function ce(ue){if(ue.ep)return;ue.ep=!0;const ve=U(ue);fetch(ue.href,ve)}})();function ze(s,a){localStorage.setItem(s,typeof a=="string"?a:JSON.stringify(a))}function it(s,a){const U=localStorage.getItem(s);if(U==null)return a;try{return JSON.parse(U)}catch(ce){return U}}function et(s){localStorage.removeItem(s)}function Ft(s,a){a?ze("bp_token",s):sessionStorage.setItem("bp_token",s)}function ot(){return localStorage.getItem("bp_token")||sessionStorage.getItem("bp_token")||""}function Lt(s){ze("bp_user",s)}function fe(){return it("bp_user",null)||null}function Vt(){et("bp_token"),sessionStorage.removeItem("bp_token"),et("bp_user"),location.href="/?v=13"}function _t(s,a={}){a.method=a.method||"GET";const U={...a.headers||{}},ce=ot();return ce&&(U.Authorization="Bearer "+ce),a.body!=null&&typeof a.body!="string"&&(U["Content-Type"]="application/json; charset=utf-8",a.body=JSON.stringify(a.body)),a.headers=U,fetch(s,a).then(Ot)}async function Ot(s){const a=await s.text();if(!s.ok)throw Rt(a,s);return Ut(a,s)}function Rt(s,a){try{const U=JSON.parse(s).error||"";return new Error(U||a.statusText||"HTTP "+a.status)}catch(U){return new Error(a.statusText||"HTTP "+a.status)}}function Ut(s,a){try{if((a.headers.get("content-type")||"").toLowerCase().indexOf("application/json")!==-1)return s?JSON.parse(s):{}}catch(U){}return s}function re(s,a){return _t(s,Object.assign({method:"GET"},{}))}function Fe(s,a){return _t(s,{method:"POST",body:a||{}})}function Le(s){return(s<10?"0":"")+s}function tt(s){const a=new Date(s);return Le(a.getDate())+"/"+Le(a.getMonth()+1)+"/"+a.getFullYear()}function Ge(s){const a=new Date(s);return a.getFullYear()+"-"+Le(a.getMonth()+1)+"-"+Le(a.getDate())}function ht(s){const a=new Date(s);return Le(a.getHours())+":"+Le(a.getMinutes())}function Ht(s){const a=new Date(s);a.setHours(0,0,0,0);const U=(a.getDay()+6)%7;return a.setDate(a.getDate()-U),a}function vt(s){const a=new Date(s);return new Date(a.getFullYear(),a.getMonth(),1)}function mt(s){const a=new Date(s);return new Date(a.getFullYear(),a.getMonth()+1,0,23,59,59,999)}function ye(s){const a=new Date(Date.UTC(s.getFullYear(),s.getMonth(),s.getDate())),U=a.getUTCDay()||7;a.setUTCDate(a.getUTCDate()+4-U);const ce=new Date(Date.UTC(a.getUTCFullYear(),0,1));return Math.ceil(((a-ce)/864e5+1)/7)}function lt(s){const a=new Date(s),U=Math.floor(a.getMonth()/3);return new Date(a.getFullYear(),U*3,1)}function pt(s){const a=lt(s);return new Date(a.getFullYear(),a.getMonth()+3,0,23,59,59,999)}function st(s){const a=new Date(s),U=a.getMonth()<6?0:6;return new Date(a.getFullYear(),U,1)}function ft(s){const a=st(s);return new Date(a.getFullYear(),a.getMonth()+6,0,23,59,59,999)}function bt(s){const a=new Date(s);return new Date(a.getFullYear(),0,1)}function rt(s){const a=new Date(s);return new Date(a.getFullYear(),11,31,23,59,59,999)}function Yt(s,a){const U=new Date(s,0,1+(a-1)*7),ce=U.getDay()||7,ue=new Date(U);return ue.setDate(U.getDate()-(ce-1)),ue.setHours(0,0,0,0),ue}function $e(s,a){const U=Yt(s,a),ce=new Date(U);return ce.setDate(U.getDate()+6),ce.setHours(23,59,59,999),{start:U,end:ce}}function Gt(s){const a=Ht(s);a.setDate(a.getDate()+7);const U=new Date(a);return U.setDate(a.getDate()+6),U.setHours(23,59,59,999),{start:a,end:U}}function zt(s){const a=new Date(s.getFullYear(),s.getMonth()+1,1);return{start:a,end:new Date(a.getFullYear(),a.getMonth()+1,0,23,59,59,999)}}function qt(s){const a=lt(new Date(s.getFullYear(),s.getMonth()+3,1));return{start:a,end:new Date(a.getFullYear(),a.getMonth()+3,0,23,59,59,999)}}function jt(s){const a=st(new Date(s.getFullYear(),s.getMonth()+6,1));return{start:a,end:new Date(a.getFullYear(),a.getMonth()+6,0,23,59,59,999)}}function Wt(s){const a=bt(new Date(s.getFullYear()+1,0,1));return{start:a,end:rt(a)}}function nt(s,a){const U=new Date(a);return s==="settimanale"?"Sett. "+ye(new Date(a))+" "+U.getFullYear():s==="mensile"?U.toLocaleString("it-IT",{month:"long",year:"numeric"}):s==="trimestrale"?"Trimestre "+(Math.floor(U.getMonth()/3)+1)+" "+U.getFullYear():s==="semestrale"?(U.getMonth()<6?"1°":"2°")+" semestre "+U.getFullYear():s==="annuale"?"Anno "+U.getFullYear():s==="ytd"?"YTD "+U.getFullYear():s==="ltm"?"Ultimi 12 mesi":s}let Re;function $t(){return Re||(Re=document.getElementById("toast-container"),Re||(Re=document.createElement("div"),Re.id="toast-container",Re.setAttribute("role","status"),Re.setAttribute("aria-live","polite"),document.body.appendChild(Re))),Re}function X(s){const a=$t(),U=document.createElement("div");U.className="toast",U.setAttribute("role","alert"),U.textContent=s,a.appendChild(U),setTimeout(function(){try{U.remove(),a.children.length||(a.remove(),Re=null)}catch(ce){}},2200)}function at(){if(window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches)return;const s=document.createElement("div");s.className="confetti",document.body.appendChild(s);for(let a=0;a<26;a++){const U=document.createElement("span");U.style.position="absolute",U.style.left=2+a*4+"%",U.style.top="0",U.style.width="6px",U.style.height="10px",U.style.background="hsl("+a*14+",90%,60%)",U.style.opacity="0.95",s.appendChild(U),(function(ce,ue){setTimeout(function(){ce.animate&&ce.animate([{transform:"translateY(-20px) rotate(0deg)"},{transform:"translateY(110vh) rotate(540deg)"}],{duration:1200+Math.random()*800,easing:"cubic-bezier(.2,.6,.2,1)"})},ue)})(U,a*35)}setTimeout(function(){try{s.remove()}catch(a){}},2500)}function pe(s){return String(s).replace(/[&<>'"]/g,function(a){return{"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"}[a]})}function Ye(s){return(Number(s)||0).toLocaleString("it-IT")+"€"}function Ee(s){const a=Number(s)||0;return String(Math.round(a))}function Xt(){if(document.getElementById("bp-mobile-drawer-fix"))return;const s="\n  @media (max-width:980px){\n    .topbar{\n      background: rgba(20,24,34,.90) !important;\n      border-bottom: 1px solid rgba(255,255,255,.08) !important;\n    }\n    .drawer{\n      background: rgba(20,24,34,.96) !important;\n      box-shadow: 14px 0 28px rgba(0,0,0,.45) !important;\n      width: 86vw !important;\n      overflow-y: auto !important;\n    }\n    .drawer .row{ gap:10px !important; }\n    .drawer button{\n      background: rgba(255,255,255,.10) !important;\n      border: 1px solid rgba(255,255,255,.22) !important;\n      color: #fff !important;\n      padding: 12px 14px !important;\n      font-weight: 700 !important;\n      border-radius: 12px !important;\n      -webkit-tap-highlight-color: transparent;\n    }\n    .drawer button:hover{\n      background: rgba(255,255,255,.14) !important;\n      border-color: rgba(255,255,255,.30) !important;\n    }\n    .drawer button.ghost{\n      background: rgba(255,255,255,.10) !important;\n      box-shadow: none !important;\n    }\n  }",a=document.createElement("style");a.id="bp-mobile-drawer-fix",a.textContent=s,document.head.appendChild(a)}function Zt(){if(document.getElementById("bp-mobile-light-fix"))return;const s="\n    @media (max-width:980px) and (prefers-color-scheme: light){\n      .topbar{\n        background:#fff !important;\n        border-bottom:1px solid rgba(0,0,0,.08) !important;\n        box-shadow:none !important;\n      }\n      .topbar .brand .logo{\n        color:#0f172a !important;\n        font-weight:900 !important;\n        letter-spacing:.4px;\n        text-shadow:none !important;\n        opacity:1 !important;\n      }\n      .topbar .hamb span{ background:#0f172a !important; }\n      .card{\n        background:#fff !important;\n        background-image:none !important;\n        box-shadow:none !important;\n      }\n      .drawer{\n        background:#fff !important;\n        box-shadow:14px 0 28px rgba(0,0,0,.10) !important;\n      }\n      .drawer button{\n        color:#0f172a !important;\n        background:rgba(0,0,0,.04) !important;\n        border:1px solid rgba(0,0,0,.12) !important;\n      }\n      .drawer button:hover{\n        background:rgba(0,0,0,.08) !important;\n      }\n    }\n  ",a=document.createElement("style");a.id="bp-mobile-light-fix",a.textContent=s,document.head.appendChild(a)}function Jt(){if(document.getElementById("bp-badge-light-css"))return;const s="\n    @media (prefers-color-scheme: light){\n      .badge{\n        background: linear-gradient(180deg, #eef2ff, #f8fafc) !important;\n        border: 1px solid #c7d2fe !important;\n        color: #0f172a !important;\n        font-weight: 700 !important;\n        padding: 6px 10px !important;\n        border-radius: 9999px !important;\n        letter-spacing: .2px !important;\n        box-shadow: 0 1px 0 rgba(15,23,42,.05) inset !important;\n      }\n      .chip, .tag{\n        background: #ffffff !important;\n        border: 1px solid #cbd5e1 !important;\n        color: #0f172a !important;\n        font-weight: 600 !important;\n        border-radius: 9999px !important;\n      }\n      .card .badge{\n        background: #fff !important;\n      }\n    }\n  ",a=document.createElement("style");a.id="bp-badge-light-css",a.textContent=s,document.head.appendChild(a)}function Pe(){const s=fe();if(!s)return"";const a=s.role==="admin",U='<span class="badge">Lvl '+(window.level?window.level():"")+" · XP "+(window.getXP?window.getXP():"")+"</span>",ce='<div id="drawer" class="drawer" role="dialog" aria-modal="true" aria-label="Menu"><div class="row"><button class="ghost" onclick="viewHome();toggleDrawer(false)">Dashboard</button><button class="ghost" onclick="viewCalendar();toggleDrawer(false)">Calendario</button><button class="ghost" onclick="viewPeriods();toggleDrawer(false)">BP</button><button class="ghost" onclick="viewAppointments();toggleDrawer(false)">Appuntamenti</button><button class="ghost" onclick="viewLeaderboard();toggleDrawer(false)">Classifiche</button><button class="ghost" onclick="viewCommissions();toggleDrawer(false)">Provvigioni</button><button class="ghost" onclick="viewVendite();toggleDrawer(false)">Vendite e Riordini</button><button class="ghost" onclick="viewGI();toggleDrawer(false)">GI &amp; Scadenzario</button><button class="ghost" onclick="viewReport();toggleDrawer(false)">Report</button><button class="ghost" onclick="viewClients();toggleDrawer(false)">Clienti</button><button class="ghost" onclick="viewTeam();toggleDrawer(false)">Squadra</button>'+(a?'<button class="ghost" onclick="viewUsers();toggleDrawer(false)">Utenti</button>':"")+'<button onclick="logout()">Logout</button></div></div>';return'<div class="topbar"><div class="brand"><button class="hamb" id="hamb" aria-label="Apri menu" aria-controls="drawer" aria-expanded="false"><span></span><span></span><span></span></button><div class="logo">BATTLE PLAN</div></div><div class="nav right">'+U+'<button class="ghost" onclick="viewHome()">Dashboard</button><button class="ghost" onclick="viewCalendar()">Calendario</button><button class="ghost" onclick="viewPeriods()">BP</button><button class="ghost" onclick="viewAppointments()">Appuntamenti</button><button class="ghost" onclick="viewLeaderboard()">Classifiche</button><button class="ghost" onclick="viewCommissions()">Provvigioni</button><button class="ghost" onclick="viewVendite()">Vendite e Riordini</button><button class="ghost" onclick="viewGI()">GI &amp; Scadenzario</button><button class="ghost" onclick="viewReport()">Report</button><button class="ghost" onclick="viewClients()">Clienti</button><button class="ghost" onclick="viewTeam()">Squadra</button>'+(a?'<button class="ghost" onclick="viewUsers()">Utenti</button>':"")+'<button onclick="logout()">Logout</button></div></div>'+ce}function xe(){if(!fe())return;if(!document.getElementById("bp_nav_contrast_css")){const ve="\n      @media (min-width: 1024px){\n        .topbar .nav .ghost{\n          background: rgba(255,255,255,.06);\n          border: 1px solid rgba(255,255,255,.18);\n        }\n        .topbar .nav .ghost:hover{\n          background: rgba(255,255,255,.12);\n        }\n      }\n    ",we=document.createElement("style");we.id="bp_nav_contrast_css",we.textContent=ve,document.head.appendChild(we)}const s=document.getElementById("app"),a=document.querySelector(".topbar"),U=Pe();a?a.outerHTML=U:s&&s.insertAdjacentHTML("afterbegin",U);try{Xt()}catch(ve){}try{Zt()}catch(ve){}try{Jt()}catch(ve){}if(!document.getElementById("bp-unified-filters-css")){const ve="\n      /* Nested inputs align in two columns inside unified filters */\n      .uf .row .row{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }\n\n      @media (max-width: 980px){\n        .uf input, .uf select{ min-width: 0; width: 100%; }\n        .uf .row > div{ flex: 1 1 180px; min-width: 0; }\n\n        /* Squadra admin bar: grid on small screens */\n        #t_adminbar{ display:grid !important; grid-template-columns: 1fr 1fr; align-items:end; gap:10px; }\n        #t_adminbar > div{ min-width: 0; }\n        #t_adminbar .row{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }\n      }\n\n      @media (max-width: 560px){\n        #t_adminbar{ grid-template-columns: 1fr; }\n      }\n    ",we=document.createElement("style");we.id="bp-unified-filters-css",we.textContent=ve,document.head.appendChild(we)}const ce=document.getElementById("hamb");ce&&(ce.onclick=function(){dt()});const ue=document.getElementById("drawer");ue&&ue.addEventListener("click",function(ve){ve.target.id==="drawer"&&dt(!1)}),document.removeEventListener("keydown",yt,!1),document.addEventListener("keydown",yt,!1)}function yt(s){if(s&&s.key==="Escape"){const a=document.getElementById("drawer");a&&a.classList.contains("open")&&dt(!1)}}function dt(s){const a=document.getElementById("drawer");if(!a)return;const U=typeof s=="boolean"?s:!a.classList.contains("open");a.classList.toggle("open",U);const ce=document.getElementById("hamb");ce&&ce.setAttribute("aria-expanded",String(U)),document.body.classList.toggle("no-scroll",U)}let wt=null;function Kt(){clearTimeout(wt),wt=setTimeout(xe,60)}function Ve(s){return document.querySelector(s)}function gt(s){return Array.from(document.querySelectorAll(s))}(function(){const s=window.BP=window.BP||{},a=s.ICS=s.ICS||{};function U(K){if(!K)return"";if(/[Zz]|[+\-]\d{2}:\d{2}$/.test(String(K)))return new Date(K).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z").slice(0,15)+"Z";const[he,_e="00:00"]=String(K).split("T"),[Ie,me,Ue]=he.split("-").map(Number),[De,Oe]=_e.split(":").map(Number);return new Date(Ie,me-1,Ue,De,Oe,0,0).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z").slice(0,15)+"Z"}function ce(K){return(K||"").replace(/\\/g,"\\\\").replace(/;/g,"\\;").replace(/,/g,"\\,").replace(/\n/g,"\\n")}function ue(K){if(K.length<=74)return[K];const _e=[];let Ie=0;for(;Ie<K.length;){const me=K.slice(Ie,Ie+74);_e.push(Ie===0?me:" "+me),Ie+=74}return _e}function ve(K){const he=(K&&K.id||"bp-"+Date.now())+"@bpapp",_e=K&&K.client?"Appuntamento · "+K.client:"Appuntamento",Ie=U(K&&K.start),me=U(K&&K.end),Ue=U(new Date().toISOString().slice(0,16)),De=[];K&&K.type&&De.push("Tipo: "+K.type),K&&K.vss&&De.push("VSS: "+K.vss),K&&K.vsdPersonal&&De.push("VSD Personale: "+K.vsdPersonal),K&&K.notes&&De.push("Note: "+K.notes);const Oe=ce(De.join("\n")),Me=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//BPApp//Calendario//IT","CALSCALE:GREGORIAN","METHOD:PUBLISH","BEGIN:VEVENT","UID:"+he,"DTSTAMP:"+Ue,Ie?"DTSTART:"+Ie:"",me?"DTEND:"+me:"","SUMMARY:"+ce(_e),Oe?"DESCRIPTION:"+Oe:"","END:VEVENT","END:VCALENDAR"].filter(Boolean),Ze=[];return Me.forEach(ct=>Ze.push.apply(Ze,ue(ct))),Ze.join("\r\n")}function we(){try{const K=navigator.userAgent||navigator.vendor||"",he=/iP(ad|hone|od)/.test(K),_e=/^((?!chrome|android|crios|fxios|edgi).)*safari/i.test(K);return he||_e}catch(K){return!1}}function Xe(K){try{const he=ve(K),_e=K&&K.start?String(K.start).split("T")[0]:"evento",Ie=(K&&K.client||"appuntamento").trim().replace(/[^\w\-]+/g,"_").slice(0,40),me="bp_".concat(Ie,"_").concat(_e,".ics");if(we())try{const Oe="data:text/calendar;charset=utf-8,"+encodeURIComponent(he),Me=document.createElement("a");return Me.href=Oe,Me.setAttribute("target","_blank"),Me.setAttribute("download",me),document.body.appendChild(Me),Me.click(),Me.remove(),!0}catch(Oe){try{return window.location.assign("data:text/calendar;charset=utf-8,"+encodeURIComponent(he)),!0}catch(Me){try{logger.error(Me)}catch(Ze){}return!1}}const Ue=new Blob([he],{type:"text/calendar;charset=utf-8"}),De=document.createElement("a");return De.href=URL.createObjectURL(Ue),De.download=me,document.body.appendChild(De),De.click(),setTimeout(()=>{try{URL.revokeObjectURL(De.href)}catch(Oe){}De.remove()},50),!0}catch(he){try{logger.error(he)}catch(_e){}return!1}}a.makeIcsForAppointment=ve,a.downloadIcsForAppointment=Xe,window.icsFromAppt=window.icsFromAppt||function(K){return ve(K)},window.downloadICS=window.downloadICS||function(K,he){try{var _e=window.__icsSanitize?__icsSanitize(K):K||"evento";/\.ics$/i.test(_e)||(_e+=".ics");var Ie=new Blob([he],{type:"text/calendar;charset=utf-8"}),me=document.createElement("a");me.href=URL.createObjectURL(Ie),me.download=_e,document.body.appendChild(me),me.click(),setTimeout(function(){URL.revokeObjectURL(me.href),me.remove()},50)}catch(Ue){logger.error(Ue)}}})();(function(){var s=document.getElementById("app");window.$1=window.$1||Ve,window.$all=window.$all||gt,window.addXP=window.addXP||function(){},typeof window.logger!="object"&&(window.logger=["debug","info","log","warn","error"].reduce((e,i)=>(e[i]=(console[i]||console.log).bind(console),e),{})),typeof window.haptic!="function"&&(window.haptic=function(){}),(function(){const e=window.__miniCharts=window.__miniCharts||{};function i(r,M,f){const m=r.getContext("2d");r.width=r.clientWidth||320,r.height=r.clientHeight||80,m.clearRect(0,0,r.width,r.height);const T=Math.max(1,...f),Q=f.length>1?(r.width-8)/(f.length-1):0;m.strokeStyle="#2e6cff",m.lineWidth=2,m.beginPath();for(let _=0;_<f.length;_++){const R=4+_*Q,D=r.height-6-f[_]/T*(r.height-12);_===0?m.moveTo(R,D):m.lineTo(R,D)}m.stroke(),m.fillStyle="#2e6cff";for(let _=0;_<f.length;_++){const R=4+_*Q,D=r.height-6-f[_]/T*(r.height-12);m.beginPath(),m.arc(R,D,2,0,Math.PI*2),m.fill()}}function B(r,M){try{const f=Array.isArray(r)?r.length:0;if(!f)return{autoSkip:!0,maxRotation:0,minRotation:0};const m=Math.max(0,...r.map(_=>String(_||"").length)),T=Math.max(28,Math.min(90,Math.round(m*7)));return f*T>(M||320)*1.2?{autoSkip:!0,maxRotation:45,minRotation:45,callback:_=>String(_||"")}:{autoSkip:!0,maxRotation:0,minRotation:0,callback:_=>String(_||"")}}catch(f){return{autoSkip:!0,maxRotation:0,minRotation:0}}}window.computeTickOptions=B,window.drawFullLine=function(r,M,f){const m=document.getElementById(r);if(!m)return;if(m.width=m.clientWidth||m.width||320,m.height=m.clientHeight||m.height||80,typeof Chart>"u"){i(m,M,f);return}const T=String(r),Q=B(M,m.width||320);if(e[T]&&e[T].canvas!==m){try{e[T].destroy()}catch(_){}delete e[T]}if(e[T]){const _=e[T];_.data.labels=M,_.data.datasets[0].data=f,_.options.scales.x.ticks=B(M,m.width||320),_.update()}else{const _=m.getContext("2d");e[T]=new Chart(_,{type:"line",data:{labels:M,datasets:[{label:"",data:f,borderColor:"#2e6cff",backgroundColor:"rgba(46,108,255,0.10)",borderWidth:2,tension:.3,pointRadius:3,pointHoverRadius:5,fill:!1}]},options:{responsive:!1,maintainAspectRatio:!1,animation:!1,animations:!1,plugins:{legend:{display:!1}},scales:{x:{grid:{display:!1},ticks:Q},y:{beginAtZero:!0}}}})}}})();function a(){document.title="Battle Plan – Login";var e='<div class="hero" id="hero"><div class="layer glow"></div><div class="layer grid"></div><div class="title">Pianifica. Eroga. Vinci. <span class="small muted">BP – stile gaming</span></div></div><div class="wrap"><div class="grid"><div class="card"><h3>Accedi</h3><form id="loginForm" autocomplete="on"><div class="row"><div><label>Email</label><input id="li_email" name="email" type="email" autocomplete="username" required></div><div><label>Password</label><input id="li_password" name="password" type="password" autocomplete="current-password" required></div></div><div class="row"><label class="small"><input type="checkbox" id="li_remember" checked> Rimani collegato</label></div><div class="right" style="margin-top:8px"><button type="submit" id="btnLogin">Accedi</button></div></form></div><div class="card"><h3>Registrati</h3><form id="regForm" autocomplete="on"><div class="row"><div><label>Nome</label><input id="re_name" name="name" type="text" required></div><div><label>Email</label><input id="re_email" name="email" type="email" autocomplete="username" required></div><div><label>Password</label><input id="re_password" name="new-password" type="password" autocomplete="new-password" required></div></div><div class="right" style="margin-top:8px"><button type="submit" id="btnRegister">Registrati</button></div></form></div></div></div>';s.innerHTML=e;var i=document.getElementById("hero");i&&i.addEventListener("pointermove",function(M){var f=i.getBoundingClientRect();i.style.setProperty("--gx",(M.clientX-f.left)/f.width*100+"%"),i.style.setProperty("--gy",(M.clientY-f.top)/f.height*100+"%")});var B=document.getElementById("loginForm"),r=document.getElementById("regForm");B.addEventListener("submit",function(M){M.preventDefault();var f=document.getElementById("btnLogin");f.disabled=!0;var m=document.getElementById("li_email").value.trim().toLowerCase(),T=document.getElementById("li_password").value,Q=document.getElementById("li_remember").checked;Fe("/api/login",{email:m,password:T}).then(function(_){if(typeof _=="string")try{_=JSON.parse(_)}catch(R){}Ft(_.token,Q),Lt(_.user),X("Bentornato "+_.user.name+"!"),window.addXP(10),he(),xe(),window.BPPush&&window.BPPush.subscribe()},function(_){X("Credenziali errate"),logger.error(_)}).catch(function(_){logger.error(_)}).finally(function(){f.disabled=!1})}),r.addEventListener("submit",function(M){M.preventDefault();var f=document.getElementById("btnRegister");f.disabled=!0;var m=document.getElementById("re_name").value.trim(),T=document.getElementById("re_email").value.trim().toLowerCase(),Q=document.getElementById("re_password").value;Fe("/api/register",{name:m,email:T,password:Q}).then(function(){X("Registrazione ok. Ora accedi"),at(),window.addXP(20),window.scrollTo({top:0,behavior:"smooth"})}).catch(function(_){X("Email già registrata?"),logger.error(_)}).finally(function(){f.disabled=!1})})}function U(e){const i=new Date().getFullYear(),B=new Date().getMonth()+1,r=ye(new Date);return'<div class="uf"><div class="row"><div><label>Granularità</label><select id="'+e+'_gran"><option value="settimanale">Settimanale</option><option value="mensile" selected>Mensile</option><option value="trimestrale">Trimestrale</option><option value="semestrale">Semestrale</option><option value="annuale">Annuale</option><option value="ytd">Anno corrente (YTD)</option><option value="ltm">Ultimi 12 mesi (LTM)</option></select></div><div id="'+e+'_wrap_week" style="display:none"><label>Settimana ISO</label><div class="row"><input type="number" id="'+e+'_week" min="1" max="53" value="'+r+'"><input type="number" id="'+e+'_year_w" min="2000" max="2100" value="'+i+'"></div></div><div id="'+e+'_wrap_month"><label>Mese</label><div class="row"><input type="number" id="'+e+'_month" min="1" max="12" value="'+B+'"><input type="number" id="'+e+'_year_m" min="2000" max="2100" value="'+i+'"></div></div><div id="'+e+'_wrap_quarter" style="display:none"><label>Trimestre</label><div class="row"><input type="number" id="'+e+'_quarter" min="1" max="4" value="'+Math.floor((B-1)/3)+1+'"><input type="number" id="'+e+'_year_q" min="2000" max="2100" value="'+i+'"></div></div><div id="'+e+'_wrap_sem" style="display:none"><label>Semestre</label><div class="row"><select id="'+e+'_sem"><option value="1">1°</option><option value="2">2°</option></select><input type="number" id="'+e+'_year_s" min="2000" max="2100" value="'+i+'"></div></div><div id="'+e+'_wrap_year" style="display:none"><label>Anno</label><input type="number" id="'+e+'_year" min="2000" max="2100" value="'+i+'"></div><div style="align-self:flex-end"><button id="'+e+'_refresh" class="ghost">Aggiorna</button></div></div></div>'}(function(){const e=[];window.onUnifiedRangeChange=function(i){typeof i=="function"&&e.push(i)},window.emitUnifiedRangeChange=function(i){for(const B of e)try{B(i)}catch(r){logger.error(r)}}})();function ce(e){return e==="d"||e==="dash"?"dash":e==="cm"||e==="comm"?"comm":e==="tg"||e==="t"||e==="team"?"t":e}function ue(e,i){function B(){const M=document.getElementById(e+"_gran").value;["week","month","quarter","sem","year"].forEach(m=>{const T=document.getElementById(e+"_wrap_"+m);T&&(T.style.display="none")}),M==="settimanale"?document.getElementById(e+"_wrap_week").style.display="":M==="mensile"?document.getElementById(e+"_wrap_month").style.display="":M==="trimestrale"?document.getElementById(e+"_wrap_quarter").style.display="":M==="semestrale"?document.getElementById(e+"_wrap_sem").style.display="":M==="annuale"&&(document.getElementById(e+"_wrap_year").style.display="")}["gran","week","year_w","month","year_m","quarter","year_q","sem","year_s","year"].forEach(M=>{const f=document.getElementById(e+"_"+M);f&&(f.onchange=()=>{B(),i&&i(),window.emitUnifiedRangeChange(ce(e))},f.oninput=()=>{B()})});const r=document.getElementById(e+"_refresh");r&&(r.onclick=()=>{i&&i(),window.emitUnifiedRangeChange(ce(e))}),B()}function ve(e){var i=new Date;function B(b,t){var P=document.getElementById(e+"_"+b),I=P?parseInt(P.value,10):NaN;return isFinite(I)?I:t}var r=document.getElementById(e+"_gran"),M=r?r.value:"mensile",f={type:M,start:null,end:null};if(M==="settimanale"){var m=B("year_w",i.getFullYear()),T=Math.max(1,Math.min(53,B("week",ye(i)))),Q=$e(m,T);return f.start=Q.start,f.end=Q.end,f}if(M==="mensile"){var _=B("year_m",i.getFullYear()),R=Math.max(1,Math.min(12,B("month",i.getMonth()+1)));return f.start=new Date(_,R-1,1),f.end=new Date(_,R,0,23,59,59,999),f}if(M==="trimestrale"){var D=B("year_q",i.getFullYear()),C=Math.max(1,Math.min(4,B("quarter",Math.floor(i.getMonth()/3)+1)));return f.start=new Date(D,(C-1)*3,1),f.end=new Date(D,C*3,0,23,59,59,999),f}if(M==="semestrale"){var h=B("year_s",i.getFullYear()),o=B("sem",i.getMonth()<6?1:2);return f.start=new Date(h,o===1?0:6,1),f.end=new Date(h,o===1?6:12,0,23,59,59,999),f}if(M==="annuale"){var y=B("year",i.getFullYear());return f.start=new Date(y,0,1),f.end=new Date(y,11,31,23,59,59,999),f}if(M==="ytd"){var d=new Date(i.getFullYear(),i.getMonth()+1,0,23,59,59,999);return f.start=new Date(i.getFullYear(),0,1),f.end=d,f}if(M==="ltm"){var V=new Date(i.getFullYear(),i.getMonth()+1,0,23,59,59,999),l=new Date(V.getFullYear(),V.getMonth()-11,1);return f.start=l,f.end=V,f}return f.type="mensile",f.start=new Date(i.getFullYear(),i.getMonth(),1),f.end=new Date(i.getFullYear(),i.getMonth()+1,0,23,59,59,999),f}function we(e){return e==="ytd"||e==="ltm"?"mensile":e}window.effectivePeriodType=we;function Xe(e,i){var B=we(e||"mensile"),r=i?new Date(i):new Date,M=r.getUTCFullYear(),f=[];function m(c,v){f.push({s:c.getTime(),e:v.getTime()})}function T(c,v,g){return new Date(Date.UTC(c,v,g))}function Q(c){return new Date(c.getTime()+24*3600*1e3-1)}function _(c,v){return new Date(Date.UTC(c,v+1,0))}if(B==="settimanale"){var R=new Date(Date.UTC(r.getUTCFullYear(),r.getUTCMonth(),r.getUTCDate())),D=(R.getUTCDay()+6)%7;R.setUTCDate(R.getUTCDate()-D);for(var C=52;C>=0;C--){var h=new Date(R);h.setUTCDate(R.getUTCDate()-C*7);var o=new Date(h);o.setUTCDate(h.getUTCDate()+6),o.setUTCHours(23,59,59,999),m(h,o)}return f}if(B==="mensile"){for(var y=new Date(Date.UTC(r.getUTCFullYear(),r.getUTCMonth(),1)),d=23;d>=0;d--){var V=new Date(Date.UTC(y.getUTCFullYear(),y.getUTCMonth()-d,1));m(V,Q(_(V.getUTCFullYear(),V.getUTCMonth())))}return f}if(B==="trimestrale"){for(var l=Math.floor(r.getUTCMonth()/3),b=11;b>=0;b--){var t=l-b,P=M+Math.floor(t/4),I=(t%4+4)%4,h=T(P,I*3,1),o=Q(new Date(Date.UTC(P,I*3+3,0)));m(h,o)}return f}if(B==="semestrale"){for(var Y=r.getUTCMonth()<6?0:1,E=5;E>=0;E--){var H=Y-E,k=M+Math.floor(H/2),J=(H%2+2)%2,z=J===0?0:6,O=T(k,z,1),q=Q(new Date(Date.UTC(k,z+6,0)));m(O,q)}return f}for(var W=2;W>=0;W--){var n=M-W;m(T(n,0,1),Q(new Date(Date.UTC(n,12,0))))}return f}function K(e,i){var B=we(e||"mensile");return(i||[]).map(function(r){var M=new Date(r.s);return B==="settimanale"?"W"+ye(M)+" "+M.getUTCFullYear():B==="mensile"?String(M.getUTCMonth()+1).padStart(2,"0")+"/"+M.getUTCFullYear():B==="trimestrale"?"Q"+(Math.floor(M.getUTCMonth()/3)+1)+" "+M.getUTCFullYear():B==="semestrale"?(M.getUTCMonth()<6?"S1 ":"S2 ")+M.getUTCFullYear():String(M.getUTCFullYear())})}function he(){if(!fe())return a();document.title="Battle Plan – Dashboard",s.innerHTML=Pe()+'<div class="wrap"><div class="card"><b>Filtro</b><div class="row" style="margin-top:6px;align-items:flex-end;gap:16px;flex-wrap:wrap"><div><label>Modalità</label><select id="dash_mode" name="mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div><div><label>Consulente</label><select id="dash_cons"><option value="">Tutti</option></select></div></div>'+U("dash")+'</div><div class="grid" id="kpiGrid"><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>VSS</b><span id="kpi_vss" class="big">—</span></div><canvas id="d_mini_vss" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>VSD personale</b><span id="kpi_vsd" class="big">—</span></div><canvas id="d_mini_vsdpersonale" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>VSD indiretto</b><span id="kpi_vsd_ind" class="big">—</span></div><canvas id="d_mini_vsdindiretto" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>GI</b><span id="kpi_gi" class="big">—</span></div><canvas id="d_mini_gi" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>NNCF</b><span id="kpi_nncf" class="big">—</span></div><canvas id="d_mini_nncf" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>Tot Provvigioni</b><span id="kpi_provv" class="big">—</span></div><canvas id="d_mini_provv" width="320" height="90"></canvas></div></div><div class="card"><b>Ultimi appuntamenti</b><div id="lastApps" class="row" style="margin-top:8px"></div></div><div class="card"><b>Ultimi BP inviati</b><div id="lastBPs" class="row" style="margin-top:8px"></div></div></div>',xe();function e(o,y){var d=document.getElementById(o);d&&(d.textContent=y)}function i(o){var y=Number(o)||0;return y.toLocaleString("it-IT")+"€"}function B(o){var y=Number(o)||0;return String(Math.round(y))}function r(o){return String(o).replace(/[&<>'"]/g,y=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[y])}(function(){re("/api/usernames").then(function(y){var d=y&&y.users||[],V=document.getElementById("dash_cons");V&&(V.innerHTML='<option value="">Tutti</option>'+d.map(function(l){return'<option value="'+r(String(l.id))+'">'+r(l.name||l.email||"User #"+l.id)+"</option>"}).join(""))}).catch(function(){})})();function M(o,y){return y==="settimanale"?window.isoWeekNum?window.isoWeekNum(o):Math.ceil(o.getDate()/7):y==="mensile"||y==="ytd"||y==="ltm"?o.getMonth()+1:y==="trimestrale"?Math.floor(o.getMonth()/3)+1:y==="semestrale"?o.getMonth()<6?1:2:o.getFullYear()}function f(o){if(typeof Xe=="function")return(Xe(o,new Date)||[]).map(function(u){return{s:u.s,e:u.e}});var y=new Date,d=[];function V(u,N){d.push({s:u.getTime(),e:N.getTime()})}function l(u){var N=new Date(u);return N.setHours(23,59,59,999),N}function b(u,N){return new Date(u,N+1,0,23,59,59,999)}var t=String(o||"mensile").toLowerCase();if(t==="settimanale"){var P=new Date(y),I=(P.getDay()+6)%7;P.setDate(P.getDate()-I),P.setHours(0,0,0,0);for(var Y=52;Y>=0;Y--){var E=new Date(P);E.setDate(E.getDate()-Y*7);var H=new Date(E);H.setDate(E.getDate()+6),H.setHours(23,59,59,999),V(E,H)}return d}if(t==="mensile"||t==="ytd"||t==="ltm"){if(t==="ytd")for(var k=0;k<=y.getMonth();k++){var J=new Date(y.getFullYear(),k,1);V(J,b(y.getFullYear(),k))}else for(var z=t==="ltm"?12:24,O=new Date(y.getFullYear(),y.getMonth(),1),q=z-1;q>=0;q--){var E=new Date(O.getFullYear(),O.getMonth()-q,1);V(E,b(E.getFullYear(),E.getMonth()))}return d}if(t==="trimestrale"){for(var W=Math.floor(y.getMonth()/3)*3,n=new Date(y.getFullYear(),W,1),c=11;c>=0;c--){var v=new Date(n.getFullYear(),n.getMonth()-c*3,1);V(v,l(new Date(v.getFullYear(),v.getMonth()+3,0)))}return d}if(t==="semestrale"){for(var g=y.getMonth()<6?0:6,S=new Date(y.getFullYear(),g,1),E=5;E>=0;E--){var G=new Date(S.getFullYear(),S.getMonth()-E*6,1);V(G,l(new Date(G.getFullYear(),G.getMonth()+6,0)))}return d}for(var oe=2;oe>=0;oe--){var ne=new Date(y.getFullYear()-oe,0,1);V(ne,l(new Date(ne.getFullYear(),12,0)))}return d}function m(o){switch(String(o)){case"provv_gi":return"ProvvGI";case"provv_vsd":return"ProvvVSD";case"tot_provv":return"TotProvvigioni";default:return o}}function T(o,y,d,V){var l=V||ve("dash"),b=String(l.type||"mensile").toLowerCase(),t=b==="ytd"||b==="ltm"?"mensile":b,P=f(b);function I(E,H){var k=new Date(H.startDate).getTime(),J=new Date(H.endDate).getTime();return k>=E.s&&J<=E.e}function Y(E,H){if(!E)return 0;if(H==="VSDTotale")return Number(E.VSDPersonale||0)+Number(E.VSDIndiretto||0);if(H==="ProvvGI")return Number(E.ProvvGI||0);if(H==="ProvvVSD")return Number(E.ProvvVSD||0);if(H==="TotProvvigioni"){var k=E.TotProvvigioni;return Number(k!=null?k:Number(E.ProvvGI||0)+Number(E.ProvvVSD||0))}return Number(E[H]||0)}return re("/api/periods?global=1").catch(function(){return re("/api/periods")}).then(function(E){var H=E&&E.periods||[],k=H.filter(function(O){return!(O.type!==t||d&&String(O.userId||O.uid||"")!==String(d))}),J=m(o),z=P.map(function(O){for(var q=0,W=0;W<k.length;W++){var n=k[W];if(I(O,n)){var c=y==="previsionale"?n.indicatorsPrev||{}:n.indicatorsCons||{};q+=Y(c,J)}}return{x:new Date(O.s),y:Math.round(q*100)/100}});return z})}function Q(o,y,d){var V=document.getElementById(o);if(V){if(typeof window.drawFullLine=="function"){window.drawFullLine(o,y,d);return}var l=V.getContext("2d");V.width=V.clientWidth||320,V.height=V.clientHeight||80,l.clearRect(0,0,V.width,V.height);var b=Math.max(1,...d),t=d.length>1?(V.width-8)/(d.length-1):0;l.strokeStyle="#2e6cff",l.lineWidth=2,l.beginPath();for(var P=0;P<d.length;P++){var I=4+P*t,Y=V.height-6-d[P]/b*(V.height-12);P===0?l.moveTo(I,Y):l.lineTo(I,Y)}l.stroke()}}function _(){var o=(document.getElementById("dash_mode")||{}).value||"consuntivo",y=ve("dash"),d=new Date(y.start).getTime(),V=new Date(y.end).getTime(),l=(document.getElementById("dash_cons")||{}).value||"";function b(I){return I=Number(I==null?"":I),isFinite(I)?I:0}function t(I){if(!I)return 0;for(var Y=["VSDIndiretto","vsdIndiretto","VSD_indiretto","VSDI"],E=0;E<Y.length;E++)if(I[Y[E]]!=null)return b(I[Y[E]]);return I.VSDTotale!=null&&I.VSDPersonale!=null?b(I.VSDTotale)-b(I.VSDPersonale):0}function P(I){return I?I.TotProvvigioni!=null?b(I.TotProvvigioni):b(I.ProvvGI)+b(I.ProvvVSD):0}return re("/api/periods").then(function(I){for(var Y=I&&I.periods||[],E={VSS:0,VSDPersonale:0,VSDIndiretto:0,GI:0,NNCF:0,PROVV:0},H=0;H<Y.length;H++){var k=Y[H];if(!(l&&String(k.userId||k.uid||"")!==String(l))){var J=new Date(k.startDate).getTime(),z=new Date(k.endDate).getTime();if(!(J<d||z>V)){var O=o==="previsionale"?k.indicatorsPrev||{}:k.indicatorsCons||{};E.VSS+=b(O.VSS),E.VSDPersonale+=b(O.VSDPersonale),E.VSDIndiretto+=t(O),E.GI+=b(O.GI),E.NNCF+=b(O.NNCF),E.PROVV+=P(O)}}}e("kpi_vss",i(E.VSS)),e("kpi_vsd",i(E.VSDPersonale)),e("kpi_vsd_ind",i(E.VSDIndiretto)),e("kpi_gi",i(E.GI)),e("kpi_nncf",B(E.NNCF)),e("kpi_provv",i(E.PROVV))})}function R(){var o=(document.getElementById("dash_mode")||{}).value||"consuntivo",y=(document.getElementById("dash_cons")||{}).value||"",d=ve("dash"),V=String(d.type||"mensile").toLowerCase(),l=f(V),b=typeof K=="function"?K(V,l):l.map(function(P){return M(new Date(P.s),V)});function t(P,I){var Y=P.map(function(E){return E.y});Q(I,b,Y)}Promise.all([T("VSS",o,y||null,d),T("VSDPersonale",o,y||null,d),T("VSDIndiretto",o,y||null,d),T("GI",o,y||null,d),T("NNCF",o,y||null,d),T("TotProvvigioni",o,y||null,d)]).then(function(P){t(P[0],"d_mini_vss"),t(P[1],"d_mini_vsdpersonale"),t(P[2],"d_mini_vsdindiretto"),t(P[3],"d_mini_gi"),t(P[4],"d_mini_nncf"),t(P[5],"d_mini_provv")}).catch(function(P){logger.error(P)})}function D(){var o=(document.getElementById("dash_cons")||{}).value||"";(function(){var P=document.getElementById("lastApps");if(P){var I=P.parentElement;if(!document.getElementById("nextApps")){var Y=document.createElement("div");Y.className="card",Y.innerHTML='<b>Prossimi appuntamenti (oggi + domani)</b><div id="nextApps" style="margin-top:8px"></div>',I.parentElement.insertBefore(Y,I)}}})();function y(t){return'<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px">'+t+"</div>"}function d(t){return t=String(t||"").toLowerCase(),t.indexOf("mezza")>-1?240:t.indexOf("giorn")>-1||t.indexOf("formaz")>-1||t.indexOf("mbs")>-1?570:t.indexOf("sottoprod")>-1?240:(t.indexOf("vend")>-1,90)}function V(t){var P=new Date(t.start),I=new Date(t.end);(!(I instanceof Date)||isNaN(I)||I<P)&&(I=new Date(P.getTime()+d(t.type||"vendita")*6e4));var Y=tt(P)+" "+ht(P)+"–"+(("0"+I.getHours()).slice(-2)+":"+("0"+I.getMinutes()).slice(-2)),E=t.nncf?" · NNCF ✅":"",H=String(t.type||"").toLowerCase(),k;return H.indexOf("mbs")>-1?k="VSD ind "+i(t.vsdIndiretto||0):H.indexOf("sottoprod")>-1?k="Tel "+B(t.telefonate||0)+" · AppFissati "+B(t.appFissati||0):H.indexOf("formaz")>-1?k="":k="VSS "+i(t.vss||0)+" · VSD "+i(t.vsdPersonal||0)+E,'<div class="card lastApp" data-aid="'+r(String(t.id||""))+'" style="cursor:pointer"><div class="small muted">'+r(Y)+" · "+r(t.type||"manuale")+'</div><div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><div><b>'+r(t.client||"")+'</b></div><div class="row" style="gap:6px"><button class="ghost btn-ics" title="Esporta .ics" data-ics="'+r(String(t.id||""))+'">📅</button></div></div>'+(k?'<div class="small">'+k+"</div>":"")+"</div>"}function l(t){return t&&Object.keys(t).length>0}function b(t){return t=Number(t||0),isFinite(t)?t:0}Promise.all([re("/api/appointments"),re("/api/periods")]).then(function(t){var P=t[0]&&t[0].appointments||[],I=t[1]&&t[1].periods||[];(function(){var E=document.getElementById("nextApps");if(E){var H=new Date,k=new Date(H.getFullYear(),H.getMonth(),H.getDate(),0,0,0,0),J=new Date(H.getFullYear(),H.getMonth(),H.getDate()+2,0,0,0,0),z=P.filter(function(O){var q=new Date(O.start).getTime(),W=q>=k.getTime()&&q<J.getTime(),n=o?String(O.userId||O.uid||"")===String(o):!0;return W&&n}).sort(function(O,q){return new Date(O.start)-new Date(q.start)});E.innerHTML=z.length?y(z.map(V).join("")):'<div class="muted">Nessun appuntamento tra oggi e domani</div>',E.querySelectorAll(".lastApp[data-aid]").forEach(function(O){O.addEventListener("click",function(){try{ze("bp_edit_aid",O.getAttribute("data-aid"))}catch(q){}me()})}),E.querySelectorAll("button[data-ics]").forEach(function(O){O.addEventListener("click",function(q){q.stopPropagation();var W=O.getAttribute("data-ics"),n=z.find(c=>String(c.id)===String(W))||P.find(c=>String(c.id)===String(W));if(!n){X("Appuntamento non trovato");return}if(window.BP&&BP.ICS&&typeof BP.ICS.downloadIcsForAppointment=="function")if(BP.ICS.downloadIcsForAppointment(n)){typeof haptic=="function"&&haptic("medium");try{document.dispatchEvent(new Event("ics:exported"))}catch(v){}X(".ics esportato")}else X("Export .ics non disponibile");else X("Export .ics non disponibile")})})}})(),(function(){var E=document.getElementById("lastApps");if(E){var H=P.filter(function(k){return o?String(k.userId||k.uid||"")===String(o):!0}).sort(function(k,J){return new Date(J.start)-new Date(k.start)}).slice(0,6);E.innerHTML=H.length?y(H.map(V).join("")):'<div class="muted">Nessun appuntamento</div>',E.querySelectorAll(".lastApp[data-aid]").forEach(function(k){k.addEventListener("click",function(){try{ze("bp_edit_aid",k.getAttribute("data-aid"))}catch(J){}me()})}),E.querySelectorAll("button[data-ics]").forEach(function(k){k.addEventListener("click",function(J){J.stopPropagation();var z=k.getAttribute("data-ics"),O=H.find(q=>String(q.id)===String(z))||P.find(q=>String(q.id)===String(z));if(!O){X("Appuntamento non trovato");return}if(window.BP&&BP.ICS&&typeof BP.ICS.downloadIcsForAppointment=="function")if(BP.ICS.downloadIcsForAppointment(O)){typeof haptic=="function"&&haptic("medium");try{document.dispatchEvent(new Event("ics:exported"))}catch(W){}X(".ics esportato")}else X("Export .ics non disponibile");else X("Export .ics non disponibile")})})}})(),(function(){var E=document.getElementById("lastBPs");if(E){var H=I.filter(function(J){return!(o&&String(J.userId||J.uid||"")!==String(o))}).sort(function(J,z){return new Date(z.endDate)-new Date(J.endDate)}).slice(0,3),k=H.map(function(J){var z=nt(J.type,J.startDate),O=J.indicatorsPrev||{},q=J.indicatorsCons||{},W=l(q),n=W?q:O,c=b(n.VSS),v=b(n.VSDPersonale),g=b(n.VSDIndiretto),S=b(n.GI),G=b(n.NNCF),oe=v+g;return'<div class="card lastBP" data-pid="'+r(String(J.id||""))+'" style="cursor:pointer;flex:1 1 320px"><div style="display:flex;align-items:center;gap:8px"><div><b>'+r(z)+'</b></div><span class="chip small">'+(W?"Consuntivo":"Previsionale")+'</span></div><div class="row" style="margin-top:6px;gap:8px;flex-wrap:wrap"><span class="chip small">VSS <b>'+i(c)+'</b></span><span class="chip small">VSD <b>'+i(oe)+'</b> <span class="muted">(P '+i(v)+" · I "+i(g)+')</span></span><span class="chip small">GI <b>'+i(S)+'</b></span><span class="chip small">NNCF <b>'+B(G)+"</b></span></div></div>"}).join("");E.innerHTML=k?y(k):'<div class="muted">Nessun BP</div>',E.querySelectorAll(".lastBP[data-pid]").forEach(function(J){J.addEventListener("click",function(){try{ze("bp_open_period",{id:J.getAttribute("data-pid"),mode:!1})}catch(z){}Ie()})})}})()}).catch(function(t){logger.error(t)})}ue("dash",function(){typeof haptic=="function"&&haptic("light"),_(),R(),D()});var C=document.getElementById("dash_mode");C&&(C.onchange=function(){typeof haptic=="function"&&haptic("light"),_(),R(),D()});var h=document.getElementById("dash_cons");h&&(h.onchange=function(){typeof haptic=="function"&&haptic("light"),_(),R(),D()}),_(),R(),D(),typeof kickFinal=="function"&&kickFinal("dashboard")}function _e(){if(!fe())return a();document.title="Battle Plan – Calendario";function e(D){return ht(D)}if(!document.getElementById("cal_dynamic_css")){var i="\n      /* ============== CALENDAR ============== */\n      #cal_container{ overflow-x:auto; -webkit-overflow-scrolling:touch; }\n      #cal_container .calendar{ min-width: 860px; }\n\n      .calendar{ display:grid; grid-template-columns: 44px repeat(7, 1fr); gap:10px; }\n      .calendar .weekLabel{ color:var(--muted); font-size:12px; display:flex; align-items:center; justify-content:center; }\n\n      .calendar .day{\n        min-height:120px; background: var(--card);\n        border:2px solid var(--hair2); border-radius:14px; padding:8px;\n        display:flex; flex-direction:column; gap:3px; overflow:hidden;\n      }\n      .calendar .day.today{\n        outline: 2px solid var(--accent);\n        box-shadow: 0 0 0 2px rgba(0,0,0,.06) inset;\n      }\n      .calendar .day .dnum{ font-weight:800; }\n      .calendar .day .small{\n        font-size:12px; line-height:1.15;\n        white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:100%;\n      }\n      .calendar .day .tag{ padding:2px 6px; border-radius:999px; border:1px solid var(--hair2); font-size:11px; align-self:flex-start; }\n      .calendar .day.busy0{ border-color:#27ae60; background:rgba(39,174,96,.08); }\n      .calendar .day.busy1{ border-color:#ff9f1a; background:rgba(255,159,26,.10); }\n      .calendar .day.busy2{ border-color:#7d1731; background:rgba(125,23,49,.12); }\n      .calendar .day.dense .small{ font-size:11px; line-height:1.1; }\n      .calendar .day.dense .tag{ transform:scale(.9); transform-origin:left top; }\n\n      @media (max-width: 900px){\n        .calendar{ grid-template-columns: 36px repeat(7, 1fr); }\n        .calendar .weekLabel{ display:flex !important; font-size:11px; }\n        .calendar .day{ min-height:92px; padding:6px; }\n        .calendar .day .dnum{ font-size:16px; }\n        .calendar .day .small{ white-space: normal !important; overflow: visible !important; text-overflow: clip !important; }\n        .calendar .day.dense .small{ font-size:clamp(9px,2.4vw,11px); }\n        .calendar .day .tag{ font-size:10px; }\n      }\n\n      .cal-filters .chip{\n        display:inline-flex; align-items:center; gap:6px;\n        padding:6px 10px; border-radius:999px; border:1px solid var(--hair2);\n      }\n    ",B=document.createElement("style");B.id="cal_dynamic_css",B.textContent=i,document.head.appendChild(B)}var r=new Date,M=Ge(vt(r)).slice(0,7);s.innerHTML=Pe()+'<div class="wrap"><div class="card"><div class="row" style="align-items:flex-end;gap:12px;flex-wrap:wrap"><div class="row" style="align-items:flex-end;gap:8px"><button id="cal_prev" class="ghost" title="Mese precedente">◀</button><div><label>Mese</label><input type="month" id="cal_month" value="'+M+'"></div><button id="cal_next" class="ghost" title="Mese successivo">▶</button></div><div class="cal-filters"><label class="chip small"><input type="checkbox" id="only_free"> Solo giorni liberi</label> <label class="chip small"><input type="checkbox" id="only_4h"> Solo slot ≥ 4h</label></div><button id="cal_add" class="ghost">Aggiungi appuntamento</button><div class="right" style="margin-left:auto"><button id="cal_refresh" class="ghost">Aggiorna</button></div></div></div><div id="cal_container"></div><div id="cal_results" class="card" style="margin-top:8px;display:none"></div><div id="cal_day_box" class="card" style="margin-top:8px;display:none"></div><div class="card" id="cal_free_slots" style="margin-top:8px;display:none"></div></div>',xe();function f(D,C,h){Promise.all([re("/api/appointments"),re("/api/availability?from="+D+"-"+Le(C)+"-01&to="+D+"-"+Le(C)+"-"+Le(new Date(D,C,0).getDate()))]).then(function(o){var y=o[0]&&o[0].appointments?o[0].appointments:[],d=o[1]||{slots:[]},V=d.slots||[],l=new Date(D,C-1,1),b=new Date(D,C,0,23,59,59,999);function t(x,A){for(var F={vss:0,vsd:0,vsdI:0,telefonate:0,appFissati:0,nncf:0,count:0},$=0;$<y.length;$++){var Z=y[$],de=new Date(Z.start);de>=x&&de<=A&&(F.vss+=Number(Z.vss||0),F.vsd+=Number(Z.vsdPersonal||0),F.vsdI+=Number(Z.vsdIndiretto||0),F.telefonate+=Number(Z.telefonate||0),F.appFissati+=Number(Z.appFissati||0),F.nncf+=Z.nncf?1:0,F.count+=1)}return F}function P(x,A,F){var $=document.getElementById("cal_results");if($){var Z=F?'<div class="right"><button id="res_reset" class="ghost">Torna al mese</button></div>':"";if($.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center"><b>Risultati · '+A+"</b>"+Z+'</div><div class="row" style="margin-top:8px;gap:8px;flex-wrap:wrap"><span class="chip small">VSS <b>'+Ye(x.vss)+'</b></span><span class="chip small">VSD <b>'+Ye(x.vsd)+'</b></span><span class="chip small">VSD ind <b>'+Ye(x.vsdI)+'</b></span><span class="chip small">Tel <b>'+Ee(x.telefonate)+'</b></span><span class="chip small">AppFiss <b>'+Ee(x.appFissati)+'</b></span><span class="chip small">NNCF <b>'+Ee(x.nncf)+'</b></span><span class="chip small">N. app <b>'+Ee(x.count)+"</b></span></div>",$.style.display="block",F){var de=document.getElementById("res_reset");de&&(de.onclick=function(){P(t(l,b),z,!1)})}}}for(var I={},Y=0;Y<y.length;Y++){var E=y[Y],H=new Date(E.start);if(!(H<l||H>b)){var k=Ge(H);I[k]||(I[k]={vss:0,vsd:0,vsdI:0,telefonate:0,appFissati:0,nncf:0,mins:0,count:0,items:[]}),I[k].vss+=Number(E.vss||0),I[k].vsd+=Number(E.vsdPersonal||0),I[k].vsdI+=Number(E.vsdIndiretto||0),I[k].telefonate+=Number(E.telefonate||0),I[k].appFissati+=Number(E.appFissati||0),I[k].nncf+=E.nncf?1:0,I[k].mins+=Number(E.durationMinutes||0),I[k].count+=1,I[k].items.push(E)}}var J=["Lun","Mar","Mer","Gio","Ven","Sab","Dom"],z=new Date(D,C-1,1).toLocaleString("it-IT",{month:"long",year:"numeric"}),O='<div class="card"><b class="neon">'+z+"</b></div>";O+='<div class="calendar">',O+='<div class="weekLabel">W</div>';for(var q=0;q<7;q++)O+='<div class="weekLabel">'+J[q]+"</div>";var W=new Date(D,C-1,1),n=(W.getDay()+6)%7,c=new Date(W);c.setDate(W.getDate()-n);for(var v=0;v<6;v++){var g=new Date(c),S="W"+ye(g);O+='<div class="weekLabel" data-ws="'+Ge(g)+'" style="cursor:pointer">'+S+"</div>";for(var G=0;G<7;G++){var oe=c.getMonth()===C-1,k=Ge(c),ne=I[k]||{vss:0,vsd:0,vsdI:0,telefonate:0,appFissati:0,nncf:0,mins:0,count:0,items:[]},u=c.getDay(),N=u===0||u===6,j=!N&&V.some(function(A){return A.date===k});if(oe&&h){if(h.only_free&&ne.count>0){O+="<div></div>",c.setDate(c.getDate()+1);continue}if(h.only_4h&&!j){O+="<div></div>",c.setDate(c.getDate()+1);continue}}if(!oe)O+="<div></div>";else{var L="";N?ne.count>0&&(L="busy2"):ne.count===0?L="busy0":j?L="busy1":L="busy2";var ee="",te=0;N&&ne.count===0||(ne.vss>0&&(ee+='<div class="small">VSS '+Ye(ne.vss)+"</div>",te++),ne.vsd>0&&(ee+='<div class="small">VSD '+Ye(ne.vsd)+"</div>",te++),ne.vsdI>0&&(ee+='<div class="small">VSD ind '+Ye(ne.vsdI)+"</div>",te++),ne.telefonate>0&&(ee+='<div class="small">Tel '+Ee(ne.telefonate)+"</div>",te++),ne.appFissati>0&&(ee+='<div class="small">AppFiss '+Ee(ne.appFissati)+"</div>",te++),ne.nncf>0&&(ee+='<div class="small">NNCF '+Ee(ne.nncf)+"</div>",te++),ne.count>0&&(ee+='<div class="small">App. '+Ee(ne.count)+"</div>",te++),j&&(ee+='<div class="tag" style="margin-top:4px">slot ≥4h</div>',te++));var ie=te>=3?" dense":"",se=j?" slot-free":"";O+='<div class="day '+L+ie+se+'" data-day="'+k+'" title="Settimana '+ye(c)+'"><div class="dnum">'+c.getDate()+"</div>"+(ee||"")+"</div>"}c.setDate(c.getDate()+1)}}O+="</div>",document.getElementById("cal_container").innerHTML=O,P(t(l,b),z,!1),document.querySelectorAll(".calendar .weekLabel[data-ws]").forEach(function(x){x.addEventListener("click",function(){var A=x.getAttribute("data-ws"),F=new Date(A),$=new Date(F);$.setDate($.getDate()+6),$.setHours(23,59,59,999);var Z="Settimana "+("W"+ye(F))+" · "+tt(F)+"–"+tt($);P(t(F,$),Z,!0)})}),document.querySelectorAll(".day[data-day]").forEach(function(x){x.addEventListener("click",function(){var A=x.getAttribute("data-day"),F=I[A]&&I[A].items?I[A].items.slice():[];F.sort(function(ke,We){return new Date(ke.start)-new Date(We.start)});var $=document.getElementById("cal_day_box"),Z="<b>Appuntamenti del "+A.split("-").reverse().join("/")+"</b>";if(!F.length)Z+='<div class="muted" style="margin-top:6px">Nessun appuntamento</div>';else{Z+='<div class="row" style="margin-top:8px">';for(var de=0;de<F.length;de++){var ae=F[de],ge=' data-start="'+ae.start+'" data-end="'+ae.end+'" data-title="'+pe(ae.client||"Appuntamento")+'" ',Ne=String(ae.type||"").toLowerCase(),Ae;Ne.indexOf("mbs")>-1?Ae="VSD ind "+Ye(ae.vsdIndiretto||0):Ne.indexOf("sottoprod")>-1?Ae="Tel "+Ee(ae.telefonate||0)+" · AppFissati "+Ee(ae.appFissati||0):Ne.indexOf("formaz")>-1?Ae="":Ae="VSS "+Ye(ae.vss)+" · VSD "+Ye(ae.vsdPersonal)+" · NNCF "+(ae.nncf?"✅":"—"),Z+='<div class="card cal-app" data-aid="'+ae.id+'" '+ge+' style="flex:1 1 320px;cursor:pointer"><div class="small muted">'+e(ae.start)+"–"+e(ae.end)+" · "+pe(ae.type||"")+"</div><div><b>"+pe(ae.client||"")+"</b></div>"+(Ae?'<div class="small">'+Ae+"</div>":"")+(ae.notes?'<div class="small muted">'+pe(ae.notes)+"</div>":"")+"</div>"}Z+="</div>"}var Ke=(V||[]).filter(function(ke){return ke.date===A});if(Ke.length){Z+='<div class="row" style="margin-top:8px">';for(var Qe=0;Qe<Ke.length;Qe++){var qe=Ke[Qe],je=qe.part==="morning"?"mattina":"pomeriggio";Z+='<div class="card slotBtn" data-start="'+qe.start+'" data-end="'+qe.end+'" style="flex:1 1 280px;cursor:pointer"><div class="small">'+je+" · "+e(qe.start)+"–"+e(qe.end)+"</div></div>"}Z+="</div>"}if($.style.display="block",$.innerHTML=Z,$.querySelectorAll(".cal-app").forEach(function(ke){ke.addEventListener("click",function(We){We.stopPropagation(),ze("bp_edit_aid",ke.getAttribute("data-aid")),me()})}),$.querySelectorAll(".slotBtn").forEach(function(ke){ke.addEventListener("click",function(We){We.stopPropagation(),ze("bp_prefill_slot",{start:ke.getAttribute("data-start"),end:ke.getAttribute("data-end")}),me(),X("Slot precompilato negli appuntamenti")})}),window.scrollTo({top:$.getBoundingClientRect().top+window.scrollY-80,behavior:"smooth"}),typeof window.wireICSInsideDayBox=="function")try{window.wireICSInsideDayBox()}catch(ke){}})});var le=document.getElementById("cal_free_slots"),Be=(function(){var x=new Date;return x.getFullYear()+"-"+Le(x.getMonth()+1)+"-"+Le(x.getDate())})(),Te=(V||[]).filter(function(x){return String(x.date||"").slice(0,10)>=Be});if(Te.length){var Je='<b>Slot liberi ≥ 4h (da oggi in poi)</b> · <span class="badge">Tot: '+Te.length+"</span>";Je+='<div class="row" style="margin-top:8px">';for(var p=0;p<Te.length&&p<80;p++){var H=Te[p],w=H.part==="morning"?"mattina":"pomeriggio";Je+='<div class="card slotBtn" data-start="'+H.start+'" data-end="'+H.end+'" style="flex:1 1 280px;cursor:pointer"><div class="small"><b>'+tt(H.start)+"</b> · "+w+'</div><div class="small">'+e(H.start)+"–"+e(H.end)+"</div></div>"}Je+="</div>",le.style.display="block",le.innerHTML=Je,le.querySelectorAll(".slotBtn").forEach(function(x){x.addEventListener("click",function(){ze("bp_prefill_slot",{start:x.getAttribute("data-start"),end:x.getAttribute("data-end")}),me(),X("Slot precompilato negli appuntamenti")})})}else le.style.display="block",le.innerHTML='<b>Slot liberi ≥ 4h (da oggi in poi)</b> · <span class="badge">Tot: 0</span><div class="muted" style="margin-top:6px">Nessuno slot libero disponibile.</div>';try{window.injectTodayCSS&&window.injectTodayCSS()}catch(x){}try{window.hookCalendar?window.hookCalendar():(window.markToday&&window.markToday(),window.clampSlotCounters&&window.clampSlotCounters())}catch(x){}}).catch(function(o){logger.error(o),X("Errore calendario")})}function m(){var D=document.getElementById("cal_month").value,C=parseInt(D.split("-")[0],10),h=parseInt(D.split("-")[1],10),o={only_free:document.getElementById("only_free").checked,only_4h:document.getElementById("only_4h").checked};f(C,h,o)}document.getElementById("cal_refresh").onclick=m;var T=document.getElementById("cal_add");T&&(T.onclick=function(){me()}),document.getElementById("cal_month").onchange=m;function Q(D){var C=document.getElementById("cal_month");if(C){var h=C.value.split("-"),o=+h[0],y=+h[1];y+=D,y<=0?(y=12,o--):y>12&&(y=1,o++),C.value=o+"-"+Le(y),m()}}var _=document.getElementById("cal_prev"),R=document.getElementById("cal_next");_&&(_.onclick=function(){Q(-1)}),R&&(R.onclick=function(){Q(1)}),document.getElementById("only_free").onchange=m,document.getElementById("only_4h").onchange=m,m()}function Ie(){if(!fe())return a();document.title="Battle Plan – BP",s.innerHTML=Pe()+'<div class="wrap"><div class="card"><b>Da inviare</b><div id="bp_to_send" class="grid" style="margin-top:8px"></div></div><div class="card" id="bp_sent_box" style="margin-top:8px"><div id="bp_sent_head" style="display:flex;align-items:center;justify-content:space-between;cursor:pointer"><b>BP inviati (periodi in essere)</b><span id="bp_sent_chev" class="chev">▸</span></div><div id="bp_sent" class="row" style="margin-top:8px;display:none"></div></div><div class="card" style="margin-top:8px"><b>Crea/Aggiorna BP</b><div class="row" style="margin-top:8px"><div><label>Tipo</label><select id="p_type"><option value="settimanale">Settimanale (lun–dom)</option><option value="mensile">Mensile</option><option value="trimestrale">Trimestrale</option><option value="semestrale">Semestrale</option><option value="annuale">Annuale</option></select></div><div id="wrap_week" style="display:none"><label>Settimana ISO (1–53)</label><input type="number" id="p_week" min="1" max="53" value="'+ye(new Date)+'"></div><div id="wrap_month" style="display:none"><label>Mese</label><select id="p_month"><option value="1">Gennaio</option><option value="2">Febbraio</option><option value="3">Marzo</option><option value="4">Aprile</option><option value="5">Maggio</option><option value="6">Giugno</option><option value="7">Luglio</option><option value="8">Agosto</option><option value="9">Settembre</option><option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option></select></div><div id="wrap_quarter" style="display:none"><label>Trimestre</label><select id="p_quarter"><option value="1">T1</option><option value="2">T2</option><option value="3">T3</option><option value="4">T4</option></select></div><div id="wrap_semester" style="display:none"><label>Semestre</label><select id="p_sem"><option value="1">1° semestre</option><option value="2">2° semestre</option></select></div><div><label>Anno</label><input type="number" id="p_year" min="2000" max="2100" value="'+new Date().getFullYear()+'"></div></div><div class="row"><div class="small muted">Modalità: <b id="p_mode_lbl">Previsionale</b> · <button class="ghost" id="btnImport" style="padding:4px 8px">Importa da agenda</button></div></div><div class="row" style="align-items:center"><div class="small"><b>Periodo selezionato:</b> <span id="p_label" class="neon">—</span></div><input type="hidden" id="p_start"><input type="hidden" id="p_end"></div><div class="row small" style="margin-top:6px;opacity:.9"><div><b>Previsionale</b></div><div><b>Consuntivo</b></div><div><b>Avanzamento</b></div></div><div class="row" id="p_rows" style="margin-top:4px"></div><div class="row" style="margin-top:8px;align-items:center;gap:8px;justify-content:space-between"><div id="p_delete_zone"></div><div class="right"><button id="btnSaveP">Salva BP</button></div></div></div><div class="card"><b>BP salvati</b><div id="p_list" class="row" style="margin-top:8px"></div></div></div>',xe();var e=!1,i=null,B=[],r=null,M=fe()||{};function f(p){return String(p).replace(/[&<>'"]/g,w=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[w])}function m(p){if(!p)return"";var w=new Date(p);return w.getFullYear()+"-"+("0"+(w.getMonth()+1)).slice(-2)+"-"+("0"+w.getDate()).slice(-2)}function T(p){var w=new Date(p);return("0"+w.getDate()).slice(-2)+"/"+("0"+(w.getMonth()+1)).slice(-2)+"/"+w.getFullYear()}function Q(p){var w=Number(p)||0;return w.toLocaleString("it-IT")+"€"}function _(p){var w=document.createElement("div");return w.innerHTML=p.trim(),w.firstChild}function R(p){return!!(p&&p.indicatorsCons&&Object.keys(p.indicatorsCons).length>0)}function D(){return M&&M.grade?Promise.resolve(M):re("/api/usernames").then(function(p){var w=String((fe()||{}).id||""),x=(p&&p.users||[]).find(function(A){return String(A.id)===w});return x&&x.grade&&(M.grade=x.grade),M}).catch(function(){return M})}function C(){var p=M&&M.grade||(fe()||{}).grade;return p==="senior"?"senior":"junior"}D();var h=document.getElementById("p_type"),o=document.getElementById("p_year"),y=document.getElementById("wrap_week"),d=document.getElementById("wrap_month"),V=document.getElementById("wrap_quarter"),l=document.getElementById("wrap_semester"),b=document.getElementById("p_week"),t=document.getElementById("p_month"),P=document.getElementById("p_quarter"),I=document.getElementById("p_sem"),Y=document.getElementById("p_label"),E=document.getElementById("p_start"),H=document.getElementById("p_end"),k=document.getElementById("p_mode_lbl"),J=document.getElementById("btnImport");function z(p){e=!!p,k.textContent=e?"Consuntivo":"Previsionale",J.style.display=e?"none":"";var w=document.querySelectorAll("[data-row]");w.forEach(function(x){var A=x.querySelector("[data-prev]"),F=x.querySelector("[data-cons]"),$=x.querySelector("[data-bar]");if(e){if(A){A.removeAttribute("hidden");var Z=A.querySelector("input");Z&&(Z.setAttribute("readonly","readonly"),Z.classList.add("disabled"))}if(F){F.removeAttribute("hidden");var de=F.querySelector("input");de&&(de.removeAttribute("readonly"),de.classList.remove("disabled"))}$&&$.removeAttribute("hidden")}else{if(A){A.removeAttribute("hidden");var ae=A.querySelector("input");ae&&(ae.removeAttribute("readonly"),ae.classList.remove("disabled"))}F&&F.setAttribute("hidden","hidden"),$&&$.setAttribute("hidden","hidden")}}),L()}function O(){var p=h.value;y.style.display=p==="settimanale"?"":"none",d.style.display=p==="mensile"?"":"none",V.style.display=p==="trimestrale"?"":"none",l.style.display=p==="semestrale"?"":"none",q()}function q(){var p=h.value,w=parseInt(o.value,10),x,A,F;if(p==="settimanale"){var $=Math.max(1,Math.min(53,parseInt(b.value||"1",10))),Z=$e(w,$);x=Z.start,A=Z.end,F="Sett. "+$+" · "+T(x)+" → "+T(A)}else if(p==="mensile"){var de=parseInt(t.value,10);x=new Date(w,de-1,1),A=new Date(w,de,0),F=x.toLocaleString("it-IT",{month:"long",year:"numeric"})+" · "+T(x)+" → "+T(A)}else if(p==="trimestrale"){var ae=parseInt(P.value,10);x=new Date(w,(ae-1)*3,1),A=new Date(w,ae*3,0),F="Trimestre "+ae+" "+w+" · "+T(x)+" → "+T(A)}else if(p==="semestrale"){var ge=parseInt(I.value,10);x=new Date(w,ge===1?0:6,1),A=new Date(w,ge===1?6:12,0),F=(ge===1?"1°":"2°")+" semestre "+w+" · "+T(x)+" → "+T(A)}else x=new Date(w,0,1),A=new Date(w,11,31),F="Anno "+w+" · "+T(x)+" → "+T(A);E.value=m(x),H.value=m(A),Y.textContent=F,z(!1),i=null,r=null,g(),L()}function W(p){for(var w="",x=0;x<p.length;x++){var A=p[x],F=/^(VSS|VSDPersonale|VSDIndiretto|GI)$/i.test(A);w+='<div class="row" data-row="'+A+'"><div data-prev><label>'+A+' (Prev)</label><input type="number" step="1" id="prev_'+A+'" placeholder="'+(F?"€":"n")+'"></div><div data-cons><label>'+A+' (Cons)</label><input type="number" step="1" id="cons_'+A+'" placeholder="'+(F?"€":"n")+'"></div><div data-bar class="small"><div style="height:10px;background:rgba(255,255,255,.12);border-radius:999px;overflow:hidden"><div id="bar_'+A+'" style="height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2));"></div></div><div id="pct_'+A+'" class="small muted">0%</div></div></div>'}document.getElementById("p_rows").innerHTML=w,z(!1),c(),n()}function n(){for(var p=0;p<B.length;p++){var w=B[p],x=document.getElementById("prev_"+w),A=document.getElementById("cons_"+w);if(!(!x||!A)){var F=Number(x.value||0),$=Number(A.value||0),Z=F>0?Math.round($/F*100):$>0?100:0;Z=Math.max(0,Math.min(200,Z));var de=document.getElementById("bar_"+w),ae=document.getElementById("pct_"+w);de&&(de.style.width=Math.min(Z,100)+"%"),ae&&(ae.textContent=Z+"%")}}}function c(){for(var p=0;p<B.length;p++)(function(w){var x=document.getElementById("prev_"+w),A=document.getElementById("cons_"+w);x&&(x.oninput=n),A&&(A.oninput=n)})(B[p])}function v(){for(var p=0;p<B.length;p++){var w=document.getElementById("prev_"+B[p]);w&&(w.value="")}n()}function g(){for(var p=0;p<B.length;p++){var w=document.getElementById("cons_"+B[p]);w&&(w.value="")}n()}function S(p){for(var w in p){var x=document.getElementById("prev_"+w);x&&(x.value=String(p[w]||0))}n()}function G(p){for(var w in p){var x=document.getElementById("cons_"+w);x&&(x.value=String(p[w]||0))}n()}function oe(){if(!e){var p=E.value,w=H.value;if(!p||!w){X("Seleziona il periodo");return}re("/api/appointments").then(function(x){for(var A=x.appointments||[],F=new Date(p),$=new Date(w),Z={VSS:0,VSDPersonale:0,VSDIndiretto:0,GI:0,Telefonate:0,AppFissati:0,AppFatti:0,CorsiLeadership:0,iProfile:0,MBS:0,NNCF:0},de=0;de<A.length;de++){var ae=A[de],ge=new Date(ae.start);ge>=F&&ge<=$&&(Z.VSS+=Number(ae.vss||0),Z.VSDPersonale+=Number(ae.vsdPersonal||0),ae.nncf&&(Z.NNCF+=1))}S(Z),X("Previsionale compilato dalla tua agenda"),at(),window.addXP(10)}).catch(function(){X("Errore import agenda")})}}function ne(p,w){p=Object.assign({},p||{});var x=Number(p.GI||0),A=Number(p.VSDPersonale||0),F=x*.15,$=A*(String(w)==="senior"?.25:.2);return p.ProvvGI=Math.round(F*100)/100,p.ProvvVSD=Math.round($*100)/100,p.TotProvvigioni=Math.round((p.ProvvGI+p.ProvvVSD)*100)/100,p}function u(p,w,x){return fetch(w,{method:p,headers:x?{"Content-Type":"application/json"}:void 0,body:x?JSON.stringify(x):void 0}).then(function(A){return A.ok?A.json().catch(function(){return{}}):Promise.reject(new Error("HTTP "+A.status))})}function N(p){for(var w=encodeURIComponent(p),x=[function(){return u("POST","/api/periods/delete",{id:p})},function(){return u("POST","/api/periods",{id:p,_delete:!0})},function(){return u("POST","/api/periods/"+w,{_method:"DELETE"})},function(){return u("DELETE","/api/periods/"+w,null)},function(){return u("DELETE","/api/periods?id="+w,null)}],A=Promise.reject(new Error("start")),F=0;F<x.length;F++)(function($){A=A.catch($)})(x[F]);return A.catch(function($){throw logger.warn("Delete fallback: tutte le route fallite",$),$})}function j(p){return r?{id:i||r.id,type:r.type,startDate:m(r.startDate),endDate:m(r.endDate),indicatorsPrev:Object.assign({},r.indicatorsPrev||{}),indicatorsCons:p!=null?p:Object.assign({},r.indicatorsCons||{})}:null}function L(){var p=document.getElementById("p_delete_zone");if(p){if(!i){p.innerHTML="";return}var w=!!(r&&R(r)),x="";w&&(x+='<button id="btnDelCons" class="ghost" style="border-color:#7d1731;color:#7d1731">Elimina Consuntivo</button> '),x+='<button id="btnDelBP" class="ghost" style="border-color:#7d1731;color:#7d1731">Elimina BP</button>',p.innerHTML=x;var A=document.getElementById("btnDelBP");A&&(A.onclick=function(){confirm("Eliminare definitivamente questo BP?")&&(A.disabled=!0,N(i).then(function(){X("BP eliminato"),i=null,r=null,v(),g(),z(!1),q(),te()}).catch(function(){X("Endpoint delete non disponibile")}).finally(function(){A.disabled=!1}))});var F=document.getElementById("btnDelCons");F&&(F.onclick=function(){if(confirm("Rimuovere solo il Consuntivo?")){F.disabled=!0;var $=j({});if(!$){F.disabled=!1;return}var Z=C();$.indicatorsPrev=ne($.indicatorsPrev,Z),$.indicatorsCons={},Fe("/api/periods",$).then(function(){X("Consuntivo eliminato"),r&&(r.indicatorsCons={}),z(!0),te(),L()}).catch(function(){X("Errore eliminazione Consuntivo")}).finally(function(){F.disabled=!1})}})}}function ee(){var p=h.value,w=E.value,x=H.value;if(!w||!x){X("Seleziona il periodo");return}for(var A={},F={},$=0;$<B.length;$++){var Z=B[$];A[Z]=Number(document.getElementById("prev_"+Z).value||0),e&&(F[Z]=Number(document.getElementById("cons_"+Z).value||0))}var de=C();A=ne(A,de),e&&(F=ne(F,de));var ae={type:p,startDate:w,endDate:x,indicatorsPrev:A};e&&(ae.indicatorsCons=F),i&&(ae.id=i),Fe("/api/periods",ae).then(function(ge){X("BP salvato"),e?window.addXP(20):window.addXP(10),at();try{document.dispatchEvent(new Event("bp:saved"))}catch(Ne){}te(),!i&&ge&&ge.id&&(i=ge.id),i&&r&&(r.indicatorsPrev=A,e&&(r.indicatorsCons=F)),L()}).catch(function(){X("Errore salvataggio BP")})}function te(){re("/api/periods").then(function(p){var w=p.periods||[];w.sort(function(ae,ge){return new Date(ge.startDate)-new Date(ae.startDate)});for(var x="",A=0;A<w.length;A++){var F=w[A],$=nt(F.type,F.startDate)+" · "+T(F.startDate)+" → "+T(F.endDate);x+='<div class="card" style="flex:1 1 360px"><div><b>'+f($)+'</b></div><div class="small">Prev VSS '+Q((F.indicatorsPrev||{}).VSS||0)+" · Cons "+Q((F.indicatorsCons||{}).VSS||0)+'</div><div class="right" style="margin-top:6px"><button class="ghost" data-edit="'+F.id+'">Modifica previs.</button><button data-cons="'+F.id+'">Consuntivo…</button></div></div>'}document.getElementById("p_list").innerHTML=x||'<div class="muted">Nessun BP</div>',document.querySelectorAll("[data-edit]").forEach(function(ae){ae.addEventListener("click",function(){var ge=ae.getAttribute("data-edit"),Ne=(p.periods||[]).find(function(Ae){return Ae.id===ge});Ne&&ie(Ne,!1)})}),document.querySelectorAll("[data-cons]").forEach(function(ae){ae.addEventListener("click",function(){var ge=ae.getAttribute("data-cons"),Ne=(p.periods||[]).find(function(Ae){return Ae.id===ge});Ne&&ie(Ne,!0)})}),Je(w);var Z=it("bp_open_period",null);if(Z){et("bp_open_period");var de=w.find(function(ae){return ae.id===Z.id});de&&ie(de,Z.mode===!0)}})}function ie(p,w){r=p||null,h.value=p.type;var x=new Date(p.startDate),A=x.getFullYear();if(o.value=String(A),p.type==="settimanale")b.value=String(ye(x));else if(p.type==="mensile")t.value=String(x.getMonth()+1);else if(p.type==="trimestrale"){var F=Math.floor(x.getMonth()/3)+1;P.value=String(F)}else p.type==="semestrale"&&(I.value=x.getMonth()<6?"1":"2");O(),v(),g(),S(p.indicatorsPrev||{}),G(p.indicatorsCons||{}),z(!!w),i=p.id||null,L(),X(w?"Compila il consuntivo":"Modifica previsionale"),window.scrollTo({top:0,behavior:"smooth"})}function se(p,w){w=w||new Date;var x=w.getFullYear();if(p==="settimanale"){var A=$e(x,ye(w));return{start:A.start,end:A.end}}return p==="mensile"?{start:vt(w),end:mt(w)}:p==="trimestrale"?{start:lt(w),end:pt(w)}:p==="semestrale"?{start:st(w),end:ft(w)}:{start:bt(w),end:rt(w)}}function le(p,w){return w=w||new Date,p==="settimanale"?Gt(w):p==="mensile"?zt(w):p==="trimestrale"?qt(w):p==="semestrale"?jt(w):Wt(w)}function Be(p){var w=$e(new Date().getFullYear(),ye(new Date)),x=w.start,A=Math.floor((new Date(p)-x)/(1e3*60*60*24));return A<=13}function Te(p,w,x,A,F,$){var Z=nt(w,x),de=_('<div class="card" style="position:relative"><div class="small muted">'+f(p)+"</div><div><b>"+f(Z)+'</b></div><div class="small muted">'+T(x)+" → "+T(A)+'</div><div class="right" style="margin-top:6px"><button class="ghost" type="button" data-sug="1">'+f(F)+"</button></div></div>");return de.querySelector("[data-sug]").addEventListener("click",$),de}function Je(p){var w=document.getElementById("bp_to_send"),x=document.getElementById("bp_sent");w.innerHTML="",x.innerHTML="";function A(be,Ce,Se){return p.find(function(He){return He.type===be&&m(He.startDate)===m(Ce)&&m(He.endDate)===m(Se)})}var F=new Date,$=F.getDay(),Z=$===5||$===6||$===0,de=mt(F),ae=pt(F),ge=ft(F),Ne=rt(F),Ae=Z&&Be(de),Ke=Z&&Be(ae),Qe=Z&&Be(ge),qe=Z&&Be(Ne);["settimanale","mensile","trimestrale","semestrale","annuale"].forEach(function(be){var Ce=se(be,F),Se=A(be,Ce.start,Ce.end);if(Se){var He=_('<div class="card" style="flex:1 1 360px"><div><b>'+f(nt(be,Ce.start))+'</b></div><div class="small muted">'+T(Ce.start)+" → "+T(Ce.end)+'</div><div class="right" style="margin-top:6px"><button class="ghost" type="button" data-mid="'+Se.id+'">Modifica</button></div></div>');He.querySelector("[data-mid]").addEventListener("click",function(){ie(Se,!1)}),x.appendChild(He)}});function je(be,Ce,Se){var He=A(be,Se.start,Se.end),ut=A(be,Ce.start,Ce.end);He?w.appendChild(Te("Previsionale",be,Se.start,Se.end,"Modifica",function(){ie(He,!1)})):w.appendChild(Te("Previsionale",be,Se.start,Se.end,"Compila",function(){if(h.value=be,o.value=String(Se.start.getFullYear()),be==="settimanale")b.value=String(ye(Se.start));else if(be==="mensile")t.value=String(Se.start.getMonth()+1);else if(be==="trimestrale"){var At=Math.floor(Se.start.getMonth()/3)+1;P.value=String(At)}else be==="semestrale"&&(I.value=Se.start.getMonth()<6?"1":"2");O()})),ut&&!R(ut)&&w.appendChild(Te("Consuntivo",be,Ce.start,Ce.end,"Consuntivo",function(){ie(ut,!0)}))}if(Z){var ke=se("settimanale",F),We=le("settimanale",F);je("settimanale",ke,We)}if(Ae){var Dt=se("mensile",F),Et=le("mensile",F);je("mensile",Dt,Et)}if(Ke){var xt=se("trimestrale",F),Bt=le("trimestrale",F);je("trimestrale",xt,Bt)}if(Qe){var Tt=se("semestrale",F),Ct=le("semestrale",F);je("semestrale",Tt,Ct)}if(qe){var Pt=se("annuale",F),Mt=le("annuale",F);je("annuale",Pt,Mt)}w.children.length||(w.innerHTML='<div class="muted">Nessun suggerimento attivo in questo momento</div>');var kt=document.getElementById("bp_sent_head"),Nt=document.getElementById("bp_sent_chev");kt.onclick=function(){var be=document.getElementById("bp_sent"),Ce=be.style.display!=="none";be.style.display=Ce?"none":"",Nt.textContent=Ce?"▸":"▾"}}re("/api/settings").then(function(p){B=p&&p.indicators||["VSS","VSDPersonale","VSDIndiretto","GI","Telefonate","AppFissati","AppFatti","CorsiLeadership","iProfile","MBS","NNCF"],W(B)}).catch(function(){B=["VSS","VSDPersonale","GI","NNCF"],W(B)}),h.onchange=O,o.oninput=q,b.oninput=q,t.onchange=q,P.onchange=q,I.onchange=q,J.onclick=oe,document.getElementById("btnSaveP").onclick=ee,O(),te()}function me(){if(!fe())return a();if(document.title="Battle Plan – Appuntamenti",!document.getElementById("appts_css")){const n=document.createElement("style");n.id="appts_css",n.textContent="\n      .appt-type .seg, #a_nncf.seg{\n        padding:8px 12px;border:1px solid #bcd7ff;border-radius:12px;\n        background:#eef5ff;color:#1463ff;cursor:pointer;user-select:none;\n        transition:.15s;\n      }\n      .appt-type .seg.active, #a_nncf.seg.active{\n        background:var(--accent);color:#fff;border-color:var(--accent);\n        box-shadow:0 0 0 2px rgba(20,99,255,.08) inset;\n      }\n      #a_list .grid3{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}\n    ",document.head.appendChild(n)}s.innerHTML=Pe()+'<div class="wrap"><div class="card"><b id="a_form_title">Nuovo appuntamento</b><div class="row" style="margin-top:8px;align-items:flex-end;gap:12px;flex-wrap:wrap"><div style="min-width:320px"><label>Cliente *</label><div style="display:flex;gap:8px;align-items:center"><input id="a_client" list="clientList" placeholder="Denominazione" style="flex:1"><datalist id="clientList"></datalist><button id="a_nncf" class="seg" data-active="0" aria-pressed="false">NNCF</button></div></div><div><label>Data/ora inizio</label><input id="a_start" type="datetime-local"></div><div><label>Ora fine</label><input id="a_end" type="time"></div><div><label>Durata (min)</label><input id="a_dur" type="number" placeholder="60" min="1"></div></div><div class="row" style="margin-top:8px"><div style="flex:1"><label>Descrizione appuntamento</label><textarea id="a_desc" rows="2"></textarea></div></div><div class="row" style="align-items:flex-end;gap:12px;flex-wrap:wrap"><div class="appt-type"><label>Tipo</label><div><button type="button" id="t_vendita" class="seg">Vendita</button><button type="button" id="t_mezza"   class="seg" data-vsd="1000">Mezza giornata</button><button type="button" id="t_full"    class="seg" data-vsd="2000">Giornata intera</button><button type="button" id="t_form"    class="seg">Formazione</button><button type="button" id="t_mbs"     class="seg">MBS</button><button type="button" id="t_sotto"   class="seg">Sottoprodotti</button></div><input id="a_type" type="hidden" value="vendita"></div><div id="row_vss"><label>VSS</label><input id="a_vss" type="number" step="1" placeholder="0"></div><div id="row_vsd_p"><label>VSD personale</label><input id="a_vsd" type="number" step="1" placeholder="0"></div><div id="row_vsd_i" style="display:none"><label>VSD indiretto</label><input id="a_vsd_i" type="number" step="1" placeholder="0"></div><div id="row_tel" style="display:none"><label>Telefonate</label><input id="a_tel" type="number" step="1" placeholder="0"></div><div id="row_app" style="display:none"><label>Appunt. fissati</label><input id="a_app" type="number" step="1" placeholder="0"></div></div><div class="row" style="margin-top:8px;gap:8px;align-items:center"><div><button id="btnSaveA">Salva</button></div><div><button id="btnSaveExportA" class="ghost">Salva ed esporta</button></div><div class="right" style="margin-left:auto"><button id="btnDeleteA" class="danger" style="display:none">Elimina</button></div></div></div><div class="card"><b>Elenco appuntamenti</b><div class="row" style="margin-top:8px;align-items:flex-end;gap:12px;flex-wrap:wrap"><div><label>Vista</label><select id="af_type"><option value="sett">Settimana</option><option value="mese">Mese</option></select></div><div id="af_week_wrap"><label>Settimana ISO</label><input id="af_week" type="number" min="1" max="53" value="'+ye(new Date)+'"></div><div id="af_month_wrap" style="display:none"><label>Mese</label><select id="af_month"><option value="1">Gennaio</option><option value="2">Febbraio</option><option value="3">Marzo</option><option value="4">Aprile</option><option value="5">Maggio</option><option value="6">Giugno</option><option value="7">Luglio</option><option value="8">Agosto</option><option value="9">Settembre</option><option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option></select></div><div><label>Anno</label><input id="af_year" type="number" min="2000" max="2100" value="'+new Date().getFullYear()+'"></div><div class="right" style="margin-left:auto;display:flex;gap:8px"><button id="af_prev" class="ghost">◀</button><button id="af_next" class="ghost">▶</button></div></div><div id="a_list" style="margin-top:8px"></div></div></div>',xe();function e(n){return String(n).replace(/[&<>'"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[c])}function i(n){var c=Number(n)||0;return c.toLocaleString("it-IT")+"€"}function B(n){var c=new Date(n);return("0"+c.getDate()).slice(-2)+"/"+("0"+(c.getMonth()+1)).slice(-2)+"/"+c.getFullYear()}function r(n){if(!n)return"";const c=new Date(n);return isNaN(c)?"":c.toISOString()}function M(n){if(!n)return"";const c=new Date(n);return isNaN(c)?"":new Date(c.getTime()-c.getTimezoneOffset()*6e4).toISOString().slice(0,16)}function f(n){return n=String(n||"").toLowerCase(),n.indexOf("mezza")>-1?240:n.indexOf("giorn")>-1||n.indexOf("formaz")>-1||n.indexOf("mbs")>-1?570:n.indexOf("sottoprod")>-1?240:90}const m=document.getElementById("a_nncf");m.addEventListener("click",()=>{const n=m.getAttribute("data-active")!=="1";m.setAttribute("data-active",n?"1":"0"),m.setAttribute("aria-pressed",n?"true":"false"),m.classList.toggle("active",n),n&&o(document.getElementById("t_vendita"))});const T=document.getElementById("t_vendita"),Q=document.getElementById("t_mezza"),_=document.getElementById("t_full"),R=document.getElementById("t_form"),D=document.getElementById("t_mbs"),C=document.getElementById("t_sotto"),h=[T,Q,_,R,D,C];function o(n){h.forEach(u=>u.classList.toggle("active",u===n));const c=document.getElementById("a_type"),v=document.getElementById("a_client"),g=document.getElementById("row_vss"),S=document.getElementById("row_vsd_p"),G=document.getElementById("row_vsd_i"),oe=document.getElementById("row_tel"),ne=document.getElementById("row_app");document.getElementById("a_vss").value="",document.getElementById("a_vsd").value="",document.getElementById("a_vsd_i").value="",document.getElementById("a_tel").value="",document.getElementById("a_app").value="",g.style.display="",S.style.display="",G.style.display="none",oe.style.display="none",ne.style.display="none",v.disabled=!1,m.style.display="",m.setAttribute("data-active","0"),m.setAttribute("aria-pressed","false"),m.classList.remove("active"),(v.value==="Formazione"||v.value==="MBS"||v.value==="Sottoprodotti")&&(v.value=""),n===T?(c.value="vendita",y(90)):n===Q?(c.value="mezza",y(240),document.getElementById("a_vsd").value="1000"):n===_?(c.value="giornata",y(570),document.getElementById("a_vsd").value="2000"):n===R?(c.value="formazione",y(570),v.value="Formazione",v.disabled=!0,g.style.display="none",S.style.display="none",m.style.display="none"):n===D?(c.value="MBS",y(570),v.value="MBS",v.disabled=!0,g.style.display="none",S.style.display="none",G.style.display="",document.getElementById("a_vsd_i").value="2000",m.style.display="none"):n===C&&(c.value="sottoprodotti",y(240),v.value="Sottoprodotti",v.disabled=!0,g.style.display="none",S.style.display="none",oe.style.display="",ne.style.display="",m.style.display="none")}function y(n){const c=document.getElementById("a_dur");c.value=String(n),d()}h.forEach(n=>n.addEventListener("click",c=>{c.preventDefault(),o(n)})),o(T);function d(){const n=document.getElementById("a_start").value,c=parseInt(document.getElementById("a_dur").value||"0",10);if(!n||!isFinite(c)||c<=0){document.getElementById("a_end").value="";return}const v=new Date(n),g=new Date(v.getTime()+c*6e4);document.getElementById("a_end").value=("0"+g.getHours()).slice(-2)+":"+("0"+g.getMinutes()).slice(-2)}function V(){const n=document.getElementById("a_start").value,c=document.getElementById("a_end").value;if(!n||!c)return;const v=new Date(n),g=c.split(":");if(g.length<2)return;const S=new Date(v);S.setHours(parseInt(g[0],10)||0,parseInt(g[1],10)||0,0,0),S<v&&S.setDate(S.getDate()+1);let G=Math.round((S-v)/6e4);document.getElementById("a_dur").value=String(Math.max(1,G))}document.getElementById("a_start").addEventListener("change",d),document.getElementById("a_dur").addEventListener("input",d),document.getElementById("a_end").addEventListener("change",V),re("/api/clients").then(n=>{const c=n&&n.clients||[],v=document.getElementById("clientList");v&&(v.innerHTML=c.map(g=>'<option value="'+e(g.name)+'"></option>').join(""))});let l=null;function b(){l=null,document.getElementById("a_form_title").textContent="Nuovo appuntamento",document.getElementById("a_client").value="",document.getElementById("a_start").value="",document.getElementById("a_end").value="",document.getElementById("a_dur").value="",document.getElementById("a_vss").value="",document.getElementById("a_vsd").value="",document.getElementById("a_vsd_i").value="",document.getElementById("a_tel").value="",document.getElementById("a_app").value="",document.getElementById("a_desc").value="",document.getElementById("a_client").disabled=!1,m.style.display="",m.setAttribute("data-active","0"),m.setAttribute("aria-pressed","false"),m.classList.remove("active"),o(T),document.getElementById("btnDeleteA").style.display="none"}function t(n){l=n.id,document.getElementById("a_form_title").textContent="Modifica appuntamento";var c=String(n.type||"vendita").toLowerCase();c.indexOf("mezza")>-1?o(Q):c.indexOf("giorn")>-1?o(_):c.indexOf("formaz")>-1?o(R):c.indexOf("mbs")>-1?o(D):c.indexOf("sottoprod")>-1?o(C):o(T),document.getElementById("a_client").value=n.client||"",document.getElementById("a_start").value=M(n.start);const v=new Date(n.start);let g=n.end?new Date(n.end):null,S=Number(n.durationMinutes);g instanceof Date&&!isNaN(g)&&g>=v?S=Math.max(1,Math.round((g-v)/6e4)):isFinite(S)&&S>0?g=new Date(v.getTime()+S*6e4):(S=f(n.type||"vendita"),g=new Date(v.getTime()+S*6e4)),document.getElementById("a_dur").value=String(S),document.getElementById("a_end").value=("0"+g.getHours()).slice(-2)+":"+("0"+g.getMinutes()).slice(-2),document.getElementById("a_vss").value=n.vss||"",document.getElementById("a_vsd").value=n.vsdPersonal||n.vsd||"",document.getElementById("a_vsd_i").value=n.vsdIndiretto||"",document.getElementById("a_tel").value=n.telefonate||"",document.getElementById("a_app").value=n.appFissati||"",document.getElementById("a_desc").value=n.notes||"";const G=!!n.nncf;m.setAttribute("data-active",G?"1":"0"),m.setAttribute("aria-pressed",G?"true":"false"),m.classList.toggle("active",G),document.getElementById("btnDeleteA").style.display=""}function P(){let n=(document.getElementById("a_client").value||"").trim();const c=document.getElementById("a_type").value;if(!n){const ne=String(c||"").toLowerCase();if(ne==="formazione"||ne==="mbs"||ne==="sottoprodotti")n=c;else return X("Cliente obbligatorio"),null}const v=document.getElementById("a_start").value;if(!v)return X("Data/ora obbligatorie"),null;let g=parseInt(document.getElementById("a_dur").value||"60",10);(!isFinite(g)||g<=0)&&(g=60);const S=document.getElementById("a_end").value;let G;if(S){const ne=new Date(v),u=S.split(":"),N=new Date(ne);N.setHours(parseInt(u[0],10)||0,parseInt(u[1],10)||0,0,0),N<ne&&N.setDate(N.getDate()+1),G=N.toISOString(),g=Math.max(1,Math.round((N-ne)/6e4)),document.getElementById("a_dur").value=String(g)}else G=new Date(new Date(v).getTime()+g*6e4).toISOString();const oe=document.getElementById("a_desc").value||"";return{id:l||void 0,client:n,start:r(v),end:G,durationMinutes:g,type:c,vss:Number(document.getElementById("a_vss").value||0),vsdPersonal:Number(document.getElementById("a_vsd").value||0),vsdIndiretto:Number(document.getElementById("a_vsd_i").value||0),telefonate:Number(document.getElementById("a_tel").value||0),appFissati:Number(document.getElementById("a_app").value||0),notes:oe,nncf:m.getAttribute("data-active")==="1"}}function I(n){const c=P();if(!c)return;const v=!l;Fe("/api/appointments",c).then(()=>{if(X("Appuntamento salvato"),typeof haptics<"u"&&haptics.try("success"),document.dispatchEvent(new Event("appt:saved")),v)try{document.dispatchEvent(new Event("appt:created"))}catch(g){}if(n&&window.BP&&BP.ICS&&typeof BP.ICS.downloadIcsForAppointment=="function")if(BP.ICS.downloadIcsForAppointment(c)){typeof haptics<"u"&&haptics.try("medium");try{document.dispatchEvent(new Event("ics:exported"))}catch(S){}X(".ics esportato")}else X("Export .ics non disponibile");b(),W()}).catch(()=>X("Errore salvataggio"))}function Y(){if(!l||!confirm("Eliminare l'appuntamento?"))return;const n=P();fetch("/api/appointments?id="+encodeURIComponent(l),{method:"DELETE",headers:{Authorization:"Bearer "+ot()}}).then(c=>{if(!c.ok)throw new Error("HTTP "+c.status);return c.json()}).then(()=>{X("Eliminato"),typeof showUndo=="function"&&n&&showUndo("Appuntamento eliminato",function(){return Fe("/api/appointments",n)},5e3),b(),W()}).catch(()=>X("Errore eliminazione"))}document.getElementById("btnSaveA").onclick=()=>I(!1),document.getElementById("btnSaveExportA").onclick=()=>I(!0),document.getElementById("btnDeleteA").onclick=Y;function E(){const n=document.getElementById("af_type").value,c=parseInt(document.getElementById("af_year").value,10);if(n==="sett"){const v=Math.max(1,Math.min(53,parseInt(document.getElementById("af_week").value||ye(new Date),10))),g=$e(c,v);return{s:new Date(g.start),e:new Date(g.end)}}else{const v=parseInt(document.getElementById("af_month").value||new Date().getMonth()+1,10);return{s:new Date(c,v-1,1),e:new Date(c,v,0,23,59,59,999)}}}function H(n){const c=document.getElementById("af_type").value,v=parseInt(document.getElementById("af_year").value,10);if(c==="sett"){const g=parseInt(document.getElementById("af_week").value,10),S=new Date($e(v,g).start);S.setDate(S.getDate()+7*n),document.getElementById("af_year").value=S.getFullYear(),document.getElementById("af_week").value=ye(S)}else{const g=parseInt(document.getElementById("af_month").value,10),S=new Date(v,g-1,1);S.setMonth(S.getMonth()+n),document.getElementById("af_year").value=S.getFullYear(),document.getElementById("af_month").value=S.getMonth()+1}W()}document.getElementById("af_prev").onclick=()=>H(-1),document.getElementById("af_next").onclick=()=>H(1);const k=document.getElementById("af_type"),J=document.getElementById("af_week"),z=document.getElementById("af_month"),O=document.getElementById("af_year");k.onchange=function(){const n=k.value;document.getElementById("af_week_wrap").style.display=n==="sett"?"":"none",document.getElementById("af_month_wrap").style.display=n==="mese"?"":"none",W()},[J,z,O].forEach(n=>{n&&(n.onchange=W)});function q(n){const c=new Date(n.start);let v=n.end?new Date(n.end):null;if(!(v instanceof Date)||isNaN(v)||v<c){const oe=isFinite(n.durationMinutes)?Number(n.durationMinutes):f(n.type||"vendita");v=new Date(c.getTime()+oe*6e4)}const g=B(c)+" "+("0"+c.getHours()).slice(-2)+":"+("0"+c.getMinutes()).slice(-2)+"–"+("0"+v.getHours()).slice(-2)+":"+("0"+v.getMinutes()).slice(-2);var S,G=String(n.type||"").toLowerCase();return G.indexOf("mbs")>-1?S="VSD ind "+i(n.vsdIndiretto||0):G.indexOf("sottoprod")>-1?S="Tel "+Ee(n.telefonate||0)+" · AppFissati "+Ee(n.appFissati||0):G.indexOf("formaz")>-1?S="":S="VSS "+i(n.vss||0)+" · VSD "+i(n.vsdPersonal||0)+" · NNCF "+(n.nncf?"✅":"—"),'<div class="card" data-aid="'+e(String(n.id||""))+'" style="flex:1 1 320px;cursor:pointer"><div class="small muted">'+e(g)+" · "+e(n.type||"vendita")+'</div><div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><div><b>'+e(n.client||"")+'</b></div><button class="ghost btn-ics" title="Esporta" data-ics="'+e(String(n.id||""))+'">📅</button></div>'+(S?'<div class="small">'+S+"</div>":"")+"</div>"}function W(){re("/api/appointments").then(n=>{const c=n&&n.appointments||[],v=E(),g=v.s.getTime(),S=v.e.getTime(),G=c.filter(te=>{const ie=new Date(te.start).getTime();return ie>=g&&ie<=S}).sort((te,ie)=>new Date(te.start)-new Date(ie.start)),oe=new Date,ne=G.filter(te=>new Date(te.start)>=oe),u=G.filter(te=>new Date(te.start)<oe),N=document.getElementById("a_list");let j="";j+="<div><b>Prossimi</b></div>",j+=ne.length?'<div class="grid3">'+ne.map(q).join("")+"</div>":'<div class="muted" style="margin:6px 0 12px">Nessun appuntamento futuro</div>';const L="past_"+Math.random().toString(36).slice(2,8);j+='<div id="'+L+'_head" style="margin-top:12px;display:flex;align-items:center;justify-content:space-between;cursor:pointer"><b>Passati</b><span class="chev">▸</span></div><div id="'+L+'_box" style="display:none;margin-top:8px">'+(u.length?'<div class="grid3">'+u.map(q).join("")+"</div>":'<div class="muted">Nessun appuntamento passato</div>')+"</div>",N.innerHTML=j,(function(){const te=document.getElementById(L+"_head"),ie=document.getElementById(L+"_box"),se=te.querySelector(".chev");te.onclick=function(){const le=ie.style.display==="none";ie.style.display=le?"":"none",se.textContent=le?"▾":"▸"}})();const ee=G;N.querySelectorAll("[data-ics]").forEach(te=>{te.addEventListener("click",ie=>{ie.stopPropagation();const se=te.getAttribute("data-ics"),le=ee.find(Be=>String(Be.id)===String(se));if(!le){X("Appuntamento non trovato");return}if(window.BP&&BP.ICS&&typeof BP.ICS.downloadIcsForAppointment=="function")if(BP.ICS.downloadIcsForAppointment(le)){typeof haptics<"u"&&haptics.try("medium");try{document.dispatchEvent(new Event("ics:exported"))}catch(Te){}X("Esportato")}else X("Export .ics non disponibile");else X("Export .ics non disponibile")})}),N.querySelectorAll(".card[data-aid]").forEach(te=>{te.addEventListener("click",()=>{const ie=te.getAttribute("data-aid"),se=ee.find(le=>String(le.id)===String(ie));se&&(t(se),window.scrollTo({top:0,behavior:"smooth"}))})})})}try{const n=it("bp_prefill_slot",null);if(n&&n.start){const c=new Date(n.start),v=new Date(n.end||n.start),g=new Date(c.getTime()-c.getTimezoneOffset()*6e4).toISOString().slice(0,16);document.getElementById("a_start").value=g,document.getElementById("a_dur").value=String(Math.max(1,Math.round((v-c)/6e4))),d(),X("Slot precompilato negli appuntamenti")}et("bp_prefill_slot")}catch(n){}try{const n=it("bp_edit_aid",null);n&&re("/api/appointments").then(c=>{const g=(c&&c.appointments||[]).find(S=>String(S.id)===String(n));g&&(t(g),window.scrollTo({top:0,behavior:"smooth"}))}).finally(()=>{try{et("bp_edit_aid")}catch(c){}})}catch(n){}document.getElementById("btnSaveA").onclick=()=>I(!1),document.getElementById("btnSaveExportA").onclick=()=>I(!0),document.getElementById("btnDeleteA").onclick=Y,re("/api/clients").then(()=>{}),W()}function Ue(){if(!fe())return a();document.title="Battle Plan – Classifiche",s.innerHTML=Pe()+('<div class="wrap"><div class="card"><div class="row"><div><label>Vista</label><select id="lb_tab"><option value="per_indicator">Per indicatore</option><option value="overall">Generale (score)</option></select></div><div><label>Modalità</label><select id="lb_mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div><div id="lb_ind_wrap"><label>Indicatore</label><select id="lb_indicator"><option value="VSS">VSS</option><option value="VSDPersonale">VSD</option><option value="GI">GI</option><option value="NNCF">NNCF</option></select></div></div>'+U("lb")+'</div><div class="card"><b id="lb_title">Classifica</b><div id="lb_podium" style="margin:10px 0"></div><div id="lb_table"></div></div></div>'),xe();function e(_){if(!_)return"";var R=new Date(_);return R.getFullYear()+"-"+("0"+(R.getMonth()+1)).slice(-2)+"-"+("0"+R.getDate()).slice(-2)}function i(_){return _==="ytd"||_==="ltm"?"mensile":_}document.getElementById("lb_tab").onchange=function(){var _=this.value;document.getElementById("lb_ind_wrap").style.display=_==="per_indicator"?"":"none",r()},ue("lb",r),document.getElementById("lb_mode").onchange=r,document.getElementById("lb_indicator").onchange=r;function B(){var _=ve("lb"),R=e(_.start),D=e(_.end),C=i(_.type||"mensile");return"&from="+encodeURIComponent(R)+"&to="+encodeURIComponent(D)+"&type="+encodeURIComponent(C)}function r(){var _=document.getElementById("lb_tab").value,R=B(),D=document.getElementById("lb_mode").value;if(_==="overall")re("/api/leaderboard_overall?mode="+encodeURIComponent(D)+R).then(Q);else{var C=document.getElementById("lb_indicator").value;re("/api/leaderboard?indicator="+encodeURIComponent(C)+"&mode="+encodeURIComponent(D)+R).then(function(h){T(h,C)})}}function M(_){return _===0?"🥇":_===1?"🥈":_===2?"🥉":_+1+"."}function f(_){var R=document.getElementById("lb_podium");if(!_||!_.length){R.innerHTML="";return}for(var D=_.slice(0,3),C='<div class="row" style="align-items:flex-end">',h=0;h<D.length;h++){var o=80-h*15;C+='<div class="card" style="flex:1 1 120px;height:'+o+'px;display:flex;align-items:flex-end;justify-content:center"><div>'+pe(M(h)+" "+D[h].name)+"</div></div>"}C+="</div>",R.innerHTML=C}function m(_,R,D){var C=Math.min(100,Math.max(0,Math.round(D)));return'<div class="card lb-card" style="flex:1 1 280px"><div class="big">'+pe(_)+'</div><div class="small muted">'+pe(R)+'</div><div class="lb-bar"><div style="width:'+C+'%"></div></div></div>'}function T(_,R){document.getElementById("lb_title").textContent="Classifica – "+R;var D=_.ranking||[];if(f(D),!D.length){document.getElementById("lb_table").innerHTML='<div class="muted">Nessun dato</div>';return}for(var C='<div class="row">',h=D[0].total||1,o=0;o<D.length;o++){var y=D[o];C+=m(M(o)+" "+y.name,"Totale: "+Ee(y.total),y.total/h*100)}C+="</div>",document.getElementById("lb_table").innerHTML=C}function Q(_){document.getElementById("lb_title").textContent="Classifica generale";var R=_.ranking||[];if(f(R),!R.length){document.getElementById("lb_table").innerHTML='<div class="muted">Nessun dato</div>';return}for(var D=R[0].score||0,C='<div class="row">',h=0;h<R.length;h++){var o=R[h];C+=m(M(h)+" "+o.name,"Score: "+Ee(o.score)+"/100",D?o.score/D*100:0)}C+="</div>",document.getElementById("lb_table").innerHTML=C}r()}(function(){function e(){var i=document.getElementById("bp-overlay");return i||(i=document.createElement("div"),i.id="bp-overlay",i.className="hidden",i.setAttribute("role","dialog"),i.setAttribute("aria-modal","true"),i.innerHTML='<div class="bp-overlay-backdrop" id="bp-overlay-backdrop"></div><div class="bp-overlay-panel" id="bp-overlay-panel"></div>',document.body.appendChild(i),document.getElementById("bp-overlay-backdrop").addEventListener("click",hideOverlay)),i}window.showOverlay=function(i){var B=e(),r=document.getElementById("bp-overlay-panel");r.innerHTML=i||"",B.classList.remove("hidden");var M=r.querySelector("input, textarea, select, button");M&&setTimeout(function(){try{M.focus()}catch(f){}},0)},window.hideOverlay=function(){var i=document.getElementById("bp-overlay");i&&i.classList.add("hidden")}})();function De(){if(!fe())return a();document.title="Battle Plan – Clienti",s.innerHTML=Pe()+'<div class="wrap"><div class="card"><b>Nuovo cliente</b><div class="row" style="margin-top:8px"><div><label>Ragione sociale</label><input id="cl_name" type="text" placeholder="Es. Rossi S.r.l."></div><div><label>Stato</label><select id="cl_new_state"><option value="potenziale">Potenziale</option><option value="lead non chiuso">Lead non chiuso</option><option value="attivo">Attivo</option></select></div><div><label>Consulente</label><select id="cl_new_owner"><option value="">—</option></select></div><div class="right"><button id="cl_add">Aggiungi</button></div></div></div><div class="card"><b>Filtri elenco</b><div class="row" style="margin-top:8px"><div><label>Stato</label><select id="cl_f_state"><option value="">Tutti</option><option value="attivo">Attivo</option><option value="lead non chiuso">Lead non chiuso</option><option value="potenziale">Potenziale</option></select></div><div><label>Consulente</label><select id="cl_f_cons"><option value="">Tutti</option></select></div><div><label>Ordina per</label><select id="cl_order"><option value="az">Ragione sociale (A→Z)</option><option value="last_desc">Ultimo appuntamento (recenti prima)</option></select></div><div class="right"><button class="ghost" id="cl_f_apply">Applica</button></div></div></div><div class="card"><b>Elenco clienti</b><div id="cl_list" class="row" style="margin-top:8px"></div></div></div>',xe();function e(){const r=(document.getElementById("cl_name").value||"").trim();if(!r){X("Nome obbligatorio");return}const M=document.getElementById("cl_new_state"),f=document.getElementById("cl_new_owner"),m={name:r};M&&(m.status=M.value),f&&f.value&&(m.consultantId=f.value),Fe("/api/clients",m).then(function(){document.getElementById("cl_name").value="",B(),at(),window.addXP(5)}).catch(function(T){logger.error(T),X("Errore creazione cliente")})}function i(){re("/api/usernames").then(function(r){const M=r&&r.users||[],f=document.getElementById("cl_f_cons"),m=document.getElementById("cl_new_owner");f&&(f.innerHTML='<option value="">Tutti</option>'+M.map(function(T){return'<option value="'+T.id+'">'+pe(T.name)+(T.grade?" ("+T.grade+")":"")+"</option>"}).join("")),m&&(m.innerHTML='<option value="">—</option>'+M.map(function(T){return'<option value="'+T.id+'">'+pe(T.name)+(T.grade?" ("+T.grade+")":"")+"</option>"}).join(""))}).catch(function(r){logger.error(r)})}function B(){re("/api/clients").then(function(r){const M=r&&r.clients||[],f=document.getElementById("cl_f_state").value,m=document.getElementById("cl_f_cons").value;function T(R){return String(R||"").trim().toLowerCase()}const _=M.filter(function(R){return!(f&&T(R.status)!==T(f)||m&&String(R.consultantId||"")!==String(m))}).map(function(R){const D=pe(R.name||""),C=pe(R.status||"potenziale"),h=R.consultantName?pe(R.consultantName):"unknown",o=String(R.id||"");return'<div class="card" data-clid="'+o+'" data-name-lower="'+D.toLowerCase()+'" data-status="'+C+'" data-consultant-id="'+pe(String(R.consultantId||""))+'" style="flex:1 1 380px"><div><b>'+D+'</b></div><div class="small">Stato: <b class="cl-status">'+C+'</b></div><div class="small">Consulente: <b class="cl-cons">'+h+'</b></div><div class="small muted">Ultimo appuntamento: <span class="last-appt">—</span></div><div class="right" style="margin-top:6px"><button class="ghost" data-del="'+o+'">Rimuovi</button></div></div>'}).join("");document.getElementById("cl_list").innerHTML=_||'<div class="muted">Nessun cliente</div>',document.querySelectorAll("[data-del]").forEach(function(R){R.addEventListener("click",function(){const D=R.getAttribute("data-del");confirm("Rimuovere il cliente?")&&fetch("/api/clients?id="+encodeURIComponent(D),{method:"DELETE",headers:{Authorization:"Bearer "+ot()}}).then(function(C){if(!C.ok)throw new Error("HTTP "+C.status);return C.json()}).then(function(){X("Cliente rimosso"),B()}).catch(function(C){logger.error(C),X("Errore rimozione")})})}),window.BPFinal&&typeof BPFinal.ensureClientSection=="function"?BPFinal.ensureClientSection():setTimeout(function(){const R=document.getElementById("cl_list"),D=Array.from(R.children).filter(C=>C.classList.contains("card"));D.sort((C,h)=>String(C.getAttribute("data-name-lower")||"").localeCompare(String(h.getAttribute("data-name-lower")||"")));for(const C of D)R.appendChild(C)},0)})}document.getElementById("cl_add").onclick=e,document.getElementById("cl_f_apply").onclick=B,i(),B(),typeof kickFinal=="function"&&kickFinal("clients")}function Oe(){if(!fe())return a();document.title="Battle Plan – Squadra";var e=Pe()+'<div class="wrap">'+('<div class="card"><b>Vista Amministratore</b><div id="t_adminbar" class="row" style="margin-top:8px;display:flex;align-items:flex-end;gap:16px;flex-wrap:wrap"><div><label>Modalità</label><select id="t_mode" name="mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div><div id="t_unified_wrap">'+U("t")+'</div></div></div><div class="card"><b>Riepilogo per utente</b><div id="t_users" class="row" style="margin-top:8px"></div></div><div class="card"><b>Aggregato Squadra</b><div id="t_agg" class="row" style="margin-top:8px"></div><div class="row" style="margin-top:12px;align-items:flex-end;gap:16px;flex-wrap:wrap"><div><label>Indicatore grafico</label><select id="t_ind"><option value="VSS">VSS</option><option value="VSDPersonale">VSD Personale</option><option value="VSDIndiretto">VSD Indiretto</option><option value="VSDTotale">VSD Totale</option><option value="GI">GI</option><option value="NNCF">NNCF</option><option value="provv_gi">Provv GI</option><option value="provv_vsd">Provv VSD</option><option value="tot_provv" selected>Tot Provvigioni</option></select></div><div><label>Consulente</label><select id="t_cons"><option value="">Tutti</option></select></div></div><div style="margin-top:8px"><canvas id="t_chart" height="160"></canvas></div></div>')+"</div>";s.innerHTML=e,xe(),(function(){var b=document.getElementById("t_adminbar"),t=document.getElementById("t_unified_wrap");if(!(!b||!t)){var P=t.querySelector(".row");P&&(Array.from(P.children).forEach(function(I){I.classList.remove("right"),I.style.marginTop="0",b.appendChild(I)}),t.remove())}})();function i(l){return l=Number(l||0),isFinite(l)?l:0}function B(l){if(!l)return"";var b=new Date(l);return b.getFullYear()+"-"+("0"+(b.getMonth()+1)).slice(-2)+"-"+("0"+b.getDate()).slice(-2)}function r(l){return l=String(l||"mensile").toLowerCase(),l.indexOf("sett")===0?"settimanale":l.indexOf("mes")===0?"mensile":l.indexOf("tri")===0?"trimestrale":l.indexOf("sem")===0?"semestrale":l.indexOf("ann")===0?"annuale":"mensile"}function M(){var l=ve("t"),b=B(l.start),t=B(l.end),P=r(l.type);return"&from="+encodeURIComponent(b)+"&to="+encodeURIComponent(t)+"&type="+encodeURIComponent(P)}function f(l){switch(String(l)){case"provv_gi":return"ProvvGI";case"provv_vsd":return"ProvvVSD";case"tot_provv":return"TotProvvigioni";default:return l}}function m(l){var b=Number(l)||0;return b.toLocaleString("it-IT")+"€"}function T(l){var b=Number(l)||0;return String(Math.round(b))}function Q(l){return String(l).replace(/[&<>'"]/g,b=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[b])}var _=null;function R(l,b){return b==="settimanale"?window.isoWeekNum?window.isoWeekNum(l):Math.ceil(l.getDate()/7):b==="mensile"||b==="ytd"||b==="ltm"?l.getMonth()+1:b==="trimestrale"?Math.floor(l.getMonth()/3)+1:b==="semestrale"?l.getMonth()<6?1:2:l.getFullYear()}function D(l,b){var t=document.getElementById("t_chart");if(t){var P=y(b),I=typeof K=="function"?K(b,P):l.map(function(O){return R(O.x,b)}),Y=l.map(function(O){return O.y});if(typeof Chart>"u"){var k=t.getContext("2d");t.width=t.clientWidth||600,t.height=t.clientHeight||160,k.clearRect(0,0,t.width,t.height);var E=Math.max(1,...Y),H=Y.length>1?(t.width-8)/(Y.length-1):0;k.beginPath(),k.lineWidth=2,k.strokeStyle="#2e6cff",Y.forEach(function(q,W){var n=4+W*H,c=t.height-6-q/E*(t.height-12);W?k.lineTo(n,c):k.moveTo(n,c)}),k.stroke(),k.fillStyle="#2e6cff",Y.forEach(function(q,W){var n=4+W*H,c=t.height-6-q/E*(t.height-12);k.beginPath(),k.arc(n,c,2,0,Math.PI*2),k.fill()});return}var k=t.getContext("2d"),J=typeof window.computeTickOptions=="function"?window.computeTickOptions(I,t.width||600):{autoSkip:!0,maxRotation:0,minRotation:0};if(_)_.data.labels=I,_.data.datasets[0].data=Y,_.options.scales.x.ticks=J,_.update();else{var z=typeof Chart.getChart=="function"?Chart.getChart(t):null;z&&z.destroy(),_=new Chart(k,{type:"line",data:{labels:I,datasets:[{label:"",data:Y,tension:.3,pointRadius:3,pointHoverRadius:5}]},options:{responsive:!1,maintainAspectRatio:!1,animation:!1,animations:!1,plugins:{legend:{display:!1}},scales:{x:{grid:{display:!1},ticks:J},y:{beginAtZero:!0}}}})}}}function C(l){return'<div class="card" style="flex:1 1 360px"><div style="display:flex;align-items:center;gap:8px"><div><b>'+Q(l.name||"User #"+l.userId)+"</b></div>"+(l.grade?'<span class="chip small">'+Q(l.grade)+"</span>":"")+'</div><div class="small" style="margin-top:6px">VSS '+m(l.vss||0)+'</div><div class="small">VSD Pers. '+m(l.vsdP||0)+'</div><div class="small">VSD Ind. '+m(l.vsdI||0)+'</div><div class="small">VSD Tot. '+m((l.vsdP||0)+(l.vsdI||0))+'</div><div class="small">GI '+m(l.gi||0)+'</div><div class="small">NNCF '+T(l.nncf||0)+'</div><div class="small muted" style="margin-top:6px">Provv GI '+m(l.provvGi||0)+'</div><div class="small muted">Provv VSD '+m(l.provvVsd||0)+'</div><div class="small"><b>Tot Provvigioni '+m(l.provvTot||0)+"</b></div></div>"}function h(l){return'<div class="card" style="flex:1 1 460px"><div class="neon" style="font-weight:900">Totali squadra</div><div class="small" style="margin-top:6px">VSS '+m(l.vss)+'</div><div class="small">VSD Pers. '+m(l.vsdP)+'</div><div class="small">VSD Ind. '+m(l.vsdI)+'</div><div class="small">VSD Tot. '+m(l.vsdP+l.vsdI)+'</div><div class="small">GI '+m(l.gi)+'</div><div class="small">NNCF '+T(l.nncf)+'</div><div class="small muted" style="margin-top:6px">Provv GI '+m(l.provvGi)+'</div><div class="small muted">Provv VSD '+m(l.provvVsd)+'</div><div class="small"><b>Tot Provvigioni '+m(l.provvTot)+"</b></div></div>"}function o(){var l=(document.getElementById("t_mode")||{}).value||"consuntivo",b=M();Promise.all([re("/api/usernames"),re("/api/leaderboard?indicator="+encodeURIComponent("VSS")+b+"&mode="+encodeURIComponent(l)),re("/api/leaderboard?indicator="+encodeURIComponent("VSDPersonale")+b+"&mode="+encodeURIComponent(l)),re("/api/leaderboard?indicator="+encodeURIComponent("VSDIndiretto")+b+"&mode="+encodeURIComponent(l)),re("/api/leaderboard?indicator="+encodeURIComponent("GI")+b+"&mode="+encodeURIComponent(l)),re("/api/leaderboard?indicator="+encodeURIComponent("NNCF")+b+"&mode="+encodeURIComponent(l)),re("/api/leaderboard?indicator="+encodeURIComponent("ProvvGI")+b+"&mode="+encodeURIComponent(l)),re("/api/leaderboard?indicator="+encodeURIComponent("ProvvVSD")+b+"&mode="+encodeURIComponent(l))]).then(function(t){var P=t[0]||{},I=t[1]&&(t[1].rows||t[1].ranking)||[],Y=t[2]&&(t[2].rows||t[2].ranking)||[],E=t[3]&&(t[3].rows||t[3].ranking)||[],H=t[4]&&(t[4].rows||t[4].ranking)||[],k=t[5]&&(t[5].rows||t[5].ranking)||[],J=t[6]&&(t[6].rows||t[6].ranking)||[],z=t[7]&&(t[7].rows||t[7].ranking)||[],O=(P.users||[]).map(function(L){return{id:String(L.id),name:L.name||L.email||"User #"+L.id,grade:L.grade==="senior"?"senior":"junior"}}),q=document.getElementById("t_cons");q&&(q.innerHTML='<option value="">Tutti</option>'+O.map(function(L){return'<option value="'+L.id+'">'+Q(L.name)+"</option>"}).join(""));function W(L){for(var ee={},te=0;te<L.length;te++){var ie=L[te],se=String(ie.userId||ie.id||ie.uid||""),le=i(ie.total||ie.value||ie.sum||0);se&&(ee[se]=le)}return ee}var n=W(I),c=W(Y),v=W(E),g=W(H),S=W(k),G=W(J),oe=W(z),ne=O.map(function(L){var ee=i(n[L.id]),te=i(c[L.id]),ie=i(v[L.id]),se=i(g[L.id]),le=i(S[L.id]),Be=i(G[L.id]),Te=i(oe[L.id]);return{userId:L.id,name:L.name,grade:L.grade,vss:ee,vsdP:te,vsdI:ie,gi:se,nncf:le,provvGi:Be,provvVsd:Te,provvTot:Be+Te}}),u=document.getElementById("t_users");u&&(u.innerHTML=ne.length?ne.map(C).join(""):'<div class="muted">Nessun dato</div>');var N=ne.reduce(function(L,ee){return L.vss+=ee.vss,L.vsdP+=ee.vsdP,L.vsdI+=ee.vsdI,L.gi+=ee.gi,L.nncf+=ee.nncf,L.provvGi+=ee.provvGi,L.provvVsd+=ee.provvVsd,L.provvTot+=ee.provvTot,L},{vss:0,vsdP:0,vsdI:0,gi:0,nncf:0,provvGi:0,provvVsd:0,provvTot:0}),j=document.getElementById("t_agg");j&&(j.innerHTML=h(N)),V()}).catch(function(t){logger.error(t),X("Errore caricamento squadra")})}function y(l){return(typeof Xe=="function"?Xe(l,new Date):[]).map(function(b){return{s:b.s,e:b.e}})}function d(l,b,t,P){var I=P||ve("t"),Y=String(I.type||"mensile").toLowerCase(),E=Y==="ytd"||Y==="ltm"?"mensile":Y,H=y(Y);function k(z,O){var q=new Date(O.startDate).getTime(),W=new Date(O.endDate).getTime();return q>=z.s&&W<=z.e}function J(z,O){if(!z)return 0;if(O==="VSDTotale")return Number(z.VSDPersonale||0)+Number(z.VSDIndiretto||0);if(O==="ProvvGI")return Number(z.ProvvGI||0);if(O==="ProvvVSD")return Number(z.ProvvVSD||0);if(O==="TotProvvigioni"){var q=z.TotProvvigioni;return Number(q!=null?q:Number(z.ProvvGI||0)+Number(z.ProvvVSD||0))}return Number(z[O]||0)}return re("/api/periods?global=1").catch(function(){return re("/api/periods")}).then(function(z){var O=z&&z.periods||[],q=O.filter(function(n){return!(n.type!==E||t&&String(n.userId||n.uid||"")!==String(t))}),W=H.map(function(n){for(var c=0,v=0;v<q.length;v++){var g=q[v];if(k(n,g)){var S=b==="previsionale"?g.indicatorsPrev||{}:g.indicatorsCons||{};c+=J(S,f(l))}}return{x:new Date(n.s),y:Math.round(c*100)/100}});return W})}function V(){var l=document.getElementById("t_ind").value,b=document.getElementById("t_mode").value||"consuntivo",t=document.getElementById("t_cons").value||"",P=ve("t"),I=P.type,Y=f(l);M()+(t?"&userId="+encodeURIComponent(t):"")+("&indicator="+encodeURIComponent(Y))+("&mode="+encodeURIComponent(b));var E=d(Y,b,t||null,P);E.then(function(H){D(H,I)}).catch(function(H){logger.error(H),D([],I)})}ue("t",function(){typeof haptic=="function"&&haptic("light"),o()}),document.getElementById("t_mode").onchange=function(){typeof haptic=="function"&&haptic("light"),o()},document.getElementById("t_ind").onchange=function(){typeof haptic=="function"&&haptic("light"),V()},document.getElementById("t_cons").onchange=function(){typeof haptic=="function"&&haptic("light"),V()},o()}function Me(){if(!fe())return a();var e=fe().role==="admin";document.title="Battle Plan – Provvigioni",s.innerHTML=Pe()+'<div class="wrap"><div class="card"><b>Calcolo provvigioni</b><div class="row" style="margin-top:8px; gap:12px; flex-wrap:wrap">'+(e?'<div><label>Utente</label><select id="comm_user"><option value="__all">Tutta la squadra</option></select></div>':"")+'<div><label>Modalità</label><select id="comm_mode" name="mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div></div>'+U("comm")+'</div><div class="card"><b>Indicatori periodo</b><div id="comm_total" class="row" style="margin-top:8px; gap:12px; flex-wrap:wrap"></div></div><div class="card"><b>Provvigioni – ripartizione</b><div class="small muted">Confronto tra Provvigioni GI e Provvigioni VSD sul periodo selezionato</div><div class="row" style="margin-top:8px; align-items:center; gap:16px; flex-wrap:wrap"><canvas id="cm_pie_provv" width="260" height="260" style="max-width:260px; max-height:260px"></canvas><div id="cm_pie_legend" class="small"></div></div></div><div class="card"><b>Dettaglio</b><div id="comm_rows" class="row" style="margin-top:8px; gap:12px; flex-wrap:wrap"></div></div></div>',xe();function i(D){return document.getElementById(D)}function B(D){var C=Number(D)||0;return C.toLocaleString("it-IT")+"€"}function r(D){return D=Number(D==null?"":D),isFinite(D)?D:0}function M(D){return D?D.TotProvvigioni!=null?r(D.TotProvvigioni):r(D.ProvvGI)+r(D.ProvvVSD):0}function f(D,C){return'<div class="card" style="flex:1 1 180px"><div class="small muted">'+pe(D)+'</div><div style="font-weight:700; font-size:20px; margin-top:4px">'+C+"</div></div>"}function m(D){return""+f("VSD personale",B(D.vsd||0))+f("GI",B(D.gi||0))+f("Provv. VSD",B(D.provv_vsd||0))+f("Provv. GI",B(D.provv_gi||0))+f("Totale Provvigioni",B(D.provv_total||0))}function T(D){return D.length?D.map(function(C){return'<div class="card" style="flex:1 1 320px"><div><b>'+pe(C.name)+'</b></div><div class="small" style="margin-top:4px">GI '+B(C.gi||0)+" · VSD "+B(C.vsd||0)+'</div><div class="small muted" style="margin-top:2px">Provv. GI '+B(C.provv_gi||0)+" · Provv. VSD "+B(C.provv_vsd||0)+'</div><div class="small" style="margin-top:6px"><b>Totale: '+B(C.provv_total||0)+"</b></div></div>"}).join(""):'<div class="muted">Nessun dato</div>'}function Q(D,C,h){var o=document.getElementById("cm_pie_provv"),y=document.getElementById("cm_pie_legend");if(!o||!o.getContext){y&&(y.innerHTML="");return}var d=o.getContext("2d"),V=o.width,l=o.height,b=V/2,t=l/2,P=Math.min(V,l)/2-8;d.clearRect(0,0,V,l);var I=Math.max(0,D||0),Y=Math.max(0,C||0),E=I+Y,H=h>0?Math.round(E/h*100):null;if(E<=0){d.beginPath(),d.arc(b,t,P,0,Math.PI*2),d.strokeStyle="#ccd0d5",d.lineWidth=10,d.setLineDash([6,6]),d.stroke(),d.setLineDash([]),d.globalCompositeOperation="destination-out",d.beginPath(),d.arc(b,t,P*.55,0,Math.PI*2),d.fill(),d.globalCompositeOperation="source-over",d.fillStyle="#111",d.textAlign="center",d.textBaseline="middle",d.font="bold 20px system-ui, -apple-system, Segoe UI, Roboto, sans-serif",d.fillText(H==null?"—":H+"%",b,t),y&&(y.innerHTML='<div class="muted">Nessuna provvigione nel periodo</div>');return}var k=[{label:"Provv. GI",value:I,color:"#4F8EF7"},{label:"Provv. VSD",value:Y,color:"#F79F4F"}],J=-Math.PI/2;k.forEach(function(q){var W=q.value/E*Math.PI*2;d.beginPath(),d.moveTo(b,t),d.arc(b,t,P,J,J+W),d.closePath(),d.fillStyle=q.color,d.fill(),J+=W}),d.globalCompositeOperation="destination-out",d.beginPath(),d.arc(b,t,P*.55,0,Math.PI*2),d.fill(),d.globalCompositeOperation="source-over",d.fillStyle="#111",d.textAlign="center",d.textBaseline="middle",d.font="bold 20px system-ui, -apple-system, Segoe UI, Roboto, sans-serif",d.fillText(H==null?"—":H+"%",b,t);var z=Math.round(I/E*100),O=Math.round(Y/E*100);y&&(y.innerHTML='<div class="row" style="gap:16px; flex-wrap:wrap"><div class="row" style="gap:8px; align-items:center"><span style="display:inline-block;width:12px;height:12px;background:#4F8EF7;border-radius:3px"></span><span><b>Provv. GI</b> '+B(I)+" · "+z+'%</span></div><div class="row" style="gap:8px; align-items:center"><span style="display:inline-block;width:12px;height:12px;background:#F79F4F;border-radius:3px"></span><span><b>Provv. VSD</b> '+B(Y)+" · "+O+"%</span></div></div>")}function _(){var D=ve("comm"),C=i("comm_mode").value||"consuntivo",h=e?i("comm_user").value||"__all":String(fe().id),o=new Date(D.start).getTime(),y=new Date(D.end).getTime();re("/api/periods").then(function(d){var V=d&&d.periods||[],l=V.filter(function(P){var I=new Date(P.startDate).getTime(),Y=new Date(P.endDate).getTime();return!(I<o||Y>y||e&&h!=="__all"&&String(P.userId||P.uid||"")!==String(h)||!e&&String(P.userId||P.uid||"")!==String(fe().id))}),b={gi:0,vsd:0,provv_gi:0,provv_vsd:0,provv_total:0},t={};l.forEach(function(P){var I=C==="previsionale"?P.indicatorsPrev||{}:P.indicatorsCons||{},Y=String(P.userId||P.uid||""),E=P.userName||P.name||"User "+Y,H=r(I.GI),k=r(I.VSDPersonale),J=r(I.ProvvGI),z=r(I.ProvvVSD),O=M(I);b.gi+=H,b.vsd+=k,b.provv_gi+=J,b.provv_vsd+=z,b.provv_total+=O,t[Y]||(t[Y]={userId:Y,name:E,gi:0,vsd:0,provv_gi:0,provv_vsd:0,provv_total:0}),t[Y].gi+=H,t[Y].vsd+=k,t[Y].provv_gi+=J,t[Y].provv_vsd+=z,t[Y].provv_total+=O}),i("comm_total").innerHTML=m(b),i("comm_rows").innerHTML=T(Object.values(t).sort(function(P,I){return(I.provv_total||0)-(P.provv_total||0)})),Q(b.provv_gi||0,b.provv_vsd||0,b.gi||0)}).catch(function(d){logger.error(d),X("Errore nel caricamento dati")})}function R(){e&&re("/api/usernames").then(function(D){var C=i("comm_user");if(C){for(var h='<option value="__all">Tutta la squadra</option>',o=D&&D.users||[],y=0;y<o.length;y++){var d=o[y];h+='<option value="'+d.id+'">'+pe(d.name||"User "+d.id)+"</option>"}C.innerHTML=h}})}ue("comm",function(){_()}),i("comm_mode").onchange=function(){haptic("light"),_()},e&&(i("comm_user").onchange=function(){haptic("light"),_()}),R(),_()}function Ze(){if(!fe())return a();document.title="Battle Plan – Vendite e Riordini",s.innerHTML=Pe()+'\n    <div class="wrap">\n\n      <div class="card">\n        <b>Filtro</b>\n        <div class="row" style="margin-top:6px;align-items:flex-end;gap:16px;flex-wrap:wrap">\n          <div>\n            <label>Consulente</label>\n            <select id="vr_cons"><option value="">Tutti</option></select>\n          </div>\n        </div>\n        '.concat(U("vr"),'\n      </div>\n\n      <div class="card">\n        <b>Vendite e Riordini</b>\n        <div class="table" style="overflow:auto">\n          <table class="simple" style="min-width:980px">\n            <thead>\n              <tr>\n                <th>Data</th>\n                <th>Cliente</th>\n                <th>Consulente</th>\n              </tr>\n            </thead>\n            <tbody id="vr_rows">\n              <tr><td colspan="3" class="muted">Nessun dato</td></tr>\n            </tbody>\n          </table>\n        </div>\n      </div>\n\n    </div>'),xe(),ue("vr",()=>{})}function ct(){if(!fe())return a();document.title="Battle Plan – GI & Scadenzario",s.innerHTML=Pe()+'\n  <div class="wrap">\n\n    <div class="card">\n      <b>Filtro</b>\n      <div class="row" style="margin-top:6px;align-items:flex-end;gap:16px;flex-wrap:wrap">\n        <div>\n          <label>Consulente</label>\n          <select id="gi_cons"><option value="">Tutti</option></select>\n        </div>\n      </div>\n      '.concat(U("gi"),'\n    </div>\n\n    <div class="card">\n      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">\n        <b>Vendite (GI)</b>\n        <button class="ghost" id="gi_add">Nuova vendita</button>\n      </div>\n      <div class="table" style="overflow:auto">\n        <table class="simple" style="min-width:980px">\n          <thead>\n            <tr>\n              <th>Data vendita</th>\n              <th>Cliente</th>\n              <th>Consulente</th>\n              <th>Servizi</th>\n              <th style="text-align:right">Tot. VSS</th>\n              <th>Piano pagamenti</th>\n              <th></th>\n            </tr>\n          </thead>\n          <tbody id="gi_rows"></tbody>\n        </table>\n      </div>\n    </div>\n\n  </div>'),xe();const e=h=>document.getElementById(h),i=h=>String(h||"").replace(/[&<>'"]/g,o=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[o]),B=h=>(Number(h)||0).toLocaleString("it-IT")+"€",r=h=>{const o=new Date(h);return o.getFullYear()+"-"+("0"+(o.getMonth()+1)).slice(-2)+"-"+("0"+o.getDate()).slice(-2)};function M(){const h=window.readUnifiedRange&&window.readUnifiedRange("gi")||{};if(!h||!h.start||!h.end){const o=new Date,y=new Date(o.getFullYear(),0,1),d=new Date(o.getFullYear(),11,31,23,59,59);return{from:r(y),to:r(d)}}return{from:r(h.start),to:r(h.end)}}let f=[];function m(){return re("/api/clients").then(h=>(f=h&&h.clients||[],re("/api/usernames"))).then(h=>{const o=h&&h.users||[],y=e("gi_cons");y&&(y.innerHTML='<option value="">Tutti</option>'+o.map(d=>'<option value="'+i(String(d.id))+'">'+i(d.name)+"</option>").join(""))})}function T(h){const o=Array.isArray(h.schedule)?h.schedule.slice():[];if(!o.length)return'<span class="muted">—</span>';const y=o.find(t=>t.kind==="deposit"||/acconto/i.test(t.note||"")),d=o.filter(t=>t!==y),V=y?"Acconto: "+B(y.amount):"";if(!d.length)return V||'<span class="muted">—</span>';const l=Math.round(d[0].amount||0),b=d.every(t=>Math.abs(Math.round(t.amount||0)-l)<=1);return(V?V+" + ":"")+(b?d.length+" rate da "+B(l):"piano personalizzato")}function Q(h){return'<tr data-id="'+i(String(h.id))+'"><td>'+new Date(h.date||h.createdAt).toLocaleDateString("it-IT")+"</td><td>"+i(h.clientName||"")+"</td><td>"+i(h.consultantName||"")+"</td><td>"+i(h.services||"")+'</td><td style="text-align:right"><b>'+B(h.vssTotal||0)+"</b></td><td>"+T(h)+'</td><td class="right"><button class="ghost" data-edit="'+i(String(h.id))+'">Modifica</button></td></tr>'}function _(){const h=M(),o=(e("gi_cons")||{}).value||"",y="?from="+encodeURIComponent(h.from)+"&to="+encodeURIComponent(h.to)+(o?"&userId="+encodeURIComponent(o):"");re("/api/gi"+y).then(d=>{let V=d&&d.sales||[];V.sort((l,b)=>+new Date(b.date||b.createdAt||0)-+new Date(l.date||l.createdAt||0)),e("gi_rows").innerHTML=V.length?V.map(Q).join(""):'<tr><td colspan="7" class="muted">Nessuna vendita</td></tr>',D()}).catch(d=>{logger.error(d),X("Errore caricamento GI")})}function R(h){const o=h.sale||{},y=Array.isArray(o.schedule)?o.schedule.slice():[],d=y.find(v=>v.kind==="deposit"||/acconto/i.test(v.note||"")),V=y.filter(v=>v!==d),l=V.length>0?V.every(v=>Math.abs((+v.amount||0)-(+V[0].amount||0))<=1):!0,b=V.length&&l?"rate":"manual",t=r(new Date),P='<div class="modal"><div class="card gi-modal"><style>.gi-modal{min-width:min(760px,96vw);max-width:980px;max-height:86vh;overflow:auto}@media (max-width:740px){ .gi-grid{display:block} .gi-col{width:100%} .gi-modal{min-width:96vw} }.gi-grid{display:flex; gap:12px; flex-wrap:wrap} .gi-col{flex:1; min-width:240px}.gi-section{border-top:1px solid var(--hair, rgba(0,0,0,.12)); padding-top:10px; margin-top:10px}.pilltabs{display:flex; gap:12px; align-items:center} .pilltabs label{display:flex; align-items:center; gap:6px; cursor:pointer}.mrow{display:flex; gap:8px; align-items:center; flex-wrap:wrap}.mini input[type=number]{width:120px}.gi-rlist{margin-top:6px; max-height:200px; overflow:auto; border:1px dashed rgba(0,0,0,.15); border-radius:8px; padding:6px}.gi-r{display:flex; gap:6px; align-items:center; padding:4px 0}.gi-foot{display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:12px}</style><div style="display:flex;justify-content:space-between;align-items:center"><b>'+(h.title||(o.id?"Modifica vendita":"Nuova vendita"))+'</b><button class="ghost" id="m_close">Chiudi</button></div><div class="gi-grid"><div class="gi-col"><label>Data</label><input id="m_date" type="date" value="'+i(r(o.date||t))+'"></div><div class="gi-col"><label>Cliente</label><select id="gi_client_select"><option value="">Caricamento…</option></select></div><div class="gi-col"><label>Totale VSS</label><input id="m_vss" type="number" step="1" value="'+i(Number(o.vssTotal||0))+'"></div></div><div class="gi-section"><label>Servizi</label><textarea id="m_srv" rows="2">'+i(o.services||"")+'</textarea></div><div class="gi-section"><b>Acconto</b><div class="mrow mini" style="margin-top:6px"><label><input id="acc_enable" type="checkbox" '+(d?"checked":"")+'> Abilita</label><label>Tipo</label><select id="acc_type"><option value="abs">Valore assoluto</option><option value="perc">Percentuale</option></select><label>Valore</label><input id="acc_value" type="number" step="1" value="'+(d?i(Number(d._fromPerc?d._rawPerc:d.amount)):"0")+'"><label>Scadenza</label><input id="acc_date" type="date" value="'+i(r(d?d.dueDate:o.date||t))+'"><label>Nota</label><input id="acc_note" placeholder="es. Acconto" value="'+i(d&&d.note||"Acconto")+'"></div></div><div class="gi-section"><b>Modalità pagamenti</b><div class="pilltabs" style="margin:6px 0 8px"><label><input type="radio" name="pmode" value="rate" '+(b==="rate"?"checked":"")+'> Rateale</label><label><input type="radio" name="pmode" value="manual" '+(b!=="rate"?"checked":"")+'> Scaglioni manuali</label></div><div id="p_rate" style="display:'+(b==="rate"?"block":"none")+'"><div class="mrow mini"><label>N° rate</label><input id="rt_n" type="number" value="'+i(V.length||12)+'"><label>Frequenza</label><select id="rt_freq"><option value="M">Mensile</option><option value="Q">Trimestrale</option><option value="W">Settimanale</option><option value="Y">Annuale</option></select><label>Prima scadenza</label><input id="rt_first" type="date" value="'+i(V[0]?r(V[0].dueDate):r(o.date||t))+'"><button class="ghost" id="rt_build">Ricalcola rate</button></div><div id="rt_preview" class="gi-rlist muted small">—</div></div><div id="p_manual" style="display:'+(b!=="rate"?"block":"none")+'"><div class="mrow mini"><button class="ghost" id="mn_add">Aggiungi scaglione</button></div><div id="mn_list" class="gi-rlist"></div></div></div><div class="gi-foot"><div><div id="tot_prog" class="small muted">Programmato: 0€</div><div id="tot_chk"  class="small muted">Totale VSS: 0€</div></div><div style="display:flex;gap:8px">'+(o.id?'<button class="ghost danger" id="m_del">Elimina</button>':"")+'<button id="m_save">Salva</button></div></div></div></div>';showOverlay(P);const I=document.documentElement.style.overflow;document.documentElement.style.overflow="hidden";function Y(){document.documentElement.style.overflow=I,hideOverlay()}(function(){const g=e("gi_client_select");g.innerHTML='<option value="">— seleziona cliente —</option>'+f.map(G=>'<option value="'+i(G.id)+'">'+i(G.name)+"</option>").join("");const S=o.clientId||o.client_id||"";if(S&&(g.value=String(S)),!g.value&&o.clientName){const G=f.find(oe=>String(oe.name).trim().toLowerCase()===String(o.clientName).trim().toLowerCase());G&&(g.value=String(G.id))}})(),d&&d._fromPerc&&(e("acc_type").value="perc"),Array.from(document.querySelectorAll('input[name="pmode"]')).forEach(v=>{v.addEventListener("change",()=>{const g=document.querySelector('input[name="pmode"]:checked').value==="rate";e("p_rate").style.display=g?"block":"none",e("p_manual").style.display=g?"none":"block",c()})});function E(v,g){const S=new Date(v);return S.setMonth(S.getMonth()+g),S}function H(v,g){const S=new Date(v);return S.setDate(S.getDate()+g*7),S}function k(v,g){const S=new Date(v);return S.setMonth(S.getMonth()+g*3),S}function J(v,g){const S=new Date(v);return S.setFullYear(S.getFullYear()+g),S}function z(){const v=Math.max(1,Number(e("rt_n").value||0)),g=e("rt_freq").value,S=new Date(e("rt_first").value||t),G=Math.max(0,Number(e("m_vss").value||0)),oe=W(),ne=Math.max(0,G-oe),u=Math.round(ne/v),N=[];for(let j=0;j<v;j++){let L;g==="M"?L=E(S,j):g==="Q"?L=k(S,j):g==="W"?L=H(S,j):L=J(S,j),N.push({dueDate:L.toISOString(),amount:u,note:"Rata "+(j+1)+"/"+v,kind:"installment"})}return O(N),N}function O(v){e("rt_preview").innerHTML=v.map(g=>"<div>"+new Date(g.dueDate).toLocaleDateString("it-IT")+" · "+B(g.amount)+' <span class="muted">'+i(g.note||"")+"</span></div>").join(""),e("rt_preview")._data=v,c()}function q(v){const g=e("mn_list");g.innerHTML="",v.forEach((S,G)=>{const oe=document.createElement("div");oe.className="gi-r",oe.innerHTML='<input type="date" data-k="dueDate" value="'+i(r(S.dueDate))+'"><input type="number" step="1" data-k="amount" value="'+i(Number(S.amount||0))+'" style="width:120px"><input type="text" data-k="note"   value="'+i(S.note||"")+'" placeholder="nota" style="flex:1"><button class="ghost" data-del="'+G+'">✕</button>',g.appendChild(oe)}),g.querySelectorAll("[data-del]").forEach(S=>{S.onclick=()=>{const G=Number(S.getAttribute("data-del")),oe=g._data||[];oe.splice(G,1),q(oe)}}),g.oninput=()=>{const S=g._data||[];Array.from(g.children).forEach((oe,ne)=>{const u=S[ne];if(!u)return;const N=oe.querySelector('[data-k="dueDate"]').value,j=Number(oe.querySelector('[data-k="amount"]').value||0),L=oe.querySelector('[data-k="note"]').value;u.dueDate=new Date(N).toISOString(),u.amount=Math.round(j),u.note=L}),c()},g._data=v,c()}if(e("m_date").value=i(r(o.date||t)),e("m_vss").value=i(Number(o.vssTotal||0)),e("m_srv").value=i(o.services||""),e("acc_type").value=d&&d._fromPerc?"perc":"abs",e("acc_value").value=d?d._fromPerc?d._rawPerc:d.amount:0,e("acc_date").value=i(r(d?d.dueDate:o.date||t)),e("acc_note").value=d?i(d.note||"Acconto"):"Acconto",b==="rate"){const v=V.length||12;e("rt_n").value=v,e("rt_first").value=V[0]?i(r(V[0].dueDate)):i(r(o.date||t)),O(V.length?V:z())}else q(V);e("rt_build").onclick=()=>O(z()),e("mn_add").onclick=()=>{const g=e("mn_list")._data||[];g.push({dueDate:new Date().toISOString(),amount:0,note:"",kind:"manual"}),q(g)},e("m_close").onclick=Y;function W(){if(!e("acc_enable").checked)return 0;const v=Math.max(0,Number(e("m_vss").value||0)),g=e("acc_type").value,S=Number(e("acc_value").value||0);return Math.round(g==="perc"?v*(S/100):S)}function n(){const v=[];if(e("acc_enable").checked){const S=W();v.push({dueDate:new Date(e("acc_date").value||t).toISOString(),amount:S,note:e("acc_note").value||"Acconto",kind:"deposit",_fromPerc:e("acc_type").value==="perc",_rawPerc:Number(e("acc_value").value||0)})}if(document.querySelector('input[name="pmode"]:checked').value==="rate"){const S=(e("rt_preview")._data||[]).map(G=>Object.assign({},G));return v.concat(S)}else{const S=(e("mn_list")._data||[]).map(G=>Object.assign({kind:"manual"},G));return v.concat(S)}}function c(){const v=Math.max(0,Number(e("m_vss").value||0)),g=n(),S=Math.round(g.reduce((G,oe)=>G+Number(oe.amount||0),0));e("tot_prog").textContent="Programmato: "+B(S),e("tot_chk").textContent="Totale VSS: "+B(v)+(S===v?" OK":" (manca "+B(v-S)+")"),e("m_save").disabled=S!==v||!e("gi_client_select").value}if(["m_vss","acc_enable","acc_type","acc_value","acc_date","rt_n","rt_freq","rt_first"].forEach(v=>{const g=e(v);g&&g.addEventListener("input",c)}),e("gi_client_select").addEventListener("change",c),c(),e("m_save").onclick=()=>{const v=e("gi_client_select").value||"",g=f.find(G=>String(G.id)===String(v));if(!g){X("Seleziona un cliente");return}const S={id:o.id||void 0,date:new Date(e("m_date").value||t).toISOString(),clientId:g.id,clientName:g.name,vssTotal:Math.round(Number(e("m_vss").value||0)),services:e("m_srv").value||"",schedule:n()};Promise.resolve(Fe("/api/gi",S)).then(()=>{Y(),haptic("light"),_()}).catch(G=>{logger.error(G),X("Errore salvataggio")})},o.id){const v=e("m_del");v&&(v.onclick=async()=>{if(confirm("Eliminare definitivamente questa vendita?"))try{await Fe("/api/gi/delete",{id:o.id}).catch(()=>Fe("/api/gi",{id:o.id,_delete:1})),Y(),X("Vendita eliminata"),_()}catch(g){logger.error(g),X("Errore eliminazione")}})}}function D(){document.querySelectorAll("[data-edit]").forEach(h=>{h.addEventListener("click",()=>{const o=h.getAttribute("data-edit");C(o)})})}document.addEventListener("gi:edit",function(h){const o=h&&h.detail&&h.detail.id;o&&C(o)}),e("gi_add").onclick=()=>{R({title:"Nuova vendita"})};function C(h){re("/api/gi?from=1900-01-01&to=2999-12-31").then(o=>{const y=(o&&o.sales||[]).find(d=>String(d.id)===String(h));if(!y){X("Vendita non trovata");return}R({title:"Modifica vendita",sale:y})})}ue("gi",()=>{haptic("light"),_()}),(e("gi_cons")||{}).onchange=()=>{haptic("light"),_()},m().then(_)}window.viewGI=window.viewGI||ct;function It(){if(!fe())return a();document.title="Battle Plan – Report",s.innerHTML=Pe()+'<div class="wrap"><div class="card"><b>Sezioni da includere</b><div id="rep_toggles" class="row" style="margin-top:8px; gap:8px; flex-wrap:wrap"><button class="pill" data-type="mensile" id="tog_mese">Mese</button><button class="pill" data-type="trimestrale" id="tog_trimestre">Trimestre</button><button class="pill" data-type="semestrale" id="tog_semestre">Semestre</button><button class="pill" data-type="annuale" id="tog_anno">Anno</button></div></div><div class="card"><b>Report</b><div class="row" style="margin-top:8px"><div style="min-width:320px"><label>Oggetto email</label><input id="report_subject" placeholder="Report BP"></div></div><div class="row" style="margin-top:8px; flex-wrap:wrap"><div style="flex:1 1 100%; min-width:0"><label>Corpo email</label><textarea id="report_body" rows="12" placeholder="Testo del report…" style="width:100%; box-sizing:border-box; overflow:auto; resize:vertical; max-height:70vh; white-space:pre-wrap; word-break:break-word"></textarea></div></div><div class="row" id="report-actions" style="gap:8px;margin-top:8px;flex-wrap:wrap"><button class="ghost" id="rep_copy">Copia report</button><span style="flex:0 0 8px"></span><button class="ghost" id="rep_gmail_web">Gmail Web</button><button class="ghost" id="rep_gmail_app">Gmail App</button></div></div></div>',xe();var e=[],i={mensile:!1,trimestrale:!1,semestrale:!1,annuale:!1},B=[{k:"VSS",money:!0,label:"VSS"},{k:"VSDPersonale",money:!0,label:"VSDPersonale"},{k:"VSDIndiretto",money:!0,label:"VSDIndiretto"},{k:"GI",money:!0,label:"GI"},{k:"Telefonate",money:!1,label:"Telefonate"},{k:"AppFissati",money:!1,label:"AppFissati"},{k:"AppFatti",money:!1,label:"AppFatti"},{k:"CorsiLeadership",money:!1,label:"CorsiLeadership"},{k:"iProfile",money:!1,label:"iProfile"},{k:"MBS",money:!1,label:"MBS"},{k:"NNCF",money:!1,label:"NNCF"}];function r(u){return document.getElementById(u)}var M=r("report_body");function f(u,N){var j=new Date(u.getTime());return j.setDate(j.getDate()+N),j}function m(u){return $e(u.getFullYear(),ye(u))}function T(u){var N=m(u);return m(f(N.start,7))}function Q(u){var N=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];return N[u.getMonth()]}function _(u){return Math.floor(u.getMonth()/3)+1}function R(u){return u.getMonth()<6?1:2}function D(u){var N=u.getDay();return N===5||N===6||N===0}function C(u,N){return u==="mensile"?{start:vt(N),end:mt(N)}:u==="trimestrale"?{start:lt(N),end:pt(N)}:u==="semestrale"?{start:st(N),end:ft(N)}:{start:bt(N),end:rt(N)}}function h(u,N){return N>=f(u,-7)&&N<=f(u,5)}function o(u,N){var j=C(u,N),L=C(u,f(j.start,-1)),ee=C(u,f(j.end,1)),te=h(L.end,N),ie=h(j.end,N);return te&&!ie?{closing:L,next:j}:{closing:j,next:ee}}function y(u,N,j){for(var L=0;L<e.length;L++){var ee=e[L];if(ee.type===u&&Ge(ee.startDate)===Ge(N)&&Ge(ee.endDate)===Ge(j))return ee}return null}function d(u,N){var j=u&&u[N];return Number(j||0)}function V(u){return Ee(u)+"€"}function l(u,N){var j=B.some(function(L){return L.k===u&&L.money});return j?V(N):Ee(N)}function b(u,N){return u>N?"↑":u<N?"↓":"="}function t(u,N,j,L){var ee=y(N,j,L)||{},te=ee.indicatorsPrev||{},ie=ee.indicatorsCons||{},se=[u,""];return B.forEach(function(le){var Be=d(te,le.k),Te=d(ie,le.k);se.push(le.label+" "+l(le.k,Te)+" vs "+l(le.k,Be)+" di previsionali ("+b(Te,Be)+")")}),se.push("Note:"),se.join("\n")}function P(u,N,j,L){var ee=y(N,j,L)||{},te=ee.indicatorsPrev||{},ie=[u,""];return B.forEach(function(se){ie.push(se.label+" "+l(se.k,d(te,se.k)))}),ie.push("Possibili note:"),ie.join("\n")}function I(u){return"BP CONSUNTIVO SETT. "+ye(u)+" "+u.getFullYear()}function Y(u){return"BP PREVISIONALE SETT. "+ye(u)+" "+u.getFullYear()}function E(u){return"BP CONSUNTIVO "+Q(u)+" "+u.getFullYear()}function H(u){var N=Q(u);return"BP PREVISIONALE "+N+" "+u.getFullYear()}function k(u){return"BP CONSUNTIVO T"+_(u)+" "+u.getFullYear()}function J(u){return"BP PREVISIONALE T"+_(u)+" "+u.getFullYear()}function z(u){return"BP CONSUNTIVO S"+R(u)+" "+u.getFullYear()}function O(u){return"BP PREVISIONALE S"+R(u)+" "+u.getFullYear()}function q(u){return"BP CONSUNTIVO "+u.getFullYear()}function W(u){return"BP PREVISIONALE "+u.getFullYear()}function n(){var u=new Date,N=[];if(D(u)){var j=m(u),L=T(u);N.push(t(I(j.start),"settimanale",j.start,j.end)),N.push(P(Y(L.start),"settimanale",L.start,L.end))}function ee(te,ie,se){var le=o(te,u);N.push(t(ie(le.closing.start),te,le.closing.start,le.closing.end)),N.push(P(se(le.next.start),te,le.next.start,le.next.end))}i.mensile&&ee("mensile",E,H),i.trimestrale&&ee("trimestrale",k,J),i.semestrale&&ee("semestrale",z,O),i.annuale&&ee("annuale",q,W),M.value=N.join("\n\n")+(N.length?"\n":"")}function c(u,N){u.classList.toggle("active",!!N),u.style.opacity=N?"1":"0.65"}function v(){c(r("tog_mese"),i.mensile),c(r("tog_trimestre"),i.trimestrale),c(r("tog_semestre"),i.semestrale),c(r("tog_anno"),i.annuale)}function g(){var u=new Date;function N(j){var L=C(j,u),ee=C(j,f(L.start,-1));return h(L.end,u)||h(ee.end,u)}i.mensile=N("mensile"),i.trimestrale=N("trimestrale"),i.semestrale=N("semestrale"),i.annuale=N("annuale"),v()}function S(){function u(N){var j=N.currentTarget.getAttribute("data-type");i[j]=!i[j],v(),n()}r("tog_mese").onclick=u,r("tog_trimestre").onclick=u,r("tog_semestre").onclick=u,r("tog_anno").onclick=u}function G(u){return encodeURIComponent(String(u||""))}function oe(){var u=r("rep_gmail_web"),N=r("rep_gmail_app"),j=r("rep_copy");j&&(j.onclick=function(){try{navigator.clipboard.writeText(M.value||"");var L=j.textContent;j.textContent="Copiato!",setTimeout(function(){j.textContent=L},1200)}catch(ee){}}),!(!u||!N)&&re("/api/users_emails").then(function(L){var ee=(L&&L.emails||(L&&L.users||[]).map(function(se){return se.email})).filter(Boolean).join(",");function te(){return r("report_subject").value||"Report BP"}function ie(){return M.value||""}u.onclick=function(){try{navigator.clipboard.writeText(ie())}catch(le){}var se="https://mail.google.com/mail/?view=cm&fs=1&tf=1&su="+G(te())+"&cc="+G(ee)+"&body="+G(ie());window.open(se,"_blank"),document.dispatchEvent(new Event("report:composed"))},N.onclick=function(){try{navigator.clipboard.writeText(ie())}catch(le){}var se="googlegmail:///co?subject="+G(te())+"&cc="+G(ee)+"&body="+G(ie());location.href=se,document.dispatchEvent(new Event("report:composed")),setTimeout(function(){document.hidden||(location.href="mailto:?subject="+G(te())+"&cc="+G(ee)+"&body="+G(ie()),document.dispatchEvent(new Event("report:composed")))},1200)}})}function ne(){re("/api/periods").then(function(u){e=u&&u.periods||[],g(),S(),n(),oe()})}ne()}function St(){var e=fe();if(!e)return a();if(document.title="Battle Plan – Utenti",e.role!=="admin"){s.innerHTML=Pe()+'<div class="wrap"><div class="card"><b>Il mio profilo</b><div class="row" style="margin-top:8px"><div><label>Nome</label><input id="p_name" type="text" value="'+pe(e.name||"")+'"></div><div><label>Email</label><input id="p_email" type="email" value="'+pe(e.email||"")+'"></div></div><div class="row"><div><label>Nuova password</label><input id="p_pwd" type="password" placeholder="Lascia vuoto per non cambiare"></div><div class="right" style="align-self:flex-end"><button id="p_save">Aggiorna</button></div></div><div class="row"><div><label>Ruolo</label><input value="'+pe(e.role||"consultant")+'" disabled></div><div><label>Grade</label><input value="'+pe(e.grade||"junior")+'" disabled></div></div></div></div>',xe(),Ve("#p_save").onclick=function(){var r=Ve("#p_name").value.trim(),M=Ve("#p_email").value.trim(),f=Ve("#p_pwd").value,m={id:e.id,name:r,email:M};f&&(m.password=f),Fe("/api/users",m).then(function(){X("Profilo aggiornato"),window.addXP(3);var T=fe();T&&(T.name=r,T.email=M,localStorage.setItem("user",JSON.stringify(T)));try{document.dispatchEvent(new Event("user:profile-updated"))}catch(Q){}}).catch(function(T){logger.error(T),X("Errore aggiornamento")})};return}s.innerHTML=Pe()+'<div class="wrap"><div class="card"><b>Gestione utenti</b><div id="users_list" class="row" style="margin-top:8px"></div></div></div>',xe();function i(r){var M=pe(r.name||r.email||"user_"+r.id),f=r.grade==="senior"?"senior":"junior",m=r.role==="admin"?"admin":"consultant";return'<div class="card" style="flex:1 1 380px"><div><b>'+M+'</b> <span class="small muted">('+pe(m)+')</span></div><div class="row" style="margin-top:6px"><div><label>Nome</label><input data-nfor="'+r.id+'" type="text" value="'+pe(r.name||"")+'"></div><div><label>Email</label><input data-efor="'+r.id+'" type="email" value="'+pe(r.email||"")+'"></div></div><div class="row"><div><label>Nuova password</label><input data-pfor="'+r.id+'" type="password" placeholder="(opzionale)"></div><div><label>Grade</label><select data-gfor="'+r.id+'"><option value="junior"'+(f==="junior"?" selected":"")+'>Junior</option><option value="senior"'+(f==="senior"?" selected":"")+'>Senior</option></select></div><div><label>Ruolo</label><select data-rfor="'+r.id+'"><option value="consultant"'+(m==="consultant"?" selected":"")+'>Consulente</option><option value="admin"'+(m==="admin"?" selected":"")+'>Admin</option></select></div><div class="right" style="align-self:flex-end"><button class="ghost" data-save="'+r.id+'">Aggiorna</button> <button class="danger" data-del="'+r.id+'" title="Elimina utente">Elimina</button></div></div></div>'}function B(){re("/api/users").then(function(r){var M=r&&r.users||[],f=Ve("#users_list");f&&(f.innerHTML=M.map(i).join(""),gt("[data-save]").forEach(function(m){m.addEventListener("click",function(){var T=m.getAttribute("data-save"),Q=(Ve('input[data-nfor="'+T+'"]')||{}).value||"",_=(Ve('input[data-efor="'+T+'"]')||{}).value||"",R=(Ve('select[data-gfor="'+T+'"]')||{}).value||"junior",D=(Ve('select[data-rfor="'+T+'"]')||{}).value||"consultant",C=Ve('input[data-pfor="'+T+'"]'),h=C?C.value:"",o={id:T,name:Q,email:_,grade:R,role:D};h&&(o.password=h),Fe("/api/users",o).then(function(){X("Aggiornato"),window.addXP(5),C&&(C.value="")}).catch(function(y){logger.error(y),X("Errore aggiornamento")})})}),gt("[data-del]").forEach(function(m){m.addEventListener("click",function(){var T=m.getAttribute("data-del");confirm("Eliminare definitivamente questo utente?")&&fetch("/api/users?id="+encodeURIComponent(T),{method:"DELETE",headers:{Authorization:"Bearer "+ot()}}).then(function(Q){if(!Q.ok)throw new Error("HTTP "+Q.status);return Q.json()}).then(function(){X("Utente eliminato"),B()}).catch(function(Q){logger.error(Q),X("Errore eliminazione")})})}))})}B()}window.viewHome=he,window.viewCalendar=_e,window.viewPeriods=Ie,window.viewAppointments=me,window.viewLeaderboard=Ue,window.viewClients=De,window.viewTeam=Oe,window.viewCommissions=Me,window.viewVendite=Ze,window.viewReport=It,window.viewUsers=St,window.toggleDrawer=dt,window.logout=Vt,window.rerenderTopbarSoon=Kt,document.addEventListener("DOMContentLoaded",function(){fe()?(xe(),he()):a()})})();export{Qt as __vite_legacy_guard};
