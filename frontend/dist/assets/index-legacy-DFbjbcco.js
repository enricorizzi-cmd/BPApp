!function(){function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */var e,a,i="function"==typeof Symbol?Symbol:{},o=i.iterator||"@@iterator",r=i.toStringTag||"@@toStringTag";function l(t,i,o,r){var l=i&&i.prototype instanceof s?i:s,c=Object.create(l.prototype);return n(c,"_invoke",function(t,n,i){var o,r,l,s=0,c=i||[],u=!1,v={p:0,n:0,v:e,a:p,f:p.bind(e,4),d:function(t,n){return o=t,r=0,l=e,v.n=n,d}};function p(t,n){for(r=t,l=n,a=0;!u&&s&&!i&&a<c.length;a++){var i,o=c[a],p=v.p,m=o[2];t>3?(i=m===n)&&(l=o[(r=o[4])?5:(r=3,3)],o[4]=o[5]=e):o[0]<=p&&((i=t<2&&p<o[1])?(r=0,v.v=n,v.n=o[1]):p<m&&(i=t<3||o[0]>n||n>m)&&(o[4]=t,o[5]=n,v.n=m,r=0))}if(i||t>1)return d;throw u=!0,n}return function(i,c,m){if(s>1)throw TypeError("Generator is already running");for(u&&1===c&&p(c,m),r=c,l=m;(a=r<2?e:l)||!u;){o||(r?r<3?(r>1&&(v.n=-1),p(r,l)):v.n=l:v.v=l);try{if(s=2,o){if(r||(i="next"),a=o[i]){if(!(a=a.call(o,l)))throw TypeError("iterator result is not an object");if(!a.done)return a;l=a.value,r<2&&(r=0)}else 1===r&&(a=o.return)&&a.call(o),r<2&&(l=TypeError("The iterator does not provide a '"+i+"' method"),r=1);o=e}else if((a=(u=v.n<0)?l:t.call(n,v))!==d)break}catch(a){o=e,r=1,l=a}finally{s=1}}return{value:a,done:u}}}(t,o,r),!0),c}var d={};function s(){}function c(){}function u(){}a=Object.getPrototypeOf;var v=[][o]?a(a([][o]())):(n(a={},o,function(){return this}),a),p=u.prototype=s.prototype=Object.create(v);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,u):(e.__proto__=u,n(e,r,"GeneratorFunction")),e.prototype=Object.create(p),e}return c.prototype=u,n(p,"constructor",u),n(u,"constructor",c),c.displayName="GeneratorFunction",n(u,r,"GeneratorFunction"),n(p),n(p,r,"Generator"),n(p,o,function(){return this}),n(p,"toString",function(){return"[object Generator]"}),(t=function(){return{w:l,m:m}})()}function n(e,t,a,i){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}n=function(e,t,a,i){function r(t,a){n(e,t,function(e){return this._invoke(t,a,e)})}t?o?o(e,t,{value:a,enumerable:!i,configurable:!i,writable:!i}):e[t]=a:(r("next",0),r("throw",1),r("return",2))},n(e,t,a,i)}function a(e){return function(e){if(Array.isArray(e))return c(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||s(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function i(e,t,n,a,i,o,r){try{var l=e[o](r),d=l.value}catch(e){return void n(e)}l.done?t(d):Promise.resolve(d).then(a,i)}function o(e){return function(){var t=this,n=arguments;return new Promise(function(a,o){var r=e.apply(t,n);function l(e){i(r,a,o,l,d,"next",e)}function d(e){i(r,a,o,l,d,"throw",e)}l(void 0)})}}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,a)}return n}function l(t,n,a){return(n=function(t){var n=function(t,n){if("object"!=e(t)||!t)return t;var a=t[Symbol.toPrimitive];if(void 0!==a){var i=a.call(t,n||"default");if("object"!=e(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===n?String:Number)(t)}(t,"string");return"symbol"==e(n)?n:n+""}(n))in t?Object.defineProperty(t,n,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[n]=a,t}function d(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=s(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var a=0,i=function(){};return{s:i,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,r=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return r=e.done,e},e:function(e){l=!0,o=e},f:function(){try{r||null==n.return||n.return()}finally{if(l)throw o}}}}function s(e,t){if(e){if("string"==typeof e)return c(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?c(e,t):void 0}}function c(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,a=Array(t);n<t;n++)a[n]=e[n];return a}System.register([],function(e,n){"use strict";return{execute:function(){var e=document.createElement("style");function n(e,t){localStorage.setItem(e,"string"==typeof t?t:JSON.stringify(t))}function i(e,t){var n=localStorage.getItem(e);if(null==n)return t;try{return JSON.parse(n)}catch(a){return n}}function s(e){localStorage.removeItem(e)}function c(){return localStorage.getItem("bp_token")||sessionStorage.getItem("bp_token")||""}function u(){return i("bp_user",null)||null}function v(){s("bp_token"),sessionStorage.removeItem("bp_token"),s("bp_user"),location.href="/?v=13"}function p(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t.method=t.method||"GET";var n=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach(function(t){l(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}({},t.headers||{}),a=c();return a&&(n.Authorization="Bearer "+a),null!=t.body&&"string"!=typeof t.body&&(n["Content-Type"]="application/json; charset=utf-8",t.body=JSON.stringify(t.body)),t.headers=n,fetch(e,t).then(m)}function m(e){return g.apply(this,arguments)}function g(){return(g=o(t().m(function e(n){var a;return t().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,n.text();case 1:if(a=e.v,n.ok){e.n=2;break}throw f(a,n);case 2:return e.a(2,b(a,n))}},e)}))).apply(this,arguments)}function f(e,t){try{var n=JSON.parse(e).error||"";return new Error(n||t.statusText||"HTTP "+t.status)}catch(a){return new Error(t.statusText||"HTTP "+t.status)}}function b(e,t){try{if(-1!==(t.headers.get("content-type")||"").toLowerCase().indexOf("application/json"))return e?JSON.parse(e):{}}catch(n){}return e}function y(e,t){return p(e,Object.assign({method:"GET"},{}))}function h(e,t){return p(e,{method:"POST",body:t||{}})}function w(e){return(e<10?"0":"")+e}function _(e){var t=new Date(e);return w(t.getDate())+"/"+w(t.getMonth()+1)+"/"+t.getFullYear()}function x(e){var t=new Date(e);return t.getFullYear()+"-"+w(t.getMonth()+1)+"-"+w(t.getDate())}function S(e){var t=new Date(e);return new Date(t.getFullYear(),t.getMonth(),1)}function I(e){var t=new Date(e);return new Date(t.getFullYear(),t.getMonth()+1,0,23,59,59,999)}function D(e){var t=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate())),n=t.getUTCDay()||7;t.setUTCDate(t.getUTCDate()+4-n);var a=new Date(Date.UTC(t.getUTCFullYear(),0,1));return Math.ceil(((t-a)/864e5+1)/7)}function E(e){var t=new Date(e),n=Math.floor(t.getMonth()/3);return new Date(t.getFullYear(),3*n,1)}function B(e){var t=E(e);return new Date(t.getFullYear(),t.getMonth()+3,0,23,59,59,999)}function P(e){var t=new Date(e),n=t.getMonth()<6?0:6;return new Date(t.getFullYear(),n,1)}function T(e){var t=P(e);return new Date(t.getFullYear(),t.getMonth()+6,0,23,59,59,999)}function C(e){var t=new Date(e);return new Date(t.getFullYear(),0,1)}function k(e){var t=new Date(e);return new Date(t.getFullYear(),11,31,23,59,59,999)}function M(e,t){var n=function(e,t){var n=new Date(e,0,1+7*(t-1)),a=n.getDay()||7,i=new Date(n);return i.setDate(n.getDate()-(a-1)),i.setHours(0,0,0,0),i}(e,t),a=new Date(n);return a.setDate(n.getDate()+6),a.setHours(23,59,59,999),{start:n,end:a}}function N(e){var t=function(e){var t=new Date(e);t.setHours(0,0,0,0);var n=(t.getDay()+6)%7;return t.setDate(t.getDate()-n),t}(e);t.setDate(t.getDate()+7);var n=new Date(t);return n.setDate(t.getDate()+6),n.setHours(23,59,59,999),{start:t,end:n}}function A(e,t){var n=new Date(t);return"settimanale"===e?"Sett. "+D(new Date(t))+" "+n.getFullYear():"mensile"===e?n.toLocaleString("it-IT",{month:"long",year:"numeric"}):"trimestrale"===e?"Trimestre "+(Math.floor(n.getMonth()/3)+1)+" "+n.getFullYear():"semestrale"===e?(n.getMonth()<6?"1°":"2°")+" semestre "+n.getFullYear():"annuale"===e?"Anno "+n.getFullYear():"ytd"===e?"YTD "+n.getFullYear():"ltm"===e?"Ultimi 12 mesi":e}function L(e){var t=document.createElement("div");t.className="toast",t.textContent=e,document.body.appendChild(t),setTimeout(function(){try{t.remove()}catch(e){}},2200)}function F(){var e=document.createElement("div");e.className="confetti",document.body.appendChild(e);for(var t=0;t<26;t++){var n=document.createElement("span");n.style.position="absolute",n.style.left=2+4*t+"%",n.style.top="0",n.style.width="6px",n.style.height="10px",n.style.background="hsl("+14*t+",90%,60%)",n.style.opacity="0.95",e.appendChild(n),function(e,t){setTimeout(function(){e.animate&&e.animate([{transform:"translateY(-20px) rotate(0deg)"},{transform:"translateY(110vh) rotate(540deg)"}],{duration:1200+800*Math.random(),easing:"cubic-bezier(.2,.6,.2,1)"})},t)}(n,35*t)}setTimeout(function(){try{e.remove()}catch(t){}},2500)}function V(e){return String(e).replace(/[&<>'"]/g,function(e){return{"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"}[e]})}function O(e){return(Number(e)||0).toLocaleString("it-IT")+"€"}function U(e){var t=Number(e)||0;return String(Math.round(t))}function j(){var e=u();if(!e)return"";var t="admin"===e.role;return'<div class="topbar"><div class="brand"><button class="hamb" id="hamb" aria-label="Apri menu" aria-controls="drawer" aria-expanded="false"><span></span><span></span><span></span></button><div class="logo">BATTLE PLAN</div></div><div class="nav right">'+('<span class="badge">Lvl '+(window.level?window.level():"")+" · XP "+(window.getXP?window.getXP():"")+"</span>")+'<button class="ghost" onclick="viewHome()">Dashboard</button><button class="ghost" onclick="viewCalendar()">Calendario</button><button class="ghost" onclick="viewPeriods()">BP</button><button class="ghost" onclick="viewAppointments()">Appuntamenti</button><button class="ghost" onclick="viewLeaderboard()">Classifiche</button><button class="ghost" onclick="viewCommissions()">Provvigioni</button><button class="ghost" onclick="viewGI()">GI &amp; Scadenzario</button><button class="ghost" onclick="viewReport()">Report</button><button class="ghost" onclick="viewClients()">Clienti</button><button class="ghost" onclick="viewTeam()">Squadra</button>'+(t?'<button class="ghost" onclick="viewUsers()">Utenti</button>':"")+'<button onclick="logout()">Logout</button></div></div>'+('<div id="drawer" class="drawer" role="dialog" aria-modal="true" aria-label="Menu"><div class="row"><button class="ghost" onclick="viewHome();toggleDrawer(false)">Dashboard</button><button class="ghost" onclick="viewCalendar();toggleDrawer(false)">Calendario</button><button class="ghost" onclick="viewPeriods();toggleDrawer(false)">BP</button><button class="ghost" onclick="viewAppointments();toggleDrawer(false)">Appuntamenti</button><button class="ghost" onclick="viewLeaderboard();toggleDrawer(false)">Classifiche</button><button class="ghost" onclick="viewCommissions();toggleDrawer(false)">Provvigioni</button><button class="ghost" onclick="viewGI();toggleDrawer(false)">GI &amp; Scadenzario</button><button class="ghost" onclick="viewReport();toggleDrawer(false)">Report</button><button class="ghost" onclick="viewClients();toggleDrawer(false)">Clienti</button><button class="ghost" onclick="viewTeam();toggleDrawer(false)">Squadra</button>'+(t?'<button class="ghost" onclick="viewUsers();toggleDrawer(false)">Utenti</button>':"")+'<button onclick="logout()">Logout</button></div></div>')}function H(){if(u()){if(!document.getElementById("bp_nav_contrast_css")){var e=document.createElement("style");e.id="bp_nav_contrast_css",e.textContent="\n      @media (min-width: 1024px){\n        .topbar .nav .ghost{\n          background: rgba(255,255,255,.06);\n          border: 1px solid rgba(255,255,255,.18);\n        }\n        .topbar .nav .ghost:hover{\n          background: rgba(255,255,255,.12);\n        }\n      }\n    ",document.head.appendChild(e)}var t=document.getElementById("app"),n=document.querySelector(".topbar"),a=j();n?n.outerHTML=a:t&&t.insertAdjacentHTML("afterbegin",a);try{!function(){if(!document.getElementById("bp-mobile-drawer-fix")){var e=document.createElement("style");e.id="bp-mobile-drawer-fix",e.textContent="\n  @media (max-width:980px){\n    .topbar{\n      background: rgba(20,24,34,.90) !important;\n      border-bottom: 1px solid rgba(255,255,255,.08) !important;\n    }\n    .drawer{\n      background: rgba(20,24,34,.96) !important;\n      box-shadow: 14px 0 28px rgba(0,0,0,.45) !important;\n      width: 86vw !important;\n      overflow-y: auto !important;\n    }\n    .drawer .row{ gap:10px !important; }\n    .drawer button{\n      background: rgba(255,255,255,.10) !important;\n      border: 1px solid rgba(255,255,255,.22) !important;\n      color: #fff !important;\n      padding: 12px 14px !important;\n      font-weight: 700 !important;\n      border-radius: 12px !important;\n      -webkit-tap-highlight-color: transparent;\n    }\n    .drawer button:hover{\n      background: rgba(255,255,255,.14) !important;\n      border-color: rgba(255,255,255,.30) !important;\n    }\n    .drawer button.ghost{\n      background: rgba(255,255,255,.10) !important;\n      box-shadow: none !important;\n    }\n  }",document.head.appendChild(e)}}()}catch(r){}try{!function(){if(!document.getElementById("bp-mobile-light-fix")){var e=document.createElement("style");e.id="bp-mobile-light-fix",e.textContent="\n    @media (max-width:980px) and (prefers-color-scheme: light){\n      .topbar{\n        background:#fff !important;\n        border-bottom:1px solid rgba(0,0,0,.08) !important;\n        box-shadow:none !important;\n      }\n      .topbar .brand .logo{\n        color:#0f172a !important;\n        font-weight:900 !important;\n        letter-spacing:.4px;\n        text-shadow:none !important;\n        opacity:1 !important;\n      }\n      .topbar .hamb span{ background:#0f172a !important; }\n      .card{\n        background:#fff !important;\n        background-image:none !important;\n        box-shadow:none !important;\n      }\n      .drawer{\n        background:#fff !important;\n        box-shadow:14px 0 28px rgba(0,0,0,.10) !important;\n      }\n      .drawer button{\n        color:#0f172a !important;\n        background:rgba(0,0,0,.04) !important;\n        border:1px solid rgba(0,0,0,.12) !important;\n      }\n      .drawer button:hover{\n        background:rgba(0,0,0,.08) !important;\n      }\n    }\n  ",document.head.appendChild(e)}}()}catch(l){}try{!function(){if(!document.getElementById("bp-badge-light-css")){var e=document.createElement("style");e.id="bp-badge-light-css",e.textContent="\n    @media (prefers-color-scheme: light){\n      .badge{\n        background: linear-gradient(180deg, #eef2ff, #f8fafc) !important;\n        border: 1px solid #c7d2fe !important;\n        color: #0f172a !important;\n        font-weight: 700 !important;\n        padding: 6px 10px !important;\n        border-radius: 9999px !important;\n        letter-spacing: .2px !important;\n        box-shadow: 0 1px 0 rgba(15,23,42,.05) inset !important;\n      }\n      .chip, .tag{\n        background: #ffffff !important;\n        border: 1px solid #cbd5e1 !important;\n        color: #0f172a !important;\n        font-weight: 600 !important;\n        border-radius: 9999px !important;\n      }\n      .card .badge{\n        background: #fff !important;\n      }\n    }\n  ",document.head.appendChild(e)}}()}catch(d){}var i=document.getElementById("hamb");i&&(i.onclick=function(){G()});var o=document.getElementById("drawer");o&&o.addEventListener("click",function(e){"drawer"===e.target.id&&G(!1)}),document.removeEventListener("keydown",R,!1),document.addEventListener("keydown",R,!1)}}function R(e){if(e&&"Escape"===e.key){var t=document.getElementById("drawer");t&&t.classList.contains("open")&&G(!1)}}function G(e){var t=document.getElementById("drawer");if(t){var n="boolean"==typeof e?e:!t.classList.contains("open");t.classList.toggle("open",n);var a=document.getElementById("hamb");a&&a.setAttribute("aria-expanded",String(n)),document.body.classList.toggle("no-scroll",n)}}e.textContent='#bp-overlay{position:fixed;top:0;right:0;bottom:0;left:0;display:none;align-items:center;justify-content:center;z-index:10000}#bp-overlay:not(.hidden){display:flex}#bp-overlay .bp-overlay-backdrop{position:absolute;top:0;right:0;bottom:0;left:0;background:rgba(0,0,0,.35)}#bp-overlay .bp-overlay-panel{position:relative;max-width:min(92vw,560px);width:auto;background:#fff;color:#111;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.3);padding:16px;margin:12px}#bp-overlay .row{display:flex;gap:12px}#bp-overlay input[type=date],#bp-overlay input[type=number],#bp-overlay input[type=text],#bp-overlay textarea,#bp-overlay select{width:100%}.chip-nncf{display:inline-flex;align-items:center;gap:.35rem;padding:.2rem .5rem;border-radius:999px;border:1px solid var(--acc,#888);cursor:pointer;user-select:none;margin-left:.5rem;font-size:.9em}.chip-nncf input{accent-color:var(--acc,#444);width:1rem;height:1rem}.today{outline:2px solid var(--acc,#0aa);outline-offset:-2px;border-radius:.5rem;position:relative}.today:after{content:"Oggi";position:absolute;top:2px;right:4px;font-size:.7em;color:var(--acc,#0aa)}.btn-ghost{background:transparent;border:1px solid #999;border-radius:.5rem;padding:.35rem .6rem;cursor:pointer}.btn-ghost:hover{background:rgba(0,0,0,.04)}.kpi-mini canvas{max-height:180px}\n/*$vite$:1*/',document.head.appendChild(e);var Y=null;function q(){clearTimeout(Y),Y=setTimeout(H,60)}function z(e){return document.querySelector(e)}function W(e){return Array.from(document.querySelectorAll(e))}!function(){var e,r=document.getElementById("app");function l(){document.title="Battle Plan – Login";r.innerHTML='<div class="hero" id="hero"><div class="layer glow"></div><div class="layer grid"></div><div class="title">Pianifica. Eroga. Vinci. <span class="small muted">BP – stile gaming</span></div></div><div class="wrap"><div class="grid"><div class="card"><h3>Accedi</h3><form id="loginForm" autocomplete="on"><div class="row"><div><label>Email</label><input id="li_email" name="email" type="email" autocomplete="username" required></div><div><label>Password</label><input id="li_password" name="password" type="password" autocomplete="current-password" required></div></div><div class="row"><label class="small"><input type="checkbox" id="li_remember" checked> Rimani collegato</label></div><div class="right" style="margin-top:8px"><button type="submit" id="btnLogin">Accedi</button></div></form></div><div class="card"><h3>Registrati</h3><form id="regForm" autocomplete="on"><div class="row"><div><label>Nome</label><input id="re_name" name="name" type="text" required></div><div><label>Email</label><input id="re_email" name="email" type="email" autocomplete="username" required></div><div><label>Password</label><input id="re_password" name="new-password" type="password" autocomplete="new-password" required></div></div><div class="right" style="margin-top:8px"><button type="submit" id="btnRegister">Registrati</button></div></form></div></div></div>';var e=document.getElementById("hero");e&&e.addEventListener("pointermove",function(t){var n=e.getBoundingClientRect();e.style.setProperty("--gx",(t.clientX-n.left)/n.width*100+"%"),e.style.setProperty("--gy",(t.clientY-n.top)/n.height*100+"%")});var t=document.getElementById("loginForm"),a=document.getElementById("regForm");t.addEventListener("submit",function(e){e.preventDefault();var t=document.getElementById("btnLogin");t.disabled=!0;var a=document.getElementById("li_email").value.trim().toLowerCase(),i=document.getElementById("li_password").value,o=document.getElementById("li_remember").checked;h("/api/login",{email:a,password:i}).then(function(e){if("string"==typeof e)try{e=JSON.parse(e)}catch(t){}!function(e,t){t?n("bp_token",e):sessionStorage.setItem("bp_token",e)}(e.token,o),n("bp_user",e.user),L("Bentornato "+e.user.name+"!"),addXP(10),Y(),H(),window.BPPush&&window.BPPush.subscribe()}).catch(function(e){L("Credenziali errate"),logger.error(e)}).finally(function(){t.disabled=!1})}),a.addEventListener("submit",function(e){e.preventDefault();var t=document.getElementById("btnRegister");t.disabled=!0,h("/api/register",{name:document.getElementById("re_name").value.trim(),email:document.getElementById("re_email").value.trim().toLowerCase(),password:document.getElementById("re_password").value}).then(function(){L("Registrazione ok. Ora accedi"),F(),addXP(20),window.scrollTo({top:0,behavior:"smooth"})}).catch(function(e){L("Email già registrata?"),logger.error(e)}).finally(function(){t.disabled=!1})})}function p(e){var t=(new Date).getFullYear(),n=(new Date).getMonth()+1;return'<div class="row"><div><label>Granularità</label><select id="'+e+'_gran"><option value="settimanale">Settimanale</option><option value="mensile" selected>Mensile</option><option value="trimestrale">Trimestrale</option><option value="semestrale">Semestrale</option><option value="annuale">Annuale</option><option value="ytd">Anno corrente (YTD)</option><option value="ltm">Ultimi 12 mesi (LTM)</option></select></div><div id="'+e+'_wrap_week" style="display:none"><label>Settimana ISO</label><div class="row"><input type="number" id="'+e+'_week" min="1" max="53" value="'+D(new Date)+'"><input type="number" id="'+e+'_year_w" min="2000" max="2100" value="'+t+'"></div></div><div id="'+e+'_wrap_month"><label>Mese</label><div class="row"><input type="number" id="'+e+'_month" min="1" max="12" value="'+n+'"><input type="number" id="'+e+'_year_m" min="2000" max="2100" value="'+t+'"></div></div><div id="'+e+'_wrap_quarter" style="display:none"><label>Trimestre</label><div class="row"><input type="number" id="'+e+'_quarter" min="1" max="4" value="'+Math.floor((n-1)/3)+'1"><input type="number" id="'+e+'_year_q" min="2000" max="2100" value="'+t+'"></div></div><div id="'+e+'_wrap_sem" style="display:none"><label>Semestre</label><div class="row"><select id="'+e+'_sem"><option value="1">1°</option><option value="2">2°</option></select><input type="number" id="'+e+'_year_s" min="2000" max="2100" value="'+t+'"></div></div><div id="'+e+'_wrap_year" style="display:none"><label>Anno</label><input type="number" id="'+e+'_year" min="2000" max="2100" value="'+t+'"></div><div style="align-self:flex-end"><button id="'+e+'_refresh" class="ghost">Aggiorna</button></div></div>'}function m(e){return"d"===e||"dash"===e?"dash":"cm"===e||"comm"===e?"comm":"tg"===e||"t"===e||"team"===e?"t":e}function g(e,t){function n(){var t=document.getElementById(e+"_gran").value;["week","month","quarter","sem","year"].forEach(function(t){var n=document.getElementById(e+"_wrap_"+t);n&&(n.style.display="none")}),"settimanale"===t?document.getElementById(e+"_wrap_week").style.display="":"mensile"===t?document.getElementById(e+"_wrap_month").style.display="":"trimestrale"===t?document.getElementById(e+"_wrap_quarter").style.display="":"semestrale"===t?document.getElementById(e+"_wrap_sem").style.display="":"annuale"===t&&(document.getElementById(e+"_wrap_year").style.display="")}["gran","week","year_w","month","year_m","quarter","year_q","sem","year_s","year"].forEach(function(a){var i=document.getElementById(e+"_"+a);i&&(i.onchange=function(){n(),t&&t(),window.emitUnifiedRangeChange(m(e))},i.oninput=function(){n()})});var a=document.getElementById(e+"_refresh");a&&(a.onclick=function(){t&&t(),window.emitUnifiedRangeChange(m(e))}),n()}function f(e){var t=new Date;function n(t,n){var a=document.getElementById(e+"_"+t),i=a?parseInt(a.value,10):NaN;return isFinite(i)?i:n}var a=document.getElementById(e+"_gran"),i=a?a.value:"mensile",o={type:i,start:null,end:null};if("settimanale"===i){var r=M(n("year_w",t.getFullYear()),Math.max(1,Math.min(53,n("week",D(t)))));return o.start=r.start,o.end=r.end,o}if("mensile"===i){var l=n("year_m",t.getFullYear()),d=Math.max(1,Math.min(12,n("month",t.getMonth()+1)));return o.start=new Date(l,d-1,1),o.end=new Date(l,d,0,23,59,59,999),o}if("trimestrale"===i){var s=n("year_q",t.getFullYear()),c=Math.max(1,Math.min(4,n("quarter",Math.floor(t.getMonth()/3)+1)));return o.start=new Date(s,3*(c-1),1),o.end=new Date(s,3*c,0,23,59,59,999),o}if("semestrale"===i){var u=n("year_s",t.getFullYear()),v=n("sem",t.getMonth()<6?1:2);return o.start=new Date(u,1===v?0:6,1),o.end=new Date(u,1===v?6:12,0,23,59,59,999),o}if("annuale"===i){var p=n("year",t.getFullYear());return o.start=new Date(p,0,1),o.end=new Date(p,11,31,23,59,59,999),o}if("ytd"===i){var m=new Date(t.getFullYear(),t.getMonth()+1,0,23,59,59,999);return o.start=new Date(t.getFullYear(),0,1),o.end=m,o}if("ltm"===i){var g=new Date(t.getFullYear(),t.getMonth()+1,0,23,59,59,999),f=new Date(g.getFullYear(),g.getMonth()-11,1);return o.start=f,o.end=g,o}return o.type="mensile",o.start=new Date(t.getFullYear(),t.getMonth(),1),o.end=new Date(t.getFullYear(),t.getMonth()+1,0,23,59,59,999),o}function b(e){return"ytd"===e||"ltm"===e?"mensile":e}function R(e,t){var n=b(e||"mensile"),a=t?new Date(t):new Date,i=a.getUTCFullYear(),o=[];function r(e,t){o.push({s:e.getTime(),e:t.getTime()})}function l(e,t,n){return new Date(Date.UTC(e,t,n))}function d(e){return new Date(e.getTime()+864e5-1)}function s(e,t){return new Date(Date.UTC(e,t+1,0))}if("settimanale"===n){var c=new Date(Date.UTC(a.getUTCFullYear(),a.getUTCMonth(),a.getUTCDate())),u=(c.getUTCDay()+6)%7;c.setUTCDate(c.getUTCDate()-u);for(var v=52;v>=0;v--){(h=new Date(c)).setUTCDate(c.getUTCDate()-7*v),(w=new Date(h)).setUTCDate(h.getUTCDate()+6),w.setUTCHours(23,59,59,999),r(h,w)}return o}if("mensile"===n){for(var p=new Date(Date.UTC(a.getUTCFullYear(),a.getUTCMonth(),1)),m=23;m>=0;m--){var g=new Date(Date.UTC(p.getUTCFullYear(),p.getUTCMonth()-m,1));r(g,d(s(g.getUTCFullYear(),g.getUTCMonth())))}return o}if("trimestrale"===n){for(var f=Math.floor(a.getUTCMonth()/3),y=11;y>=0;y--){var h,w,_=f-y,x=i+Math.floor(_/4),S=(_%4+4)%4;r(h=l(x,3*S,1),w=d(new Date(Date.UTC(x,3*S+3,0))))}return o}if("semestrale"===n){for(var I=a.getUTCMonth()<6?0:1,D=5;D>=0;D--){var E=I-D,B=i+Math.floor(E/2),P=0===(E%2+2)%2?0:6;r(l(B,P,1),d(new Date(Date.UTC(B,P+6,0))))}return o}for(var T=2;T>=0;T--){var C=i-T;r(l(C,0,1),d(new Date(Date.UTC(C,12,0))))}return o}function Y(){if(!u())return l();function e(e,t){var n=document.getElementById(e);n&&(n.textContent=t)}function t(e){return(Number(e)||0).toLocaleString("it-IT")+"€"}function i(e){var t=Number(e)||0;return String(Math.round(t))}function o(e){return String(e).replace(/[&<>'"]/g,function(e){return{"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"}[e]})}function d(e,t,n,a){var i=a||f("dash"),o=String(i.type||"mensile").toLowerCase(),r="ytd"===o||"ltm"===o?"mensile":o,l=(R(o,new Date)||[]).map(function(e){return{s:e.s,e:e.e}});function d(e,t){var n=new Date(t.startDate).getTime(),a=new Date(t.endDate).getTime();return n>=e.s&&a<=e.e}function s(e,t){if(!e)return 0;if("VSDTotale"===t)return Number(e.VSDPersonale||0)+Number(e.VSDIndiretto||0);if("ProvvGI"===t)return Number(e.ProvvGI||0);if("ProvvVSD"===t)return Number(e.ProvvVSD||0);if("TotProvvigioni"===t){var n=e.TotProvvigioni;return Number(null!=n?n:Number(e.ProvvGI||0)+Number(e.ProvvVSD||0))}return Number(e[t]||0)}return y("/api/periods?global=1").catch(function(){return y("/api/periods")}).then(function(a){var i=(a&&a.periods||[]).filter(function(e){return e.type===r&&(!n||String(e.userId||e.uid||"")===String(n))}),o=function(e){switch(String(e)){case"provv_gi":return"ProvvGI";case"provv_vsd":return"ProvvVSD";case"tot_provv":return"TotProvvigioni";default:return e}}(e);return l.map(function(e){for(var n=0,a=0;a<i.length;a++){var r=i[a];if(d(e,r))n+=s("previsionale"===t?r.indicatorsPrev||{}:r.indicatorsCons||{},o)}return{x:new Date(e.s),y:Math.round(100*n)/100}})})}function s(){var n=(document.getElementById("dash_mode")||{}).value||"consuntivo",a=f("dash"),o=new Date(a.start).getTime(),r=new Date(a.end).getTime(),l=(document.getElementById("dash_cons")||{}).value||"";function d(e){return e=Number(null==e?"":e),isFinite(e)?e:0}function s(e){if(!e)return 0;for(var t=["VSDIndiretto","vsdIndiretto","VSD_indiretto","VSDI"],n=0;n<t.length;n++)if(null!=e[t[n]])return d(e[t[n]]);return null!=e.VSDTotale&&null!=e.VSDPersonale?d(e.VSDTotale)-d(e.VSDPersonale):0}function c(e){return e?null!=e.TotProvvigioni?d(e.TotProvvigioni):d(e.ProvvGI)+d(e.ProvvVSD):0}return y("/api/periods").then(function(a){for(var u=a&&a.periods||[],v={VSS:0,VSDPersonale:0,VSDIndiretto:0,GI:0,NNCF:0,PROVV:0},p=0;p<u.length;p++){var m=u[p];if(!l||String(m.userId||m.uid||"")===String(l)){var g=new Date(m.startDate).getTime(),f=new Date(m.endDate).getTime();if(!(g<o||f>r)){var b="previsionale"===n?m.indicatorsPrev||{}:m.indicatorsCons||{};v.VSS+=d(b.VSS),v.VSDPersonale+=d(b.VSDPersonale),v.VSDIndiretto+=s(b),v.GI+=d(b.GI),v.NNCF+=d(b.NNCF),v.PROVV+=c(b)}}}e("kpi_vss",t(v.VSS)),e("kpi_vsd",t(v.VSDPersonale)),e("kpi_vsd_ind",t(v.VSDIndiretto)),e("kpi_gi",t(v.GI)),e("kpi_nncf",i(v.NNCF)),e("kpi_provv",t(v.PROVV))})}function c(){var e=(document.getElementById("dash_mode")||{}).value||"consuntivo",t=(document.getElementById("dash_cons")||{}).value||"",n=f("dash"),i=String(n.type||"mensile").toLowerCase();function o(e,t){var n=e.map(function(e){return function(e,t){return"settimanale"===t?window.isoWeekNum?window.isoWeekNum(e):Math.ceil(e.getDate()/7):"mensile"===t||"ytd"===t||"ltm"===t?e.getMonth()+1:"trimestrale"===t?Math.floor(e.getMonth()/3)+1:"semestrale"===t?e.getMonth()<6?1:2:e.getFullYear()}(e.x,i)});!function(e,t,n){var i=document.getElementById(e);if(i)if("function"!=typeof window.drawFullLine){var o=i.getContext("2d");i.width=i.clientWidth||320,i.height=i.clientHeight||80,o.clearRect(0,0,i.width,i.height);var r=Math.max.apply(Math,[1].concat(a(n))),l=n.length>1?(i.width-8)/(n.length-1):0;o.strokeStyle="#2e6cff",o.lineWidth=2,o.beginPath();for(var d=0;d<n.length;d++){var s=4+d*l,c=i.height-6-n[d]/r*(i.height-12);0===d?o.moveTo(s,c):o.lineTo(s,c)}o.stroke()}else window.drawFullLine(e,t,n)}(t,n,e.map(function(e){return e.y}))}Promise.all([d("VSS",e,t||null,n),d("VSDPersonale",e,t||null,n),d("VSDIndiretto",e,t||null,n),d("GI",e,t||null,n),d("NNCF",e,t||null,n),d("TotProvvigioni",e,t||null,n)]).then(function(e){o(e[0],"d_mini_vss"),o(e[1],"d_mini_vsdpersonale"),o(e[2],"d_mini_vsdindiretto"),o(e[3],"d_mini_gi"),o(e[4],"d_mini_nncf"),o(e[5],"d_mini_provv")}).catch(function(e){logger.error(e)})}function v(){var e=(document.getElementById("dash_cons")||{}).value||"";function a(e){return'<div style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px">'+e+"</div>"}function r(e){var n,a=new Date(e.start),i=new Date(e.end);(!(i instanceof Date)||isNaN(i)||i<a)&&(i=new Date(a.getTime()+6e4*(n=e.type||"vendita",(n=String(n||"").toLowerCase()).indexOf("mezza")>-1?240:n.indexOf("giorn")>-1?570:(n.indexOf("vend"),90))));var r=_(a)+" "+function(e){var t=new Date(e);return w(t.getHours())+":"+w(t.getMinutes())}(a)+"–"+("0"+i.getHours()).slice(-2)+":"+("0"+i.getMinutes()).slice(-2),l=e.nncf?" · NNCF ✅":"";return'<div class="card lastApp" data-aid="'+o(String(e.id||""))+'" style="cursor:pointer"><div class="small muted">'+o(r)+" · "+o(e.type||"manuale")+'</div><div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><div><b>'+o(e.client||"")+'</b></div><div class="row" style="gap:6px"><button class="ghost" title="Esporta .ics" data-ics="'+o(String(e.id||""))+'">.ics</button></div></div><div class="small">VSS '+t(e.vss||0)+" · VSD "+t(e.vsdPersonal||0)+l+"</div></div>"}function l(e){return e=Number(e||0),isFinite(e)?e:0}!function(){var e=document.getElementById("lastApps");if(e){var t=e.parentElement;if(!document.getElementById("nextApps")){var n=document.createElement("div");n.className="card",n.innerHTML='<b>Prossimi appuntamenti (oggi + domani)</b><div id="nextApps" style="margin-top:8px"></div>',t.parentElement.insertBefore(n,t)}}}(),Promise.all([y("/api/appointments"),y("/api/periods")]).then(function(d){var s=d[0]&&d[0].appointments||[],c=d[1]&&d[1].periods||[];!function(){var t=document.getElementById("nextApps");if(t){var i=new Date,o=new Date(i.getFullYear(),i.getMonth(),i.getDate(),0,0,0,0),l=new Date(i.getFullYear(),i.getMonth(),i.getDate()+2,0,0,0,0),d=s.filter(function(t){var n=new Date(t.start).getTime(),a=n>=o.getTime()&&n<l.getTime(),i=!e||String(t.userId||t.uid||"")===String(e);return a&&i}).sort(function(e,t){return new Date(e.start)-new Date(t.start)});t.innerHTML=d.length?a(d.map(r).join("")):'<div class="muted">Nessun appuntamento tra oggi e domani</div>',t.querySelectorAll(".lastApp[data-aid]").forEach(function(e){e.addEventListener("click",function(){try{n("bp_edit_aid",e.getAttribute("data-aid"))}catch(t){}J()})}),t.querySelectorAll("button[data-ics]").forEach(function(e){e.addEventListener("click",function(t){t.stopPropagation();var n=e.getAttribute("data-ics"),a=d.find(function(e){return String(e.id)===String(n)})||s.find(function(e){return String(e.id)===String(n)});a?"function"==typeof icsFromAppt&&"function"==typeof downloadICS?(downloadICS("bp_".concat((a.client||"app").replace(/\s+/g,"_"),"_").concat((a.start||"").slice(0,10)),icsFromAppt(a)),"function"==typeof haptic&&haptic("medium"),L(".ics esportato")):L("Export .ics non disponibile"):L("Appuntamento non trovato")})})}}(),function(){var t=document.getElementById("lastApps");if(t){var i=s.filter(function(t){return!e||String(t.userId||t.uid||"")===String(e)}).sort(function(e,t){return new Date(t.start)-new Date(e.start)}).slice(0,6);t.innerHTML=i.length?a(i.map(r).join("")):'<div class="muted">Nessun appuntamento</div>',t.querySelectorAll(".lastApp[data-aid]").forEach(function(e){e.addEventListener("click",function(){try{n("bp_edit_aid",e.getAttribute("data-aid"))}catch(t){}J()})}),t.querySelectorAll("button[data-ics]").forEach(function(e){e.addEventListener("click",function(t){t.stopPropagation();var n=e.getAttribute("data-ics"),a=i.find(function(e){return String(e.id)===String(n)})||s.find(function(e){return String(e.id)===String(n)});a?"function"==typeof icsFromAppt&&"function"==typeof downloadICS?(downloadICS("bp_".concat((a.client||"app").replace(/\s+/g,"_"),"_").concat((a.start||"").slice(0,10)),icsFromAppt(a)),"function"==typeof haptic&&haptic("medium"),L(".ics esportato")):L("Export .ics non disponibile"):L("Appuntamento non trovato")})})}}(),function(){var a=document.getElementById("lastBPs");if(a){var r=c.filter(function(t){return!e||String(t.userId||t.uid||"")===String(e)}).sort(function(e,t){return new Date(t.endDate)-new Date(e.endDate)}).slice(0,3).map(function(e){var n=A(e.type,e.startDate),a=e.userName||e.userId||"",r=e.indicatorsPrev||{},d=e.indicatorsCons||{},s=function(e){return e&&Object.keys(e).length>0}(d),c=s?d:r,u=l(c.VSS),v=l(c.VSDPersonale),p=l(c.VSDIndiretto),m=l(c.GI),g=l(c.NNCF),f=v+p;return'<div class="card lastBP" data-pid="'+o(String(e.id||""))+'" style="cursor:pointer;flex:1 1 320px"><div style="display:flex;align-items:center;gap:8px"><div><b>'+o(n)+'</b></div><span class="chip small">'+(s?"Consuntivo":"Previsionale")+'</span></div><div class="small muted">'+o(a)+'</div><div class="row" style="margin-top:6px;gap:8px;flex-wrap:wrap"><span class="chip small">VSS <b>'+t(u)+'</b></span><span class="chip small">VSD <b>'+t(f)+'</b> <span class="muted">(P '+t(v)+" · I "+t(p)+')</span></span><span class="chip small">GI <b>'+t(m)+'</b></span><span class="chip small">NNCF <b>'+i(g)+"</b></span></div></div>"}).join("");a.innerHTML=r?'<div style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px">'+r+"</div>":'<div class="muted">Nessun BP</div>',a.querySelectorAll(".lastBP[data-pid]").forEach(function(e){e.addEventListener("click",function(){try{n("bp_open_period",{id:e.getAttribute("data-pid"),mode:!1})}catch(t){}X()})})}}()}).catch(function(e){logger.error(e)})}document.title="Battle Plan – Dashboard",r.innerHTML=j()+'<div class="wrap"><div class="card"><b>Filtro</b><div class="row" style="margin-top:6px;align-items:flex-end;gap:16px;flex-wrap:wrap"><div><label>Modalità</label><select id="dash_mode" name="mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div><div><label>Consulente</label><select id="dash_cons"><option value="">Tutti</option></select></div></div>'+p("dash")+'</div><div class="grid" id="kpiGrid"><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>VSS</b><span id="kpi_vss" class="big">—</span></div><canvas id="d_mini_vss" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>VSD personale</b><span id="kpi_vsd" class="big">—</span></div><canvas id="d_mini_vsdpersonale" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>VSD indiretto</b><span id="kpi_vsd_ind" class="big">—</span></div><canvas id="d_mini_vsdindiretto" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>GI</b><span id="kpi_gi" class="big">—</span></div><canvas id="d_mini_gi" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>NNCF</b><span id="kpi_nncf" class="big">—</span></div><canvas id="d_mini_nncf" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>Tot Provvigioni</b><span id="kpi_provv" class="big">—</span></div><canvas id="d_mini_provv" width="320" height="90"></canvas></div></div><div class="card"><b>Ultimi appuntamenti</b><div id="lastApps" class="row" style="margin-top:8px"></div></div><div class="card"><b>Ultimi BP inviati</b><div id="lastBPs" class="row" style="margin-top:8px"></div></div></div>',H(),y("/api/usernames").then(function(e){var t=e&&e.users||[],n=document.getElementById("dash_cons");n&&(n.innerHTML='<option value="">Tutti</option>'+t.map(function(e){return'<option value="'+o(String(e.id))+'">'+o(e.name||e.email||"User #"+e.id)+"</option>"}).join(""))}).catch(function(){}),g("dash",function(){"function"==typeof haptic&&haptic("light"),s(),c(),v()});var m=document.getElementById("dash_mode");m&&(m.onchange=function(){"function"==typeof haptic&&haptic("light"),s(),c(),v()});var b=document.getElementById("dash_cons");b&&(b.onchange=function(){"function"==typeof haptic&&haptic("light"),s(),c(),v()}),s(),c(),v(),"function"==typeof kickFinal&&kickFinal("dashboard")}function X(){if(!u())return l();document.title="Battle Plan – BP",r.innerHTML=j()+'<div class="wrap"><div class="card"><b>Da inviare</b><div id="bp_to_send" class="grid" style="margin-top:8px"></div></div><div class="card" id="bp_sent_box" style="margin-top:8px"><div id="bp_sent_head" style="display:flex;align-items:center;justify-content:space-between;cursor:pointer"><b>BP inviati (periodi in essere)</b><span id="bp_sent_chev" class="chev">▸</span></div><div id="bp_sent" class="row" style="margin-top:8px;display:none"></div></div><div class="card" style="margin-top:8px"><b>Crea/Aggiorna BP</b><div class="row" style="margin-top:8px"><div><label>Tipo</label><select id="p_type"><option value="settimanale">Settimanale (lun–dom)</option><option value="mensile">Mensile</option><option value="trimestrale">Trimestrale</option><option value="semestrale">Semestrale</option><option value="annuale">Annuale</option></select></div><div id="wrap_week" style="display:none"><label>Settimana ISO (1–53)</label><input type="number" id="p_week" min="1" max="53" value="'+D(new Date)+'"></div><div id="wrap_month" style="display:none"><label>Mese</label><select id="p_month"><option value="1">Gennaio</option><option value="2">Febbraio</option><option value="3">Marzo</option><option value="4">Aprile</option><option value="5">Maggio</option><option value="6">Giugno</option><option value="7">Luglio</option><option value="8">Agosto</option><option value="9">Settembre</option><option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option></select></div><div id="wrap_quarter" style="display:none"><label>Trimestre</label><select id="p_quarter"><option value="1">T1</option><option value="2">T2</option><option value="3">T3</option><option value="4">T4</option></select></div><div id="wrap_semester" style="display:none"><label>Semestre</label><select id="p_sem"><option value="1">1° semestre</option><option value="2">2° semestre</option></select></div><div><label>Anno</label><input type="number" id="p_year" min="2000" max="2100" value="'+(new Date).getFullYear()+'"></div></div><div class="row"><div class="small muted">Modalità: <b id="p_mode_lbl">Previsionale</b> · <button class="ghost" id="btnImport" style="padding:4px 8px">Importa da agenda</button></div></div><div class="row" style="align-items:center"><div class="small"><b>Periodo selezionato:</b> <span id="p_label" class="neon">—</span></div><input type="hidden" id="p_start"><input type="hidden" id="p_end"></div><div class="row small" style="margin-top:6px;opacity:.9"><div><b>Previsionale</b></div><div><b>Consuntivo</b></div><div><b>Avanzamento</b></div></div><div class="row" id="p_rows" style="margin-top:4px"></div><div class="row" style="margin-top:8px;align-items:center;gap:8px;justify-content:space-between"><div id="p_delete_zone"></div><div class="right"><button id="btnSaveP">Salva BP</button></div></div></div><div class="card"><b>BP salvati</b><div id="p_list" class="row" style="margin-top:8px"></div></div></div>',H();var e=!1,t=null,n=[],a=null,o=u()||{};function d(e){return String(e).replace(/[&<>'"]/g,function(e){return{"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"}[e]})}function c(e){if(!e)return"";var t=new Date(e);return t.getFullYear()+"-"+("0"+(t.getMonth()+1)).slice(-2)+"-"+("0"+t.getDate()).slice(-2)}function v(e){var t=new Date(e);return("0"+t.getDate()).slice(-2)+"/"+("0"+(t.getMonth()+1)).slice(-2)+"/"+t.getFullYear()}function p(e){return(Number(e)||0).toLocaleString("it-IT")+"€"}function m(e){var t=document.createElement("div");return t.innerHTML=e.trim(),t.firstChild}function g(e){return!!(e&&e.indicatorsCons&&Object.keys(e.indicatorsCons).length>0)}function f(){return"senior"===(o&&o.grade||(u()||{}).grade)?"senior":"junior"}o&&o.grade?Promise.resolve(o):y("/api/usernames").then(function(e){var t=String((u()||{}).id||""),n=(e&&e.users||[]).find(function(e){return String(e.id)===t});return n&&n.grade&&(o.grade=n.grade),o}).catch(function(){return o});var b=document.getElementById("p_type"),w=document.getElementById("p_year"),_=document.getElementById("wrap_week"),x=document.getElementById("wrap_month"),V=document.getElementById("wrap_quarter"),O=document.getElementById("wrap_semester"),U=document.getElementById("p_week"),R=document.getElementById("p_month"),G=document.getElementById("p_quarter"),Y=document.getElementById("p_sem"),q=document.getElementById("p_label"),z=document.getElementById("p_start"),W=document.getElementById("p_end"),X=document.getElementById("p_mode_lbl"),J=document.getElementById("btnImport");function $(t){e=!!t,X.textContent=e?"Consuntivo":"Previsionale",J.style.display=e?"none":"",document.querySelectorAll("[data-row]").forEach(function(t){var n=t.querySelector("[data-prev]"),a=t.querySelector("[data-cons]"),i=t.querySelector("[data-bar]");if(e){if(n){n.removeAttribute("hidden");var o=n.querySelector("input");o&&(o.setAttribute("readonly","readonly"),o.classList.add("disabled"))}if(a){a.removeAttribute("hidden");var r=a.querySelector("input");r&&(r.removeAttribute("readonly"),r.classList.remove("disabled"))}i&&i.removeAttribute("hidden")}else{if(n){n.removeAttribute("hidden");var l=n.querySelector("input");l&&(l.removeAttribute("readonly"),l.classList.remove("disabled"))}a&&a.setAttribute("hidden","hidden"),i&&i.setAttribute("hidden","hidden")}}),re()}function Q(){var e=b.value;_.style.display="settimanale"===e?"":"none",x.style.display="mensile"===e?"":"none",V.style.display="trimestrale"===e?"":"none",O.style.display="semestrale"===e?"":"none",Z()}function Z(){var e,n,i,o=b.value,r=parseInt(w.value,10);if("settimanale"===o){var l=Math.max(1,Math.min(53,parseInt(U.value||"1",10))),d=M(r,l);e=d.start,n=d.end,i="Sett. "+l+" · "+v(e)+" → "+v(n)}else if("mensile"===o){var s=parseInt(R.value,10);e=new Date(r,s-1,1),n=new Date(r,s,0),i=e.toLocaleString("it-IT",{month:"long",year:"numeric"})+" · "+v(e)+" → "+v(n)}else if("trimestrale"===o){var u=parseInt(G.value,10);e=new Date(r,3*(u-1),1),n=new Date(r,3*u,0),i="Trimestre "+u+" "+r+" · "+v(e)+" → "+v(n)}else if("semestrale"===o){var p=parseInt(Y.value,10);e=new Date(r,1===p?0:6,1),n=new Date(r,1===p?6:12,0),i=(1===p?"1°":"2°")+" semestre "+r+" · "+v(e)+" → "+v(n)}else e=new Date(r,0,1),n=new Date(r,11,31),i="Anno "+r+" · "+v(e)+" → "+v(n);z.value=c(e),W.value=c(n),q.textContent=i,$(!1),t=null,a=null,ne(),re()}function K(e){for(var t="",a=0;a<e.length;a++){var i=e[a],o=/^(VSS|VSDPersonale|VSDIndiretto|GI)$/i.test(i);t+='<div class="row" data-row="'+i+'"><div data-prev><label>'+i+' (Prev)</label><input type="number" step="1" id="prev_'+i+'" placeholder="'+(o?"€":"n")+'"></div><div data-cons><label>'+i+' (Cons)</label><input type="number" step="1" id="cons_'+i+'" placeholder="'+(o?"€":"n")+'"></div><div data-bar class="small"><div style="height:10px;background:rgba(255,255,255,.12);border-radius:999px;overflow:hidden"><div id="bar_'+i+'" style="height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2));"></div></div><div id="pct_'+i+'" class="small muted">0%</div></div></div>'}document.getElementById("p_rows").innerHTML=t,$(!1),function(){for(var e=0;e<n.length;e++)(function(e){var t=document.getElementById("prev_"+e),n=document.getElementById("cons_"+e);t&&(t.oninput=ee),n&&(n.oninput=ee)})(n[e])}(),ee()}function ee(){for(var e=0;e<n.length;e++){var t=n[e],a=document.getElementById("prev_"+t),i=document.getElementById("cons_"+t);if(a&&i){var o=Number(a.value||0),r=Number(i.value||0),l=o>0?Math.round(r/o*100):r>0?100:0;l=Math.max(0,Math.min(200,l));var d=document.getElementById("bar_"+t),s=document.getElementById("pct_"+t);d&&(d.style.width=Math.min(l,100)+"%"),s&&(s.textContent=l+"%")}}}function te(){for(var e=0;e<n.length;e++){var t=document.getElementById("prev_"+n[e]);t&&(t.value="")}ee()}function ne(){for(var e=0;e<n.length;e++){var t=document.getElementById("cons_"+n[e]);t&&(t.value="")}ee()}function ae(e){for(var t in e){var n=document.getElementById("prev_"+t);n&&(n.value=String(e[t]||0))}ee()}function ie(e,t){e=Object.assign({},e||{});var n=.15*Number(e.GI||0),a=Number(e.VSDPersonale||0)*("senior"===String(t)?.25:.2);return e.ProvvGI=Math.round(100*n)/100,e.ProvvVSD=Math.round(100*a)/100,e.TotProvvigioni=Math.round(100*(e.ProvvGI+e.ProvvVSD))/100,e}function oe(e,t,n){return fetch(t,{method:e,headers:n?{"Content-Type":"application/json"}:void 0,body:n?JSON.stringify(n):void 0}).then(function(e){return e.ok?e.json().catch(function(){return{}}):Promise.reject(new Error("HTTP "+e.status))})}function re(){var n=document.getElementById("p_delete_zone");if(n)if(t){var i="";!!(e&&a&&g(a))&&(i+='<button id="btnDelCons" class="ghost" style="border-color:#7d1731;color:#7d1731">Elimina Consuntivo</button> '),i+='<button id="btnDelBP" class="ghost" style="border-color:#7d1731;color:#7d1731">Elimina BP</button>',n.innerHTML=i;var o=document.getElementById("btnDelBP");o&&(o.onclick=function(){confirm("Eliminare definitivamente questo BP?")&&(o.disabled=!0,function(e){for(var t=encodeURIComponent(e),n=[function(){return oe("POST","/api/periods/delete",{id:e})},function(){return oe("POST","/api/periods",{id:e,_delete:!0})},function(){return oe("POST","/api/periods/"+t,{_method:"DELETE"})},function(){return oe("DELETE","/api/periods/"+t,null)},function(){return oe("DELETE","/api/periods?id="+t,null)}],a=Promise.reject(new Error("start")),i=0;i<n.length;i++)(function(e){a=a.catch(e)})(n[i]);return a.catch(function(e){throw logger.warn("Delete fallback: tutte le route fallite",e),e})}(t).then(function(){L("BP eliminato"),t=null,a=null,te(),ne(),$(!1),Z(),le()}).catch(function(){L("Endpoint delete non disponibile")}).finally(function(){o.disabled=!1}))});var r=document.getElementById("btnDelCons");r&&(r.onclick=function(){if(confirm("Rimuovere solo il Consuntivo?")){r.disabled=!0;var e,n=(e={},a?{id:t||a.id,type:a.type,startDate:c(a.startDate),endDate:c(a.endDate),indicatorsPrev:Object.assign({},a.indicatorsPrev||{}),indicatorsCons:null!=e?e:Object.assign({},a.indicatorsCons||{})}:null);if(n){var i=f();n.indicatorsPrev=ie(n.indicatorsPrev,i),n.indicatorsCons={},h("/api/periods",n).then(function(){L("Consuntivo eliminato"),a&&(a.indicatorsCons={}),$(!0),le(),re()}).catch(function(){L("Errore eliminazione Consuntivo")}).finally(function(){r.disabled=!1})}else r.disabled=!1}})}else n.innerHTML=""}function le(){y("/api/periods").then(function(e){var t=e.periods||[];t.sort(function(e,t){return new Date(t.startDate)-new Date(e.startDate)});for(var n="",a=0;a<t.length;a++){var o=t[a];n+='<div class="card" style="flex:1 1 360px"><div><b>'+d(A(o.type,o.startDate)+" · "+v(o.startDate)+" → "+v(o.endDate))+'</b></div><div class="small">Prev VSS '+p((o.indicatorsPrev||{}).VSS||0)+" · Cons "+p((o.indicatorsCons||{}).VSS||0)+'</div><div class="right" style="margin-top:6px"><button class="ghost" data-edit="'+o.id+'">Modifica previs.</button><button data-cons="'+o.id+'">Consuntivo…</button></div></div>'}document.getElementById("p_list").innerHTML=n||'<div class="muted">Nessun BP</div>',document.querySelectorAll("[data-edit]").forEach(function(t){t.addEventListener("click",function(){var n=t.getAttribute("data-edit"),a=(e.periods||[]).find(function(e){return e.id===n});a&&de(a,!1)})}),document.querySelectorAll("[data-cons]").forEach(function(t){t.addEventListener("click",function(){var n=t.getAttribute("data-cons"),a=(e.periods||[]).find(function(e){return e.id===n});a&&de(a,!0)})}),function(e){var t=document.getElementById("bp_to_send"),n=document.getElementById("bp_sent");function a(t,n,a){return e.find(function(e){return e.type===t&&c(e.startDate)===c(n)&&c(e.endDate)===c(a)})}t.innerHTML="",n.innerHTML="";var i=new Date,o=i.getDay(),r=5===o||6===o||0===o,l=I(i),s=B(i),u=T(i),p=k(i),f=r&&ue(l),y=r&&ue(s),h=r&&ue(u),_=r&&ue(p);function x(e,n,i){var o=a(e,i.start,i.end),r=a(e,n.start,n.end);o?t.appendChild(ve("Previsionale",e,i.start,i.end,"Modifica",function(){de(o,!1)})):t.appendChild(ve("Previsionale",e,i.start,i.end,"Compila",function(){if(b.value=e,w.value=String(i.start.getFullYear()),"settimanale"===e)U.value=String(D(i.start));else if("mensile"===e)R.value=String(i.start.getMonth()+1);else if("trimestrale"===e){var t=Math.floor(i.start.getMonth()/3)+1;G.value=String(t)}else"semestrale"===e&&(Y.value=i.start.getMonth()<6?"1":"2");Q()})),r&&!g(r)&&t.appendChild(ve("Consuntivo",e,n.start,n.end,"Consuntivo",function(){de(r,!0)}))}if(["settimanale","mensile","trimestrale","semestrale","annuale"].forEach(function(e){var t=se(e,i),o=a(e,t.start,t.end);if(o){var r=m('<div class="card" style="flex:1 1 360px"><div><b>'+d(A(e,t.start))+'</b></div><div class="small muted">'+v(t.start)+" → "+v(t.end)+'</div><div class="right" style="margin-top:6px"><button class="ghost" type="button" data-mid="'+o.id+'">Modifica</button></div></div>');r.querySelector("[data-mid]").addEventListener("click",function(){de(o,!1)}),n.appendChild(r)}}),r){x("settimanale",se("settimanale",i),ce("settimanale",i))}if(f){x("mensile",se("mensile",i),ce("mensile",i))}if(y){x("trimestrale",se("trimestrale",i),ce("trimestrale",i))}if(h){x("semestrale",se("semestrale",i),ce("semestrale",i))}if(_){x("annuale",se("annuale",i),ce("annuale",i))}t.children.length||(t.innerHTML='<div class="muted">Nessun suggerimento attivo in questo momento</div>');var S=document.getElementById("bp_sent_head"),E=document.getElementById("bp_sent_chev");S.onclick=function(){var e=document.getElementById("bp_sent"),t="none"!==e.style.display;e.style.display=t?"none":"",E.textContent=t?"▸":"▾"}}(t);var r=i("bp_open_period",null);if(r){s("bp_open_period");var l=t.find(function(e){return e.id===r.id});l&&de(l,!0===r.mode)}})}function de(e,n){a=e||null,b.value=e.type;var i=new Date(e.startDate),o=i.getFullYear();if(w.value=String(o),"settimanale"===e.type)U.value=String(D(i));else if("mensile"===e.type)R.value=String(i.getMonth()+1);else if("trimestrale"===e.type){var r=Math.floor(i.getMonth()/3)+1;G.value=String(r)}else"semestrale"===e.type&&(Y.value=i.getMonth()<6?"1":"2");Q(),te(),ne(),ae(e.indicatorsPrev||{}),function(e){for(var t in e){var n=document.getElementById("cons_"+t);n&&(n.value=String(e[t]||0))}ee()}(e.indicatorsCons||{}),$(!!n),t=e.id||null,re(),L(n?"Compila il consuntivo":"Modifica previsionale"),window.scrollTo({top:0,behavior:"smooth"})}function se(e,t){var n=(t=t||new Date).getFullYear();if("settimanale"===e){var a=M(n,D(t));return{start:a.start,end:a.end}}return"mensile"===e?{start:S(t),end:I(t)}:"trimestrale"===e?{start:E(t),end:B(t)}:"semestrale"===e?{start:P(t),end:T(t)}:{start:C(t),end:k(t)}}function ce(e,t){return t=t||new Date,"settimanale"===e?N(t):"mensile"===e?(n=t,{start:a=new Date(n.getFullYear(),n.getMonth()+1,1),end:new Date(a.getFullYear(),a.getMonth()+1,0,23,59,59,999)}):"trimestrale"===e?function(e){var t=E(new Date(e.getFullYear(),e.getMonth()+3,1));return{start:t,end:new Date(t.getFullYear(),t.getMonth()+3,0,23,59,59,999)}}(t):"semestrale"===e?function(e){var t=P(new Date(e.getFullYear(),e.getMonth()+6,1));return{start:t,end:new Date(t.getFullYear(),t.getMonth()+6,0,23,59,59,999)}}(t):function(e){var t=C(new Date(e.getFullYear()+1,0,1));return{start:t,end:k(t)}}(t);var n,a}function ue(e){var t=M((new Date).getFullYear(),D(new Date)).start;return Math.floor((new Date(e)-t)/864e5)<=13}function ve(e,t,n,a,i,o){var r=A(t,n),l=m('<div class="card" style="position:relative"><div class="small muted">'+d(e)+"</div><div><b>"+d(r)+'</b></div><div class="small muted">'+v(n)+" → "+v(a)+'</div><div class="right" style="margin-top:6px"><button class="ghost" type="button" data-sug="1">'+d(i)+"</button></div></div>");return l.querySelector("[data-sug]").addEventListener("click",o),l}y("/api/settings").then(function(e){K(n=e&&e.indicators||["VSS","VSDPersonale","VSDIndiretto","GI","Telefonate","AppFissati","AppFatti","CorsiLeadership","iProfile","MBS","NNCF"])}).catch(function(){K(n=["VSS","VSDPersonale","GI","NNCF"])}),b.onchange=Q,w.oninput=Z,U.oninput=Z,R.onchange=Z,G.onchange=Z,Y.onchange=Z,J.onclick=function(){if(!e){var t=z.value,n=W.value;t&&n?y("/api/appointments").then(function(e){for(var a=e.appointments||[],i=new Date(t),o=new Date(n),r={VSS:0,VSDPersonale:0,VSDIndiretto:0,GI:0,Telefonate:0,AppFissati:0,AppFatti:0,CorsiLeadership:0,iProfile:0,MBS:0,NNCF:0},l=0;l<a.length;l++){var d=a[l],s=new Date(d.start);s>=i&&s<=o&&(r.VSS+=Number(d.vss||0),r.VSDPersonale+=Number(d.vsdPersonal||0),d.nncf&&(r.NNCF+=1))}ae(r),L("Previsionale compilato dalla tua agenda"),F(),addXP(10)}).catch(function(){L("Errore import agenda")}):L("Seleziona il periodo")}},document.getElementById("btnSaveP").onclick=function(){var i=b.value,o=z.value,r=W.value;if(o&&r){for(var l={},d={},s=0;s<n.length;s++){var c=n[s];l[c]=Number(document.getElementById("prev_"+c).value||0),e&&(d[c]=Number(document.getElementById("cons_"+c).value||0))}var u=f();l=ie(l,u),e&&(d=ie(d,u));var v={type:i,startDate:o,endDate:r,indicatorsPrev:l};e&&(v.indicatorsCons=d),t&&(v.id=t),h("/api/periods",v).then(function(n){L("BP salvato"),e?addXP(20):addXP(10),F(),le(),!t&&n&&n.id&&(t=n.id),t&&a&&(a.indicatorsPrev=l,e&&(a.indicatorsCons=d)),re()}).catch(function(){L("Errore salvataggio BP")})}else L("Seleziona il periodo")},Q(),le()}function J(){if(!u())return l();if(document.title="Battle Plan – Appuntamenti",!document.getElementById("appts_css")){var e=document.createElement("style");e.id="appts_css",e.textContent="\n      .appt-type .seg, #a_nncf.seg{\n        padding:8px 12px;border:1px solid #bcd7ff;border-radius:12px;\n        background:#eef5ff;color:#1463ff;cursor:pointer;user-select:none;\n        transition:.15s;\n      }\n      .appt-type .seg.active, #a_nncf.seg.active{\n        background:var(--accent);color:#fff;border-color:var(--accent);\n        box-shadow:0 0 0 2px rgba(20,99,255,.08) inset;\n      }\n      #a_list .grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}\n    ",document.head.appendChild(e)}function t(e){return String(e).replace(/[&<>'"]/g,function(e){return{"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"}[e]})}function n(e){return(Number(e)||0).toLocaleString("it-IT")+"€"}function a(e){if(!e)return"";var t=new Date(e);return isNaN(t)?"":t.toISOString()}function o(e){return(e=String(e||"").toLowerCase()).indexOf("mezza")>-1?240:e.indexOf("giorn")>-1?570:90}r.innerHTML=j()+'<div class="wrap"><div class="card"><b id="a_form_title">Nuovo appuntamento</b><div class="row" style="margin-top:8px;align-items:flex-end;gap:12px;flex-wrap:wrap"><div style="min-width:320px"><label>Cliente *</label><div style="display:flex;gap:8px;align-items:center"><input id="a_client" list="clientList" placeholder="Denominazione" style="flex:1"><datalist id="clientList"></datalist><button id="a_nncf" class="seg" data-active="0" aria-pressed="false">NNCF</button></div></div><div><label>Data/ora inizio</label><input id="a_start" type="datetime-local"></div><div><label>Ora fine</label><input id="a_end" type="time"></div><div><label>Durata (min)</label><input id="a_dur" type="number" placeholder="60" min="1"></div></div><div class="row" style="align-items:flex-end;gap:12px;flex-wrap:wrap"><div class="appt-type"><label>Tipo</label><div><button type="button" id="t_vendita" class="seg">Vendita</button><button type="button" id="t_mezza"   class="seg" data-vsd="1000">Mezza giornata</button><button type="button" id="t_full"    class="seg" data-vsd="2000">Giornata intera</button></div><input id="a_type" type="hidden" value="vendita"></div><div><label>VSS</label><input id="a_vss" type="number" step="1" placeholder="0"></div><div><label>VSD personale</label><input id="a_vsd" type="number" step="1" placeholder="0"></div></div><div class="row" style="margin-top:8px;gap:8px;align-items:center"><div><button id="btnSaveA">Salva</button></div><div><button id="btnSaveExportA" class="ghost">Salva ed esporta</button></div><div class="right" style="margin-left:auto"><button id="btnDeleteA" class="danger" style="display:none">Elimina</button></div></div></div><div class="card"><b>Elenco appuntamenti</b><div class="row" style="margin-top:8px;align-items:flex-end;gap:12px;flex-wrap:wrap"><div><label>Vista</label><select id="af_type"><option value="sett">Settimana</option><option value="mese">Mese</option></select></div><div id="af_week_wrap"><label>Settimana ISO</label><input id="af_week" type="number" min="1" max="53" value="'+D(new Date)+'"></div><div id="af_month_wrap" style="display:none"><label>Mese</label><select id="af_month"><option value="1">Gennaio</option><option value="2">Febbraio</option><option value="3">Marzo</option><option value="4">Aprile</option><option value="5">Maggio</option><option value="6">Giugno</option><option value="7">Luglio</option><option value="8">Agosto</option><option value="9">Settembre</option><option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option></select></div><div><label>Anno</label><input id="af_year" type="number" min="2000" max="2100" value="'+(new Date).getFullYear()+'"></div><div class="right" style="margin-left:auto;display:flex;gap:8px"><button id="af_prev" class="ghost">◀</button><button id="af_next" class="ghost">▶</button></div></div><div id="a_list" style="margin-top:8px"></div></div></div>',H();var d=document.getElementById("a_nncf");d.addEventListener("click",function(){var e="1"!==d.getAttribute("data-active");d.setAttribute("data-active",e?"1":"0"),d.setAttribute("aria-pressed",e?"true":"false"),d.classList.toggle("active",e),e&&f(document.getElementById("t_vendita"))});var v=document.getElementById("t_vendita"),p=document.getElementById("t_mezza"),m=document.getElementById("t_full"),g=[v,p,m];function f(e){g.forEach(function(t){return t.classList.toggle("active",t===e)});var t=document.getElementById("a_type");e===v&&(t.value="vendita",b(90)),e===p&&(t.value="mezza",b(240),document.getElementById("a_vsd").value="1000"),e===m&&(t.value="giornata",b(570),document.getElementById("a_vsd").value="2000")}function b(e){document.getElementById("a_dur").value=String(e),w()}function w(){var e=document.getElementById("a_start").value,t=parseInt(document.getElementById("a_dur").value||"0",10);if(!e||!isFinite(t)||t<=0)document.getElementById("a_end").value="";else{var n=new Date(e),a=new Date(n.getTime()+6e4*t);document.getElementById("a_end").value=("0"+a.getHours()).slice(-2)+":"+("0"+a.getMinutes()).slice(-2)}}g.forEach(function(e){return e.addEventListener("click",function(t){t.preventDefault(),f(e)})}),f(v),document.getElementById("a_start").addEventListener("change",w),document.getElementById("a_dur").addEventListener("input",w),document.getElementById("a_end").addEventListener("change",function(){var e=document.getElementById("a_start").value,t=document.getElementById("a_end").value;if(e&&t){var n=new Date(e),a=t.split(":");if(!(a.length<2)){var i=new Date(n);i.setHours(parseInt(a[0],10)||0,parseInt(a[1],10)||0,0,0),i<n&&i.setDate(i.getDate()+1);var o=Math.round((i-n)/6e4);document.getElementById("a_dur").value=String(Math.max(1,o))}}}),y("/api/clients").then(function(e){var n=e&&e.clients||[],a=document.getElementById("clientList");a&&(a.innerHTML=n.map(function(e){return'<option value="'+t(e.name)+'"></option>'}).join(""))});var _=null;function x(){_=null,document.getElementById("a_form_title").textContent="Nuovo appuntamento",document.getElementById("a_client").value="",document.getElementById("a_start").value="",document.getElementById("a_end").value="",document.getElementById("a_dur").value="",document.getElementById("a_vss").value="",document.getElementById("a_vsd").value="",d.setAttribute("data-active","0"),d.setAttribute("aria-pressed","false"),d.classList.remove("active"),f(v),document.getElementById("btnDeleteA").style.display="none"}function S(e){_=e.id,document.getElementById("a_form_title").textContent="Modifica appuntamento",document.getElementById("a_client").value=e.client||"",document.getElementById("a_start").value=function(e){if(!e)return"";var t=new Date(e);return isNaN(t)?"":new Date(t.getTime()-6e4*t.getTimezoneOffset()).toISOString().slice(0,16)}(e.start);var t=new Date(e.start),n=new Date(e.end),a=Math.max(1,Math.round((n-t)/6e4));if(!(n instanceof Date)||isNaN(n)||n<t){var i=o(e.type||"vendita");n=new Date(t.getTime()+6e4*i),a=i}document.getElementById("a_dur").value=String(a),document.getElementById("a_end").value=("0"+n.getHours()).slice(-2)+":"+("0"+n.getMinutes()).slice(-2),document.getElementById("a_vss").value=e.vss||"",document.getElementById("a_vsd").value=e.vsdPersonal||e.vsd||"";var r=!!e.nncf;d.setAttribute("data-active",r?"1":"0"),d.setAttribute("aria-pressed",r?"true":"false"),d.classList.toggle("active",r),f(240===a?p:570===a?m:v),document.getElementById("btnDeleteA").style.display=""}function I(){var e=(document.getElementById("a_client").value||"").trim();if(!e)return L("Cliente obbligatorio"),null;var t=document.getElementById("a_start").value;if(!t)return L("Data/ora obbligatorie"),null;var n=parseInt(document.getElementById("a_dur").value||"60",10);(!isFinite(n)||n<=0)&&(n=60);var i,o=document.getElementById("a_end").value;if(o){var r=new Date(t),l=o.split(":"),s=new Date(r);s.setHours(parseInt(l[0],10)||0,parseInt(l[1],10)||0,0,0),s<r&&s.setDate(s.getDate()+1),i=s.toISOString(),n=Math.max(1,Math.round((s-r)/6e4)),document.getElementById("a_dur").value=String(n)}else{i=new Date(new Date(t).getTime()+6e4*n).toISOString()}return{id:_||void 0,client:e,start:a(t),end:i,type:document.getElementById("a_type").value,vss:Number(document.getElementById("a_vss").value||0),vsdPersonal:Number(document.getElementById("a_vsd").value||0),nncf:"1"===d.getAttribute("data-active")}}function E(e){var t=I();t&&h("/api/appointments",t).then(function(){L("Appuntamento salvato"),"undefined"!=typeof haptics&&haptics.try("success"),document.dispatchEvent(new Event("appt:saved")),e&&window.BP&&BP.ICS&&"function"==typeof BP.ICS.downloadIcsForAppointment&&(BP.ICS.downloadIcsForAppointment(t),"undefined"!=typeof haptics&&haptics.try("medium"),document.dispatchEvent(new Event("ics:exported"))),x(),F()}).catch(function(){return L("Errore salvataggio")})}function B(){if(_&&confirm("Eliminare l'appuntamento?")){var e=I();fetch("/api/appointments?id="+encodeURIComponent(_),{method:"DELETE",headers:{Authorization:"Bearer "+c()}}).then(function(e){if(!e.ok)throw new Error("HTTP "+e.status);return e.json()}).then(function(){L("Eliminato"),"function"==typeof showUndo&&e&&showUndo("Appuntamento eliminato",function(){return h("/api/appointments",e)},5e3),x(),F()}).catch(function(){return L("Errore eliminazione")})}}function P(e){var t=document.getElementById("af_type").value,n=parseInt(document.getElementById("af_year").value,10);if("sett"===t){var a=parseInt(document.getElementById("af_week").value,10),i=new Date(M(n,a).start);i.setDate(i.getDate()+7*e),document.getElementById("af_year").value=i.getFullYear(),document.getElementById("af_week").value=D(i)}else{var o=parseInt(document.getElementById("af_month").value,10),r=new Date(n,o-1,1);r.setMonth(r.getMonth()+e),document.getElementById("af_year").value=r.getFullYear(),document.getElementById("af_month").value=r.getMonth()+1}F()}document.getElementById("btnSaveA").onclick=function(){return E(!1)},document.getElementById("btnSaveExportA").onclick=function(){return E(!0)},document.getElementById("btnDeleteA").onclick=B,document.getElementById("af_prev").onclick=function(){return P(-1)},document.getElementById("af_next").onclick=function(){return P(1)};var T=document.getElementById("af_type"),C=document.getElementById("af_week"),k=document.getElementById("af_month"),N=document.getElementById("af_year");function A(e){var a=new Date(e.start),i=new Date(e.end);(!(i instanceof Date)||isNaN(i)||i<a)&&(i=new Date(a.getTime()+6e4*o(e.type||"vendita")));var r,l=("0"+(r=new Date(a)).getDate()).slice(-2)+"/"+("0"+(r.getMonth()+1)).slice(-2)+"/"+r.getFullYear()+" "+("0"+a.getHours()).slice(-2)+":"+("0"+a.getMinutes()).slice(-2)+"–"+("0"+i.getHours()).slice(-2)+":"+("0"+i.getMinutes()).slice(-2),d="VSS "+n(e.vss||0)+" · VSD "+n(e.vsdPersonal||0)+" · NNCF "+(e.nncf?"✅":"—");return'<div class="card" data-aid="'+t(String(e.id||""))+'" style="flex:1 1 320px"><div class="small muted">'+t(l)+" · "+t(e.type||"vendita")+'</div><div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><div><b>'+t(e.client||"")+'</b></div><div class="row" style="gap:6px"><button class="ghost" title="Esporta" data-ics="'+t(String(e.id||""))+'">Esporta</button><button class="ghost" title="Modifica" data-edit="'+t(String(e.id||""))+'">✏️</button></div></div><div class="small">'+d+"</div></div>"}function F(){y("/api/appointments").then(function(e){var t=e&&e.appointments||[],n=function(){var e=document.getElementById("af_type").value,t=parseInt(document.getElementById("af_year").value,10);if("sett"===e){var n=M(t,Math.max(1,Math.min(53,parseInt(document.getElementById("af_week").value||D(new Date),10))));return{s:new Date(n.start),e:new Date(n.end)}}var a=parseInt(document.getElementById("af_month").value||(new Date).getMonth()+1,10);return{s:new Date(t,a-1,1),e:new Date(t,a,0,23,59,59,999)}}(),a=n.s.getTime(),i=n.e.getTime(),o=t.filter(function(e){var t=new Date(e.start).getTime();return t>=a&&t<=i}).sort(function(e,t){return new Date(e.start)-new Date(t.start)}),r=new Date,l=o.filter(function(e){return new Date(e.start)>=r}),d=o.filter(function(e){return new Date(e.start)<r}),s=document.getElementById("a_list"),c="";c+="<div><b>Prossimi</b></div>",c+=l.length?'<div class="grid3">'+l.map(A).join("")+"</div>":'<div class="muted" style="margin:6px 0 12px">Nessun appuntamento futuro</div>';var u,v,p,m="past_"+Math.random().toString(36).slice(2,8);c+='<div id="'+m+'_head" style="margin-top:12px;display:flex;align-items:center;justify-content:space-between;cursor:pointer"><b>Passati</b><span class="chev">▸</span></div><div id="'+m+'_box" style="display:none;margin-top:8px">'+(d.length?'<div class="grid3">'+d.map(A).join("")+"</div>":'<div class="muted">Nessun appuntamento passato</div>')+"</div>",s.innerHTML=c,u=document.getElementById(m+"_head"),v=document.getElementById(m+"_box"),p=u.querySelector(".chev"),u.onclick=function(){var e="none"===v.style.display;v.style.display=e?"":"none",p.textContent=e?"▾":"▸"};var g=o;s.querySelectorAll("[data-ics]").forEach(function(e){e.addEventListener("click",function(t){t.stopPropagation();var n=e.getAttribute("data-ics"),a=g.find(function(e){return String(e.id)===String(n)});a?window.BP&&BP.ICS&&"function"==typeof BP.ICS.downloadIcsForAppointment?(BP.ICS.downloadIcsForAppointment(a),"undefined"!=typeof haptics&&haptics.try("medium"),document.dispatchEvent(new Event("ics:exported")),L("Esportato")):L("Export .ics non disponibile"):L("Appuntamento non trovato")})}),s.querySelectorAll("[data-edit]").forEach(function(e){e.addEventListener("click",function(t){t.stopPropagation();var n=e.getAttribute("data-edit"),a=g.find(function(e){return String(e.id)===String(n)});a&&(S(a),window.scrollTo({top:0,behavior:"smooth"}))})})})}T.onchange=function(){var e=T.value;document.getElementById("af_week_wrap").style.display="sett"===e?"":"none",document.getElementById("af_month_wrap").style.display="mese"===e?"":"none",F()},[C,k,N].forEach(function(e){e&&(e.onchange=F)});try{var V=i("bp_prefill_slot",null);if(V&&V.start){var O=new Date(V.start),U=new Date(V.end||V.start),R=new Date(O.getTime()-6e4*O.getTimezoneOffset()).toISOString().slice(0,16);document.getElementById("a_start").value=R,document.getElementById("a_dur").value=String(Math.max(1,Math.round((U-O)/6e4))),w(),L("Slot precompilato negli appuntamenti")}s("bp_prefill_slot")}catch(Y){}try{var G=i("bp_edit_aid",null);G&&y("/api/appointments").then(function(e){var t=(e&&e.appointments||[]).find(function(e){return String(e.id)===String(G)});t&&(S(t),window.scrollTo({top:0,behavior:"smooth"}))}).finally(function(){try{s("bp_edit_aid")}catch(Y){}})}catch(Y){}document.getElementById("btnSaveA").onclick=function(){return E(!1)},document.getElementById("btnSaveExportA").onclick=function(){return E(!0)},document.getElementById("btnDeleteA").onclick=B,y("/api/clients").then(function(){}),F()}window.$1=window.$1||z,window.$all=window.$all||W,"function"!=typeof window.haptic&&(window.haptic=function(){}),e=[],window.onUnifiedRangeChange=function(t){"function"==typeof t&&e.push(t)},window.emitUnifiedRangeChange=function(t){for(var n=0,a=e;n<a.length;n++){var i=a[n];try{i(t)}catch(o){logger.error(o)}}},window.effectivePeriodType=b,window.showOverlay=function(e){var t=function(){var e=document.getElementById("bp-overlay");return e||((e=document.createElement("div")).id="bp-overlay",e.className="hidden",e.setAttribute("role","dialog"),e.setAttribute("aria-modal","true"),e.innerHTML='<div class="bp-overlay-backdrop" id="bp-overlay-backdrop"></div><div class="bp-overlay-panel" id="bp-overlay-panel"></div>',document.body.appendChild(e),document.getElementById("bp-overlay-backdrop").addEventListener("click",hideOverlay)),e}(),n=document.getElementById("bp-overlay-panel");n.innerHTML=e||"",t.classList.remove("hidden");var a=n.querySelector("input, textarea, select, button");a&&setTimeout(function(){try{a.focus()}catch(e){}},0)},window.hideOverlay=function(){var e=document.getElementById("bp-overlay");e&&e.classList.add("hidden")},window.viewGI=window.viewGI||function(){if(!u())return l();document.title="Battle Plan – GI & Scadenzario",r.innerHTML=j()+'\n  <div class="wrap">\n\n    <div class="card">\n      <b>Filtro</b>\n      <div class="row" style="margin-top:6px;align-items:flex-end;gap:16px;flex-wrap:wrap">\n        <div>\n          <label>Consulente</label>\n          <select id="gi_cons"><option value="">Tutti</option></select>\n        </div>\n      </div>\n      '.concat(p("gi"),'\n    </div>\n\n    <div class="card">\n      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">\n        <b>Vendite (GI)</b>\n        <button class="ghost" id="gi_add">Nuova vendita</button>\n      </div>\n      <div class="table" style="overflow:auto">\n        <table class="simple" style="min-width:980px">\n          <thead>\n            <tr>\n              <th>Data vendita</th>\n              <th>Cliente</th>\n              <th>Consulente</th>\n              <th>Servizi</th>\n              <th style="text-align:right">Tot. VSS</th>\n              <th>Piano pagamenti</th>\n              <th></th>\n            </tr>\n          </thead>\n          <tbody id="gi_rows"></tbody>\n        </table>\n      </div>\n    </div>\n\n  </div>'),H();var e=function(e){return document.getElementById(e)},n=function(e){return String(e||"").replace(/[&<>'"]/g,function(e){return{"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"}[e]})},a=function(e){return(Number(e)||0).toLocaleString("it-IT")+"€"},i=function(e){var t=new Date(e);return t.getFullYear()+"-"+("0"+(t.getMonth()+1)).slice(-2)+"-"+("0"+t.getDate()).slice(-2)},d=[];function s(e){return'<tr data-id="'+n(String(e.id))+'"><td>'+new Date(e.date||e.createdAt).toLocaleDateString("it-IT")+"</td><td>"+n(e.clientName||"")+"</td><td>"+n(e.consultantName||"")+"</td><td>"+n(e.services||"")+'</td><td style="text-align:right"><b>'+a(e.vssTotal||0)+"</b></td><td>"+function(e){var t=Array.isArray(e.schedule)?e.schedule.slice():[];if(!t.length)return'<span class="muted">—</span>';var n=t.find(function(e){return"deposit"===e.kind||/acconto/i.test(e.note||"")}),i=t.filter(function(e){return e!==n}),o=n?"Acconto: "+a(n.amount):"";if(!i.length)return o||'<span class="muted">—</span>';var r=Math.round(i[0].amount||0);return(o?o+" + ":"")+(i.every(function(e){return Math.abs(Math.round(e.amount||0)-r)<=1})?i.length+" rate da "+a(r):"piano personalizzato")}(e)+'</td><td class="right"><button class="ghost" data-edit="'+n(String(e.id))+'">Modifica</button></td></tr>'}function c(){var t=function(){var e=window.readUnifiedRange&&window.readUnifiedRange("gi")||{};if(!e||!e.start||!e.end){var t=new Date,n=new Date(t.getFullYear(),0,1),a=new Date(t.getFullYear(),11,31,23,59,59);return{from:i(n),to:i(a)}}return{from:i(e.start),to:i(e.end)}}(),n=(e("gi_cons")||{}).value||"";y("/api/gi"+("?from="+encodeURIComponent(t.from)+"&to="+encodeURIComponent(t.to)+(n?"&userId="+encodeURIComponent(n):""))).then(function(t){var n=t&&t.sales||[];n.sort(function(e,t){return+new Date(t.date||t.createdAt||0)-+new Date(e.date||e.createdAt||0)}),e("gi_rows").innerHTML=n.length?n.map(s).join(""):'<tr><td colspan="7" class="muted">Nessuna vendita</td></tr>',document.querySelectorAll("[data-edit]").forEach(function(e){e.addEventListener("click",function(){m(e.getAttribute("data-edit"))})})}).catch(function(e){logger.error(e),L("Errore caricamento GI")})}function v(r){var l=r.sale||{},s=Array.isArray(l.schedule)?l.schedule.slice():[],u=s.find(function(e){return"deposit"===e.kind||/acconto/i.test(e.note||"")}),v=s.filter(function(e){return e!==u}),p=!(v.length>0)||v.every(function(e){return Math.abs((+e.amount||0)-(+v[0].amount||0))<=1}),m=v.length&&p?"rate":"manual",g=i(new Date),f='<div class="modal"><div class="card gi-modal"><style>.gi-modal{min-width:min(760px,96vw);max-width:980px;max-height:86vh;overflow:auto}@media (max-width:740px){ .gi-grid{display:block} .gi-col{width:100%} .gi-modal{min-width:96vw} }.gi-grid{display:flex; gap:12px; flex-wrap:wrap} .gi-col{flex:1; min-width:240px}.gi-section{border-top:1px solid var(--hair, rgba(0,0,0,.12)); padding-top:10px; margin-top:10px}.pilltabs{display:flex; gap:12px; align-items:center} .pilltabs label{display:flex; align-items:center; gap:6px; cursor:pointer}.mrow{display:flex; gap:8px; align-items:center; flex-wrap:wrap}.mini input[type=number]{width:120px}.gi-rlist{margin-top:6px; max-height:200px; overflow:auto; border:1px dashed rgba(0,0,0,.15); border-radius:8px; padding:6px}.gi-r{display:flex; gap:6px; align-items:center; padding:4px 0}.gi-foot{display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:12px}</style><div style="display:flex;justify-content:space-between;align-items:center"><b>'+(r.title||(l.id?"Modifica vendita":"Nuova vendita"))+'</b><button class="ghost" id="m_close">Chiudi</button></div><div class="gi-grid"><div class="gi-col"><label>Data</label><input id="m_date" type="date" value="'+n(i(l.date||g))+'"></div><div class="gi-col"><label>Cliente</label><select id="gi_client_select"><option value="">Caricamento…</option></select></div><div class="gi-col"><label>Totale VSS</label><input id="m_vss" type="number" step="1" value="'+n(Number(l.vssTotal||0))+'"></div></div><div class="gi-section"><label>Servizi</label><textarea id="m_srv" rows="2">'+n(l.services||"")+'</textarea></div><div class="gi-section"><b>Acconto</b><div class="mrow mini" style="margin-top:6px"><label><input id="acc_enable" type="checkbox" '+(u?"checked":"")+'> Abilita</label><label>Tipo</label><select id="acc_type"><option value="abs">Valore assoluto</option><option value="perc">Percentuale</option></select><label>Valore</label><input id="acc_value" type="number" step="1" value="'+(u?n(Number(u._fromPerc?u._rawPerc:u.amount)):"0")+'"><label>Scadenza</label><input id="acc_date" type="date" value="'+n(i(u?u.dueDate:l.date||g))+'"><label>Nota</label><input id="acc_note" placeholder="es. Acconto" value="'+n(u&&u.note||"Acconto")+'"></div></div><div class="gi-section"><b>Modalità pagamenti</b><div class="pilltabs" style="margin:6px 0 8px"><label><input type="radio" name="pmode" value="rate" '+("rate"===m?"checked":"")+'> Rateale</label><label><input type="radio" name="pmode" value="manual" '+("rate"!==m?"checked":"")+'> Scaglioni manuali</label></div><div id="p_rate" style="display:'+("rate"===m?"block":"none")+'"><div class="mrow mini"><label>N° rate</label><input id="rt_n" type="number" value="'+n(v.length||12)+'"><label>Frequenza</label><select id="rt_freq"><option value="M">Mensile</option><option value="Q">Trimestrale</option><option value="W">Settimanale</option><option value="Y">Annuale</option></select><label>Prima scadenza</label><input id="rt_first" type="date" value="'+n(v[0]?i(v[0].dueDate):i(l.date||g))+'"><button class="ghost" id="rt_build">Ricalcola rate</button></div><div id="rt_preview" class="gi-rlist muted small">—</div></div><div id="p_manual" style="display:'+("rate"!==m?"block":"none")+'"><div class="mrow mini"><button class="ghost" id="mn_add">Aggiungi scaglione</button></div><div id="mn_list" class="gi-rlist"></div></div></div><div class="gi-foot"><div><div id="tot_prog" class="small muted">Programmato: 0€</div><div id="tot_chk"  class="small muted">Totale VSS: 0€</div></div><div style="display:flex;gap:8px">'+(l.id?'<button class="ghost danger" id="m_del">Elimina</button>':"")+'<button id="m_save">Salva</button></div></div></div></div>';showOverlay(f);var b=document.documentElement.style.overflow;function y(){document.documentElement.style.overflow=b,hideOverlay()}function w(e,t){var n=new Date(e);return n.setMonth(n.getMonth()+t),n}function _(e,t){var n=new Date(e);return n.setDate(n.getDate()+7*t),n}function x(e,t){var n=new Date(e);return n.setMonth(n.getMonth()+3*t),n}function S(e,t){var n=new Date(e);return n.setFullYear(n.getFullYear()+t),n}function I(){for(var t=Math.max(1,Number(e("rt_n").value||0)),n=e("rt_freq").value,a=new Date(e("rt_first").value||g),i=Math.max(0,Number(e("m_vss").value||0)),o=P(),r=Math.max(0,i-o),l=Math.round(r/t),d=[],s=0;s<t;s++){var c=void 0;c="M"===n?w(a,s):"Q"===n?x(a,s):"W"===n?_(a,s):S(a,s),d.push({dueDate:c.toISOString(),amount:l,note:"Rata "+(s+1)+"/"+t,kind:"installment"})}return D(d),d}function D(t){e("rt_preview").innerHTML=t.map(function(e){return"<div>"+new Date(e.dueDate).toLocaleDateString("it-IT")+" · "+a(e.amount)+' <span class="muted">'+n(e.note||"")+"</span></div>"}).join(""),e("rt_preview")._data=t,C()}function E(t){var a=e("mn_list");a.innerHTML="",t.forEach(function(e,t){var o=document.createElement("div");o.className="gi-r",o.innerHTML='<input type="date" data-k="dueDate" value="'+n(i(e.dueDate))+'"><input type="number" step="1" data-k="amount" value="'+n(Number(e.amount||0))+'" style="width:120px"><input type="text" data-k="note"   value="'+n(e.note||"")+'" placeholder="nota" style="flex:1"><button class="ghost" data-del="'+t+'">✕</button>',a.appendChild(o)}),a.querySelectorAll("[data-del]").forEach(function(e){e.onclick=function(){var t=Number(e.getAttribute("data-del")),n=a._data||[];n.splice(t,1),E(n)}}),a.oninput=function(){var e=a._data||[];Array.from(a.children).forEach(function(t,n){var a=e[n];if(a){var i=t.querySelector('[data-k="dueDate"]').value,o=Number(t.querySelector('[data-k="amount"]').value||0),r=t.querySelector('[data-k="note"]').value;a.dueDate=new Date(i).toISOString(),a.amount=Math.round(o),a.note=r}}),C()},a._data=t,C()}if(document.documentElement.style.overflow="hidden",function(){var t=e("gi_client_select");t.innerHTML='<option value="">— seleziona cliente —</option>'+d.map(function(e){return'<option value="'+n(e.id)+'">'+n(e.name)+"</option>"}).join("");var a=l.clientId||l.client_id||"";if(a&&(t.value=String(a)),!t.value&&l.clientName){var i=d.find(function(e){return String(e.name).trim().toLowerCase()===String(l.clientName).trim().toLowerCase()});i&&(t.value=String(i.id))}}(),u&&u._fromPerc&&(e("acc_type").value="perc"),Array.from(document.querySelectorAll('input[name="pmode"]')).forEach(function(t){t.addEventListener("change",function(){var t="rate"===document.querySelector('input[name="pmode"]:checked').value;e("p_rate").style.display=t?"block":"none",e("p_manual").style.display=t?"none":"block",C()})}),e("m_date").value=n(i(l.date||g)),e("m_vss").value=n(Number(l.vssTotal||0)),e("m_srv").value=n(l.services||""),e("acc_type").value=u&&u._fromPerc?"perc":"abs",e("acc_value").value=u?u._fromPerc?u._rawPerc:u.amount:0,e("acc_date").value=n(i(u?u.dueDate:l.date||g)),e("acc_note").value=u?n(u.note||"Acconto"):"Acconto","rate"===m){var B=v.length||12;e("rt_n").value=B,e("rt_first").value=v[0]?n(i(v[0].dueDate)):n(i(l.date||g)),D(v.length?v:I())}else E(v);function P(){if(!e("acc_enable").checked)return 0;var t=Math.max(0,Number(e("m_vss").value||0)),n=e("acc_type").value,a=Number(e("acc_value").value||0);return Math.round("perc"===n?t*(a/100):a)}function T(){var t=[];if(e("acc_enable").checked){var n=P();t.push({dueDate:new Date(e("acc_date").value||g).toISOString(),amount:n,note:e("acc_note").value||"Acconto",kind:"deposit",_fromPerc:"perc"===e("acc_type").value,_rawPerc:Number(e("acc_value").value||0)})}if("rate"===document.querySelector('input[name="pmode"]:checked').value){var a=(e("rt_preview")._data||[]).map(function(e){return Object.assign({},e)});return t.concat(a)}var i=(e("mn_list")._data||[]).map(function(e){return Object.assign({kind:"manual"},e)});return t.concat(i)}function C(){var t=Math.max(0,Number(e("m_vss").value||0)),n=T(),i=Math.round(n.reduce(function(e,t){return e+Number(t.amount||0)},0));e("tot_prog").textContent="Programmato: "+a(i),e("tot_chk").textContent="Totale VSS: "+a(t)+(i===t?" OK":" (manca "+a(t-i)+")"),e("m_save").disabled=i!==t||!e("gi_client_select").value}if(e("rt_build").onclick=function(){return D(I())},e("mn_add").onclick=function(){var t=e("mn_list")._data||[];t.push({dueDate:(new Date).toISOString(),amount:0,note:"",kind:"manual"}),E(t)},e("m_close").onclick=y,["m_vss","acc_enable","acc_type","acc_value","acc_date","rt_n","rt_freq","rt_first"].forEach(function(t){var n=e(t);n&&n.addEventListener("input",C)}),e("gi_client_select").addEventListener("change",C),C(),e("m_save").onclick=function(){var t=e("gi_client_select").value||"",n=d.find(function(e){return String(e.id)===String(t)});if(n){var a={id:l.id||void 0,date:new Date(e("m_date").value||g).toISOString(),clientId:n.id,clientName:n.name,vssTotal:Math.round(Number(e("m_vss").value||0)),services:e("m_srv").value||"",schedule:T()};Promise.resolve(h("/api/gi",a)).then(function(){y(),haptic("light"),c()}).catch(function(e){logger.error(e),L("Errore salvataggio")})}else L("Seleziona un cliente")},l.id){var k=e("m_del");k&&(k.onclick=o(t().m(function e(){var n;return t().w(function(e){for(;;)switch(e.p=e.n){case 0:if(confirm("Eliminare definitivamente questa vendita?")){e.n=1;break}return e.a(2);case 1:return e.p=1,e.n=2,h("/api/gi/delete",{id:l.id}).catch(function(){return h("/api/gi",{id:l.id,_delete:1})});case 2:y(),L("Vendita eliminata"),c(),e.n=4;break;case 3:e.p=3,n=e.v,logger.error(n),L("Errore eliminazione");case 4:return e.a(2)}},e,null,[[1,3]])})))}}function m(e){y("/api/gi?from=1900-01-01&to=2999-12-31").then(function(t){var n=(t&&t.sales||[]).find(function(t){return String(t.id)===String(e)});n?v({title:"Modifica vendita",sale:n}):L("Vendita non trovata")})}document.addEventListener("gi:edit",function(e){var t=e&&e.detail&&e.detail.id;t&&m(t)}),e("gi_add").onclick=function(){v({title:"Nuova vendita"})},g("gi",function(){haptic("light"),c()}),(e("gi_cons")||{}).onchange=function(){haptic("light"),c()},y("/api/clients").then(function(e){return d=e&&e.clients||[],y("/api/usernames")}).then(function(t){var a=t&&t.users||[],i=e("gi_cons");i&&(i.innerHTML='<option value="">Tutti</option>'+a.map(function(e){return'<option value="'+n(String(e.id))+'">'+n(e.name)+"</option>"}).join(""))}).then(c)},window.viewHome=Y,window.viewCalendar=function(){if(!u())return l();function e(e){var t=function(e){if(!e)return new Date(NaN);if("string"==typeof e){var t=e.match(/^(\d{4})-(\d{2})-(\d{2})[T ](\d{2}):(\d{2})/);if(t)return new Date(+t[1],+t[2]-1,+t[3],+t[4],+t[5])}return new Date(e)}(e);return(isFinite(t)?("0"+t.getHours()).slice(-2):"--")+":"+(isFinite(t)?("0"+t.getMinutes()).slice(-2):"--")}if(document.title="Battle Plan – Calendario",!document.getElementById("cal_dynamic_css")){var t=document.createElement("style");t.id="cal_dynamic_css",t.textContent="\n      /* ============== CALENDAR ============== */\n      #cal_container{ overflow-x:auto; -webkit-overflow-scrolling:touch; }\n      #cal_container .calendar{ min-width: 860px; }\n\n      .calendar{ display:grid; grid-template-columns: 44px repeat(7, 1fr); gap:10px; }\n      .calendar .weekLabel{ color:var(--muted); font-size:12px; display:flex; align-items:center; justify-content:center; }\n\n      .calendar .day{\n        min-height:120px; background: var(--card);\n        border:2px solid var(--hair2); border-radius:14px; padding:8px;\n        display:flex; flex-direction:column; gap:3px; overflow:hidden;\n      }\n      .calendar .day.today{\n        outline: 2px solid var(--accent);\n        box-shadow: 0 0 0 2px rgba(0,0,0,.06) inset;\n      }\n      .calendar .day .dnum{ font-weight:800; }\n      .calendar .day .small{\n        font-size:12px; line-height:1.15;\n        white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:100%;\n      }\n      .calendar .day .tag{ padding:2px 6px; border-radius:999px; border:1px solid var(--hair2); font-size:11px; align-self:flex-start; }\n      .calendar .day.busy0{ border-color:#27ae60; background:rgba(39,174,96,.08); }\n      .calendar .day.busy1{ border-color:#ff9f1a; background:rgba(255,159,26,.10); }\n      .calendar .day.busy2{ border-color:#7d1731; background:rgba(125,23,49,.12); }\n      .calendar .day.dense .small{ font-size:11px; line-height:1.1; }\n      .calendar .day.dense .tag{ transform:scale(.9); transform-origin:left top; }\n\n      @media (max-width: 900px){\n        .calendar{ grid-template-columns: 36px repeat(7, 1fr); }\n        .calendar .weekLabel{ display:flex !important; font-size:11px; }\n        .calendar .day{ min-height:92px; padding:6px; }\n        .calendar .day .dnum{ font-size:16px; }\n        .calendar .day .small{ white-space: normal !important; overflow: visible !important; text-overflow: clip !important; }\n        .calendar .day.dense .small{ font-size:clamp(9px,2.4vw,11px); }\n        .calendar .day .tag{ font-size:10px; }\n      }\n\n      .cal-filters .chip{\n        display:inline-flex; align-items:center; gap:6px;\n        padding:6px 10px; border-radius:999px; border:1px solid var(--hair2);\n      }\n    ",document.head.appendChild(t)}var a=x(S(new Date)).slice(0,7);function i(){var t=document.getElementById("cal_month").value;!function(t,a,i){Promise.all([y("/api/appointments"),y("/api/availability?from="+t+"-"+w(a)+"-01&to="+t+"-"+w(a)+"-"+w(new Date(t,a,0).getDate()))]).then(function(o){var r=o[0]&&o[0].appointments?o[0].appointments:[],l=(o[1]||{slots:[]}).slots||[],d=new Date(t,a-1,1),s=new Date(t,a,0,23,59,59,999);function c(e,t){for(var n={vss:0,vsd:0,nncf:0,count:0},a=0;a<r.length;a++){var i=r[a],o=new Date(i.start);o>=e&&o<=t&&(n.vss+=Number(i.vss||0),n.vsd+=Number(i.vsdPersonal||0),n.nncf+=i.nncf?1:0,n.count+=1)}return n}function u(e,t,n){var a=document.getElementById("cal_results");if(a){var i=n?'<div class="right"><button id="res_reset" class="ghost">Torna al mese</button></div>':"";if(a.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center"><b>Risultati · '+t+"</b>"+i+'</div><div class="row" style="margin-top:8px;gap:8px;flex-wrap:wrap"><span class="chip small">VSS <b>'+O(e.vss)+'</b></span><span class="chip small">VSD <b>'+O(e.vsd)+'</b></span><span class="chip small">NNCF <b>'+U(e.nncf)+'</b></span><span class="chip small">N. app <b>'+U(e.count)+"</b></span></div>",a.style.display="block",n){var o=document.getElementById("res_reset");o&&(o.onclick=function(){u(c(d,s),b,!1)})}}}for(var v={},p=0;p<r.length;p++){var m=r[p];if(!((X=new Date(m.start))<d||X>s)){var g=x(X);v[g]||(v[g]={vss:0,vsd:0,nncf:0,mins:0,count:0,items:[]}),v[g].vss+=Number(m.vss||0),v[g].vsd+=Number(m.vsdPersonal||0),v[g].nncf+=m.nncf?1:0,v[g].mins+=Number(m.durationMinutes||0),v[g].count+=1,v[g].items.push(m)}}var f=["Lun","Mar","Mer","Gio","Ven","Sab","Dom"],b=new Date(t,a-1,1).toLocaleString("it-IT",{month:"long",year:"numeric"}),y='<div class="card"><b class="neon">'+b+"</b></div>";y+='<div class="calendar">',y+='<div class="weekLabel">W</div>';for(var h=0;h<7;h++)y+='<div class="weekLabel">'+f[h]+"</div>";var S=new Date(t,a-1,1),I=(S.getDay()+6)%7,E=new Date(S);E.setDate(S.getDate()-I);for(var B=0;B<6;B++){var P=new Date(E),T="W"+D(P);y+='<div class="weekLabel" data-ws="'+x(P)+'" style="cursor:pointer">'+T+"</div>";for(var C=0;C<7;C++){var k=E.getMonth()===a-1,M=(g=x(E),v[g]||{vss:0,vsd:0,nncf:0,mins:0,count:0,items:[]}),N=E.getDay(),A=0===N||6===N,F=!A&&l.some(function(e){return e.date===g});if(k&&i){if(i.only_free&&M.count>0){y+="<div></div>",E.setDate(E.getDate()+1);continue}if(i.only_4h&&!F){y+="<div></div>",E.setDate(E.getDate()+1);continue}}if(k){var j="";A?M.count>0&&(j="busy2"):j=0===M.count?"busy0":F?"busy1":"busy2";var H="",R=0;A&&0===M.count||(M.vss>0&&(H+='<div class="small">VSS '+O(M.vss)+"</div>",R++),M.vsd>0&&(H+='<div class="small">VSD '+O(M.vsd)+"</div>",R++),M.nncf>0&&(H+='<div class="small">NNCF '+U(M.nncf)+"</div>",R++),M.count>0&&(H+='<div class="small">App. '+U(M.count)+"</div>",R++),F&&(H+='<div class="tag" style="margin-top:4px">slot ≥4h</div>',R++)),y+='<div class="day '+j+(R>=3?" dense":"")+(F?" slot-free":"")+'" data-day="'+g+'" title="Settimana '+D(E)+'"><div class="dnum">'+E.getDate()+"</div>"+(H||"")+"</div>"}else y+="<div></div>";E.setDate(E.getDate()+1)}}y+="</div>",document.getElementById("cal_container").innerHTML=y,u(c(d,s),b,!1),document.querySelectorAll(".calendar .weekLabel[data-ws]").forEach(function(e){e.addEventListener("click",function(){var t=e.getAttribute("data-ws"),n=new Date(t),a=new Date(n);a.setDate(a.getDate()+6),a.setHours(23,59,59,999);var i="Settimana W"+D(n)+" · "+_(n)+"–"+_(a);u(c(n,a),i,!0)})}),document.querySelectorAll(".day[data-day]").forEach(function(t){t.addEventListener("click",function(){var a=t.getAttribute("data-day"),i=v[a]&&v[a].items?v[a].items.slice():[];i.sort(function(e,t){return new Date(e.start)-new Date(t.start)});var o=document.getElementById("cal_day_box"),r="<b>Appuntamenti del "+a.split("-").reverse().join("/")+"</b>";if(i.length){r+='<div class="row" style="margin-top:8px">';for(var l=0;l<i.length;l++){var d=i[l],s=' data-start="'+d.start+'" data-end="'+d.end+'" data-title="'+V(d.client||"Appuntamento")+'" ';r+='<div class="card cal-app" data-aid="'+d.id+'" '+s+' style="flex:1 1 320px;cursor:pointer"><div class="small muted">'+e(d.start)+"–"+e(d.end)+" · "+V(d.type||"")+"</div><div><b>"+V(d.client||"")+'</b></div><div class="small">VSS '+O(d.vss)+" · VSD "+O(d.vsdPersonal)+" · NNCF "+(d.nncf?"✅":"—")+"</div>"+(d.notes?'<div class="small muted">'+V(d.notes)+"</div>":"")+"</div>"}r+="</div>"}else r+='<div class="muted" style="margin-top:6px">Nessun appuntamento</div>';if(o.style.display="block",o.innerHTML=r,o.querySelectorAll(".cal-app").forEach(function(e){e.addEventListener("click",function(t){t.stopPropagation(),n("bp_edit_aid",e.getAttribute("data-aid")),J()})}),window.scrollTo({top:o.getBoundingClientRect().top+window.scrollY-80,behavior:"smooth"}),"function"==typeof window.wireICSInsideDayBox)try{window.wireICSInsideDayBox()}catch(c){}})});var G=document.getElementById("cal_free_slots"),Y=function(){var e=new Date;return e.getFullYear()+"-"+w(e.getMonth()+1)+"-"+w(e.getDate())}(),q=(l||[]).filter(function(e){return String(e.date||"").slice(0,10)>=Y});if(q.length){var z='<b>Slot liberi ≥ 4h (da oggi in poi)</b> · <span class="badge">Tot: '+q.length+"</span>";z+='<div class="row" style="margin-top:8px">';for(var W=0;W<q.length&&W<80;W++){var X,$="morning"===(X=q[W]).part?"mattina":"pomeriggio";z+='<div class="card slotBtn" data-start="'+X.start+'" data-end="'+X.end+'" style="flex:1 1 280px;cursor:pointer"><div class="small"><b>'+_(X.start)+"</b> · "+$+'</div><div class="small">'+e(X.start)+"–"+e(X.end)+"</div></div>"}z+="</div>",G.style.display="block",G.innerHTML=z,G.querySelectorAll(".slotBtn").forEach(function(e){e.addEventListener("click",function(){n("bp_prefill_slot",{start:e.getAttribute("data-start"),end:e.getAttribute("data-end")}),J(),L("Slot precompilato negli appuntamenti")})})}else G.style.display="block",G.innerHTML='<b>Slot liberi ≥ 4h (da oggi in poi)</b> · <span class="badge">Tot: 0</span><div class="muted" style="margin-top:6px">Nessuno slot libero disponibile.</div>';try{window.injectTodayCSS&&window.injectTodayCSS()}catch(Q){}try{window.hookCalendar?window.hookCalendar():(window.markToday&&window.markToday(),window.clampSlotCounters&&window.clampSlotCounters())}catch(Q){}}).catch(function(e){logger.error(e),L("Errore calendario")})}(parseInt(t.split("-")[0],10),parseInt(t.split("-")[1],10),{only_free:document.getElementById("only_free").checked,only_4h:document.getElementById("only_4h").checked})}function o(e){var t=document.getElementById("cal_month");if(t){var n=t.value.split("-"),a=+n[0],o=+n[1];(o+=e)<=0?(o=12,a--):o>12&&(o=1,a++),t.value=a+"-"+w(o),i()}}r.innerHTML=j()+'<div class="wrap"><div class="card"><div class="row" style="align-items:flex-end;gap:12px;flex-wrap:wrap"><div class="row" style="align-items:flex-end;gap:8px"><button id="cal_prev" class="ghost" title="Mese precedente">◀</button><div><label>Mese</label><input type="month" id="cal_month" value="'+a+'"></div><button id="cal_next" class="ghost" title="Mese successivo">▶</button></div><div class="cal-filters"><label class="chip small"><input type="checkbox" id="only_free"> Solo giorni liberi</label> <label class="chip small"><input type="checkbox" id="only_4h"> Solo slot ≥ 4h</label></div><div class="right" style="margin-left:auto"><button id="cal_refresh" class="ghost">Aggiorna</button></div></div></div><div id="cal_container"></div><div id="cal_results" class="card" style="margin-top:8px;display:none"></div><div id="cal_day_box" class="card" style="margin-top:8px;display:none"></div><div class="card" id="cal_free_slots" style="margin-top:8px;display:none"></div></div>',H(),document.getElementById("cal_refresh").onclick=i,document.getElementById("cal_month").onchange=i;var d=document.getElementById("cal_prev"),s=document.getElementById("cal_next");d&&(d.onclick=function(){o(-1)}),s&&(s.onclick=function(){o(1)}),document.getElementById("only_free").onchange=i,document.getElementById("only_4h").onchange=i,i()},window.viewPeriods=X,window.viewAppointments=J,window.viewLeaderboard=function(){if(!u())return l();function e(e){if(!e)return"";var t=new Date(e);return t.getFullYear()+"-"+("0"+(t.getMonth()+1)).slice(-2)+"-"+("0"+t.getDate()).slice(-2)}function t(){var t,r,l,d,s,c=document.getElementById("lb_tab").value,u=(r=f("lb"),l=e(r.start),d=e(r.end),s="ytd"===(t=r.type||"mensile")||"ltm"===t?"mensile":t,"&from="+encodeURIComponent(l)+"&to="+encodeURIComponent(d)+"&type="+encodeURIComponent(s)),v=document.getElementById("lb_mode").value;if("overall"===c)y("/api/leaderboard_overall?mode="+encodeURIComponent(v)+u).then(o);else{var p=document.getElementById("lb_indicator").value;y("/api/leaderboard?indicator="+encodeURIComponent(p)+"&mode="+encodeURIComponent(v)+u).then(function(e){!function(e,t){document.getElementById("lb_title").textContent="Classifica – "+t;var o=e.ranking||[];if(a(o),!o.length)return void(document.getElementById("lb_table").innerHTML='<div class="muted">Nessun dato</div>');for(var r='<div class="row">',l=o[0].total||1,d=0;d<o.length;d++){var s=o[d];r+=i(n(d)+" "+s.name,"Totale: "+U(s.total),s.total/l*100)}r+="</div>",document.getElementById("lb_table").innerHTML=r}(e,p)})}}function n(e){return 0===e?"🥇":1===e?"🥈":2===e?"🥉":e+1+"."}function a(e){var t=document.getElementById("lb_podium");if(e&&e.length){for(var a=e.slice(0,3),i='<div class="row" style="align-items:flex-end">',o=0;o<a.length;o++){i+='<div class="card" style="flex:1 1 120px;height:'+(80-15*o)+'px;display:flex;align-items:flex-end;justify-content:center"><div>'+V(n(o)+" "+a[o].name)+"</div></div>"}i+="</div>",t.innerHTML=i}else t.innerHTML=""}function i(e,t,n){var a=Math.min(100,Math.max(0,Math.round(n)));return'<div class="card" style="flex:1 1 280px"><div><b>'+V(e)+'</b></div><div class="small muted">'+V(t)+'</div><div style="height:10px;background:rgba(255,255,255,0.1);border-radius:6px;overflow:hidden;margin-top:6px"><div style="height:10px;width:'+a+'%;background:linear-gradient(90deg,var(--accent),var(--accent2));"></div></div></div>'}function o(e){document.getElementById("lb_title").textContent="Classifica generale";var t=e.ranking||[];if(a(t),t.length){for(var o=t[0].score||0,r='<div class="row">',l=0;l<t.length;l++){var d=t[l];r+=i(n(l)+" "+d.name,"Score: "+U(d.score)+"/100",o?d.score/o*100:0)}r+="</div>",document.getElementById("lb_table").innerHTML=r}else document.getElementById("lb_table").innerHTML='<div class="muted">Nessun dato</div>'}document.title="Battle Plan – Classifiche",r.innerHTML=j()+'<div class="wrap"><div class="card"><div class="row"><div><label>Vista</label><select id="lb_tab"><option value="per_indicator">Per indicatore</option><option value="overall">Generale (score)</option></select></div><div><label>Modalità</label><select id="lb_mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div><div id="lb_ind_wrap"><label>Indicatore</label><select id="lb_indicator"><option value="VSS">VSS</option><option value="VSDPersonale">VSD</option><option value="GI">GI</option><option value="NNCF">NNCF</option></select></div></div>'+p("lb")+'</div><div class="card"><b id="lb_title">Classifica</b><div id="lb_podium" style="margin:10px 0"></div><div id="lb_table"></div></div></div>',H(),document.getElementById("lb_tab").onchange=function(){var e=this.value;document.getElementById("lb_ind_wrap").style.display="per_indicator"===e?"":"none",t()},g("lb",t),document.getElementById("lb_mode").onchange=t,document.getElementById("lb_indicator").onchange=t,t()},window.viewClients=function(){if(!u())return l();function e(){y("/api/clients").then(function(t){var n=t&&t.clients||[],a=document.getElementById("cl_f_state").value,i=document.getElementById("cl_f_cons").value;function o(e){return String(e||"").trim().toLowerCase()}var r=n.filter(function(e){return(!a||o(e.status)===o(a))&&(!i||String(e.consultantId||"")===String(i))}).map(function(e){var t=V(e.name||""),n=V(e.status||"potenziale"),a=e.consultantName?V(e.consultantName):"unknown",i=String(e.id||"");return'<div class="card" data-clid="'+i+'" data-name-lower="'+t.toLowerCase()+'" data-status="'+n+'" data-consultant-id="'+V(String(e.consultantId||""))+'" style="flex:1 1 380px"><div><b>'+t+'</b></div><div class="small">Stato: <b class="cl-status">'+n+'</b></div><div class="small">Consulente: <b class="cl-cons">'+a+'</b></div><div class="small muted">Ultimo appuntamento: <span class="last-appt">—</span></div><div class="right" style="margin-top:6px"><button class="ghost" data-del="'+i+'">Rimuovi</button></div></div>'}).join("");document.getElementById("cl_list").innerHTML=r||'<div class="muted">Nessun cliente</div>',document.querySelectorAll("[data-del]").forEach(function(t){t.addEventListener("click",function(){var n=t.getAttribute("data-del");confirm("Rimuovere il cliente?")&&fetch("/api/clients?id="+encodeURIComponent(n),{method:"DELETE",headers:{Authorization:"Bearer "+c()}}).then(function(e){if(!e.ok)throw new Error("HTTP "+e.status);return e.json()}).then(function(){L("Cliente rimosso"),e()}).catch(function(e){logger.error(e),L("Errore rimozione")})})}),window.BPFinal&&"function"==typeof BPFinal.ensureClientSection?BPFinal.ensureClientSection():setTimeout(function(){var e=document.getElementById("cl_list"),t=Array.from(e.children).filter(function(e){return e.classList.contains("card")});t.sort(function(e,t){return String(e.getAttribute("data-name-lower")||"").localeCompare(String(t.getAttribute("data-name-lower")||""))});var n,a=d(t);try{for(a.s();!(n=a.n()).done;){var i=n.value;e.appendChild(i)}}catch(o){a.e(o)}finally{a.f()}},0)})}document.title="Battle Plan – Clienti",r.innerHTML=j()+'<div class="wrap"><div class="card"><b>Nuovo cliente</b><div class="row" style="margin-top:8px"><div><label>Ragione sociale</label><input id="cl_name" type="text" placeholder="Es. Rossi S.r.l."></div><div><label>Stato</label><select id="cl_new_state"><option value="potenziale">Potenziale</option><option value="lead non chiuso">Lead non chiuso</option><option value="attivo">Attivo</option></select></div><div><label>Consulente</label><select id="cl_new_owner"><option value="">—</option></select></div><div class="right"><button id="cl_add">Aggiungi</button></div></div></div><div class="card"><b>Filtri elenco</b><div class="row" style="margin-top:8px"><div><label>Stato</label><select id="cl_f_state"><option value="">Tutti</option><option value="attivo">Attivo</option><option value="lead non chiuso">Lead non chiuso</option><option value="potenziale">Potenziale</option></select></div><div><label>Consulente</label><select id="cl_f_cons"><option value="">Tutti</option></select></div><div><label>Ordina per</label><select id="cl_order"><option value="az">Ragione sociale (A→Z)</option><option value="last_desc">Ultimo appuntamento (recenti prima)</option></select></div><div class="right"><button class="ghost" id="cl_f_apply">Applica</button></div></div></div><div class="card"><b>Elenco clienti</b><div id="cl_list" class="row" style="margin-top:8px"></div></div></div>',H(),document.getElementById("cl_add").onclick=function(){var t=(document.getElementById("cl_name").value||"").trim();if(t){var n=document.getElementById("cl_new_state"),a=document.getElementById("cl_new_owner"),i={name:t};n&&(i.status=n.value),a&&a.value&&(i.consultantId=a.value),h("/api/clients",i).then(function(){document.getElementById("cl_name").value="",e(),F(),addXP(5)}).catch(function(e){logger.error(e),L("Errore creazione cliente")})}else L("Nome obbligatorio")},document.getElementById("cl_f_apply").onclick=e,y("/api/usernames").then(function(e){var t=e&&e.users||[],n=document.getElementById("cl_f_cons"),a=document.getElementById("cl_new_owner");n&&(n.innerHTML='<option value="">Tutti</option>'+t.map(function(e){return'<option value="'+e.id+'">'+V(e.name)+(e.grade?" ("+e.grade+")":"")+"</option>"}).join("")),a&&(a.innerHTML='<option value="">—</option>'+t.map(function(e){return'<option value="'+e.id+'">'+V(e.name)+(e.grade?" ("+e.grade+")":"")+"</option>"}).join(""))}).catch(function(e){logger.error(e)}),e()},window.viewTeam=function(){if(!u())return l();document.title="Battle Plan – Squadra";var e=j()+'<div class="wrap"><div class="card"><b>Vista Amministratore</b><div id="t_adminbar" class="row" style="margin-top:8px;display:flex;align-items:flex-end;gap:16px;flex-wrap:nowrap"><div><label>Modalità</label><select id="t_mode" name="mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div><div id="t_unified_wrap">'+p("t")+'</div></div></div><div class="card"><b>Riepilogo per utente</b><div id="t_users" class="row" style="margin-top:8px"></div></div><div class="card"><b>Aggregato Squadra</b><div id="t_agg" class="row" style="margin-top:8px"></div><div class="row" style="margin-top:12px;align-items:flex-end;gap:16px;flex-wrap:nowrap"><div><label>Indicatore grafico</label><select id="t_ind"><option value="VSS">VSS</option><option value="VSDPersonale">VSD Personale</option><option value="VSDIndiretto">VSD Indiretto</option><option value="VSDTotale">VSD Totale</option><option value="GI">GI</option><option value="NNCF">NNCF</option><option value="provv_gi">Provv GI</option><option value="provv_vsd">Provv VSD</option><option value="tot_provv" selected>Tot Provvigioni</option></select></div><div><label>Consulente</label><select id="t_cons"><option value="">Tutti</option></select></div></div><div style="margin-top:8px"><canvas id="t_chart" height="160"></canvas></div></div></div>';function t(e){return e=Number(e||0),isFinite(e)?e:0}function n(e){if(!e)return"";var t=new Date(e);return t.getFullYear()+"-"+("0"+(t.getMonth()+1)).slice(-2)+"-"+("0"+t.getDate()).slice(-2)}function i(){var e,t=f("t"),a=n(t.start),i=n(t.end),o=(e=t.type,0===(e=String(e||"mensile").toLowerCase()).indexOf("sett")?"settimanale":0===e.indexOf("mes")?"mensile":0===e.indexOf("tri")?"trimestrale":0===e.indexOf("sem")?"semestrale":0===e.indexOf("ann")?"annuale":"mensile");return"&from="+encodeURIComponent(a)+"&to="+encodeURIComponent(i)+"&type="+encodeURIComponent(o)}function o(e){switch(String(e)){case"provv_gi":return"ProvvGI";case"provv_vsd":return"ProvvVSD";case"tot_provv":return"TotProvvigioni";default:return e}}function d(e){return(Number(e)||0).toLocaleString("it-IT")+"€"}function s(e){var t=Number(e)||0;return String(Math.round(t))}function c(e){return String(e).replace(/[&<>'"]/g,function(e){return{"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"}[e]})}r.innerHTML=e,H(),function(){var e=document.getElementById("t_adminbar"),t=document.getElementById("t_unified_wrap");if(e&&t){var n=t.querySelector(".row");n&&(Array.from(n.children).forEach(function(t){t.classList.remove("right"),t.style.marginTop="0",e.appendChild(t)}),t.remove())}}();var v=null;function m(e,t){var n=document.getElementById("t_chart");if(n){var i=e.map(function(e){return function(e,t){return"settimanale"===t?window.isoWeekNum?window.isoWeekNum(e):Math.ceil(e.getDate()/7):"mensile"===t||"ytd"===t||"ltm"===t?e.getMonth()+1:"trimestrale"===t?Math.floor(e.getMonth()/3)+1:"semestrale"===t?e.getMonth()<6?1:2:e.getFullYear()}(e.x,t)}),o=e.map(function(e){return e.y});if("undefined"==typeof Chart){var r=n.getContext("2d");n.width=n.clientWidth||600,n.height=n.clientHeight||160,r.clearRect(0,0,n.width,n.height);var l=Math.max.apply(Math,[1].concat(a(o))),d=o.length>1?(n.width-8)/(o.length-1):0;return r.beginPath(),r.lineWidth=2,r.strokeStyle="#2e6cff",o.forEach(function(e,t){var a=4+t*d,i=n.height-6-e/l*(n.height-12);t?r.lineTo(a,i):r.moveTo(a,i)}),void r.stroke()}r=n.getContext("2d");v?(v.data.labels=i,v.data.datasets[0].data=o,v.update()):v=new Chart(r,{type:"line",data:{labels:i,datasets:[{label:"",data:o,tension:.3,pointRadius:3}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{x:{grid:{display:!1},ticks:{autoSkip:!1,maxRotation:0,minRotation:0}},y:{beginAtZero:!0}}}})}}function b(e){return'<div class="card" style="flex:1 1 360px"><div style="display:flex;align-items:center;gap:8px"><div><b>'+c(e.name||"User #"+e.userId)+"</b></div>"+(e.grade?'<span class="chip small">'+c(e.grade)+"</span>":"")+'</div><div class="small" style="margin-top:6px">VSS '+d(e.vss||0)+'</div><div class="small">VSD Pers. '+d(e.vsdP||0)+'</div><div class="small">VSD Ind. '+d(e.vsdI||0)+'</div><div class="small">VSD Tot. '+d((e.vsdP||0)+(e.vsdI||0))+'</div><div class="small">GI '+d(e.gi||0)+'</div><div class="small">NNCF '+s(e.nncf||0)+'</div><div class="small muted" style="margin-top:6px">Provv GI '+d(e.provvGi||0)+'</div><div class="small muted">Provv VSD '+d(e.provvVsd||0)+'</div><div class="small"><b>Tot Provvigioni '+d(e.provvTot||0)+"</b></div></div>"}function h(){var e=(document.getElementById("t_mode")||{}).value||"consuntivo",n=i();Promise.all([y("/api/usernames"),y("/api/leaderboard?indicator="+encodeURIComponent("VSS")+n+"&mode="+encodeURIComponent(e)),y("/api/leaderboard?indicator="+encodeURIComponent("VSDPersonale")+n+"&mode="+encodeURIComponent(e)),y("/api/leaderboard?indicator="+encodeURIComponent("VSDIndiretto")+n+"&mode="+encodeURIComponent(e)),y("/api/leaderboard?indicator="+encodeURIComponent("GI")+n+"&mode="+encodeURIComponent(e)),y("/api/leaderboard?indicator="+encodeURIComponent("NNCF")+n+"&mode="+encodeURIComponent(e)),y("/api/leaderboard?indicator="+encodeURIComponent("ProvvGI")+n+"&mode="+encodeURIComponent(e)),y("/api/leaderboard?indicator="+encodeURIComponent("ProvvVSD")+n+"&mode="+encodeURIComponent(e))]).then(function(e){var n=e[0]||{},a=e[1]&&(e[1].rows||e[1].ranking)||[],i=e[2]&&(e[2].rows||e[2].ranking)||[],o=e[3]&&(e[3].rows||e[3].ranking)||[],r=e[4]&&(e[4].rows||e[4].ranking)||[],l=e[5]&&(e[5].rows||e[5].ranking)||[],u=e[6]&&(e[6].rows||e[6].ranking)||[],v=e[7]&&(e[7].rows||e[7].ranking)||[],p=(n.users||[]).map(function(e){return{id:String(e.id),name:e.name||e.email||"User #"+e.id,grade:"senior"===e.grade?"senior":"junior"}}),m=document.getElementById("t_cons");function g(e){for(var n={},a=0;a<e.length;a++){var i=e[a],o=String(i.userId||i.id||i.uid||""),r=t(i.total||i.value||i.sum||0);o&&(n[o]=r)}return n}m&&(m.innerHTML='<option value="">Tutti</option>'+p.map(function(e){return'<option value="'+e.id+'">'+c(e.name)+"</option>"}).join(""));var f=g(a),y=g(i),h=g(o),w=g(r),x=g(l),S=g(u),I=g(v),D=p.map(function(e){var n=t(f[e.id]),a=t(y[e.id]),i=t(h[e.id]),o=t(w[e.id]),r=t(x[e.id]),l=t(S[e.id]),d=t(I[e.id]);return{userId:e.id,name:e.name,grade:e.grade,vss:n,vsdP:a,vsdI:i,gi:o,nncf:r,provvGi:l,provvVsd:d,provvTot:l+d}}),E=document.getElementById("t_users");E&&(E.innerHTML=D.length?D.map(b).join(""):'<div class="muted">Nessun dato</div>');var B=D.reduce(function(e,t){return e.vss+=t.vss,e.vsdP+=t.vsdP,e.vsdI+=t.vsdI,e.gi+=t.gi,e.nncf+=t.nncf,e.provvGi+=t.provvGi,e.provvVsd+=t.provvVsd,e.provvTot+=t.provvTot,e},{vss:0,vsdP:0,vsdI:0,gi:0,nncf:0,provvGi:0,provvVsd:0,provvTot:0}),P=document.getElementById("t_agg");P&&(P.innerHTML=function(e){return'<div class="card" style="flex:1 1 460px"><div class="neon" style="font-weight:900">Totali squadra</div><div class="small" style="margin-top:6px">VSS '+d(e.vss)+'</div><div class="small">VSD Pers. '+d(e.vsdP)+'</div><div class="small">VSD Ind. '+d(e.vsdI)+'</div><div class="small">VSD Tot. '+d(e.vsdP+e.vsdI)+'</div><div class="small">GI '+d(e.gi)+'</div><div class="small">NNCF '+s(e.nncf)+'</div><div class="small muted" style="margin-top:6px">Provv GI '+d(e.provvGi)+'</div><div class="small muted">Provv VSD '+d(e.provvVsd)+'</div><div class="small"><b>Tot Provvigioni '+d(e.provvTot)+"</b></div></div>"}(B)),_()}).catch(function(e){logger.error(e),L("Errore caricamento squadra")})}function w(e,t,n,a){var i=a||f("t"),r=String(i.type||"mensile").toLowerCase(),l="ytd"===r||"ltm"===r?"mensile":r,d=R(r,new Date).map(function(e){return{s:e.s,e:e.e}});function s(e,t){var n=new Date(t.startDate).getTime(),a=new Date(t.endDate).getTime();return n>=e.s&&a<=e.e}function c(e,t){if(!e)return 0;if("VSDTotale"===t)return Number(e.VSDPersonale||0)+Number(e.VSDIndiretto||0);if("ProvvGI"===t)return Number(e.ProvvGI||0);if("ProvvVSD"===t)return Number(e.ProvvVSD||0);if("TotProvvigioni"===t){var n=e.TotProvvigioni;return Number(null!=n?n:Number(e.ProvvGI||0)+Number(e.ProvvVSD||0))}return Number(e[t]||0)}return y("/api/periods?global=1").catch(function(){return y("/api/periods")}).then(function(a){var i=(a&&a.periods||[]).filter(function(e){return e.type===l&&(!n||String(e.userId||e.uid||"")===String(n))});return d.map(function(n){for(var a=0,r=0;r<i.length;r++){var l=i[r];if(s(n,l))a+=c("previsionale"===t?l.indicatorsPrev||{}:l.indicatorsCons||{},o(e))}return{x:new Date(n.s),y:Math.round(100*a)/100}})})}function _(){var e=document.getElementById("t_ind").value,t=document.getElementById("t_mode").value||"consuntivo",n=document.getElementById("t_cons").value||"",a=f("t"),r=a.type,l=o(e);i(),n&&encodeURIComponent(n),encodeURIComponent(l),encodeURIComponent(t),w(l,t,n||null,a).then(function(e){m(e,r)}).catch(function(e){logger.error(e),m([],r)})}g("t",function(){"function"==typeof haptic&&haptic("light"),h()}),document.getElementById("t_mode").onchange=function(){"function"==typeof haptic&&haptic("light"),h()},document.getElementById("t_ind").onchange=function(){"function"==typeof haptic&&haptic("light"),_()},document.getElementById("t_cons").onchange=function(){"function"==typeof haptic&&haptic("light"),_()},h()},window.viewCommissions=function(){if(!u())return l();var e="admin"===u().role;function t(e){return document.getElementById(e)}function n(e){return(Number(e)||0).toLocaleString("it-IT")+"€"}function a(e){return e=Number(null==e?"":e),isFinite(e)?e:0}function i(e,t){return'<div class="card" style="flex:1 1 180px"><div class="small muted">'+V(e)+'</div><div style="font-weight:700; font-size:20px; margin-top:4px">'+t+"</div></div>"}function o(){var o=f("comm"),r=t("comm_mode").value||"consuntivo",l=e?t("comm_user").value||"__all":String(u().id),d=new Date(o.start).getTime(),s=new Date(o.end).getTime();y("/api/periods").then(function(o){var c,v,p=(o&&o.periods||[]).filter(function(t){var n=new Date(t.startDate).getTime(),a=new Date(t.endDate).getTime();return!(n<d||a>s)&&((!e||"__all"===l||String(t.userId||t.uid||"")===String(l))&&!(!e&&String(t.userId||t.uid||"")!==String(u().id)))}),m={gi:0,vsd:0,provv_gi:0,provv_vsd:0,provv_total:0},g={};p.forEach(function(e){var t="previsionale"===r?e.indicatorsPrev||{}:e.indicatorsCons||{},n=String(e.userId||e.uid||""),i=e.userName||e.name||"User "+n,o=a(t.GI),l=a(t.VSDPersonale),d=a(t.ProvvGI),s=a(t.ProvvVSD),c=function(e){return e?null!=e.TotProvvigioni?a(e.TotProvvigioni):a(e.ProvvGI)+a(e.ProvvVSD):0}(t);m.gi+=o,m.vsd+=l,m.provv_gi+=d,m.provv_vsd+=s,m.provv_total+=c,g[n]||(g[n]={userId:n,name:i,gi:0,vsd:0,provv_gi:0,provv_vsd:0,provv_total:0}),g[n].gi+=o,g[n].vsd+=l,g[n].provv_gi+=d,g[n].provv_vsd+=s,g[n].provv_total+=c}),t("comm_total").innerHTML=""+i("VSD personale",n((c=m).vsd||0))+i("GI",n(c.gi||0))+i("Provv. VSD",n(c.provv_vsd||0))+i("Provv. GI",n(c.provv_gi||0))+i("Totale Provvigioni",n(c.provv_total||0)),t("comm_rows").innerHTML=(v=Object.values(g).sort(function(e,t){return(t.provv_total||0)-(e.provv_total||0)})).length?v.map(function(e){return'<div class="card" style="flex:1 1 320px"><div><b>'+V(e.name)+'</b></div><div class="small" style="margin-top:4px">GI '+n(e.gi||0)+" · VSD "+n(e.vsd||0)+'</div><div class="small muted" style="margin-top:2px">Provv. GI '+n(e.provv_gi||0)+" · Provv. VSD "+n(e.provv_vsd||0)+'</div><div class="small" style="margin-top:6px"><b>Totale: '+n(e.provv_total||0)+"</b></div></div>"}).join(""):'<div class="muted">Nessun dato</div>',function(e,t,a){var i=document.getElementById("cm_pie_provv"),o=document.getElementById("cm_pie_legend");if(i&&i.getContext){var r=i.getContext("2d"),l=i.width,d=i.height,s=l/2,c=d/2,u=Math.min(l,d)/2-8;r.clearRect(0,0,l,d);var v=Math.max(0,e||0),p=Math.max(0,t||0),m=v+p,g=a>0?Math.round(m/a*100):null;if(m<=0)return r.beginPath(),r.arc(s,c,u,0,2*Math.PI),r.strokeStyle="#ccd0d5",r.lineWidth=10,r.setLineDash([6,6]),r.stroke(),r.setLineDash([]),r.globalCompositeOperation="destination-out",r.beginPath(),r.arc(s,c,.55*u,0,2*Math.PI),r.fill(),r.globalCompositeOperation="source-over",r.fillStyle="#111",r.textAlign="center",r.textBaseline="middle",r.font="bold 20px system-ui, -apple-system, Segoe UI, Roboto, sans-serif",r.fillText(null==g?"—":g+"%",s,c),void(o&&(o.innerHTML='<div class="muted">Nessuna provvigione nel periodo</div>'));var f=[{label:"Provv. GI",value:v,color:"#4F8EF7"},{label:"Provv. VSD",value:p,color:"#F79F4F"}],b=-Math.PI/2;f.forEach(function(e){var t=e.value/m*Math.PI*2;r.beginPath(),r.moveTo(s,c),r.arc(s,c,u,b,b+t),r.closePath(),r.fillStyle=e.color,r.fill(),b+=t}),r.globalCompositeOperation="destination-out",r.beginPath(),r.arc(s,c,.55*u,0,2*Math.PI),r.fill(),r.globalCompositeOperation="source-over",r.fillStyle="#111",r.textAlign="center",r.textBaseline="middle",r.font="bold 20px system-ui, -apple-system, Segoe UI, Roboto, sans-serif",r.fillText(null==g?"—":g+"%",s,c);var y=Math.round(v/m*100),h=Math.round(p/m*100);o&&(o.innerHTML='<div class="row" style="gap:16px; flex-wrap:wrap"><div class="row" style="gap:8px; align-items:center"><span style="display:inline-block;width:12px;height:12px;background:#4F8EF7;border-radius:3px"></span><span><b>Provv. GI</b> '+n(v)+" · "+y+'%</span></div><div class="row" style="gap:8px; align-items:center"><span style="display:inline-block;width:12px;height:12px;background:#F79F4F;border-radius:3px"></span><span><b>Provv. VSD</b> '+n(p)+" · "+h+"%</span></div></div>")}else o&&(o.innerHTML="")}(m.provv_gi||0,m.provv_vsd||0,m.gi||0)}).catch(function(e){logger.error(e),L("Errore nel caricamento dati")})}document.title="Battle Plan – Provvigioni",r.innerHTML=j()+'<div class="wrap"><div class="card"><b>Calcolo provvigioni</b><div class="row" style="margin-top:8px; gap:12px; flex-wrap:wrap">'+(e?'<div><label>Utente</label><select id="comm_user"><option value="__all">Tutta la squadra</option></select></div>':"")+'<div><label>Modalità</label><select id="comm_mode" name="mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div></div>'+p("comm")+'</div><div class="card"><b>Indicatori periodo</b><div id="comm_total" class="row" style="margin-top:8px; gap:12px; flex-wrap:wrap"></div></div><div class="card"><b>Provvigioni – ripartizione</b><div class="small muted">Confronto tra Provvigioni GI e Provvigioni VSD sul periodo selezionato</div><div class="row" style="margin-top:8px; align-items:center; gap:16px; flex-wrap:wrap"><canvas id="cm_pie_provv" width="260" height="260" style="max-width:260px; max-height:260px"></canvas><div id="cm_pie_legend" class="small"></div></div></div><div class="card"><b>Dettaglio</b><div id="comm_rows" class="row" style="margin-top:8px; gap:12px; flex-wrap:wrap"></div></div></div>',H(),g("comm",function(){o()}),t("comm_mode").onchange=function(){haptic("light"),o()},e&&(t("comm_user").onchange=function(){haptic("light"),o()}),e&&y("/api/usernames").then(function(e){var n=t("comm_user");if(n){for(var a='<option value="__all">Tutta la squadra</option>',i=e&&e.users||[],o=0;o<i.length;o++){var r=i[o];a+='<option value="'+r.id+'">'+V(r.name||"User "+r.id)+"</option>"}n.innerHTML=a}}),o()},window.viewReport=function(){if(!u())return l();document.title="Battle Plan – Report",r.innerHTML=j()+'<div class="wrap"><div class="card"><b>Sezioni da includere</b><div id="rep_toggles" class="row" style="margin-top:8px; gap:8px; flex-wrap:wrap"><button class="pill" data-type="mensile" id="tog_mese">Mese</button><button class="pill" data-type="trimestrale" id="tog_trimestre">Trimestre</button><button class="pill" data-type="semestrale" id="tog_semestre">Semestre</button><button class="pill" data-type="annuale" id="tog_anno">Anno</button></div></div><div class="card"><b>Report</b><div class="row" style="margin-top:8px"><div style="min-width:320px"><label>Oggetto email</label><input id="report_subject" placeholder="Report BP"></div></div><div class="row" style="margin-top:8px; flex-wrap:wrap"><div style="flex:1 1 100%; min-width:0"><label>Corpo email</label><textarea id="report_body" rows="12" placeholder="Testo del report…" style="width:100%; box-sizing:border-box; overflow:auto; resize:vertical; max-height:70vh; white-space:pre-wrap; word-break:break-word"></textarea></div></div><div class="row" id="report-actions" style="gap:8px;margin-top:8px;flex-wrap:wrap"><button class="ghost" id="rep_copy">Copia report</button><span style="flex:0 0 8px"></span><button class="ghost" id="rep_gmail_web">Gmail Web</button><button class="ghost" id="rep_gmail_app">Gmail App</button></div></div></div>',H();var e=[],t={mensile:!1,trimestrale:!1,semestrale:!1,annuale:!1},n=[{k:"VSS",money:!0,label:"VSS"},{k:"VSDPersonale",money:!0,label:"VSDPersonale"},{k:"VSDIndiretto",money:!0,label:"VSDIndiretto"},{k:"GI",money:!0,label:"GI"},{k:"Telefonate",money:!1,label:"Telefonate"},{k:"AppFissati",money:!1,label:"AppFissati"},{k:"AppFatti",money:!1,label:"AppFatti"},{k:"CorsiLeadership",money:!1,label:"CorsiLeadership"},{k:"iProfile",money:!1,label:"iProfile"},{k:"MBS",money:!1,label:"MBS"},{k:"NNCF",money:!1,label:"NNCF"}];function a(e){return document.getElementById(e)}var i=a("report_body");function o(e,t){var n=new Date(e.getTime());return n.setDate(n.getDate()+t),n}function d(e){return M(e.getFullYear(),D(e))}function s(e){return["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"][e.getMonth()]}function c(e){return Math.floor(e.getMonth()/3)+1}function v(e){return e.getMonth()<6?1:2}function p(e,t){return"mensile"===e?{start:S(t),end:I(t)}:"trimestrale"===e?{start:E(t),end:B(t)}:"semestrale"===e?{start:P(t),end:T(t)}:{start:C(t),end:k(t)}}function m(e,t){return t>=o(e,-7)&&t<=o(e,5)}function g(t,n,a){for(var i=0;i<e.length;i++){var o=e[i];if(o.type===t&&(x(o.startDate)===x(n)&&x(o.endDate)===x(a)))return o}return null}function f(e,t){var n=e&&e[t];return Number(n||0)}function b(e,t){return n.some(function(t){return t.k===e&&t.money})?function(e){return U(e)+"€"}(t):U(t)}function h(e,t,a,i){var o=g(t,a,i)||{},r=o.indicatorsPrev||{},l=o.indicatorsCons||{},d=[e,""];return n.forEach(function(e){var t=f(r,e.k),n=f(l,e.k);d.push(e.label+" "+b(e.k,n)+" vs "+b(e.k,t)+" di previsionali ("+function(e,t){return e>t?"↑":e<t?"↓":"="}(n,t)+")")}),d.push("Note:"),d.join("\n")}function w(e,t,a,i){var o=(g(t,a,i)||{}).indicatorsPrev||{},r=[e,""];return n.forEach(function(e){r.push(e.label+" "+b(e.k,f(o,e.k)))}),r.push("Possibili note:"),r.join("\n")}function _(e){return"BP CONSUNTIVO "+s(e)+" "+e.getFullYear()}function N(e){return"BP PREVISIONALE "+s(e)+" "+e.getFullYear()}function A(e){return"BP CONSUNTIVO T"+c(e)+" "+e.getFullYear()}function L(e){return"BP PREVISIONALE T"+c(e)+" "+e.getFullYear()}function F(e){return"BP CONSUNTIVO S"+v(e)+" "+e.getFullYear()}function V(e){return"BP PREVISIONALE S"+v(e)+" "+e.getFullYear()}function O(e){return"BP CONSUNTIVO "+e.getFullYear()}function R(e){return"BP PREVISIONALE "+e.getFullYear()}function G(){var e,n=new Date,a=[];if(function(e){var t=e.getDay();return 5===t||6===t||0===t}(n)){var r=d(n),l=function(e){var t=d(e);return d(o(t.start,7))}(n);a.push(h("BP CONSUNTIVO SETT. "+D(e=r.start)+" "+e.getFullYear(),"settimanale",r.start,r.end)),a.push(w(function(e){return"BP PREVISIONALE SETT. "+D(e)+" "+e.getFullYear()}(l.start),"settimanale",l.start,l.end))}function s(e,t,i){var r=function(e,t){var n=p(e,t),a=p(e,o(n.start,-1)),i=p(e,o(n.end,1)),r=m(a.end,t),l=m(n.end,t);return r&&!l?{closing:a,next:n}:{closing:n,next:i}}(e,n);a.push(h(t(r.closing.start),e,r.closing.start,r.closing.end)),a.push(w(i(r.next.start),e,r.next.start,r.next.end))}t.mensile&&s("mensile",_,N),t.trimestrale&&s("trimestrale",A,L),t.semestrale&&s("semestrale",F,V),t.annuale&&s("annuale",O,R),i.value=a.join("\n\n")+(a.length?"\n":"")}function Y(e,t){e.classList.toggle("active",!!t),e.style.opacity=t?"1":"0.65"}function q(){Y(a("tog_mese"),t.mensile),Y(a("tog_trimestre"),t.trimestrale),Y(a("tog_semestre"),t.semestrale),Y(a("tog_anno"),t.annuale)}function z(e){return encodeURIComponent(String(e||""))}y("/api/periods").then(function(n){var r,l,d;e=n&&n.periods||[],function(){var e=new Date;function n(t){var n=p(t,e),a=p(t,o(n.start,-1));return m(n.end,e)||m(a.end,e)}t.mensile=n("mensile"),t.trimestrale=n("trimestrale"),t.semestrale=n("semestrale"),t.annuale=n("annuale"),q()}(),function(){function e(e){var n=e.currentTarget.getAttribute("data-type");t[n]=!t[n],q(),G()}a("tog_mese").onclick=e,a("tog_trimestre").onclick=e,a("tog_semestre").onclick=e,a("tog_anno").onclick=e}(),G(),r=a("rep_gmail_web"),l=a("rep_gmail_app"),(d=a("rep_copy"))&&(d.onclick=function(){try{navigator.clipboard.writeText(i.value||"");var e=d.textContent;d.textContent="Copiato!",setTimeout(function(){d.textContent=e},1200)}catch(t){}}),r&&l&&y("/api/users_emails").then(function(e){var t=(e&&e.emails||(e&&e.users||[]).map(function(e){return e.email})).filter(Boolean).join(",");function n(){return a("report_subject").value||"Report BP"}function o(){return i.value||""}r.onclick=function(){try{navigator.clipboard.writeText(o())}catch(a){}var e="https://mail.google.com/mail/?view=cm&fs=1&tf=1&su="+z(n())+"&cc="+z(t)+"&body="+z(o());window.open(e,"_blank"),document.dispatchEvent(new Event("report:composed"))},l.onclick=function(){try{navigator.clipboard.writeText(o())}catch(a){}var e="googlegmail:///co?subject="+z(n())+"&cc="+z(t)+"&body="+z(o());location.href=e,document.dispatchEvent(new Event("report:composed")),setTimeout(function(){document.hidden||(location.href="mailto:?subject="+z(n())+"&cc="+z(t)+"&body="+z(o()),document.dispatchEvent(new Event("report:composed")))},1200)}})})},window.viewUsers=function(){var e=u();if(!e)return l();if(document.title="Battle Plan – Utenti","admin"!==e.role)return r.innerHTML=j()+'<div class="wrap"><div class="card"><b>Il mio profilo</b><div class="row" style="margin-top:8px"><div><label>Nome</label><input id="p_name" type="text" value="'+V(e.name||"")+'"></div><div><label>Email</label><input id="p_email" type="email" value="'+V(e.email||"")+'"></div></div><div class="row"><div><label>Nuova password</label><input id="p_pwd" type="password" placeholder="Lascia vuoto per non cambiare"></div><div class="right" style="align-self:flex-end"><button id="p_save">Aggiorna</button></div></div><div class="row"><div><label>Ruolo</label><input value="'+V(e.role||"consultant")+'" disabled></div><div><label>Grade</label><input value="'+V(e.grade||"junior")+'" disabled></div></div></div></div>',H(),void(z("#p_save").onclick=function(){var t=z("#p_name").value.trim(),n=z("#p_email").value.trim(),a=z("#p_pwd").value,i={id:e.id,name:t,email:n};a&&(i.password=a),h("/api/users",i).then(function(){L("Profilo aggiornato"),addXP(3);var e=u();e&&(e.name=t,e.email=n,localStorage.setItem("user",JSON.stringify(e)))}).catch(function(e){logger.error(e),L("Errore aggiornamento")})});function t(e){var t=V(e.name||e.email||"user_"+e.id),n="senior"===e.grade?"senior":"junior",a="admin"===e.role?"admin":"consultant";return'<div class="card" style="flex:1 1 380px"><div><b>'+t+'</b> <span class="small muted">('+V(a)+')</span></div><div class="row" style="margin-top:6px"><div><label>Nome</label><input data-nfor="'+e.id+'" type="text" value="'+V(e.name||"")+'"></div><div><label>Email</label><input data-efor="'+e.id+'" type="email" value="'+V(e.email||"")+'"></div></div><div class="row"><div><label>Nuova password</label><input data-pfor="'+e.id+'" type="password" placeholder="(opzionale)"></div><div><label>Grade</label><select data-gfor="'+e.id+'"><option value="junior"'+("junior"===n?" selected":"")+'>Junior</option><option value="senior"'+("senior"===n?" selected":"")+'>Senior</option></select></div><div><label>Ruolo</label><select data-rfor="'+e.id+'"><option value="consultant"'+("consultant"===a?" selected":"")+'>Consulente</option><option value="admin"'+("admin"===a?" selected":"")+'>Admin</option></select></div><div class="right" style="align-self:flex-end"><button class="ghost" data-save="'+e.id+'">Aggiorna</button></div></div></div>'}r.innerHTML=j()+'<div class="wrap"><div class="card"><b>Gestione utenti</b><div id="users_list" class="row" style="margin-top:8px"></div></div></div>',H(),y("/api/users").then(function(e){var n=e&&e.users||[],a=z("#users_list");a&&(a.innerHTML=n.map(t).join(""),W("[data-save]").forEach(function(e){e.addEventListener("click",function(){var t=e.getAttribute("data-save"),n=(z('input[data-nfor="'+t+'"]')||{}).value||"",a=(z('input[data-efor="'+t+'"]')||{}).value||"",i=(z('select[data-gfor="'+t+'"]')||{}).value||"junior",o=(z('select[data-rfor="'+t+'"]')||{}).value||"consultant",r=z('input[data-pfor="'+t+'"]'),l=r?r.value:"",d={id:t,name:n,email:a,grade:i,role:o};l&&(d.password=l),h("/api/users",d).then(function(){L("Aggiornato"),addXP(5),r&&(r.value="")}).catch(function(e){logger.error(e),L("Errore aggiornamento")})})}))})},window.toggleDrawer=G,window.logout=v,window.rerenderTopbarSoon=q,document.addEventListener("DOMContentLoaded",function(){u()?(H(),Y()):l()})}()}}})}();
