var sl=Object.defineProperty;var rl=(n,t,e)=>t in n?sl(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var St=(n,t,e)=>rl(n,typeof t!="symbol"?t+"":t,e);function Wf(){import.meta.url,import("_").catch(()=>1),(async function*(){})().next()}(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function e(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(o){if(o.ep)return;o.ep=!0;const a=e(o);fetch(o.href,a)}})();/*!
 * @kurkle/color v0.3.4
 * https://github.com/kurkle/color#readme
 * (c) 2024 Jukka Kurkela
 * Released under the MIT License
 */function Ai(n){return n+.5|0}const Sn=(n,t,e)=>Math.max(Math.min(n,e),t);function ui(n){return Sn(Ai(n*2.55),0,255)}function In(n){return Sn(Ai(n*255),0,255)}function gn(n){return Sn(Ai(n/2.55)/100,0,1)}function Ca(n){return Sn(Ai(n*100),0,100)}const Ze={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,A:10,B:11,C:12,D:13,E:14,F:15,a:10,b:11,c:12,d:13,e:14,f:15},Wo=[..."0123456789ABCDEF"],ll=n=>Wo[n&15],cl=n=>Wo[(n&240)>>4]+Wo[n&15],Li=n=>(n&240)>>4===(n&15),dl=n=>Li(n.r)&&Li(n.g)&&Li(n.b)&&Li(n.a);function ul(n){var t=n.length,e;return n[0]==="#"&&(t===4||t===5?e={r:255&Ze[n[1]]*17,g:255&Ze[n[2]]*17,b:255&Ze[n[3]]*17,a:t===5?Ze[n[4]]*17:255}:(t===7||t===9)&&(e={r:Ze[n[1]]<<4|Ze[n[2]],g:Ze[n[3]]<<4|Ze[n[4]],b:Ze[n[5]]<<4|Ze[n[6]],a:t===9?Ze[n[7]]<<4|Ze[n[8]]:255})),e}const pl=(n,t)=>n<255?t(n):"";function fl(n){var t=dl(n)?ll:cl;return n?"#"+t(n.r)+t(n.g)+t(n.b)+pl(n.a,t):void 0}const hl=/^(hsla?|hwb|hsv)\(\s*([-+.e\d]+)(?:deg)?[\s,]+([-+.e\d]+)%[\s,]+([-+.e\d]+)%(?:[\s,]+([-+.e\d]+)(%)?)?\s*\)$/;function Ks(n,t,e){const i=t*Math.min(e,1-e),o=(a,s=(a+n/30)%12)=>e-i*Math.max(Math.min(s-3,9-s,1),-1);return[o(0),o(8),o(4)]}function gl(n,t,e){const i=(o,a=(o+n/60)%6)=>e-e*t*Math.max(Math.min(a,4-a,1),0);return[i(5),i(3),i(1)]}function ml(n,t,e){const i=Ks(n,1,.5);let o;for(t+e>1&&(o=1/(t+e),t*=o,e*=o),o=0;o<3;o++)i[o]*=1-t-e,i[o]+=t;return i}function vl(n,t,e,i,o){return n===o?(t-e)/i+(t<e?6:0):t===o?(e-n)/i+2:(n-t)/i+4}function ra(n){const e=n.r/255,i=n.g/255,o=n.b/255,a=Math.max(e,i,o),s=Math.min(e,i,o),r=(a+s)/2;let l,c,d;return a!==s&&(d=a-s,c=r>.5?d/(2-a-s):d/(a+s),l=vl(e,i,o,d,a),l=l*60+.5),[l|0,c||0,r]}function la(n,t,e,i){return(Array.isArray(t)?n(t[0],t[1],t[2]):n(t,e,i)).map(In)}function ca(n,t,e){return la(Ks,n,t,e)}function bl(n,t,e){return la(ml,n,t,e)}function yl(n,t,e){return la(gl,n,t,e)}function Js(n){return(n%360+360)%360}function xl(n){const t=hl.exec(n);let e=255,i;if(!t)return;t[5]!==i&&(e=t[6]?ui(+t[5]):In(+t[5]));const o=Js(+t[2]),a=+t[3]/100,s=+t[4]/100;return t[1]==="hwb"?i=bl(o,a,s):t[1]==="hsv"?i=yl(o,a,s):i=ca(o,a,s),{r:i[0],g:i[1],b:i[2],a:e}}function wl(n,t){var e=ra(n);e[0]=Js(e[0]+t),e=ca(e),n.r=e[0],n.g=e[1],n.b=e[2]}function _l(n){if(!n)return;const t=ra(n),e=t[0],i=Ca(t[1]),o=Ca(t[2]);return n.a<255?"hsla(".concat(e,", ").concat(i,"%, ").concat(o,"%, ").concat(gn(n.a),")"):"hsl(".concat(e,", ").concat(i,"%, ").concat(o,"%)")}const Ea={x:"dark",Z:"light",Y:"re",X:"blu",W:"gr",V:"medium",U:"slate",A:"ee",T:"ol",S:"or",B:"ra",C:"lateg",D:"ights",R:"in",Q:"turquois",E:"hi",P:"ro",O:"al",N:"le",M:"de",L:"yello",F:"en",K:"ch",G:"arks",H:"ea",I:"ightg",J:"wh"},Ia={OiceXe:"f0f8ff",antiquewEte:"faebd7",aqua:"ffff",aquamarRe:"7fffd4",azuY:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"0",blanKedOmond:"ffebcd",Xe:"ff",XeviTet:"8a2be2",bPwn:"a52a2a",burlywood:"deb887",caMtXe:"5f9ea0",KartYuse:"7fff00",KocTate:"d2691e",cSO:"ff7f50",cSnflowerXe:"6495ed",cSnsilk:"fff8dc",crimson:"dc143c",cyan:"ffff",xXe:"8b",xcyan:"8b8b",xgTMnPd:"b8860b",xWay:"a9a9a9",xgYF:"6400",xgYy:"a9a9a9",xkhaki:"bdb76b",xmagFta:"8b008b",xTivegYF:"556b2f",xSange:"ff8c00",xScEd:"9932cc",xYd:"8b0000",xsOmon:"e9967a",xsHgYF:"8fbc8f",xUXe:"483d8b",xUWay:"2f4f4f",xUgYy:"2f4f4f",xQe:"ced1",xviTet:"9400d3",dAppRk:"ff1493",dApskyXe:"bfff",dimWay:"696969",dimgYy:"696969",dodgerXe:"1e90ff",fiYbrick:"b22222",flSOwEte:"fffaf0",foYstWAn:"228b22",fuKsia:"ff00ff",gaRsbSo:"dcdcdc",ghostwEte:"f8f8ff",gTd:"ffd700",gTMnPd:"daa520",Way:"808080",gYF:"8000",gYFLw:"adff2f",gYy:"808080",honeyMw:"f0fff0",hotpRk:"ff69b4",RdianYd:"cd5c5c",Rdigo:"4b0082",ivSy:"fffff0",khaki:"f0e68c",lavFMr:"e6e6fa",lavFMrXsh:"fff0f5",lawngYF:"7cfc00",NmoncEffon:"fffacd",ZXe:"add8e6",ZcSO:"f08080",Zcyan:"e0ffff",ZgTMnPdLw:"fafad2",ZWay:"d3d3d3",ZgYF:"90ee90",ZgYy:"d3d3d3",ZpRk:"ffb6c1",ZsOmon:"ffa07a",ZsHgYF:"20b2aa",ZskyXe:"87cefa",ZUWay:"778899",ZUgYy:"778899",ZstAlXe:"b0c4de",ZLw:"ffffe0",lime:"ff00",limegYF:"32cd32",lRF:"faf0e6",magFta:"ff00ff",maPon:"800000",VaquamarRe:"66cdaa",VXe:"cd",VScEd:"ba55d3",VpurpN:"9370db",VsHgYF:"3cb371",VUXe:"7b68ee",VsprRggYF:"fa9a",VQe:"48d1cc",VviTetYd:"c71585",midnightXe:"191970",mRtcYam:"f5fffa",mistyPse:"ffe4e1",moccasR:"ffe4b5",navajowEte:"ffdead",navy:"80",Tdlace:"fdf5e6",Tive:"808000",TivedBb:"6b8e23",Sange:"ffa500",SangeYd:"ff4500",ScEd:"da70d6",pOegTMnPd:"eee8aa",pOegYF:"98fb98",pOeQe:"afeeee",pOeviTetYd:"db7093",papayawEp:"ffefd5",pHKpuff:"ffdab9",peru:"cd853f",pRk:"ffc0cb",plum:"dda0dd",powMrXe:"b0e0e6",purpN:"800080",YbeccapurpN:"663399",Yd:"ff0000",Psybrown:"bc8f8f",PyOXe:"4169e1",saddNbPwn:"8b4513",sOmon:"fa8072",sandybPwn:"f4a460",sHgYF:"2e8b57",sHshell:"fff5ee",siFna:"a0522d",silver:"c0c0c0",skyXe:"87ceeb",UXe:"6a5acd",UWay:"708090",UgYy:"708090",snow:"fffafa",sprRggYF:"ff7f",stAlXe:"4682b4",tan:"d2b48c",teO:"8080",tEstN:"d8bfd8",tomato:"ff6347",Qe:"40e0d0",viTet:"ee82ee",JHt:"f5deb3",wEte:"ffffff",wEtesmoke:"f5f5f5",Lw:"ffff00",LwgYF:"9acd32"};function Sl(){const n={},t=Object.keys(Ia),e=Object.keys(Ea);let i,o,a,s,r;for(i=0;i<t.length;i++){for(s=r=t[i],o=0;o<e.length;o++)a=e[o],r=r.replace(a,Ea[a]);a=parseInt(Ia[s],16),n[r]=[a>>16&255,a>>8&255,a&255]}return n}let Oi;function kl(n){Oi||(Oi=Sl(),Oi.transparent=[0,0,0,0]);const t=Oi[n.toLowerCase()];return t&&{r:t[0],g:t[1],b:t[2],a:t.length===4?t[3]:255}}const Cl=/^rgba?\(\s*([-+.\d]+)(%)?[\s,]+([-+.e\d]+)(%)?[\s,]+([-+.e\d]+)(%)?(?:[\s,/]+([-+.e\d]+)(%)?)?\s*\)$/;function El(n){const t=Cl.exec(n);let e=255,i,o,a;if(t){if(t[7]!==i){const s=+t[7];e=t[8]?ui(s):Sn(s*255,0,255)}return i=+t[1],o=+t[3],a=+t[5],i=255&(t[2]?ui(i):Sn(i,0,255)),o=255&(t[4]?ui(o):Sn(o,0,255)),a=255&(t[6]?ui(a):Sn(a,0,255)),{r:i,g:o,b:a,a:e}}}function Il(n){return n&&(n.a<255?"rgba(".concat(n.r,", ").concat(n.g,", ").concat(n.b,", ").concat(gn(n.a),")"):"rgb(".concat(n.r,", ").concat(n.g,", ").concat(n.b,")"))}const To=n=>n<=.0031308?n*12.92:Math.pow(n,1/2.4)*1.055-.055,qn=n=>n<=.04045?n/12.92:Math.pow((n+.055)/1.055,2.4);function Dl(n,t,e){const i=qn(gn(n.r)),o=qn(gn(n.g)),a=qn(gn(n.b));return{r:In(To(i+e*(qn(gn(t.r))-i))),g:In(To(o+e*(qn(gn(t.g))-o))),b:In(To(a+e*(qn(gn(t.b))-a))),a:n.a+e*(t.a-n.a)}}function Ni(n,t,e){if(n){let i=ra(n);i[t]=Math.max(0,Math.min(i[t]+i[t]*e,t===0?360:1)),i=ca(i),n.r=i[0],n.g=i[1],n.b=i[2]}}function Zs(n,t){return n&&Object.assign(t||{},n)}function Da(n){var t={r:0,g:0,b:0,a:255};return Array.isArray(n)?n.length>=3&&(t={r:n[0],g:n[1],b:n[2],a:255},n.length>3&&(t.a=In(n[3]))):(t=Zs(n,{r:0,g:0,b:0,a:1}),t.a=In(t.a)),t}function Tl(n){return n.charAt(0)==="r"?El(n):xl(n)}class ki{constructor(t){if(t instanceof ki)return t;const e=typeof t;let i;e==="object"?i=Da(t):e==="string"&&(i=ul(t)||kl(t)||Tl(t)),this._rgb=i,this._valid=!!i}get valid(){return this._valid}get rgb(){var t=Zs(this._rgb);return t&&(t.a=gn(t.a)),t}set rgb(t){this._rgb=Da(t)}rgbString(){return this._valid?Il(this._rgb):void 0}hexString(){return this._valid?fl(this._rgb):void 0}hslString(){return this._valid?_l(this._rgb):void 0}mix(t,e){if(t){const i=this.rgb,o=t.rgb;let a;const s=e===a?.5:e,r=2*s-1,l=i.a-o.a,c=((r*l===-1?r:(r+l)/(1+r*l))+1)/2;a=1-c,i.r=255&c*i.r+a*o.r+.5,i.g=255&c*i.g+a*o.g+.5,i.b=255&c*i.b+a*o.b+.5,i.a=s*i.a+(1-s)*o.a,this.rgb=i}return this}interpolate(t,e){return t&&(this._rgb=Dl(this._rgb,t._rgb,e)),this}clone(){return new ki(this.rgb)}alpha(t){return this._rgb.a=In(t),this}clearer(t){const e=this._rgb;return e.a*=1-t,this}greyscale(){const t=this._rgb,e=Ai(t.r*.3+t.g*.59+t.b*.11);return t.r=t.g=t.b=e,this}opaquer(t){const e=this._rgb;return e.a*=1+t,this}negate(){const t=this._rgb;return t.r=255-t.r,t.g=255-t.g,t.b=255-t.b,this}lighten(t){return Ni(this._rgb,2,t),this}darken(t){return Ni(this._rgb,2,-t),this}saturate(t){return Ni(this._rgb,1,t),this}desaturate(t){return Ni(this._rgb,1,-t),this}rotate(t){return wl(this._rgb,t),this}}/*!
 * Chart.js v4.5.0
 * https://www.chartjs.org
 * (c) 2025 Chart.js Contributors
 * Released under the MIT License
 */function un(){}const Ml=(()=>{let n=0;return()=>n++})();function ne(n){return n==null}function ve(n){if(Array.isArray&&Array.isArray(n))return!0;const t=Object.prototype.toString.call(n);return t.slice(0,7)==="[object"&&t.slice(-6)==="Array]"}function ie(n){return n!==null&&Object.prototype.toString.call(n)==="[object Object]"}function _e(n){return(typeof n=="number"||n instanceof Number)&&isFinite(+n)}function Xe(n,t){return _e(n)?n:t}function Xt(n,t){return typeof n>"u"?t:n}const Pl=(n,t)=>typeof n=="string"&&n.endsWith("%")?parseFloat(n)/100:+n/t,Qs=(n,t)=>typeof n=="string"&&n.endsWith("%")?parseFloat(n)/100*t:+n;function ge(n,t,e){if(n&&typeof n.call=="function")return n.apply(e,t)}function fe(n,t,e,i){let o,a,s;if(ve(n))for(a=n.length,o=0;o<a;o++)t.call(e,n[o],o);else if(ie(n))for(s=Object.keys(n),a=s.length,o=0;o<a;o++)t.call(e,n[s[o]],s[o])}function lo(n,t){let e,i,o,a;if(!n||!t||n.length!==t.length)return!1;for(e=0,i=n.length;e<i;++e)if(o=n[e],a=t[e],o.datasetIndex!==a.datasetIndex||o.index!==a.index)return!1;return!0}function co(n){if(ve(n))return n.map(co);if(ie(n)){const t=Object.create(null),e=Object.keys(n),i=e.length;let o=0;for(;o<i;++o)t[e[o]]=co(n[e[o]]);return t}return n}function tr(n){return["__proto__","prototype","constructor"].indexOf(n)===-1}function Al(n,t,e,i){if(!tr(n))return;const o=t[n],a=e[n];ie(o)&&ie(a)?Ci(o,a,i):t[n]=co(a)}function Ci(n,t,e){const i=ve(t)?t:[t],o=i.length;if(!ie(n))return n;e=e||{};const a=e.merger||Al;let s;for(let r=0;r<o;++r){if(s=i[r],!ie(s))continue;const l=Object.keys(s);for(let c=0,d=l.length;c<d;++c)a(l[c],n,s,e)}return n}function yi(n,t){return Ci(n,t,{merger:Bl})}function Bl(n,t,e){if(!tr(n))return;const i=t[n],o=e[n];ie(i)&&ie(o)?yi(i,o):Object.prototype.hasOwnProperty.call(t,n)||(t[n]=co(o))}const Ta={"":n=>n,x:n=>n.x,y:n=>n.y};function Ll(n){const t=n.split("."),e=[];let i="";for(const o of t)i+=o,i.endsWith("\\")?i=i.slice(0,-1)+".":(e.push(i),i="");return e}function Ol(n){const t=Ll(n);return e=>{for(const i of t){if(i==="")break;e=e&&e[i]}return e}}function Dn(n,t){return(Ta[t]||(Ta[t]=Ol(t)))(n)}function da(n){return n.charAt(0).toUpperCase()+n.slice(1)}const Ei=n=>typeof n<"u",Tn=n=>typeof n=="function",Ma=(n,t)=>{if(n.size!==t.size)return!1;for(const e of n)if(!t.has(e))return!1;return!0};function Nl(n){return n.type==="mouseup"||n.type==="click"||n.type==="contextmenu"}const de=Math.PI,me=2*de,Fl=me+de,uo=Number.POSITIVE_INFINITY,Rl=de/180,ke=de/2,An=de/4,Pa=de*2/3,kn=Math.log10,ln=Math.sign;function xi(n,t,e){return Math.abs(n-t)<e}function Aa(n){const t=Math.round(n);n=xi(n,t,n/1e3)?t:n;const e=Math.pow(10,Math.floor(kn(n))),i=n/e;return(i<=1?1:i<=2?2:i<=5?5:10)*e}function zl(n){const t=[],e=Math.sqrt(n);let i;for(i=1;i<e;i++)n%i===0&&(t.push(i),t.push(n/i));return e===(e|0)&&t.push(e),t.sort((o,a)=>o-a).pop(),t}function Vl(n){return typeof n=="symbol"||typeof n=="object"&&n!==null&&!(Symbol.toPrimitive in n||"toString"in n||"valueOf"in n)}function Qn(n){return!Vl(n)&&!isNaN(parseFloat(n))&&isFinite(n)}function Ul(n,t){const e=Math.round(n);return e-t<=n&&e+t>=n}function er(n,t,e){let i,o,a;for(i=0,o=n.length;i<o;i++)a=n[i][e],isNaN(a)||(t.min=Math.min(t.min,a),t.max=Math.max(t.max,a))}function Qe(n){return n*(de/180)}function ua(n){return n*(180/de)}function Ba(n){if(!_e(n))return;let t=1,e=0;for(;Math.round(n*t)/t!==n;)t*=10,e++;return e}function nr(n,t){const e=t.x-n.x,i=t.y-n.y,o=Math.sqrt(e*e+i*i);let a=Math.atan2(i,e);return a<-.5*de&&(a+=me),{angle:a,distance:o}}function Yo(n,t){return Math.sqrt(Math.pow(t.x-n.x,2)+Math.pow(t.y-n.y,2))}function Hl(n,t){return(n-t+Fl)%me-de}function Fe(n){return(n%me+me)%me}function Ii(n,t,e,i){const o=Fe(n),a=Fe(t),s=Fe(e),r=Fe(a-o),l=Fe(s-o),c=Fe(o-a),d=Fe(o-s);return o===a||o===s||i&&a===s||r>l&&c<d}function Ae(n,t,e){return Math.max(t,Math.min(e,n))}function jl(n){return Ae(n,-32768,32767)}function vn(n,t,e,i=1e-6){return n>=Math.min(t,e)-i&&n<=Math.max(t,e)+i}function pa(n,t,e){e=e||(s=>n[s]<t);let i=n.length-1,o=0,a;for(;i-o>1;)a=o+i>>1,e(a)?o=a:i=a;return{lo:o,hi:i}}const bn=(n,t,e,i)=>pa(n,e,i?o=>{const a=n[o][t];return a<e||a===e&&n[o+1][t]===e}:o=>n[o][t]<e),Wl=(n,t,e)=>pa(n,e,i=>n[i][t]>=e);function Yl(n,t,e){let i=0,o=n.length;for(;i<o&&n[i]<t;)i++;for(;o>i&&n[o-1]>e;)o--;return i>0||o<n.length?n.slice(i,o):n}const ir=["push","pop","shift","splice","unshift"];function $l(n,t){if(n._chartjs){n._chartjs.listeners.push(t);return}Object.defineProperty(n,"_chartjs",{configurable:!0,enumerable:!1,value:{listeners:[t]}}),ir.forEach(e=>{const i="_onData"+da(e),o=n[e];Object.defineProperty(n,e,{configurable:!0,enumerable:!1,value(...a){const s=o.apply(this,a);return n._chartjs.listeners.forEach(r=>{typeof r[i]=="function"&&r[i](...a)}),s}})})}function La(n,t){const e=n._chartjs;if(!e)return;const i=e.listeners,o=i.indexOf(t);o!==-1&&i.splice(o,1),!(i.length>0)&&(ir.forEach(a=>{delete n[a]}),delete n._chartjs)}function or(n){const t=new Set(n);return t.size===n.length?n:Array.from(t)}const ar=(function(){return typeof window>"u"?function(n){return n()}:window.requestAnimationFrame})();function sr(n,t){let e=[],i=!1;return function(...o){e=o,i||(i=!0,ar.call(window,()=>{i=!1,n.apply(t,e)}))}}function ql(n,t){let e;return function(...i){return t?(clearTimeout(e),e=setTimeout(n,t,i)):n.apply(this,i),t}}const fa=n=>n==="start"?"left":n==="end"?"right":"center",Ne=(n,t,e)=>n==="start"?t:n==="end"?e:(t+e)/2,Gl=(n,t,e,i)=>n===(i?"left":"right")?e:n==="center"?(t+e)/2:t;function rr(n,t,e){const i=t.length;let o=0,a=i;if(n._sorted){const{iScale:s,vScale:r,_parsed:l}=n,c=n.dataset&&n.dataset.options?n.dataset.options.spanGaps:null,d=s.axis,{min:u,max:p,minDefined:f,maxDefined:b}=s.getUserBounds();if(f){if(o=Math.min(bn(l,d,u).lo,e?i:bn(t,d,s.getPixelForValue(u)).lo),c){const v=l.slice(0,o+1).reverse().findIndex(y=>!ne(y[r.axis]));o-=Math.max(0,v)}o=Ae(o,0,i-1)}if(b){let v=Math.max(bn(l,s.axis,p,!0).hi+1,e?0:bn(t,d,s.getPixelForValue(p),!0).hi+1);if(c){const y=l.slice(v-1).findIndex(E=>!ne(E[r.axis]));v+=Math.max(0,y)}a=Ae(v,o,i)-o}else a=i-o}return{start:o,count:a}}function lr(n){const{xScale:t,yScale:e,_scaleRanges:i}=n,o={xmin:t.min,xmax:t.max,ymin:e.min,ymax:e.max};if(!i)return n._scaleRanges=o,!0;const a=i.xmin!==t.min||i.xmax!==t.max||i.ymin!==e.min||i.ymax!==e.max;return Object.assign(i,o),a}const Fi=n=>n===0||n===1,Oa=(n,t,e)=>-(Math.pow(2,10*(n-=1))*Math.sin((n-t)*me/e)),Na=(n,t,e)=>Math.pow(2,-10*n)*Math.sin((n-t)*me/e)+1,wi={linear:n=>n,easeInQuad:n=>n*n,easeOutQuad:n=>-n*(n-2),easeInOutQuad:n=>(n/=.5)<1?.5*n*n:-.5*(--n*(n-2)-1),easeInCubic:n=>n*n*n,easeOutCubic:n=>(n-=1)*n*n+1,easeInOutCubic:n=>(n/=.5)<1?.5*n*n*n:.5*((n-=2)*n*n+2),easeInQuart:n=>n*n*n*n,easeOutQuart:n=>-((n-=1)*n*n*n-1),easeInOutQuart:n=>(n/=.5)<1?.5*n*n*n*n:-.5*((n-=2)*n*n*n-2),easeInQuint:n=>n*n*n*n*n,easeOutQuint:n=>(n-=1)*n*n*n*n+1,easeInOutQuint:n=>(n/=.5)<1?.5*n*n*n*n*n:.5*((n-=2)*n*n*n*n+2),easeInSine:n=>-Math.cos(n*ke)+1,easeOutSine:n=>Math.sin(n*ke),easeInOutSine:n=>-.5*(Math.cos(de*n)-1),easeInExpo:n=>n===0?0:Math.pow(2,10*(n-1)),easeOutExpo:n=>n===1?1:-Math.pow(2,-10*n)+1,easeInOutExpo:n=>Fi(n)?n:n<.5?.5*Math.pow(2,10*(n*2-1)):.5*(-Math.pow(2,-10*(n*2-1))+2),easeInCirc:n=>n>=1?n:-(Math.sqrt(1-n*n)-1),easeOutCirc:n=>Math.sqrt(1-(n-=1)*n),easeInOutCirc:n=>(n/=.5)<1?-.5*(Math.sqrt(1-n*n)-1):.5*(Math.sqrt(1-(n-=2)*n)+1),easeInElastic:n=>Fi(n)?n:Oa(n,.075,.3),easeOutElastic:n=>Fi(n)?n:Na(n,.075,.3),easeInOutElastic(n){return Fi(n)?n:n<.5?.5*Oa(n*2,.1125,.45):.5+.5*Na(n*2-1,.1125,.45)},easeInBack(n){return n*n*((1.70158+1)*n-1.70158)},easeOutBack(n){return(n-=1)*n*((1.70158+1)*n+1.70158)+1},easeInOutBack(n){let t=1.70158;return(n/=.5)<1?.5*(n*n*(((t*=1.525)+1)*n-t)):.5*((n-=2)*n*(((t*=1.525)+1)*n+t)+2)},easeInBounce:n=>1-wi.easeOutBounce(1-n),easeOutBounce(n){return n<1/2.75?7.5625*n*n:n<2/2.75?7.5625*(n-=1.5/2.75)*n+.75:n<2.5/2.75?7.5625*(n-=2.25/2.75)*n+.9375:7.5625*(n-=2.625/2.75)*n+.984375},easeInOutBounce:n=>n<.5?wi.easeInBounce(n*2)*.5:wi.easeOutBounce(n*2-1)*.5+.5};function ha(n){if(n&&typeof n=="object"){const t=n.toString();return t==="[object CanvasPattern]"||t==="[object CanvasGradient]"}return!1}function Fa(n){return ha(n)?n:new ki(n)}function Mo(n){return ha(n)?n:new ki(n).saturate(.5).darken(.1).hexString()}const Xl=["x","y","borderWidth","radius","tension"],Kl=["color","borderColor","backgroundColor"];function Jl(n){n.set("animation",{delay:void 0,duration:1e3,easing:"easeOutQuart",fn:void 0,from:void 0,loop:void 0,to:void 0,type:void 0}),n.describe("animation",{_fallback:!1,_indexable:!1,_scriptable:t=>t!=="onProgress"&&t!=="onComplete"&&t!=="fn"}),n.set("animations",{colors:{type:"color",properties:Kl},numbers:{type:"number",properties:Xl}}),n.describe("animations",{_fallback:"animation"}),n.set("transitions",{active:{animation:{duration:400}},resize:{animation:{duration:0}},show:{animations:{colors:{from:"transparent"},visible:{type:"boolean",duration:0}}},hide:{animations:{colors:{to:"transparent"},visible:{type:"boolean",easing:"linear",fn:t=>t|0}}}})}function Zl(n){n.set("layout",{autoPadding:!0,padding:{top:0,right:0,bottom:0,left:0}})}const Ra=new Map;function Ql(n,t){t=t||{};const e=n+JSON.stringify(t);let i=Ra.get(e);return i||(i=new Intl.NumberFormat(n,t),Ra.set(e,i)),i}function Bi(n,t,e){return Ql(t,e).format(n)}const cr={values(n){return ve(n)?n:""+n},numeric(n,t,e){if(n===0)return"0";const i=this.chart.options.locale;let o,a=n;if(e.length>1){const c=Math.max(Math.abs(e[0].value),Math.abs(e[e.length-1].value));(c<1e-4||c>1e15)&&(o="scientific"),a=tc(n,e)}const s=kn(Math.abs(a)),r=isNaN(s)?1:Math.max(Math.min(-1*Math.floor(s),20),0),l={notation:o,minimumFractionDigits:r,maximumFractionDigits:r};return Object.assign(l,this.options.ticks.format),Bi(n,i,l)},logarithmic(n,t,e){if(n===0)return"0";const i=e[t].significand||n/Math.pow(10,Math.floor(kn(n)));return[1,2,3,5,10,15].includes(i)||t>.8*e.length?cr.numeric.call(this,n,t,e):""}};function tc(n,t){let e=t.length>3?t[2].value-t[1].value:t[1].value-t[0].value;return Math.abs(e)>=1&&n!==Math.floor(n)&&(e=n-Math.floor(n)),e}var yo={formatters:cr};function ec(n){n.set("scale",{display:!0,offset:!1,reverse:!1,beginAtZero:!1,bounds:"ticks",clip:!0,grace:0,grid:{display:!0,lineWidth:1,drawOnChartArea:!0,drawTicks:!0,tickLength:8,tickWidth:(t,e)=>e.lineWidth,tickColor:(t,e)=>e.color,offset:!1},border:{display:!0,dash:[],dashOffset:0,width:1},title:{display:!1,text:"",padding:{top:4,bottom:4}},ticks:{minRotation:0,maxRotation:50,mirror:!1,textStrokeWidth:0,textStrokeColor:"",padding:3,display:!0,autoSkip:!0,autoSkipPadding:3,labelOffset:0,callback:yo.formatters.values,minor:{},major:{},align:"center",crossAlign:"near",showLabelBackdrop:!1,backdropColor:"rgba(255, 255, 255, 0.75)",backdropPadding:2}}),n.route("scale.ticks","color","","color"),n.route("scale.grid","color","","borderColor"),n.route("scale.border","color","","borderColor"),n.route("scale.title","color","","color"),n.describe("scale",{_fallback:!1,_scriptable:t=>!t.startsWith("before")&&!t.startsWith("after")&&t!=="callback"&&t!=="parser",_indexable:t=>t!=="borderDash"&&t!=="tickBorderDash"&&t!=="dash"}),n.describe("scales",{_fallback:"scale"}),n.describe("scale.ticks",{_scriptable:t=>t!=="backdropPadding"&&t!=="callback",_indexable:t=>t!=="backdropPadding"})}const Hn=Object.create(null),$o=Object.create(null);function _i(n,t){if(!t)return n;const e=t.split(".");for(let i=0,o=e.length;i<o;++i){const a=e[i];n=n[a]||(n[a]=Object.create(null))}return n}function Po(n,t,e){return typeof t=="string"?Ci(_i(n,t),e):Ci(_i(n,""),t)}class nc{constructor(t,e){this.animation=void 0,this.backgroundColor="rgba(0,0,0,0.1)",this.borderColor="rgba(0,0,0,0.1)",this.color="#666",this.datasets={},this.devicePixelRatio=i=>i.chart.platform.getDevicePixelRatio(),this.elements={},this.events=["mousemove","mouseout","click","touchstart","touchmove"],this.font={family:"'Helvetica Neue', 'Helvetica', 'Arial', sans-serif",size:12,style:"normal",lineHeight:1.2,weight:null},this.hover={},this.hoverBackgroundColor=(i,o)=>Mo(o.backgroundColor),this.hoverBorderColor=(i,o)=>Mo(o.borderColor),this.hoverColor=(i,o)=>Mo(o.color),this.indexAxis="x",this.interaction={mode:"nearest",intersect:!0,includeInvisible:!1},this.maintainAspectRatio=!0,this.onHover=null,this.onClick=null,this.parsing=!0,this.plugins={},this.responsive=!0,this.scale=void 0,this.scales={},this.showLine=!0,this.drawActiveElementsOnTop=!0,this.describe(t),this.apply(e)}set(t,e){return Po(this,t,e)}get(t){return _i(this,t)}describe(t,e){return Po($o,t,e)}override(t,e){return Po(Hn,t,e)}route(t,e,i,o){const a=_i(this,t),s=_i(this,i),r="_"+e;Object.defineProperties(a,{[r]:{value:a[e],writable:!0},[e]:{enumerable:!0,get(){const l=this[r],c=s[o];return ie(l)?Object.assign({},c,l):Xt(l,c)},set(l){this[r]=l}}})}apply(t){t.forEach(e=>e(this))}}var be=new nc({_scriptable:n=>!n.startsWith("on"),_indexable:n=>n!=="events",hover:{_fallback:"interaction"},interaction:{_scriptable:!1,_indexable:!1}},[Jl,Zl,ec]);function ic(n){return!n||ne(n.size)||ne(n.family)?null:(n.style?n.style+" ":"")+(n.weight?n.weight+" ":"")+n.size+"px "+n.family}function po(n,t,e,i,o){let a=t[o];return a||(a=t[o]=n.measureText(o).width,e.push(o)),a>i&&(i=a),i}function oc(n,t,e,i){i=i||{};let o=i.data=i.data||{},a=i.garbageCollect=i.garbageCollect||[];i.font!==t&&(o=i.data={},a=i.garbageCollect=[],i.font=t),n.save(),n.font=t;let s=0;const r=e.length;let l,c,d,u,p;for(l=0;l<r;l++)if(u=e[l],u!=null&&!ve(u))s=po(n,o,a,s,u);else if(ve(u))for(c=0,d=u.length;c<d;c++)p=u[c],p!=null&&!ve(p)&&(s=po(n,o,a,s,p));n.restore();const f=a.length/2;if(f>e.length){for(l=0;l<f;l++)delete o[a[l]];a.splice(0,f)}return s}function Bn(n,t,e){const i=n.currentDevicePixelRatio,o=e!==0?Math.max(e/2,.5):0;return Math.round((t-o)*i)/i+o}function za(n,t){!t&&!n||(t=t||n.getContext("2d"),t.save(),t.resetTransform(),t.clearRect(0,0,n.width,n.height),t.restore())}function qo(n,t,e,i){dr(n,t,e,i,null)}function dr(n,t,e,i,o){let a,s,r,l,c,d,u,p;const f=t.pointStyle,b=t.rotation,v=t.radius;let y=(b||0)*Rl;if(f&&typeof f=="object"&&(a=f.toString(),a==="[object HTMLImageElement]"||a==="[object HTMLCanvasElement]")){n.save(),n.translate(e,i),n.rotate(y),n.drawImage(f,-f.width/2,-f.height/2,f.width,f.height),n.restore();return}if(!(isNaN(v)||v<=0)){switch(n.beginPath(),f){default:o?n.ellipse(e,i,o/2,v,0,0,me):n.arc(e,i,v,0,me),n.closePath();break;case"triangle":d=o?o/2:v,n.moveTo(e+Math.sin(y)*d,i-Math.cos(y)*v),y+=Pa,n.lineTo(e+Math.sin(y)*d,i-Math.cos(y)*v),y+=Pa,n.lineTo(e+Math.sin(y)*d,i-Math.cos(y)*v),n.closePath();break;case"rectRounded":c=v*.516,l=v-c,s=Math.cos(y+An)*l,u=Math.cos(y+An)*(o?o/2-c:l),r=Math.sin(y+An)*l,p=Math.sin(y+An)*(o?o/2-c:l),n.arc(e-u,i-r,c,y-de,y-ke),n.arc(e+p,i-s,c,y-ke,y),n.arc(e+u,i+r,c,y,y+ke),n.arc(e-p,i+s,c,y+ke,y+de),n.closePath();break;case"rect":if(!b){l=Math.SQRT1_2*v,d=o?o/2:l,n.rect(e-d,i-l,2*d,2*l);break}y+=An;case"rectRot":u=Math.cos(y)*(o?o/2:v),s=Math.cos(y)*v,r=Math.sin(y)*v,p=Math.sin(y)*(o?o/2:v),n.moveTo(e-u,i-r),n.lineTo(e+p,i-s),n.lineTo(e+u,i+r),n.lineTo(e-p,i+s),n.closePath();break;case"crossRot":y+=An;case"cross":u=Math.cos(y)*(o?o/2:v),s=Math.cos(y)*v,r=Math.sin(y)*v,p=Math.sin(y)*(o?o/2:v),n.moveTo(e-u,i-r),n.lineTo(e+u,i+r),n.moveTo(e+p,i-s),n.lineTo(e-p,i+s);break;case"star":u=Math.cos(y)*(o?o/2:v),s=Math.cos(y)*v,r=Math.sin(y)*v,p=Math.sin(y)*(o?o/2:v),n.moveTo(e-u,i-r),n.lineTo(e+u,i+r),n.moveTo(e+p,i-s),n.lineTo(e-p,i+s),y+=An,u=Math.cos(y)*(o?o/2:v),s=Math.cos(y)*v,r=Math.sin(y)*v,p=Math.sin(y)*(o?o/2:v),n.moveTo(e-u,i-r),n.lineTo(e+u,i+r),n.moveTo(e+p,i-s),n.lineTo(e-p,i+s);break;case"line":s=o?o/2:Math.cos(y)*v,r=Math.sin(y)*v,n.moveTo(e-s,i-r),n.lineTo(e+s,i+r);break;case"dash":n.moveTo(e,i),n.lineTo(e+Math.cos(y)*(o?o/2:v),i+Math.sin(y)*v);break;case!1:n.closePath();break}n.fill(),t.borderWidth>0&&n.stroke()}}function yn(n,t,e){return e=e||.5,!t||n&&n.x>t.left-e&&n.x<t.right+e&&n.y>t.top-e&&n.y<t.bottom+e}function xo(n,t){n.save(),n.beginPath(),n.rect(t.left,t.top,t.right-t.left,t.bottom-t.top),n.clip()}function wo(n){n.restore()}function ac(n,t,e,i,o){if(!t)return n.lineTo(e.x,e.y);if(o==="middle"){const a=(t.x+e.x)/2;n.lineTo(a,t.y),n.lineTo(a,e.y)}else o==="after"!=!!i?n.lineTo(t.x,e.y):n.lineTo(e.x,t.y);n.lineTo(e.x,e.y)}function sc(n,t,e,i){if(!t)return n.lineTo(e.x,e.y);n.bezierCurveTo(i?t.cp1x:t.cp2x,i?t.cp1y:t.cp2y,i?e.cp2x:e.cp1x,i?e.cp2y:e.cp1y,e.x,e.y)}function rc(n,t){t.translation&&n.translate(t.translation[0],t.translation[1]),ne(t.rotation)||n.rotate(t.rotation),t.color&&(n.fillStyle=t.color),t.textAlign&&(n.textAlign=t.textAlign),t.textBaseline&&(n.textBaseline=t.textBaseline)}function lc(n,t,e,i,o){if(o.strikethrough||o.underline){const a=n.measureText(i),s=t-a.actualBoundingBoxLeft,r=t+a.actualBoundingBoxRight,l=e-a.actualBoundingBoxAscent,c=e+a.actualBoundingBoxDescent,d=o.strikethrough?(l+c)/2:c;n.strokeStyle=n.fillStyle,n.beginPath(),n.lineWidth=o.decorationWidth||2,n.moveTo(s,d),n.lineTo(r,d),n.stroke()}}function cc(n,t){const e=n.fillStyle;n.fillStyle=t.color,n.fillRect(t.left,t.top,t.width,t.height),n.fillStyle=e}function jn(n,t,e,i,o,a={}){const s=ve(t)?t:[t],r=a.strokeWidth>0&&a.strokeColor!=="";let l,c;for(n.save(),n.font=o.string,rc(n,a),l=0;l<s.length;++l)c=s[l],a.backdrop&&cc(n,a.backdrop),r&&(a.strokeColor&&(n.strokeStyle=a.strokeColor),ne(a.strokeWidth)||(n.lineWidth=a.strokeWidth),n.strokeText(c,e,i,a.maxWidth)),n.fillText(c,e,i,a.maxWidth),lc(n,e,i,c,a),i+=Number(o.lineHeight);n.restore()}function Di(n,t){const{x:e,y:i,w:o,h:a,radius:s}=t;n.arc(e+s.topLeft,i+s.topLeft,s.topLeft,1.5*de,de,!0),n.lineTo(e,i+a-s.bottomLeft),n.arc(e+s.bottomLeft,i+a-s.bottomLeft,s.bottomLeft,de,ke,!0),n.lineTo(e+o-s.bottomRight,i+a),n.arc(e+o-s.bottomRight,i+a-s.bottomRight,s.bottomRight,ke,0,!0),n.lineTo(e+o,i+s.topRight),n.arc(e+o-s.topRight,i+s.topRight,s.topRight,0,-ke,!0),n.lineTo(e+s.topLeft,i)}const dc=/^(normal|(\d+(?:\.\d+)?)(px|em|%)?)$/,uc=/^(normal|italic|initial|inherit|unset|(oblique( -?[0-9]?[0-9]deg)?))$/;function pc(n,t){const e=(""+n).match(dc);if(!e||e[1]==="normal")return t*1.2;switch(n=+e[2],e[3]){case"px":return n;case"%":n/=100;break}return t*n}const fc=n=>+n||0;function ga(n,t){const e={},i=ie(t),o=i?Object.keys(t):t,a=ie(n)?i?s=>Xt(n[s],n[t[s]]):s=>n[s]:()=>n;for(const s of o)e[s]=fc(a(s));return e}function ur(n){return ga(n,{top:"y",right:"x",bottom:"y",left:"x"})}function Vn(n){return ga(n,["topLeft","topRight","bottomLeft","bottomRight"])}function ze(n){const t=ur(n);return t.width=t.left+t.right,t.height=t.top+t.bottom,t}function Me(n,t){n=n||{},t=t||be.font;let e=Xt(n.size,t.size);typeof e=="string"&&(e=parseInt(e,10));let i=Xt(n.style,t.style);i&&!(""+i).match(uc)&&(console.warn('Invalid font style specified: "'+i+'"'),i=void 0);const o={family:Xt(n.family,t.family),lineHeight:pc(Xt(n.lineHeight,t.lineHeight),e),size:e,style:i,weight:Xt(n.weight,t.weight),string:""};return o.string=ic(o),o}function pi(n,t,e,i){let o,a,s;for(o=0,a=n.length;o<a;++o)if(s=n[o],s!==void 0&&s!==void 0)return s}function hc(n,t,e){const{min:i,max:o}=n,a=Qs(t,(o-i)/2),s=(r,l)=>e&&r===0?0:r+l;return{min:s(i,-Math.abs(a)),max:s(o,a)}}function Mn(n,t){return Object.assign(Object.create(n),t)}function ma(n,t=[""],e,i,o=()=>n[0]){const a=e||n;typeof i>"u"&&(i=gr("_fallback",n));const s={[Symbol.toStringTag]:"Object",_cacheable:!0,_scopes:n,_rootScopes:a,_fallback:i,_getTarget:o,override:r=>ma([r,...n],t,a,i)};return new Proxy(s,{deleteProperty(r,l){return delete r[l],delete r._keys,delete n[0][l],!0},get(r,l){return fr(r,l,()=>_c(l,t,n,r))},getOwnPropertyDescriptor(r,l){return Reflect.getOwnPropertyDescriptor(r._scopes[0],l)},getPrototypeOf(){return Reflect.getPrototypeOf(n[0])},has(r,l){return Ua(r).includes(l)},ownKeys(r){return Ua(r)},set(r,l,c){const d=r._storage||(r._storage=o());return r[l]=d[l]=c,delete r._keys,!0}})}function ti(n,t,e,i){const o={_cacheable:!1,_proxy:n,_context:t,_subProxy:e,_stack:new Set,_descriptors:pr(n,i),setContext:a=>ti(n,a,e,i),override:a=>ti(n.override(a),t,e,i)};return new Proxy(o,{deleteProperty(a,s){return delete a[s],delete n[s],!0},get(a,s,r){return fr(a,s,()=>mc(a,s,r))},getOwnPropertyDescriptor(a,s){return a._descriptors.allKeys?Reflect.has(n,s)?{enumerable:!0,configurable:!0}:void 0:Reflect.getOwnPropertyDescriptor(n,s)},getPrototypeOf(){return Reflect.getPrototypeOf(n)},has(a,s){return Reflect.has(n,s)},ownKeys(){return Reflect.ownKeys(n)},set(a,s,r){return n[s]=r,delete a[s],!0}})}function pr(n,t={scriptable:!0,indexable:!0}){const{_scriptable:e=t.scriptable,_indexable:i=t.indexable,_allKeys:o=t.allKeys}=n;return{allKeys:o,scriptable:e,indexable:i,isScriptable:Tn(e)?e:()=>e,isIndexable:Tn(i)?i:()=>i}}const gc=(n,t)=>n?n+da(t):t,va=(n,t)=>ie(t)&&n!=="adapters"&&(Object.getPrototypeOf(t)===null||t.constructor===Object);function fr(n,t,e){if(Object.prototype.hasOwnProperty.call(n,t)||t==="constructor")return n[t];const i=e();return n[t]=i,i}function mc(n,t,e){const{_proxy:i,_context:o,_subProxy:a,_descriptors:s}=n;let r=i[t];return Tn(r)&&s.isScriptable(t)&&(r=vc(t,r,n,e)),ve(r)&&r.length&&(r=bc(t,r,n,s.isIndexable)),va(t,r)&&(r=ti(r,o,a&&a[t],s)),r}function vc(n,t,e,i){const{_proxy:o,_context:a,_subProxy:s,_stack:r}=e;if(r.has(n))throw new Error("Recursion detected: "+Array.from(r).join("->")+"->"+n);r.add(n);let l=t(a,s||i);return r.delete(n),va(n,l)&&(l=ba(o._scopes,o,n,l)),l}function bc(n,t,e,i){const{_proxy:o,_context:a,_subProxy:s,_descriptors:r}=e;if(typeof a.index<"u"&&i(n))return t[a.index%t.length];if(ie(t[0])){const l=t,c=o._scopes.filter(d=>d!==l);t=[];for(const d of l){const u=ba(c,o,n,d);t.push(ti(u,a,s&&s[n],r))}}return t}function hr(n,t,e){return Tn(n)?n(t,e):n}const yc=(n,t)=>n===!0?t:typeof n=="string"?Dn(t,n):void 0;function xc(n,t,e,i,o){for(const a of t){const s=yc(e,a);if(s){n.add(s);const r=hr(s._fallback,e,o);if(typeof r<"u"&&r!==e&&r!==i)return r}else if(s===!1&&typeof i<"u"&&e!==i)return null}return!1}function ba(n,t,e,i){const o=t._rootScopes,a=hr(t._fallback,e,i),s=[...n,...o],r=new Set;r.add(i);let l=Va(r,s,e,a||e,i);return l===null||typeof a<"u"&&a!==e&&(l=Va(r,s,a,l,i),l===null)?!1:ma(Array.from(r),[""],o,a,()=>wc(t,e,i))}function Va(n,t,e,i,o){for(;e;)e=xc(n,t,e,i,o);return e}function wc(n,t,e){const i=n._getTarget();t in i||(i[t]={});const o=i[t];return ve(o)&&ie(e)?e:o||{}}function _c(n,t,e,i){let o;for(const a of t)if(o=gr(gc(a,n),e),typeof o<"u")return va(n,o)?ba(e,i,n,o):o}function gr(n,t){for(const e of t){if(!e)continue;const i=e[n];if(typeof i<"u")return i}}function Ua(n){let t=n._keys;return t||(t=n._keys=Sc(n._scopes)),t}function Sc(n){const t=new Set;for(const e of n)for(const i of Object.keys(e).filter(o=>!o.startsWith("_")))t.add(i);return Array.from(t)}function mr(n,t,e,i){const{iScale:o}=n,{key:a="r"}=this._parsing,s=new Array(i);let r,l,c,d;for(r=0,l=i;r<l;++r)c=r+e,d=t[c],s[r]={r:o.parse(Dn(d,a),c)};return s}const kc=Number.EPSILON||1e-14,ei=(n,t)=>t<n.length&&!n[t].skip&&n[t],vr=n=>n==="x"?"y":"x";function Cc(n,t,e,i){const o=n.skip?t:n,a=t,s=e.skip?t:e,r=Yo(a,o),l=Yo(s,a);let c=r/(r+l),d=l/(r+l);c=isNaN(c)?0:c,d=isNaN(d)?0:d;const u=i*c,p=i*d;return{previous:{x:a.x-u*(s.x-o.x),y:a.y-u*(s.y-o.y)},next:{x:a.x+p*(s.x-o.x),y:a.y+p*(s.y-o.y)}}}function Ec(n,t,e){const i=n.length;let o,a,s,r,l,c=ei(n,0);for(let d=0;d<i-1;++d)if(l=c,c=ei(n,d+1),!(!l||!c)){if(xi(t[d],0,kc)){e[d]=e[d+1]=0;continue}o=e[d]/t[d],a=e[d+1]/t[d],r=Math.pow(o,2)+Math.pow(a,2),!(r<=9)&&(s=3/Math.sqrt(r),e[d]=o*s*t[d],e[d+1]=a*s*t[d])}}function Ic(n,t,e="x"){const i=vr(e),o=n.length;let a,s,r,l=ei(n,0);for(let c=0;c<o;++c){if(s=r,r=l,l=ei(n,c+1),!r)continue;const d=r[e],u=r[i];s&&(a=(d-s[e])/3,r["cp1".concat(e)]=d-a,r["cp1".concat(i)]=u-a*t[c]),l&&(a=(l[e]-d)/3,r["cp2".concat(e)]=d+a,r["cp2".concat(i)]=u+a*t[c])}}function Dc(n,t="x"){const e=vr(t),i=n.length,o=Array(i).fill(0),a=Array(i);let s,r,l,c=ei(n,0);for(s=0;s<i;++s)if(r=l,l=c,c=ei(n,s+1),!!l){if(c){const d=c[t]-l[t];o[s]=d!==0?(c[e]-l[e])/d:0}a[s]=r?c?ln(o[s-1])!==ln(o[s])?0:(o[s-1]+o[s])/2:o[s-1]:o[s]}Ec(n,o,a),Ic(n,a,t)}function Ri(n,t,e){return Math.max(Math.min(n,e),t)}function Tc(n,t){let e,i,o,a,s,r=yn(n[0],t);for(e=0,i=n.length;e<i;++e)s=a,a=r,r=e<i-1&&yn(n[e+1],t),a&&(o=n[e],s&&(o.cp1x=Ri(o.cp1x,t.left,t.right),o.cp1y=Ri(o.cp1y,t.top,t.bottom)),r&&(o.cp2x=Ri(o.cp2x,t.left,t.right),o.cp2y=Ri(o.cp2y,t.top,t.bottom)))}function Mc(n,t,e,i,o){let a,s,r,l;if(t.spanGaps&&(n=n.filter(c=>!c.skip)),t.cubicInterpolationMode==="monotone")Dc(n,o);else{let c=i?n[n.length-1]:n[0];for(a=0,s=n.length;a<s;++a)r=n[a],l=Cc(c,r,n[Math.min(a+1,s-(i?0:1))%s],t.tension),r.cp1x=l.previous.x,r.cp1y=l.previous.y,r.cp2x=l.next.x,r.cp2y=l.next.y,c=r}t.capBezierPoints&&Tc(n,e)}function ya(){return typeof window<"u"&&typeof document<"u"}function xa(n){let t=n.parentNode;return t&&t.toString()==="[object ShadowRoot]"&&(t=t.host),t}function fo(n,t,e){let i;return typeof n=="string"?(i=parseInt(n,10),n.indexOf("%")!==-1&&(i=i/100*t.parentNode[e])):i=n,i}const _o=n=>n.ownerDocument.defaultView.getComputedStyle(n,null);function Pc(n,t){return _o(n).getPropertyValue(t)}const Ac=["top","right","bottom","left"];function Un(n,t,e){const i={};e=e?"-"+e:"";for(let o=0;o<4;o++){const a=Ac[o];i[a]=parseFloat(n[t+"-"+a+e])||0}return i.width=i.left+i.right,i.height=i.top+i.bottom,i}const Bc=(n,t,e)=>(n>0||t>0)&&(!e||!e.shadowRoot);function Lc(n,t){const e=n.touches,i=e&&e.length?e[0]:n,{offsetX:o,offsetY:a}=i;let s=!1,r,l;if(Bc(o,a,n.target))r=o,l=a;else{const c=t.getBoundingClientRect();r=i.clientX-c.left,l=i.clientY-c.top,s=!0}return{x:r,y:l,box:s}}function Fn(n,t){if("native"in n)return n;const{canvas:e,currentDevicePixelRatio:i}=t,o=_o(e),a=o.boxSizing==="border-box",s=Un(o,"padding"),r=Un(o,"border","width"),{x:l,y:c,box:d}=Lc(n,e),u=s.left+(d&&r.left),p=s.top+(d&&r.top);let{width:f,height:b}=t;return a&&(f-=s.width+r.width,b-=s.height+r.height),{x:Math.round((l-u)/f*e.width/i),y:Math.round((c-p)/b*e.height/i)}}function Oc(n,t,e){let i,o;if(t===void 0||e===void 0){const a=n&&xa(n);if(!a)t=n.clientWidth,e=n.clientHeight;else{const s=a.getBoundingClientRect(),r=_o(a),l=Un(r,"border","width"),c=Un(r,"padding");t=s.width-c.width-l.width,e=s.height-c.height-l.height,i=fo(r.maxWidth,a,"clientWidth"),o=fo(r.maxHeight,a,"clientHeight")}}return{width:t,height:e,maxWidth:i||uo,maxHeight:o||uo}}const zi=n=>Math.round(n*10)/10;function Nc(n,t,e,i){const o=_o(n),a=Un(o,"margin"),s=fo(o.maxWidth,n,"clientWidth")||uo,r=fo(o.maxHeight,n,"clientHeight")||uo,l=Oc(n,t,e);let{width:c,height:d}=l;if(o.boxSizing==="content-box"){const p=Un(o,"border","width"),f=Un(o,"padding");c-=f.width+p.width,d-=f.height+p.height}return c=Math.max(0,c-a.width),d=Math.max(0,i?c/i:d-a.height),c=zi(Math.min(c,s,l.maxWidth)),d=zi(Math.min(d,r,l.maxHeight)),c&&!d&&(d=zi(c/2)),(t!==void 0||e!==void 0)&&i&&l.height&&d>l.height&&(d=l.height,c=zi(Math.floor(d*i))),{width:c,height:d}}function Ha(n,t,e){const i=t||1,o=Math.floor(n.height*i),a=Math.floor(n.width*i);n.height=Math.floor(n.height),n.width=Math.floor(n.width);const s=n.canvas;return s.style&&(e||!s.style.height&&!s.style.width)&&(s.style.height="".concat(n.height,"px"),s.style.width="".concat(n.width,"px")),n.currentDevicePixelRatio!==i||s.height!==o||s.width!==a?(n.currentDevicePixelRatio=i,s.height=o,s.width=a,n.ctx.setTransform(i,0,0,i,0,0),!0):!1}const Fc=(function(){let n=!1;try{const t={get passive(){return n=!0,!1}};ya()&&(window.addEventListener("test",null,t),window.removeEventListener("test",null,t))}catch(t){}return n})();function ja(n,t){const e=Pc(n,t),i=e&&e.match(/^(\d+)(\.\d+)?px$/);return i?+i[1]:void 0}function Rn(n,t,e,i){return{x:n.x+e*(t.x-n.x),y:n.y+e*(t.y-n.y)}}function Rc(n,t,e,i){return{x:n.x+e*(t.x-n.x),y:i==="middle"?e<.5?n.y:t.y:i==="after"?e<1?n.y:t.y:e>0?t.y:n.y}}function zc(n,t,e,i){const o={x:n.cp2x,y:n.cp2y},a={x:t.cp1x,y:t.cp1y},s=Rn(n,o,e),r=Rn(o,a,e),l=Rn(a,t,e),c=Rn(s,r,e),d=Rn(r,l,e);return Rn(c,d,e)}const Vc=function(n,t){return{x(e){return n+n+t-e},setWidth(e){t=e},textAlign(e){return e==="center"?e:e==="right"?"left":"right"},xPlus(e,i){return e-i},leftForLtr(e,i){return e-i}}},Uc=function(){return{x(n){return n},setWidth(n){},textAlign(n){return n},xPlus(n,t){return n+t},leftForLtr(n,t){return n}}};function Zn(n,t,e){return n?Vc(t,e):Uc()}function br(n,t){let e,i;(t==="ltr"||t==="rtl")&&(e=n.canvas.style,i=[e.getPropertyValue("direction"),e.getPropertyPriority("direction")],e.setProperty("direction",t,"important"),n.prevTextDirection=i)}function yr(n,t){t!==void 0&&(delete n.prevTextDirection,n.canvas.style.setProperty("direction",t[0],t[1]))}function xr(n){return n==="angle"?{between:Ii,compare:Hl,normalize:Fe}:{between:vn,compare:(t,e)=>t-e,normalize:t=>t}}function Wa({start:n,end:t,count:e,loop:i,style:o}){return{start:n%e,end:t%e,loop:i&&(t-n+1)%e===0,style:o}}function Hc(n,t,e){const{property:i,start:o,end:a}=e,{between:s,normalize:r}=xr(i),l=t.length;let{start:c,end:d,loop:u}=n,p,f;if(u){for(c+=l,d+=l,p=0,f=l;p<f&&s(r(t[c%l][i]),o,a);++p)c--,d--;c%=l,d%=l}return d<c&&(d+=l),{start:c,end:d,loop:u,style:n.style}}function wr(n,t,e){if(!e)return[n];const{property:i,start:o,end:a}=e,s=t.length,{compare:r,between:l,normalize:c}=xr(i),{start:d,end:u,loop:p,style:f}=Hc(n,t,e),b=[];let v=!1,y=null,E,M,X;const it=()=>l(o,X,E)&&r(o,X)!==0,Q=()=>r(a,E)===0||l(a,X,E),ft=()=>v||it(),ut=()=>!v||Q();for(let ct=d,It=d;ct<=u;++ct)M=t[ct%s],!M.skip&&(E=c(M[i]),E!==X&&(v=l(E,o,a),y===null&&ft()&&(y=r(E,o)===0?ct:It),y!==null&&ut()&&(b.push(Wa({start:y,end:ct,loop:p,count:s,style:f})),y=null),It=ct,X=E));return y!==null&&b.push(Wa({start:y,end:u,loop:p,count:s,style:f})),b}function _r(n,t){const e=[],i=n.segments;for(let o=0;o<i.length;o++){const a=wr(i[o],n.points,t);a.length&&e.push(...a)}return e}function jc(n,t,e,i){let o=0,a=t-1;if(e&&!i)for(;o<t&&!n[o].skip;)o++;for(;o<t&&n[o].skip;)o++;for(o%=t,e&&(a+=o);a>o&&n[a%t].skip;)a--;return a%=t,{start:o,end:a}}function Wc(n,t,e,i){const o=n.length,a=[];let s=t,r=n[t],l;for(l=t+1;l<=e;++l){const c=n[l%o];c.skip||c.stop?r.skip||(i=!1,a.push({start:t%o,end:(l-1)%o,loop:i}),t=s=c.stop?l:null):(s=l,r.skip&&(t=l)),r=c}return s!==null&&a.push({start:t%o,end:s%o,loop:i}),a}function Yc(n,t){const e=n.points,i=n.options.spanGaps,o=e.length;if(!o)return[];const a=!!n._loop,{start:s,end:r}=jc(e,o,a,i);if(i===!0)return Ya(n,[{start:s,end:r,loop:a}],e,t);const l=r<s?r+o:r,c=!!n._fullLoop&&s===0&&r===o-1;return Ya(n,Wc(e,s,l,c),e,t)}function Ya(n,t,e,i){return!i||!i.setContext||!e?t:$c(n,t,e,i)}function $c(n,t,e,i){const o=n._chart.getContext(),a=$a(n.options),{_datasetIndex:s,options:{spanGaps:r}}=n,l=e.length,c=[];let d=a,u=t[0].start,p=u;function f(b,v,y,E){const M=r?-1:1;if(b!==v){for(b+=l;e[b%l].skip;)b-=M;for(;e[v%l].skip;)v+=M;b%l!==v%l&&(c.push({start:b%l,end:v%l,loop:y,style:E}),d=E,u=v%l)}}for(const b of t){u=r?u:b.start;let v=e[u%l],y;for(p=u+1;p<=b.end;p++){const E=e[p%l];y=$a(i.setContext(Mn(o,{type:"segment",p0:v,p1:E,p0DataIndex:(p-1)%l,p1DataIndex:p%l,datasetIndex:s}))),qc(y,d)&&f(u,p-1,b.loop,d),v=E,d=y}u<p-1&&f(u,p-1,b.loop,d)}return c}function $a(n){return{backgroundColor:n.backgroundColor,borderCapStyle:n.borderCapStyle,borderDash:n.borderDash,borderDashOffset:n.borderDashOffset,borderJoinStyle:n.borderJoinStyle,borderWidth:n.borderWidth,borderColor:n.borderColor}}function qc(n,t){if(!t)return!1;const e=[],i=function(o,a){return ha(a)?(e.includes(a)||e.push(a),e.indexOf(a)):a};return JSON.stringify(n,i)!==JSON.stringify(t,i)}function Vi(n,t,e){return n.options.clip?n[e]:t[e]}function Gc(n,t){const{xScale:e,yScale:i}=n;return e&&i?{left:Vi(e,t,"left"),right:Vi(e,t,"right"),top:Vi(i,t,"top"),bottom:Vi(i,t,"bottom")}:t}function Sr(n,t){const e=t._clip;if(e.disabled)return!1;const i=Gc(t,n.chartArea);return{left:e.left===!1?0:i.left-(e.left===!0?0:e.left),right:e.right===!1?n.width:i.right+(e.right===!0?0:e.right),top:e.top===!1?0:i.top-(e.top===!0?0:e.top),bottom:e.bottom===!1?n.height:i.bottom+(e.bottom===!0?0:e.bottom)}}/*!
 * Chart.js v4.5.0
 * https://www.chartjs.org
 * (c) 2025 Chart.js Contributors
 * Released under the MIT License
 */class Xc{constructor(){this._request=null,this._charts=new Map,this._running=!1,this._lastDate=void 0}_notify(t,e,i,o){const a=e.listeners[o],s=e.duration;a.forEach(r=>r({chart:t,initial:e.initial,numSteps:s,currentStep:Math.min(i-e.start,s)}))}_refresh(){this._request||(this._running=!0,this._request=ar.call(window,()=>{this._update(),this._request=null,this._running&&this._refresh()}))}_update(t=Date.now()){let e=0;this._charts.forEach((i,o)=>{if(!i.running||!i.items.length)return;const a=i.items;let s=a.length-1,r=!1,l;for(;s>=0;--s)l=a[s],l._active?(l._total>i.duration&&(i.duration=l._total),l.tick(t),r=!0):(a[s]=a[a.length-1],a.pop());r&&(o.draw(),this._notify(o,i,t,"progress")),a.length||(i.running=!1,this._notify(o,i,t,"complete"),i.initial=!1),e+=a.length}),this._lastDate=t,e===0&&(this._running=!1)}_getAnims(t){const e=this._charts;let i=e.get(t);return i||(i={running:!1,initial:!0,items:[],listeners:{complete:[],progress:[]}},e.set(t,i)),i}listen(t,e,i){this._getAnims(t).listeners[e].push(i)}add(t,e){!e||!e.length||this._getAnims(t).items.push(...e)}has(t){return this._getAnims(t).items.length>0}start(t){const e=this._charts.get(t);e&&(e.running=!0,e.start=Date.now(),e.duration=e.items.reduce((i,o)=>Math.max(i,o._duration),0),this._refresh())}running(t){if(!this._running)return!1;const e=this._charts.get(t);return!(!e||!e.running||!e.items.length)}stop(t){const e=this._charts.get(t);if(!e||!e.items.length)return;const i=e.items;let o=i.length-1;for(;o>=0;--o)i[o].cancel();e.items=[],this._notify(t,e,Date.now(),"complete")}remove(t){return this._charts.delete(t)}}var fn=new Xc;const qa="transparent",Kc={boolean(n,t,e){return e>.5?t:n},color(n,t,e){const i=Fa(n||qa),o=i.valid&&Fa(t||qa);return o&&o.valid?o.mix(i,e).hexString():t},number(n,t,e){return n+(t-n)*e}};class Jc{constructor(t,e,i,o){const a=e[i];o=pi([t.to,o,a,t.from]);const s=pi([t.from,a,o]);this._active=!0,this._fn=t.fn||Kc[t.type||typeof s],this._easing=wi[t.easing]||wi.linear,this._start=Math.floor(Date.now()+(t.delay||0)),this._duration=this._total=Math.floor(t.duration),this._loop=!!t.loop,this._target=e,this._prop=i,this._from=s,this._to=o,this._promises=void 0}active(){return this._active}update(t,e,i){if(this._active){this._notify(!1);const o=this._target[this._prop],a=i-this._start,s=this._duration-a;this._start=i,this._duration=Math.floor(Math.max(s,t.duration)),this._total+=a,this._loop=!!t.loop,this._to=pi([t.to,e,o,t.from]),this._from=pi([t.from,o,e])}}cancel(){this._active&&(this.tick(Date.now()),this._active=!1,this._notify(!1))}tick(t){const e=t-this._start,i=this._duration,o=this._prop,a=this._from,s=this._loop,r=this._to;let l;if(this._active=a!==r&&(s||e<i),!this._active){this._target[o]=r,this._notify(!0);return}if(e<0){this._target[o]=a;return}l=e/i%2,l=s&&l>1?2-l:l,l=this._easing(Math.min(1,Math.max(0,l))),this._target[o]=this._fn(a,r,l)}wait(){const t=this._promises||(this._promises=[]);return new Promise((e,i)=>{t.push({res:e,rej:i})})}_notify(t){const e=t?"res":"rej",i=this._promises||[];for(let o=0;o<i.length;o++)i[o][e]()}}class kr{constructor(t,e){this._chart=t,this._properties=new Map,this.configure(e)}configure(t){if(!ie(t))return;const e=Object.keys(be.animation),i=this._properties;Object.getOwnPropertyNames(t).forEach(o=>{const a=t[o];if(!ie(a))return;const s={};for(const r of e)s[r]=a[r];(ve(a.properties)&&a.properties||[o]).forEach(r=>{(r===o||!i.has(r))&&i.set(r,s)})})}_animateOptions(t,e){const i=e.options,o=Qc(t,i);if(!o)return[];const a=this._createAnimations(o,i);return i.$shared&&Zc(t.options.$animations,i).then(()=>{t.options=i},()=>{}),a}_createAnimations(t,e){const i=this._properties,o=[],a=t.$animations||(t.$animations={}),s=Object.keys(e),r=Date.now();let l;for(l=s.length-1;l>=0;--l){const c=s[l];if(c.charAt(0)==="$")continue;if(c==="options"){o.push(...this._animateOptions(t,e));continue}const d=e[c];let u=a[c];const p=i.get(c);if(u)if(p&&u.active()){u.update(p,d,r);continue}else u.cancel();if(!p||!p.duration){t[c]=d;continue}a[c]=u=new Jc(p,t,c,d),o.push(u)}return o}update(t,e){if(this._properties.size===0){Object.assign(t,e);return}const i=this._createAnimations(t,e);if(i.length)return fn.add(this._chart,i),!0}}function Zc(n,t){const e=[],i=Object.keys(t);for(let o=0;o<i.length;o++){const a=n[i[o]];a&&a.active()&&e.push(a.wait())}return Promise.all(e)}function Qc(n,t){if(!t)return;let e=n.options;if(!e){n.options=t;return}return e.$shared&&(n.options=e=Object.assign({},e,{$shared:!1,$animations:{}})),e}function Ga(n,t){const e=n&&n.options||{},i=e.reverse,o=e.min===void 0?t:0,a=e.max===void 0?t:0;return{start:i?a:o,end:i?o:a}}function td(n,t,e){if(e===!1)return!1;const i=Ga(n,e),o=Ga(t,e);return{top:o.end,right:i.end,bottom:o.start,left:i.start}}function ed(n){let t,e,i,o;return ie(n)?(t=n.top,e=n.right,i=n.bottom,o=n.left):t=e=i=o=n,{top:t,right:e,bottom:i,left:o,disabled:n===!1}}function Cr(n,t){const e=[],i=n._getSortedDatasetMetas(t);let o,a;for(o=0,a=i.length;o<a;++o)e.push(i[o].index);return e}function Xa(n,t,e,i={}){const o=n.keys,a=i.mode==="single";let s,r,l,c;if(t===null)return;let d=!1;for(s=0,r=o.length;s<r;++s){if(l=+o[s],l===e){if(d=!0,i.all)continue;break}c=n.values[l],_e(c)&&(a||t===0||ln(t)===ln(c))&&(t+=c)}return!d&&!i.all?0:t}function nd(n,t){const{iScale:e,vScale:i}=t,o=e.axis==="x"?"x":"y",a=i.axis==="x"?"x":"y",s=Object.keys(n),r=new Array(s.length);let l,c,d;for(l=0,c=s.length;l<c;++l)d=s[l],r[l]={[o]:d,[a]:n[d]};return r}function Ao(n,t){const e=n&&n.options.stacked;return e||e===void 0&&t.stack!==void 0}function id(n,t,e){return"".concat(n.id,".").concat(t.id,".").concat(e.stack||e.type)}function od(n){const{min:t,max:e,minDefined:i,maxDefined:o}=n.getUserBounds();return{min:i?t:Number.NEGATIVE_INFINITY,max:o?e:Number.POSITIVE_INFINITY}}function ad(n,t,e){const i=n[t]||(n[t]={});return i[e]||(i[e]={})}function Ka(n,t,e,i){for(const o of t.getMatchingVisibleMetas(i).reverse()){const a=n[o.index];if(e&&a>0||!e&&a<0)return o.index}return null}function Ja(n,t){const{chart:e,_cachedMeta:i}=n,o=e._stacks||(e._stacks={}),{iScale:a,vScale:s,index:r}=i,l=a.axis,c=s.axis,d=id(a,s,i),u=t.length;let p;for(let f=0;f<u;++f){const b=t[f],{[l]:v,[c]:y}=b,E=b._stacks||(b._stacks={});p=E[c]=ad(o,d,v),p[r]=y,p._top=Ka(p,s,!0,i.type),p._bottom=Ka(p,s,!1,i.type);const M=p._visualValues||(p._visualValues={});M[r]=y}}function Bo(n,t){const e=n.scales;return Object.keys(e).filter(i=>e[i].axis===t).shift()}function sd(n,t){return Mn(n,{active:!1,dataset:void 0,datasetIndex:t,index:t,mode:"default",type:"dataset"})}function rd(n,t,e){return Mn(n,{active:!1,dataIndex:t,parsed:void 0,raw:void 0,element:e,index:t,mode:"default",type:"data"})}function ai(n,t){const e=n.controller.index,i=n.vScale&&n.vScale.axis;if(i){t=t||n._parsed;for(const o of t){const a=o._stacks;if(!a||a[i]===void 0||a[i][e]===void 0)return;delete a[i][e],a[i]._visualValues!==void 0&&a[i]._visualValues[e]!==void 0&&delete a[i]._visualValues[e]}}}const Lo=n=>n==="reset"||n==="none",Za=(n,t)=>t?n:Object.assign({},n),ld=(n,t,e)=>n&&!t.hidden&&t._stacked&&{keys:Cr(e,!0),values:null};class tn{constructor(t,e){this.chart=t,this._ctx=t.ctx,this.index=e,this._cachedDataOpts={},this._cachedMeta=this.getMeta(),this._type=this._cachedMeta.type,this.options=void 0,this._parsing=!1,this._data=void 0,this._objectData=void 0,this._sharedOptions=void 0,this._drawStart=void 0,this._drawCount=void 0,this.enableOptionSharing=!1,this.supportsDecimation=!1,this.$context=void 0,this._syncList=[],this.datasetElementType=new.target.datasetElementType,this.dataElementType=new.target.dataElementType,this.initialize()}initialize(){const t=this._cachedMeta;this.configure(),this.linkScales(),t._stacked=Ao(t.vScale,t),this.addElements(),this.options.fill&&!this.chart.isPluginEnabled("filler")&&console.warn("Tried to use the 'fill' option without the 'Filler' plugin enabled. Please import and register the 'Filler' plugin and make sure it is not disabled in the options")}updateIndex(t){this.index!==t&&ai(this._cachedMeta),this.index=t}linkScales(){const t=this.chart,e=this._cachedMeta,i=this.getDataset(),o=(u,p,f,b)=>u==="x"?p:u==="r"?b:f,a=e.xAxisID=Xt(i.xAxisID,Bo(t,"x")),s=e.yAxisID=Xt(i.yAxisID,Bo(t,"y")),r=e.rAxisID=Xt(i.rAxisID,Bo(t,"r")),l=e.indexAxis,c=e.iAxisID=o(l,a,s,r),d=e.vAxisID=o(l,s,a,r);e.xScale=this.getScaleForId(a),e.yScale=this.getScaleForId(s),e.rScale=this.getScaleForId(r),e.iScale=this.getScaleForId(c),e.vScale=this.getScaleForId(d)}getDataset(){return this.chart.data.datasets[this.index]}getMeta(){return this.chart.getDatasetMeta(this.index)}getScaleForId(t){return this.chart.scales[t]}_getOtherScale(t){const e=this._cachedMeta;return t===e.iScale?e.vScale:e.iScale}reset(){this._update("reset")}_destroy(){const t=this._cachedMeta;this._data&&La(this._data,this),t._stacked&&ai(t)}_dataCheck(){const t=this.getDataset(),e=t.data||(t.data=[]),i=this._data;if(ie(e)){const o=this._cachedMeta;this._data=nd(e,o)}else if(i!==e){if(i){La(i,this);const o=this._cachedMeta;ai(o),o._parsed=[]}e&&Object.isExtensible(e)&&$l(e,this),this._syncList=[],this._data=e}}addElements(){const t=this._cachedMeta;this._dataCheck(),this.datasetElementType&&(t.dataset=new this.datasetElementType)}buildOrUpdateElements(t){const e=this._cachedMeta,i=this.getDataset();let o=!1;this._dataCheck();const a=e._stacked;e._stacked=Ao(e.vScale,e),e.stack!==i.stack&&(o=!0,ai(e),e.stack=i.stack),this._resyncElements(t),(o||a!==e._stacked)&&(Ja(this,e._parsed),e._stacked=Ao(e.vScale,e))}configure(){const t=this.chart.config,e=t.datasetScopeKeys(this._type),i=t.getOptionScopes(this.getDataset(),e,!0);this.options=t.createResolver(i,this.getContext()),this._parsing=this.options.parsing,this._cachedDataOpts={}}parse(t,e){const{_cachedMeta:i,_data:o}=this,{iScale:a,_stacked:s}=i,r=a.axis;let l=t===0&&e===o.length?!0:i._sorted,c=t>0&&i._parsed[t-1],d,u,p;if(this._parsing===!1)i._parsed=o,i._sorted=!0,p=o;else{ve(o[t])?p=this.parseArrayData(i,o,t,e):ie(o[t])?p=this.parseObjectData(i,o,t,e):p=this.parsePrimitiveData(i,o,t,e);const f=()=>u[r]===null||c&&u[r]<c[r];for(d=0;d<e;++d)i._parsed[d+t]=u=p[d],l&&(f()&&(l=!1),c=u);i._sorted=l}s&&Ja(this,p)}parsePrimitiveData(t,e,i,o){const{iScale:a,vScale:s}=t,r=a.axis,l=s.axis,c=a.getLabels(),d=a===s,u=new Array(o);let p,f,b;for(p=0,f=o;p<f;++p)b=p+i,u[p]={[r]:d||a.parse(c[b],b),[l]:s.parse(e[b],b)};return u}parseArrayData(t,e,i,o){const{xScale:a,yScale:s}=t,r=new Array(o);let l,c,d,u;for(l=0,c=o;l<c;++l)d=l+i,u=e[d],r[l]={x:a.parse(u[0],d),y:s.parse(u[1],d)};return r}parseObjectData(t,e,i,o){const{xScale:a,yScale:s}=t,{xAxisKey:r="x",yAxisKey:l="y"}=this._parsing,c=new Array(o);let d,u,p,f;for(d=0,u=o;d<u;++d)p=d+i,f=e[p],c[d]={x:a.parse(Dn(f,r),p),y:s.parse(Dn(f,l),p)};return c}getParsed(t){return this._cachedMeta._parsed[t]}getDataElement(t){return this._cachedMeta.data[t]}applyStack(t,e,i){const o=this.chart,a=this._cachedMeta,s=e[t.axis],r={keys:Cr(o,!0),values:e._stacks[t.axis]._visualValues};return Xa(r,s,a.index,{mode:i})}updateRangeFromParsed(t,e,i,o){const a=i[e.axis];let s=a===null?NaN:a;const r=o&&i._stacks[e.axis];o&&r&&(o.values=r,s=Xa(o,a,this._cachedMeta.index)),t.min=Math.min(t.min,s),t.max=Math.max(t.max,s)}getMinMax(t,e){const i=this._cachedMeta,o=i._parsed,a=i._sorted&&t===i.iScale,s=o.length,r=this._getOtherScale(t),l=ld(e,i,this.chart),c={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY},{min:d,max:u}=od(r);let p,f;function b(){f=o[p];const v=f[r.axis];return!_e(f[t.axis])||d>v||u<v}for(p=0;p<s&&!(!b()&&(this.updateRangeFromParsed(c,t,f,l),a));++p);if(a){for(p=s-1;p>=0;--p)if(!b()){this.updateRangeFromParsed(c,t,f,l);break}}return c}getAllParsedValues(t){const e=this._cachedMeta._parsed,i=[];let o,a,s;for(o=0,a=e.length;o<a;++o)s=e[o][t.axis],_e(s)&&i.push(s);return i}getMaxOverflow(){return!1}getLabelAndValue(t){const e=this._cachedMeta,i=e.iScale,o=e.vScale,a=this.getParsed(t);return{label:i?""+i.getLabelForValue(a[i.axis]):"",value:o?""+o.getLabelForValue(a[o.axis]):""}}_update(t){const e=this._cachedMeta;this.update(t||"default"),e._clip=ed(Xt(this.options.clip,td(e.xScale,e.yScale,this.getMaxOverflow())))}update(t){}draw(){const t=this._ctx,e=this.chart,i=this._cachedMeta,o=i.data||[],a=e.chartArea,s=[],r=this._drawStart||0,l=this._drawCount||o.length-r,c=this.options.drawActiveElementsOnTop;let d;for(i.dataset&&i.dataset.draw(t,a,r,l),d=r;d<r+l;++d){const u=o[d];u.hidden||(u.active&&c?s.push(u):u.draw(t,a))}for(d=0;d<s.length;++d)s[d].draw(t,a)}getStyle(t,e){const i=e?"active":"default";return t===void 0&&this._cachedMeta.dataset?this.resolveDatasetElementOptions(i):this.resolveDataElementOptions(t||0,i)}getContext(t,e,i){const o=this.getDataset();let a;if(t>=0&&t<this._cachedMeta.data.length){const s=this._cachedMeta.data[t];a=s.$context||(s.$context=rd(this.getContext(),t,s)),a.parsed=this.getParsed(t),a.raw=o.data[t],a.index=a.dataIndex=t}else a=this.$context||(this.$context=sd(this.chart.getContext(),this.index)),a.dataset=o,a.index=a.datasetIndex=this.index;return a.active=!!e,a.mode=i,a}resolveDatasetElementOptions(t){return this._resolveElementOptions(this.datasetElementType.id,t)}resolveDataElementOptions(t,e){return this._resolveElementOptions(this.dataElementType.id,e,t)}_resolveElementOptions(t,e="default",i){const o=e==="active",a=this._cachedDataOpts,s=t+"-"+e,r=a[s],l=this.enableOptionSharing&&Ei(i);if(r)return Za(r,l);const c=this.chart.config,d=c.datasetElementScopeKeys(this._type,t),u=o?["".concat(t,"Hover"),"hover",t,""]:[t,""],p=c.getOptionScopes(this.getDataset(),d),f=Object.keys(be.elements[t]),b=()=>this.getContext(i,o,e),v=c.resolveNamedOptions(p,f,b,u);return v.$shared&&(v.$shared=l,a[s]=Object.freeze(Za(v,l))),v}_resolveAnimations(t,e,i){const o=this.chart,a=this._cachedDataOpts,s="animation-".concat(e),r=a[s];if(r)return r;let l;if(o.options.animation!==!1){const d=this.chart.config,u=d.datasetAnimationScopeKeys(this._type,e),p=d.getOptionScopes(this.getDataset(),u);l=d.createResolver(p,this.getContext(t,i,e))}const c=new kr(o,l&&l.animations);return l&&l._cacheable&&(a[s]=Object.freeze(c)),c}getSharedOptions(t){if(t.$shared)return this._sharedOptions||(this._sharedOptions=Object.assign({},t))}includeOptions(t,e){return!e||Lo(t)||this.chart._animationsDisabled}_getSharedOptions(t,e){const i=this.resolveDataElementOptions(t,e),o=this._sharedOptions,a=this.getSharedOptions(i),s=this.includeOptions(e,a)||a!==o;return this.updateSharedOptions(a,e,i),{sharedOptions:a,includeOptions:s}}updateElement(t,e,i,o){Lo(o)?Object.assign(t,i):this._resolveAnimations(e,o).update(t,i)}updateSharedOptions(t,e,i){t&&!Lo(e)&&this._resolveAnimations(void 0,e).update(t,i)}_setStyle(t,e,i,o){t.active=o;const a=this.getStyle(e,o);this._resolveAnimations(e,i,o).update(t,{options:!o&&this.getSharedOptions(a)||a})}removeHoverStyle(t,e,i){this._setStyle(t,i,"active",!1)}setHoverStyle(t,e,i){this._setStyle(t,i,"active",!0)}_removeDatasetHoverStyle(){const t=this._cachedMeta.dataset;t&&this._setStyle(t,void 0,"active",!1)}_setDatasetHoverStyle(){const t=this._cachedMeta.dataset;t&&this._setStyle(t,void 0,"active",!0)}_resyncElements(t){const e=this._data,i=this._cachedMeta.data;for(const[r,l,c]of this._syncList)this[r](l,c);this._syncList=[];const o=i.length,a=e.length,s=Math.min(a,o);s&&this.parse(0,s),a>o?this._insertElements(o,a-o,t):a<o&&this._removeElements(a,o-a)}_insertElements(t,e,i=!0){const o=this._cachedMeta,a=o.data,s=t+e;let r;const l=c=>{for(c.length+=e,r=c.length-1;r>=s;r--)c[r]=c[r-e]};for(l(a),r=t;r<s;++r)a[r]=new this.dataElementType;this._parsing&&l(o._parsed),this.parse(t,e),i&&this.updateElements(a,t,e,"reset")}updateElements(t,e,i,o){}_removeElements(t,e){const i=this._cachedMeta;if(this._parsing){const o=i._parsed.splice(t,e);i._stacked&&ai(i,o)}i.data.splice(t,e)}_sync(t){if(this._parsing)this._syncList.push(t);else{const[e,i,o]=t;this[e](i,o)}this.chart._dataChanges.push([this.index,...t])}_onDataPush(){const t=arguments.length;this._sync(["_insertElements",this.getDataset().data.length-t,t])}_onDataPop(){this._sync(["_removeElements",this._cachedMeta.data.length-1,1])}_onDataShift(){this._sync(["_removeElements",0,1])}_onDataSplice(t,e){e&&this._sync(["_removeElements",t,e]);const i=arguments.length-2;i&&this._sync(["_insertElements",t,i])}_onDataUnshift(){this._sync(["_insertElements",0,arguments.length])}}St(tn,"defaults",{}),St(tn,"datasetElementType",null),St(tn,"dataElementType",null);function cd(n,t){if(!n._cache.$bar){const e=n.getMatchingVisibleMetas(t);let i=[];for(let o=0,a=e.length;o<a;o++)i=i.concat(e[o].controller.getAllParsedValues(n));n._cache.$bar=or(i.sort((o,a)=>o-a))}return n._cache.$bar}function dd(n){const t=n.iScale,e=cd(t,n.type);let i=t._length,o,a,s,r;const l=()=>{s===32767||s===-32768||(Ei(r)&&(i=Math.min(i,Math.abs(s-r)||i)),r=s)};for(o=0,a=e.length;o<a;++o)s=t.getPixelForValue(e[o]),l();for(r=void 0,o=0,a=t.ticks.length;o<a;++o)s=t.getPixelForTick(o),l();return i}function ud(n,t,e,i){const o=e.barThickness;let a,s;return ne(o)?(a=t.min*e.categoryPercentage,s=e.barPercentage):(a=o*i,s=1),{chunk:a/i,ratio:s,start:t.pixels[n]-a/2}}function pd(n,t,e,i){const o=t.pixels,a=o[n];let s=n>0?o[n-1]:null,r=n<o.length-1?o[n+1]:null;const l=e.categoryPercentage;s===null&&(s=a-(r===null?t.end-t.start:r-a)),r===null&&(r=a+a-s);const c=a-(a-Math.min(s,r))/2*l;return{chunk:Math.abs(r-s)/2*l/i,ratio:e.barPercentage,start:c}}function fd(n,t,e,i){const o=e.parse(n[0],i),a=e.parse(n[1],i),s=Math.min(o,a),r=Math.max(o,a);let l=s,c=r;Math.abs(s)>Math.abs(r)&&(l=r,c=s),t[e.axis]=c,t._custom={barStart:l,barEnd:c,start:o,end:a,min:s,max:r}}function Er(n,t,e,i){return ve(n)?fd(n,t,e,i):t[e.axis]=e.parse(n,i),t}function Qa(n,t,e,i){const o=n.iScale,a=n.vScale,s=o.getLabels(),r=o===a,l=[];let c,d,u,p;for(c=e,d=e+i;c<d;++c)p=t[c],u={},u[o.axis]=r||o.parse(s[c],c),l.push(Er(p,u,a,c));return l}function Oo(n){return n&&n.barStart!==void 0&&n.barEnd!==void 0}function hd(n,t,e){return n!==0?ln(n):(t.isHorizontal()?1:-1)*(t.min>=e?1:-1)}function gd(n){let t,e,i,o,a;return n.horizontal?(t=n.base>n.x,e="left",i="right"):(t=n.base<n.y,e="bottom",i="top"),t?(o="end",a="start"):(o="start",a="end"),{start:e,end:i,reverse:t,top:o,bottom:a}}function md(n,t,e,i){let o=t.borderSkipped;const a={};if(!o){n.borderSkipped=a;return}if(o===!0){n.borderSkipped={top:!0,right:!0,bottom:!0,left:!0};return}const{start:s,end:r,reverse:l,top:c,bottom:d}=gd(n);o==="middle"&&e&&(n.enableBorderRadius=!0,(e._top||0)===i?o=c:(e._bottom||0)===i?o=d:(a[ts(d,s,r,l)]=!0,o=c)),a[ts(o,s,r,l)]=!0,n.borderSkipped=a}function ts(n,t,e,i){return i?(n=vd(n,t,e),n=es(n,e,t)):n=es(n,t,e),n}function vd(n,t,e){return n===t?e:n===e?t:n}function es(n,t,e){return n==="start"?t:n==="end"?e:n}function bd(n,{inflateAmount:t},e){n.inflateAmount=t==="auto"?e===1?.33:0:t}class Zi extends tn{parsePrimitiveData(t,e,i,o){return Qa(t,e,i,o)}parseArrayData(t,e,i,o){return Qa(t,e,i,o)}parseObjectData(t,e,i,o){const{iScale:a,vScale:s}=t,{xAxisKey:r="x",yAxisKey:l="y"}=this._parsing,c=a.axis==="x"?r:l,d=s.axis==="x"?r:l,u=[];let p,f,b,v;for(p=i,f=i+o;p<f;++p)v=e[p],b={},b[a.axis]=a.parse(Dn(v,c),p),u.push(Er(Dn(v,d),b,s,p));return u}updateRangeFromParsed(t,e,i,o){super.updateRangeFromParsed(t,e,i,o);const a=i._custom;a&&e===this._cachedMeta.vScale&&(t.min=Math.min(t.min,a.min),t.max=Math.max(t.max,a.max))}getMaxOverflow(){return 0}getLabelAndValue(t){const e=this._cachedMeta,{iScale:i,vScale:o}=e,a=this.getParsed(t),s=a._custom,r=Oo(s)?"["+s.start+", "+s.end+"]":""+o.getLabelForValue(a[o.axis]);return{label:""+i.getLabelForValue(a[i.axis]),value:r}}initialize(){this.enableOptionSharing=!0,super.initialize();const t=this._cachedMeta;t.stack=this.getDataset().stack}update(t){const e=this._cachedMeta;this.updateElements(e.data,0,e.data.length,t)}updateElements(t,e,i,o){const a=o==="reset",{index:s,_cachedMeta:{vScale:r}}=this,l=r.getBasePixel(),c=r.isHorizontal(),d=this._getRuler(),{sharedOptions:u,includeOptions:p}=this._getSharedOptions(e,o);for(let f=e;f<e+i;f++){const b=this.getParsed(f),v=a||ne(b[r.axis])?{base:l,head:l}:this._calculateBarValuePixels(f),y=this._calculateBarIndexPixels(f,d),E=(b._stacks||{})[r.axis],M={horizontal:c,base:v.base,enableBorderRadius:!E||Oo(b._custom)||s===E._top||s===E._bottom,x:c?v.head:y.center,y:c?y.center:v.head,height:c?y.size:Math.abs(v.size),width:c?Math.abs(v.size):y.size};p&&(M.options=u||this.resolveDataElementOptions(f,t[f].active?"active":o));const X=M.options||t[f].options;md(M,X,E,s),bd(M,X,d.ratio),this.updateElement(t[f],f,M,o)}}_getStacks(t,e){const{iScale:i}=this._cachedMeta,o=i.getMatchingVisibleMetas(this._type).filter(d=>d.controller.options.grouped),a=i.options.stacked,s=[],r=this._cachedMeta.controller.getParsed(e),l=r&&r[i.axis],c=d=>{const u=d._parsed.find(f=>f[i.axis]===l),p=u&&u[d.vScale.axis];if(ne(p)||isNaN(p))return!0};for(const d of o)if(!(e!==void 0&&c(d))&&((a===!1||s.indexOf(d.stack)===-1||a===void 0&&d.stack===void 0)&&s.push(d.stack),d.index===t))break;return s.length||s.push(void 0),s}_getStackCount(t){return this._getStacks(void 0,t).length}_getAxisCount(){return this._getAxis().length}getFirstScaleIdForIndexAxis(){const t=this.chart.scales,e=this.chart.options.indexAxis;return Object.keys(t).filter(i=>t[i].axis===e).shift()}_getAxis(){const t={},e=this.getFirstScaleIdForIndexAxis();for(const i of this.chart.data.datasets)t[Xt(this.chart.options.indexAxis==="x"?i.xAxisID:i.yAxisID,e)]=!0;return Object.keys(t)}_getStackIndex(t,e,i){const o=this._getStacks(t,i),a=e!==void 0?o.indexOf(e):-1;return a===-1?o.length-1:a}_getRuler(){const t=this.options,e=this._cachedMeta,i=e.iScale,o=[];let a,s;for(a=0,s=e.data.length;a<s;++a)o.push(i.getPixelForValue(this.getParsed(a)[i.axis],a));const r=t.barThickness;return{min:r||dd(e),pixels:o,start:i._startPixel,end:i._endPixel,stackCount:this._getStackCount(),scale:i,grouped:t.grouped,ratio:r?1:t.categoryPercentage*t.barPercentage}}_calculateBarValuePixels(t){const{_cachedMeta:{vScale:e,_stacked:i,index:o},options:{base:a,minBarLength:s}}=this,r=a||0,l=this.getParsed(t),c=l._custom,d=Oo(c);let u=l[e.axis],p=0,f=i?this.applyStack(e,l,i):u,b,v;f!==u&&(p=f-u,f=u),d&&(u=c.barStart,f=c.barEnd-c.barStart,u!==0&&ln(u)!==ln(c.barEnd)&&(p=0),p+=u);const y=!ne(a)&&!d?a:p;let E=e.getPixelForValue(y);if(this.chart.getDataVisibility(t)?b=e.getPixelForValue(p+f):b=E,v=b-E,Math.abs(v)<s){v=hd(v,e,r)*s,u===r&&(E-=v/2);const M=e.getPixelForDecimal(0),X=e.getPixelForDecimal(1),it=Math.min(M,X),Q=Math.max(M,X);E=Math.max(Math.min(E,Q),it),b=E+v,i&&!d&&(l._stacks[e.axis]._visualValues[o]=e.getValueForPixel(b)-e.getValueForPixel(E))}if(E===e.getPixelForValue(r)){const M=ln(v)*e.getLineWidthForValue(r)/2;E+=M,v-=M}return{size:v,base:E,head:b,center:b+v/2}}_calculateBarIndexPixels(t,e){const i=e.scale,o=this.options,a=o.skipNull,s=Xt(o.maxBarThickness,1/0);let r,l;const c=this._getAxisCount();if(e.grouped){const d=a?this._getStackCount(t):e.stackCount,u=o.barThickness==="flex"?pd(t,e,o,d*c):ud(t,e,o,d*c),p=this.chart.options.indexAxis==="x"?this.getDataset().xAxisID:this.getDataset().yAxisID,f=this._getAxis().indexOf(Xt(p,this.getFirstScaleIdForIndexAxis())),b=this._getStackIndex(this.index,this._cachedMeta.stack,a?t:void 0)+f;r=u.start+u.chunk*b+u.chunk/2,l=Math.min(s,u.chunk*u.ratio)}else r=i.getPixelForValue(this.getParsed(t)[i.axis],t),l=Math.min(s,e.min*e.ratio);return{base:r-l/2,head:r+l/2,center:r,size:l}}draw(){const t=this._cachedMeta,e=t.vScale,i=t.data,o=i.length;let a=0;for(;a<o;++a)this.getParsed(a)[e.axis]!==null&&!i[a].hidden&&i[a].draw(this._ctx)}}St(Zi,"id","bar"),St(Zi,"defaults",{datasetElementType:!1,dataElementType:"bar",categoryPercentage:.8,barPercentage:.9,grouped:!0,animations:{numbers:{type:"number",properties:["x","y","base","width","height"]}}}),St(Zi,"overrides",{scales:{_index_:{type:"category",offset:!0,grid:{offset:!0}},_value_:{type:"linear",beginAtZero:!0}}});class Qi extends tn{initialize(){this.enableOptionSharing=!0,super.initialize()}parsePrimitiveData(t,e,i,o){const a=super.parsePrimitiveData(t,e,i,o);for(let s=0;s<a.length;s++)a[s]._custom=this.resolveDataElementOptions(s+i).radius;return a}parseArrayData(t,e,i,o){const a=super.parseArrayData(t,e,i,o);for(let s=0;s<a.length;s++){const r=e[i+s];a[s]._custom=Xt(r[2],this.resolveDataElementOptions(s+i).radius)}return a}parseObjectData(t,e,i,o){const a=super.parseObjectData(t,e,i,o);for(let s=0;s<a.length;s++){const r=e[i+s];a[s]._custom=Xt(r&&r.r&&+r.r,this.resolveDataElementOptions(s+i).radius)}return a}getMaxOverflow(){const t=this._cachedMeta.data;let e=0;for(let i=t.length-1;i>=0;--i)e=Math.max(e,t[i].size(this.resolveDataElementOptions(i))/2);return e>0&&e}getLabelAndValue(t){const e=this._cachedMeta,i=this.chart.data.labels||[],{xScale:o,yScale:a}=e,s=this.getParsed(t),r=o.getLabelForValue(s.x),l=a.getLabelForValue(s.y),c=s._custom;return{label:i[t]||"",value:"("+r+", "+l+(c?", "+c:"")+")"}}update(t){const e=this._cachedMeta.data;this.updateElements(e,0,e.length,t)}updateElements(t,e,i,o){const a=o==="reset",{iScale:s,vScale:r}=this._cachedMeta,{sharedOptions:l,includeOptions:c}=this._getSharedOptions(e,o),d=s.axis,u=r.axis;for(let p=e;p<e+i;p++){const f=t[p],b=!a&&this.getParsed(p),v={},y=v[d]=a?s.getPixelForDecimal(.5):s.getPixelForValue(b[d]),E=v[u]=a?r.getBasePixel():r.getPixelForValue(b[u]);v.skip=isNaN(y)||isNaN(E),c&&(v.options=l||this.resolveDataElementOptions(p,f.active?"active":o),a&&(v.options.radius=0)),this.updateElement(f,p,v,o)}}resolveDataElementOptions(t,e){const i=this.getParsed(t);let o=super.resolveDataElementOptions(t,e);o.$shared&&(o=Object.assign({},o,{$shared:!1}));const a=o.radius;return e!=="active"&&(o.radius=0),o.radius+=Xt(i&&i._custom,a),o}}St(Qi,"id","bubble"),St(Qi,"defaults",{datasetElementType:!1,dataElementType:"point",animations:{numbers:{type:"number",properties:["x","y","borderWidth","radius"]}}}),St(Qi,"overrides",{scales:{x:{type:"linear"},y:{type:"linear"}}});function yd(n,t,e){let i=1,o=1,a=0,s=0;if(t<me){const r=n,l=r+t,c=Math.cos(r),d=Math.sin(r),u=Math.cos(l),p=Math.sin(l),f=(X,it,Q)=>Ii(X,r,l,!0)?1:Math.max(it,it*e,Q,Q*e),b=(X,it,Q)=>Ii(X,r,l,!0)?-1:Math.min(it,it*e,Q,Q*e),v=f(0,c,u),y=f(ke,d,p),E=b(de,c,u),M=b(de+ke,d,p);i=(v-E)/2,o=(y-M)/2,a=-(v+E)/2,s=-(y+M)/2}return{ratioX:i,ratioY:o,offsetX:a,offsetY:s}}class zn extends tn{constructor(t,e){super(t,e),this.enableOptionSharing=!0,this.innerRadius=void 0,this.outerRadius=void 0,this.offsetX=void 0,this.offsetY=void 0}linkScales(){}parse(t,e){const i=this.getDataset().data,o=this._cachedMeta;if(this._parsing===!1)o._parsed=i;else{let a=l=>+i[l];if(ie(i[t])){const{key:l="value"}=this._parsing;a=c=>+Dn(i[c],l)}let s,r;for(s=t,r=t+e;s<r;++s)o._parsed[s]=a(s)}}_getRotation(){return Qe(this.options.rotation-90)}_getCircumference(){return Qe(this.options.circumference)}_getRotationExtents(){let t=me,e=-me;for(let i=0;i<this.chart.data.datasets.length;++i)if(this.chart.isDatasetVisible(i)&&this.chart.getDatasetMeta(i).type===this._type){const o=this.chart.getDatasetMeta(i).controller,a=o._getRotation(),s=o._getCircumference();t=Math.min(t,a),e=Math.max(e,a+s)}return{rotation:t,circumference:e-t}}update(t){const e=this.chart,{chartArea:i}=e,o=this._cachedMeta,a=o.data,s=this.getMaxBorderWidth()+this.getMaxOffset(a)+this.options.spacing,r=Math.max((Math.min(i.width,i.height)-s)/2,0),l=Math.min(Pl(this.options.cutout,r),1),c=this._getRingWeight(this.index),{circumference:d,rotation:u}=this._getRotationExtents(),{ratioX:p,ratioY:f,offsetX:b,offsetY:v}=yd(u,d,l),y=(i.width-s)/p,E=(i.height-s)/f,M=Math.max(Math.min(y,E)/2,0),X=Qs(this.options.radius,M),it=Math.max(X*l,0),Q=(X-it)/this._getVisibleDatasetWeightTotal();this.offsetX=b*X,this.offsetY=v*X,o.total=this.calculateTotal(),this.outerRadius=X-Q*this._getRingWeightOffset(this.index),this.innerRadius=Math.max(this.outerRadius-Q*c,0),this.updateElements(a,0,a.length,t)}_circumference(t,e){const i=this.options,o=this._cachedMeta,a=this._getCircumference();return e&&i.animation.animateRotate||!this.chart.getDataVisibility(t)||o._parsed[t]===null||o.data[t].hidden?0:this.calculateCircumference(o._parsed[t]*a/me)}updateElements(t,e,i,o){const a=o==="reset",s=this.chart,r=s.chartArea,c=s.options.animation,d=(r.left+r.right)/2,u=(r.top+r.bottom)/2,p=a&&c.animateScale,f=p?0:this.innerRadius,b=p?0:this.outerRadius,{sharedOptions:v,includeOptions:y}=this._getSharedOptions(e,o);let E=this._getRotation(),M;for(M=0;M<e;++M)E+=this._circumference(M,a);for(M=e;M<e+i;++M){const X=this._circumference(M,a),it=t[M],Q={x:d+this.offsetX,y:u+this.offsetY,startAngle:E,endAngle:E+X,circumference:X,outerRadius:b,innerRadius:f};y&&(Q.options=v||this.resolveDataElementOptions(M,it.active?"active":o)),E+=X,this.updateElement(it,M,Q,o)}}calculateTotal(){const t=this._cachedMeta,e=t.data;let i=0,o;for(o=0;o<e.length;o++){const a=t._parsed[o];a!==null&&!isNaN(a)&&this.chart.getDataVisibility(o)&&!e[o].hidden&&(i+=Math.abs(a))}return i}calculateCircumference(t){const e=this._cachedMeta.total;return e>0&&!isNaN(t)?me*(Math.abs(t)/e):0}getLabelAndValue(t){const e=this._cachedMeta,i=this.chart,o=i.data.labels||[],a=Bi(e._parsed[t],i.options.locale);return{label:o[t]||"",value:a}}getMaxBorderWidth(t){let e=0;const i=this.chart;let o,a,s,r,l;if(!t){for(o=0,a=i.data.datasets.length;o<a;++o)if(i.isDatasetVisible(o)){s=i.getDatasetMeta(o),t=s.data,r=s.controller;break}}if(!t)return 0;for(o=0,a=t.length;o<a;++o)l=r.resolveDataElementOptions(o),l.borderAlign!=="inner"&&(e=Math.max(e,l.borderWidth||0,l.hoverBorderWidth||0));return e}getMaxOffset(t){let e=0;for(let i=0,o=t.length;i<o;++i){const a=this.resolveDataElementOptions(i);e=Math.max(e,a.offset||0,a.hoverOffset||0)}return e}_getRingWeightOffset(t){let e=0;for(let i=0;i<t;++i)this.chart.isDatasetVisible(i)&&(e+=this._getRingWeight(i));return e}_getRingWeight(t){return Math.max(Xt(this.chart.data.datasets[t].weight,1),0)}_getVisibleDatasetWeightTotal(){return this._getRingWeightOffset(this.chart.data.datasets.length)||1}}St(zn,"id","doughnut"),St(zn,"defaults",{datasetElementType:!1,dataElementType:"arc",animation:{animateRotate:!0,animateScale:!1},animations:{numbers:{type:"number",properties:["circumference","endAngle","innerRadius","outerRadius","startAngle","x","y","offset","borderWidth","spacing"]}},cutout:"50%",rotation:0,circumference:360,radius:"100%",spacing:0,indexAxis:"r"}),St(zn,"descriptors",{_scriptable:t=>t!=="spacing",_indexable:t=>t!=="spacing"&&!t.startsWith("borderDash")&&!t.startsWith("hoverBorderDash")}),St(zn,"overrides",{aspectRatio:1,plugins:{legend:{labels:{generateLabels(t){const e=t.data;if(e.labels.length&&e.datasets.length){const{labels:{pointStyle:i,color:o}}=t.legend.options;return e.labels.map((a,s)=>{const l=t.getDatasetMeta(0).controller.getStyle(s);return{text:a,fillStyle:l.backgroundColor,strokeStyle:l.borderColor,fontColor:o,lineWidth:l.borderWidth,pointStyle:i,hidden:!t.getDataVisibility(s),index:s}})}return[]}},onClick(t,e,i){i.chart.toggleDataVisibility(e.index),i.chart.update()}}}});class to extends tn{initialize(){this.enableOptionSharing=!0,this.supportsDecimation=!0,super.initialize()}update(t){const e=this._cachedMeta,{dataset:i,data:o=[],_dataset:a}=e,s=this.chart._animationsDisabled;let{start:r,count:l}=rr(e,o,s);this._drawStart=r,this._drawCount=l,lr(e)&&(r=0,l=o.length),i._chart=this.chart,i._datasetIndex=this.index,i._decimated=!!a._decimated,i.points=o;const c=this.resolveDatasetElementOptions(t);this.options.showLine||(c.borderWidth=0),c.segment=this.options.segment,this.updateElement(i,void 0,{animated:!s,options:c},t),this.updateElements(o,r,l,t)}updateElements(t,e,i,o){const a=o==="reset",{iScale:s,vScale:r,_stacked:l,_dataset:c}=this._cachedMeta,{sharedOptions:d,includeOptions:u}=this._getSharedOptions(e,o),p=s.axis,f=r.axis,{spanGaps:b,segment:v}=this.options,y=Qn(b)?b:Number.POSITIVE_INFINITY,E=this.chart._animationsDisabled||a||o==="none",M=e+i,X=t.length;let it=e>0&&this.getParsed(e-1);for(let Q=0;Q<X;++Q){const ft=t[Q],ut=E?ft:{};if(Q<e||Q>=M){ut.skip=!0;continue}const ct=this.getParsed(Q),It=ne(ct[f]),Ot=ut[p]=s.getPixelForValue(ct[p],Q),Ut=ut[f]=a||It?r.getBasePixel():r.getPixelForValue(l?this.applyStack(r,ct,l):ct[f],Q);ut.skip=isNaN(Ot)||isNaN(Ut)||It,ut.stop=Q>0&&Math.abs(ct[p]-it[p])>y,v&&(ut.parsed=ct,ut.raw=c.data[Q]),u&&(ut.options=d||this.resolveDataElementOptions(Q,ft.active?"active":o)),E||this.updateElement(ft,Q,ut,o),it=ct}}getMaxOverflow(){const t=this._cachedMeta,e=t.dataset,i=e.options&&e.options.borderWidth||0,o=t.data||[];if(!o.length)return i;const a=o[0].size(this.resolveDataElementOptions(0)),s=o[o.length-1].size(this.resolveDataElementOptions(o.length-1));return Math.max(i,a,s)/2}draw(){const t=this._cachedMeta;t.dataset.updateControlPoints(this.chart.chartArea,t.iScale.axis),super.draw()}}St(to,"id","line"),St(to,"defaults",{datasetElementType:"line",dataElementType:"point",showLine:!0,spanGaps:!1}),St(to,"overrides",{scales:{_index_:{type:"category"},_value_:{type:"linear"}}});class Si extends tn{constructor(t,e){super(t,e),this.innerRadius=void 0,this.outerRadius=void 0}getLabelAndValue(t){const e=this._cachedMeta,i=this.chart,o=i.data.labels||[],a=Bi(e._parsed[t].r,i.options.locale);return{label:o[t]||"",value:a}}parseObjectData(t,e,i,o){return mr.bind(this)(t,e,i,o)}update(t){const e=this._cachedMeta.data;this._updateRadius(),this.updateElements(e,0,e.length,t)}getMinMax(){const t=this._cachedMeta,e={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};return t.data.forEach((i,o)=>{const a=this.getParsed(o).r;!isNaN(a)&&this.chart.getDataVisibility(o)&&(a<e.min&&(e.min=a),a>e.max&&(e.max=a))}),e}_updateRadius(){const t=this.chart,e=t.chartArea,i=t.options,o=Math.min(e.right-e.left,e.bottom-e.top),a=Math.max(o/2,0),s=Math.max(i.cutoutPercentage?a/100*i.cutoutPercentage:1,0),r=(a-s)/t.getVisibleDatasetCount();this.outerRadius=a-r*this.index,this.innerRadius=this.outerRadius-r}updateElements(t,e,i,o){const a=o==="reset",s=this.chart,l=s.options.animation,c=this._cachedMeta.rScale,d=c.xCenter,u=c.yCenter,p=c.getIndexAngle(0)-.5*de;let f=p,b;const v=360/this.countVisibleElements();for(b=0;b<e;++b)f+=this._computeAngle(b,o,v);for(b=e;b<e+i;b++){const y=t[b];let E=f,M=f+this._computeAngle(b,o,v),X=s.getDataVisibility(b)?c.getDistanceFromCenterForValue(this.getParsed(b).r):0;f=M,a&&(l.animateScale&&(X=0),l.animateRotate&&(E=M=p));const it={x:d,y:u,innerRadius:0,outerRadius:X,startAngle:E,endAngle:M,options:this.resolveDataElementOptions(b,y.active?"active":o)};this.updateElement(y,b,it,o)}}countVisibleElements(){const t=this._cachedMeta;let e=0;return t.data.forEach((i,o)=>{!isNaN(this.getParsed(o).r)&&this.chart.getDataVisibility(o)&&e++}),e}_computeAngle(t,e,i){return this.chart.getDataVisibility(t)?Qe(this.resolveDataElementOptions(t,e).angle||i):0}}St(Si,"id","polarArea"),St(Si,"defaults",{dataElementType:"arc",animation:{animateRotate:!0,animateScale:!0},animations:{numbers:{type:"number",properties:["x","y","startAngle","endAngle","innerRadius","outerRadius"]}},indexAxis:"r",startAngle:0}),St(Si,"overrides",{aspectRatio:1,plugins:{legend:{labels:{generateLabels(t){const e=t.data;if(e.labels.length&&e.datasets.length){const{labels:{pointStyle:i,color:o}}=t.legend.options;return e.labels.map((a,s)=>{const l=t.getDatasetMeta(0).controller.getStyle(s);return{text:a,fillStyle:l.backgroundColor,strokeStyle:l.borderColor,fontColor:o,lineWidth:l.borderWidth,pointStyle:i,hidden:!t.getDataVisibility(s),index:s}})}return[]}},onClick(t,e,i){i.chart.toggleDataVisibility(e.index),i.chart.update()}}},scales:{r:{type:"radialLinear",angleLines:{display:!1},beginAtZero:!0,grid:{circular:!0},pointLabels:{display:!1},startAngle:0}}});class Go extends zn{}St(Go,"id","pie"),St(Go,"defaults",{cutout:0,rotation:0,circumference:360,radius:"100%"});class eo extends tn{getLabelAndValue(t){const e=this._cachedMeta.vScale,i=this.getParsed(t);return{label:e.getLabels()[t],value:""+e.getLabelForValue(i[e.axis])}}parseObjectData(t,e,i,o){return mr.bind(this)(t,e,i,o)}update(t){const e=this._cachedMeta,i=e.dataset,o=e.data||[],a=e.iScale.getLabels();if(i.points=o,t!=="resize"){const s=this.resolveDatasetElementOptions(t);this.options.showLine||(s.borderWidth=0);const r={_loop:!0,_fullLoop:a.length===o.length,options:s};this.updateElement(i,void 0,r,t)}this.updateElements(o,0,o.length,t)}updateElements(t,e,i,o){const a=this._cachedMeta.rScale,s=o==="reset";for(let r=e;r<e+i;r++){const l=t[r],c=this.resolveDataElementOptions(r,l.active?"active":o),d=a.getPointPositionForValue(r,this.getParsed(r).r),u=s?a.xCenter:d.x,p=s?a.yCenter:d.y,f={x:u,y:p,angle:d.angle,skip:isNaN(u)||isNaN(p),options:c};this.updateElement(l,r,f,o)}}}St(eo,"id","radar"),St(eo,"defaults",{datasetElementType:"line",dataElementType:"point",indexAxis:"r",showLine:!0,elements:{line:{fill:"start"}}}),St(eo,"overrides",{aspectRatio:1,scales:{r:{type:"radialLinear"}}});class no extends tn{getLabelAndValue(t){const e=this._cachedMeta,i=this.chart.data.labels||[],{xScale:o,yScale:a}=e,s=this.getParsed(t),r=o.getLabelForValue(s.x),l=a.getLabelForValue(s.y);return{label:i[t]||"",value:"("+r+", "+l+")"}}update(t){const e=this._cachedMeta,{data:i=[]}=e,o=this.chart._animationsDisabled;let{start:a,count:s}=rr(e,i,o);if(this._drawStart=a,this._drawCount=s,lr(e)&&(a=0,s=i.length),this.options.showLine){this.datasetElementType||this.addElements();const{dataset:r,_dataset:l}=e;r._chart=this.chart,r._datasetIndex=this.index,r._decimated=!!l._decimated,r.points=i;const c=this.resolveDatasetElementOptions(t);c.segment=this.options.segment,this.updateElement(r,void 0,{animated:!o,options:c},t)}else this.datasetElementType&&(delete e.dataset,this.datasetElementType=!1);this.updateElements(i,a,s,t)}addElements(){const{showLine:t}=this.options;!this.datasetElementType&&t&&(this.datasetElementType=this.chart.registry.getElement("line")),super.addElements()}updateElements(t,e,i,o){const a=o==="reset",{iScale:s,vScale:r,_stacked:l,_dataset:c}=this._cachedMeta,d=this.resolveDataElementOptions(e,o),u=this.getSharedOptions(d),p=this.includeOptions(o,u),f=s.axis,b=r.axis,{spanGaps:v,segment:y}=this.options,E=Qn(v)?v:Number.POSITIVE_INFINITY,M=this.chart._animationsDisabled||a||o==="none";let X=e>0&&this.getParsed(e-1);for(let it=e;it<e+i;++it){const Q=t[it],ft=this.getParsed(it),ut=M?Q:{},ct=ne(ft[b]),It=ut[f]=s.getPixelForValue(ft[f],it),Ot=ut[b]=a||ct?r.getBasePixel():r.getPixelForValue(l?this.applyStack(r,ft,l):ft[b],it);ut.skip=isNaN(It)||isNaN(Ot)||ct,ut.stop=it>0&&Math.abs(ft[f]-X[f])>E,y&&(ut.parsed=ft,ut.raw=c.data[it]),p&&(ut.options=u||this.resolveDataElementOptions(it,Q.active?"active":o)),M||this.updateElement(Q,it,ut,o),X=ft}this.updateSharedOptions(u,o,d)}getMaxOverflow(){const t=this._cachedMeta,e=t.data||[];if(!this.options.showLine){let r=0;for(let l=e.length-1;l>=0;--l)r=Math.max(r,e[l].size(this.resolveDataElementOptions(l))/2);return r>0&&r}const i=t.dataset,o=i.options&&i.options.borderWidth||0;if(!e.length)return o;const a=e[0].size(this.resolveDataElementOptions(0)),s=e[e.length-1].size(this.resolveDataElementOptions(e.length-1));return Math.max(o,a,s)/2}}St(no,"id","scatter"),St(no,"defaults",{datasetElementType:!1,dataElementType:"point",showLine:!1,fill:!1}),St(no,"overrides",{interaction:{mode:"point"},scales:{x:{type:"linear"},y:{type:"linear"}}});var xd=Object.freeze({__proto__:null,BarController:Zi,BubbleController:Qi,DoughnutController:zn,LineController:to,PieController:Go,PolarAreaController:Si,RadarController:eo,ScatterController:no});function Ln(){throw new Error("This method is not implemented: Check that a complete date adapter is provided.")}class wa{constructor(t){St(this,"options");this.options=t||{}}static override(t){Object.assign(wa.prototype,t)}init(){}formats(){return Ln()}parse(){return Ln()}format(){return Ln()}add(){return Ln()}diff(){return Ln()}startOf(){return Ln()}endOf(){return Ln()}}var wd={_date:wa};function _d(n,t,e,i){const{controller:o,data:a,_sorted:s}=n,r=o._cachedMeta.iScale,l=n.dataset&&n.dataset.options?n.dataset.options.spanGaps:null;if(r&&t===r.axis&&t!=="r"&&s&&a.length){const c=r._reversePixels?Wl:bn;if(i){if(o._sharedOptions){const d=a[0],u=typeof d.getRange=="function"&&d.getRange(t);if(u){const p=c(a,t,e-u),f=c(a,t,e+u);return{lo:p.lo,hi:f.hi}}}}else{const d=c(a,t,e);if(l){const{vScale:u}=o._cachedMeta,{_parsed:p}=n,f=p.slice(0,d.lo+1).reverse().findIndex(v=>!ne(v[u.axis]));d.lo-=Math.max(0,f);const b=p.slice(d.hi).findIndex(v=>!ne(v[u.axis]));d.hi+=Math.max(0,b)}return d}}return{lo:0,hi:a.length-1}}function So(n,t,e,i,o){const a=n.getSortedVisibleDatasetMetas(),s=e[t];for(let r=0,l=a.length;r<l;++r){const{index:c,data:d}=a[r],{lo:u,hi:p}=_d(a[r],t,s,o);for(let f=u;f<=p;++f){const b=d[f];b.skip||i(b,c,f)}}}function Sd(n){const t=n.indexOf("x")!==-1,e=n.indexOf("y")!==-1;return function(i,o){const a=t?Math.abs(i.x-o.x):0,s=e?Math.abs(i.y-o.y):0;return Math.sqrt(Math.pow(a,2)+Math.pow(s,2))}}function No(n,t,e,i,o){const a=[];return!o&&!n.isPointInArea(t)||So(n,e,t,function(r,l,c){!o&&!yn(r,n.chartArea,0)||r.inRange(t.x,t.y,i)&&a.push({element:r,datasetIndex:l,index:c})},!0),a}function kd(n,t,e,i){let o=[];function a(s,r,l){const{startAngle:c,endAngle:d}=s.getProps(["startAngle","endAngle"],i),{angle:u}=nr(s,{x:t.x,y:t.y});Ii(u,c,d)&&o.push({element:s,datasetIndex:r,index:l})}return So(n,e,t,a),o}function Cd(n,t,e,i,o,a){let s=[];const r=Sd(e);let l=Number.POSITIVE_INFINITY;function c(d,u,p){const f=d.inRange(t.x,t.y,o);if(i&&!f)return;const b=d.getCenterPoint(o);if(!(!!a||n.isPointInArea(b))&&!f)return;const y=r(t,b);y<l?(s=[{element:d,datasetIndex:u,index:p}],l=y):y===l&&s.push({element:d,datasetIndex:u,index:p})}return So(n,e,t,c),s}function Fo(n,t,e,i,o,a){return!a&&!n.isPointInArea(t)?[]:e==="r"&&!i?kd(n,t,e,o):Cd(n,t,e,i,o,a)}function ns(n,t,e,i,o){const a=[],s=e==="x"?"inXRange":"inYRange";let r=!1;return So(n,e,t,(l,c,d)=>{l[s]&&l[s](t[e],o)&&(a.push({element:l,datasetIndex:c,index:d}),r=r||l.inRange(t.x,t.y,o))}),i&&!r?[]:a}var Ed={modes:{index(n,t,e,i){const o=Fn(t,n),a=e.axis||"x",s=e.includeInvisible||!1,r=e.intersect?No(n,o,a,i,s):Fo(n,o,a,!1,i,s),l=[];return r.length?(n.getSortedVisibleDatasetMetas().forEach(c=>{const d=r[0].index,u=c.data[d];u&&!u.skip&&l.push({element:u,datasetIndex:c.index,index:d})}),l):[]},dataset(n,t,e,i){const o=Fn(t,n),a=e.axis||"xy",s=e.includeInvisible||!1;let r=e.intersect?No(n,o,a,i,s):Fo(n,o,a,!1,i,s);if(r.length>0){const l=r[0].datasetIndex,c=n.getDatasetMeta(l).data;r=[];for(let d=0;d<c.length;++d)r.push({element:c[d],datasetIndex:l,index:d})}return r},point(n,t,e,i){const o=Fn(t,n),a=e.axis||"xy",s=e.includeInvisible||!1;return No(n,o,a,i,s)},nearest(n,t,e,i){const o=Fn(t,n),a=e.axis||"xy",s=e.includeInvisible||!1;return Fo(n,o,a,e.intersect,i,s)},x(n,t,e,i){const o=Fn(t,n);return ns(n,o,"x",e.intersect,i)},y(n,t,e,i){const o=Fn(t,n);return ns(n,o,"y",e.intersect,i)}}};const Ir=["left","top","right","bottom"];function si(n,t){return n.filter(e=>e.pos===t)}function is(n,t){return n.filter(e=>Ir.indexOf(e.pos)===-1&&e.box.axis===t)}function ri(n,t){return n.sort((e,i)=>{const o=t?i:e,a=t?e:i;return o.weight===a.weight?o.index-a.index:o.weight-a.weight})}function Id(n){const t=[];let e,i,o,a,s,r;for(e=0,i=(n||[]).length;e<i;++e)o=n[e],{position:a,options:{stack:s,stackWeight:r=1}}=o,t.push({index:e,box:o,pos:a,horizontal:o.isHorizontal(),weight:o.weight,stack:s&&a+s,stackWeight:r});return t}function Dd(n){const t={};for(const e of n){const{stack:i,pos:o,stackWeight:a}=e;if(!i||!Ir.includes(o))continue;const s=t[i]||(t[i]={count:0,placed:0,weight:0,size:0});s.count++,s.weight+=a}return t}function Td(n,t){const e=Dd(n),{vBoxMaxWidth:i,hBoxMaxHeight:o}=t;let a,s,r;for(a=0,s=n.length;a<s;++a){r=n[a];const{fullSize:l}=r.box,c=e[r.stack],d=c&&r.stackWeight/c.weight;r.horizontal?(r.width=d?d*i:l&&t.availableWidth,r.height=o):(r.width=i,r.height=d?d*o:l&&t.availableHeight)}return e}function Md(n){const t=Id(n),e=ri(t.filter(c=>c.box.fullSize),!0),i=ri(si(t,"left"),!0),o=ri(si(t,"right")),a=ri(si(t,"top"),!0),s=ri(si(t,"bottom")),r=is(t,"x"),l=is(t,"y");return{fullSize:e,leftAndTop:i.concat(a),rightAndBottom:o.concat(l).concat(s).concat(r),chartArea:si(t,"chartArea"),vertical:i.concat(o).concat(l),horizontal:a.concat(s).concat(r)}}function os(n,t,e,i){return Math.max(n[e],t[e])+Math.max(n[i],t[i])}function Dr(n,t){n.top=Math.max(n.top,t.top),n.left=Math.max(n.left,t.left),n.bottom=Math.max(n.bottom,t.bottom),n.right=Math.max(n.right,t.right)}function Pd(n,t,e,i){const{pos:o,box:a}=e,s=n.maxPadding;if(!ie(o)){e.size&&(n[o]-=e.size);const u=i[e.stack]||{size:0,count:1};u.size=Math.max(u.size,e.horizontal?a.height:a.width),e.size=u.size/u.count,n[o]+=e.size}a.getPadding&&Dr(s,a.getPadding());const r=Math.max(0,t.outerWidth-os(s,n,"left","right")),l=Math.max(0,t.outerHeight-os(s,n,"top","bottom")),c=r!==n.w,d=l!==n.h;return n.w=r,n.h=l,e.horizontal?{same:c,other:d}:{same:d,other:c}}function Ad(n){const t=n.maxPadding;function e(i){const o=Math.max(t[i]-n[i],0);return n[i]+=o,o}n.y+=e("top"),n.x+=e("left"),e("right"),e("bottom")}function Bd(n,t){const e=t.maxPadding;function i(o){const a={left:0,top:0,right:0,bottom:0};return o.forEach(s=>{a[s]=Math.max(t[s],e[s])}),a}return i(n?["left","right"]:["top","bottom"])}function fi(n,t,e,i){const o=[];let a,s,r,l,c,d;for(a=0,s=n.length,c=0;a<s;++a){r=n[a],l=r.box,l.update(r.width||t.w,r.height||t.h,Bd(r.horizontal,t));const{same:u,other:p}=Pd(t,e,r,i);c|=u&&o.length,d=d||p,l.fullSize||o.push(r)}return c&&fi(o,t,e,i)||d}function Ui(n,t,e,i,o){n.top=e,n.left=t,n.right=t+i,n.bottom=e+o,n.width=i,n.height=o}function as(n,t,e,i){const o=e.padding;let{x:a,y:s}=t;for(const r of n){const l=r.box,c=i[r.stack]||{placed:0,weight:1},d=r.stackWeight/c.weight||1;if(r.horizontal){const u=t.w*d,p=c.size||l.height;Ei(c.start)&&(s=c.start),l.fullSize?Ui(l,o.left,s,e.outerWidth-o.right-o.left,p):Ui(l,t.left+c.placed,s,u,p),c.start=s,c.placed+=u,s=l.bottom}else{const u=t.h*d,p=c.size||l.width;Ei(c.start)&&(a=c.start),l.fullSize?Ui(l,a,o.top,p,e.outerHeight-o.bottom-o.top):Ui(l,a,t.top+c.placed,p,u),c.start=a,c.placed+=u,a=l.right}}t.x=a,t.y=s}var Re={addBox(n,t){n.boxes||(n.boxes=[]),t.fullSize=t.fullSize||!1,t.position=t.position||"top",t.weight=t.weight||0,t._layers=t._layers||function(){return[{z:0,draw(e){t.draw(e)}}]},n.boxes.push(t)},removeBox(n,t){const e=n.boxes?n.boxes.indexOf(t):-1;e!==-1&&n.boxes.splice(e,1)},configure(n,t,e){t.fullSize=e.fullSize,t.position=e.position,t.weight=e.weight},update(n,t,e,i){if(!n)return;const o=ze(n.options.layout.padding),a=Math.max(t-o.width,0),s=Math.max(e-o.height,0),r=Md(n.boxes),l=r.vertical,c=r.horizontal;fe(n.boxes,v=>{typeof v.beforeLayout=="function"&&v.beforeLayout()});const d=l.reduce((v,y)=>y.box.options&&y.box.options.display===!1?v:v+1,0)||1,u=Object.freeze({outerWidth:t,outerHeight:e,padding:o,availableWidth:a,availableHeight:s,vBoxMaxWidth:a/2/d,hBoxMaxHeight:s/2}),p=Object.assign({},o);Dr(p,ze(i));const f=Object.assign({maxPadding:p,w:a,h:s,x:o.left,y:o.top},o),b=Td(l.concat(c),u);fi(r.fullSize,f,u,b),fi(l,f,u,b),fi(c,f,u,b)&&fi(l,f,u,b),Ad(f),as(r.leftAndTop,f,u,b),f.x+=f.w,f.y+=f.h,as(r.rightAndBottom,f,u,b),n.chartArea={left:f.left,top:f.top,right:f.left+f.w,bottom:f.top+f.h,height:f.h,width:f.w},fe(r.chartArea,v=>{const y=v.box;Object.assign(y,n.chartArea),y.update(f.w,f.h,{left:0,top:0,right:0,bottom:0})})}};class Tr{acquireContext(t,e){}releaseContext(t){return!1}addEventListener(t,e,i){}removeEventListener(t,e,i){}getDevicePixelRatio(){return 1}getMaximumSize(t,e,i,o){return e=Math.max(0,e||t.width),i=i||t.height,{width:e,height:Math.max(0,o?Math.floor(e/o):i)}}isAttached(t){return!0}updateConfig(t){}}class Ld extends Tr{acquireContext(t){return t&&t.getContext&&t.getContext("2d")||null}updateConfig(t){t.options.animation=!1}}const io="$chartjs",Od={touchstart:"mousedown",touchmove:"mousemove",touchend:"mouseup",pointerenter:"mouseenter",pointerdown:"mousedown",pointermove:"mousemove",pointerup:"mouseup",pointerleave:"mouseout",pointerout:"mouseout"},ss=n=>n===null||n==="";function Nd(n,t){const e=n.style,i=n.getAttribute("height"),o=n.getAttribute("width");if(n[io]={initial:{height:i,width:o,style:{display:e.display,height:e.height,width:e.width}}},e.display=e.display||"block",e.boxSizing=e.boxSizing||"border-box",ss(o)){const a=ja(n,"width");a!==void 0&&(n.width=a)}if(ss(i))if(n.style.height==="")n.height=n.width/(t||2);else{const a=ja(n,"height");a!==void 0&&(n.height=a)}return n}const Mr=Fc?{passive:!0}:!1;function Fd(n,t,e){n&&n.addEventListener(t,e,Mr)}function Rd(n,t,e){n&&n.canvas&&n.canvas.removeEventListener(t,e,Mr)}function zd(n,t){const e=Od[n.type]||n.type,{x:i,y:o}=Fn(n,t);return{type:e,chart:t,native:n,x:i!==void 0?i:null,y:o!==void 0?o:null}}function ho(n,t){for(const e of n)if(e===t||e.contains(t))return!0}function Vd(n,t,e){const i=n.canvas,o=new MutationObserver(a=>{let s=!1;for(const r of a)s=s||ho(r.addedNodes,i),s=s&&!ho(r.removedNodes,i);s&&e()});return o.observe(document,{childList:!0,subtree:!0}),o}function Ud(n,t,e){const i=n.canvas,o=new MutationObserver(a=>{let s=!1;for(const r of a)s=s||ho(r.removedNodes,i),s=s&&!ho(r.addedNodes,i);s&&e()});return o.observe(document,{childList:!0,subtree:!0}),o}const Ti=new Map;let rs=0;function Pr(){const n=window.devicePixelRatio;n!==rs&&(rs=n,Ti.forEach((t,e)=>{e.currentDevicePixelRatio!==n&&t()}))}function Hd(n,t){Ti.size||window.addEventListener("resize",Pr),Ti.set(n,t)}function jd(n){Ti.delete(n),Ti.size||window.removeEventListener("resize",Pr)}function Wd(n,t,e){const i=n.canvas,o=i&&xa(i);if(!o)return;const a=sr((r,l)=>{const c=o.clientWidth;e(r,l),c<o.clientWidth&&e()},window),s=new ResizeObserver(r=>{const l=r[0],c=l.contentRect.width,d=l.contentRect.height;c===0&&d===0||a(c,d)});return s.observe(o),Hd(n,a),s}function Ro(n,t,e){e&&e.disconnect(),t==="resize"&&jd(n)}function Yd(n,t,e){const i=n.canvas,o=sr(a=>{n.ctx!==null&&e(zd(a,n))},n);return Fd(i,t,o),o}class $d extends Tr{acquireContext(t,e){const i=t&&t.getContext&&t.getContext("2d");return i&&i.canvas===t?(Nd(t,e),i):null}releaseContext(t){const e=t.canvas;if(!e[io])return!1;const i=e[io].initial;["height","width"].forEach(a=>{const s=i[a];ne(s)?e.removeAttribute(a):e.setAttribute(a,s)});const o=i.style||{};return Object.keys(o).forEach(a=>{e.style[a]=o[a]}),e.width=e.width,delete e[io],!0}addEventListener(t,e,i){this.removeEventListener(t,e);const o=t.$proxies||(t.$proxies={}),s={attach:Vd,detach:Ud,resize:Wd}[e]||Yd;o[e]=s(t,e,i)}removeEventListener(t,e){const i=t.$proxies||(t.$proxies={}),o=i[e];if(!o)return;({attach:Ro,detach:Ro,resize:Ro}[e]||Rd)(t,e,o),i[e]=void 0}getDevicePixelRatio(){return window.devicePixelRatio}getMaximumSize(t,e,i,o){return Nc(t,e,i,o)}isAttached(t){const e=t&&xa(t);return!!(e&&e.isConnected)}}function qd(n){return!ya()||typeof OffscreenCanvas<"u"&&n instanceof OffscreenCanvas?Ld:$d}class en{constructor(){St(this,"x");St(this,"y");St(this,"active",!1);St(this,"options");St(this,"$animations")}tooltipPosition(t){const{x:e,y:i}=this.getProps(["x","y"],t);return{x:e,y:i}}hasValue(){return Qn(this.x)&&Qn(this.y)}getProps(t,e){const i=this.$animations;if(!e||!i)return this;const o={};return t.forEach(a=>{o[a]=i[a]&&i[a].active()?i[a]._to:this[a]}),o}}St(en,"defaults",{}),St(en,"defaultRoutes");function Gd(n,t){const e=n.options.ticks,i=Xd(n),o=Math.min(e.maxTicksLimit||i,i),a=e.major.enabled?Jd(t):[],s=a.length,r=a[0],l=a[s-1],c=[];if(s>o)return Zd(t,c,a,s/o),c;const d=Kd(a,t,o);if(s>0){let u,p;const f=s>1?Math.round((l-r)/(s-1)):null;for(Hi(t,c,d,ne(f)?0:r-f,r),u=0,p=s-1;u<p;u++)Hi(t,c,d,a[u],a[u+1]);return Hi(t,c,d,l,ne(f)?t.length:l+f),c}return Hi(t,c,d),c}function Xd(n){const t=n.options.offset,e=n._tickSize(),i=n._length/e+(t?0:1),o=n._maxLength/e;return Math.floor(Math.min(i,o))}function Kd(n,t,e){const i=Qd(n),o=t.length/e;if(!i)return Math.max(o,1);const a=zl(i);for(let s=0,r=a.length-1;s<r;s++){const l=a[s];if(l>o)return l}return Math.max(o,1)}function Jd(n){const t=[];let e,i;for(e=0,i=n.length;e<i;e++)n[e].major&&t.push(e);return t}function Zd(n,t,e,i){let o=0,a=e[0],s;for(i=Math.ceil(i),s=0;s<n.length;s++)s===a&&(t.push(n[s]),o++,a=e[o*i])}function Hi(n,t,e,i,o){const a=Xt(i,0),s=Math.min(Xt(o,n.length),n.length);let r=0,l,c,d;for(e=Math.ceil(e),o&&(l=o-i,e=l/Math.floor(l/e)),d=a;d<0;)r++,d=Math.round(a+r*e);for(c=Math.max(a,0);c<s;c++)c===d&&(t.push(n[c]),r++,d=Math.round(a+r*e))}function Qd(n){const t=n.length;let e,i;if(t<2)return!1;for(i=n[0],e=1;e<t;++e)if(n[e]-n[e-1]!==i)return!1;return i}const tu=n=>n==="left"?"right":n==="right"?"left":n,ls=(n,t,e)=>t==="top"||t==="left"?n[t]+e:n[t]-e,cs=(n,t)=>Math.min(t||n,n);function ds(n,t){const e=[],i=n.length/t,o=n.length;let a=0;for(;a<o;a+=i)e.push(n[Math.floor(a)]);return e}function eu(n,t,e){const i=n.ticks.length,o=Math.min(t,i-1),a=n._startPixel,s=n._endPixel,r=1e-6;let l=n.getPixelForTick(o),c;if(!(e&&(i===1?c=Math.max(l-a,s-l):t===0?c=(n.getPixelForTick(1)-l)/2:c=(l-n.getPixelForTick(o-1))/2,l+=o<t?c:-c,l<a-r||l>s+r)))return l}function nu(n,t){fe(n,e=>{const i=e.gc,o=i.length/2;let a;if(o>t){for(a=0;a<o;++a)delete e.data[i[a]];i.splice(0,o)}})}function li(n){return n.drawTicks?n.tickLength:0}function us(n,t){if(!n.display)return 0;const e=Me(n.font,t),i=ze(n.padding);return(ve(n.text)?n.text.length:1)*e.lineHeight+i.height}function iu(n,t){return Mn(n,{scale:t,type:"scale"})}function ou(n,t,e){return Mn(n,{tick:e,index:t,type:"tick"})}function au(n,t,e){let i=fa(n);return(e&&t!=="right"||!e&&t==="right")&&(i=tu(i)),i}function su(n,t,e,i){const{top:o,left:a,bottom:s,right:r,chart:l}=n,{chartArea:c,scales:d}=l;let u=0,p,f,b;const v=s-o,y=r-a;if(n.isHorizontal()){if(f=Ne(i,a,r),ie(e)){const E=Object.keys(e)[0],M=e[E];b=d[E].getPixelForValue(M)+v-t}else e==="center"?b=(c.bottom+c.top)/2+v-t:b=ls(n,e,t);p=r-a}else{if(ie(e)){const E=Object.keys(e)[0],M=e[E];f=d[E].getPixelForValue(M)-y+t}else e==="center"?f=(c.left+c.right)/2-y+t:f=ls(n,e,t);b=Ne(i,s,o),u=e==="left"?-ke:ke}return{titleX:f,titleY:b,maxWidth:p,rotation:u}}class Wn extends en{constructor(t){super(),this.id=t.id,this.type=t.type,this.options=void 0,this.ctx=t.ctx,this.chart=t.chart,this.top=void 0,this.bottom=void 0,this.left=void 0,this.right=void 0,this.width=void 0,this.height=void 0,this._margins={left:0,right:0,top:0,bottom:0},this.maxWidth=void 0,this.maxHeight=void 0,this.paddingTop=void 0,this.paddingBottom=void 0,this.paddingLeft=void 0,this.paddingRight=void 0,this.axis=void 0,this.labelRotation=void 0,this.min=void 0,this.max=void 0,this._range=void 0,this.ticks=[],this._gridLineItems=null,this._labelItems=null,this._labelSizes=null,this._length=0,this._maxLength=0,this._longestTextCache={},this._startPixel=void 0,this._endPixel=void 0,this._reversePixels=!1,this._userMax=void 0,this._userMin=void 0,this._suggestedMax=void 0,this._suggestedMin=void 0,this._ticksLength=0,this._borderValue=0,this._cache={},this._dataLimitsCached=!1,this.$context=void 0}init(t){this.options=t.setContext(this.getContext()),this.axis=t.axis,this._userMin=this.parse(t.min),this._userMax=this.parse(t.max),this._suggestedMin=this.parse(t.suggestedMin),this._suggestedMax=this.parse(t.suggestedMax)}parse(t,e){return t}getUserBounds(){let{_userMin:t,_userMax:e,_suggestedMin:i,_suggestedMax:o}=this;return t=Xe(t,Number.POSITIVE_INFINITY),e=Xe(e,Number.NEGATIVE_INFINITY),i=Xe(i,Number.POSITIVE_INFINITY),o=Xe(o,Number.NEGATIVE_INFINITY),{min:Xe(t,i),max:Xe(e,o),minDefined:_e(t),maxDefined:_e(e)}}getMinMax(t){let{min:e,max:i,minDefined:o,maxDefined:a}=this.getUserBounds(),s;if(o&&a)return{min:e,max:i};const r=this.getMatchingVisibleMetas();for(let l=0,c=r.length;l<c;++l)s=r[l].controller.getMinMax(this,t),o||(e=Math.min(e,s.min)),a||(i=Math.max(i,s.max));return e=a&&e>i?i:e,i=o&&e>i?e:i,{min:Xe(e,Xe(i,e)),max:Xe(i,Xe(e,i))}}getPadding(){return{left:this.paddingLeft||0,top:this.paddingTop||0,right:this.paddingRight||0,bottom:this.paddingBottom||0}}getTicks(){return this.ticks}getLabels(){const t=this.chart.data;return this.options.labels||(this.isHorizontal()?t.xLabels:t.yLabels)||t.labels||[]}getLabelItems(t=this.chart.chartArea){return this._labelItems||(this._labelItems=this._computeLabelItems(t))}beforeLayout(){this._cache={},this._dataLimitsCached=!1}beforeUpdate(){ge(this.options.beforeUpdate,[this])}update(t,e,i){const{beginAtZero:o,grace:a,ticks:s}=this.options,r=s.sampleSize;this.beforeUpdate(),this.maxWidth=t,this.maxHeight=e,this._margins=i=Object.assign({left:0,right:0,top:0,bottom:0},i),this.ticks=null,this._labelSizes=null,this._gridLineItems=null,this._labelItems=null,this.beforeSetDimensions(),this.setDimensions(),this.afterSetDimensions(),this._maxLength=this.isHorizontal()?this.width+i.left+i.right:this.height+i.top+i.bottom,this._dataLimitsCached||(this.beforeDataLimits(),this.determineDataLimits(),this.afterDataLimits(),this._range=hc(this,a,o),this._dataLimitsCached=!0),this.beforeBuildTicks(),this.ticks=this.buildTicks()||[],this.afterBuildTicks();const l=r<this.ticks.length;this._convertTicksToLabels(l?ds(this.ticks,r):this.ticks),this.configure(),this.beforeCalculateLabelRotation(),this.calculateLabelRotation(),this.afterCalculateLabelRotation(),s.display&&(s.autoSkip||s.source==="auto")&&(this.ticks=Gd(this,this.ticks),this._labelSizes=null,this.afterAutoSkip()),l&&this._convertTicksToLabels(this.ticks),this.beforeFit(),this.fit(),this.afterFit(),this.afterUpdate()}configure(){let t=this.options.reverse,e,i;this.isHorizontal()?(e=this.left,i=this.right):(e=this.top,i=this.bottom,t=!t),this._startPixel=e,this._endPixel=i,this._reversePixels=t,this._length=i-e,this._alignToPixels=this.options.alignToPixels}afterUpdate(){ge(this.options.afterUpdate,[this])}beforeSetDimensions(){ge(this.options.beforeSetDimensions,[this])}setDimensions(){this.isHorizontal()?(this.width=this.maxWidth,this.left=0,this.right=this.width):(this.height=this.maxHeight,this.top=0,this.bottom=this.height),this.paddingLeft=0,this.paddingTop=0,this.paddingRight=0,this.paddingBottom=0}afterSetDimensions(){ge(this.options.afterSetDimensions,[this])}_callHooks(t){this.chart.notifyPlugins(t,this.getContext()),ge(this.options[t],[this])}beforeDataLimits(){this._callHooks("beforeDataLimits")}determineDataLimits(){}afterDataLimits(){this._callHooks("afterDataLimits")}beforeBuildTicks(){this._callHooks("beforeBuildTicks")}buildTicks(){return[]}afterBuildTicks(){this._callHooks("afterBuildTicks")}beforeTickToLabelConversion(){ge(this.options.beforeTickToLabelConversion,[this])}generateTickLabels(t){const e=this.options.ticks;let i,o,a;for(i=0,o=t.length;i<o;i++)a=t[i],a.label=ge(e.callback,[a.value,i,t],this)}afterTickToLabelConversion(){ge(this.options.afterTickToLabelConversion,[this])}beforeCalculateLabelRotation(){ge(this.options.beforeCalculateLabelRotation,[this])}calculateLabelRotation(){const t=this.options,e=t.ticks,i=cs(this.ticks.length,t.ticks.maxTicksLimit),o=e.minRotation||0,a=e.maxRotation;let s=o,r,l,c;if(!this._isVisible()||!e.display||o>=a||i<=1||!this.isHorizontal()){this.labelRotation=o;return}const d=this._getLabelSizes(),u=d.widest.width,p=d.highest.height,f=Ae(this.chart.width-u,0,this.maxWidth);r=t.offset?this.maxWidth/i:f/(i-1),u+6>r&&(r=f/(i-(t.offset?.5:1)),l=this.maxHeight-li(t.grid)-e.padding-us(t.title,this.chart.options.font),c=Math.sqrt(u*u+p*p),s=ua(Math.min(Math.asin(Ae((d.highest.height+6)/r,-1,1)),Math.asin(Ae(l/c,-1,1))-Math.asin(Ae(p/c,-1,1)))),s=Math.max(o,Math.min(a,s))),this.labelRotation=s}afterCalculateLabelRotation(){ge(this.options.afterCalculateLabelRotation,[this])}afterAutoSkip(){}beforeFit(){ge(this.options.beforeFit,[this])}fit(){const t={width:0,height:0},{chart:e,options:{ticks:i,title:o,grid:a}}=this,s=this._isVisible(),r=this.isHorizontal();if(s){const l=us(o,e.options.font);if(r?(t.width=this.maxWidth,t.height=li(a)+l):(t.height=this.maxHeight,t.width=li(a)+l),i.display&&this.ticks.length){const{first:c,last:d,widest:u,highest:p}=this._getLabelSizes(),f=i.padding*2,b=Qe(this.labelRotation),v=Math.cos(b),y=Math.sin(b);if(r){const E=i.mirror?0:y*u.width+v*p.height;t.height=Math.min(this.maxHeight,t.height+E+f)}else{const E=i.mirror?0:v*u.width+y*p.height;t.width=Math.min(this.maxWidth,t.width+E+f)}this._calculatePadding(c,d,y,v)}}this._handleMargins(),r?(this.width=this._length=e.width-this._margins.left-this._margins.right,this.height=t.height):(this.width=t.width,this.height=this._length=e.height-this._margins.top-this._margins.bottom)}_calculatePadding(t,e,i,o){const{ticks:{align:a,padding:s},position:r}=this.options,l=this.labelRotation!==0,c=r!=="top"&&this.axis==="x";if(this.isHorizontal()){const d=this.getPixelForTick(0)-this.left,u=this.right-this.getPixelForTick(this.ticks.length-1);let p=0,f=0;l?c?(p=o*t.width,f=i*e.height):(p=i*t.height,f=o*e.width):a==="start"?f=e.width:a==="end"?p=t.width:a!=="inner"&&(p=t.width/2,f=e.width/2),this.paddingLeft=Math.max((p-d+s)*this.width/(this.width-d),0),this.paddingRight=Math.max((f-u+s)*this.width/(this.width-u),0)}else{let d=e.height/2,u=t.height/2;a==="start"?(d=0,u=t.height):a==="end"&&(d=e.height,u=0),this.paddingTop=d+s,this.paddingBottom=u+s}}_handleMargins(){this._margins&&(this._margins.left=Math.max(this.paddingLeft,this._margins.left),this._margins.top=Math.max(this.paddingTop,this._margins.top),this._margins.right=Math.max(this.paddingRight,this._margins.right),this._margins.bottom=Math.max(this.paddingBottom,this._margins.bottom))}afterFit(){ge(this.options.afterFit,[this])}isHorizontal(){const{axis:t,position:e}=this.options;return e==="top"||e==="bottom"||t==="x"}isFullSize(){return this.options.fullSize}_convertTicksToLabels(t){this.beforeTickToLabelConversion(),this.generateTickLabels(t);let e,i;for(e=0,i=t.length;e<i;e++)ne(t[e].label)&&(t.splice(e,1),i--,e--);this.afterTickToLabelConversion()}_getLabelSizes(){let t=this._labelSizes;if(!t){const e=this.options.ticks.sampleSize;let i=this.ticks;e<i.length&&(i=ds(i,e)),this._labelSizes=t=this._computeLabelSizes(i,i.length,this.options.ticks.maxTicksLimit)}return t}_computeLabelSizes(t,e,i){const{ctx:o,_longestTextCache:a}=this,s=[],r=[],l=Math.floor(e/cs(e,i));let c=0,d=0,u,p,f,b,v,y,E,M,X,it,Q;for(u=0;u<e;u+=l){if(b=t[u].label,v=this._resolveTickFontOptions(u),o.font=y=v.string,E=a[y]=a[y]||{data:{},gc:[]},M=v.lineHeight,X=it=0,!ne(b)&&!ve(b))X=po(o,E.data,E.gc,X,b),it=M;else if(ve(b))for(p=0,f=b.length;p<f;++p)Q=b[p],!ne(Q)&&!ve(Q)&&(X=po(o,E.data,E.gc,X,Q),it+=M);s.push(X),r.push(it),c=Math.max(X,c),d=Math.max(it,d)}nu(a,e);const ft=s.indexOf(c),ut=r.indexOf(d),ct=It=>({width:s[It]||0,height:r[It]||0});return{first:ct(0),last:ct(e-1),widest:ct(ft),highest:ct(ut),widths:s,heights:r}}getLabelForValue(t){return t}getPixelForValue(t,e){return NaN}getValueForPixel(t){}getPixelForTick(t){const e=this.ticks;return t<0||t>e.length-1?null:this.getPixelForValue(e[t].value)}getPixelForDecimal(t){this._reversePixels&&(t=1-t);const e=this._startPixel+t*this._length;return jl(this._alignToPixels?Bn(this.chart,e,0):e)}getDecimalForPixel(t){const e=(t-this._startPixel)/this._length;return this._reversePixels?1-e:e}getBasePixel(){return this.getPixelForValue(this.getBaseValue())}getBaseValue(){const{min:t,max:e}=this;return t<0&&e<0?e:t>0&&e>0?t:0}getContext(t){const e=this.ticks||[];if(t>=0&&t<e.length){const i=e[t];return i.$context||(i.$context=ou(this.getContext(),t,i))}return this.$context||(this.$context=iu(this.chart.getContext(),this))}_tickSize(){const t=this.options.ticks,e=Qe(this.labelRotation),i=Math.abs(Math.cos(e)),o=Math.abs(Math.sin(e)),a=this._getLabelSizes(),s=t.autoSkipPadding||0,r=a?a.widest.width+s:0,l=a?a.highest.height+s:0;return this.isHorizontal()?l*i>r*o?r/i:l/o:l*o<r*i?l/i:r/o}_isVisible(){const t=this.options.display;return t!=="auto"?!!t:this.getMatchingVisibleMetas().length>0}_computeGridLineItems(t){const e=this.axis,i=this.chart,o=this.options,{grid:a,position:s,border:r}=o,l=a.offset,c=this.isHorizontal(),u=this.ticks.length+(l?1:0),p=li(a),f=[],b=r.setContext(this.getContext()),v=b.display?b.width:0,y=v/2,E=function(Zt){return Bn(i,Zt,v)};let M,X,it,Q,ft,ut,ct,It,Ot,Ut,Vt,Mt;if(s==="top")M=E(this.bottom),ut=this.bottom-p,It=M-y,Ut=E(t.top)+y,Mt=t.bottom;else if(s==="bottom")M=E(this.top),Ut=t.top,Mt=E(t.bottom)-y,ut=M+y,It=this.top+p;else if(s==="left")M=E(this.right),ft=this.right-p,ct=M-y,Ot=E(t.left)+y,Vt=t.right;else if(s==="right")M=E(this.left),Ot=t.left,Vt=E(t.right)-y,ft=M+y,ct=this.left+p;else if(e==="x"){if(s==="center")M=E((t.top+t.bottom)/2+.5);else if(ie(s)){const Zt=Object.keys(s)[0],ae=s[Zt];M=E(this.chart.scales[Zt].getPixelForValue(ae))}Ut=t.top,Mt=t.bottom,ut=M+y,It=ut+p}else if(e==="y"){if(s==="center")M=E((t.left+t.right)/2);else if(ie(s)){const Zt=Object.keys(s)[0],ae=s[Zt];M=E(this.chart.scales[Zt].getPixelForValue(ae))}ft=M-y,ct=ft-p,Ot=t.left,Vt=t.right}const $t=Xt(o.ticks.maxTicksLimit,u),Kt=Math.max(1,Math.ceil(u/$t));for(X=0;X<u;X+=Kt){const Zt=this.getContext(X),ae=a.setContext(Zt),Ce=r.setContext(Zt),re=ae.lineWidth,Se=ae.color,We=Ce.dash||[],Te=Ce.dashOffset,Ke=ae.tickWidth,Ve=ae.tickColor,Je=ae.tickBorderDash||[],k=ae.tickBorderDashOffset;it=eu(this,X,l),it!==void 0&&(Q=Bn(i,it,re),c?ft=ct=Ot=Vt=Q:ut=It=Ut=Mt=Q,f.push({tx1:ft,ty1:ut,tx2:ct,ty2:It,x1:Ot,y1:Ut,x2:Vt,y2:Mt,width:re,color:Se,borderDash:We,borderDashOffset:Te,tickWidth:Ke,tickColor:Ve,tickBorderDash:Je,tickBorderDashOffset:k}))}return this._ticksLength=u,this._borderValue=M,f}_computeLabelItems(t){const e=this.axis,i=this.options,{position:o,ticks:a}=i,s=this.isHorizontal(),r=this.ticks,{align:l,crossAlign:c,padding:d,mirror:u}=a,p=li(i.grid),f=p+d,b=u?-d:f,v=-Qe(this.labelRotation),y=[];let E,M,X,it,Q,ft,ut,ct,It,Ot,Ut,Vt,Mt="middle";if(o==="top")ft=this.bottom-b,ut=this._getXAxisLabelAlignment();else if(o==="bottom")ft=this.top+b,ut=this._getXAxisLabelAlignment();else if(o==="left"){const Kt=this._getYAxisLabelAlignment(p);ut=Kt.textAlign,Q=Kt.x}else if(o==="right"){const Kt=this._getYAxisLabelAlignment(p);ut=Kt.textAlign,Q=Kt.x}else if(e==="x"){if(o==="center")ft=(t.top+t.bottom)/2+f;else if(ie(o)){const Kt=Object.keys(o)[0],Zt=o[Kt];ft=this.chart.scales[Kt].getPixelForValue(Zt)+f}ut=this._getXAxisLabelAlignment()}else if(e==="y"){if(o==="center")Q=(t.left+t.right)/2-f;else if(ie(o)){const Kt=Object.keys(o)[0],Zt=o[Kt];Q=this.chart.scales[Kt].getPixelForValue(Zt)}ut=this._getYAxisLabelAlignment(p).textAlign}e==="y"&&(l==="start"?Mt="top":l==="end"&&(Mt="bottom"));const $t=this._getLabelSizes();for(E=0,M=r.length;E<M;++E){X=r[E],it=X.label;const Kt=a.setContext(this.getContext(E));ct=this.getPixelForTick(E)+a.labelOffset,It=this._resolveTickFontOptions(E),Ot=It.lineHeight,Ut=ve(it)?it.length:1;const Zt=Ut/2,ae=Kt.color,Ce=Kt.textStrokeColor,re=Kt.textStrokeWidth;let Se=ut;s?(Q=ct,ut==="inner"&&(E===M-1?Se=this.options.reverse?"left":"right":E===0?Se=this.options.reverse?"right":"left":Se="center"),o==="top"?c==="near"||v!==0?Vt=-Ut*Ot+Ot/2:c==="center"?Vt=-$t.highest.height/2-Zt*Ot+Ot:Vt=-$t.highest.height+Ot/2:c==="near"||v!==0?Vt=Ot/2:c==="center"?Vt=$t.highest.height/2-Zt*Ot:Vt=$t.highest.height-Ut*Ot,u&&(Vt*=-1),v!==0&&!Kt.showLabelBackdrop&&(Q+=Ot/2*Math.sin(v))):(ft=ct,Vt=(1-Ut)*Ot/2);let We;if(Kt.showLabelBackdrop){const Te=ze(Kt.backdropPadding),Ke=$t.heights[E],Ve=$t.widths[E];let Je=Vt-Te.top,k=0-Te.left;switch(Mt){case"middle":Je-=Ke/2;break;case"bottom":Je-=Ke;break}switch(ut){case"center":k-=Ve/2;break;case"right":k-=Ve;break;case"inner":E===M-1?k-=Ve:E>0&&(k-=Ve/2);break}We={left:k,top:Je,width:Ve+Te.width,height:Ke+Te.height,color:Kt.backdropColor}}y.push({label:it,font:It,textOffset:Vt,options:{rotation:v,color:ae,strokeColor:Ce,strokeWidth:re,textAlign:Se,textBaseline:Mt,translation:[Q,ft],backdrop:We}})}return y}_getXAxisLabelAlignment(){const{position:t,ticks:e}=this.options;if(-Qe(this.labelRotation))return t==="top"?"left":"right";let o="center";return e.align==="start"?o="left":e.align==="end"?o="right":e.align==="inner"&&(o="inner"),o}_getYAxisLabelAlignment(t){const{position:e,ticks:{crossAlign:i,mirror:o,padding:a}}=this.options,s=this._getLabelSizes(),r=t+a,l=s.widest.width;let c,d;return e==="left"?o?(d=this.right+a,i==="near"?c="left":i==="center"?(c="center",d+=l/2):(c="right",d+=l)):(d=this.right-r,i==="near"?c="right":i==="center"?(c="center",d-=l/2):(c="left",d=this.left)):e==="right"?o?(d=this.left+a,i==="near"?c="right":i==="center"?(c="center",d-=l/2):(c="left",d-=l)):(d=this.left+r,i==="near"?c="left":i==="center"?(c="center",d+=l/2):(c="right",d=this.right)):c="right",{textAlign:c,x:d}}_computeLabelArea(){if(this.options.ticks.mirror)return;const t=this.chart,e=this.options.position;if(e==="left"||e==="right")return{top:0,left:this.left,bottom:t.height,right:this.right};if(e==="top"||e==="bottom")return{top:this.top,left:0,bottom:this.bottom,right:t.width}}drawBackground(){const{ctx:t,options:{backgroundColor:e},left:i,top:o,width:a,height:s}=this;e&&(t.save(),t.fillStyle=e,t.fillRect(i,o,a,s),t.restore())}getLineWidthForValue(t){const e=this.options.grid;if(!this._isVisible()||!e.display)return 0;const o=this.ticks.findIndex(a=>a.value===t);return o>=0?e.setContext(this.getContext(o)).lineWidth:0}drawGrid(t){const e=this.options.grid,i=this.ctx,o=this._gridLineItems||(this._gridLineItems=this._computeGridLineItems(t));let a,s;const r=(l,c,d)=>{!d.width||!d.color||(i.save(),i.lineWidth=d.width,i.strokeStyle=d.color,i.setLineDash(d.borderDash||[]),i.lineDashOffset=d.borderDashOffset,i.beginPath(),i.moveTo(l.x,l.y),i.lineTo(c.x,c.y),i.stroke(),i.restore())};if(e.display)for(a=0,s=o.length;a<s;++a){const l=o[a];e.drawOnChartArea&&r({x:l.x1,y:l.y1},{x:l.x2,y:l.y2},l),e.drawTicks&&r({x:l.tx1,y:l.ty1},{x:l.tx2,y:l.ty2},{color:l.tickColor,width:l.tickWidth,borderDash:l.tickBorderDash,borderDashOffset:l.tickBorderDashOffset})}}drawBorder(){const{chart:t,ctx:e,options:{border:i,grid:o}}=this,a=i.setContext(this.getContext()),s=i.display?a.width:0;if(!s)return;const r=o.setContext(this.getContext(0)).lineWidth,l=this._borderValue;let c,d,u,p;this.isHorizontal()?(c=Bn(t,this.left,s)-s/2,d=Bn(t,this.right,r)+r/2,u=p=l):(u=Bn(t,this.top,s)-s/2,p=Bn(t,this.bottom,r)+r/2,c=d=l),e.save(),e.lineWidth=a.width,e.strokeStyle=a.color,e.beginPath(),e.moveTo(c,u),e.lineTo(d,p),e.stroke(),e.restore()}drawLabels(t){if(!this.options.ticks.display)return;const i=this.ctx,o=this._computeLabelArea();o&&xo(i,o);const a=this.getLabelItems(t);for(const s of a){const r=s.options,l=s.font,c=s.label,d=s.textOffset;jn(i,c,0,d,l,r)}o&&wo(i)}drawTitle(){const{ctx:t,options:{position:e,title:i,reverse:o}}=this;if(!i.display)return;const a=Me(i.font),s=ze(i.padding),r=i.align;let l=a.lineHeight/2;e==="bottom"||e==="center"||ie(e)?(l+=s.bottom,ve(i.text)&&(l+=a.lineHeight*(i.text.length-1))):l+=s.top;const{titleX:c,titleY:d,maxWidth:u,rotation:p}=su(this,l,e,r);jn(t,i.text,0,0,a,{color:i.color,maxWidth:u,rotation:p,textAlign:au(r,e,o),textBaseline:"middle",translation:[c,d]})}draw(t){this._isVisible()&&(this.drawBackground(),this.drawGrid(t),this.drawBorder(),this.drawTitle(),this.drawLabels(t))}_layers(){const t=this.options,e=t.ticks&&t.ticks.z||0,i=Xt(t.grid&&t.grid.z,-1),o=Xt(t.border&&t.border.z,0);return!this._isVisible()||this.draw!==Wn.prototype.draw?[{z:e,draw:a=>{this.draw(a)}}]:[{z:i,draw:a=>{this.drawBackground(),this.drawGrid(a),this.drawTitle()}},{z:o,draw:()=>{this.drawBorder()}},{z:e,draw:a=>{this.drawLabels(a)}}]}getMatchingVisibleMetas(t){const e=this.chart.getSortedVisibleDatasetMetas(),i=this.axis+"AxisID",o=[];let a,s;for(a=0,s=e.length;a<s;++a){const r=e[a];r[i]===this.id&&(!t||r.type===t)&&o.push(r)}return o}_resolveTickFontOptions(t){const e=this.options.ticks.setContext(this.getContext(t));return Me(e.font)}_maxDigits(){const t=this._resolveTickFontOptions(0).lineHeight;return(this.isHorizontal()?this.width:this.height)/t}}class ji{constructor(t,e,i){this.type=t,this.scope=e,this.override=i,this.items=Object.create(null)}isForType(t){return Object.prototype.isPrototypeOf.call(this.type.prototype,t.prototype)}register(t){const e=Object.getPrototypeOf(t);let i;cu(e)&&(i=this.register(e));const o=this.items,a=t.id,s=this.scope+"."+a;if(!a)throw new Error("class does not have id: "+t);return a in o||(o[a]=t,ru(t,s,i),this.override&&be.override(t.id,t.overrides)),s}get(t){return this.items[t]}unregister(t){const e=this.items,i=t.id,o=this.scope;i in e&&delete e[i],o&&i in be[o]&&(delete be[o][i],this.override&&delete Hn[i])}}function ru(n,t,e){const i=Ci(Object.create(null),[e?be.get(e):{},be.get(t),n.defaults]);be.set(t,i),n.defaultRoutes&&lu(t,n.defaultRoutes),n.descriptors&&be.describe(t,n.descriptors)}function lu(n,t){Object.keys(t).forEach(e=>{const i=e.split("."),o=i.pop(),a=[n].concat(i).join("."),s=t[e].split("."),r=s.pop(),l=s.join(".");be.route(a,o,l,r)})}function cu(n){return"id"in n&&"defaults"in n}class du{constructor(){this.controllers=new ji(tn,"datasets",!0),this.elements=new ji(en,"elements"),this.plugins=new ji(Object,"plugins"),this.scales=new ji(Wn,"scales"),this._typedRegistries=[this.controllers,this.scales,this.elements]}add(...t){this._each("register",t)}remove(...t){this._each("unregister",t)}addControllers(...t){this._each("register",t,this.controllers)}addElements(...t){this._each("register",t,this.elements)}addPlugins(...t){this._each("register",t,this.plugins)}addScales(...t){this._each("register",t,this.scales)}getController(t){return this._get(t,this.controllers,"controller")}getElement(t){return this._get(t,this.elements,"element")}getPlugin(t){return this._get(t,this.plugins,"plugin")}getScale(t){return this._get(t,this.scales,"scale")}removeControllers(...t){this._each("unregister",t,this.controllers)}removeElements(...t){this._each("unregister",t,this.elements)}removePlugins(...t){this._each("unregister",t,this.plugins)}removeScales(...t){this._each("unregister",t,this.scales)}_each(t,e,i){[...e].forEach(o=>{const a=i||this._getRegistryForType(o);i||a.isForType(o)||a===this.plugins&&o.id?this._exec(t,a,o):fe(o,s=>{const r=i||this._getRegistryForType(s);this._exec(t,r,s)})})}_exec(t,e,i){const o=da(t);ge(i["before"+o],[],i),e[t](i),ge(i["after"+o],[],i)}_getRegistryForType(t){for(let e=0;e<this._typedRegistries.length;e++){const i=this._typedRegistries[e];if(i.isForType(t))return i}return this.plugins}_get(t,e,i){const o=e.get(t);if(o===void 0)throw new Error('"'+t+'" is not a registered '+i+".");return o}}var sn=new du;class uu{constructor(){this._init=[]}notify(t,e,i,o){e==="beforeInit"&&(this._init=this._createDescriptors(t,!0),this._notify(this._init,t,"install"));const a=o?this._descriptors(t).filter(o):this._descriptors(t),s=this._notify(a,t,e,i);return e==="afterDestroy"&&(this._notify(a,t,"stop"),this._notify(this._init,t,"uninstall")),s}_notify(t,e,i,o){o=o||{};for(const a of t){const s=a.plugin,r=s[i],l=[e,o,a.options];if(ge(r,l,s)===!1&&o.cancelable)return!1}return!0}invalidate(){ne(this._cache)||(this._oldCache=this._cache,this._cache=void 0)}_descriptors(t){if(this._cache)return this._cache;const e=this._cache=this._createDescriptors(t);return this._notifyStateChanges(t),e}_createDescriptors(t,e){const i=t&&t.config,o=Xt(i.options&&i.options.plugins,{}),a=pu(i);return o===!1&&!e?[]:hu(t,a,o,e)}_notifyStateChanges(t){const e=this._oldCache||[],i=this._cache,o=(a,s)=>a.filter(r=>!s.some(l=>r.plugin.id===l.plugin.id));this._notify(o(e,i),t,"stop"),this._notify(o(i,e),t,"start")}}function pu(n){const t={},e=[],i=Object.keys(sn.plugins.items);for(let a=0;a<i.length;a++)e.push(sn.getPlugin(i[a]));const o=n.plugins||[];for(let a=0;a<o.length;a++){const s=o[a];e.indexOf(s)===-1&&(e.push(s),t[s.id]=!0)}return{plugins:e,localIds:t}}function fu(n,t){return!t&&n===!1?null:n===!0?{}:n}function hu(n,{plugins:t,localIds:e},i,o){const a=[],s=n.getContext();for(const r of t){const l=r.id,c=fu(i[l],o);c!==null&&a.push({plugin:r,options:gu(n.config,{plugin:r,local:e[l]},c,s)})}return a}function gu(n,{plugin:t,local:e},i,o){const a=n.pluginScopeKeys(t),s=n.getOptionScopes(i,a);return e&&t.defaults&&s.push(t.defaults),n.createResolver(s,o,[""],{scriptable:!1,indexable:!1,allKeys:!0})}function Xo(n,t){const e=be.datasets[n]||{};return((t.datasets||{})[n]||{}).indexAxis||t.indexAxis||e.indexAxis||"x"}function mu(n,t){let e=n;return n==="_index_"?e=t:n==="_value_"&&(e=t==="x"?"y":"x"),e}function vu(n,t){return n===t?"_index_":"_value_"}function ps(n){if(n==="x"||n==="y"||n==="r")return n}function bu(n){if(n==="top"||n==="bottom")return"x";if(n==="left"||n==="right")return"y"}function Ko(n,...t){if(ps(n))return n;for(const e of t){const i=e.axis||bu(e.position)||n.length>1&&ps(n[0].toLowerCase());if(i)return i}throw new Error("Cannot determine type of '".concat(n,"' axis. Please provide 'axis' or 'position' option."))}function fs(n,t,e){if(e[t+"AxisID"]===n)return{axis:t}}function yu(n,t){if(t.data&&t.data.datasets){const e=t.data.datasets.filter(i=>i.xAxisID===n||i.yAxisID===n);if(e.length)return fs(n,"x",e[0])||fs(n,"y",e[0])}return{}}function xu(n,t){const e=Hn[n.type]||{scales:{}},i=t.scales||{},o=Xo(n.type,t),a=Object.create(null);return Object.keys(i).forEach(s=>{const r=i[s];if(!ie(r))return console.error("Invalid scale configuration for scale: ".concat(s));if(r._proxy)return console.warn("Ignoring resolver passed as options for scale: ".concat(s));const l=Ko(s,r,yu(s,n),be.scales[r.type]),c=vu(l,o),d=e.scales||{};a[s]=yi(Object.create(null),[{axis:l},r,d[l],d[c]])}),n.data.datasets.forEach(s=>{const r=s.type||n.type,l=s.indexAxis||Xo(r,t),d=(Hn[r]||{}).scales||{};Object.keys(d).forEach(u=>{const p=mu(u,l),f=s[p+"AxisID"]||p;a[f]=a[f]||Object.create(null),yi(a[f],[{axis:p},i[f],d[u]])})}),Object.keys(a).forEach(s=>{const r=a[s];yi(r,[be.scales[r.type],be.scale])}),a}function Ar(n){const t=n.options||(n.options={});t.plugins=Xt(t.plugins,{}),t.scales=xu(n,t)}function Br(n){return n=n||{},n.datasets=n.datasets||[],n.labels=n.labels||[],n}function wu(n){return n=n||{},n.data=Br(n.data),Ar(n),n}const hs=new Map,Lr=new Set;function Wi(n,t){let e=hs.get(n);return e||(e=t(),hs.set(n,e),Lr.add(e)),e}const ci=(n,t,e)=>{const i=Dn(t,e);i!==void 0&&n.add(i)};class _u{constructor(t){this._config=wu(t),this._scopeCache=new Map,this._resolverCache=new Map}get platform(){return this._config.platform}get type(){return this._config.type}set type(t){this._config.type=t}get data(){return this._config.data}set data(t){this._config.data=Br(t)}get options(){return this._config.options}set options(t){this._config.options=t}get plugins(){return this._config.plugins}update(){const t=this._config;this.clearCache(),Ar(t)}clearCache(){this._scopeCache.clear(),this._resolverCache.clear()}datasetScopeKeys(t){return Wi(t,()=>[["datasets.".concat(t),""]])}datasetAnimationScopeKeys(t,e){return Wi("".concat(t,".transition.").concat(e),()=>[["datasets.".concat(t,".transitions.").concat(e),"transitions.".concat(e)],["datasets.".concat(t),""]])}datasetElementScopeKeys(t,e){return Wi("".concat(t,"-").concat(e),()=>[["datasets.".concat(t,".elements.").concat(e),"datasets.".concat(t),"elements.".concat(e),""]])}pluginScopeKeys(t){const e=t.id,i=this.type;return Wi("".concat(i,"-plugin-").concat(e),()=>[["plugins.".concat(e),...t.additionalOptionScopes||[]]])}_cachedScopes(t,e){const i=this._scopeCache;let o=i.get(t);return(!o||e)&&(o=new Map,i.set(t,o)),o}getOptionScopes(t,e,i){const{options:o,type:a}=this,s=this._cachedScopes(t,i),r=s.get(e);if(r)return r;const l=new Set;e.forEach(d=>{t&&(l.add(t),d.forEach(u=>ci(l,t,u))),d.forEach(u=>ci(l,o,u)),d.forEach(u=>ci(l,Hn[a]||{},u)),d.forEach(u=>ci(l,be,u)),d.forEach(u=>ci(l,$o,u))});const c=Array.from(l);return c.length===0&&c.push(Object.create(null)),Lr.has(e)&&s.set(e,c),c}chartOptionScopes(){const{options:t,type:e}=this;return[t,Hn[e]||{},be.datasets[e]||{},{type:e},be,$o]}resolveNamedOptions(t,e,i,o=[""]){const a={$shared:!0},{resolver:s,subPrefixes:r}=gs(this._resolverCache,t,o);let l=s;if(ku(s,e)){a.$shared=!1,i=Tn(i)?i():i;const c=this.createResolver(t,i,r);l=ti(s,i,c)}for(const c of e)a[c]=l[c];return a}createResolver(t,e,i=[""],o){const{resolver:a}=gs(this._resolverCache,t,i);return ie(e)?ti(a,e,void 0,o):a}}function gs(n,t,e){let i=n.get(t);i||(i=new Map,n.set(t,i));const o=e.join();let a=i.get(o);return a||(a={resolver:ma(t,e),subPrefixes:e.filter(r=>!r.toLowerCase().includes("hover"))},i.set(o,a)),a}const Su=n=>ie(n)&&Object.getOwnPropertyNames(n).some(t=>Tn(n[t]));function ku(n,t){const{isScriptable:e,isIndexable:i}=pr(n);for(const o of t){const a=e(o),s=i(o),r=(s||a)&&n[o];if(a&&(Tn(r)||Su(r))||s&&ve(r))return!0}return!1}var Cu="4.5.0";const Eu=["top","bottom","left","right","chartArea"];function ms(n,t){return n==="top"||n==="bottom"||Eu.indexOf(n)===-1&&t==="x"}function vs(n,t){return function(e,i){return e[n]===i[n]?e[t]-i[t]:e[n]-i[n]}}function bs(n){const t=n.chart,e=t.options.animation;t.notifyPlugins("afterRender"),ge(e&&e.onComplete,[n],t)}function Iu(n){const t=n.chart,e=t.options.animation;ge(e&&e.onProgress,[n],t)}function Or(n){return ya()&&typeof n=="string"?n=document.getElementById(n):n&&n.length&&(n=n[0]),n&&n.canvas&&(n=n.canvas),n}const oo={},ys=n=>{const t=Or(n);return Object.values(oo).filter(e=>e.canvas===t).pop()};function Du(n,t,e){const i=Object.keys(n);for(const o of i){const a=+o;if(a>=t){const s=n[o];delete n[o],(e>0||a>t)&&(n[a+e]=s)}}}function Tu(n,t,e,i){return!e||n.type==="mouseout"?null:i?t:n}var _n;let mn=(_n=class{static register(...t){sn.add(...t),xs()}static unregister(...t){sn.remove(...t),xs()}constructor(t,e){const i=this.config=new _u(e),o=Or(t),a=ys(o);if(a)throw new Error("Canvas is already in use. Chart with ID '"+a.id+"' must be destroyed before the canvas with ID '"+a.canvas.id+"' can be reused.");const s=i.createResolver(i.chartOptionScopes(),this.getContext());this.platform=new(i.platform||qd(o)),this.platform.updateConfig(i);const r=this.platform.acquireContext(o,s.aspectRatio),l=r&&r.canvas,c=l&&l.height,d=l&&l.width;if(this.id=Ml(),this.ctx=r,this.canvas=l,this.width=d,this.height=c,this._options=s,this._aspectRatio=this.aspectRatio,this._layers=[],this._metasets=[],this._stacks=void 0,this.boxes=[],this.currentDevicePixelRatio=void 0,this.chartArea=void 0,this._active=[],this._lastEvent=void 0,this._listeners={},this._responsiveListeners=void 0,this._sortedMetasets=[],this.scales={},this._plugins=new uu,this.$proxies={},this._hiddenIndices={},this.attached=!1,this._animationsDisabled=void 0,this.$context=void 0,this._doResize=ql(u=>this.update(u),s.resizeDelay||0),this._dataChanges=[],oo[this.id]=this,!r||!l){console.error("Failed to create chart: can't acquire context from the given item");return}fn.listen(this,"complete",bs),fn.listen(this,"progress",Iu),this._initialize(),this.attached&&this.update()}get aspectRatio(){const{options:{aspectRatio:t,maintainAspectRatio:e},width:i,height:o,_aspectRatio:a}=this;return ne(t)?e&&a?a:o?i/o:null:t}get data(){return this.config.data}set data(t){this.config.data=t}get options(){return this._options}set options(t){this.config.options=t}get registry(){return sn}_initialize(){return this.notifyPlugins("beforeInit"),this.options.responsive?this.resize():Ha(this,this.options.devicePixelRatio),this.bindEvents(),this.notifyPlugins("afterInit"),this}clear(){return za(this.canvas,this.ctx),this}stop(){return fn.stop(this),this}resize(t,e){fn.running(this)?this._resizeBeforeDraw={width:t,height:e}:this._resize(t,e)}_resize(t,e){const i=this.options,o=this.canvas,a=i.maintainAspectRatio&&this.aspectRatio,s=this.platform.getMaximumSize(o,t,e,a),r=i.devicePixelRatio||this.platform.getDevicePixelRatio(),l=this.width?"resize":"attach";this.width=s.width,this.height=s.height,this._aspectRatio=this.aspectRatio,Ha(this,r,!0)&&(this.notifyPlugins("resize",{size:s}),ge(i.onResize,[this,s],this),this.attached&&this._doResize(l)&&this.render())}ensureScalesHaveIDs(){const e=this.options.scales||{};fe(e,(i,o)=>{i.id=o})}buildOrUpdateScales(){const t=this.options,e=t.scales,i=this.scales,o=Object.keys(i).reduce((s,r)=>(s[r]=!1,s),{});let a=[];e&&(a=a.concat(Object.keys(e).map(s=>{const r=e[s],l=Ko(s,r),c=l==="r",d=l==="x";return{options:r,dposition:c?"chartArea":d?"bottom":"left",dtype:c?"radialLinear":d?"category":"linear"}}))),fe(a,s=>{const r=s.options,l=r.id,c=Ko(l,r),d=Xt(r.type,s.dtype);(r.position===void 0||ms(r.position,c)!==ms(s.dposition))&&(r.position=s.dposition),o[l]=!0;let u=null;if(l in i&&i[l].type===d)u=i[l];else{const p=sn.getScale(d);u=new p({id:l,type:d,ctx:this.ctx,chart:this}),i[u.id]=u}u.init(r,t)}),fe(o,(s,r)=>{s||delete i[r]}),fe(i,s=>{Re.configure(this,s,s.options),Re.addBox(this,s)})}_updateMetasets(){const t=this._metasets,e=this.data.datasets.length,i=t.length;if(t.sort((o,a)=>o.index-a.index),i>e){for(let o=e;o<i;++o)this._destroyDatasetMeta(o);t.splice(e,i-e)}this._sortedMetasets=t.slice(0).sort(vs("order","index"))}_removeUnreferencedMetasets(){const{_metasets:t,data:{datasets:e}}=this;t.length>e.length&&delete this._stacks,t.forEach((i,o)=>{e.filter(a=>a===i._dataset).length===0&&this._destroyDatasetMeta(o)})}buildOrUpdateControllers(){const t=[],e=this.data.datasets;let i,o;for(this._removeUnreferencedMetasets(),i=0,o=e.length;i<o;i++){const a=e[i];let s=this.getDatasetMeta(i);const r=a.type||this.config.type;if(s.type&&s.type!==r&&(this._destroyDatasetMeta(i),s=this.getDatasetMeta(i)),s.type=r,s.indexAxis=a.indexAxis||Xo(r,this.options),s.order=a.order||0,s.index=i,s.label=""+a.label,s.visible=this.isDatasetVisible(i),s.controller)s.controller.updateIndex(i),s.controller.linkScales();else{const l=sn.getController(r),{datasetElementType:c,dataElementType:d}=be.datasets[r];Object.assign(l,{dataElementType:sn.getElement(d),datasetElementType:c&&sn.getElement(c)}),s.controller=new l(this,i),t.push(s.controller)}}return this._updateMetasets(),t}_resetElements(){fe(this.data.datasets,(t,e)=>{this.getDatasetMeta(e).controller.reset()},this)}reset(){this._resetElements(),this.notifyPlugins("reset")}update(t){const e=this.config;e.update();const i=this._options=e.createResolver(e.chartOptionScopes(),this.getContext()),o=this._animationsDisabled=!i.animation;if(this._updateScales(),this._checkEventBindings(),this._updateHiddenIndices(),this._plugins.invalidate(),this.notifyPlugins("beforeUpdate",{mode:t,cancelable:!0})===!1)return;const a=this.buildOrUpdateControllers();this.notifyPlugins("beforeElementsUpdate");let s=0;for(let c=0,d=this.data.datasets.length;c<d;c++){const{controller:u}=this.getDatasetMeta(c),p=!o&&a.indexOf(u)===-1;u.buildOrUpdateElements(p),s=Math.max(+u.getMaxOverflow(),s)}s=this._minPadding=i.layout.autoPadding?s:0,this._updateLayout(s),o||fe(a,c=>{c.reset()}),this._updateDatasets(t),this.notifyPlugins("afterUpdate",{mode:t}),this._layers.sort(vs("z","_idx"));const{_active:r,_lastEvent:l}=this;l?this._eventHandler(l,!0):r.length&&this._updateHoverStyles(r,r,!0),this.render()}_updateScales(){fe(this.scales,t=>{Re.removeBox(this,t)}),this.ensureScalesHaveIDs(),this.buildOrUpdateScales()}_checkEventBindings(){const t=this.options,e=new Set(Object.keys(this._listeners)),i=new Set(t.events);(!Ma(e,i)||!!this._responsiveListeners!==t.responsive)&&(this.unbindEvents(),this.bindEvents())}_updateHiddenIndices(){const{_hiddenIndices:t}=this,e=this._getUniformDataChanges()||[];for(const{method:i,start:o,count:a}of e){const s=i==="_removeElements"?-a:a;Du(t,o,s)}}_getUniformDataChanges(){const t=this._dataChanges;if(!t||!t.length)return;this._dataChanges=[];const e=this.data.datasets.length,i=a=>new Set(t.filter(s=>s[0]===a).map((s,r)=>r+","+s.splice(1).join(","))),o=i(0);for(let a=1;a<e;a++)if(!Ma(o,i(a)))return;return Array.from(o).map(a=>a.split(",")).map(a=>({method:a[1],start:+a[2],count:+a[3]}))}_updateLayout(t){if(this.notifyPlugins("beforeLayout",{cancelable:!0})===!1)return;Re.update(this,this.width,this.height,t);const e=this.chartArea,i=e.width<=0||e.height<=0;this._layers=[],fe(this.boxes,o=>{i&&o.position==="chartArea"||(o.configure&&o.configure(),this._layers.push(...o._layers()))},this),this._layers.forEach((o,a)=>{o._idx=a}),this.notifyPlugins("afterLayout")}_updateDatasets(t){if(this.notifyPlugins("beforeDatasetsUpdate",{mode:t,cancelable:!0})!==!1){for(let e=0,i=this.data.datasets.length;e<i;++e)this.getDatasetMeta(e).controller.configure();for(let e=0,i=this.data.datasets.length;e<i;++e)this._updateDataset(e,Tn(t)?t({datasetIndex:e}):t);this.notifyPlugins("afterDatasetsUpdate",{mode:t})}}_updateDataset(t,e){const i=this.getDatasetMeta(t),o={meta:i,index:t,mode:e,cancelable:!0};this.notifyPlugins("beforeDatasetUpdate",o)!==!1&&(i.controller._update(e),o.cancelable=!1,this.notifyPlugins("afterDatasetUpdate",o))}render(){this.notifyPlugins("beforeRender",{cancelable:!0})!==!1&&(fn.has(this)?this.attached&&!fn.running(this)&&fn.start(this):(this.draw(),bs({chart:this})))}draw(){let t;if(this._resizeBeforeDraw){const{width:i,height:o}=this._resizeBeforeDraw;this._resizeBeforeDraw=null,this._resize(i,o)}if(this.clear(),this.width<=0||this.height<=0||this.notifyPlugins("beforeDraw",{cancelable:!0})===!1)return;const e=this._layers;for(t=0;t<e.length&&e[t].z<=0;++t)e[t].draw(this.chartArea);for(this._drawDatasets();t<e.length;++t)e[t].draw(this.chartArea);this.notifyPlugins("afterDraw")}_getSortedDatasetMetas(t){const e=this._sortedMetasets,i=[];let o,a;for(o=0,a=e.length;o<a;++o){const s=e[o];(!t||s.visible)&&i.push(s)}return i}getSortedVisibleDatasetMetas(){return this._getSortedDatasetMetas(!0)}_drawDatasets(){if(this.notifyPlugins("beforeDatasetsDraw",{cancelable:!0})===!1)return;const t=this.getSortedVisibleDatasetMetas();for(let e=t.length-1;e>=0;--e)this._drawDataset(t[e]);this.notifyPlugins("afterDatasetsDraw")}_drawDataset(t){const e=this.ctx,i={meta:t,index:t.index,cancelable:!0},o=Sr(this,t);this.notifyPlugins("beforeDatasetDraw",i)!==!1&&(o&&xo(e,o),t.controller.draw(),o&&wo(e),i.cancelable=!1,this.notifyPlugins("afterDatasetDraw",i))}isPointInArea(t){return yn(t,this.chartArea,this._minPadding)}getElementsAtEventForMode(t,e,i,o){const a=Ed.modes[e];return typeof a=="function"?a(this,t,i,o):[]}getDatasetMeta(t){const e=this.data.datasets[t],i=this._metasets;let o=i.filter(a=>a&&a._dataset===e).pop();return o||(o={type:null,data:[],dataset:null,controller:null,hidden:null,xAxisID:null,yAxisID:null,order:e&&e.order||0,index:t,_dataset:e,_parsed:[],_sorted:!1},i.push(o)),o}getContext(){return this.$context||(this.$context=Mn(null,{chart:this,type:"chart"}))}getVisibleDatasetCount(){return this.getSortedVisibleDatasetMetas().length}isDatasetVisible(t){const e=this.data.datasets[t];if(!e)return!1;const i=this.getDatasetMeta(t);return typeof i.hidden=="boolean"?!i.hidden:!e.hidden}setDatasetVisibility(t,e){const i=this.getDatasetMeta(t);i.hidden=!e}toggleDataVisibility(t){this._hiddenIndices[t]=!this._hiddenIndices[t]}getDataVisibility(t){return!this._hiddenIndices[t]}_updateVisibility(t,e,i){const o=i?"show":"hide",a=this.getDatasetMeta(t),s=a.controller._resolveAnimations(void 0,o);Ei(e)?(a.data[e].hidden=!i,this.update()):(this.setDatasetVisibility(t,i),s.update(a,{visible:i}),this.update(r=>r.datasetIndex===t?o:void 0))}hide(t,e){this._updateVisibility(t,e,!1)}show(t,e){this._updateVisibility(t,e,!0)}_destroyDatasetMeta(t){const e=this._metasets[t];e&&e.controller&&e.controller._destroy(),delete this._metasets[t]}_stop(){let t,e;for(this.stop(),fn.remove(this),t=0,e=this.data.datasets.length;t<e;++t)this._destroyDatasetMeta(t)}destroy(){this.notifyPlugins("beforeDestroy");const{canvas:t,ctx:e}=this;this._stop(),this.config.clearCache(),t&&(this.unbindEvents(),za(t,e),this.platform.releaseContext(e),this.canvas=null,this.ctx=null),delete oo[this.id],this.notifyPlugins("afterDestroy")}toBase64Image(...t){return this.canvas.toDataURL(...t)}bindEvents(){this.bindUserEvents(),this.options.responsive?this.bindResponsiveEvents():this.attached=!0}bindUserEvents(){const t=this._listeners,e=this.platform,i=(a,s)=>{e.addEventListener(this,a,s),t[a]=s},o=(a,s,r)=>{a.offsetX=s,a.offsetY=r,this._eventHandler(a)};fe(this.options.events,a=>i(a,o))}bindResponsiveEvents(){this._responsiveListeners||(this._responsiveListeners={});const t=this._responsiveListeners,e=this.platform,i=(l,c)=>{e.addEventListener(this,l,c),t[l]=c},o=(l,c)=>{t[l]&&(e.removeEventListener(this,l,c),delete t[l])},a=(l,c)=>{this.canvas&&this.resize(l,c)};let s;const r=()=>{o("attach",r),this.attached=!0,this.resize(),i("resize",a),i("detach",s)};s=()=>{this.attached=!1,o("resize",a),this._stop(),this._resize(0,0),i("attach",r)},e.isAttached(this.canvas)?r():s()}unbindEvents(){fe(this._listeners,(t,e)=>{this.platform.removeEventListener(this,e,t)}),this._listeners={},fe(this._responsiveListeners,(t,e)=>{this.platform.removeEventListener(this,e,t)}),this._responsiveListeners=void 0}updateHoverStyle(t,e,i){const o=i?"set":"remove";let a,s,r,l;for(e==="dataset"&&(a=this.getDatasetMeta(t[0].datasetIndex),a.controller["_"+o+"DatasetHoverStyle"]()),r=0,l=t.length;r<l;++r){s=t[r];const c=s&&this.getDatasetMeta(s.datasetIndex).controller;c&&c[o+"HoverStyle"](s.element,s.datasetIndex,s.index)}}getActiveElements(){return this._active||[]}setActiveElements(t){const e=this._active||[],i=t.map(({datasetIndex:a,index:s})=>{const r=this.getDatasetMeta(a);if(!r)throw new Error("No dataset found at index "+a);return{datasetIndex:a,element:r.data[s],index:s}});!lo(i,e)&&(this._active=i,this._lastEvent=null,this._updateHoverStyles(i,e))}notifyPlugins(t,e,i){return this._plugins.notify(this,t,e,i)}isPluginEnabled(t){return this._plugins._cache.filter(e=>e.plugin.id===t).length===1}_updateHoverStyles(t,e,i){const o=this.options.hover,a=(l,c)=>l.filter(d=>!c.some(u=>d.datasetIndex===u.datasetIndex&&d.index===u.index)),s=a(e,t),r=i?t:a(t,e);s.length&&this.updateHoverStyle(s,o.mode,!1),r.length&&o.mode&&this.updateHoverStyle(r,o.mode,!0)}_eventHandler(t,e){const i={event:t,replay:e,cancelable:!0,inChartArea:this.isPointInArea(t)},o=s=>(s.options.events||this.options.events).includes(t.native.type);if(this.notifyPlugins("beforeEvent",i,o)===!1)return;const a=this._handleEvent(t,e,i.inChartArea);return i.cancelable=!1,this.notifyPlugins("afterEvent",i,o),(a||i.changed)&&this.render(),this}_handleEvent(t,e,i){const{_active:o=[],options:a}=this,s=e,r=this._getActiveElements(t,o,i,s),l=Nl(t),c=Tu(t,this._lastEvent,i,l);i&&(this._lastEvent=null,ge(a.onHover,[t,r,this],this),l&&ge(a.onClick,[t,r,this],this));const d=!lo(r,o);return(d||e)&&(this._active=r,this._updateHoverStyles(r,o,e)),this._lastEvent=c,d}_getActiveElements(t,e,i,o){if(t.type==="mouseout")return[];if(!i)return e;const a=this.options.hover;return this.getElementsAtEventForMode(t,a.mode,a,o)}},St(_n,"defaults",be),St(_n,"instances",oo),St(_n,"overrides",Hn),St(_n,"registry",sn),St(_n,"version",Cu),St(_n,"getChart",ys),_n);function xs(){return fe(mn.instances,n=>n._plugins.invalidate())}function Mu(n,t,e){const{startAngle:i,x:o,y:a,outerRadius:s,innerRadius:r,options:l}=t,{borderWidth:c,borderJoinStyle:d}=l,u=Math.min(c/s,Fe(i-e));if(n.beginPath(),n.arc(o,a,s-c/2,i+u/2,e-u/2),r>0){const p=Math.min(c/r,Fe(i-e));n.arc(o,a,r+c/2,e-p/2,i+p/2,!0)}else{const p=Math.min(c/2,s*Fe(i-e));if(d==="round")n.arc(o,a,p,e-de/2,i+de/2,!0);else if(d==="bevel"){const f=2*p*p,b=-f*Math.cos(e+de/2)+o,v=-f*Math.sin(e+de/2)+a,y=f*Math.cos(i+de/2)+o,E=f*Math.sin(i+de/2)+a;n.lineTo(b,v),n.lineTo(y,E)}}n.closePath(),n.moveTo(0,0),n.rect(0,0,n.canvas.width,n.canvas.height),n.clip("evenodd")}function Pu(n,t,e){const{startAngle:i,pixelMargin:o,x:a,y:s,outerRadius:r,innerRadius:l}=t;let c=o/r;n.beginPath(),n.arc(a,s,r,i-c,e+c),l>o?(c=o/l,n.arc(a,s,l,e+c,i-c,!0)):n.arc(a,s,o,e+ke,i-ke),n.closePath(),n.clip()}function Au(n){return ga(n,["outerStart","outerEnd","innerStart","innerEnd"])}function Bu(n,t,e,i){const o=Au(n.options.borderRadius),a=(e-t)/2,s=Math.min(a,i*t/2),r=l=>{const c=(e-Math.min(a,l))*i/2;return Ae(l,0,Math.min(a,c))};return{outerStart:r(o.outerStart),outerEnd:r(o.outerEnd),innerStart:Ae(o.innerStart,0,s),innerEnd:Ae(o.innerEnd,0,s)}}function Gn(n,t,e,i){return{x:e+n*Math.cos(t),y:i+n*Math.sin(t)}}function go(n,t,e,i,o,a){const{x:s,y:r,startAngle:l,pixelMargin:c,innerRadius:d}=t,u=Math.max(t.outerRadius+i+e-c,0),p=d>0?d+i+e+c:0;let f=0;const b=o-l;if(i){const Kt=d>0?d-i:0,Zt=u>0?u-i:0,ae=(Kt+Zt)/2,Ce=ae!==0?b*ae/(ae+i):b;f=(b-Ce)/2}const v=Math.max(.001,b*u-e/de)/u,y=(b-v)/2,E=l+y+f,M=o-y-f,{outerStart:X,outerEnd:it,innerStart:Q,innerEnd:ft}=Bu(t,p,u,M-E),ut=u-X,ct=u-it,It=E+X/ut,Ot=M-it/ct,Ut=p+Q,Vt=p+ft,Mt=E+Q/Ut,$t=M-ft/Vt;if(n.beginPath(),a){const Kt=(It+Ot)/2;if(n.arc(s,r,u,It,Kt),n.arc(s,r,u,Kt,Ot),it>0){const re=Gn(ct,Ot,s,r);n.arc(re.x,re.y,it,Ot,M+ke)}const Zt=Gn(Vt,M,s,r);if(n.lineTo(Zt.x,Zt.y),ft>0){const re=Gn(Vt,$t,s,r);n.arc(re.x,re.y,ft,M+ke,$t+Math.PI)}const ae=(M-ft/p+(E+Q/p))/2;if(n.arc(s,r,p,M-ft/p,ae,!0),n.arc(s,r,p,ae,E+Q/p,!0),Q>0){const re=Gn(Ut,Mt,s,r);n.arc(re.x,re.y,Q,Mt+Math.PI,E-ke)}const Ce=Gn(ut,E,s,r);if(n.lineTo(Ce.x,Ce.y),X>0){const re=Gn(ut,It,s,r);n.arc(re.x,re.y,X,E-ke,It)}}else{n.moveTo(s,r);const Kt=Math.cos(It)*u+s,Zt=Math.sin(It)*u+r;n.lineTo(Kt,Zt);const ae=Math.cos(Ot)*u+s,Ce=Math.sin(Ot)*u+r;n.lineTo(ae,Ce)}n.closePath()}function Lu(n,t,e,i,o){const{fullCircles:a,startAngle:s,circumference:r}=t;let l=t.endAngle;if(a){go(n,t,e,i,l,o);for(let c=0;c<a;++c)n.fill();isNaN(r)||(l=s+(r%me||me))}return go(n,t,e,i,l,o),n.fill(),l}function Ou(n,t,e,i,o){const{fullCircles:a,startAngle:s,circumference:r,options:l}=t,{borderWidth:c,borderJoinStyle:d,borderDash:u,borderDashOffset:p,borderRadius:f}=l,b=l.borderAlign==="inner";if(!c)return;n.setLineDash(u||[]),n.lineDashOffset=p,b?(n.lineWidth=c*2,n.lineJoin=d||"round"):(n.lineWidth=c,n.lineJoin=d||"bevel");let v=t.endAngle;if(a){go(n,t,e,i,v,o);for(let y=0;y<a;++y)n.stroke();isNaN(r)||(v=s+(r%me||me))}b&&Pu(n,t,v),l.selfJoin&&v-s>=de&&f===0&&d!=="miter"&&Mu(n,t,v),a||(go(n,t,e,i,v,o),n.stroke())}class hi extends en{constructor(e){super();St(this,"circumference");St(this,"endAngle");St(this,"fullCircles");St(this,"innerRadius");St(this,"outerRadius");St(this,"pixelMargin");St(this,"startAngle");this.options=void 0,this.circumference=void 0,this.startAngle=void 0,this.endAngle=void 0,this.innerRadius=void 0,this.outerRadius=void 0,this.pixelMargin=0,this.fullCircles=0,e&&Object.assign(this,e)}inRange(e,i,o){const a=this.getProps(["x","y"],o),{angle:s,distance:r}=nr(a,{x:e,y:i}),{startAngle:l,endAngle:c,innerRadius:d,outerRadius:u,circumference:p}=this.getProps(["startAngle","endAngle","innerRadius","outerRadius","circumference"],o),f=(this.options.spacing+this.options.borderWidth)/2,b=Xt(p,c-l),v=Ii(s,l,c)&&l!==c,y=b>=me||v,E=vn(r,d+f,u+f);return y&&E}getCenterPoint(e){const{x:i,y:o,startAngle:a,endAngle:s,innerRadius:r,outerRadius:l}=this.getProps(["x","y","startAngle","endAngle","innerRadius","outerRadius"],e),{offset:c,spacing:d}=this.options,u=(a+s)/2,p=(r+l+d+c)/2;return{x:i+Math.cos(u)*p,y:o+Math.sin(u)*p}}tooltipPosition(e){return this.getCenterPoint(e)}draw(e){const{options:i,circumference:o}=this,a=(i.offset||0)/4,s=(i.spacing||0)/2,r=i.circular;if(this.pixelMargin=i.borderAlign==="inner"?.33:0,this.fullCircles=o>me?Math.floor(o/me):0,o===0||this.innerRadius<0||this.outerRadius<0)return;e.save();const l=(this.startAngle+this.endAngle)/2;e.translate(Math.cos(l)*a,Math.sin(l)*a);const c=1-Math.sin(Math.min(de,o||0)),d=a*c;e.fillStyle=i.backgroundColor,e.strokeStyle=i.borderColor,Lu(e,this,d,s,r),Ou(e,this,d,s,r),e.restore()}}St(hi,"id","arc"),St(hi,"defaults",{borderAlign:"center",borderColor:"#fff",borderDash:[],borderDashOffset:0,borderJoinStyle:void 0,borderRadius:0,borderWidth:2,offset:0,spacing:0,angle:void 0,circular:!0,selfJoin:!1}),St(hi,"defaultRoutes",{backgroundColor:"backgroundColor"}),St(hi,"descriptors",{_scriptable:!0,_indexable:e=>e!=="borderDash"});function Nr(n,t,e=t){n.lineCap=Xt(e.borderCapStyle,t.borderCapStyle),n.setLineDash(Xt(e.borderDash,t.borderDash)),n.lineDashOffset=Xt(e.borderDashOffset,t.borderDashOffset),n.lineJoin=Xt(e.borderJoinStyle,t.borderJoinStyle),n.lineWidth=Xt(e.borderWidth,t.borderWidth),n.strokeStyle=Xt(e.borderColor,t.borderColor)}function Nu(n,t,e){n.lineTo(e.x,e.y)}function Fu(n){return n.stepped?ac:n.tension||n.cubicInterpolationMode==="monotone"?sc:Nu}function Fr(n,t,e={}){const i=n.length,{start:o=0,end:a=i-1}=e,{start:s,end:r}=t,l=Math.max(o,s),c=Math.min(a,r),d=o<s&&a<s||o>r&&a>r;return{count:i,start:l,loop:t.loop,ilen:c<l&&!d?i+c-l:c-l}}function Ru(n,t,e,i){const{points:o,options:a}=t,{count:s,start:r,loop:l,ilen:c}=Fr(o,e,i),d=Fu(a);let{move:u=!0,reverse:p}=i||{},f,b,v;for(f=0;f<=c;++f)b=o[(r+(p?c-f:f))%s],!b.skip&&(u?(n.moveTo(b.x,b.y),u=!1):d(n,v,b,p,a.stepped),v=b);return l&&(b=o[(r+(p?c:0))%s],d(n,v,b,p,a.stepped)),!!l}function zu(n,t,e,i){const o=t.points,{count:a,start:s,ilen:r}=Fr(o,e,i),{move:l=!0,reverse:c}=i||{};let d=0,u=0,p,f,b,v,y,E;const M=it=>(s+(c?r-it:it))%a,X=()=>{v!==y&&(n.lineTo(d,y),n.lineTo(d,v),n.lineTo(d,E))};for(l&&(f=o[M(0)],n.moveTo(f.x,f.y)),p=0;p<=r;++p){if(f=o[M(p)],f.skip)continue;const it=f.x,Q=f.y,ft=it|0;ft===b?(Q<v?v=Q:Q>y&&(y=Q),d=(u*d+it)/++u):(X(),n.lineTo(it,Q),b=ft,u=0,v=y=Q),E=Q}X()}function Jo(n){const t=n.options,e=t.borderDash&&t.borderDash.length;return!n._decimated&&!n._loop&&!t.tension&&t.cubicInterpolationMode!=="monotone"&&!t.stepped&&!e?zu:Ru}function Vu(n){return n.stepped?Rc:n.tension||n.cubicInterpolationMode==="monotone"?zc:Rn}function Uu(n,t,e,i){let o=t._path;o||(o=t._path=new Path2D,t.path(o,e,i)&&o.closePath()),Nr(n,t.options),n.stroke(o)}function Hu(n,t,e,i){const{segments:o,options:a}=t,s=Jo(t);for(const r of o)Nr(n,a,r.style),n.beginPath(),s(n,t,r,{start:e,end:e+i-1})&&n.closePath(),n.stroke()}const ju=typeof Path2D=="function";function Wu(n,t,e,i){ju&&!t.options.segment?Uu(n,t,e,i):Hu(n,t,e,i)}class Cn extends en{constructor(t){super(),this.animated=!0,this.options=void 0,this._chart=void 0,this._loop=void 0,this._fullLoop=void 0,this._path=void 0,this._points=void 0,this._segments=void 0,this._decimated=!1,this._pointsUpdated=!1,this._datasetIndex=void 0,t&&Object.assign(this,t)}updateControlPoints(t,e){const i=this.options;if((i.tension||i.cubicInterpolationMode==="monotone")&&!i.stepped&&!this._pointsUpdated){const o=i.spanGaps?this._loop:this._fullLoop;Mc(this._points,i,t,o,e),this._pointsUpdated=!0}}set points(t){this._points=t,delete this._segments,delete this._path,this._pointsUpdated=!1}get points(){return this._points}get segments(){return this._segments||(this._segments=Yc(this,this.options.segment))}first(){const t=this.segments,e=this.points;return t.length&&e[t[0].start]}last(){const t=this.segments,e=this.points,i=t.length;return i&&e[t[i-1].end]}interpolate(t,e){const i=this.options,o=t[e],a=this.points,s=_r(this,{property:e,start:o,end:o});if(!s.length)return;const r=[],l=Vu(i);let c,d;for(c=0,d=s.length;c<d;++c){const{start:u,end:p}=s[c],f=a[u],b=a[p];if(f===b){r.push(f);continue}const v=Math.abs((o-f[e])/(b[e]-f[e])),y=l(f,b,v,i.stepped);y[e]=t[e],r.push(y)}return r.length===1?r[0]:r}pathSegment(t,e,i){return Jo(this)(t,this,e,i)}path(t,e,i){const o=this.segments,a=Jo(this);let s=this._loop;e=e||0,i=i||this.points.length-e;for(const r of o)s&=a(t,this,r,{start:e,end:e+i-1});return!!s}draw(t,e,i,o){const a=this.options||{};(this.points||[]).length&&a.borderWidth&&(t.save(),Wu(t,this,i,o),t.restore()),this.animated&&(this._pointsUpdated=!1,this._path=void 0)}}St(Cn,"id","line"),St(Cn,"defaults",{borderCapStyle:"butt",borderDash:[],borderDashOffset:0,borderJoinStyle:"miter",borderWidth:3,capBezierPoints:!0,cubicInterpolationMode:"default",fill:!1,spanGaps:!1,stepped:!1,tension:0}),St(Cn,"defaultRoutes",{backgroundColor:"backgroundColor",borderColor:"borderColor"}),St(Cn,"descriptors",{_scriptable:!0,_indexable:t=>t!=="borderDash"&&t!=="fill"});function ws(n,t,e,i){const o=n.options,{[e]:a}=n.getProps([e],i);return Math.abs(t-a)<o.radius+o.hitRadius}class ao extends en{constructor(e){super();St(this,"parsed");St(this,"skip");St(this,"stop");this.options=void 0,this.parsed=void 0,this.skip=void 0,this.stop=void 0,e&&Object.assign(this,e)}inRange(e,i,o){const a=this.options,{x:s,y:r}=this.getProps(["x","y"],o);return Math.pow(e-s,2)+Math.pow(i-r,2)<Math.pow(a.hitRadius+a.radius,2)}inXRange(e,i){return ws(this,e,"x",i)}inYRange(e,i){return ws(this,e,"y",i)}getCenterPoint(e){const{x:i,y:o}=this.getProps(["x","y"],e);return{x:i,y:o}}size(e){e=e||this.options||{};let i=e.radius||0;i=Math.max(i,i&&e.hoverRadius||0);const o=i&&e.borderWidth||0;return(i+o)*2}draw(e,i){const o=this.options;this.skip||o.radius<.1||!yn(this,i,this.size(o)/2)||(e.strokeStyle=o.borderColor,e.lineWidth=o.borderWidth,e.fillStyle=o.backgroundColor,qo(e,o,this.x,this.y))}getRange(){const e=this.options||{};return e.radius+e.hitRadius}}St(ao,"id","point"),St(ao,"defaults",{borderWidth:1,hitRadius:1,hoverBorderWidth:1,hoverRadius:4,pointStyle:"circle",radius:3,rotation:0}),St(ao,"defaultRoutes",{backgroundColor:"backgroundColor",borderColor:"borderColor"});function Rr(n,t){const{x:e,y:i,base:o,width:a,height:s}=n.getProps(["x","y","base","width","height"],t);let r,l,c,d,u;return n.horizontal?(u=s/2,r=Math.min(e,o),l=Math.max(e,o),c=i-u,d=i+u):(u=a/2,r=e-u,l=e+u,c=Math.min(i,o),d=Math.max(i,o)),{left:r,top:c,right:l,bottom:d}}function En(n,t,e,i){return n?0:Ae(t,e,i)}function Yu(n,t,e){const i=n.options.borderWidth,o=n.borderSkipped,a=ur(i);return{t:En(o.top,a.top,0,e),r:En(o.right,a.right,0,t),b:En(o.bottom,a.bottom,0,e),l:En(o.left,a.left,0,t)}}function $u(n,t,e){const{enableBorderRadius:i}=n.getProps(["enableBorderRadius"]),o=n.options.borderRadius,a=Vn(o),s=Math.min(t,e),r=n.borderSkipped,l=i||ie(o);return{topLeft:En(!l||r.top||r.left,a.topLeft,0,s),topRight:En(!l||r.top||r.right,a.topRight,0,s),bottomLeft:En(!l||r.bottom||r.left,a.bottomLeft,0,s),bottomRight:En(!l||r.bottom||r.right,a.bottomRight,0,s)}}function qu(n){const t=Rr(n),e=t.right-t.left,i=t.bottom-t.top,o=Yu(n,e/2,i/2),a=$u(n,e/2,i/2);return{outer:{x:t.left,y:t.top,w:e,h:i,radius:a},inner:{x:t.left+o.l,y:t.top+o.t,w:e-o.l-o.r,h:i-o.t-o.b,radius:{topLeft:Math.max(0,a.topLeft-Math.max(o.t,o.l)),topRight:Math.max(0,a.topRight-Math.max(o.t,o.r)),bottomLeft:Math.max(0,a.bottomLeft-Math.max(o.b,o.l)),bottomRight:Math.max(0,a.bottomRight-Math.max(o.b,o.r))}}}}function zo(n,t,e,i){const o=t===null,a=e===null,r=n&&!(o&&a)&&Rr(n,i);return r&&(o||vn(t,r.left,r.right))&&(a||vn(e,r.top,r.bottom))}function Gu(n){return n.topLeft||n.topRight||n.bottomLeft||n.bottomRight}function Xu(n,t){n.rect(t.x,t.y,t.w,t.h)}function Vo(n,t,e={}){const i=n.x!==e.x?-t:0,o=n.y!==e.y?-t:0,a=(n.x+n.w!==e.x+e.w?t:0)-i,s=(n.y+n.h!==e.y+e.h?t:0)-o;return{x:n.x+i,y:n.y+o,w:n.w+a,h:n.h+s,radius:n.radius}}class so extends en{constructor(t){super(),this.options=void 0,this.horizontal=void 0,this.base=void 0,this.width=void 0,this.height=void 0,this.inflateAmount=void 0,t&&Object.assign(this,t)}draw(t){const{inflateAmount:e,options:{borderColor:i,backgroundColor:o}}=this,{inner:a,outer:s}=qu(this),r=Gu(s.radius)?Di:Xu;t.save(),(s.w!==a.w||s.h!==a.h)&&(t.beginPath(),r(t,Vo(s,e,a)),t.clip(),r(t,Vo(a,-e,s)),t.fillStyle=i,t.fill("evenodd")),t.beginPath(),r(t,Vo(a,e)),t.fillStyle=o,t.fill(),t.restore()}inRange(t,e,i){return zo(this,t,e,i)}inXRange(t,e){return zo(this,t,null,e)}inYRange(t,e){return zo(this,null,t,e)}getCenterPoint(t){const{x:e,y:i,base:o,horizontal:a}=this.getProps(["x","y","base","horizontal"],t);return{x:a?(e+o)/2:e,y:a?i:(i+o)/2}}getRange(t){return t==="x"?this.width/2:this.height/2}}St(so,"id","bar"),St(so,"defaults",{borderSkipped:"start",borderWidth:0,borderRadius:0,inflateAmount:"auto",pointStyle:void 0}),St(so,"defaultRoutes",{backgroundColor:"backgroundColor",borderColor:"borderColor"});var Ku=Object.freeze({__proto__:null,ArcElement:hi,BarElement:so,LineElement:Cn,PointElement:ao});const Zo=["rgb(54, 162, 235)","rgb(255, 99, 132)","rgb(255, 159, 64)","rgb(255, 205, 86)","rgb(75, 192, 192)","rgb(153, 102, 255)","rgb(201, 203, 207)"],_s=Zo.map(n=>n.replace("rgb(","rgba(").replace(")",", 0.5)"));function zr(n){return Zo[n%Zo.length]}function Vr(n){return _s[n%_s.length]}function Ju(n,t){return n.borderColor=zr(t),n.backgroundColor=Vr(t),++t}function Zu(n,t){return n.backgroundColor=n.data.map(()=>zr(t++)),t}function Qu(n,t){return n.backgroundColor=n.data.map(()=>Vr(t++)),t}function tp(n){let t=0;return(e,i)=>{const o=n.getDatasetMeta(i).controller;o instanceof zn?t=Zu(e,t):o instanceof Si?t=Qu(e,t):o&&(t=Ju(e,t))}}function Ss(n){let t;for(t in n)if(n[t].borderColor||n[t].backgroundColor)return!0;return!1}function ep(n){return n&&(n.borderColor||n.backgroundColor)}function np(){return be.borderColor!=="rgba(0,0,0,0.1)"||be.backgroundColor!=="rgba(0,0,0,0.1)"}var ip={id:"colors",defaults:{enabled:!0,forceOverride:!1},beforeLayout(n,t,e){if(!e.enabled)return;const{data:{datasets:i},options:o}=n.config,{elements:a}=o,s=Ss(i)||ep(o)||a&&Ss(a)||np();if(!e.forceOverride&&s)return;const r=tp(n);i.forEach(r)}};function op(n,t,e,i,o){const a=o.samples||i;if(a>=e)return n.slice(t,t+e);const s=[],r=(e-2)/(a-2);let l=0;const c=t+e-1;let d=t,u,p,f,b,v;for(s[l++]=n[d],u=0;u<a-2;u++){let y=0,E=0,M;const X=Math.floor((u+1)*r)+1+t,it=Math.min(Math.floor((u+2)*r)+1,e)+t,Q=it-X;for(M=X;M<it;M++)y+=n[M].x,E+=n[M].y;y/=Q,E/=Q;const ft=Math.floor(u*r)+1+t,ut=Math.min(Math.floor((u+1)*r)+1,e)+t,{x:ct,y:It}=n[d];for(f=b=-1,M=ft;M<ut;M++)b=.5*Math.abs((ct-y)*(n[M].y-It)-(ct-n[M].x)*(E-It)),b>f&&(f=b,p=n[M],v=M);s[l++]=p,d=v}return s[l++]=n[c],s}function ap(n,t,e,i){let o=0,a=0,s,r,l,c,d,u,p,f,b,v;const y=[],E=t+e-1,M=n[t].x,it=n[E].x-M;for(s=t;s<t+e;++s){r=n[s],l=(r.x-M)/it*i,c=r.y;const Q=l|0;if(Q===d)c<b?(b=c,u=s):c>v&&(v=c,p=s),o=(a*o+r.x)/++a;else{const ft=s-1;if(!ne(u)&&!ne(p)){const ut=Math.min(u,p),ct=Math.max(u,p);ut!==f&&ut!==ft&&y.push({...n[ut],x:o}),ct!==f&&ct!==ft&&y.push({...n[ct],x:o})}s>0&&ft!==f&&y.push(n[ft]),y.push(r),d=Q,a=0,b=v=c,u=p=f=s}}return y}function Ur(n){if(n._decimated){const t=n._data;delete n._decimated,delete n._data,Object.defineProperty(n,"data",{configurable:!0,enumerable:!0,writable:!0,value:t})}}function ks(n){n.data.datasets.forEach(t=>{Ur(t)})}function sp(n,t){const e=t.length;let i=0,o;const{iScale:a}=n,{min:s,max:r,minDefined:l,maxDefined:c}=a.getUserBounds();return l&&(i=Ae(bn(t,a.axis,s).lo,0,e-1)),c?o=Ae(bn(t,a.axis,r).hi+1,i,e)-i:o=e-i,{start:i,count:o}}var rp={id:"decimation",defaults:{algorithm:"min-max",enabled:!1},beforeElementsUpdate:(n,t,e)=>{if(!e.enabled){ks(n);return}const i=n.width;n.data.datasets.forEach((o,a)=>{const{_data:s,indexAxis:r}=o,l=n.getDatasetMeta(a),c=s||o.data;if(pi([r,n.options.indexAxis])==="y"||!l.controller.supportsDecimation)return;const d=n.scales[l.xAxisID];if(d.type!=="linear"&&d.type!=="time"||n.options.parsing)return;let{start:u,count:p}=sp(l,c);const f=e.threshold||4*i;if(p<=f){Ur(o);return}ne(s)&&(o._data=c,delete o.data,Object.defineProperty(o,"data",{configurable:!0,enumerable:!0,get:function(){return this._decimated},set:function(v){this._data=v}}));let b;switch(e.algorithm){case"lttb":b=op(c,u,p,i,e);break;case"min-max":b=ap(c,u,p,i);break;default:throw new Error("Unsupported decimation algorithm '".concat(e.algorithm,"'"))}o._decimated=b})},destroy(n){ks(n)}};function lp(n,t,e){const i=n.segments,o=n.points,a=t.points,s=[];for(const r of i){let{start:l,end:c}=r;c=ko(l,c,o);const d=Qo(e,o[l],o[c],r.loop);if(!t.segments){s.push({source:r,target:d,start:o[l],end:o[c]});continue}const u=_r(t,d);for(const p of u){const f=Qo(e,a[p.start],a[p.end],p.loop),b=wr(r,o,f);for(const v of b)s.push({source:v,target:p,start:{[e]:Cs(d,f,"start",Math.max)},end:{[e]:Cs(d,f,"end",Math.min)}})}}return s}function Qo(n,t,e,i){if(i)return;let o=t[n],a=e[n];return n==="angle"&&(o=Fe(o),a=Fe(a)),{property:n,start:o,end:a}}function cp(n,t){const{x:e=null,y:i=null}=n||{},o=t.points,a=[];return t.segments.forEach(({start:s,end:r})=>{r=ko(s,r,o);const l=o[s],c=o[r];i!==null?(a.push({x:l.x,y:i}),a.push({x:c.x,y:i})):e!==null&&(a.push({x:e,y:l.y}),a.push({x:e,y:c.y}))}),a}function ko(n,t,e){for(;t>n;t--){const i=e[t];if(!isNaN(i.x)&&!isNaN(i.y))break}return t}function Cs(n,t,e,i){return n&&t?i(n[e],t[e]):n?n[e]:t?t[e]:0}function Hr(n,t){let e=[],i=!1;return ve(n)?(i=!0,e=n):e=cp(n,t),e.length?new Cn({points:e,options:{tension:0},_loop:i,_fullLoop:i}):null}function Es(n){return n&&n.fill!==!1}function dp(n,t,e){let o=n[t].fill;const a=[t];let s;if(!e)return o;for(;o!==!1&&a.indexOf(o)===-1;){if(!_e(o))return o;if(s=n[o],!s)return!1;if(s.visible)return o;a.push(o),o=s.fill}return!1}function up(n,t,e){const i=gp(n);if(ie(i))return isNaN(i.value)?!1:i;let o=parseFloat(i);return _e(o)&&Math.floor(o)===o?pp(i[0],t,o,e):["origin","start","end","stack","shape"].indexOf(i)>=0&&i}function pp(n,t,e,i){return(n==="-"||n==="+")&&(e=t+e),e===t||e<0||e>=i?!1:e}function fp(n,t){let e=null;return n==="start"?e=t.bottom:n==="end"?e=t.top:ie(n)?e=t.getPixelForValue(n.value):t.getBasePixel&&(e=t.getBasePixel()),e}function hp(n,t,e){let i;return n==="start"?i=e:n==="end"?i=t.options.reverse?t.min:t.max:ie(n)?i=n.value:i=t.getBaseValue(),i}function gp(n){const t=n.options,e=t.fill;let i=Xt(e&&e.target,e);return i===void 0&&(i=!!t.backgroundColor),i===!1||i===null?!1:i===!0?"origin":i}function mp(n){const{scale:t,index:e,line:i}=n,o=[],a=i.segments,s=i.points,r=vp(t,e);r.push(Hr({x:null,y:t.bottom},i));for(let l=0;l<a.length;l++){const c=a[l];for(let d=c.start;d<=c.end;d++)bp(o,s[d],r)}return new Cn({points:o,options:{}})}function vp(n,t){const e=[],i=n.getMatchingVisibleMetas("line");for(let o=0;o<i.length;o++){const a=i[o];if(a.index===t)break;a.hidden||e.unshift(a.dataset)}return e}function bp(n,t,e){const i=[];for(let o=0;o<e.length;o++){const a=e[o],{first:s,last:r,point:l}=yp(a,t,"x");if(!(!l||s&&r)){if(s)i.unshift(l);else if(n.push(l),!r)break}}n.push(...i)}function yp(n,t,e){const i=n.interpolate(t,e);if(!i)return{};const o=i[e],a=n.segments,s=n.points;let r=!1,l=!1;for(let c=0;c<a.length;c++){const d=a[c],u=s[d.start][e],p=s[d.end][e];if(vn(o,u,p)){r=o===u,l=o===p;break}}return{first:r,last:l,point:i}}class jr{constructor(t){this.x=t.x,this.y=t.y,this.radius=t.radius}pathSegment(t,e,i){const{x:o,y:a,radius:s}=this;return e=e||{start:0,end:me},t.arc(o,a,s,e.end,e.start,!0),!i.bounds}interpolate(t){const{x:e,y:i,radius:o}=this,a=t.angle;return{x:e+Math.cos(a)*o,y:i+Math.sin(a)*o,angle:a}}}function xp(n){const{chart:t,fill:e,line:i}=n;if(_e(e))return wp(t,e);if(e==="stack")return mp(n);if(e==="shape")return!0;const o=_p(n);return o instanceof jr?o:Hr(o,i)}function wp(n,t){const e=n.getDatasetMeta(t);return e&&n.isDatasetVisible(t)?e.dataset:null}function _p(n){return(n.scale||{}).getPointPositionForValue?kp(n):Sp(n)}function Sp(n){const{scale:t={},fill:e}=n,i=fp(e,t);if(_e(i)){const o=t.isHorizontal();return{x:o?i:null,y:o?null:i}}return null}function kp(n){const{scale:t,fill:e}=n,i=t.options,o=t.getLabels().length,a=i.reverse?t.max:t.min,s=hp(e,t,a),r=[];if(i.grid.circular){const l=t.getPointPositionForValue(0,a);return new jr({x:l.x,y:l.y,radius:t.getDistanceFromCenterForValue(s)})}for(let l=0;l<o;++l)r.push(t.getPointPositionForValue(l,s));return r}function Uo(n,t,e){const i=xp(t),{chart:o,index:a,line:s,scale:r,axis:l}=t,c=s.options,d=c.fill,u=c.backgroundColor,{above:p=u,below:f=u}=d||{},b=o.getDatasetMeta(a),v=Sr(o,b);i&&s.points.length&&(xo(n,e),Cp(n,{line:s,target:i,above:p,below:f,area:e,scale:r,axis:l,clip:v}),wo(n))}function Cp(n,t){const{line:e,target:i,above:o,below:a,area:s,scale:r,clip:l}=t,c=e._loop?"angle":t.axis;n.save();let d=a;a!==o&&(c==="x"?(Is(n,i,s.top),Ho(n,{line:e,target:i,color:o,scale:r,property:c,clip:l}),n.restore(),n.save(),Is(n,i,s.bottom)):c==="y"&&(Ds(n,i,s.left),Ho(n,{line:e,target:i,color:a,scale:r,property:c,clip:l}),n.restore(),n.save(),Ds(n,i,s.right),d=o)),Ho(n,{line:e,target:i,color:d,scale:r,property:c,clip:l}),n.restore()}function Is(n,t,e){const{segments:i,points:o}=t;let a=!0,s=!1;n.beginPath();for(const r of i){const{start:l,end:c}=r,d=o[l],u=o[ko(l,c,o)];a?(n.moveTo(d.x,d.y),a=!1):(n.lineTo(d.x,e),n.lineTo(d.x,d.y)),s=!!t.pathSegment(n,r,{move:s}),s?n.closePath():n.lineTo(u.x,e)}n.lineTo(t.first().x,e),n.closePath(),n.clip()}function Ds(n,t,e){const{segments:i,points:o}=t;let a=!0,s=!1;n.beginPath();for(const r of i){const{start:l,end:c}=r,d=o[l],u=o[ko(l,c,o)];a?(n.moveTo(d.x,d.y),a=!1):(n.lineTo(e,d.y),n.lineTo(d.x,d.y)),s=!!t.pathSegment(n,r,{move:s}),s?n.closePath():n.lineTo(e,u.y)}n.lineTo(e,t.first().y),n.closePath(),n.clip()}function Ho(n,t){const{line:e,target:i,property:o,color:a,scale:s,clip:r}=t,l=lp(e,i,o);for(const{source:c,target:d,start:u,end:p}of l){const{style:{backgroundColor:f=a}={}}=c,b=i!==!0;n.save(),n.fillStyle=f,Ep(n,s,r,b&&Qo(o,u,p)),n.beginPath();const v=!!e.pathSegment(n,c);let y;if(b){v?n.closePath():Ts(n,i,p,o);const E=!!i.pathSegment(n,d,{move:v,reverse:!0});y=v&&E,y||Ts(n,i,u,o)}n.closePath(),n.fill(y?"evenodd":"nonzero"),n.restore()}}function Ep(n,t,e,i){const o=t.chart.chartArea,{property:a,start:s,end:r}=i||{};if(a==="x"||a==="y"){let l,c,d,u;a==="x"?(l=s,c=o.top,d=r,u=o.bottom):(l=o.left,c=s,d=o.right,u=r),n.beginPath(),e&&(l=Math.max(l,e.left),d=Math.min(d,e.right),c=Math.max(c,e.top),u=Math.min(u,e.bottom)),n.rect(l,c,d-l,u-c),n.clip()}}function Ts(n,t,e,i){const o=t.interpolate(e,i);o&&n.lineTo(o.x,o.y)}var Ip={id:"filler",afterDatasetsUpdate(n,t,e){const i=(n.data.datasets||[]).length,o=[];let a,s,r,l;for(s=0;s<i;++s)a=n.getDatasetMeta(s),r=a.dataset,l=null,r&&r.options&&r instanceof Cn&&(l={visible:n.isDatasetVisible(s),index:s,fill:up(r,s,i),chart:n,axis:a.controller.options.indexAxis,scale:a.vScale,line:r}),a.$filler=l,o.push(l);for(s=0;s<i;++s)l=o[s],!(!l||l.fill===!1)&&(l.fill=dp(o,s,e.propagate))},beforeDraw(n,t,e){const i=e.drawTime==="beforeDraw",o=n.getSortedVisibleDatasetMetas(),a=n.chartArea;for(let s=o.length-1;s>=0;--s){const r=o[s].$filler;r&&(r.line.updateControlPoints(a,r.axis),i&&r.fill&&Uo(n.ctx,r,a))}},beforeDatasetsDraw(n,t,e){if(e.drawTime!=="beforeDatasetsDraw")return;const i=n.getSortedVisibleDatasetMetas();for(let o=i.length-1;o>=0;--o){const a=i[o].$filler;Es(a)&&Uo(n.ctx,a,n.chartArea)}},beforeDatasetDraw(n,t,e){const i=t.meta.$filler;!Es(i)||e.drawTime!=="beforeDatasetDraw"||Uo(n.ctx,i,n.chartArea)},defaults:{propagate:!0,drawTime:"beforeDatasetDraw"}};const Ms=(n,t)=>{let{boxHeight:e=t,boxWidth:i=t}=n;return n.usePointStyle&&(e=Math.min(e,t),i=n.pointStyleWidth||Math.min(i,t)),{boxWidth:i,boxHeight:e,itemHeight:Math.max(t,e)}},Dp=(n,t)=>n!==null&&t!==null&&n.datasetIndex===t.datasetIndex&&n.index===t.index;class Ps extends en{constructor(t){super(),this._added=!1,this.legendHitBoxes=[],this._hoveredItem=null,this.doughnutMode=!1,this.chart=t.chart,this.options=t.options,this.ctx=t.ctx,this.legendItems=void 0,this.columnSizes=void 0,this.lineWidths=void 0,this.maxHeight=void 0,this.maxWidth=void 0,this.top=void 0,this.bottom=void 0,this.left=void 0,this.right=void 0,this.height=void 0,this.width=void 0,this._margins=void 0,this.position=void 0,this.weight=void 0,this.fullSize=void 0}update(t,e,i){this.maxWidth=t,this.maxHeight=e,this._margins=i,this.setDimensions(),this.buildLabels(),this.fit()}setDimensions(){this.isHorizontal()?(this.width=this.maxWidth,this.left=this._margins.left,this.right=this.width):(this.height=this.maxHeight,this.top=this._margins.top,this.bottom=this.height)}buildLabels(){const t=this.options.labels||{};let e=ge(t.generateLabels,[this.chart],this)||[];t.filter&&(e=e.filter(i=>t.filter(i,this.chart.data))),t.sort&&(e=e.sort((i,o)=>t.sort(i,o,this.chart.data))),this.options.reverse&&e.reverse(),this.legendItems=e}fit(){const{options:t,ctx:e}=this;if(!t.display){this.width=this.height=0;return}const i=t.labels,o=Me(i.font),a=o.size,s=this._computeTitleHeight(),{boxWidth:r,itemHeight:l}=Ms(i,a);let c,d;e.font=o.string,this.isHorizontal()?(c=this.maxWidth,d=this._fitRows(s,a,r,l)+10):(d=this.maxHeight,c=this._fitCols(s,o,r,l)+10),this.width=Math.min(c,t.maxWidth||this.maxWidth),this.height=Math.min(d,t.maxHeight||this.maxHeight)}_fitRows(t,e,i,o){const{ctx:a,maxWidth:s,options:{labels:{padding:r}}}=this,l=this.legendHitBoxes=[],c=this.lineWidths=[0],d=o+r;let u=t;a.textAlign="left",a.textBaseline="middle";let p=-1,f=-d;return this.legendItems.forEach((b,v)=>{const y=i+e/2+a.measureText(b.text).width;(v===0||c[c.length-1]+y+2*r>s)&&(u+=d,c[c.length-(v>0?0:1)]=0,f+=d,p++),l[v]={left:0,top:f,row:p,width:y,height:o},c[c.length-1]+=y+r}),u}_fitCols(t,e,i,o){const{ctx:a,maxHeight:s,options:{labels:{padding:r}}}=this,l=this.legendHitBoxes=[],c=this.columnSizes=[],d=s-t;let u=r,p=0,f=0,b=0,v=0;return this.legendItems.forEach((y,E)=>{const{itemWidth:M,itemHeight:X}=Tp(i,e,a,y,o);E>0&&f+X+2*r>d&&(u+=p+r,c.push({width:p,height:f}),b+=p+r,v++,p=f=0),l[E]={left:b,top:f,col:v,width:M,height:X},p=Math.max(p,M),f+=X+r}),u+=p,c.push({width:p,height:f}),u}adjustHitBoxes(){if(!this.options.display)return;const t=this._computeTitleHeight(),{legendHitBoxes:e,options:{align:i,labels:{padding:o},rtl:a}}=this,s=Zn(a,this.left,this.width);if(this.isHorizontal()){let r=0,l=Ne(i,this.left+o,this.right-this.lineWidths[r]);for(const c of e)r!==c.row&&(r=c.row,l=Ne(i,this.left+o,this.right-this.lineWidths[r])),c.top+=this.top+t+o,c.left=s.leftForLtr(s.x(l),c.width),l+=c.width+o}else{let r=0,l=Ne(i,this.top+t+o,this.bottom-this.columnSizes[r].height);for(const c of e)c.col!==r&&(r=c.col,l=Ne(i,this.top+t+o,this.bottom-this.columnSizes[r].height)),c.top=l,c.left+=this.left+o,c.left=s.leftForLtr(s.x(c.left),c.width),l+=c.height+o}}isHorizontal(){return this.options.position==="top"||this.options.position==="bottom"}draw(){if(this.options.display){const t=this.ctx;xo(t,this),this._draw(),wo(t)}}_draw(){const{options:t,columnSizes:e,lineWidths:i,ctx:o}=this,{align:a,labels:s}=t,r=be.color,l=Zn(t.rtl,this.left,this.width),c=Me(s.font),{padding:d}=s,u=c.size,p=u/2;let f;this.drawTitle(),o.textAlign=l.textAlign("left"),o.textBaseline="middle",o.lineWidth=.5,o.font=c.string;const{boxWidth:b,boxHeight:v,itemHeight:y}=Ms(s,u),E=function(ft,ut,ct){if(isNaN(b)||b<=0||isNaN(v)||v<0)return;o.save();const It=Xt(ct.lineWidth,1);if(o.fillStyle=Xt(ct.fillStyle,r),o.lineCap=Xt(ct.lineCap,"butt"),o.lineDashOffset=Xt(ct.lineDashOffset,0),o.lineJoin=Xt(ct.lineJoin,"miter"),o.lineWidth=It,o.strokeStyle=Xt(ct.strokeStyle,r),o.setLineDash(Xt(ct.lineDash,[])),s.usePointStyle){const Ot={radius:v*Math.SQRT2/2,pointStyle:ct.pointStyle,rotation:ct.rotation,borderWidth:It},Ut=l.xPlus(ft,b/2),Vt=ut+p;dr(o,Ot,Ut,Vt,s.pointStyleWidth&&b)}else{const Ot=ut+Math.max((u-v)/2,0),Ut=l.leftForLtr(ft,b),Vt=Vn(ct.borderRadius);o.beginPath(),Object.values(Vt).some(Mt=>Mt!==0)?Di(o,{x:Ut,y:Ot,w:b,h:v,radius:Vt}):o.rect(Ut,Ot,b,v),o.fill(),It!==0&&o.stroke()}o.restore()},M=function(ft,ut,ct){jn(o,ct.text,ft,ut+y/2,c,{strikethrough:ct.hidden,textAlign:l.textAlign(ct.textAlign)})},X=this.isHorizontal(),it=this._computeTitleHeight();X?f={x:Ne(a,this.left+d,this.right-i[0]),y:this.top+d+it,line:0}:f={x:this.left+d,y:Ne(a,this.top+it+d,this.bottom-e[0].height),line:0},br(this.ctx,t.textDirection);const Q=y+d;this.legendItems.forEach((ft,ut)=>{o.strokeStyle=ft.fontColor,o.fillStyle=ft.fontColor;const ct=o.measureText(ft.text).width,It=l.textAlign(ft.textAlign||(ft.textAlign=s.textAlign)),Ot=b+p+ct;let Ut=f.x,Vt=f.y;l.setWidth(this.width),X?ut>0&&Ut+Ot+d>this.right&&(Vt=f.y+=Q,f.line++,Ut=f.x=Ne(a,this.left+d,this.right-i[f.line])):ut>0&&Vt+Q>this.bottom&&(Ut=f.x=Ut+e[f.line].width+d,f.line++,Vt=f.y=Ne(a,this.top+it+d,this.bottom-e[f.line].height));const Mt=l.x(Ut);if(E(Mt,Vt,ft),Ut=Gl(It,Ut+b+p,X?Ut+Ot:this.right,t.rtl),M(l.x(Ut),Vt,ft),X)f.x+=Ot+d;else if(typeof ft.text!="string"){const $t=c.lineHeight;f.y+=Wr(ft,$t)+d}else f.y+=Q}),yr(this.ctx,t.textDirection)}drawTitle(){const t=this.options,e=t.title,i=Me(e.font),o=ze(e.padding);if(!e.display)return;const a=Zn(t.rtl,this.left,this.width),s=this.ctx,r=e.position,l=i.size/2,c=o.top+l;let d,u=this.left,p=this.width;if(this.isHorizontal())p=Math.max(...this.lineWidths),d=this.top+c,u=Ne(t.align,u,this.right-p);else{const b=this.columnSizes.reduce((v,y)=>Math.max(v,y.height),0);d=c+Ne(t.align,this.top,this.bottom-b-t.labels.padding-this._computeTitleHeight())}const f=Ne(r,u,u+p);s.textAlign=a.textAlign(fa(r)),s.textBaseline="middle",s.strokeStyle=e.color,s.fillStyle=e.color,s.font=i.string,jn(s,e.text,f,d,i)}_computeTitleHeight(){const t=this.options.title,e=Me(t.font),i=ze(t.padding);return t.display?e.lineHeight+i.height:0}_getLegendItemAt(t,e){let i,o,a;if(vn(t,this.left,this.right)&&vn(e,this.top,this.bottom)){for(a=this.legendHitBoxes,i=0;i<a.length;++i)if(o=a[i],vn(t,o.left,o.left+o.width)&&vn(e,o.top,o.top+o.height))return this.legendItems[i]}return null}handleEvent(t){const e=this.options;if(!Ap(t.type,e))return;const i=this._getLegendItemAt(t.x,t.y);if(t.type==="mousemove"||t.type==="mouseout"){const o=this._hoveredItem,a=Dp(o,i);o&&!a&&ge(e.onLeave,[t,o,this],this),this._hoveredItem=i,i&&!a&&ge(e.onHover,[t,i,this],this)}else i&&ge(e.onClick,[t,i,this],this)}}function Tp(n,t,e,i,o){const a=Mp(i,n,t,e),s=Pp(o,i,t.lineHeight);return{itemWidth:a,itemHeight:s}}function Mp(n,t,e,i){let o=n.text;return o&&typeof o!="string"&&(o=o.reduce((a,s)=>a.length>s.length?a:s)),t+e.size/2+i.measureText(o).width}function Pp(n,t,e){let i=n;return typeof t.text!="string"&&(i=Wr(t,e)),i}function Wr(n,t){const e=n.text?n.text.length:0;return t*e}function Ap(n,t){return!!((n==="mousemove"||n==="mouseout")&&(t.onHover||t.onLeave)||t.onClick&&(n==="click"||n==="mouseup"))}var Bp={id:"legend",_element:Ps,start(n,t,e){const i=n.legend=new Ps({ctx:n.ctx,options:e,chart:n});Re.configure(n,i,e),Re.addBox(n,i)},stop(n){Re.removeBox(n,n.legend),delete n.legend},beforeUpdate(n,t,e){const i=n.legend;Re.configure(n,i,e),i.options=e},afterUpdate(n){const t=n.legend;t.buildLabels(),t.adjustHitBoxes()},afterEvent(n,t){t.replay||n.legend.handleEvent(t.event)},defaults:{display:!0,position:"top",align:"center",fullSize:!0,reverse:!1,weight:1e3,onClick(n,t,e){const i=t.datasetIndex,o=e.chart;o.isDatasetVisible(i)?(o.hide(i),t.hidden=!0):(o.show(i),t.hidden=!1)},onHover:null,onLeave:null,labels:{color:n=>n.chart.options.color,boxWidth:40,padding:10,generateLabels(n){const t=n.data.datasets,{labels:{usePointStyle:e,pointStyle:i,textAlign:o,color:a,useBorderRadius:s,borderRadius:r}}=n.legend.options;return n._getSortedDatasetMetas().map(l=>{const c=l.controller.getStyle(e?0:void 0),d=ze(c.borderWidth);return{text:t[l.index].label,fillStyle:c.backgroundColor,fontColor:a,hidden:!l.visible,lineCap:c.borderCapStyle,lineDash:c.borderDash,lineDashOffset:c.borderDashOffset,lineJoin:c.borderJoinStyle,lineWidth:(d.width+d.height)/4,strokeStyle:c.borderColor,pointStyle:i||c.pointStyle,rotation:c.rotation,textAlign:o||c.textAlign,borderRadius:s&&(r||c.borderRadius),datasetIndex:l.index}},this)}},title:{color:n=>n.chart.options.color,display:!1,position:"center",text:""}},descriptors:{_scriptable:n=>!n.startsWith("on"),labels:{_scriptable:n=>!["generateLabels","filter","sort"].includes(n)}}};class _a extends en{constructor(t){super(),this.chart=t.chart,this.options=t.options,this.ctx=t.ctx,this._padding=void 0,this.top=void 0,this.bottom=void 0,this.left=void 0,this.right=void 0,this.width=void 0,this.height=void 0,this.position=void 0,this.weight=void 0,this.fullSize=void 0}update(t,e){const i=this.options;if(this.left=0,this.top=0,!i.display){this.width=this.height=this.right=this.bottom=0;return}this.width=this.right=t,this.height=this.bottom=e;const o=ve(i.text)?i.text.length:1;this._padding=ze(i.padding);const a=o*Me(i.font).lineHeight+this._padding.height;this.isHorizontal()?this.height=a:this.width=a}isHorizontal(){const t=this.options.position;return t==="top"||t==="bottom"}_drawArgs(t){const{top:e,left:i,bottom:o,right:a,options:s}=this,r=s.align;let l=0,c,d,u;return this.isHorizontal()?(d=Ne(r,i,a),u=e+t,c=a-i):(s.position==="left"?(d=i+t,u=Ne(r,o,e),l=de*-.5):(d=a-t,u=Ne(r,e,o),l=de*.5),c=o-e),{titleX:d,titleY:u,maxWidth:c,rotation:l}}draw(){const t=this.ctx,e=this.options;if(!e.display)return;const i=Me(e.font),a=i.lineHeight/2+this._padding.top,{titleX:s,titleY:r,maxWidth:l,rotation:c}=this._drawArgs(a);jn(t,e.text,0,0,i,{color:e.color,maxWidth:l,rotation:c,textAlign:fa(e.align),textBaseline:"middle",translation:[s,r]})}}function Lp(n,t){const e=new _a({ctx:n.ctx,options:t,chart:n});Re.configure(n,e,t),Re.addBox(n,e),n.titleBlock=e}var Op={id:"title",_element:_a,start(n,t,e){Lp(n,e)},stop(n){const t=n.titleBlock;Re.removeBox(n,t),delete n.titleBlock},beforeUpdate(n,t,e){const i=n.titleBlock;Re.configure(n,i,e),i.options=e},defaults:{align:"center",display:!1,font:{weight:"bold"},fullSize:!0,padding:10,position:"top",text:"",weight:2e3},defaultRoutes:{color:"color"},descriptors:{_scriptable:!0,_indexable:!1}};const Yi=new WeakMap;var Np={id:"subtitle",start(n,t,e){const i=new _a({ctx:n.ctx,options:e,chart:n});Re.configure(n,i,e),Re.addBox(n,i),Yi.set(n,i)},stop(n){Re.removeBox(n,Yi.get(n)),Yi.delete(n)},beforeUpdate(n,t,e){const i=Yi.get(n);Re.configure(n,i,e),i.options=e},defaults:{align:"center",display:!1,font:{weight:"normal"},fullSize:!0,padding:0,position:"top",text:"",weight:1500},defaultRoutes:{color:"color"},descriptors:{_scriptable:!0,_indexable:!1}};const gi={average(n){if(!n.length)return!1;let t,e,i=new Set,o=0,a=0;for(t=0,e=n.length;t<e;++t){const r=n[t].element;if(r&&r.hasValue()){const l=r.tooltipPosition();i.add(l.x),o+=l.y,++a}}return a===0||i.size===0?!1:{x:[...i].reduce((r,l)=>r+l)/i.size,y:o/a}},nearest(n,t){if(!n.length)return!1;let e=t.x,i=t.y,o=Number.POSITIVE_INFINITY,a,s,r;for(a=0,s=n.length;a<s;++a){const l=n[a].element;if(l&&l.hasValue()){const c=l.getCenterPoint(),d=Yo(t,c);d<o&&(o=d,r=l)}}if(r){const l=r.tooltipPosition();e=l.x,i=l.y}return{x:e,y:i}}};function nn(n,t){return t&&(ve(t)?Array.prototype.push.apply(n,t):n.push(t)),n}function hn(n){return(typeof n=="string"||n instanceof String)&&n.indexOf("\n")>-1?n.split("\n"):n}function Fp(n,t){const{element:e,datasetIndex:i,index:o}=t,a=n.getDatasetMeta(i).controller,{label:s,value:r}=a.getLabelAndValue(o);return{chart:n,label:s,parsed:a.getParsed(o),raw:n.data.datasets[i].data[o],formattedValue:r,dataset:a.getDataset(),dataIndex:o,datasetIndex:i,element:e}}function As(n,t){const e=n.chart.ctx,{body:i,footer:o,title:a}=n,{boxWidth:s,boxHeight:r}=t,l=Me(t.bodyFont),c=Me(t.titleFont),d=Me(t.footerFont),u=a.length,p=o.length,f=i.length,b=ze(t.padding);let v=b.height,y=0,E=i.reduce((it,Q)=>it+Q.before.length+Q.lines.length+Q.after.length,0);if(E+=n.beforeBody.length+n.afterBody.length,u&&(v+=u*c.lineHeight+(u-1)*t.titleSpacing+t.titleMarginBottom),E){const it=t.displayColors?Math.max(r,l.lineHeight):l.lineHeight;v+=f*it+(E-f)*l.lineHeight+(E-1)*t.bodySpacing}p&&(v+=t.footerMarginTop+p*d.lineHeight+(p-1)*t.footerSpacing);let M=0;const X=function(it){y=Math.max(y,e.measureText(it).width+M)};return e.save(),e.font=c.string,fe(n.title,X),e.font=l.string,fe(n.beforeBody.concat(n.afterBody),X),M=t.displayColors?s+2+t.boxPadding:0,fe(i,it=>{fe(it.before,X),fe(it.lines,X),fe(it.after,X)}),M=0,e.font=d.string,fe(n.footer,X),e.restore(),y+=b.width,{width:y,height:v}}function Rp(n,t){const{y:e,height:i}=t;return e<i/2?"top":e>n.height-i/2?"bottom":"center"}function zp(n,t,e,i){const{x:o,width:a}=i,s=e.caretSize+e.caretPadding;if(n==="left"&&o+a+s>t.width||n==="right"&&o-a-s<0)return!0}function Vp(n,t,e,i){const{x:o,width:a}=e,{width:s,chartArea:{left:r,right:l}}=n;let c="center";return i==="center"?c=o<=(r+l)/2?"left":"right":o<=a/2?c="left":o>=s-a/2&&(c="right"),zp(c,n,t,e)&&(c="center"),c}function Bs(n,t,e){const i=e.yAlign||t.yAlign||Rp(n,e);return{xAlign:e.xAlign||t.xAlign||Vp(n,t,e,i),yAlign:i}}function Up(n,t){let{x:e,width:i}=n;return t==="right"?e-=i:t==="center"&&(e-=i/2),e}function Hp(n,t,e){let{y:i,height:o}=n;return t==="top"?i+=e:t==="bottom"?i-=o+e:i-=o/2,i}function Ls(n,t,e,i){const{caretSize:o,caretPadding:a,cornerRadius:s}=n,{xAlign:r,yAlign:l}=e,c=o+a,{topLeft:d,topRight:u,bottomLeft:p,bottomRight:f}=Vn(s);let b=Up(t,r);const v=Hp(t,l,c);return l==="center"?r==="left"?b+=c:r==="right"&&(b-=c):r==="left"?b-=Math.max(d,p)+o:r==="right"&&(b+=Math.max(u,f)+o),{x:Ae(b,0,i.width-t.width),y:Ae(v,0,i.height-t.height)}}function $i(n,t,e){const i=ze(e.padding);return t==="center"?n.x+n.width/2:t==="right"?n.x+n.width-i.right:n.x+i.left}function Os(n){return nn([],hn(n))}function jp(n,t,e){return Mn(n,{tooltip:t,tooltipItems:e,type:"tooltip"})}function Ns(n,t){const e=t&&t.dataset&&t.dataset.tooltip&&t.dataset.tooltip.callbacks;return e?n.override(e):n}const Yr={beforeTitle:un,title(n){if(n.length>0){const t=n[0],e=t.chart.data.labels,i=e?e.length:0;if(this&&this.options&&this.options.mode==="dataset")return t.dataset.label||"";if(t.label)return t.label;if(i>0&&t.dataIndex<i)return e[t.dataIndex]}return""},afterTitle:un,beforeBody:un,beforeLabel:un,label(n){if(this&&this.options&&this.options.mode==="dataset")return n.label+": "+n.formattedValue||n.formattedValue;let t=n.dataset.label||"";t&&(t+=": ");const e=n.formattedValue;return ne(e)||(t+=e),t},labelColor(n){const e=n.chart.getDatasetMeta(n.datasetIndex).controller.getStyle(n.dataIndex);return{borderColor:e.borderColor,backgroundColor:e.backgroundColor,borderWidth:e.borderWidth,borderDash:e.borderDash,borderDashOffset:e.borderDashOffset,borderRadius:0}},labelTextColor(){return this.options.bodyColor},labelPointStyle(n){const e=n.chart.getDatasetMeta(n.datasetIndex).controller.getStyle(n.dataIndex);return{pointStyle:e.pointStyle,rotation:e.rotation}},afterLabel:un,afterBody:un,beforeFooter:un,footer:un,afterFooter:un};function Ye(n,t,e,i){const o=n[t].call(e,i);return typeof o>"u"?Yr[t].call(e,i):o}class ta extends en{constructor(t){super(),this.opacity=0,this._active=[],this._eventPosition=void 0,this._size=void 0,this._cachedAnimations=void 0,this._tooltipItems=[],this.$animations=void 0,this.$context=void 0,this.chart=t.chart,this.options=t.options,this.dataPoints=void 0,this.title=void 0,this.beforeBody=void 0,this.body=void 0,this.afterBody=void 0,this.footer=void 0,this.xAlign=void 0,this.yAlign=void 0,this.x=void 0,this.y=void 0,this.height=void 0,this.width=void 0,this.caretX=void 0,this.caretY=void 0,this.labelColors=void 0,this.labelPointStyles=void 0,this.labelTextColors=void 0}initialize(t){this.options=t,this._cachedAnimations=void 0,this.$context=void 0}_resolveAnimations(){const t=this._cachedAnimations;if(t)return t;const e=this.chart,i=this.options.setContext(this.getContext()),o=i.enabled&&e.options.animation&&i.animations,a=new kr(this.chart,o);return o._cacheable&&(this._cachedAnimations=Object.freeze(a)),a}getContext(){return this.$context||(this.$context=jp(this.chart.getContext(),this,this._tooltipItems))}getTitle(t,e){const{callbacks:i}=e,o=Ye(i,"beforeTitle",this,t),a=Ye(i,"title",this,t),s=Ye(i,"afterTitle",this,t);let r=[];return r=nn(r,hn(o)),r=nn(r,hn(a)),r=nn(r,hn(s)),r}getBeforeBody(t,e){return Os(Ye(e.callbacks,"beforeBody",this,t))}getBody(t,e){const{callbacks:i}=e,o=[];return fe(t,a=>{const s={before:[],lines:[],after:[]},r=Ns(i,a);nn(s.before,hn(Ye(r,"beforeLabel",this,a))),nn(s.lines,Ye(r,"label",this,a)),nn(s.after,hn(Ye(r,"afterLabel",this,a))),o.push(s)}),o}getAfterBody(t,e){return Os(Ye(e.callbacks,"afterBody",this,t))}getFooter(t,e){const{callbacks:i}=e,o=Ye(i,"beforeFooter",this,t),a=Ye(i,"footer",this,t),s=Ye(i,"afterFooter",this,t);let r=[];return r=nn(r,hn(o)),r=nn(r,hn(a)),r=nn(r,hn(s)),r}_createItems(t){const e=this._active,i=this.chart.data,o=[],a=[],s=[];let r=[],l,c;for(l=0,c=e.length;l<c;++l)r.push(Fp(this.chart,e[l]));return t.filter&&(r=r.filter((d,u,p)=>t.filter(d,u,p,i))),t.itemSort&&(r=r.sort((d,u)=>t.itemSort(d,u,i))),fe(r,d=>{const u=Ns(t.callbacks,d);o.push(Ye(u,"labelColor",this,d)),a.push(Ye(u,"labelPointStyle",this,d)),s.push(Ye(u,"labelTextColor",this,d))}),this.labelColors=o,this.labelPointStyles=a,this.labelTextColors=s,this.dataPoints=r,r}update(t,e){const i=this.options.setContext(this.getContext()),o=this._active;let a,s=[];if(!o.length)this.opacity!==0&&(a={opacity:0});else{const r=gi[i.position].call(this,o,this._eventPosition);s=this._createItems(i),this.title=this.getTitle(s,i),this.beforeBody=this.getBeforeBody(s,i),this.body=this.getBody(s,i),this.afterBody=this.getAfterBody(s,i),this.footer=this.getFooter(s,i);const l=this._size=As(this,i),c=Object.assign({},r,l),d=Bs(this.chart,i,c),u=Ls(i,c,d,this.chart);this.xAlign=d.xAlign,this.yAlign=d.yAlign,a={opacity:1,x:u.x,y:u.y,width:l.width,height:l.height,caretX:r.x,caretY:r.y}}this._tooltipItems=s,this.$context=void 0,a&&this._resolveAnimations().update(this,a),t&&i.external&&i.external.call(this,{chart:this.chart,tooltip:this,replay:e})}drawCaret(t,e,i,o){const a=this.getCaretPosition(t,i,o);e.lineTo(a.x1,a.y1),e.lineTo(a.x2,a.y2),e.lineTo(a.x3,a.y3)}getCaretPosition(t,e,i){const{xAlign:o,yAlign:a}=this,{caretSize:s,cornerRadius:r}=i,{topLeft:l,topRight:c,bottomLeft:d,bottomRight:u}=Vn(r),{x:p,y:f}=t,{width:b,height:v}=e;let y,E,M,X,it,Q;return a==="center"?(it=f+v/2,o==="left"?(y=p,E=y-s,X=it+s,Q=it-s):(y=p+b,E=y+s,X=it-s,Q=it+s),M=y):(o==="left"?E=p+Math.max(l,d)+s:o==="right"?E=p+b-Math.max(c,u)-s:E=this.caretX,a==="top"?(X=f,it=X-s,y=E-s,M=E+s):(X=f+v,it=X+s,y=E+s,M=E-s),Q=X),{x1:y,x2:E,x3:M,y1:X,y2:it,y3:Q}}drawTitle(t,e,i){const o=this.title,a=o.length;let s,r,l;if(a){const c=Zn(i.rtl,this.x,this.width);for(t.x=$i(this,i.titleAlign,i),e.textAlign=c.textAlign(i.titleAlign),e.textBaseline="middle",s=Me(i.titleFont),r=i.titleSpacing,e.fillStyle=i.titleColor,e.font=s.string,l=0;l<a;++l)e.fillText(o[l],c.x(t.x),t.y+s.lineHeight/2),t.y+=s.lineHeight+r,l+1===a&&(t.y+=i.titleMarginBottom-r)}}_drawColorBox(t,e,i,o,a){const s=this.labelColors[i],r=this.labelPointStyles[i],{boxHeight:l,boxWidth:c}=a,d=Me(a.bodyFont),u=$i(this,"left",a),p=o.x(u),f=l<d.lineHeight?(d.lineHeight-l)/2:0,b=e.y+f;if(a.usePointStyle){const v={radius:Math.min(c,l)/2,pointStyle:r.pointStyle,rotation:r.rotation,borderWidth:1},y=o.leftForLtr(p,c)+c/2,E=b+l/2;t.strokeStyle=a.multiKeyBackground,t.fillStyle=a.multiKeyBackground,qo(t,v,y,E),t.strokeStyle=s.borderColor,t.fillStyle=s.backgroundColor,qo(t,v,y,E)}else{t.lineWidth=ie(s.borderWidth)?Math.max(...Object.values(s.borderWidth)):s.borderWidth||1,t.strokeStyle=s.borderColor,t.setLineDash(s.borderDash||[]),t.lineDashOffset=s.borderDashOffset||0;const v=o.leftForLtr(p,c),y=o.leftForLtr(o.xPlus(p,1),c-2),E=Vn(s.borderRadius);Object.values(E).some(M=>M!==0)?(t.beginPath(),t.fillStyle=a.multiKeyBackground,Di(t,{x:v,y:b,w:c,h:l,radius:E}),t.fill(),t.stroke(),t.fillStyle=s.backgroundColor,t.beginPath(),Di(t,{x:y,y:b+1,w:c-2,h:l-2,radius:E}),t.fill()):(t.fillStyle=a.multiKeyBackground,t.fillRect(v,b,c,l),t.strokeRect(v,b,c,l),t.fillStyle=s.backgroundColor,t.fillRect(y,b+1,c-2,l-2))}t.fillStyle=this.labelTextColors[i]}drawBody(t,e,i){const{body:o}=this,{bodySpacing:a,bodyAlign:s,displayColors:r,boxHeight:l,boxWidth:c,boxPadding:d}=i,u=Me(i.bodyFont);let p=u.lineHeight,f=0;const b=Zn(i.rtl,this.x,this.width),v=function(ct){e.fillText(ct,b.x(t.x+f),t.y+p/2),t.y+=p+a},y=b.textAlign(s);let E,M,X,it,Q,ft,ut;for(e.textAlign=s,e.textBaseline="middle",e.font=u.string,t.x=$i(this,y,i),e.fillStyle=i.bodyColor,fe(this.beforeBody,v),f=r&&y!=="right"?s==="center"?c/2+d:c+2+d:0,it=0,ft=o.length;it<ft;++it){for(E=o[it],M=this.labelTextColors[it],e.fillStyle=M,fe(E.before,v),X=E.lines,r&&X.length&&(this._drawColorBox(e,t,it,b,i),p=Math.max(u.lineHeight,l)),Q=0,ut=X.length;Q<ut;++Q)v(X[Q]),p=u.lineHeight;fe(E.after,v)}f=0,p=u.lineHeight,fe(this.afterBody,v),t.y-=a}drawFooter(t,e,i){const o=this.footer,a=o.length;let s,r;if(a){const l=Zn(i.rtl,this.x,this.width);for(t.x=$i(this,i.footerAlign,i),t.y+=i.footerMarginTop,e.textAlign=l.textAlign(i.footerAlign),e.textBaseline="middle",s=Me(i.footerFont),e.fillStyle=i.footerColor,e.font=s.string,r=0;r<a;++r)e.fillText(o[r],l.x(t.x),t.y+s.lineHeight/2),t.y+=s.lineHeight+i.footerSpacing}}drawBackground(t,e,i,o){const{xAlign:a,yAlign:s}=this,{x:r,y:l}=t,{width:c,height:d}=i,{topLeft:u,topRight:p,bottomLeft:f,bottomRight:b}=Vn(o.cornerRadius);e.fillStyle=o.backgroundColor,e.strokeStyle=o.borderColor,e.lineWidth=o.borderWidth,e.beginPath(),e.moveTo(r+u,l),s==="top"&&this.drawCaret(t,e,i,o),e.lineTo(r+c-p,l),e.quadraticCurveTo(r+c,l,r+c,l+p),s==="center"&&a==="right"&&this.drawCaret(t,e,i,o),e.lineTo(r+c,l+d-b),e.quadraticCurveTo(r+c,l+d,r+c-b,l+d),s==="bottom"&&this.drawCaret(t,e,i,o),e.lineTo(r+f,l+d),e.quadraticCurveTo(r,l+d,r,l+d-f),s==="center"&&a==="left"&&this.drawCaret(t,e,i,o),e.lineTo(r,l+u),e.quadraticCurveTo(r,l,r+u,l),e.closePath(),e.fill(),o.borderWidth>0&&e.stroke()}_updateAnimationTarget(t){const e=this.chart,i=this.$animations,o=i&&i.x,a=i&&i.y;if(o||a){const s=gi[t.position].call(this,this._active,this._eventPosition);if(!s)return;const r=this._size=As(this,t),l=Object.assign({},s,this._size),c=Bs(e,t,l),d=Ls(t,l,c,e);(o._to!==d.x||a._to!==d.y)&&(this.xAlign=c.xAlign,this.yAlign=c.yAlign,this.width=r.width,this.height=r.height,this.caretX=s.x,this.caretY=s.y,this._resolveAnimations().update(this,d))}}_willRender(){return!!this.opacity}draw(t){const e=this.options.setContext(this.getContext());let i=this.opacity;if(!i)return;this._updateAnimationTarget(e);const o={width:this.width,height:this.height},a={x:this.x,y:this.y};i=Math.abs(i)<.001?0:i;const s=ze(e.padding),r=this.title.length||this.beforeBody.length||this.body.length||this.afterBody.length||this.footer.length;e.enabled&&r&&(t.save(),t.globalAlpha=i,this.drawBackground(a,t,o,e),br(t,e.textDirection),a.y+=s.top,this.drawTitle(a,t,e),this.drawBody(a,t,e),this.drawFooter(a,t,e),yr(t,e.textDirection),t.restore())}getActiveElements(){return this._active||[]}setActiveElements(t,e){const i=this._active,o=t.map(({datasetIndex:r,index:l})=>{const c=this.chart.getDatasetMeta(r);if(!c)throw new Error("Cannot find a dataset at index "+r);return{datasetIndex:r,element:c.data[l],index:l}}),a=!lo(i,o),s=this._positionChanged(o,e);(a||s)&&(this._active=o,this._eventPosition=e,this._ignoreReplayEvents=!0,this.update(!0))}handleEvent(t,e,i=!0){if(e&&this._ignoreReplayEvents)return!1;this._ignoreReplayEvents=!1;const o=this.options,a=this._active||[],s=this._getActiveElements(t,a,e,i),r=this._positionChanged(s,t),l=e||!lo(s,a)||r;return l&&(this._active=s,(o.enabled||o.external)&&(this._eventPosition={x:t.x,y:t.y},this.update(!0,e))),l}_getActiveElements(t,e,i,o){const a=this.options;if(t.type==="mouseout")return[];if(!o)return e.filter(r=>this.chart.data.datasets[r.datasetIndex]&&this.chart.getDatasetMeta(r.datasetIndex).controller.getParsed(r.index)!==void 0);const s=this.chart.getElementsAtEventForMode(t,a.mode,a,i);return a.reverse&&s.reverse(),s}_positionChanged(t,e){const{caretX:i,caretY:o,options:a}=this,s=gi[a.position].call(this,t,e);return s!==!1&&(i!==s.x||o!==s.y)}}St(ta,"positioners",gi);var Wp={id:"tooltip",_element:ta,positioners:gi,afterInit(n,t,e){e&&(n.tooltip=new ta({chart:n,options:e}))},beforeUpdate(n,t,e){n.tooltip&&n.tooltip.initialize(e)},reset(n,t,e){n.tooltip&&n.tooltip.initialize(e)},afterDraw(n){const t=n.tooltip;if(t&&t._willRender()){const e={tooltip:t};if(n.notifyPlugins("beforeTooltipDraw",{...e,cancelable:!0})===!1)return;t.draw(n.ctx),n.notifyPlugins("afterTooltipDraw",e)}},afterEvent(n,t){if(n.tooltip){const e=t.replay;n.tooltip.handleEvent(t.event,e,t.inChartArea)&&(t.changed=!0)}},defaults:{enabled:!0,external:null,position:"average",backgroundColor:"rgba(0,0,0,0.8)",titleColor:"#fff",titleFont:{weight:"bold"},titleSpacing:2,titleMarginBottom:6,titleAlign:"left",bodyColor:"#fff",bodySpacing:2,bodyFont:{},bodyAlign:"left",footerColor:"#fff",footerSpacing:2,footerMarginTop:6,footerFont:{weight:"bold"},footerAlign:"left",padding:6,caretPadding:2,caretSize:5,cornerRadius:6,boxHeight:(n,t)=>t.bodyFont.size,boxWidth:(n,t)=>t.bodyFont.size,multiKeyBackground:"#fff",displayColors:!0,boxPadding:0,borderColor:"rgba(0,0,0,0)",borderWidth:0,animation:{duration:400,easing:"easeOutQuart"},animations:{numbers:{type:"number",properties:["x","y","width","height","caretX","caretY"]},opacity:{easing:"linear",duration:200}},callbacks:Yr},defaultRoutes:{bodyFont:"font",footerFont:"font",titleFont:"font"},descriptors:{_scriptable:n=>n!=="filter"&&n!=="itemSort"&&n!=="external",_indexable:!1,callbacks:{_scriptable:!1,_indexable:!1},animation:{_fallback:!1},animations:{_fallback:"animation"}},additionalOptionScopes:["interaction"]},Yp=Object.freeze({__proto__:null,Colors:ip,Decimation:rp,Filler:Ip,Legend:Bp,SubTitle:Np,Title:Op,Tooltip:Wp});const $p=(n,t,e,i)=>(typeof t=="string"?(e=n.push(t)-1,i.unshift({index:e,label:t})):isNaN(t)&&(e=null),e);function qp(n,t,e,i){const o=n.indexOf(t);if(o===-1)return $p(n,t,e,i);const a=n.lastIndexOf(t);return o!==a?e:o}const Gp=(n,t)=>n===null?null:Ae(Math.round(n),0,t);function Fs(n){const t=this.getLabels();return n>=0&&n<t.length?t[n]:n}class ea extends Wn{constructor(t){super(t),this._startValue=void 0,this._valueRange=0,this._addedLabels=[]}init(t){const e=this._addedLabels;if(e.length){const i=this.getLabels();for(const{index:o,label:a}of e)i[o]===a&&i.splice(o,1);this._addedLabels=[]}super.init(t)}parse(t,e){if(ne(t))return null;const i=this.getLabels();return e=isFinite(e)&&i[e]===t?e:qp(i,t,Xt(e,t),this._addedLabels),Gp(e,i.length-1)}determineDataLimits(){const{minDefined:t,maxDefined:e}=this.getUserBounds();let{min:i,max:o}=this.getMinMax(!0);this.options.bounds==="ticks"&&(t||(i=0),e||(o=this.getLabels().length-1)),this.min=i,this.max=o}buildTicks(){const t=this.min,e=this.max,i=this.options.offset,o=[];let a=this.getLabels();a=t===0&&e===a.length-1?a:a.slice(t,e+1),this._valueRange=Math.max(a.length-(i?0:1),1),this._startValue=this.min-(i?.5:0);for(let s=t;s<=e;s++)o.push({value:s});return o}getLabelForValue(t){return Fs.call(this,t)}configure(){super.configure(),this.isHorizontal()||(this._reversePixels=!this._reversePixels)}getPixelForValue(t){return typeof t!="number"&&(t=this.parse(t)),t===null?NaN:this.getPixelForDecimal((t-this._startValue)/this._valueRange)}getPixelForTick(t){const e=this.ticks;return t<0||t>e.length-1?null:this.getPixelForValue(e[t].value)}getValueForPixel(t){return Math.round(this._startValue+this.getDecimalForPixel(t)*this._valueRange)}getBasePixel(){return this.bottom}}St(ea,"id","category"),St(ea,"defaults",{ticks:{callback:Fs}});function Xp(n,t){const e=[],{bounds:o,step:a,min:s,max:r,precision:l,count:c,maxTicks:d,maxDigits:u,includeBounds:p}=n,f=a||1,b=d-1,{min:v,max:y}=t,E=!ne(s),M=!ne(r),X=!ne(c),it=(y-v)/(u+1);let Q=Aa((y-v)/b/f)*f,ft,ut,ct,It;if(Q<1e-14&&!E&&!M)return[{value:v},{value:y}];It=Math.ceil(y/Q)-Math.floor(v/Q),It>b&&(Q=Aa(It*Q/b/f)*f),ne(l)||(ft=Math.pow(10,l),Q=Math.ceil(Q*ft)/ft),o==="ticks"?(ut=Math.floor(v/Q)*Q,ct=Math.ceil(y/Q)*Q):(ut=v,ct=y),E&&M&&a&&Ul((r-s)/a,Q/1e3)?(It=Math.round(Math.min((r-s)/Q,d)),Q=(r-s)/It,ut=s,ct=r):X?(ut=E?s:ut,ct=M?r:ct,It=c-1,Q=(ct-ut)/It):(It=(ct-ut)/Q,xi(It,Math.round(It),Q/1e3)?It=Math.round(It):It=Math.ceil(It));const Ot=Math.max(Ba(Q),Ba(ut));ft=Math.pow(10,ne(l)?Ot:l),ut=Math.round(ut*ft)/ft,ct=Math.round(ct*ft)/ft;let Ut=0;for(E&&(p&&ut!==s?(e.push({value:s}),ut<s&&Ut++,xi(Math.round((ut+Ut*Q)*ft)/ft,s,Rs(s,it,n))&&Ut++):ut<s&&Ut++);Ut<It;++Ut){const Vt=Math.round((ut+Ut*Q)*ft)/ft;if(M&&Vt>r)break;e.push({value:Vt})}return M&&p&&ct!==r?e.length&&xi(e[e.length-1].value,r,Rs(r,it,n))?e[e.length-1].value=r:e.push({value:r}):(!M||ct===r)&&e.push({value:ct}),e}function Rs(n,t,{horizontal:e,minRotation:i}){const o=Qe(i),a=(e?Math.sin(o):Math.cos(o))||.001,s=.75*t*(""+n).length;return Math.min(t/a,s)}class mo extends Wn{constructor(t){super(t),this.start=void 0,this.end=void 0,this._startValue=void 0,this._endValue=void 0,this._valueRange=0}parse(t,e){return ne(t)||(typeof t=="number"||t instanceof Number)&&!isFinite(+t)?null:+t}handleTickRangeOptions(){const{beginAtZero:t}=this.options,{minDefined:e,maxDefined:i}=this.getUserBounds();let{min:o,max:a}=this;const s=l=>o=e?o:l,r=l=>a=i?a:l;if(t){const l=ln(o),c=ln(a);l<0&&c<0?r(0):l>0&&c>0&&s(0)}if(o===a){let l=a===0?1:Math.abs(a*.05);r(a+l),t||s(o-l)}this.min=o,this.max=a}getTickLimit(){const t=this.options.ticks;let{maxTicksLimit:e,stepSize:i}=t,o;return i?(o=Math.ceil(this.max/i)-Math.floor(this.min/i)+1,o>1e3&&(console.warn("scales.".concat(this.id,".ticks.stepSize: ").concat(i," would result generating up to ").concat(o," ticks. Limiting to 1000.")),o=1e3)):(o=this.computeTickLimit(),e=e||11),e&&(o=Math.min(e,o)),o}computeTickLimit(){return Number.POSITIVE_INFINITY}buildTicks(){const t=this.options,e=t.ticks;let i=this.getTickLimit();i=Math.max(2,i);const o={maxTicks:i,bounds:t.bounds,min:t.min,max:t.max,precision:e.precision,step:e.stepSize,count:e.count,maxDigits:this._maxDigits(),horizontal:this.isHorizontal(),minRotation:e.minRotation||0,includeBounds:e.includeBounds!==!1},a=this._range||this,s=Xp(o,a);return t.bounds==="ticks"&&er(s,this,"value"),t.reverse?(s.reverse(),this.start=this.max,this.end=this.min):(this.start=this.min,this.end=this.max),s}configure(){const t=this.ticks;let e=this.min,i=this.max;if(super.configure(),this.options.offset&&t.length){const o=(i-e)/Math.max(t.length-1,1)/2;e-=o,i+=o}this._startValue=e,this._endValue=i,this._valueRange=i-e}getLabelForValue(t){return Bi(t,this.chart.options.locale,this.options.ticks.format)}}class na extends mo{determineDataLimits(){const{min:t,max:e}=this.getMinMax(!0);this.min=_e(t)?t:0,this.max=_e(e)?e:1,this.handleTickRangeOptions()}computeTickLimit(){const t=this.isHorizontal(),e=t?this.width:this.height,i=Qe(this.options.ticks.minRotation),o=(t?Math.sin(i):Math.cos(i))||.001,a=this._resolveTickFontOptions(0);return Math.ceil(e/Math.min(40,a.lineHeight/o))}getPixelForValue(t){return t===null?NaN:this.getPixelForDecimal((t-this._startValue)/this._valueRange)}getValueForPixel(t){return this._startValue+this.getDecimalForPixel(t)*this._valueRange}}St(na,"id","linear"),St(na,"defaults",{ticks:{callback:yo.formatters.numeric}});const Mi=n=>Math.floor(kn(n)),On=(n,t)=>Math.pow(10,Mi(n)+t);function zs(n){return n/Math.pow(10,Mi(n))===1}function Vs(n,t,e){const i=Math.pow(10,e),o=Math.floor(n/i);return Math.ceil(t/i)-o}function Kp(n,t){const e=t-n;let i=Mi(e);for(;Vs(n,t,i)>10;)i++;for(;Vs(n,t,i)<10;)i--;return Math.min(i,Mi(n))}function Jp(n,{min:t,max:e}){t=Xe(n.min,t);const i=[],o=Mi(t);let a=Kp(t,e),s=a<0?Math.pow(10,Math.abs(a)):1;const r=Math.pow(10,a),l=o>a?Math.pow(10,o):0,c=Math.round((t-l)*s)/s,d=Math.floor((t-l)/r/10)*r*10;let u=Math.floor((c-d)/Math.pow(10,a)),p=Xe(n.min,Math.round((l+d+u*Math.pow(10,a))*s)/s);for(;p<e;)i.push({value:p,major:zs(p),significand:u}),u>=10?u=u<15?15:20:u++,u>=20&&(a++,u=2,s=a>=0?1:s),p=Math.round((l+d+u*Math.pow(10,a))*s)/s;const f=Xe(n.max,p);return i.push({value:f,major:zs(f),significand:u}),i}class ia extends Wn{constructor(t){super(t),this.start=void 0,this.end=void 0,this._startValue=void 0,this._valueRange=0}parse(t,e){const i=mo.prototype.parse.apply(this,[t,e]);if(i===0){this._zero=!0;return}return _e(i)&&i>0?i:null}determineDataLimits(){const{min:t,max:e}=this.getMinMax(!0);this.min=_e(t)?Math.max(0,t):null,this.max=_e(e)?Math.max(0,e):null,this.options.beginAtZero&&(this._zero=!0),this._zero&&this.min!==this._suggestedMin&&!_e(this._userMin)&&(this.min=t===On(this.min,0)?On(this.min,-1):On(this.min,0)),this.handleTickRangeOptions()}handleTickRangeOptions(){const{minDefined:t,maxDefined:e}=this.getUserBounds();let i=this.min,o=this.max;const a=r=>i=t?i:r,s=r=>o=e?o:r;i===o&&(i<=0?(a(1),s(10)):(a(On(i,-1)),s(On(o,1)))),i<=0&&a(On(o,-1)),o<=0&&s(On(i,1)),this.min=i,this.max=o}buildTicks(){const t=this.options,e={min:this._userMin,max:this._userMax},i=Jp(e,this);return t.bounds==="ticks"&&er(i,this,"value"),t.reverse?(i.reverse(),this.start=this.max,this.end=this.min):(this.start=this.min,this.end=this.max),i}getLabelForValue(t){return t===void 0?"0":Bi(t,this.chart.options.locale,this.options.ticks.format)}configure(){const t=this.min;super.configure(),this._startValue=kn(t),this._valueRange=kn(this.max)-kn(t)}getPixelForValue(t){return(t===void 0||t===0)&&(t=this.min),t===null||isNaN(t)?NaN:this.getPixelForDecimal(t===this.min?0:(kn(t)-this._startValue)/this._valueRange)}getValueForPixel(t){const e=this.getDecimalForPixel(t);return Math.pow(10,this._startValue+e*this._valueRange)}}St(ia,"id","logarithmic"),St(ia,"defaults",{ticks:{callback:yo.formatters.logarithmic,major:{enabled:!0}}});function oa(n){const t=n.ticks;if(t.display&&n.display){const e=ze(t.backdropPadding);return Xt(t.font&&t.font.size,be.font.size)+e.height}return 0}function Zp(n,t,e){return e=ve(e)?e:[e],{w:oc(n,t.string,e),h:e.length*t.lineHeight}}function Us(n,t,e,i,o){return n===i||n===o?{start:t-e/2,end:t+e/2}:n<i||n>o?{start:t-e,end:t}:{start:t,end:t+e}}function Qp(n){const t={l:n.left+n._padding.left,r:n.right-n._padding.right,t:n.top+n._padding.top,b:n.bottom-n._padding.bottom},e=Object.assign({},t),i=[],o=[],a=n._pointLabels.length,s=n.options.pointLabels,r=s.centerPointLabels?de/a:0;for(let l=0;l<a;l++){const c=s.setContext(n.getPointLabelContext(l));o[l]=c.padding;const d=n.getPointPosition(l,n.drawingArea+o[l],r),u=Me(c.font),p=Zp(n.ctx,u,n._pointLabels[l]);i[l]=p;const f=Fe(n.getIndexAngle(l)+r),b=Math.round(ua(f)),v=Us(b,d.x,p.w,0,180),y=Us(b,d.y,p.h,90,270);tf(e,t,f,v,y)}n.setCenterPoint(t.l-e.l,e.r-t.r,t.t-e.t,e.b-t.b),n._pointLabelItems=of(n,i,o)}function tf(n,t,e,i,o){const a=Math.abs(Math.sin(e)),s=Math.abs(Math.cos(e));let r=0,l=0;i.start<t.l?(r=(t.l-i.start)/a,n.l=Math.min(n.l,t.l-r)):i.end>t.r&&(r=(i.end-t.r)/a,n.r=Math.max(n.r,t.r+r)),o.start<t.t?(l=(t.t-o.start)/s,n.t=Math.min(n.t,t.t-l)):o.end>t.b&&(l=(o.end-t.b)/s,n.b=Math.max(n.b,t.b+l))}function ef(n,t,e){const i=n.drawingArea,{extra:o,additionalAngle:a,padding:s,size:r}=e,l=n.getPointPosition(t,i+o+s,a),c=Math.round(ua(Fe(l.angle+ke))),d=rf(l.y,r.h,c),u=af(c),p=sf(l.x,r.w,u);return{visible:!0,x:l.x,y:d,textAlign:u,left:p,top:d,right:p+r.w,bottom:d+r.h}}function nf(n,t){if(!t)return!0;const{left:e,top:i,right:o,bottom:a}=n;return!(yn({x:e,y:i},t)||yn({x:e,y:a},t)||yn({x:o,y:i},t)||yn({x:o,y:a},t))}function of(n,t,e){const i=[],o=n._pointLabels.length,a=n.options,{centerPointLabels:s,display:r}=a.pointLabels,l={extra:oa(a)/2,additionalAngle:s?de/o:0};let c;for(let d=0;d<o;d++){l.padding=e[d],l.size=t[d];const u=ef(n,d,l);i.push(u),r==="auto"&&(u.visible=nf(u,c),u.visible&&(c=u))}return i}function af(n){return n===0||n===180?"center":n<180?"left":"right"}function sf(n,t,e){return e==="right"?n-=t:e==="center"&&(n-=t/2),n}function rf(n,t,e){return e===90||e===270?n-=t/2:(e>270||e<90)&&(n-=t),n}function lf(n,t,e){const{left:i,top:o,right:a,bottom:s}=e,{backdropColor:r}=t;if(!ne(r)){const l=Vn(t.borderRadius),c=ze(t.backdropPadding);n.fillStyle=r;const d=i-c.left,u=o-c.top,p=a-i+c.width,f=s-o+c.height;Object.values(l).some(b=>b!==0)?(n.beginPath(),Di(n,{x:d,y:u,w:p,h:f,radius:l}),n.fill()):n.fillRect(d,u,p,f)}}function cf(n,t){const{ctx:e,options:{pointLabels:i}}=n;for(let o=t-1;o>=0;o--){const a=n._pointLabelItems[o];if(!a.visible)continue;const s=i.setContext(n.getPointLabelContext(o));lf(e,s,a);const r=Me(s.font),{x:l,y:c,textAlign:d}=a;jn(e,n._pointLabels[o],l,c+r.lineHeight/2,r,{color:s.color,textAlign:d,textBaseline:"middle"})}}function $r(n,t,e,i){const{ctx:o}=n;if(e)o.arc(n.xCenter,n.yCenter,t,0,me);else{let a=n.getPointPosition(0,t);o.moveTo(a.x,a.y);for(let s=1;s<i;s++)a=n.getPointPosition(s,t),o.lineTo(a.x,a.y)}}function df(n,t,e,i,o){const a=n.ctx,s=t.circular,{color:r,lineWidth:l}=t;!s&&!i||!r||!l||e<0||(a.save(),a.strokeStyle=r,a.lineWidth=l,a.setLineDash(o.dash||[]),a.lineDashOffset=o.dashOffset,a.beginPath(),$r(n,e,s,i),a.closePath(),a.stroke(),a.restore())}function uf(n,t,e){return Mn(n,{label:e,index:t,type:"pointLabel"})}class mi extends mo{constructor(t){super(t),this.xCenter=void 0,this.yCenter=void 0,this.drawingArea=void 0,this._pointLabels=[],this._pointLabelItems=[]}setDimensions(){const t=this._padding=ze(oa(this.options)/2),e=this.width=this.maxWidth-t.width,i=this.height=this.maxHeight-t.height;this.xCenter=Math.floor(this.left+e/2+t.left),this.yCenter=Math.floor(this.top+i/2+t.top),this.drawingArea=Math.floor(Math.min(e,i)/2)}determineDataLimits(){const{min:t,max:e}=this.getMinMax(!1);this.min=_e(t)&&!isNaN(t)?t:0,this.max=_e(e)&&!isNaN(e)?e:0,this.handleTickRangeOptions()}computeTickLimit(){return Math.ceil(this.drawingArea/oa(this.options))}generateTickLabels(t){mo.prototype.generateTickLabels.call(this,t),this._pointLabels=this.getLabels().map((e,i)=>{const o=ge(this.options.pointLabels.callback,[e,i],this);return o||o===0?o:""}).filter((e,i)=>this.chart.getDataVisibility(i))}fit(){const t=this.options;t.display&&t.pointLabels.display?Qp(this):this.setCenterPoint(0,0,0,0)}setCenterPoint(t,e,i,o){this.xCenter+=Math.floor((t-e)/2),this.yCenter+=Math.floor((i-o)/2),this.drawingArea-=Math.min(this.drawingArea/2,Math.max(t,e,i,o))}getIndexAngle(t){const e=me/(this._pointLabels.length||1),i=this.options.startAngle||0;return Fe(t*e+Qe(i))}getDistanceFromCenterForValue(t){if(ne(t))return NaN;const e=this.drawingArea/(this.max-this.min);return this.options.reverse?(this.max-t)*e:(t-this.min)*e}getValueForDistanceFromCenter(t){if(ne(t))return NaN;const e=t/(this.drawingArea/(this.max-this.min));return this.options.reverse?this.max-e:this.min+e}getPointLabelContext(t){const e=this._pointLabels||[];if(t>=0&&t<e.length){const i=e[t];return uf(this.getContext(),t,i)}}getPointPosition(t,e,i=0){const o=this.getIndexAngle(t)-ke+i;return{x:Math.cos(o)*e+this.xCenter,y:Math.sin(o)*e+this.yCenter,angle:o}}getPointPositionForValue(t,e){return this.getPointPosition(t,this.getDistanceFromCenterForValue(e))}getBasePosition(t){return this.getPointPositionForValue(t||0,this.getBaseValue())}getPointLabelPosition(t){const{left:e,top:i,right:o,bottom:a}=this._pointLabelItems[t];return{left:e,top:i,right:o,bottom:a}}drawBackground(){const{backgroundColor:t,grid:{circular:e}}=this.options;if(t){const i=this.ctx;i.save(),i.beginPath(),$r(this,this.getDistanceFromCenterForValue(this._endValue),e,this._pointLabels.length),i.closePath(),i.fillStyle=t,i.fill(),i.restore()}}drawGrid(){const t=this.ctx,e=this.options,{angleLines:i,grid:o,border:a}=e,s=this._pointLabels.length;let r,l,c;if(e.pointLabels.display&&cf(this,s),o.display&&this.ticks.forEach((d,u)=>{if(u!==0||u===0&&this.min<0){l=this.getDistanceFromCenterForValue(d.value);const p=this.getContext(u),f=o.setContext(p),b=a.setContext(p);df(this,f,l,s,b)}}),i.display){for(t.save(),r=s-1;r>=0;r--){const d=i.setContext(this.getPointLabelContext(r)),{color:u,lineWidth:p}=d;!p||!u||(t.lineWidth=p,t.strokeStyle=u,t.setLineDash(d.borderDash),t.lineDashOffset=d.borderDashOffset,l=this.getDistanceFromCenterForValue(e.reverse?this.min:this.max),c=this.getPointPosition(r,l),t.beginPath(),t.moveTo(this.xCenter,this.yCenter),t.lineTo(c.x,c.y),t.stroke())}t.restore()}}drawBorder(){}drawLabels(){const t=this.ctx,e=this.options,i=e.ticks;if(!i.display)return;const o=this.getIndexAngle(0);let a,s;t.save(),t.translate(this.xCenter,this.yCenter),t.rotate(o),t.textAlign="center",t.textBaseline="middle",this.ticks.forEach((r,l)=>{if(l===0&&this.min>=0&&!e.reverse)return;const c=i.setContext(this.getContext(l)),d=Me(c.font);if(a=this.getDistanceFromCenterForValue(this.ticks[l].value),c.showLabelBackdrop){t.font=d.string,s=t.measureText(r.label).width,t.fillStyle=c.backdropColor;const u=ze(c.backdropPadding);t.fillRect(-s/2-u.left,-a-d.size/2-u.top,s+u.width,d.size+u.height)}jn(t,r.label,0,-a,d,{color:c.color,strokeColor:c.textStrokeColor,strokeWidth:c.textStrokeWidth})}),t.restore()}drawTitle(){}}St(mi,"id","radialLinear"),St(mi,"defaults",{display:!0,animate:!0,position:"chartArea",angleLines:{display:!0,lineWidth:1,borderDash:[],borderDashOffset:0},grid:{circular:!1},startAngle:0,ticks:{showLabelBackdrop:!0,callback:yo.formatters.numeric},pointLabels:{backdropColor:void 0,backdropPadding:2,display:!0,font:{size:10},callback(t){return t},padding:5,centerPointLabels:!1}}),St(mi,"defaultRoutes",{"angleLines.color":"borderColor","pointLabels.color":"color","ticks.color":"color"}),St(mi,"descriptors",{angleLines:{_fallback:"grid"}});const Co={millisecond:{common:!0,size:1,steps:1e3},second:{common:!0,size:1e3,steps:60},minute:{common:!0,size:6e4,steps:60},hour:{common:!0,size:36e5,steps:24},day:{common:!0,size:864e5,steps:30},week:{common:!1,size:6048e5,steps:4},month:{common:!0,size:2628e6,steps:12},quarter:{common:!1,size:7884e6,steps:4},year:{common:!0,size:3154e7}},qe=Object.keys(Co);function Hs(n,t){return n-t}function js(n,t){if(ne(t))return null;const e=n._adapter,{parser:i,round:o,isoWeekday:a}=n._parseOpts;let s=t;return typeof i=="function"&&(s=i(s)),_e(s)||(s=typeof i=="string"?e.parse(s,i):e.parse(s)),s===null?null:(o&&(s=o==="week"&&(Qn(a)||a===!0)?e.startOf(s,"isoWeek",a):e.startOf(s,o)),+s)}function Ws(n,t,e,i){const o=qe.length;for(let a=qe.indexOf(n);a<o-1;++a){const s=Co[qe[a]],r=s.steps?s.steps:Number.MAX_SAFE_INTEGER;if(s.common&&Math.ceil((e-t)/(r*s.size))<=i)return qe[a]}return qe[o-1]}function pf(n,t,e,i,o){for(let a=qe.length-1;a>=qe.indexOf(e);a--){const s=qe[a];if(Co[s].common&&n._adapter.diff(o,i,s)>=t-1)return s}return qe[e?qe.indexOf(e):0]}function ff(n){for(let t=qe.indexOf(n)+1,e=qe.length;t<e;++t)if(Co[qe[t]].common)return qe[t]}function Ys(n,t,e){if(!e)n[t]=!0;else if(e.length){const{lo:i,hi:o}=pa(e,t),a=e[i]>=t?e[i]:e[o];n[a]=!0}}function hf(n,t,e,i){const o=n._adapter,a=+o.startOf(t[0].value,i),s=t[t.length-1].value;let r,l;for(r=a;r<=s;r=+o.add(r,1,i))l=e[r],l>=0&&(t[l].major=!0);return t}function $s(n,t,e){const i=[],o={},a=t.length;let s,r;for(s=0;s<a;++s)r=t[s],o[r]=s,i.push({value:r,major:!1});return a===0||!e?i:hf(n,i,o,e)}class Pi extends Wn{constructor(t){super(t),this._cache={data:[],labels:[],all:[]},this._unit="day",this._majorUnit=void 0,this._offsets={},this._normalized=!1,this._parseOpts=void 0}init(t,e={}){const i=t.time||(t.time={}),o=this._adapter=new wd._date(t.adapters.date);o.init(e),yi(i.displayFormats,o.formats()),this._parseOpts={parser:i.parser,round:i.round,isoWeekday:i.isoWeekday},super.init(t),this._normalized=e.normalized}parse(t,e){return t===void 0?null:js(this,t)}beforeLayout(){super.beforeLayout(),this._cache={data:[],labels:[],all:[]}}determineDataLimits(){const t=this.options,e=this._adapter,i=t.time.unit||"day";let{min:o,max:a,minDefined:s,maxDefined:r}=this.getUserBounds();function l(c){!s&&!isNaN(c.min)&&(o=Math.min(o,c.min)),!r&&!isNaN(c.max)&&(a=Math.max(a,c.max))}(!s||!r)&&(l(this._getLabelBounds()),(t.bounds!=="ticks"||t.ticks.source!=="labels")&&l(this.getMinMax(!1))),o=_e(o)&&!isNaN(o)?o:+e.startOf(Date.now(),i),a=_e(a)&&!isNaN(a)?a:+e.endOf(Date.now(),i)+1,this.min=Math.min(o,a-1),this.max=Math.max(o+1,a)}_getLabelBounds(){const t=this.getLabelTimestamps();let e=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY;return t.length&&(e=t[0],i=t[t.length-1]),{min:e,max:i}}buildTicks(){const t=this.options,e=t.time,i=t.ticks,o=i.source==="labels"?this.getLabelTimestamps():this._generate();t.bounds==="ticks"&&o.length&&(this.min=this._userMin||o[0],this.max=this._userMax||o[o.length-1]);const a=this.min,s=this.max,r=Yl(o,a,s);return this._unit=e.unit||(i.autoSkip?Ws(e.minUnit,this.min,this.max,this._getLabelCapacity(a)):pf(this,r.length,e.minUnit,this.min,this.max)),this._majorUnit=!i.major.enabled||this._unit==="year"?void 0:ff(this._unit),this.initOffsets(o),t.reverse&&r.reverse(),$s(this,r,this._majorUnit)}afterAutoSkip(){this.options.offsetAfterAutoskip&&this.initOffsets(this.ticks.map(t=>+t.value))}initOffsets(t=[]){let e=0,i=0,o,a;this.options.offset&&t.length&&(o=this.getDecimalForValue(t[0]),t.length===1?e=1-o:e=(this.getDecimalForValue(t[1])-o)/2,a=this.getDecimalForValue(t[t.length-1]),t.length===1?i=a:i=(a-this.getDecimalForValue(t[t.length-2]))/2);const s=t.length<3?.5:.25;e=Ae(e,0,s),i=Ae(i,0,s),this._offsets={start:e,end:i,factor:1/(e+1+i)}}_generate(){const t=this._adapter,e=this.min,i=this.max,o=this.options,a=o.time,s=a.unit||Ws(a.minUnit,e,i,this._getLabelCapacity(e)),r=Xt(o.ticks.stepSize,1),l=s==="week"?a.isoWeekday:!1,c=Qn(l)||l===!0,d={};let u=e,p,f;if(c&&(u=+t.startOf(u,"isoWeek",l)),u=+t.startOf(u,c?"day":s),t.diff(i,e,s)>1e5*r)throw new Error(e+" and "+i+" are too far apart with stepSize of "+r+" "+s);const b=o.ticks.source==="data"&&this.getDataTimestamps();for(p=u,f=0;p<i;p=+t.add(p,r,s),f++)Ys(d,p,b);return(p===i||o.bounds==="ticks"||f===1)&&Ys(d,p,b),Object.keys(d).sort(Hs).map(v=>+v)}getLabelForValue(t){const e=this._adapter,i=this.options.time;return i.tooltipFormat?e.format(t,i.tooltipFormat):e.format(t,i.displayFormats.datetime)}format(t,e){const o=this.options.time.displayFormats,a=this._unit,s=e||o[a];return this._adapter.format(t,s)}_tickFormatFunction(t,e,i,o){const a=this.options,s=a.ticks.callback;if(s)return ge(s,[t,e,i],this);const r=a.time.displayFormats,l=this._unit,c=this._majorUnit,d=l&&r[l],u=c&&r[c],p=i[e],f=c&&u&&p&&p.major;return this._adapter.format(t,o||(f?u:d))}generateTickLabels(t){let e,i,o;for(e=0,i=t.length;e<i;++e)o=t[e],o.label=this._tickFormatFunction(o.value,e,t)}getDecimalForValue(t){return t===null?NaN:(t-this.min)/(this.max-this.min)}getPixelForValue(t){const e=this._offsets,i=this.getDecimalForValue(t);return this.getPixelForDecimal((e.start+i)*e.factor)}getValueForPixel(t){const e=this._offsets,i=this.getDecimalForPixel(t)/e.factor-e.end;return this.min+i*(this.max-this.min)}_getLabelSize(t){const e=this.options.ticks,i=this.ctx.measureText(t).width,o=Qe(this.isHorizontal()?e.maxRotation:e.minRotation),a=Math.cos(o),s=Math.sin(o),r=this._resolveTickFontOptions(0).size;return{w:i*a+r*s,h:i*s+r*a}}_getLabelCapacity(t){const e=this.options.time,i=e.displayFormats,o=i[e.unit]||i.millisecond,a=this._tickFormatFunction(t,0,$s(this,[t],this._majorUnit),o),s=this._getLabelSize(a),r=Math.floor(this.isHorizontal()?this.width/s.w:this.height/s.h)-1;return r>0?r:1}getDataTimestamps(){let t=this._cache.data||[],e,i;if(t.length)return t;const o=this.getMatchingVisibleMetas();if(this._normalized&&o.length)return this._cache.data=o[0].controller.getAllParsedValues(this);for(e=0,i=o.length;e<i;++e)t=t.concat(o[e].controller.getAllParsedValues(this));return this._cache.data=this.normalize(t)}getLabelTimestamps(){const t=this._cache.labels||[];let e,i;if(t.length)return t;const o=this.getLabels();for(e=0,i=o.length;e<i;++e)t.push(js(this,o[e]));return this._cache.labels=this._normalized?t:this.normalize(t)}normalize(t){return or(t.sort(Hs))}}St(Pi,"id","time"),St(Pi,"defaults",{bounds:"data",adapters:{},time:{parser:!1,unit:!1,round:!1,isoWeekday:!1,minUnit:"millisecond",displayFormats:{}},ticks:{source:"auto",callback:!1,major:{enabled:!1}}});function qi(n,t,e){let i=0,o=n.length-1,a,s,r,l;e?(t>=n[i].pos&&t<=n[o].pos&&({lo:i,hi:o}=bn(n,"pos",t)),{pos:a,time:r}=n[i],{pos:s,time:l}=n[o]):(t>=n[i].time&&t<=n[o].time&&({lo:i,hi:o}=bn(n,"time",t)),{time:a,pos:r}=n[i],{time:s,pos:l}=n[o]);const c=s-a;return c?r+(l-r)*(t-a)/c:r}class aa extends Pi{constructor(t){super(t),this._table=[],this._minPos=void 0,this._tableRange=void 0}initOffsets(){const t=this._getTimestampsForTable(),e=this._table=this.buildLookupTable(t);this._minPos=qi(e,this.min),this._tableRange=qi(e,this.max)-this._minPos,super.initOffsets(t)}buildLookupTable(t){const{min:e,max:i}=this,o=[],a=[];let s,r,l,c,d;for(s=0,r=t.length;s<r;++s)c=t[s],c>=e&&c<=i&&o.push(c);if(o.length<2)return[{time:e,pos:0},{time:i,pos:1}];for(s=0,r=o.length;s<r;++s)d=o[s+1],l=o[s-1],c=o[s],Math.round((d+l)/2)!==c&&a.push({time:c,pos:s/(r-1)});return a}_generate(){const t=this.min,e=this.max;let i=super.getDataTimestamps();return(!i.includes(t)||!i.length)&&i.splice(0,0,t),(!i.includes(e)||i.length===1)&&i.push(e),i.sort((o,a)=>o-a)}_getTimestampsForTable(){let t=this._cache.all||[];if(t.length)return t;const e=this.getDataTimestamps(),i=this.getLabelTimestamps();return e.length&&i.length?t=this.normalize(e.concat(i)):t=e.length?e:i,t=this._cache.all=t,t}getDecimalForValue(t){return(qi(this._table,t)-this._minPos)/this._tableRange}getValueForPixel(t){const e=this._offsets,i=this.getDecimalForPixel(t)/e.factor-e.end;return qi(this._table,i*this._tableRange+this._minPos,!0)}}St(aa,"id","timeseries"),St(aa,"defaults",Pi.defaults);var gf=Object.freeze({__proto__:null,CategoryScale:ea,LinearScale:na,LogarithmicScale:ia,RadialLinearScale:mi,TimeScale:Pi,TimeSeriesScale:aa});const mf=[xd,Ku,Yp,gf];mn.register(...mf);(function(){const n=window.fetch.bind(window);function t(){try{const i=JSON.parse(localStorage.getItem("user")||"{}");if(i&&(i.token||i.jwt||i.accessToken))return i.token||i.jwt||i.accessToken}catch(i){}const e=["token","authToken","jwt","bp_token","accessToken","id_token"];for(const i of e){let o=localStorage.getItem(i)||sessionStorage.getItem(i);if(o){try{const a=JSON.parse(o);if(a&&(a.token||a.jwt||a.accessToken))return a.token||a.jwt||a.accessToken}catch(a){}if(o=String(o).replace(/^"+|"+$/g,""),/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+$/.test(o))return o}}return null}window.fetch=function(e,i){const o=typeof e=="string"?e:e&&e.url||"";if(!(typeof o=="string"&&(o.startsWith("/api/")||o.startsWith(location.origin+"/api/"))))return n(e,i);const s=t(),r=Object.assign({},i);return r.headers=new Headers(r&&r.headers||{}),s&&!r.headers.has("Authorization")&&r.headers.set("Authorization","Bearer "+s),n(e,r)}})();(function(){function n(){const o=r=>String(r).replace(/^"+|"+$/g,""),a=r=>/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+$/.test(r||""),s=["token","authToken","jwt","bp_token","accessToken","id_token"];for(const r of s){let l=localStorage.getItem(r)||sessionStorage.getItem(r);if(l){try{const c=JSON.parse(l);if(c&&(c.token||c.jwt||c.accessToken))return c.token||c.jwt||c.accessToken}catch(c){}if(l=o(l),a(l))return l}}try{const r=JSON.parse(localStorage.getItem("user")||"{}");if(r&&(r.token||r.jwt||r.accessToken))return r.token||r.jwt||r.accessToken}catch(r){}return null}typeof window.users>"u"&&(window.users=[]),(async function o(){try{if(window.GET){const r=await window.GET("/api/usernames");r&&Array.isArray(r.users)&&(window.users=r.users);return}const a=n(),s=await fetch("/api/usernames",{headers:{Accept:"application/json",...a?{Authorization:"Bearer "+a}:{}}});if(s.status===401){setTimeout(o,800);return}if(s.ok){const r=await s.json();r&&Array.isArray(r.users)&&(window.users=r.users)}}catch(a){setTimeout(o,1200)}})();function t(o,a,s){return new Date(Date.UTC(o,a,s))}function e(o){return new Date(o.getTime()+24*3600*1e3-1)}function i(o,a){return new Date(Date.UTC(o,a+1,0))}typeof window.buildBuckets!="function"&&(window.buildBuckets=function(o,a){var s=String(o||"mensile").toLowerCase(),r=effectivePeriodType(s),l=a?new Date(a):new Date,c=l.getUTCFullYear(),d=[];function u(We,Te){d.push({s:We.getTime(),e:Te.getTime()})}if(s==="ytd"){for(var p=0;p<=l.getUTCMonth();p++){var f=t(l.getUTCFullYear(),p,1),b=e(i(f.getUTCFullYear(),f.getUTCMonth()));u(f,b)}return d}if(s==="ltm"){for(var v=t(l.getUTCFullYear(),l.getUTCMonth(),1),y=11;y>=0;y--){var p=t(v.getUTCFullYear(),v.getUTCMonth()-y,1);u(p,e(i(p.getUTCFullYear(),p.getUTCMonth())))}return d}if(r==="settimanale"){var E=new Date(Date.UTC(l.getUTCFullYear(),l.getUTCMonth(),l.getUTCDate())),M=(E.getUTCDay()+6)%7;E.setUTCDate(E.getUTCDate()-M);for(var X=52;X>=0;X--){var it=new Date(E);it.setUTCDate(E.getUTCDate()-X*7);var Q=new Date(it);Q.setUTCDate(it.getUTCDate()+6),Q.setUTCHours(23,59,59,999),u(it,Q)}return d}if(r==="mensile"){for(var v=new Date(Date.UTC(l.getUTCFullYear(),l.getUTCMonth(),1)),y=23;y>=0;y--){var p=new Date(Date.UTC(v.getUTCFullYear(),v.getUTCMonth()-y,1));u(p,e(i(p.getUTCFullYear(),p.getUTCMonth())))}return d}if(r==="trimestrale"){for(var ft=Math.floor(l.getUTCMonth()/3),ut=11;ut>=0;ut--){var ct=ft-ut,It=c+Math.floor(ct/4),Ot=(ct%4+4)%4,it=t(It,Ot*3,1),Q=e(new Date(Date.UTC(It,Ot*3+3,0)));u(it,Q)}return d}if(r==="semestrale"){for(var Ut=l.getUTCMonth()<6?0:1,Vt=5;Vt>=0;Vt--){var Mt=Ut-Vt,$t=c+Math.floor(Mt/2),Kt=(Mt%2+2)%2,Zt=Kt===0?0:6,ae=t($t,Zt,1),Ce=e(new Date(Date.UTC($t,Zt+6,0)));u(ae,Ce)}return d}for(var re=2;re>=0;re--){var Se=c-re;u(t(Se,0,1),e(new Date(Date.UTC(Se,12,0))))}return d}),typeof window.labelsForBuckets!="function"&&(window.labelsForBuckets=function(o,a){var s=effectivePeriodType(o||"mensile");return(a||[]).map(function(r){var l=new Date(r.s);return s==="settimanale"?"W"+isoWeekNum(l)+" "+l.getUTCFullYear():s==="mensile"?String(l.getUTCMonth()+1).padStart(2,"0")+"/"+l.getUTCFullYear():s==="trimestrale"?"Q"+(Math.floor(l.getUTCMonth()/3)+1)+" "+l.getUTCFullYear():s==="semestrale"?(l.getUTCMonth()<6?"S1 ":"S2 ")+l.getUTCFullYear():String(l.getUTCFullYear())})}),typeof window.sumIndicator!="function"&&(window.sumIndicator=function(o,a,s){var c,d;var r=String(a).toLowerCase()==="previsionale"?o.indicatorsPrev||{}:o.indicatorsCons||{};if(s==="VSDTotale")return Number(r.VSDPersonale||0)+Number(r.VSDIndiretto||0);var l=Number((d=(c=r[s])!=null?c:r[s.toUpperCase()])!=null?d:0);return Number.isFinite(l)?l:0}),(function(){try{let s=function(r,l){try{if(this&&typeof this.getLabelForValue=="function")return String(this.getLabelForValue(r))}catch(p){}try{var c=typeof r=="number"?r:l,d=this&&this.chart&&this.chart.data&&this.chart.data.labels||[],u=Array.isArray(d)?d[c]:void 0;return String(u!=null?u:r)}catch(p){return String(r)}};if(typeof window.Chart>"u")return;try{Chart.defaults=Chart.defaults||{},Chart.defaults.scales=Chart.defaults.scales||{},Chart.defaults.scales.category=Chart.defaults.scales.category||{},Chart.defaults.scales.category.ticks=Object.assign({},Chart.defaults.scales.category.ticks||{},{callback:s})}catch(r){}var a={id:"bpAutoTicks",beforeUpdate:function(r){try{let f=function(b,v){try{var y=Array.isArray(b)?b.length:0;if(!y)return{autoSkip:!0,maxRotation:0,minRotation:0,callback:s};for(var E=0,M=0;M<b.length;M++){var X=""+(b[M]==null?"":b[M]);X.length>E&&(E=X.length)}var it=Math.max(28,Math.min(90,Math.round(E*7))),Q=y*it;return Q>(v||320)*1.2?{autoSkip:!0,maxRotation:45,minRotation:45,callback:s}:{autoSkip:!0,maxRotation:0,minRotation:0,callback:s}}catch(ft){return{autoSkip:!0,maxRotation:0,minRotation:0,callback:s}}};if(!r||(r.config&&r.config.type)!=="line")return;var l=r.config&&r.config.data&&r.config.data.labels||[],c=r.canvas&&(r.canvas.clientWidth||r.canvas.width)||320,d=typeof window.computeTickOptions=="function"?window.computeTickOptions:f,u=d(l,c);r.options=r.options||{},r.options.scales=r.options.scales||{};var p=r.options.scales.x||(r.options.scales.x={display:!0});p.ticks=Object.assign({},p.ticks||{},u)}catch(f){}}};try{Chart.register?Chart.register(a):Chart.plugins&&Chart.plugins.register&&Chart.plugins.register(a)}catch(r){}}catch(s){}})()})();(function(){const n=window.BP=window.BP||{},t=n.ClientStatus=n.ClientStatus||{},e="bp_banner_seen";function i(){try{return JSON.parse(localStorage.getItem(e)||"{}")}catch(f){return{}}}function o(f){try{localStorage.setItem(e,JSON.stringify(f||{}))}catch(b){}}function a(f){return!!i()[f]}function s(f){const b=i();b[f]=!0,o(b)}async function r(f){const b=window.authToken||"",v=await fetch(f,{headers:b?{Authorization:"Bearer "+b}:{}});if(!v.ok)throw new Error("GET "+f+" failed");return v.json()}async function l(f,b){const v=window.authToken||"",y=await fetch(f,{method:"POST",headers:{"Content-Type":"application/json",...v?{Authorization:"Bearer "+v}:{}},body:JSON.stringify(b||{})});if(!y.ok)throw new Error("POST "+f+" failed");return y.json()}async function c({clientId:f,status:b}){if(!f)throw new Error("missing clientId");return l("/api/clients",{id:f,status:String(b||"")})}t.setClientStatusByName=d;async function d({clientName:f,status:b}){const v=String(f||"").trim();if(!v)throw new Error("missing clientName");const E=((await r("/api/clients")).clients||[]).find(it=>String(it.name||"").toLowerCase()===v.toLowerCase());if(E)return c({clientId:E.id,status:b});await l("/api/clients",{name:v});const X=((await r("/api/clients")).clients||[]).find(it=>String(it.name||"").toLowerCase()===v.toLowerCase());if(!X)throw new Error("client creation failed");return c({clientId:X.id,status:b})}function u({appointment:f,clientName:b},v){const y=f||{},E=b||y.client||"Cliente",M=document.createElement("div");return M.className="bp-banner-client",M.innerHTML='\n      <div class="bp-banner-inner">\n        <div class="bp-banner-title"> diventato cliente?</div>\n        <div class="bp-banner-sub">Appuntamento con <b>'.concat(p(E),'</b></div>\n        <div class="bp-banner-actions">\n          <button type="button" data-yes>S</button>\n          <button type="button" class="ghost" data-no>No</button>\n        </div>\n      </div>\n    '),M.querySelector("[data-yes]").addEventListener("click",()=>v&&v(!0,y)),M.querySelector("[data-no]").addEventListener("click",()=>v&&v(!1,y)),M}function p(f){return String(f).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}(function(){if(document.getElementById("bp-clientstatus-css"))return;const b="\n.bp-banner-client{\n  position: fixed; left:50%; transform:translateX(-50%);\n  top: 70px; z-index: 1200;\n  background: rgba(20,24,34,.95);\n  color: #fff;\n  border: 1px solid rgba(255,255,255,.18);\n  box-shadow: 0 10px 24px rgba(0,0,0,.35);\n  border-radius:14px; padding:10px; min-width:280px;\n  animation: bpBannerPop .18s ease-out;\n}\n.bp-banner-inner{ display:flex; flex-direction:column; gap:6px; }\n.bp-banner-title{ font-weight:800; }\n.bp-banner-sub{ font-size:12px; opacity:.92; }\n.bp-banner-actions{ display:flex; gap:8px; margin-top:6px; justify-content:flex-end; }\n@keyframes bpBannerPop{ from{ transform:translate(-50%, -6px); opacity:0 } to{ transform:translate(-50%, 0); opacity:1 } }\n",v=document.createElement("style");v.id="bp-clientstatus-css",v.textContent=b,document.head.appendChild(v)})(),t.hasSeen=a,t.markSeen=s,t.renderBecameClientBanner=u,t.setClientStatus=c,t.setClientStatusByName=d})();(function(){const n=window.BP=window.BP||{},t=n.ClientsHelpers=n.ClientsHelpers||{};function e(s){return String(s||"").trim().toLowerCase()}function i(s){const r={};return(s||[]).forEach(l=>{const c=e(l.client);if(!c)return;const d=l.start||l.end;if(!d)return;const u=r[c];(!u||new Date(d)>new Date(u))&&(r[c]=d)}),r}function o(s,r){const l=i(r);return(s||[]).map(c=>{const d=l[e(c.name)]||null;return{...c,lastAppointment:d}})}function a(s,{status:r,consultantId:l,consultantName:c}){const d=f=>String(f||"").trim().toLowerCase(),u=f=>{const b=d(f).replace(/\s+/g,"_").replace(/-/g,"_");return b==="lead_non_chiuso"||b==="lead_non-chiuso"?"lead_non_chiuso":b};let p=s||[];if(r&&r!=="tutti"&&(p=p.filter(f=>u(f.status)===u(r))),l)p=p.filter(f=>(f.consultantId||"")===String(l));else if(c){const f=d(c);p=p.filter(b=>d(b.consultantName)===f)}return p}t.withLastAppointment=o,t.filter=a})();function vf(n){return n?(n=String(n).toLowerCase(),n==="ytd"||n==="ltm"?"mensile":n):""}function bf(n){var t=new Date(Date.UTC(n.getFullYear(),n.getMonth(),n.getDate())),e=t.getUTCDay()||7;t.setUTCDate(t.getUTCDate()+4-e);var i=new Date(Date.UTC(t.getUTCFullYear(),0,1));return Math.ceil(((t-i)/864e5+1)/7)}typeof window<"u"&&(typeof window.effectivePeriodType!="function"&&(window.effectivePeriodType=vf),typeof window.isoWeekNum!="function"&&(window.isoWeekNum=bf));(function(){const n=window.BP=window.BP||{},t=n.Haptics=n.Haptics||{};function e(){const o=navigator.userAgent||navigator.vendor||"";return/android|iphone|ipad|ipod|mobile/i.test(o)}function i(o){if(e()&&"vibrate"in navigator)try{switch(o){case"light":navigator.vibrate(12);break;case"heavy":navigator.vibrate([10,30,10]);break;default:navigator.vibrate(18);break}}catch(a){}}t.impact=i})();(function(){function n(t){return String(t||"event").normalize("NFKD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9._-]+/g,"_").replace(/^_+|_+$/g,"").slice(0,80)||"event"}if(window.saveICS&&!window.__icsSanitized){const t=window.saveICS;window.saveICS=function(e,i){try{e=n(e)}catch(o){}return t(e,i)},window.__icsSanitized=!0}window.__icsSanitize=n})();(function(){const n=window.BP=window.BP||{},t=n.ICS=n.ICS||{};function e(i){try{logger.warn("[BP ICS bulk disabled] chiamata a:",i)}catch(o){}}t.createCalendarForRange=function(){return e("createCalendarForRange()"),null},t.downloadForRange=function(){return e("downloadForRange()"),!1}})();(function(n){const t=["localhost","127.0.0.1"].includes(n.location.hostname),e=n.pino?n.pino({level:t?"debug":"info"}):console,i={info:(...o)=>e.info?e.info(...o):console.log(...o),error:(...o)=>e.error?e.error(...o):console.error(...o),warn:(...o)=>e.warn?e.warn(...o):console.warn(...o),debug:(...o)=>e.debug?e.debug(...o):console.debug(...o)};n.logger=i})(window);window.BP_PHRASES=(function(){const n=["Ottimo, {name}! ","Ben fatto, {name}! ","Avanti cos, {name}! ","Perfetto, {name}! ","Bel colpo, {name}! ","Ci siamo, {name}! ","Grande {name}! ","Pezzo dopo pezzo, {name}! ","Molto bene, {name}! ","Stai andando bene, {name}! "],t=["Che figata, {name}! ","Ma cosa dico grande grandissimo, {name}! ","Super, {name}! ","Non ti ferma nessuno, {name}!! ","Stai andando alla grande, {name}! ","Gran progressione, {name}! ","Il ritmo  giusto, {name}! ","Questa spinge, {name}! ","Bello tosto, {name}! ","Gran focus, {name}! "],e=["BOOM! {name}, questo  livello PRO! ","Risultato pazzesco, {name}! ","Clamoroso {name}, cos si fa! "," ufficiale: {name} ON FIRE! ","Top di gamma, {name}! ","Mostruoso upgrade, {name}! ","Record personale in vista, {name}! ","Spacchi tutto, {name}! ","Da incorniciare, {name}! ","Questo alza lasticella, {name}! "],i={lite:n,mid:t,mega:e};return i.standard=n,i.rilevante=t,i.grande=e,i.pick=function(o,a){const s=i[o]||n,r=a||JSON.parse(localStorage.getItem("bp_user")||"{}").name||"campione";return(s[Math.floor(Math.random()*s.length)]||"Grande!").replace(/\{name\}/g,r)},i.random=function(o){const a=[n,t,e],s=a[Math.floor(Math.random()*a.length)];return i.pick(s===e?"mega":s===t?"rilevante":"standard",o)},typeof window<"u"&&(window.BP=window.BP||{},window.BP.Phrases=i),i})();(function(){const n=window.BP=window.BP||{},t=n.Targets=n.Targets||{},e=["VSS","VSDPersonale","VSDIndiretto","GI"],i=["NNCF","AppFatti","Telefonate"],o=e.concat(i),a={senior:{VSS:3e4,VSDPersonale:15e3,VSDIndiretto:5e3,GI:15e3,NNCF:1,AppFatti:4,Telefonate:0},junior:{VSS:15e3,VSDPersonale:5e3,VSDIndiretto:5e3,GI:1e4,NNCF:4,AppFatti:30,Telefonate:300}};function s(f,b){const v=Number(f||0),y=Number(b||0);return y?Math.ceil(v/y)*y:Math.ceil(v)}function r(f){switch(String(f||"mensile").toLowerCase()){case"settimanale":return 1/4;case"mensile":return 1;case"trimestrale":return 3;case"semestrale":return 6;case"annuale":return 12;default:return 1}}function l(f){return e.indexOf(f)>=0}function c(f){const b=String(f||"junior").toLowerCase()==="senior"?"senior":"junior";return{...a[b]}}function d(f,b){const v=r(b),y=c(f),E={};for(const M of o){const X=Number(y[M]||0)*v;l(M)?String(b).toLowerCase()==="settimanale"?E[M]=s(X,500):E[M]=s(X,5e3):E[M]=Math.ceil(X)}return E}function u(f,b){const v={};for(const y of o){const E=Number((f||{})[y]||0),M=Number((b||{})[y]||0),X=E-M,it=M>0?Math.round(E/M*100):E>0?100:0;v[y]={value:E,target:M,delta:X,pct:Math.max(0,it)}}return v}function p(f){const b=[];for(const y of o){const E=(f||{})[y];E&&E.target>0&&b.push(Number(E.pct||0))}if(!b.length)return 0;const v=b.reduce((y,E)=>y+E,0)/b.length;return Math.round(v)}t.MONEY_KEYS=e,t.COUNT_KEYS=i,t.ALL_KEYS=o,t.getMonthly=c,t.getForPeriod=d,t.compare=u,t.summarize=p})();(function(){function n(t){try{fetch("/api/client_error",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:location.href,info:{ua:navigator.userAgent},...t})})}catch(e){}}window.addEventListener("error",function(t){try{n({message:t.message,stack:t.error&&t.error.stack||null})}catch(e){}}),window.addEventListener("unhandledrejection",function(t){try{n({message:"unhandledrejection",stack:t.reason&&t.reason.stack||String(t.reason)})}catch(e){}})})();(function(){const n=window.BP=window.BP||{},t=n.Undo=n.Undo||{},e=document.createElement("div");e.className="bp-undo-host",document.body.appendChild(e);const i="\n  .bp-undo-host{\n    position: fixed; left:50%; transform: translateX(-50%);\n    bottom: 20px; z-index: 1201; display:flex; flex-direction:column; gap:8px;\n  }\n  .bp-undo{\n    min-width: 280px; max-width: 540px;\n    background: rgba(15,19,28,.95);\n    border:1px solid rgba(255,255,255,.18);\n    border-radius: 12px; padding: 10px 12px;\n    box-shadow: 0 10px 24px rgba(0,0,0,.35);\n    display:flex; align-items:center; gap:10px;\n    animation: bpUndoPop .16s ease-out;\n  }\n  .bp-undo .lbl{ font-weight:700; }\n  .bp-undo .spacer{ flex:1; }\n  .bp-undo button{ white-space:nowrap; }\n  @keyframes bpUndoPop{ from{ transform: translate(-50%, 4px); opacity:0 } to{ transform: translate(-50%, 0); opacity:1 } }\n  ",o=document.createElement("style");o.textContent=i,document.head.appendChild(o);function a(s){const r=document.createElement("div");r.className="bp-undo",r.innerHTML='\n      <div class="lbl">'.concat(s&&s.label||"Operazione eseguita",'</div>\n      <div class="spacer"></div>\n      <button type="button" class="ghost" data-undo>Annulla</button>\n    '),e.appendChild(r);let l=!1;const c=setTimeout(()=>{l||(l=!0,r.remove())},s&&s.timeoutMs||5e3);r.querySelector("[data-undo]").addEventListener("click",()=>{if(!l){l=!0,clearTimeout(c);try{s&&s.onUndo&&s.onUndo()}catch(d){}r.remove()}})}t.push=a})();const ce=window.BP&&BP.Haptics&&BP.Haptics.impact?BP.Haptics.impact:()=>{};(function(){window.bpAuthToken||(window.bpAuthToken=function(){try{const w=localStorage.getItem("bp_user")||sessionStorage.getItem("bp_user");if(w)try{const I=JSON.parse(w);if(I&&(I.token||I.jwt||I.accessToken))return I.token||I.jwt||I.accessToken}catch(I){}}catch(w){}const k=["bp_token","authToken","token","jwt","accessToken","id_token","auth","authorization","session","user"];for(const w of k)try{const I=localStorage.getItem(w)||sessionStorage.getItem(w);if(!I)continue;try{const h=JSON.parse(I);if(h&&(h.token||h.jwt||h.accessToken))return h.token||h.jwt||h.accessToken}catch(h){}if(/^[A-Za-z0-9\-_]+\.[A-Za-z0-9\-_]+\.[A-Za-z0-9\-_]+$/.test(I))return I}catch(I){}try{for(let w=0;w<localStorage.length;w++){const I=localStorage.key(w),h=localStorage.getItem(I);if(h){try{const x=JSON.parse(h);if(x&&(x.token||x.jwt||x.accessToken))return x.token||x.jwt||x.accessToken}catch(x){}if(/^[A-Za-z0-9\-_]+\.[A-Za-z0-9\-_]+\.[A-Za-z0-9\-_]+$/.test(h))return h}}}catch(w){}try{const w=JSON.parse(localStorage.getItem("user")||"{}");if(w&&(w.token||w.jwt||w.accessToken))return w.token||w.jwt||w.accessToken}catch(w){}return null}),window.GET||(window.GET=async function(k){const w=window.bpAuthToken&&window.bpAuthToken()||null,I=await fetch(k,{headers:{Accept:"application/json",...w?{Authorization:"Bearer "+w}:{}}});return I.status===204?null:(I.headers.get("content-type")||"").includes("application/json")?I.json():{ok:I.ok,status:I.status,text:await I.text()}}),window.POST||(window.POST=async function(k,w){const I=window.bpAuthToken&&window.bpAuthToken()||null,h=await fetch(k,{method:"POST",headers:{"Content-Type":"application/json",...I?{Authorization:"Bearer "+I}:{}},body:JSON.stringify(w||{})});return h.status===204?null:(h.headers.get("content-type")||"").includes("application/json")?h.json():{ok:h.ok,status:h.status,text:await h.text()}}),typeof window<"u"&&typeof window.initPostSaleBanners=="function"&&window.initPostSaleBanners(ce),(function(){if(document.getElementById("bp-qvss-css"))return;const w=document.createElement("style");w.id="bp-qvss-css",w.textContent='\n    #bp_overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);\n      display:flex;align-items:center;justify-content:center;z-index:9999;padding:16px}\n    .bp-modal{max-width:560px;width:clamp(300px,90vw,560px);background:var(--card,#fff);\n      color:var(--text,#111);border-radius:14px;border:1px solid rgba(0,0,0,.12);\n      box-shadow:0 12px 34px rgba(0,0,0,.35)}\n    .bp-modal .hd{display:flex;align-items:center;justify-content:space-between;padding:12px 14px}\n    .bp-modal .bd{padding:10px 14px 14px}\n    .bp-modal .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}\n    .bp-modal .right{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}\n    .bp-modal input[type="number"], .bp-modal input[type="date"], .bp-modal select, .bp-modal textarea{\n      width:100%;padding:8px;border:1px solid rgba(0,0,0,.18);border-radius:10px}\n    @media (prefers-color-scheme:dark){\n      .bp-modal{background:rgba(15,18,28,.98);color:#fff;border-color:rgba(255,255,255,.14)}\n      .bp-modal input, .bp-modal select, .bp-modal textarea{background:rgba(255,255,255,.04);color:#fff;border-color:rgba(255,255,255,.18)}\n    }\n  ',document.head.appendChild(w)})();function n(k){return String(k||"").replace(/[&<>'"]/g,w=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[w])}function t(k){if(window.showOverlay)window.showOverlay(k);else{const w=document.createElement("div");w.id="bp_overlay",w.innerHTML=k,document.body.appendChild(w)}}function e(){if(window.hideOverlay)window.hideOverlay();else{const k=document.getElementById("bp_overlay");k&&k.remove()}}async function i(k){try{const w=await M("/api/clients"),I=w&&w.clients||[],h=String(k||"").trim().toLowerCase(),x=I.find(A=>String(A.name||"").trim().toLowerCase()===h);return x?x.id:null}catch(w){return null}}async function o(k,w){if(!(Number(w)>0))return null;const I=new Date(k.end||k.start||Date.now()).toISOString();let h=k.clientId||null;h||(h=await i(k.client));const x={date:I,vssTotal:Number(w)||0,services:k.services||"",consultantId:k.userId||(JSON.parse(localStorage.getItem("user")||"{}")||{}).id,clientId:h||void 0,clientName:k.client||void 0},A=await X("/api/gi",x);return A&&(A.id||A.sale&&A.sale.id)||null}async function a(k){if(typeof viewGI=="function"&&document.querySelector("#gi_rows")){document.dispatchEvent(new CustomEvent("gi:edit",{detail:{id:k}}));return}if(typeof viewGI=="function"){try{viewGI()}catch(w){}setTimeout(()=>document.dispatchEvent(new CustomEvent("gi:edit",{detail:{id:k}})),350);return}try{let A=function(O){const D=x("pb_rates");if(!O||!O.length){D.textContent="Nessuna rata",D._data=[];return}D.innerHTML=O.map(U=>{const H=new Date(U.dueDate).toLocaleDateString("it-IT");return"<div>".concat(H,"  ").concat(Number(U.amount||0).toLocaleString("it-IT"),' <span class="muted">').concat(n(U.note||""),"</span></div>")}).join(""),D._data=O};const w=await M("/api/gi?from=1900-01-01&to=2999-12-31"),I=(w&&w.sales||[]).find(O=>String(O.id)===String(k));if(!I){y("Vendita non trovata");return}const h=new Date().toISOString().slice(0,10);t('<div class="bp-modal"><div class="hd"><b>Builder pagamenti  '+n(I.clientName||"Cliente")+'</b><button class="ghost" id="pb_x">Chiudi</button></div><div class="bd"><div class="row"><div style="flex:1"><label>Totale VSS</label><input id="pb_vss" type="number" value="'+Number(I.vssTotal||0)+'"></div></div><div class="row" style="margin-top:8px;gap:12px"><div><label>Regola rapida</label><select id="pb_rule"><option value="0">Manuale</option><option value="50-25-25">50% + 25% / 30-60gg</option><option value="20+12">20% + 12 rate mensili</option></select></div><div><label>Prima scadenza</label><input id="pb_first" type="date" value="'+h+'"></div></div><div style="margin-top:8px"><label>Rate</label><div id="pb_rates" class="small muted">Nessuna rata</div></div><div class="right"><button class="ghost" id="pb_apply">Ricalcola</button><button id="pb_save">Salva</button></div></div></div>');const x=O=>document.getElementById(O);x("pb_apply").onclick=function(){const O=x("pb_rule").value||"0",D=Math.max(0,Number(x("pb_vss").value||0)),U=new Date(x("pb_first").value||new Date),H=[],Y=(rt,m,g)=>H.push({dueDate:new Date(rt).toISOString(),amount:Math.round(m),note:g||""});if(O==="50-25-25"){Y(U,D*.5,"Acconto 50%");const rt=new Date(U);rt.setDate(rt.getDate()+30),Y(rt,D*.25,"Saldo 25% a 30gg");const m=new Date(U);m.setDate(m.getDate()+60),Y(m,D*.25,"Saldo 25% a 60gg")}else if(O==="20+12"){Y(U,D*.2,"Acconto 20%");const rt=D*.8,m=12,g=rt/m;for(let S=0;S<m;S++){const C=new Date(U);C.setMonth(C.getMonth()+S+1),Y(C,g,"Rata "+(S+1)+"/"+m)}}A(H)},x("pb_save").onclick=async function(){const O=Math.max(0,Number(x("pb_vss").value||0)),D=x("pb_rates")._data||[];try{await X("/api/gi",{id:I.id,vssTotal:O,schedule:D});try{document.dispatchEvent(new CustomEvent("payments:defined",{detail:{id:I.id,vssTotal:O,schedule:D}}))}catch(U){}y("Piano pagamenti salvato"),e()}catch(U){logger.error(U),y("Errore salvataggio")}},x("pb_x").onclick=e}catch(w){logger.error(w)}}function s(k){const w=k.client||"Cliente",I=Number(k.vss||k.vsdPersonal||0)||0;t('<div class="bp-modal"><div class="hd"><b>VSS per '+n(w)+'</b><button class="ghost" id="qvss_x">Chiudi</button></div><div class="bd"><div><label>Valore VSS</label><input id="qvss_val" type="number" step="1" value="'+I+'"></div><div class="small muted" style="margin-top:6px">Modifica consentita solo per VSS</div><div class="right"><button id="qvss_ok">Salva</button></div></div></div>'),document.getElementById("qvss_x").onclick=e,document.getElementById("qvss_ok").onclick=async function(){try{const h=Math.max(0,Number(document.getElementById("qvss_val").value||0));await X("/api/appointments",{id:k.id,vss:h});const x=await o(k,h);e(),y("VSS salvato"),x&&a(x);try{x&&document.dispatchEvent(new CustomEvent("gi:created",{detail:{id:x}}))}catch(A){}document.dispatchEvent(new Event("bp:saved"))}catch(h){logger.error(h),y("Errore salvataggio VSS")}}}async function r(k){try{k.nncf&&(await(async function(){try{const I=await M("/api/clients"),h=I&&I.clients||[],x=String(k.client||"").trim().toLowerCase(),A=h.find(O=>String(O.name||"").trim().toLowerCase()===x);A&&await X("/api/clients",{id:A.id,status:"attivo"})}catch(I){}})(),document.dispatchEvent(new Event("client:converted"))),s(k)}catch(w){logger.error(w)}}async function l(k){try{if(k.nncf)try{const w=await M("/api/clients"),I=w&&w.clients||[],h=String(k.client||"").trim().toLowerCase(),x=I.find(A=>String(A.name||"").trim().toLowerCase()===h);x&&await X("/api/clients",{id:x.id,status:"lead non chiuso"})}catch(w){}await X("/api/appointments",{id:k.id,vss:0}),y("Ok, segnato come non venduto")}catch(w){logger.error(w),y("Errore aggiornamento")}}window.pipelineYes=r,window.pipelineNo=l,(function(){function k(){if(document.getElementById("bp-center-css"))return;const H="\n      #bp_overlay{display:flex;align-items:center;justify-content:center}\n      .bp-modal-card{min-width:min(480px,90vw);max-width:600px;max-height:86vh;overflow:auto}\n      @media (max-width:640px){ .bp-modal-card{min-width:90vw} }\n      .bp-modal-foot{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}\n    ",Y=document.createElement("style");Y.id="bp-center-css",Y.textContent=H,document.head.appendChild(Y)}function w(H){try{document.documentElement.style.overflow=H?"hidden":""}catch(Y){}}async function I(H){if(!H)return null;try{const Y=await M("/api/clients"),rt=Y&&Y.clients||[],m=String(H).trim().toLowerCase(),g=rt.find(S=>String(S.name||"").trim().toLowerCase()===m);return g?g.id:null}catch(Y){return null}}async function h(H,Y){const rt=await I(H);if(rt)try{await X("/api/clients",{id:rt,status:Y})}catch(m){}}async function x(H,Y){return X("/api/appointments",{id:H,vss:Math.max(0,Number(Y||0))})}async function A(H,Y){const rt=await I(H.client||""),m={date:new Date(H.end||H.start||Date.now()).toISOString(),clientId:rt||void 0,clientName:H.client||"",vssTotal:Math.max(0,Number(Y||0)),services:H.services||"",schedule:[]},g=await X("/api/gi",m);return g&&(g.id||g.sale&&g.sale.id||Array.isArray(g.sales)&&g.sales[0]&&g.sales[0].id)||null}async function O(H){if(!H)return;try{typeof window.viewGI=="function"&&window.viewGI()}catch(rt){}let Y=0;(function rt(){if(document.getElementById("gi_rows")||Y>40){try{const g=new CustomEvent("gi:edit",{detail:{id:H}});document.dispatchEvent(g)}catch(g){}return}Y++,setTimeout(rt,100)})()}function D(H,Y){k(),w(!0);const rt=Math.max(0,Number(H.vss||0)),m='<div class="modal"><div class="card bp-modal-card"><div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><b>VSS per '+(H.client?U(H.client):"appuntamento")+'</b><button class="ghost" id="qvss_x">Chiudi</button></div><div style="margin-top:8px"><label>Valore VSS</label><input id="qvss_val" type="number" step="1" value="'+rt+'"><div class="small muted" style="margin-top:6px">Modifica consentita solo per VSS</div></div><div class="bp-modal-foot"><button id="qvss_ok">Salva</button></div></div></div>';showOverlay(m);function g(){w(!1),hideOverlay()}const S=document.getElementById("qvss_val");document.getElementById("qvss_x").onclick=g,document.getElementById("qvss_ok").onclick=async function(){try{const C=Math.max(0,Number(S.value||0));await x(H.id,C);const L=await A(H,C);if(g(),L)try{document.dispatchEvent(new CustomEvent("gi:created",{detail:{id:L}}))}catch(z){}O(L)}catch(C){logger.error(C),y("Errore salvataggio VSS")}}}function U(H){return String(H||"").replace(/[&<>'"]/g,Y=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[Y])}window.pipelineYes=async function(H){try{H.nncf&&await h(H.client,"cliente"),D(H)}catch(Y){logger.error(Y)}},window.pipelineNo=async function(H){try{H.nncf&&await h(H.client,"lead non chiuso"),await x(H.id,0),ce("light"),y("Segnato VSS 0")}catch(Y){logger.error(Y)}}})(),(function(){function k(O){return encodeURIComponent(String(O||""))}function w(){try{const Y=document.getElementById("rep_label");if(Y&&Y.textContent)return Y.textContent.trim()}catch(Y){}const O=(document.getElementById("rep_type")||{}).value||"mensile",D=new Date,U=String(D.getMonth()+1).padStart(2,"0"),H=D.getFullYear();return O==="settimanale"?"Settimana ISO "+(isoWeekNum?isoWeekNum(D):"corrente")+" "+H:O==="trimestrale"?"Q"+(Math.floor(D.getMonth()/3)+1)+" "+H:O==="semestrale"?"Semestre "+(D.getMonth()<6?"1":"2")+" "+H:O==="annuale"?"Anno "+H:"Mese "+U+"/"+H}async function I(){try{const O=await M("/api/usernames");return(O&&O.users||[]).map(U=>U.email).filter(Boolean).join(",")}catch(O){return""}}function h(){const O=document.getElementById("report_subject");return O&&O.value&&O.value.trim()?O.value.trim():"Report BP  "+w()}function x(){const O=document.getElementById("report_body");return O&&O.value&&O.value.trim()?O.value:"Ciao,\n\ndi seguito il report del periodo "+w()+".\n\n VSS\n VSD\n GI\n NNCF\n\nA presto."}async function A(){const O=document.getElementById("rep_gmail_web"),D=document.getElementById("rep_gmail_app");if(!O&&!D)return;const U=await I(),H=h(),Y=x();try{await navigator.clipboard.writeText(Y)}catch(rt){}O&&(O.onclick=function(){const rt="https://mail.google.com/mail/?view=cm&fs=1&tf=1&su="+k(H)+"&cc="+k(U)+"&body="+k(Y);window.open(rt,"_blank");try{document.dispatchEvent(new Event("report:composed"))}catch(m){}}),D&&(D.onclick=function(){const rt="googlegmail:///co?subject="+k(H)+"&cc="+k(U)+"&body="+k(Y);location.href=rt;try{document.dispatchEvent(new Event("report:composed"))}catch(m){}setTimeout(function(){if(!document.hidden){location.href="mailto:?subject="+k(H)+"&cc="+k(U)+"&body="+k(Y);try{document.dispatchEvent(new Event("report:composed"))}catch(m){}}},1200)})}window.wireReportButtons=A})(),(function(){function k(D){var U=D instanceof Date?D:new Date(D||Date.now()),H=U.getFullYear(),Y=("0"+(U.getMonth()+1)).slice(-2),rt=("0"+U.getDate()).slice(-2);return H+"-"+Y+"-"+rt}function w(D){for(var U=k(new Date),H=D.querySelectorAll("[data-date], [data-day]"),Y=0;Y<H.length;Y++){var rt=H[Y],m=rt.getAttribute("data-date")||rt.getAttribute("data-day")||"";if(m){var g=String(m).slice(0,10);g===U&&rt.classList.add("today")}}}function I(D){if(typeof window.attachICSButtons=="function"){try{window.attachICSButtons(D)}catch(C){logger.error(C)}return}for(var U=D.querySelectorAll("[data-appt], [data-start][data-title], .appt, .calendar-appt"),H=0;H<U.length;H++){var Y=U[H];if(!Y.querySelector(".bp-ics")){var rt=Y.getAttribute("data-start")||"",m=Y.getAttribute("data-end")||"",g=Y.getAttribute("data-title")||Y.getAttribute("data-client")||"Appuntamento";if(rt){var S=document.createElement("a");S.href="#",S.className="bp-ics btn-ics",S.textContent="",S.style.marginLeft="6px",S.onclick=function(C){C.preventDefault();try{var L=C.currentTarget.parentElement||document.body,z=L.getAttribute("data-start")||rt,tt=L.getAttribute("data-end")||m||z,q=L.getAttribute("data-title")||L.getAttribute("data-client")||g,ht=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//BP//Calendar//IT","BEGIN:VEVENT","UID:"+Date.now()+"@bp","DTSTAMP:"+new Date().toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z"),"DTSTART:"+new Date(z).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z"),"DTEND:"+new Date(tt).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z"),"SUMMARY:"+q,"END:VEVENT","END:VCALENDAR"].join("\r\n"),V=new Blob([ht],{type:"text/calendar"}),nt=URL.createObjectURL(V),vt=document.createElement("a");vt.href=nt,vt.download=(q||"appuntamento")+".ics",document.body.appendChild(vt),vt.click(),setTimeout(function(){URL.revokeObjectURL(nt);try{vt.remove()}catch(K){}},0)}catch(K){logger.error(K)}},Y.appendChild(S)}}}}function h(){var D=document.getElementById("calendar")||document.querySelector(".calendar")||document;w(D),I(D)}window.hookCalendar=h;function x(D){if(document.readyState==="complete"||document.readyState==="interactive")return D();document.addEventListener("DOMContentLoaded",D,{once:!0})}x(h);var A=document.getElementById("calendar")||document.querySelector(".calendar");if(A&&!A.__bpCalObs){A.__bpCalObs=!0;var O=new MutationObserver(function(){try{h()}catch(D){}});O.observe(A,{childList:!0,subtree:!0})}})(),(function(){var k=!1;function w(){if(!k){k=!0;var I='.today{outline:2px solid var(--accent, #5dd3ff); outline-offset:-2px; border-radius:8px; position:relative;}.today::after{content:"OGGI"; position:absolute; top:6px; right:8px; font-size:10px; font-weight:700; color:#fff; background:var(--accent, #5dd3ff); padding:2px 6px; border-radius:6px;}',h=document.createElement("style");h.setAttribute("data-bp-today","1"),h.textContent=I,document.head.appendChild(h)}}window.injectTodayCSS=w,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",w,{once:!0}):w()})(),(function(){function k(){try{return JSON.parse(localStorage.getItem("user")||"{}")}catch(H){return{}}}function w(){var H=k();return H&&H.role==="admin"}function I(H,Y){return(Y||document).querySelector(H)}function h(H,Y){return Array.prototype.slice.call((Y||document).querySelectorAll(H))}function x(H){var Y=new Date(H);return!Y||isNaN(Y)?"":("0"+Y.getDate()).slice(-2)+"/"+("0"+(Y.getMonth()+1)).slice(-2)+"/"+Y.getFullYear()}async function A(){try{for(var H=await M("/api/appointments"),Y=H&&H.appointments||[],rt={},m=0;m<Y.length;m++){var g=Y[m],S=String(g.client||"").trim().toLowerCase();if(S){var C=new Date(g.start||g.end||0).getTime();(!rt[S]||C>rt[S])&&(rt[S]=C)}}return rt}catch(L){return logger.error(L),{}}}async function O(){var H=document.getElementById("cl_list");if(H){var Y=await A();h(".card",H).forEach(function(rt){var m=I("b",rt);if(m){var g=(m.textContent||"").trim().toLowerCase();if(g){var S=Y[g],C=I(".bp-lastapp",rt),L="Ultimo appuntamento: "+(S?x(S):"");if(C)C.textContent=L;else{var z=document.createElement("div");z.className="small muted bp-lastapp",z.textContent=L,rt.appendChild(z)}}}})}}async function D(){if(!w())return;var H=document.getElementById("cl_list");if(!H)return;var[Y,rt]=await Promise.all([M("/api/clients"),M("/api/usernames")]),m=Y&&Y.clients||[],g=rt&&rt.users||[];function S(C){var L=I("b",C),z=(L&&L.textContent||"").trim().toLowerCase();return m.find(function(tt){return String(tt.name||"").trim().toLowerCase()===z})}H.__bpInlineReady||(H.__bpInlineReady=!0,h(".card",H).forEach(function(C){if(!C.__bpInline){C.__bpInline=!0;var L=S(C);if(L){var z=document.createElement("div");z.style.display="flex",z.style.gap="8px",z.style.marginTop="6px";var tt=document.createElement("button");tt.className="ghost",tt.textContent="Modifica",z.appendChild(tt),C.appendChild(z);var q=document.createElement("div");q.style.display="none",q.style.marginTop="8px",q.innerHTML='<div class="row" style="gap:8px"><div><label>Nome</label><input class="bp-ed-name" type="text" value="'+(L.name||"")+'"></div><div><label>Stato</label><select class="bp-ed-state"><option value="prospect" '+(L.status==="prospect"?"selected":"")+'>Prospect</option><option value="attivo" '+(L.status==="attivo"?"selected":"")+'>Attivo</option><option value="cliente" '+(L.status==="cliente"?"selected":"")+'>Cliente</option></select></div><div><label>Consulente</label><select class="bp-ed-consulente"></select></div><div style="align-self:flex-end"><button class="ghost bp-ed-save">Salva</button></div></div>',C.appendChild(q);var ht=I(".bp-ed-consulente",q);ht.innerHTML='<option value=""></option>'+g.map(function(V){return'<option value="'+V.id+'" '+(String(L.consultantId||"")===String(V.id)?"selected":"")+">"+(V.name||"User "+V.id)+"</option>"}).join(""),tt.onclick=function(){q.style.display=q.style.display==="none"?"block":"none"},I(".bp-ed-save",q).onclick=async function(V){V.preventDefault();try{var nt={id:L.id,name:I(".bp-ed-name",q).value.trim(),status:I(".bp-ed-state",q).value,consultantId:I(".bp-ed-consulente",q).value||null};await X("/api/clients",nt);var vt=I("b",C);vt&&(vt.textContent=nt.name);var K=I(".small",C);K&&/Stato:/.test(K.textContent||"")&&(K.innerHTML="Stato: <b>"+nt.status+"</b>");var P=h(".small",C).find(function(J){return/Consulente:/.test(J.textContent||"")});if(P){var et=g.find(function(J){return String(J.id)===String(nt.consultantId||"")});P.innerHTML="Consulente: <b>"+(et?et.name||"User "+et.id:"")+"</b>"}ce("medium")}catch(J){logger.error(J),ce("heavy")}}}}}))}window.applyClientsLastAppointment=O,window.ensureClientInlineEdit=D;function U(){var H=document.getElementById("cl_list");if(H&&(O(),D(),!H.__bpCliObs)){H.__bpCliObs=!0;var Y=new MutationObserver(function(){O(),D()});Y.observe(H,{childList:!0,subtree:!0})}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",U,{once:!0}):U()})();function c(k){const w=["#".concat(k,"_mode"),"#dash_mode","#comm_mode",'[data-scope="'.concat(k,'"] [name="mode"]'),"#".concat(k,' select[name="mode"]'),'#dashboard select[name="mode"]','select[name="mode"]'];for(const I of w){const h=document.querySelector(I);if(h&&h.value)return h.value}return"consuntivo"}if(window.__BP_FINAL_READY__)return;window.__BP_FINAL_READY__=!0;const d=(k,w)=>(w||document).querySelector(k),u=(k,w,I)=>k&&k.addEventListener(w,I,!1),p=k=>document.readyState!=="loading"?k():document.addEventListener("DOMContentLoaded",k),f=(k,w)=>{try{return JSON.parse(k)}catch(I){return w}},b=k=>k<10?"0"+k:""+k,v=()=>{const k=new Date;return"".concat(k.getFullYear(),"-").concat(b(k.getMonth()+1),"-").concat(b(k.getDate()))};function y(k){try{(window.showToast?window.showToast:alert)(k)}catch(w){alert(k)}}function E(){const k=I=>{if(!I)return null;I=String(I).replace(/^"+|"+$/g,"");try{const h=JSON.parse(I);if(h&&(h.token||h.jwt||h.accessToken))return h.token||h.jwt||h.accessToken}catch(h){}return/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+$/.test(I)?I:null};for(let I=0;I<localStorage.length;I++){const h=k(localStorage.getItem(localStorage.key(I)));if(h)return h}const w=["token","authToken","jwt","bp_token","accessToken","id_token","auth","authorization","bp.jwt","_token","session","user"];for(const I of w){const h=k(localStorage.getItem(I)||sessionStorage.getItem(I));if(h)return h}try{const I=f(localStorage.getItem("user")||"{}",{});if(I&&(I.token||I.jwt||I.accessToken))return I.token||I.jwt||I.accessToken}catch(I){}return null}async function M(k,w={}){if(typeof window.GET=="function"&&!w.forceFetch)try{return await window.GET(k)}catch(x){}const I=E(),h=await fetch(k,{headers:{Accept:"application/json",...I?{Authorization:"Bearer "+I}:{}}});return h.status===401&&window.GET?window.GET(k):h.status===204?null:h.json()}async function X(k,w,I={}){if(typeof window.POST=="function"&&!I.forceFetch)try{return await window.POST(k,w)}catch(A){}const h=E(),x=await fetch(k,{method:"POST",headers:{"Content-Type":"application/json",...h?{Authorization:"Bearer "+h}:{}},body:JSON.stringify(w||{})});return!x.ok&&x.status===401&&window.POST?window.POST(k,w):x.status===204?null:x.json()}function it(k,w,I){const h=document.getElementById(k);if(!h)return;const x=h.getContext("2d"),A=window.devicePixelRatio||1,O=Math.max(220,h.clientWidth||320),D=Math.max(80,h.clientHeight||80);h.style.width=O+"px",h.style.height=D+"px",h.width=O*A,h.height=D*A,x.scale(A,A),x.clearRect(0,0,O,D);const U=Array.isArray(I)?I.map(z=>+z||0):[];if(!U.length)return;const H=Math.max(...U),Y=Math.min(...U),rt=H-Y===0?(H||1)*.2:(H-Y)*.2,m=H+rt,g=Math.max(0,Y-rt),S=U.length>1?(O-8)/(U.length-1):0,C=z=>4+z*S,L=z=>{const tt=(z-g)/(m-g||1);return D-6-tt*(D-12)};x.lineWidth=2,x.lineJoin=x.lineCap="round",x.strokeStyle="#2e6cff",x.beginPath(),x.moveTo(C(0),L(U[0]));for(let z=1;z<U.length;z++)x.lineTo(C(z),L(U[z]));x.stroke(),x.fillStyle="#2e6cff";for(let z=0;z<U.length;z++)x.beginPath(),x.arc(C(z),L(U[z]),2,0,Math.PI*2),x.fill()}(function(){const w=function(I,h,x){const A=document.getElementById(I);if(A){if(window.Chart)try{A.__chart&&typeof A.__chart.destroy=="function"&&A.__chart.destroy();const O=typeof window.computeTickOptions=="function"?window.computeTickOptions(h,A.clientWidth||320):void 0,D={type:"line",data:{labels:h,datasets:[{data:x,tension:.35,pointRadius:2,borderWidth:2}]},options:{responsive:!0,plugins:{legend:{display:!1}},scales:{x:Object.assign({display:!0},O?{ticks:O}:{}),y:{display:!0}}}};A.__chart=new Chart(A.getContext("2d"),D);return}catch(O){}it(I,h,x)}};(!window.drawFullLine||!window.drawFullLine.__patched)&&(window.drawFullLine=w,window.drawFullLine.__patched=!0)})();function Q(k,w){try{if(typeof window.labelsForBuckets=="function")return window.labelsForBuckets(k,w)}catch(h){}const I=typeof effectivePeriodType=="function"?effectivePeriodType(String(k||"mensile").toLowerCase()):String(k||"mensile").toLowerCase();return(w||[]).map(h=>{const x=new Date(h.s);return I==="settimanale"?"W"+(typeof isoWeekNum=="function"?isoWeekNum(x):"")+" "+x.getUTCFullYear():I==="mensile"?String(x.getUTCMonth()+1).padStart(2,"0")+"/"+x.getUTCFullYear():I==="trimestrale"?"Q"+(Math.floor(x.getUTCMonth()/3)+1)+" "+x.getUTCFullYear():I==="semestrale"?(x.getUTCMonth()<6?"S1 ":"S2 ")+x.getUTCFullYear():String(x.getUTCFullYear())})}const ft=typeof window<"u"?window.__periodsCache||(window.__periodsCache={}):{};function ut(k){try{const w=new Date(k),I=w.getUTCFullYear(),h=String(w.getUTCMonth()+1).padStart(2,"0"),x=String(w.getUTCDate()).padStart(2,"0");return I+"-"+h+"-"+x}catch(w){return""}}function ct(k){try{return typeof effectivePeriodType=="function"?effectivePeriodType(String(k||"mensile").toLowerCase()):String(k||"mensile").toLowerCase()}catch(w){return String(k||"mensile").toLowerCase()}}async function It(k){if(!k){if(Array.isArray(window.periods)&&window.periods.length)return window.periods;try{const U=await M("/api/periods?global=1");if(U&&Array.isArray(U.periods))return window.periods=U.periods,U.periods}catch(U){}return window.periods||[]}let w,I,h,x=null;if(typeof k=="string"){const U=window.readUnifiedRange&&window.readUnifiedRange(k)||{type:"mensile",end:new Date};w=U.type||"mensile";const H=window.buildBuckets?window.buildBuckets(w,U.end):[];if(H&&H.length)I=ut(new Date(H[0].s)),h=ut(new Date(H[H.length-1].e));else if(U.start&&U.end)I=ut(new Date(U.start)),h=ut(new Date(U.end));else{const Y=new Date;I=ut(Y),h=ut(Y)}}else{const U=k||{};w=U.type||"mensile",I=U.from||ut(new Date),h=U.to||ut(new Date),x=U.userId||null}const A=ct(w),O=[A,I,h,x||""].join("|");if(ft[O])return ft[O];const D=["?global=1","type="+encodeURIComponent(A),"from="+encodeURIComponent(I),"to="+encodeURIComponent(h)].concat(x?["userId="+encodeURIComponent(x)]:[]).join("&").replace("?&","?");try{const U=await M("/api/periods"+D).catch(function(){return M("/api/periods"+D.replace("?global=1","?").replace("??","?"))}),H=U&&Array.isArray(U.periods)?U.periods:[];return ft[O]=H,H}catch(U){return[]}}function Ot(k,w,I){const h=String(w).toLowerCase()==="previsionale"?k.indicatorsPrev||{}:k.indicatorsCons||{},x=Number(h[I]||0);return Number.isFinite(x)?x:0}function Ut(k,w,I){if(typeof window.drawFullLine=="function")return window.drawFullLine(k,w,I);it(k,w,I)}async function Vt(){const k=window.readUnifiedRange&&window.readUnifiedRange("dash")||{type:"mensile",end:new Date},w=k.type||"mensile",I=c("dash"),h=window.buildBuckets?window.buildBuckets(w,k.end):[],x=await It("dash"),A=Q(w,h);["VSS","VSDPersonale","GI","NNCF"].forEach(O=>{const D=h.map(U=>{let H=0;return x.forEach(Y=>{if(Y.type!==effectivePeriodType(w))return;const rt=new Date(Y.startDate).getTime(),m=new Date(Y.endDate).getTime();rt>=U.s&&m<=U.e&&(H+=Ot(Y,I,O))}),Math.round(H)});Ut("d_mini_"+O.toLowerCase(),A,D)});try{if(window.BP&&BP.Targets&&typeof BP.Targets.getForPeriod=="function"){const O=JSON.parse(localStorage.getItem("user")||"{}")||{},D=String(O.grade||"junior").toLowerCase()==="senior"?"senior":"junior",U=BP.Targets.getForPeriod(D,effectivePeriodType(w))||{},H=["VSS","VSDPersonale","GI","NNCF"],Y={};H.forEach(rt=>{let m=0;const g=h[h.length-1];g&&(x.forEach(S=>{if(S.type!==effectivePeriodType(w))return;const C=new Date(S.startDate).getTime(),L=new Date(S.endDate).getTime();C>=g.s&&L<=g.e&&(m+=Ot(S,I,rt))}),Y[rt]=Math.round(m))}),window.__bpCoachKpiFired=window.__bpCoachKpiFired||{},H.forEach(rt=>{const m=Number(U[rt]||0);if(m<=0)return;const g=Number(Y[rt]||0),S=Math.round(g/m*100),C=effectivePeriodType(w)+"_"+rt;if(S>=100&&!window.__bpCoachKpiFired[C+"_100"]){window.__bpCoachKpiFired[C+"_100"]=!0;try{document.dispatchEvent(new CustomEvent("kpi:goal-reached",{detail:{key:rt,value:g,target:m}}))}catch(L){}}else if(S>=80&&!window.__bpCoachKpiFired[C+"_80"]){window.__bpCoachKpiFired[C+"_80"]=!0;try{document.dispatchEvent(new CustomEvent("kpi:goal-80",{detail:{key:rt,value:g,target:m}}))}catch(L){}}})}}catch(O){}}async function Mt(){const k="comm",w=window.readUnifiedRange&&(window.readUnifiedRange(k)||window.readUnifiedRange("cm"))||{type:"mensile",end:new Date},I=w.type||"mensile",h=c&&c(k)||c&&c("cm")||"cons",x=window.buildBuckets?window.buildBuckets(I,w.end):[],A=await It("comm"),O=Q(I,x),D=x.map(U=>{let H=0;return A.forEach(Y=>{if(Y.type!==effectivePeriodType(I))return;const rt=new Date(Y.startDate).getTime(),m=new Date(Y.endDate).getTime();rt>=U.s&&m<=U.e&&(H+=Ot(Y,h,"VSDPersonale"))}),Math.round(H)});Ut("cm_mini_vsd",O,D)}async function $t(){const k=window.readUnifiedRange&&(window.readUnifiedRange("t")||window.readUnifiedRange("tg"))||{type:"mensile",end:new Date},w=k.type||"mensile",I=c&&c("t")||c&&c("tg")||"cons",h=(d("#tg_user")||{}).value||"",x=(d("#tg_ind")||{}).value||"VSS",A=window.buildBuckets?window.buildBuckets(w,k.end):[];function O(m){try{const g=new Date(m),S=g.getUTCFullYear(),C=String(g.getUTCMonth()+1).padStart(2,"0"),L=String(g.getUTCDate()).padStart(2,"0");return S+"-"+C+"-"+L}catch(g){return""}}const D=A.length?O(new Date(A[0].s)):O(new Date),U=A.length?O(new Date(A[A.length-1].e)):O(new Date),H=await It({type:w,from:D,to:U,userId:h||null}),Y=Q(w,A),rt=A.map(m=>{let g=0;return H.forEach(S=>{if(S.type!==effectivePeriodType(w)||h&&String(S.userId)!==String(h))return;const C=new Date(S.startDate).getTime(),L=new Date(S.endDate).getTime();C>=m.s&&L<=m.e&&(g+=Ot(S,I,x))}),Math.round(g)});Ut("tg_chart",Y,rt)}function Kt(){u(d("#dash_mode"),"change",()=>{ce("light"),window.recomputeDashboard&&recomputeDashboard(),window.recomputeDashboardMini&&Vt()}),u(d("#d_mode"),"change",()=>{ce("light"),window.recomputeDashboard&&recomputeDashboard(),window.recomputeDashboardMini&&Vt()}),u(d("#comm_mode"),"change",()=>{ce("light"),window.recomputeCommsMini&&Mt()}),u(d("#cm_mode"),"change",()=>{ce("light"),window.recomputeCommsMini&&Mt()});const k=d("#tg_user");k&&k.options.length<=1&&M("/api/usernames").then(h=>{(h&&h.users||[]).forEach(x=>{var A=document.createElement("option");A.value=x.id,A.textContent=(x.name||"User "+x.id)+(x.grade?"  "+x.grade:""),k.appendChild(A)})}).catch(h=>logger.error(h));const w=()=>{window.recomputeTeamChart&&$t(),window.recomputeTeamAggChart&&recomputeTeamAggChart()};u(d("#t_mode"),"change",()=>{ce("light"),w()}),["#t_y","#t_m","#t_q","#t_from","#t_to"].forEach(h=>{const x=d(h);x&&u(x,"change",w)}),k&&u(k,"change",()=>{ce("light"),window.recomputeTeamChart&&$t()});const I=d("#t_ind");I&&u(I,"change",()=>{ce("light"),window.recomputeTeamAggChart&&recomputeTeamAggChart()}),d("#tg_chart")&&window.recomputeTeamChart&&$t(),d("#t_chart")&&window.recomputeTeamAggChart&&recomputeTeamAggChart()}typeof window.todayKey!="function"&&(window.todayKey=function(){var w=new Date,I=w.getFullYear(),h=("0"+(w.getMonth()+1)).slice(-2),x=("0"+w.getDate()).slice(-2);return I+"-"+h+"-"+x});function Zt(){try{var k=v(),w=document.querySelector('.calendar .day[data-day="'+k+'"], .calendar .day[data-date="'+k+'"]');if(!w)for(var I=parseInt(k.slice(8,10),10),h=document.querySelectorAll(".calendar .day"),x=0;x<h.length;x++){var A=h[x],O=parseInt((A.getAttribute("data-day")||A.getAttribute("data-date")||"").slice(8,10)||A.textContent.trim(),10);if(O===I){w=A;break}}w&&w.classList.add("today")}catch(D){}}function ae(){try{for(var k=v(),w=document.querySelectorAll(".calendar .day[data-day], .calendar .day[data-date]"),I=0;I<w.length;I++){var h=w[I],x=(h.getAttribute("data-day")||h.getAttribute("data-date")||"").slice(0,10);x&&x<k&&h.classList.remove("slot-free")}}catch(A){}}function Ce(){try{var k=document.getElementById("cal_day_box");if(!k)return;for(var w=k.querySelectorAll(".cal-app"),I=0;I<w.length;I++){var h=w[I];if(!h.querySelector("[data-ics-inline]")){var x=h.getAttribute("data-start")||"",A=h.getAttribute("data-end")||"",O=h.getAttribute("data-title")||(h.querySelector("b")?h.querySelector("b").textContent.trim():"Appuntamento");if(!(!x||!A)&&window.BP&&BP.ICS&&typeof BP.ICS.downloadIcsForAppointment=="function"){var D=document.createElement("button");D.className="ghost btn-ics",D.textContent="",D.setAttribute("data-ics-inline","1"),D.style.marginTop="6px",D.addEventListener("click",function(U){U.stopPropagation();var H=U.currentTarget.parentElement,Y=H.getAttribute("data-start"),rt=H.getAttribute("data-end"),m=H.getAttribute("data-title")||(H.querySelector("b")?H.querySelector("b").textContent.trim():"Appuntamento"),g={client:m,start:Y,end:rt,type:"manuale",vss:0,vsdPersonal:0,nncf:!1};try{BP.ICS.downloadIcsForAppointment(g),ce("medium")}catch(S){}}),h.appendChild(D)}}}}catch(U){}}window.markToday=window.markToday||Zt,window.clampSlotCounters=window.clampSlotCounters||ae,window.wireICSInsideDayBox=window.wireICSInsideDayBox||Ce,(function(){function k(O){return encodeURIComponent(String(O||""))}function w(){return M("/api/users_emails").then(function(O){return O&&Array.isArray(O.emails)?O.emails.filter(Boolean):O&&Array.isArray(O.users)?O.users.map(D=>D.email).filter(Boolean):[]}).catch(function(){return M("/api/usernames").then(function(O){var D=O&&O.users||[];return D.map(U=>U.email).filter(Boolean)}).catch(function(){return[]})})}function I(){var O=document.getElementById("report_subject");return O&&O.value.trim()||"Report BP"}function h(){var O=document.getElementById("report_body");return O&&O.value||""}function x(){var O=document.getElementById("rep_gmail_web"),D=document.getElementById("rep_gmail_app");!O&&!D||w().then(function(U){var H=(U||[]).join(",");function Y(){return"https://mail.google.com/mail/?view=cm&fs=1&tf=1&su="+k(I())+"&cc="+k(H)+"&body="+k(h())}function rt(){return"googlegmail:///co?subject="+k(I())+"&cc="+k(H)+"&body="+k(h())}O&&(O.onclick=function(){try{navigator.clipboard&&navigator.clipboard.writeText(h())}catch(m){}window.open(Y(),"_blank")}),D&&(D.onclick=function(){try{navigator.clipboard&&navigator.clipboard.writeText(h())}catch(m){}location.href=rt(),setTimeout(function(){if(!document.hidden){var m="mailto:?subject="+k(I())+"&cc="+k(H)+"&body="+k(h());location.href=m}},1200)})})}var A=window.BPFinal=window.BPFinal||{};A.wireReportButtons=x,window.wireReportButtons||(window.wireReportButtons=x)})(),(function(){let k={ts:0,map:null},w=null;function I(h){const x=Object.create(null);for(const A of h||[]){const O=String(A.client||"").toLowerCase();if(!O)continue;const D=+new Date(A.end||A.start||0);(!x[O]||D>x[O])&&(x[O]=D)}return x}window.BPFinal=window.BPFinal||{},BPFinal.getLastApptMap=function(){const x=Date.now();return k.map&&x-k.ts<15e3?Promise.resolve(k.map):w||(w=M("/api/appointments?global=1").then(A=>I(A&&A.appointments||[])).then(A=>(k={ts:Date.now(),map:A},A)).catch(()=>({})).finally(()=>{w=null}),w)}})();function re(k){var x;if(!k)return;let w=k.querySelector(".bp-appts");if(w&&w.style.display!=="none"){w.remove();return}w||(w=document.createElement("div"),w.className="bp-appts",w.style.marginTop="8px",k.appendChild(w)),w.innerHTML='<div class="muted">Caricamento</div>',w.style.display="block";const I=k.getAttribute("data-clid")||"",h=(((x=k.querySelector("b"))==null?void 0:x.textContent)||"").trim();M("/api/appointments?global=1").then(A=>{const O=A&&A.appointments||[],D=h.toLowerCase(),U=O.filter(Y=>String(Y.clientId||"")===I||String(Y.client||"").trim().toLowerCase()===D);U.sort((Y,rt)=>BPTimezone.parseUTCString(rt.start)-BPTimezone.parseUTCString(Y.start));const H=U.map(Y=>{const rt=BPTimezone.parseUTCString(Y.start),m=("0"+rt.getDate()).slice(-2)+"/"+("0"+(rt.getMonth()+1)).slice(-2)+"/"+rt.getFullYear(),g=[];return Number(Y.vss)>0&&g.push("VSS "+Number(Y.vss).toLocaleString("it-IT")+""),Number(Y.vsdPersonal)>0&&g.push("VSD "+Number(Y.vsdPersonal).toLocaleString("it-IT")+""),Number(Y.vsdIndiretto)>0&&g.push("VSD ind "+Number(Y.vsdIndiretto).toLocaleString("it-IT")+""),Number(Y.telefonate)>0&&g.push("Tel "+Number(Y.telefonate)),Number(Y.appFissati)>0&&g.push("AppFiss "+Number(Y.appFissati)),'<div class="small">'.concat(n(Y.type||""),"  ").concat(m).concat(g.length?"  "+g.join("  "):"","</div>")}).join("")||'<div class="muted">Nessun appuntamento</div>';w.innerHTML=H}).catch(A=>{logger.error(A),w.innerHTML='<div class="muted">Errore caricamento appuntamenti</div>'})}BPFinal.showClientAppointments=re,BPFinal.enrichClientCards=function(){const w=document.getElementById("cl_list");w&&BPFinal.getLastApptMap().then(I=>{const h=w.querySelectorAll(".card[data-clid], .card");for(const x of h){const A=x.querySelector("b"),O=(A?A.textContent:x.getAttribute("data-name")||"").trim().toLowerCase(),D=I[O]||0,U=x.querySelector(".last-appt, .client-last");if(U)if(D){const H=new Date(D),Y=("0"+H.getDate()).slice(-2),rt=("0"+(H.getMonth()+1)).slice(-2),m=H.getFullYear();U.textContent="".concat(Y,"/").concat(rt,"/").concat(m)}else U.textContent="";x.setAttribute("data-last-ts",String(D||0)),!x.getAttribute("data-name-lower")&&O&&x.setAttribute("data-name-lower",O),x.__bp_appts||(x.__bp_appts=!0,x.addEventListener("click",H=>{H.target.closest("button,select,input,a")||x.hasAttribute("data-aid")||re(x)}))}})},BPFinal.enableClientsInlineAdmin=function(){const w=document.getElementById("cl_list");if(!w||w.__bp_inline_admin_wired)return;w.__bp_inline_admin_wired=!0;let I=null;function h(){return I?Promise.resolve(I):M("/api/usernames").then(D=>I=D&&D.users||[]).catch(()=>[])}const x=["attivo","lead non chiuso","potenziale"];function A(D){if(!D||D.nodeType!==1||D.querySelector("[data-edit-client]"))return;D.style.position="relative";const U=document.createElement("button");U.className="ghost small",U.textContent="Modifica",U.title="Modifica cliente",U.setAttribute("data-edit-client","1"),U.style.position="absolute",U.style.right="8px",U.style.top="8px",U.style.zIndex="2",U.style.cursor="pointer",D.appendChild(U),U.addEventListener("click",function(){const H=D.getAttribute("data-clid")||D.dataset.clid||"",Y=D.querySelector("b"),rt=D.querySelector(".cl-status, .client-status"),m=D.querySelector(".cl-cons, .client-owner"),g={name:Y?Y.textContent.trim():"",status:String(rt&&rt.textContent||D.getAttribute("data-status")||"potenziale").toLowerCase(),consId:D.getAttribute("data-consultant-id")||"",consText:m?m.textContent:""},S=document.createElement("input");S.type="text",S.value=g.name,S.style.width="100%",Y&&Y.replaceWith(S);const C=document.createElement("select");C.innerHTML=x.map(L=>'<option value="'.concat(L,'">').concat(L.charAt(0).toUpperCase()+L.slice(1),"</option>")).join(""),C.value=x.includes(g.status)?g.status:"potenziale",rt&&(rt.textContent="",rt.appendChild(C)),h().then(L=>{const z=document.createElement("select");z.innerHTML='<option value=""></option>'+L.map(V=>'<option value="'.concat(V.id,'">').concat(V.name||"User "+V.id).concat(V.grade?" ("+V.grade+")":"","</option>")).join(""),g.consId&&(z.value=String(g.consId)),m&&(m.textContent="",m.appendChild(z));const tt=document.createElement("div");tt.className="row",tt.style.marginTop="8px";const q=document.createElement("button");q.textContent="Salva";const ht=document.createElement("button");ht.textContent="Annulla",ht.className="ghost",tt.appendChild(q),tt.appendChild(ht),D.appendChild(tt),ht.addEventListener("click",function(){const V=document.createElement("b");V.textContent=g.name,S.replaceWith(V),rt&&(rt.textContent=g.status),m.textContent=g.consText||"",tt.remove()}),q.addEventListener("click",function(){const V={id:H,name:S.value.trim(),status:C.value},nt=z.value?String(z.value):"";nt&&(V.consultantId=nt),X("/api/clients",V).then(function(){y("Cliente aggiornato"),typeof addXP=="function"&&addXP(4);const vt=document.createElement("b");vt.textContent=V.name||g.name,S.replaceWith(vt),rt&&(rt.textContent=V.status),nt?(m.textContent=z.options[z.selectedIndex].textContent||"#"+nt,D.setAttribute("data-consultant-id",nt)):(m.textContent="",D.setAttribute("data-consultant-id","")),D.setAttribute("data-status",V.status),tt.remove()}).catch(function(vt){logger.error(vt),y("Errore aggiornamento cliente")})})})})}w.querySelectorAll(".card[data-clid], .card").forEach(A),new MutationObserver(D=>{for(const U of D)for(const H of U.addedNodes)H.nodeType===1&&H.matches(".card[data-clid], .card")&&A(H),H.nodeType===1&&H.querySelectorAll&&H.querySelectorAll(".card[data-clid], .card").forEach(A)}).observe(w,{childList:!0,subtree:!0})},BPFinal.applyClientSort=function(){const w=document.getElementById("cl_list");if(!w)return;const I=document.getElementById("cl_order"),h=I?I.value:"az",x=Array.from(w.children).filter(A=>A.classList.contains("card"));if(x.length){h==="last_desc"?x.sort((A,O)=>(+O.getAttribute("data-last-ts")||0)-(+A.getAttribute("data-last-ts")||0)):x.sort((A,O)=>String(A.getAttribute("data-name-lower")||"").localeCompare(String(O.getAttribute("data-name-lower")||"")));for(const A of x)w.appendChild(A)}},BPFinal.ensureClientFilters=function(){const w=document.getElementById("cl_f_apply");w&&!w.__bp_wired&&(w.__bp_wired=!0,w.addEventListener("click",()=>{setTimeout(()=>{BPFinal.enrichClientCards(),BPFinal.applyClientSort()},0)}));const I=document.getElementById("cl_order");I&&!I.__bp_wired&&(I.__bp_wired=!0,I.addEventListener("change",()=>BPFinal.applyClientSort()))},BPFinal.wireCreateClientExtras=function(){const w=document.getElementById("cl_add");!w||w.__bp_wired||(w.__bp_wired=!0,w.addEventListener("click",I=>{const h=document.getElementById("cl_name"),x=document.getElementById("cl_new_state"),A=document.getElementById("cl_new_owner");if(!h)return;const O=(h.value||"").trim();if(!O||!x&&!A)return;I.stopPropagation(),I.preventDefault();const D={name:O};x&&(D.status=x.value),A&&A.value&&(D.consultantId=A.value),X("/api/clients",D).then(()=>{y("Cliente aggiunto"),addXP&&addXP(5),h.value="",setTimeout(()=>{BPFinal.enrichClientCards(),BPFinal.applyClientSort()},150)}).catch(()=>y("Errore creazione cliente"))},!0))},BPFinal.ensureClientSection=function(){BPFinal.ensureClientFilters(),BPFinal.wireCreateClientExtras(),BPFinal.enrichClientCards(),BPFinal.enableClientsInlineAdmin(),BPFinal.applyClientSort()};async function Se(){const k=d("#tg_user");if(!k||k.options.length>1)return;const w=await M("/api/usernames").catch(()=>null);(w&&w.users||[]).forEach(I=>{const h=document.createElement("option");h.value=I.id,h.textContent=I.name+(I.grade?" ("+I.grade+")":""),k.appendChild(h)})}function We(){const k=d("#users, .users");if(!k||k.__userEditWired)return;k.__userEditWired=!0,k.addEventListener("click",I=>{var H,Y;const h=I.target.closest("[data-edit-user]");if(!h)return;const x=h.closest("[data-user-id]"),A=x==null?void 0:x.getAttribute("data-user-id"),O=((H=x==null?void 0:x.querySelector(".u-name"))==null?void 0:H.textContent)||"",D=((Y=x==null?void 0:x.querySelector(".u-email"))==null?void 0:Y.textContent)||"",U=document.createElement("div");U.className="modal",U.innerHTML='<div class="card"><h3>Modifica utente</h3><label>Nome <input id="u_name" value="'+O+'"></label><label>Email <input id="u_email" value="'+D+'"></label><label>Password <input id="u_pass" type="password" placeholder="(lascia vuoto per non cambiare)"></label><div class="row right"><button id="u_ok" class="btn-ghost">Salva</button><button id="u_x" class="btn-ghost">Chiudi</button></div></div>',document.body.appendChild(U),d("#u_x",U).onclick=()=>U.remove(),d("#u_ok",U).onclick=async()=>{try{const rt={id:A,name:d("#u_name",U).value,email:d("#u_email",U).value},m=d("#u_pass",U).value.trim();m&&(rt.password=m),await X("/api/users",rt),y("Utente aggiornato"),U.remove(),location.reload()}catch(rt){y("Errore aggiornamento utente")}}});const w=d("#btnProfile")||d("[data-edit-self]");w&&!w.__wired&&(w.__wired=!0,w.onclick=()=>{const I=f(localStorage.getItem("user")||"{}",{}),h=document.createElement("div");h.className="modal",h.innerHTML='<div class="card"><h3>Profilo</h3><label>Nome <input id="me_name" value="'+(I.name||"")+'"></label><label>Email <input id="me_email" value="'+(I.email||"")+'"></label><label>Password <input id="me_pass" type="password" placeholder="(nuova password)"></label><div class="row right"><button id="me_ok" class="btn-ghost">Salva</button><button id="me_x" class="btn-ghost">Chiudi</button></div></div>',document.body.appendChild(h),d("#me_x",h).onclick=()=>h.remove(),d("#me_ok",h).onclick=async()=>{try{const x={id:I.id,name:d("#me_name",h).value,email:d("#me_email",h).value},A=d("#me_pass",h).value.trim();A&&(x.password=A),await X("/api/users",x),y("Profilo aggiornato"),h.remove(),location.reload()}catch(x){y("Errore aggiornamento profilo")}}})}const Te=document.createElement("div");Te.className="bp-coach-host",Te.style.cssText="position:fixed;left:50%;transform:translateX(-50%);z-index:1200;display:flex;flex-direction:column;gap:6px;pointer-events:none;",document.documentElement.appendChild(Te);const Ke="\n    /* Desktop default */\n    .bp-coach-host{ top:14px; }\n    /* Mobile: place below header + safe-area */\n    @media (max-width:980px){\n      .bp-coach-host{ top: calc(env(safe-area-inset-top) + 56px + 12px); }\n    }\n    .bp-coach{background:rgba(20,24,34,.92);color:#fff;border:1px solid rgba(255,255,255,.16);\n      border-radius:12px;padding:8px 10px;font-weight:700;box-shadow:0 12px 24px rgba(0,0,0,.35);opacity:.98;transform:translateY(0);transition:all .18s;}\n    @keyframes bpCoachPop{from{transform:translateY(-6px);opacity:0}to{transform:translateY(0);opacity:1}}\n  ",Ve=document.createElement("style");Ve.textContent=Ke,document.head.appendChild(Ve);try{window.BP=window.BP||{},window.BP.Coach=window.BP.Coach||{}}catch(k){}(function(){var k="bp-nncf-banner",w="bp_seen_nncf_appt";function I(){if(!document.getElementById("bp-nncf-css")){var D="\n      #".concat(k,"{\n        position: fixed; left: 16px; right:16px; bottom: 16px; z-index: 9999;\n        background: var(--card, rgba(15,18,28,.96));\n        border: 1px solid var(--hair2, rgba(255,255,255,.12));\n        border-radius: 14px; box-shadow: 0 8px 28px rgba(0,0,0,.35);\n        padding: 12px; display:flex; align-items:center; gap:12px; backdrop-filter: blur(6px);\n      }\n      #").concat(k," .msg{ flex:1; }\n      #").concat(k," .row{ display:flex; gap:8px; align-items:center; }\n      #").concat(k," .ghost{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.18); }\n      @media (prefers-color-scheme: light){\n        #").concat(k,"{ background:#fff; border-color: rgba(0,0,0,.12); }\n        #").concat(k," .ghost{ background:rgba(0,0,0,.04); border-color: rgba(0,0,0,.12); }\n      }\n    "),U=document.createElement("style");U.id="bp-nncf-css",U.textContent=D,document.head.appendChild(U)}}function h(D,U){return D?(D=String(D).trim().toLowerCase(),M("/api/clients").then(function(H){var Y=H&&H.clients||[],rt=Y.find(function(m){return String(m.name||"").trim().toLowerCase()===D});if(!rt)throw new Error("Cliente non trovato: "+D);return X("/api/clients",{id:rt.id,status:U})})):Promise.reject(new Error("Nome cliente mancante"))}function x(D){if(document.getElementById(k))return;I();var U=D.client||"Cliente",H=document.createElement("div");H.id=k,H.innerHTML='<div class="msg"><b> diventato cliente?</b> '+n(U)+'</div><div class="row"><button class="ghost" id="bp_nncf_yes">S</button><button class="ghost" id="bp_nncf_notyet">Non ancora</button><button id="bp_nncf_close">Chiudi</button></div>',document.body.appendChild(H);function Y(){try{localStorage.setItem(w,String(D.id||D.end||Date.now()))}catch(m){}}function rt(){try{H.remove()}catch(m){}}document.getElementById("bp_nncf_yes").onclick=function(){h(U,"cliente").then(function(){y("Stato cliente aggiornato")}).catch(function(){y("Impossibile aggiornare lo stato")}).finally(function(){Y(),rt()})},document.getElementById("bp_nncf_notyet").onclick=function(){h(U,"prospect").catch(function(){}).finally(function(){Y(),rt()})},document.getElementById("bp_nncf_close").onclick=function(){Y(),rt()}}function A(){var D=localStorage.getItem(w)||"";return M("/api/appointments").then(function(U){var H=Date.now(),Y=U&&U.appointments||[],rt=Y.filter(function(S){if(!S||!S.nncf)return!1;var C=+new Date(S.end||S.start||0);return C&&C<H-60*1e3}).sort(function(S,C){return+new Date(C.end||C.start||0)-+new Date(S.end||S.start||0)});if(rt.length){var m=rt[0],g=String(m.id||m.end||"");g&&D&&String(D)===g||x(m)}}).catch(function(U){})}var O=window.BPFinal=window.BPFinal||{};O.injectBannerCSS=I,O.updateClientStatusByName=h,O.scanNNCF=A,window.scanNNCF||(window.scanNNCF=A)})(),(function(){window.showUndo=window.showUndo||function(k,w,I){try{var h=document.getElementById("bp_undo_bar");h||(h=document.createElement("div"),h.id="bp_undo_bar",h.style.position="fixed",h.style.left="16px",h.style.bottom="16px",h.style.zIndex="9999",h.style.background="rgba(20,22,28,0.95)",h.style.color="#fff",h.style.padding="10px 12px",h.style.borderRadius="10px",h.style.boxShadow="0 8px 24px rgba(0,0,0,.25)",h.style.display="flex",h.style.alignItems="center",h.style.gap="12px",document.body.appendChild(h)),h.innerHTML="<span>"+k+'</span><button id="bp_undo_btn" class="ghost" style="background:#fff;color:#111;border-radius:8px;padding:6px 10px">Annulla</button>';var x=document.getElementById("bp_undo_btn"),A=setTimeout(function(){try{h.remove()}catch(O){}},I||5e3);x.onclick=function(){clearTimeout(A);try{h.remove()}catch(O){}typeof w=="function"&&Promise.resolve(w()).then(function(){ce("medium");try{document.dispatchEvent(new Event("undo:performed"))}catch(O){}}).catch(function(){ce("heavy")})},ce("light")}catch(O){logger.error(O)}},window.pushUndo=window.pushUndo||function(k){if(!(!k||typeof k.undo!="function")){var w=k.label||"Annulla ultima operazione";window.showUndo(w,k.undo,k.ttl||5e3)}},window.wireCoachUndoHaptics=function(){function k(){try{window.__periodsCache&&Object.keys(window.__periodsCache).forEach(function(I){delete window.__periodsCache[I]}),delete window.periods}catch(I){}}document.addEventListener("bp:saved",function(){ce("heavy"),k()}),document.addEventListener("bp:deleted",function(){ce("medium"),k()}),document.addEventListener("appt:saved",function(){ce("medium")}),document.addEventListener("ics:exported",function(){ce("light")}),document.addEventListener("report:composed",function(){ce("medium")}),document.addEventListener("client:converted",function(){ce("heavy")}),document.addEventListener("gi:created",function(){ce("heavy")}),document.addEventListener("payments:defined",function(){ce("medium")}),document.addEventListener("user:profile-updated",function(){ce("light")}),document.addEventListener("appt:created",function(){ce("medium")}),document.addEventListener("undo:performed",function(){ce("light")}),document.addEventListener("kpi:goal-80",function(){ce("medium")}),document.addEventListener("kpi:goal-reached",function(){ce("heavy")}),document.addEventListener("click",function(I){try{for(var h=I.target,x=0;x<3&&h;x++){if(h.matches&&(h.matches('[data-close], [aria-label*="Chiudi" i], [aria-label*="Close" i]')||(h.id||"").toLowerCase().includes("close")||(h.className||"").toLowerCase().includes("close")||/^\s*(chiudi|close)\s*$/i.test(h.textContent||""))){ce("light");break}h=h.parentElement}}catch(A){}},!0);var w=document.getElementById("app")||document.body;w&&!w.__undoWired&&(w.__undoWired=!0,w.addEventListener("click",function(I){var h=I.target.closest("[data-delete], .btn-delete");if(h){var x=h.getAttribute("href"),A=h.getAttribute("data-id");(x||A)&&(I.preventDefault(),showUndo("Eliminato  Annulla",async function(){try{if(x){var O=x+(x.indexOf("?")>=0?"&":"?")+"undo=1";await M(O)}else A&&await X("/api/restore",{id:A});location.reload()}catch(D){logger.error(D)}}))}},!0))},window.wireHapticsUI=function(){var k=document.body;if(!k.__hapticsWired){k.__hapticsWired=!0,k.addEventListener("click",function(I){var h=I.target.closest('button, .button, .btn, .ghost, [role="button"], a.button, a.btn, [data-action]');if(h){var x="light";h.classList.contains("danger")||h.getAttribute("data-danger")==="1"?x="heavy":(h.classList.contains("primary")||h.getAttribute("data-primary")==="1")&&(x="medium"),ce(x)}},!0),k.addEventListener("change",function(I){var h=I.target;h&&h.matches('select, input[type="checkbox"], input[type="radio"], input[type="range"]')&&ce("light")},!0);var w=document.querySelector("[data-drawer-toggle], #menuToggle, .menu-toggle");w&&!w.__hW&&(w.__hW=!0,w.addEventListener("click",function(){ce("light")},!0))}}})(),window.recomputeDashboardMini=typeof Vt=="function"?Vt:()=>{},window.recomputeCommsMini=typeof Mt=="function"?Mt:()=>{},window.recomputeTeamChart=typeof $t=="function"?$t:()=>{},window.ensureTeamUserSelect=typeof Se=="function"?Se:()=>{},window.attachICSButtons=typeof attachICSButtons=="function"?attachICSButtons:()=>{},window.addSaveAndExport=typeof addSaveAndExport=="function"?addSaveAndExport:()=>{},window.BPFinal=window.BPFinal||{},(function(k){function w(I,h){typeof h=="function"&&(k[I]=h,window[I]||(window[I]=h))}typeof Vt<"u"&&w("recomputeDashboardMini",Vt),typeof Mt<"u"&&w("recomputeCommsMini",Mt),typeof $t<"u"&&w("recomputeTeamChart",$t),typeof viewGI<"u"&&w("viewGI",viewGI),typeof Se<"u"&&w("ensureTeamUserSelect",Se),typeof attachICSButtons<"u"&&w("attachICSButtons",attachICSButtons),typeof addSaveAndExport<"u"&&w("addSaveAndExport",addSaveAndExport),typeof ensureClientFilters<"u"&&w("ensureClientFilters",ensureClientFilters),typeof enrichClientCards<"u"&&w("enrichClientCards",enrichClientCards),typeof re<"u"&&w("showClientAppointments",re),typeof wireReportButtons<"u"&&w("wireReportButtons",wireReportButtons),typeof scanNNCF<"u"&&w("scanNNCF",scanNNCF),typeof ensureNNCFChip<"u"&&w("ensureNNCFChip",ensureNNCFChip),typeof Zt<"u"&&w("markToday",Zt),typeof ae<"u"&&w("clampSlotCounters",ae),typeof filterPastAppointments<"u"&&w("filterPastAppointments",filterPastAppointments),typeof openWeb<"u"&&w("openWeb",openWeb),typeof openApp<"u"&&w("openApp",openApp),typeof notifyConversion<"u"&&w("notifyConversion",notifyConversion),typeof icsFromAppt<"u"&&w("icsFromAppt",icsFromAppt),typeof downloadICS<"u"&&w("downloadICS",downloadICS),typeof M<"u"&&w("GET",M),typeof X<"u"&&w("POST",X)})(window.BPFinal);const Je=new MutationObserver(()=>{typeof ensureNNCFChip=="function"&&ensureNNCFChip(),typeof addSaveAndExport=="function"&&addSaveAndExport(),typeof attachICSButtons=="function"&&attachICSButtons(),typeof wireReportButtons=="function"&&wireReportButtons(),typeof ensureClientFilters=="function"&&ensureClientFilters(),typeof enrichClientCards=="function"&&enrichClientCards(),typeof Se=="function"&&Se(),typeof We=="function"&&We(),typeof filterPastAppointments=="function"&&filterPastAppointments(document.body),typeof Zt=="function"&&Zt()});p(async()=>{typeof injectTodayCSS=="function"&&injectTodayCSS(),typeof Zt=="function"&&Zt(),typeof ae=="function"&&ae(),typeof Kt=="function"&&Kt(),typeof Vt=="function"&&await Vt(),typeof Mt=="function"&&await Mt(),typeof $t=="function"&&await $t(),typeof wireHapticsUI=="function"&&wireHapticsUI(),typeof wireCoachUndoHaptics=="function"&&wireCoachUndoHaptics();try{const k="bpCoachGreetedDate",w=new Date().toISOString().slice(0,10);(localStorage.getItem(k)||"")!==w&&typeof window.BP<"u"&&window.BP.Coach&&typeof window.BP.Coach.say=="function"&&(localStorage.setItem(k,w),window.BP.Coach.say("generic",{intensity:"low"}))}catch(k){}Je.observe(document.body,{childList:!0,subtree:!0}),window.onUnifiedRangeChange&&window.onUnifiedRangeChange(k=>{const w=k==="d"?"dash":k==="cm"?"comm":k==="tg"?"t":k;w==="dash"&&typeof Vt=="function"&&(Vt(),typeof renderDashboard=="function"&&renderDashboard()),w==="comm"&&typeof Mt=="function"&&Mt(),(w==="t"||w==="team")&&typeof $t=="function"&&$t()})})})();(function(){const n=window.BP=window.BP||{},t=n.ICS=n.ICS||{};function e(l){if(!l)return"";if(/[Zz]|[+\-]\d{2}:\d{2}$/.test(String(l)))return new Date(l).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z").slice(0,15)+"Z";const[c,d="00:00"]=String(l).split("T"),[u,p,f]=c.split("-").map(Number),[b,v]=d.split(":").map(Number);return new Date(u,p-1,f,b,v,0,0).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z").slice(0,15)+"Z"}function i(l){return(l||"").replace(/\\/g,"\\\\").replace(/;/g,"\\;").replace(/,/g,"\\,").replace(/\n/g,"\\n")}function o(l){if(l.length<=74)return[l];const d=[];let u=0;for(;u<l.length;){const p=l.slice(u,u+74);d.push(u===0?p:" "+p),u+=74}return d}function a(l){const c=(l&&l.id||"bp-"+Date.now())+"@bpapp",d=l&&l.client?"Appuntamento  "+l.client:"Appuntamento",u=e(l&&l.start),p=e(l&&l.end),f=e(new Date().toISOString().slice(0,16)),b=[];l&&l.type&&b.push("Tipo: "+l.type),l&&l.vss&&b.push("VSS: "+l.vss),l&&l.vsdPersonal&&b.push("VSD Personale: "+l.vsdPersonal),l&&l.notes&&b.push("Note: "+l.notes);const v=i(b.join("\n")),y=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//BPApp//Calendario//IT","CALSCALE:GREGORIAN","METHOD:PUBLISH","BEGIN:VEVENT","UID:"+c,"DTSTAMP:"+f,u?"DTSTART:"+u:"",p?"DTEND:"+p:"","SUMMARY:"+i(d),v?"DESCRIPTION:"+v:"","END:VEVENT","END:VCALENDAR"].filter(Boolean),E=[];return y.forEach(M=>E.push.apply(E,o(M))),E.join("\r\n")}function s(){try{const l=navigator.userAgent||navigator.vendor||"",c=/iP(ad|hone|od)/.test(l),d=/^((?!chrome|android|crios|fxios|edgi).)*safari/i.test(l);return c||d}catch(l){return!1}}function r(l){try{const c=a(l),d=l&&l.start?String(l.start).split("T")[0]:"evento",u=(l&&l.client||"appuntamento").trim().replace(/[^\w\-]+/g,"_").slice(0,40),p="bp_".concat(u,"_").concat(d,".ics");if(s())try{const v="data:text/calendar;charset=utf-8,"+encodeURIComponent(c),y=document.createElement("a");return y.href=v,y.setAttribute("target","_blank"),y.setAttribute("download",p),document.body.appendChild(y),y.click(),y.remove(),!0}catch(v){try{return window.location.assign("data:text/calendar;charset=utf-8,"+encodeURIComponent(c)),!0}catch(y){try{logger.error(y)}catch(E){}return!1}}const f=new Blob([c],{type:"text/calendar;charset=utf-8"}),b=document.createElement("a");return b.href=URL.createObjectURL(f),b.download=p,document.body.appendChild(b),b.click(),setTimeout(()=>{try{URL.revokeObjectURL(b.href)}catch(v){}b.remove()},50),!0}catch(c){try{logger.error(c)}catch(d){}return!1}}t.makeIcsForAppointment=a,t.downloadIcsForAppointment=r,window.icsFromAppt=window.icsFromAppt||function(l){return a(l)},window.downloadICS=window.downloadICS||function(l,c){try{var d=window.__icsSanitize?__icsSanitize(l):l||"evento";/\.ics$/i.test(d)||(d+=".ics");var u=new Blob([c],{type:"text/calendar;charset=utf-8"}),p=document.createElement("a");p.href=URL.createObjectURL(u),p.download=d,document.body.appendChild(p),p.click(),setTimeout(function(){URL.revokeObjectURL(p.href),p.remove()},50)}catch(f){logger.error(f)}}})();(function(){if(!window.GET)return;const n=window.GET;window.GET=function(t){try{if(typeof t=="string"&&t.indexOf("/api/leaderboard")===0){if(!(t.indexOf("/api/leaderboard_overall")===0)&&t.indexOf("indicator=")===-1)return Promise.resolve({ranking:[]});if(window.readUnifiedRange){var e=window.readUnifiedRange("lb")||{},i=e.type==="ytd"||e.type==="ltm"?"mensile":e.type;i&&(t+=(t.includes("?")?"&":"?")+"type="+encodeURIComponent(i))}var o=document.getElementById("lb_mode"),a=o?o.value:"consuntivo";t+=(t.includes("?")?"&":"?")+"mode="+encodeURIComponent(a)}}catch(s){}return n.apply(this,arguments)}})();(function(){if(!("serviceWorker"in navigator)||!("PushManager"in window))return;function n(){try{const a=JSON.parse(localStorage.getItem("bp_user")||"null")||{};if(a.token)return a.token}catch(a){}return localStorage.getItem("bp_token")||localStorage.getItem("authToken")||localStorage.getItem("token")||""}function t(a){const s="=".repeat((4-a.length%4)%4),r=(a+s).replace(/-/g,"+").replace(/_/g,"/"),l=atob(r),c=new Uint8Array(l.length);for(let d=0;d<l.length;d++)c[d]=l.charCodeAt(d);return c}async function e(a){const s=n();if(s)try{await fetch("/api/push/subscribe",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+s},body:JSON.stringify(a)})}catch(r){logger.warn("[BP] push subscribe error",r)}}async function i(){try{console.log("[BP] Starting subscription process...");const a=await navigator.serviceWorker.ready;console.log("[BP] Service Worker ready");let s=await a.pushManager.getSubscription();if(console.log("[BP] Existing subscription:",!!s),!s){console.log("[BP] No existing subscription, creating new one...");const l=await(await fetch("/api/push/publicKey")).json(),c=l.publicKey||l.key||"";if(console.log("[BP] Public key received:",!!c),!c){console.error("[BP] No public key received from server");return}s=await a.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:t(c)}),console.log("[BP] New subscription created")}console.log("[BP] Sending subscription to server..."),await e(s.toJSON()),console.log("[BP] Subscription sent successfully")}catch(a){console.error("[BP] Push subscribe failed:",a),logger.warn("[BP] push subscribe fail",a)}}async function o(){if(console.log("[BP] Push client initializing..."),console.log("[BP] Notification permission:",Notification.permission),Notification.permission==="granted")return console.log("[BP] Permission already granted, subscribing..."),i();if(Notification.permission==="default"){console.log("[BP] Requesting notification permission...");try{const a=await Notification.requestPermission();if(console.log("[BP] Permission result:",a),a==="granted")return console.log("[BP] Permission granted, subscribing..."),i();console.warn("[BP] Notification permission denied")}catch(a){console.error("[BP] Error requesting permission:",a)}}else console.warn("[BP] Notification permission denied by user")}window.BPPush={init:o,subscribe:i},window.addEventListener("load",o)})();function Sa(n){if(!n)return new Date(NaN);const t=new Date(n);return isNaN(t)?new Date(NaN):t}function qr(n){if(!(n instanceof Date)||isNaN(n))return"";const t=r=>(r<10?"0":"")+r,e=t(n.getDate()),i=t(n.getMonth()+1),o=n.getFullYear(),a=t(n.getHours()),s=t(n.getMinutes());return"".concat(e,"/").concat(i,"/").concat(o," ").concat(a,":").concat(s)}function Gr(n){if(!(n instanceof Date)||isNaN(n))return"";const t=r=>(r<10?"0":"")+r,e=n.getFullYear(),i=t(n.getMonth()+1),o=t(n.getDate()),a=t(n.getHours()),s=t(n.getMinutes());return"".concat(e,"-").concat(i,"-").concat(o,"T").concat(a,":").concat(s)}function Xr(n){if(!n)return new Date(NaN);const t=String(n).trim(),[e,i="00:00"]=t.split("T"),[o,a,s]=e.split("-").map(Number),[r,l]=i.split(":").map(Number);if(!o||!a||!s||r===void 0||l===void 0)return new Date(NaN);const c=new Date(o,a-1,s,r,l,0,0);return isNaN(c)?new Date(NaN):c}function Kr(n){if(!(n instanceof Date)||isNaN(n))return"";const t=a=>(a<10?"0":"")+a,e=n.getFullYear(),i=t(n.getMonth()+1),o=t(n.getDate());return"".concat(e,"-").concat(i,"-").concat(o)}function Jr(n){if(!(n instanceof Date)||isNaN(n))return"";const t=o=>(o<10?"0":"")+o,e=t(n.getHours()),i=t(n.getMinutes());return"".concat(e,":").concat(i)}function Zr(n,t){return!(n instanceof Date)||!(t instanceof Date)||isNaN(n)||isNaN(t)?0:Math.max(0,Math.round((t.getTime()-n.getTime())/6e4))}function Qr(n,t){return!(n instanceof Date)||isNaN(n)||!isFinite(t)?new Date(NaN):new Date(n.getTime()+t*6e4)}function tl(n){if(!isFinite(n)||n<0)return"0m";const t=Math.floor(n/60),e=n%60;return t===0?"".concat(e,"m"):e===0?"".concat(t,"h"):"".concat(t,"h ").concat(e,"m")}function el(n){if(!(n instanceof Date)||isNaN(n))return"";const t=l=>(l<10?"0":"")+l,e=n.getUTCFullYear(),i=t(n.getUTCMonth()+1),o=t(n.getUTCDate()),a=t(n.getUTCHours()),s=t(n.getUTCMinutes()),r=t(n.getUTCSeconds());return"".concat(e).concat(i).concat(o,"T").concat(a).concat(s).concat(r,"Z")}function nl(n){if(!(n instanceof Date)||isNaN(n))return"";const t=a=>(a<10?"0":"")+a,e=n.getUTCFullYear(),i=t(n.getUTCMonth()+1),o=t(n.getUTCDate());return"".concat(e,"-").concat(i,"-").concat(o)}function il(n){const t=Sa(n);return!isNaN(t)}typeof module<"u"&&module.exports&&(module.exports={parseUTCString:Sa,toLocalDisplay:qr,toLocalInputValue:Gr,fromLocalInputValue:Xr,ymdLocal:Kr,ymdUTC:nl,timeHMLocal:Jr,minutesBetween:Zr,addMinutes:Qr,formatDuration:tl,toICSUTC:el,isValidDateTime:il});typeof window<"u"&&(window.BPTimezone={parseUTCString:Sa,toLocalDisplay:qr,toLocalInputValue:Gr,fromLocalInputValue:Xr,ymdLocal:Kr,ymdUTC:nl,timeHMLocal:Jr,minutesBetween:Zr,addMinutes:Qr,formatDuration:tl,toICSUTC:el,isValidDateTime:il});let on;function yf(){return on||(on=document.getElementById("toast-container"),on||(on=document.createElement("div"),on.id="toast-container",on.setAttribute("role","status"),on.setAttribute("aria-live","polite"),document.body.appendChild(on))),on}function xf(){if(sessionStorage.getItem("a2hs-dismissed")==="1")return;const n=navigator.userAgent||navigator.vendor||"",t=/android|iphone|ipad|ipod|mobile/i.test(n),e=window.matchMedia&&window.matchMedia("(display-mode: standalone)").matches;if(!t||e)return;const i=yf(),o=document.createElement("div");o.className="toast",o.style.display="flex",o.style.alignItems="center",o.style.gap="8px";const a=document.createElement("span");a.textContent="Aggiungi questa pagina alla schermata Home per avere la tua app";const s=document.createElement("span");s.textContent="",s.setAttribute("role","button"),s.setAttribute("aria-label","Chiudi"),s.style.cursor="pointer",s.style.fontWeight="700",s.addEventListener("click",()=>{o.remove(),i.children.length||(i.remove(),on=null),sessionStorage.setItem("a2hs-dismissed","1")}),o.appendChild(a),o.appendChild(s),i.appendChild(o)}let an;function wf(){return an||(an=document.getElementById("toast-container"),an||(an=document.createElement("div"),an.id="toast-container",an.setAttribute("role","status"),an.setAttribute("aria-live","polite"),document.body.appendChild(an))),an}function Nt(n){const t=wf(),e=document.createElement("div");e.className="toast",e.setAttribute("role","alert"),e.textContent=n,t.appendChild(e),setTimeout(function(){try{e.remove(),t.children.length||(t.remove(),an=null)}catch(i){}},2200)}function Gi(){if(window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches)return;const n=document.createElement("div");n.className="confetti",document.body.appendChild(n);for(let t=0;t<26;t++){const e=document.createElement("span");e.style.position="absolute",e.style.left=2+t*4+"%",e.style.top="0",e.style.width="6px",e.style.height="10px",e.style.background="hsl("+t*14+",90%,60%)",e.style.opacity="0.95",n.appendChild(e),(function(i,o){setTimeout(function(){i.animate&&i.animate([{transform:"translateY(-20px) rotate(0deg)"},{transform:"translateY(110vh) rotate(540deg)"}],{duration:1200+Math.random()*800,easing:"cubic-bezier(.2,.6,.2,1)"})},o)})(e,t*35)}setTimeout(function(){try{n.remove()}catch(t){}},2500)}function Xn(n,t){localStorage.setItem(n,typeof t=="string"?t:JSON.stringify(t))}function sa(n,t){const e=localStorage.getItem(n);if(e==null)return t;try{return JSON.parse(e)}catch(i){return e}}function vo(n){localStorage.removeItem(n)}function _f(n,t){t?Xn("bp_token",n):sessionStorage.setItem("bp_token",n)}function ro(){return localStorage.getItem("bp_token")||sessionStorage.getItem("bp_token")||""}function Sf(n){Xn("bp_user",n)}function Jt(){return sa("bp_user",null)||null}function kf(){vo("bp_token"),sessionStorage.removeItem("bp_token"),vo("bp_user"),location.href="/?v=13"}function Cf(){if(document.getElementById("bp-mobile-drawer-fix"))return;const n="\n  @media (max-width:980px){\n    .topbar{\n      background: rgba(20,24,34,.90) !important;\n      border-bottom: 1px solid rgba(255,255,255,.08) !important;\n      z-index: 70 !important; /* Assicura che la topbar sia sopra il drawer */\n    }\n    .drawer{\n      background: rgba(20,24,34,.96) !important;\n      box-shadow: 14px 0 28px rgba(0,0,0,.45) !important;\n      width: 86vw !important;\n      overflow-y: auto !important;\n    }\n    .drawer .row{ gap:10px !important; }\n    .drawer button{\n      background: rgba(255,255,255,.10) !important;\n      border: 1px solid rgba(255,255,255,.22) !important;\n      color: #fff !important;\n      padding: 12px 14px !important;\n      font-weight: 700 !important;\n      border-radius: 12px !important;\n      -webkit-tap-highlight-color: transparent;\n    }\n    .drawer button:hover{\n      background: rgba(255,255,255,.14) !important;\n      border-color: rgba(255,255,255,.30) !important;\n    }\n    .drawer button.ghost{\n      background: rgba(255,255,255,.10) !important;\n      box-shadow: none !important;\n    }\n    .hamb{\n      z-index: 80 !important; /* Assicura che l'hamburger sia sempre cliccabile */\n      position: relative !important;\n    }\n  }",t=document.createElement("style");t.id="bp-mobile-drawer-fix",t.textContent=n,document.head.appendChild(t)}function Ef(){if(document.getElementById("bp-mobile-light-fix"))return;const n="\n    @media (max-width:980px) and (prefers-color-scheme: light){\n      .topbar{\n        background:#fff !important;\n        border-bottom:1px solid rgba(0,0,0,.08) !important;\n        box-shadow:none !important;\n      }\n      .topbar .brand .logo{\n        color:#0f172a !important;\n        font-weight:900 !important;\n        letter-spacing:.4px;\n        text-shadow:none !important;\n        opacity:1 !important;\n      }\n      .topbar .hamb span{ background:#0f172a !important; }\n      .card{\n        background:#fff !important;\n        background-image:none !important;\n        box-shadow:none !important;\n      }\n      .drawer{\n        background:#fff !important;\n        box-shadow:14px 0 28px rgba(0,0,0,.10) !important;\n      }\n      .drawer button{\n        color:#0f172a !important;\n        background:rgba(0,0,0,.04) !important;\n        border:1px solid rgba(0,0,0,.12) !important;\n      }\n      .drawer button:hover{\n        background:rgba(0,0,0,.08) !important;\n      }\n    }\n  ",t=document.createElement("style");t.id="bp-mobile-light-fix",t.textContent=n,document.head.appendChild(t)}function If(){if(document.getElementById("bp-badge-light-css"))return;const n="\n    @media (prefers-color-scheme: light){\n      .badge{\n        background: linear-gradient(180deg, #eef2ff, #f8fafc) !important;\n        border: 1px solid #c7d2fe !important;\n        color: #0f172a !important;\n        font-weight: 700 !important;\n        padding: 6px 10px !important;\n        border-radius: 9999px !important;\n        letter-spacing: .2px !important;\n        box-shadow: 0 1px 0 rgba(15,23,42,.05) inset !important;\n      }\n      .chip, .tag{\n        background: #ffffff !important;\n        border: 1px solid #cbd5e1 !important;\n        color: #0f172a !important;\n        font-weight: 600 !important;\n        border-radius: 9999px !important;\n      }\n      .card .badge{\n        background: #fff !important;\n      }\n    }\n  ",t=document.createElement("style");t.id="bp-badge-light-css",t.textContent=n,document.head.appendChild(t)}function Df(){if(document.getElementById("bp-summary-css"))return;const n="\n    summary{ cursor:pointer; padding:4px 0; }\n  ",t=document.createElement("style");t.id="bp-summary-css",t.textContent=n,document.head.appendChild(t)}function $e(){const n=Jt();if(!n)return"";const t=n.role==="admin",e='<div id="drawer" class="drawer" role="dialog" aria-modal="true" aria-label="Menu"><div class="row"><button class="ghost" onclick="viewHome();toggleDrawer(false)">Dashboard</button><button class="ghost" onclick="viewCalendar();toggleDrawer(false)">Calendario</button><button class="ghost" onclick="viewPeriods();toggleDrawer(false)">BP</button><button class="ghost" onclick="viewAppointments();toggleDrawer(false)">Appuntamenti</button><button class="ghost" onclick="viewLeaderboard();toggleDrawer(false)">Classifiche</button><button class="ghost" onclick="viewCommissions();toggleDrawer(false)">Provvigioni</button><button class="ghost" onclick="viewVendite();toggleDrawer(false)">Vendite e Riordini</button><button class="ghost" onclick="viewGI();toggleDrawer(false)">GI &amp; Scadenzario</button><button class="ghost" onclick="viewReport();toggleDrawer(false)">Report</button><button class="ghost" onclick="viewClients();toggleDrawer(false)">Clienti</button><button class="ghost" onclick="viewTeam();toggleDrawer(false)">Squadra</button>'+(t?'<button class="ghost" onclick="viewUsers();toggleDrawer(false)">Utenti</button>':"")+(t?'<button class="ghost" onclick="viewSettings();toggleDrawer(false)">Impostazioni</button>':"")+'<button onclick="logout()">Logout</button></div></div>',i=[{icon:"",text:"Dashboard",onclick:"viewHome()"},{icon:"",text:"Calendario",onclick:"viewCalendar()"},{icon:"",text:"BP",onclick:"viewPeriods()"},{icon:"",text:"Appuntamenti",onclick:"viewAppointments()"},{icon:"",text:"Classifiche",onclick:"viewLeaderboard()"},{icon:"",text:"Provvigioni",onclick:"viewCommissions()"},{icon:"",text:"Vendite e Riordini",onclick:"viewVendite()"},{icon:"",text:"GI & Scadenzario",onclick:"viewGI()"},{icon:"",text:"Report",onclick:"viewReport()"},{icon:"",text:"Clienti",onclick:"viewClients()"},{icon:"",text:"Squadra",onclick:"viewTeam()"}];t&&(i.push({icon:"",text:"Utenti",onclick:"viewUsers()"}),i.push({icon:"",text:"Impostazioni",onclick:"viewSettings()"}));const o='\n    <div id="sidebar" class="sidebar">\n      <div class="sidebar-header">\n        <div class="sidebar-logo">BATTLE PLAN</div>\n        <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Comprimi/Espandi sidebar">\n          <span class="sidebar-toggle-icon"></span>\n        </button>\n      </div>\n      <div class="sidebar-logo-container">\n        <img src="/logo-azienda.jpg" alt="Logo Azienda" class="company-logo">\n      </div>\n      <nav class="sidebar-nav">\n        '.concat(i.map(s=>'\n          <button class="sidebar-item" onclick="'.concat(s.onclick,'" title="').concat(s.text,'">\n            <span class="sidebar-icon">').concat(s.icon,'</span>\n            <span class="sidebar-text">').concat(s.text,"</span>\n          </button>\n        ")).join(""),'\n        <button class="sidebar-item sidebar-logout" onclick="logout()" title="Logout">\n          <span class="sidebar-icon"></span>\n          <span class="sidebar-text">Logout</span>\n        </button>\n      </nav>\n    </div>\n  '),a='<div class="topbar"><div class="brand"><button class="hamb" id="hamb" aria-label="Apri menu" aria-controls="drawer" aria-expanded="false"><span></span><span></span><span></span></button><div class="logo">BATTLE PLAN</div></div><img src="/logo-azienda.jpg" alt="Logo Azienda" class="mobile-company-logo"><div class="nav right"><button class="ghost" onclick="viewHome()">Dashboard</button><button class="ghost" onclick="viewCalendar()">Calendario</button><button class="ghost" onclick="viewPeriods()">BP</button><button class="ghost" onclick="viewAppointments()">Appuntamenti</button><button class="ghost" onclick="viewLeaderboard()">Classifiche</button><button class="ghost" onclick="viewCommissions()">Provvigioni</button><button class="ghost" onclick="viewVendite()">Vendite e Riordini</button><button class="ghost" onclick="viewGI()">GI &amp; Scadenzario</button><button class="ghost" onclick="viewReport()">Report</button><button class="ghost" onclick="viewClients()">Clienti</button><button class="ghost" onclick="viewTeam()">Squadra</button>'+(t?'<button class="ghost" onclick="viewUsers()">Utenti</button>':"")+(t?'<button class="ghost" onclick="viewSettings()">Impostazioni</button>':"")+'<button onclick="logout()">Logout</button></div></div>';return o+a+e}function Tf(){if(document.getElementById("company-logo-css"))return;document.head.insertAdjacentHTML("beforeend",'\n    <style id="company-logo-css">\n      /* Logo aziendale nella sidebar desktop */\n      .sidebar-logo-container {\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        padding: 15px 10px;\n        margin-bottom: 10px;\n      }\n      \n      .company-logo {\n        width: 100%;\n        max-width: 200px;\n        max-height: 80px;\n        height: auto;\n        object-fit: contain;\n        border-radius: 8px;\n        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\n      }\n      \n      /* Logo aziendale nella topbar mobile */\n      .mobile-company-logo {\n        max-width: 40px;\n        max-height: 30px;\n        width: auto;\n        height: auto;\n        object-fit: contain;\n        margin-left: auto;\n        border-radius: 4px;\n        display: none; /* Nascosto di default */\n      }\n      \n      /* Responsive adjustments */\n      @media (max-width: 768px) {\n        .sidebar-logo-container {\n          display: none; /* Nascondi nella sidebar mobile */\n        }\n        \n        .mobile-company-logo {\n          display: block !important;\n        }\n      }\n      \n      @media (min-width: 769px) {\n        .mobile-company-logo {\n          display: none; /* Nascondi nella topbar desktop */\n        }\n        \n        .sidebar-logo-container {\n          display: flex;\n        }\n      }\n    </style>\n  ')}function Oe(){if(!Jt())return;if(Tf(),!document.getElementById("bp_sidebar_css")){const s="\n      /* Sidebar per desktop */\n      @media (min-width: 1024px) {\n        .sidebar {\n          position: fixed;\n          left: 0;\n          top: 0;\n          height: 100vh;\n          width: 280px;\n          background: var(--card);\n          border-right: 1px solid var(--hair2);\n          z-index: 1000;\n          transition: all 0.3s ease;\n          display: flex;\n          flex-direction: column;\n        }\n        \n        .sidebar.collapsed {\n          width: 80px;\n        }\n        \n        .sidebar-header {\n          padding: 20px;\n          border-bottom: 1px solid var(--hair2);\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n        }\n        \n        .sidebar-logo {\n          font-size: 18px;\n          font-weight: 800;\n          color: var(--text);\n          transition: opacity 0.3s ease;\n        }\n        \n        .sidebar.collapsed .sidebar-logo {\n          opacity: 0;\n        }\n        \n        .sidebar-toggle {\n          background: var(--card-soft);\n          border: 1px solid var(--hair2);\n          border-radius: 8px;\n          padding: 8px;\n          cursor: pointer;\n          transition: all 0.2s ease;\n          color: var(--text);\n        }\n        \n        .sidebar-toggle:hover {\n          background: var(--accent);\n          border-color: var(--accent);\n          color: #fff;\n        }\n        \n        .sidebar-toggle-icon {\n          transition: transform 0.3s ease;\n          font-size: 12px;\n        }\n        \n        .sidebar.collapsed .sidebar-toggle-icon {\n          transform: rotate(180deg);\n        }\n        \n        .sidebar-xp {\n          padding: 16px 20px;\n          border-bottom: 1px solid var(--hair2);\n          text-align: center;\n          transition: opacity 0.3s ease;\n        }\n        \n        .sidebar.collapsed .sidebar-xp {\n          opacity: 0;\n        }\n        \n        .sidebar-nav {\n          flex: 1;\n          padding: 16px 0;\n          overflow-y: auto;\n        }\n        \n        .sidebar-item {\n          width: 100%;\n          padding: 12px 20px;\n          background: transparent;\n          border: none;\n          color: var(--text);\n          cursor: pointer;\n          transition: all 0.2s ease;\n          display: flex;\n          align-items: center;\n          gap: 12px;\n          text-align: left;\n          font-size: 14px;\n          border-radius: 0;\n        }\n        \n        .sidebar-item:hover {\n          background: var(--accent);\n          color: #fff;\n        }\n        \n        .sidebar-item.active {\n          background: var(--accent);\n          color: #fff;\n          font-weight: 600;\n        }\n        \n        .sidebar-icon {\n          font-size: 18px;\n          width: 24px;\n          text-align: center;\n          flex-shrink: 0;\n        }\n        \n        .sidebar-text {\n          transition: opacity 0.3s ease;\n          white-space: nowrap;\n        }\n        \n        .sidebar.collapsed .sidebar-text {\n          opacity: 0;\n        }\n        \n        .sidebar-logout {\n          border-top: 1px solid var(--hair2);\n          margin-top: auto;\n          background: transparent;\n        }\n        \n        .sidebar-logout:hover {\n          background: var(--danger);\n          color: #fff;\n        }\n        \n        /* Nascondi topbar su desktop */\n        .topbar {\n          display: none;\n        }\n        \n        /* Aggiusta contenuto principale */\n        body.sidebar-expanded {\n          margin-left: 280px;\n          transition: margin-left 0.3s ease;\n        }\n        \n        body.sidebar-collapsed {\n          margin-left: 80px;\n          transition: margin-left 0.3s ease;\n        }\n      }\n      \n      /* Mobile: nascondi sidebar, mostra topbar */\n      @media (max-width: 1023px) {\n        .sidebar {\n          display: none;\n        }\n        \n        .topbar {\n          display: flex;\n        }\n        \n        body {\n          margin-left: 0;\n        }\n      }\n      \n      /* Contrasto topbar mobile */\n      @media (max-width: 1023px) {\n        .topbar .nav .ghost{\n          background: rgba(255,255,255,.06);\n          border: 1px solid rgba(255,255,255,.18);\n        }\n        .topbar .nav .ghost:hover{\n          background: rgba(255,255,255,.12);\n        }\n      }\n    ",r=document.createElement("style");r.id="bp_sidebar_css",r.textContent=s,document.head.appendChild(r)}const n=document.getElementById("app"),t=document.querySelector(".topbar"),e=$e();t?t.outerHTML=e:n&&n.insertAdjacentHTML("afterbegin",e);try{Cf()}catch(s){}try{Ef()}catch(s){}try{If()}catch(s){}try{Df()}catch(s){}if(!document.getElementById("bp-unified-filters-css")){const s="\n      /* Nested inputs align in two columns inside unified filters */\n      .uf .row .row{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }\n\n      @media (max-width: 980px){\n        .uf input, .uf select{ min-width: 0; width: 100%; }\n        .uf .row > div{ flex: 1 1 180px; min-width: 0; }\n\n        /* Squadra admin bar: grid on small screens */\n        #t_adminbar{ display:grid !important; grid-template-columns: 1fr 1fr; align-items:end; gap:10px; }\n        #t_adminbar > div{ min-width: 0; }\n        #t_adminbar .row{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }\n      }\n\n      @media (max-width: 560px){\n        #t_adminbar{ grid-template-columns: 1fr; }\n      }\n    ",r=document.createElement("style");r.id="bp-unified-filters-css",r.textContent=s,document.head.appendChild(r)}const i=document.getElementById("hamb");i&&(i.onclick=function(){bo()});const o=document.getElementById("drawer");o&&o.addEventListener("click",function(s){s.target.id==="drawer"&&bo(!1)});const a=document.getElementById("sidebar-toggle");a&&(a.onclick=function(){Pf()}),Af(),window.addEventListener("resize",()=>{if(window.innerWidth<1024)document.body.classList.remove("sidebar-expanded","sidebar-collapsed");else{const s=localStorage.getItem("bp_sidebar_collapsed")==="true";document.body.classList.remove("sidebar-expanded","sidebar-collapsed"),document.body.classList.add(s?"sidebar-collapsed":"sidebar-expanded")}}),document.removeEventListener("keydown",qs,!1),document.addEventListener("keydown",qs,!1)}function qs(n){if(n&&n.key==="Escape"){const t=document.getElementById("drawer");t&&t.classList.contains("open")&&bo(!1)}}function bo(n){const t=document.getElementById("drawer");if(!t)return;const e=typeof n=="boolean"?n:!t.classList.contains("open");t.classList.toggle("open",e);const i=document.getElementById("hamb");i&&i.setAttribute("aria-expanded",String(e)),document.body.classList.toggle("no-scroll",e)}let Gs=null;function Mf(){clearTimeout(Gs),Gs=setTimeout(Oe,60)}function Pf(n){const t=document.getElementById("sidebar");if(!t)return;const e=!t.classList.contains("collapsed");t.classList.toggle("collapsed",e),window.innerWidth>=1024?(document.body.classList.remove("sidebar-expanded","sidebar-collapsed"),document.body.classList.add(e?"sidebar-collapsed":"sidebar-expanded")):document.body.classList.remove("sidebar-expanded","sidebar-collapsed");try{localStorage.setItem("bp_sidebar_collapsed",String(e))}catch(i){}}function Af(){try{const n=localStorage.getItem("bp_sidebar_collapsed")==="true",t=document.getElementById("sidebar");t&&(t.classList.toggle("collapsed",n),window.innerWidth>=1024?(document.body.classList.remove("sidebar-expanded","sidebar-collapsed"),document.body.classList.add(n?"sidebar-collapsed":"sidebar-expanded")):document.body.classList.remove("sidebar-expanded","sidebar-collapsed"))}catch(n){}}function Ge(n){const t=document.getElementById("sidebar");if(!t)return;t.querySelectorAll(".sidebar-item").forEach(i=>{i.classList.remove("active")});const e=t.querySelector('[onclick*="'.concat(n,'"]'));e&&e.classList.add("active")}function Be(n){const t=Number(n)||0;return String(Math.round(t))}function ka(n,t={}){t.method=t.method||"GET";const e={...t.headers||{}},i=ro();return i&&(e.Authorization="Bearer "+i),t.body!=null&&typeof t.body!="string"&&(e["Content-Type"]="application/json; charset=utf-8",t.body=JSON.stringify(t.body)),t.headers=e,fetch(n,t).then(Bf)}async function Bf(n){const t=await n.text();if(!n.ok)throw Lf(t,n);return Of(t,n)}function Lf(n,t){try{const e=JSON.parse(n).error||"";return new Error(e||t.statusText||"HTTP "+t.status)}catch(e){return new Error(t.statusText||"HTTP "+t.status)}}function Of(n,t){try{if((t.headers.get("content-type")||"").toLowerCase().indexOf("application/json")!==-1)return n?JSON.parse(n):{}}catch(e){}return n}function qt(n,t){return ka(n,Object.assign({method:"GET"},{}))}function Le(n,t){return ka(n,{method:"POST",body:t||{}})}function Nf(n){return ka(n,{method:"DELETE"})}function rn(n){return(n<10?"0":"")+n}function Ie(n){const t=new Date(n);return t.getFullYear()+"-"+rn(t.getMonth()+1)+"-"+rn(t.getDate())}function Xs(n){const t=new Date(n);return rn(t.getHours())+":"+rn(t.getMinutes())}function ol(n){const t=new Date(n);t.setHours(0,0,0,0);const e=(t.getDay()+6)%7;return t.setDate(t.getDate()-e),t}function di(n){const t=new Date(n);return new Date(t.getFullYear(),t.getMonth(),1)}function Xi(n){const t=new Date(n);return new Date(t.getFullYear(),t.getMonth()+1,0,23,59,59,999)}function De(n){const t=new Date(Date.UTC(n.getFullYear(),n.getMonth(),n.getDate())),e=t.getUTCDay()||7;t.setUTCDate(t.getUTCDate()+4-e);const i=new Date(Date.UTC(t.getUTCFullYear(),0,1));return Math.ceil(((t-i)/864e5+1)/7)}function Kn(n){const t=new Date(n),e=Math.floor(t.getMonth()/3);return new Date(t.getFullYear(),e*3,1)}function Ki(n){const t=Kn(n);return new Date(t.getFullYear(),t.getMonth()+3,0,23,59,59,999)}function Jn(n){const t=new Date(n),e=t.getMonth()<6?0:6;return new Date(t.getFullYear(),e,1)}function Ji(n){const t=Jn(n);return new Date(t.getFullYear(),t.getMonth()+6,0,23,59,59,999)}function vi(n){const t=new Date(n);return new Date(t.getFullYear(),0,1)}function bi(n){const t=new Date(n);return new Date(t.getFullYear(),11,31,23,59,59,999)}function Ff(n,t){const e=new Date(n,0,1+(t-1)*7),i=e.getDay()||7,o=new Date(e);return o.setDate(e.getDate()-(i-1)),o.setHours(0,0,0,0),o}function wn(n,t){const e=Ff(n,t),i=new Date(e);return i.setDate(e.getDate()+6),i.setHours(23,59,59,999),{start:e,end:i}}function Rf(n){const t=ol(n);t.setDate(t.getDate()+7);const e=new Date(t);return e.setDate(t.getDate()+6),e.setHours(23,59,59,999),{start:t,end:e}}function zf(n){const t=new Date(n.getFullYear(),n.getMonth()+1,1);return{start:t,end:new Date(t.getFullYear(),t.getMonth()+1,0,23,59,59,999)}}function Vf(n){const t=Kn(new Date(n.getFullYear(),n.getMonth()+3,1));return{start:t,end:new Date(t.getFullYear(),t.getMonth()+3,0,23,59,59,999)}}function Uf(n){const t=Jn(new Date(n.getFullYear(),n.getMonth()+6,1));return{start:t,end:new Date(t.getFullYear(),t.getMonth()+6,0,23,59,59,999)}}function Hf(n){const t=vi(new Date(n.getFullYear()+1,0,1));return{start:t,end:bi(t)}}function pn(n,t){const e=new Date(t);return n==="settimanale"?"Sett. "+De(new Date(t))+" "+e.getFullYear():n==="mensile"?e.toLocaleString("it-IT",{month:"long",year:"numeric"}):n==="trimestrale"?"Trimestre "+(Math.floor(e.getMonth()/3)+1)+" "+e.getFullYear():n==="semestrale"?(e.getMonth()<6?"1":"2")+" semestre "+e.getFullYear():n==="annuale"?"Anno "+e.getFullYear():n==="ytd"?"YTD "+e.getFullYear():n==="ltm"?"Ultimi 12 mesi":n}(function(n){function t(e){try{if(n.__postSaleBannersInitialized)return;n.__postSaleBannersInitialized=!0,ct("init")}catch(h){}const i=window.BANNERS_LOOKBACK_DAYS||7,o="nncf",a="sale",s=1,r=(h,x)=>"bp_snooze_".concat(x,"_").concat(h),l=(h,x)=>"bp_done_".concat(x,"_").concat(h),c=(h,x)=>{try{const A=localStorage.getItem(r(h,x));return A&&new Date(A).getTime()>Date.now()}catch(A){return!1}},d=(h,x)=>{try{const A=new Date;A.setDate(A.getDate()+1),localStorage.setItem(r(h,x),A.toISOString())}catch(A){}},u=(h,x)=>{try{return localStorage.getItem(l(h,x))==="1"}catch(A){return!1}},p=(h,x)=>{try{localStorage.setItem(l(h,x),"1")}catch(A){}},f=new Set,b=(h,x)=>"bp_pending_".concat(x,"_").concat(h),v=(h,x)=>{const A="".concat(x,":").concat(h);if(f.has(A))return!0;try{const O=localStorage.getItem(b(h,x));return O&&new Date(O).getTime()>Date.now()}catch(O){return!1}},y=(h,x,A=5)=>{const O="".concat(x,":").concat(h);f.add(O);try{const D=new Date;D.setMinutes(D.getMinutes()+Math.max(1,Number(A)||5)),localStorage.setItem(b(h,x),D.toISOString())}catch(D){}},E=(h,x)=>{const A="".concat(x,":").concat(h);f.delete(A);try{localStorage.removeItem(b(h,x))}catch(O){}},M=(h,x)=>"bp_push_".concat(x,"_").concat(h),X=(h,x)=>{try{return localStorage.getItem(M(h,x))==="1"}catch(A){return!1}},it=(h,x)=>{try{localStorage.setItem(M(h,x),"1")}catch(A){}},Q=window.BPFinal&&BPFinal.GET||window.GET,ft=window.BPFinal&&BPFinal.POST||window.POST,ut=window.toast||(h=>alert(h));function ct(){try{if(!window||window.DEBUG_BANNERS!==!0)return}catch(h){return}try{window.logger&&typeof window.logger.debug=="function"?window.logger.debug("[banners]",...arguments):console.debug("[banners]",...arguments)}catch(h){}}function It(h){return String(h||"").replace(/[&<>\"]/g,x=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"})[x])}async function Ot(h,x){try{if(ct("triggerPush called for",h,x.id,x.client),!ft||!x||!x.id){ct("triggerPush early return - missing POST/appt/id");return}if(X(x.id,h)){ct("triggerPush early return - already sent");return}const A=new Date(x.end||x.start||Date.now()).toLocaleString("it-IT",{dateStyle:"short",timeStyle:"short"}),O="Battle Plan",D=h==="nncf"?"Ehi, ".concat(String(x.client||""),"  diventato cliente? Appuntamento del ").concat(A):"Allora, hai venduto a ".concat(String(x.client||"Cliente"),"? Appuntamento del ").concat(A);ct("Sending push notification:",{title:O,body:D,tag:h==="nncf"?"bp-nncf":"bp-sale",url:"/"}),await ft("/api/notifications/send",{text:D,recipients:"all",type:"automatic"}),it(x.id,h),ct("Push notification sent and marked")}catch(A){ct("Error in triggerPush:",A)}}function Ut(){if(document.getElementById("bp-banner-css"))return;const h="\n      #bp_banner_host{position:fixed;left:16px;right:16px;bottom:16px;z-index:9999;display:flex;justify-content:center;pointer-events:none}\n      .bp-banner-card{pointer-events:auto;width:100%;max-width:720px;background:var(--card,#fff);color:var(--text,#111);\n        border:1px solid rgba(0,0,0,.12);border-radius:14px;box-shadow:0 10px 28px rgba(0,0,0,.28);padding:12px;display:flex;gap:12px;align-items:center;opacity:0;transform:translateY(8px);transition:opacity .2s,transform .2s}\n      .bp-banner-card.show{opacity:1;transform:none}\n      .bp-banner-card .msg{flex:1}.bp-banner-card .row{display:flex;gap:8px;align-items:center}\n      .bp-banner-card .ghost{background:rgba(0,0,0,.06);border:1px solid rgba(0,0,0,.12)}\n      @media (prefers-color-scheme: dark){ .bp-banner-card{background:rgba(15,18,28,.96);color:#fff;border-color:rgba(255,255,255,.16)}\n        .bp-banner-card .ghost{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.18)}}\n    ",x=document.createElement("style");x.id="bp-banner-css",x.textContent=h,document.head.appendChild(x)}function Vt(){let h=document.getElementById("bp_banner_host");return h||(h=document.createElement("div"),h.id="bp_banner_host",document.body.appendChild(h)),h}let Mt=[],$t=!1;function Kt(h){Mt.push(h),Zt()}function Zt(){if($t)return;const h=Mt.shift();if(!h)return;$t=!0,Ut();const x=Vt();x.innerHTML="";const A=h(O);x.appendChild(A),requestAnimationFrame(()=>A.classList.add("show"));function O(){x.innerHTML="",$t=!1,setTimeout(Zt,40)}}async function ae(h,x){if(!h)return;const A=await Q("/api/clients"),D=(A&&A.clients||[]).find(U=>String(U.name||"").trim().toLowerCase()===String(h).trim().toLowerCase());D&&await ft("/api/clients",{id:D.id,status:x})}async function Ce(h){try{if(!h)return null;const x=await Q("/api/clients"),A=x&&x.clients||[],O=String(h||"").trim().toLowerCase(),D=A.find(U=>String(U.name||"").trim().toLowerCase()===O);return D?D.id:null}catch(x){return null}}function re(h){if(h)try{if(typeof window.openPaymentBuilderById=="function"){window.openPaymentBuilderById(h);return}if(typeof window.gotoGIAndOpenBuilder=="function"){window.gotoGIAndOpenBuilder(h);return}if(document.querySelector("#gi_rows")){document.dispatchEvent(new CustomEvent("gi:edit",{detail:{id:h}}));return}if(typeof window.viewGI=="function"){try{window.viewGI()}catch(A){}let x=0;(function A(){if(document.getElementById("gi_rows")||x>40){try{document.dispatchEvent(new CustomEvent("gi:edit",{detail:{id:h}}))}catch(D){}return}x++,setTimeout(A,100)})();return}document.dispatchEvent(new CustomEvent("gi:edit",{detail:{id:h}}))}catch(x){}}function Se(h,x){const A=Number(h.vss||h.vsdPersonal||0)||0,O=h.client||"Cliente",D='\n      <div class="card" style="min-width:min(380px,96vw);max-width:480px">\n        <div style="display:flex;justify-content:space-between;align-items:center">\n          <b>VSS per '.concat(It(O),'</b>\n          <button class="ghost" id="vss_x">Chiudi</button>\n        </div>\n        <div class="row" style="margin-top:8px;gap:8px;align-items:flex-end;flex-wrap:wrap">\n          <div style="min-width:200px">\n            <label>Valore VSS</label>\n            <input id="vss_val" type="number" step="1" value="').concat(A,'">\n          </div>\n          <div class="muted small">Modifica consentita solo per VSS</div>\n        </div>\n        <div class="right" style="margin-top:12px">\n          <button id="vss_ok">Salva</button>\n        </div>\n      </div>');if(typeof window.showOverlay=="function"&&typeof window.hideOverlay=="function"){showOverlay(D);const Y=document.getElementById("bp-overlay-panel")||document.body,rt=g=>Y.querySelector(g),m=()=>{try{hideOverlay()}catch(g){}};rt("#vss_x").onclick=m,rt("#vss_ok").onclick=async()=>{try{const g=Math.max(0,Number(rt("#vss_val").value||0));if(await ft("/api/appointments",{id:h.id,vss:g}),e("medium"),ut("Appuntamento aggiornato"),m(),g>0)try{const S=await We(h,g);if(S&&(S.id||S._id)){const C=S.id||S._id;re(C)}}catch(S){logger.error(S)}x&&x.onSaved}catch(g){logger.error(g),ut("Errore salvataggio VSS")}};return}const U=document.createElement("div");U.className="modal",U.innerHTML=D,document.body.appendChild(U);const H=()=>{try{U.remove()}catch(Y){}};U.querySelector("#vss_x").onclick=H,U.querySelector("#vss_ok").onclick=async()=>{try{const Y=Math.max(0,Number(U.querySelector("#vss_val").value||0));if(await ft("/api/appointments",{id:h.id,vss:Y}),e("medium"),ut("Appuntamento aggiornato"),H(),Y>0)try{const rt=await We(h,Y);if(rt&&(rt.id||rt._id)){const m=rt.id||rt._id;re(m)}}catch(rt){logger.error(rt)}x&&x.onSaved}catch(Y){logger.error(Y),ut("Errore salvataggio VSS")}}}async function We(h,x){let A=h.clientId||null;A||(A=await Ce(h.client));const O={apptId:h.id,date:new Date(h.end||h.start||Date.now()).toISOString(),clientId:A||void 0,clientName:h.client||"Cliente",vssTotal:Math.round(Number(x||0)),services:h.services||h.note||"",consultantId:h.userId||h.ownerId||null},D=await ft("/api/gi",O);return D&&(D.sale||D.gi||D.data)||D}async function Te(h,x,A){try{await ft("/api/appointments",{id:h,[x===o?"nncfPromptAnswered":"salePromptAnswered"]:!0}),ct("Marked banner as answered",h,x,A)}catch(O){ct("Error marking banner as answered",O)}}async function Ke(h,x,A=24){try{const O=new Date;O.setHours(O.getHours()+A),await ft("/api/appointments",{id:h,[x===o?"nncfPromptSnoozedUntil":"salePromptSnoozedUntil"]:O.toISOString()}),ct("Snoozed banner",h,x,"until",O.toISOString())}catch(O){ct("Error snoozing banner",O)}}function Ve(h,x){const O=h[x===o?"nncfPromptSnoozedUntil":"salePromptSnoozedUntil"];return O?new Date(O).getTime()>Date.now():!1}function Je(h,x){return!!h[x===o?"nncfPromptAnswered":"salePromptAnswered"]}function k(h){return function(x){const A=document.createElement("div");A.className="bp-banner-card",A.setAttribute("role","alertdialog"),A.setAttribute("aria-live","assertive");const O=new Date(h.end||h.start||Date.now()).toLocaleString("it-IT",{dateStyle:"short",timeStyle:"short"});return A.innerHTML='<div class="msg"><b>Allora, hai venduto a '.concat(It(h.client||"Cliente"),"? Appuntamento del ").concat(It(O),'</b></div>\n         <div class="row">\n           <button class="ghost" data-act="later">Posticipa</button>\n           <button class="ghost" data-act="no">No</button>\n           <button data-act="yes">S</button>\n         </div>'),A.querySelector('[data-act="yes"]').onclick=async function(){p(h.id,a),E(h.id,a),x(),await Te(h.id,a,"yes"),typeof window.BP<"u"&&window.BP.Coach&&typeof window.BP.Coach.say=="function"&&window.BP.Coach.say("client_converted",{intensity:"high"}),Se(h)},A.querySelector('[data-act="no"]').onclick=async function(){p(h.id,a),E(h.id,a),x(),await Te(h.id,a,"no");try{await ft("/api/appointments",{id:h.id,vss:0}),ut("Registrato: nessuna vendita")}catch(D){}},A.querySelector('[data-act="later"]').onclick=async function(){d(h.id,a),E(h.id,a),await Ke(h.id,a,24),ut("Te lo ripropongo domani"),x()},A}}function w(h){return function(x){const A=document.createElement("div");A.className="bp-banner-card",A.setAttribute("role","alertdialog"),A.setAttribute("aria-live","assertive");const O=new Date(h.end||h.start||Date.now()).toLocaleString("it-IT",{dateStyle:"short",timeStyle:"short"});return A.innerHTML='<div class="msg"><b>Ehi, '.concat(It(h.client||""),"  diventato cliente? Appuntamento del ").concat(It(O),'</b></div>\n         <div class="row">\n           <button class="ghost" data-act="later">Posticipa</button>\n           <button class="ghost" data-act="no">No</button>\n           <button data-act="yes">S</button>\n         </div>'),A.querySelector('[data-act="yes"]').onclick=async function(){p(h.id,o),E(h.id,o),x(),await Te(h.id,o,"yes");try{await ae(h.client,"attivo")}catch(D){}typeof window.BP<"u"&&window.BP.Coach&&typeof window.BP.Coach.say=="function"&&window.BP.Coach.say("client_converted",{intensity:"high"}),Se(h)},A.querySelector('[data-act="no"]').onclick=async function(){p(h.id,o),E(h.id,o),x(),await Te(h.id,o,"no");try{await ae(h.client,"lead non chiuso"),await ft("/api/appointments",{id:h.id,vss:0}),ut("Aggiornato: Lead non chiuso, VSS=0")}catch(D){}},A.querySelector('[data-act="later"]').onclick=async function(){d(h.id,o),E(h.id,o),await Ke(h.id,o,24),ut("Te lo ripropongo domani"),x()},A}}async function I(){try{ct("=== SCAN STARTED ===");const h=await Q("/api/appointments"),x=Date.now(),A=x-i*24*60*60*1e3,O=h&&h.appointments||[];O.sort((D,U)=>+new Date(U.end||U.start||0)-+new Date(D.end||D.start||0)),ct("Scanning",O.length,"appointments"),O.forEach(D=>{try{const U=+new Date(D.end||D.start||0);if(!U||U>x||U<A){ct("Skipping appointment - time filter",D.id,D.type,new Date(U).toLocaleString());return}const H=s*60*1e3;if(U>x-H){ct("Skipping appointment - too recent",D.id,D.type,"ended",new Date(U).toLocaleString());return}if(!(String(D.type||"").toLowerCase()==="vendita")){ct("Skipping appointment - not vendita",D.id,"type:",D.type,"lowercase:",String(D.type||"").toLowerCase());return}if(ct("Processing vendita appointment",D.id,D.type,"nncf:",D.nncf),D.nncf){if(Je(D,o)||Ve(D,o))return;if(u(D.id,o)||c(D.id,o)||v(D.id,o)){ct("skip pending NNCF",D&&D.id);return}ct("Triggering NNCF push and banner for",D.id),Ot(o,D),y(D.id,o),ct("mark pending NNCF",D&&D.id),Kt(w(D))}else{if(Je(D,a)||Ve(D,a))return;if(u(D.id,a)||c(D.id,a)||v(D.id,a)){ct("skip pending SALE",D&&D.id);return}ct("Triggering SALE push and banner for",D.id),Ot(a,D),y(D.id,a),ct("mark pending SALE",D&&D.id),Kt(k(D))}}catch(U){}})}catch(h){}}window.scanBanners=I,ct("=== POST SALE BANNERS INITIALIZED ==="),document.readyState==="loading"?(ct("Document loading, waiting for DOMContentLoaded"),document.addEventListener("DOMContentLoaded",I,{once:!0})):(ct("Document ready, starting initial scan"),I());try{document.addEventListener("appt:saved",function(){setTimeout(I,50)})}catch(h){}try{document.addEventListener("visibilitychange",function(){document.hidden||setTimeout(I,50)})}catch(h){}try{setInterval(function(){I()},60*1e3)}catch(h){}}if(typeof n<"u"){n.initPostSaleBanners=t;try{t()}catch(e){console.error("Error initializing post sale banners:",e)}}})(typeof window<"u"?window:void 0);function Nn(n){return document.querySelector(n)}function jo(n){return Array.from(document.querySelectorAll(n))}window.Chart=mn;(function(){var n=document.getElementById("app");window.$1=window.$1||Nn,window.$all=window.$all||jo,window.addXP=window.addXP||function(){},typeof window.logger!="object"&&(window.logger=["debug","info","log","warn","error"].reduce((m,g)=>(m[g]=(console[g]||console.log).bind(console),m),{})),typeof window.haptic!="function"&&(window.haptic=window.BP&&BP.Haptics&&BP.Haptics.impact?BP.Haptics.impact:function(){}),(function(){const m=window.__miniCharts=window.__miniCharts||{};function g(tt,q,ht){const V=tt.getContext("2d"),nt=window.devicePixelRatio||1,vt=tt.clientWidth||320,K=tt.clientHeight||80;tt.width=Math.round(vt*nt),tt.height=Math.round(K*nt),V.save(),V.scale(nt,nt),V.clearRect(0,0,vt,K);const P=Math.max(1,...ht),et=ht.length>1?(vt-8)/(ht.length-1):0;V.strokeStyle="#2e6cff",V.lineWidth=2,V.beginPath();for(let J=0;J<ht.length;J++){const F=4+J*et,B=K-6-ht[J]/P*(K-12);J===0?V.moveTo(F,B):V.lineTo(F,B)}V.stroke(),V.fillStyle="#2e6cff";for(let J=0;J<ht.length;J++){const F=4+J*et,B=K-6-ht[J]/P*(K-12);V.beginPath(),V.arc(F,B,2,0,Math.PI*2),V.fill()}V.restore()}function S(tt,q){try{let V=function(P,et){try{if(this&&typeof this.getLabelForValue=="function")return String(this.getLabelForValue(P))}catch(B){}const J=typeof P=="number"?P:et,F=Array.isArray(tt)?tt[J]:P;return String(F!=null?F:P)};const ht=Array.isArray(tt)?tt.length:0;if(!ht)return{autoSkip:!0,maxRotation:0,minRotation:0};const nt=Math.max(0,...tt.map(P=>String(P||"").length)),vt=Math.max(28,Math.min(90,Math.round(nt*7)));return ht*vt>(q||320)*1.2?{autoSkip:!0,maxRotation:45,minRotation:45,callback:V}:{autoSkip:!0,maxRotation:0,minRotation:0,callback:V}}catch(ht){return{autoSkip:!0,maxRotation:0,minRotation:0}}}window.computeTickOptions=S,window.drawFullLine=function(tt,q,ht){const V=document.getElementById(tt);if(!V)return;if(V.width=V.clientWidth||V.width||320,V.height=V.clientHeight||V.height||80,!mn){g(V,q,ht),m[String(tt)]={canvas:V,labels:q,data:ht,fallback:!0};return}const nt=String(tt),vt=S(q,V.width||320);if(m[nt]&&m[nt].canvas!==V){try{m[nt].destroy()}catch(K){}delete m[nt]}if(m[nt]){const K=m[nt];K.data.labels=q,K.data.datasets[0].data=ht,K.options.scales.x.ticks=S(q,V.width||320),K.update()}else{const K=V.getContext("2d");m[nt]=new mn(K,{type:"line",data:{labels:q,datasets:[{label:"",data:ht,borderColor:"#2e6cff",backgroundColor:"rgba(46,108,255,0.10)",borderWidth:2,tension:.3,pointRadius:3,pointHoverRadius:5,fill:!1}]},options:{responsive:!1,maintainAspectRatio:!1,animation:!1,animations:!1,plugins:{legend:{display:!1}},devicePixelRatio:window.devicePixelRatio||1,scales:{x:{grid:{display:!1},ticks:vt},y:{beginAtZero:!0}}}})}};let C=window.devicePixelRatio||1;function L(){Object.keys(m).forEach(tt=>{const q=m[tt];if(q&&typeof q.resize=="function")try{q.resize()}catch(ht){}else if(q&&q.fallback)try{g(q.canvas,q.labels,q.data)}catch(ht){}})}function z(){const tt=window.devicePixelRatio||1;tt!==C&&(C=tt,L())}window.addEventListener("pageshow",L),window.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&z()}),window.addEventListener("resize",z),window.addEventListener("orientationchange",()=>setTimeout(()=>{C=-1,z()},50))})();function t(){document.title="Battle Plan  Login";var m='<div class="hero" id="hero"><div class="layer glow"></div><div class="layer grid"></div><div class="title">Pianifica. Eroga. Vinci. <span class="small muted">BP  stile gaming</span></div></div><div class="wrap"><div class="grid"><div class="card"><h3>Accedi</h3><form id="loginForm" autocomplete="on"><div class="row"><div><label>Email</label><input id="li_email" name="email" type="email" autocomplete="username" required></div><div><label>Password</label><input id="li_password" name="password" type="password" autocomplete="current-password" required></div></div><div class="row"><label class="small"><input type="checkbox" id="li_remember" checked> Rimani collegato</label></div><div class="right" style="margin-top:8px"><button type="submit" id="btnLogin">Accedi</button></div></form></div><div class="card"><h3>Registrati</h3><form id="regForm" autocomplete="on"><div class="row"><div><label>Nome</label><input id="re_name" name="name" type="text" required></div><div><label>Email</label><input id="re_email" name="email" type="email" autocomplete="username" required></div><div><label>Password</label><input id="re_password" name="new-password" type="password" autocomplete="new-password" required></div></div><div class="right" style="margin-top:8px"><button type="submit" id="btnRegister">Registrati</button></div></form></div></div></div>';n.innerHTML=m;var g=document.getElementById("hero");g&&g.addEventListener("pointermove",function(L){var z=g.getBoundingClientRect();g.style.setProperty("--gx",(L.clientX-z.left)/z.width*100+"%"),g.style.setProperty("--gy",(L.clientY-z.top)/z.height*100+"%")});var S=document.getElementById("loginForm"),C=document.getElementById("regForm");S.addEventListener("submit",function(L){L.preventDefault();var z=document.getElementById("btnLogin");z.disabled=!0;var tt=document.getElementById("li_email").value.trim().toLowerCase(),q=document.getElementById("li_password").value,ht=document.getElementById("li_remember").checked;Le("/api/login",{email:tt,password:q}).then(function(V){if(typeof V=="string")try{V=JSON.parse(V)}catch(nt){}_f(V.token,ht),Sf(V.user),Nt("Bentornato "+V.user.name+"!"),window.addXP(10),c(),Oe(),window.BPPush&&window.BPPush.subscribe()},function(V){Nt("Credenziali errate"),logger.error(V)}).catch(function(V){logger.error(V)}).finally(function(){z.disabled=!1})}),C.addEventListener("submit",function(L){L.preventDefault();var z=document.getElementById("btnRegister");z.disabled=!0;var tt=document.getElementById("re_name").value.trim(),q=document.getElementById("re_email").value.trim().toLowerCase(),ht=document.getElementById("re_password").value;Le("/api/register",{name:tt,email:q,password:ht}).then(function(){Nt("Registrazione ok. Ora accedi"),Gi(),window.addXP(20),window.scrollTo({top:0,behavior:"smooth"})}).catch(function(V){Nt("Email gi registrata?"),logger.error(V)}).finally(function(){z.disabled=!1})})}function e(m){const g=new Date,S=g.getFullYear(),C=g.getMonth()+1,L=De(g),z=Math.floor((C-1)/3)+1,tt=2e3,q=2100,ht=(function(){let K="";for(let P=tt;P<=q;P++)K+='<option value="'.concat(P,'" ').concat(P===S?"selected":"",">").concat(P,"</option>");return K})(),V=(function(){let K="";for(let P=1;P<=12;P++)K+='<option value="'.concat(P,'" ').concat(P===C?"selected":"",">").concat(P,"</option>");return K})(),nt=(function(){let K="";for(let P=1;P<=53;P++)K+='<option value="'.concat(P,'" ').concat(P===L?"selected":"",">").concat(P,"</option>");return K})(),vt=(function(){let K="";for(let P=1;P<=4;P++)K+='<option value="'.concat(P,'" ').concat(P===z?"selected":"",">Q").concat(P,"</option>");return K})();return'<div class="uf"><div class="row"><div><label>Granularit</label><select id="'+m+'_gran"><option value="settimanale">Settimanale</option><option value="mensile" selected>Mensile</option><option value="trimestrale">Trimestrale</option><option value="semestrale">Semestrale</option><option value="annuale">Annuale</option><option value="ytd">Anno corrente (YTD)</option><option value="ltm">Ultimi 12 mesi (LTM)</option></select></div><div id="'+m+'_wrap_week" style="display:none"><label>Settimana ISO</label><div class="row"><select id="'+m+'_week">'+nt+'</select><select id="'+m+'_year_w">'+ht+'</select></div></div><div id="'+m+'_wrap_month"><label>Mese</label><div class="row"><select id="'+m+'_month">'+V+'</select><select id="'+m+'_year_m">'+ht+'</select></div></div><div id="'+m+'_wrap_quarter" style="display:none"><label>Trimestre</label><div class="row"><select id="'+m+'_quarter">'+vt+'</select><select id="'+m+'_year_q">'+ht+'</select></div></div><div id="'+m+'_wrap_sem" style="display:none"><label>Semestre</label><div class="row"><select id="'+m+'_sem"><option value="1">1</option><option value="2">2</option></select><select id="'+m+'_year_s">'+ht+'</select></div></div><div id="'+m+'_wrap_year" style="display:none"><label>Anno</label><select id="'+m+'_year">'+ht+'</select></div><div class="actions"><button id="'+m+'_refresh" class="ghost">Aggiorna</button></div></div></div>'}(function(){const m=[];window.onUnifiedRangeChange=function(g){typeof g=="function"&&m.push(g)},window.emitUnifiedRangeChange=function(g){for(const S of m)try{S(g)}catch(C){logger.error(C)}}})();function i(m){return m==="d"||m==="dash"?"dash":m==="cm"||m==="comm"?"comm":m==="tg"||m==="t"||m==="team"?"t":m}function o(m,g){function S(){const L=document.getElementById(m+"_gran").value;["week","month","quarter","sem","year"].forEach(tt=>{const q=document.getElementById(m+"_wrap_"+tt);q&&(q.style.display="none")}),L==="settimanale"?document.getElementById(m+"_wrap_week").style.display="":L==="mensile"?document.getElementById(m+"_wrap_month").style.display="":L==="trimestrale"?document.getElementById(m+"_wrap_quarter").style.display="":L==="semestrale"?document.getElementById(m+"_wrap_sem").style.display="":L==="annuale"&&(document.getElementById(m+"_wrap_year").style.display="")}["gran","week","year_w","month","year_m","quarter","year_q","sem","year_s","year"].forEach(L=>{const z=document.getElementById(m+"_"+L);z&&(z.onchange=()=>{S(),g&&g(),window.emitUnifiedRangeChange(i(m))},z.oninput=()=>{S()})});const C=document.getElementById(m+"_refresh");C&&(C.onclick=()=>{g&&g(),window.emitUnifiedRangeChange(i(m))}),S()}function a(m){var g=new Date;function S(R,W){var $=document.getElementById(m+"_"+R),_=$?parseInt($.value,10):NaN;return isFinite(_)?_:W}var C=document.getElementById(m+"_gran"),L=C?C.value:"mensile",z={type:L,start:null,end:null};if(L==="settimanale"){var tt=S("year_w",g.getFullYear()),q=Math.max(1,Math.min(53,S("week",De(g)))),ht=wn(tt,q);return z.start=ht.start,z.end=ht.end,z}if(L==="mensile"){var V=S("year_m",g.getFullYear()),nt=Math.max(1,Math.min(12,S("month",g.getMonth()+1)));return z.start=new Date(V,nt-1,1),z.end=new Date(V,nt,0,23,59,59,999),z}if(L==="trimestrale"){var vt=S("year_q",g.getFullYear()),K=Math.max(1,Math.min(4,S("quarter",Math.floor(g.getMonth()/3)+1)));return z.start=new Date(vt,(K-1)*3,1),z.end=new Date(vt,K*3,0,23,59,59,999),z}if(L==="semestrale"){var P=S("year_s",g.getFullYear()),et=S("sem",g.getMonth()<6?1:2);return z.start=new Date(P,et===1?0:6,1),z.end=new Date(P,et===1?6:12,0,23,59,59,999),z}if(L==="annuale"){var J=S("year",g.getFullYear());return z.start=new Date(J,0,1),z.end=new Date(J,11,31,23,59,59,999),z}if(L==="ytd"){var F=new Date(g.getFullYear(),g.getMonth()+1,0,23,59,59,999);return z.start=new Date(g.getFullYear(),0,1),z.end=F,z}if(L==="ltm"){var B=new Date(g.getFullYear(),g.getMonth()+1,0,23,59,59,999),at=new Date(B.getFullYear(),B.getMonth()-11,1);return z.start=at,z.end=B,z}return z.type="mensile",z.start=new Date(g.getFullYear(),g.getMonth(),1),z.end=new Date(g.getFullYear(),g.getMonth()+1,0,23,59,59,999),z}function s(m){return m==="ytd"||m==="ltm"?"mensile":m}window.effectivePeriodType=s;function r(m,g){var S=String(m||"mensile").toLowerCase(),C=s(S||"mensile"),L=g?new Date(g):new Date,z=L.getUTCFullYear(),tt=[];function q(te,Yt){tt.push({s:te.getTime(),e:Yt.getTime()})}function ht(te,Yt,Et){return new Date(Date.UTC(te,Yt,Et))}function V(te){return new Date(te.getTime()+24*3600*1e3-1)}function nt(te,Yt){return new Date(Date.UTC(te,Yt+1,0))}if(S==="ytd"){for(var vt=0;vt<=L.getUTCMonth();vt++){var K=ht(L.getUTCFullYear(),vt,1),P=V(nt(K.getUTCFullYear(),K.getUTCMonth()));tt.push({s:K.getTime(),e:P.getTime()})}return tt}if(S==="ltm"){for(var et=ht(L.getUTCFullYear(),L.getUTCMonth(),1),J=11;J>=0;J--){var F=ht(et.getUTCFullYear(),et.getUTCMonth()-J,1),B=V(nt(F.getUTCFullYear(),F.getUTCMonth()));tt.push({s:F.getTime(),e:B.getTime()})}return tt}if(C==="settimanale"){var at=new Date(Date.UTC(L.getUTCFullYear(),L.getUTCMonth(),L.getUTCDate())),R=(at.getUTCDay()+6)%7;at.setUTCDate(at.getUTCDate()-R);for(var W=52;W>=0;W--){var $=new Date(at);$.setUTCDate(at.getUTCDate()-W*7);var _=new Date($);_.setUTCDate($.getUTCDate()+6),_.setUTCHours(23,59,59,999),q($,_)}return tt}if(C==="mensile"){for(var et=new Date(Date.UTC(L.getUTCFullYear(),L.getUTCMonth(),1)),J=23;J>=0;J--){var vt=new Date(Date.UTC(et.getUTCFullYear(),et.getUTCMonth()-J,1));q(vt,V(nt(vt.getUTCFullYear(),vt.getUTCMonth())))}return tt}if(C==="trimestrale"){for(var N=Math.floor(L.getUTCMonth()/3),T=11;T>=0;T--){var gt=N-T,st=z+Math.floor(gt/4),ot=(gt%4+4)%4,$=ht(st,ot*3,1),_=V(new Date(Date.UTC(st,ot*3+3,0)));q($,_)}return tt}if(C==="semestrale"){for(var pt=L.getUTCMonth()<6?0:1,lt=5;lt>=0;lt--){var dt=pt-lt,yt=z+Math.floor(dt/2),Ct=(dt%2+2)%2,wt=Ct===0?0:6,Tt=ht(yt,wt,1),Ft=V(new Date(Date.UTC(yt,wt+6,0)));q(Tt,Ft)}return tt}for(var Pt=2;Pt>=0;Pt--){var At=z-Pt;q(ht(At,0,1),V(new Date(Date.UTC(At,12,0))))}return tt}function l(m,g){var S=s(m||"mensile");return(g||[]).map(function(C){var L=new Date(C.s);return S==="settimanale"?"W"+De(L)+" "+L.getUTCFullYear():S==="mensile"?String(L.getUTCMonth()+1).padStart(2,"0")+"/"+L.getUTCFullYear():S==="trimestrale"?"Q"+(Math.floor(L.getUTCMonth()/3)+1)+" "+L.getUTCFullYear():S==="semestrale"?(L.getUTCMonth()<6?"S1 ":"S2 ")+L.getUTCFullYear():String(L.getUTCFullYear())})}function c(){if(!Jt())return t();document.title="Battle Plan  Dashboard",Ge("viewHome");const m=Jt().role==="admin";var g=m?'<div><label>Consulente</label><select id="dash_cons"><option value="">Tutti</option></select></div>':"";if(!document.getElementById("dashboard_modern_css")){const F=document.createElement("style");F.id="dashboard_modern_css",F.textContent='\n      /* Modern Dashboard Design */\n      .dashboard-wrap {\n        max-width: 1200px;\n        margin: 0 auto;\n        padding: 0 20px;\n        margin-top: calc(56px + env(safe-area-inset-top) + 32px);\n      }\n      \n      /* Modern KPI Cards */\n      .kpi-card {\n        background: linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.04));\n        border: 1px solid var(--hair2);\n        border-radius: 20px;\n        padding: 24px;\n        position: relative;\n        overflow: hidden;\n        transition: all 0.3s ease;\n        backdrop-filter: blur(10px);\n        box-shadow: 0 8px 32px rgba(0,0,0,.1);\n      }\n      \n      .kpi-card::before {\n        content: "";\n        position: absolute;\n        top: 0;\n        left: 0;\n        right: 0;\n        height: 4px;\n        background: linear-gradient(90deg, var(--accent), var(--accent2));\n        border-radius: 20px 20px 0 0;\n      }\n      \n      .kpi-card::after {\n        content: "";\n        position: absolute;\n        top: 0;\n        left: 0;\n        right: 0;\n        height: 1px;\n        background: var(--hair2);\n        border-radius: 20px 20px 0 0;\n      }\n      \n      .kpi-card:hover {\n        transform: translateY(-4px);\n        box-shadow: 0 16px 48px rgba(0,0,0,.15);\n        border-color: var(--accent);\n      }\n      \n      /* KPI Card Header */\n      .kpi-header {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        margin-bottom: 16px;\n      }\n      \n      .kpi-title {\n        font-size: 14px;\n        font-weight: 600;\n        color: var(--accent);\n        text-transform: uppercase;\n        letter-spacing: 0.5px;\n        display: flex;\n        align-items: center;\n        gap: 8px;\n      }\n      \n      .kpi-icon {\n        font-size: 18px;\n        opacity: 0.8;\n      }\n      \n      .kpi-value {\n        font-size: 28px;\n        font-weight: 800;\n        color: var(--text);\n        line-height: 1;\n        text-shadow: 0 2px 4px rgba(0,0,0,.1);\n      }\n      \n      /* KPI Chart Container */\n      .kpi-chart {\n        height: 90px;\n        border-radius: 12px;\n        overflow: hidden;\n        background: rgba(255,255,255,.02);\n        border: 1px solid var(--hair2);\n      }\n      \n      /* Modern Grid Layout */\n      .dashboard-grid {\n        display: grid;\n        gap: 20px;\n        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));\n        margin-bottom: 32px;\n      }\n      \n      @media (max-width: 768px) {\n        .dashboard-grid {\n          grid-template-columns: 1fr;\n          gap: 16px;\n        }\n        \n        .kpi-card {\n          padding: 20px;\n        }\n        \n        .kpi-value {\n          font-size: 24px;\n        }\n        \n        .dashboard-wrap {\n          margin-top: calc(56px + env(safe-area-inset-top) + 16px);\n          padding: 0 16px;\n        }\n      }\n      \n      /* Modern Filter Card */\n      .filter-card {\n        background: linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.03));\n        border: 1px solid var(--hair2);\n        border-radius: 16px;\n        padding: 20px;\n        margin-bottom: 24px;\n        backdrop-filter: blur(10px);\n        box-shadow: 0 4px 16px rgba(0,0,0,.08);\n      }\n      \n      .filter-card b {\n        font-size: 16px;\n        font-weight: 700;\n        color: var(--text);\n        margin-bottom: 16px;\n        display: block;\n        position: relative;\n        padding-left: 12px;\n      }\n      \n      .filter-card b::before {\n        content: "";\n        position: absolute;\n        left: 0;\n        top: 50%;\n        transform: translateY(-50%);\n        width: 4px;\n        height: 16px;\n        background: linear-gradient(180deg, var(--accent), var(--accent2));\n        border-radius: 2px;\n      }\n      \n      /* Modern Section Cards */\n      .section-card {\n        background: linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.03));\n        border: 1px solid var(--hair2);\n        border-radius: 16px;\n        padding: 20px;\n        margin-bottom: 20px;\n        backdrop-filter: blur(10px);\n        box-shadow: 0 4px 16px rgba(0,0,0,.08);\n        transition: all 0.2s ease;\n      }\n      \n      .section-card:hover {\n        border-color: var(--accent);\n        box-shadow: 0 8px 24px rgba(0,0,0,.12);\n      }\n      \n      .section-card b {\n        font-size: 16px;\n        font-weight: 700;\n        color: var(--text);\n        margin-bottom: 16px;\n        display: block;\n        position: relative;\n        padding-left: 12px;\n      }\n      \n      .section-card b::before {\n        content: "";\n        position: absolute;\n        left: 0;\n        top: 50%;\n        transform: translateY(-50%);\n        width: 4px;\n        height: 16px;\n        background: linear-gradient(180deg, var(--accent), var(--accent2));\n        border-radius: 2px;\n      }\n      \n      /* Accordion Header */\n      .accordion-header {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        cursor: pointer;\n        padding: 8px 0;\n        transition: all 0.2s ease;\n      }\n      \n      .accordion-header:hover {\n        color: var(--accent);\n      }\n      \n      .accordion-chevron {\n        transition: transform 0.2s ease;\n        font-size: 14px;\n        color: var(--accent);\n      }\n      \n      .accordion-content {\n        margin-top: 16px;\n        display: none;\n      }\n      \n      .accordion-content.open {\n        display: block;\n        animation: slideDown 0.3s ease;\n      }\n      \n      @keyframes slideDown {\n        from { opacity: 0; transform: translateY(-10px); }\n        to { opacity: 1; transform: translateY(0); }\n      }\n      \n      /* Responsive adjustments */\n      @media (max-width: 480px) {\n        .dashboard-wrap {\n          padding: 0 16px;\n        }\n        \n        .kpi-card {\n          padding: 16px;\n        }\n        \n        .filter-card, .section-card {\n          padding: 16px;\n        }\n      }\n    ',document.head.appendChild(F)}n.innerHTML=$e()+'<div class="dashboard-wrap"><div class="filter-card"><b>Filtro</b><div class="row uf-row" style="margin-top:6px;align-items:flex-end;gap:16px;flex-wrap:wrap"><div><label>Modalit</label><select id="dash_mode" name="mode"><option value="previsionale">Previsionale</option><option value="consuntivo">Consuntivo</option></select></div>'+g+"</div>"+e("dash")+'</div><div class="dashboard-grid" id="kpiGrid"><div class="kpi-card"><div class="kpi-header"><div class="kpi-title"><span class="kpi-icon"></span>VSS</div><span id="kpi_vss" class="kpi-value"></span></div><div class="kpi-chart"><canvas id="d_mini_vss" width="320" height="90"></canvas></div></div><div class="kpi-card"><div class="kpi-header"><div class="kpi-title"><span class="kpi-icon"></span>VSD personale</div><span id="kpi_vsd" class="kpi-value"></span></div><div class="kpi-chart"><canvas id="d_mini_vsdpersonale" width="320" height="90"></canvas></div></div><div class="kpi-card"><div class="kpi-header"><div class="kpi-title"><span class="kpi-icon"></span>VSD indiretto</div><span id="kpi_vsd_ind" class="kpi-value"></span></div><div class="kpi-chart"><canvas id="d_mini_vsdindiretto" width="320" height="90"></canvas></div></div><div class="kpi-card"><div class="kpi-header"><div class="kpi-title"><span class="kpi-icon"></span>GI</div><span id="kpi_gi" class="kpi-value"></span></div><div class="kpi-chart"><canvas id="d_mini_gi" width="320" height="90"></canvas></div></div><div class="kpi-card"><div class="kpi-header"><div class="kpi-title"><span class="kpi-icon"></span>NNCF</div><span id="kpi_nncf" class="kpi-value"></span></div><div class="kpi-chart"><canvas id="d_mini_nncf" width="320" height="90"></canvas></div></div><div class="kpi-card"><div class="kpi-header"><div class="kpi-title"><span class="kpi-icon"></span>Tot Provvigioni</div><span id="kpi_provv" class="kpi-value"></span></div><div class="kpi-chart"><canvas id="d_mini_provv" width="320" height="90"></canvas></div></div></div><div class="section-card"><b>Ultimi appuntamenti inseriti</b><div id="lastApps" class="row" style="margin-top:8px"></div></div><div class="section-card"><div id="dash_bp_sent_head" class="accordion-header"><b>BP inviati (periodi in essere)</b><span id="dash_bp_sent_chev" class="accordion-chevron"></span></div><div id="dash_bp_sent" class="accordion-content" style="margin-top:8px"></div></div></div>',Oe(),(function(){try{var B=document.querySelector(".uf-row");if(!B)return;var at=document.getElementById("cal_prev");at&&(at.textContent="");var R=document.getElementById("cal_next");R&&(R.textContent="");var W=B.querySelector("#only_4h");W&&W.parentElement&&(W.parentElement.innerHTML='<input type="checkbox" id="only_4h"> Solo slot  4h');var $=document.getElementById("cal_add"),_=B.querySelector(".right"),N=_?_.querySelector("#cal_refresh"):null;if($&&N){var T=document.createElement("div");T.className="actions",_.parentNode.insertBefore(T,_),T.appendChild($),T.appendChild(N),_.remove()}}catch(gt){logger&&logger.warn&&logger.warn("cal header fix fail",gt)}})();function S(F,B){var at=document.getElementById(F);at&&(at.textContent=B)}function C(F){var B=Number(F)||0;return B.toLocaleString("it-IT")+""}function L(F){var B=Number(F)||0;return String(Math.round(B))}function z(F){return String(F).replace(/[&<>'"]/g,B=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[B])}m&&(function(){qt("/api/usernames").then(function(B){var at=B&&B.users||[],R=document.getElementById("dash_cons");if(R){var W=Jt()||{},$="";W.role==="admin"&&($+='<option value="">Tutti</option>',$+=at.map(function(_){return'<option value="'+z(String(_.id))+'">'+z(_.name||_.email||"User #"+_.id)+"</option>"}).join("")),R.innerHTML=$,R.value=W.id}}).catch(function(){})})();function tt(F,B){return B==="settimanale"?window.isoWeekNum?window.isoWeekNum(F):Math.ceil(F.getDate()/7):B==="mensile"||B==="ytd"||B==="ltm"?F.getMonth()+1:B==="trimestrale"?Math.floor(F.getMonth()/3)+1:B==="semestrale"?F.getMonth()<6?1:2:F.getFullYear()}function q(F){if(typeof r=="function")return(r(F,new Date)||[]).map(function(Dt){return{s:Dt.s,e:Dt.e}});var B=new Date,at=[];function R(Dt,G){at.push({s:Dt.getTime(),e:G.getTime()})}function W(Dt){var G=new Date(Dt);return G.setHours(23,59,59,999),G}function $(Dt,G){return new Date(Dt,G+1,0,23,59,59,999)}var _=String(F||"mensile").toLowerCase();if(_==="settimanale"){var N=new Date(B),T=(N.getDay()+6)%7;N.setDate(N.getDate()-T),N.setHours(0,0,0,0);for(var gt=52;gt>=0;gt--){var st=new Date(N);st.setDate(st.getDate()-gt*7);var ot=new Date(st);ot.setDate(st.getDate()+6),ot.setHours(23,59,59,999),R(st,ot)}return at}if(_==="mensile"||_==="ytd"||_==="ltm"){if(_==="ytd")for(var pt=0;pt<=B.getMonth();pt++){var lt=new Date(B.getFullYear(),pt,1);R(lt,$(B.getFullYear(),pt))}else for(var dt=_==="ltm"?12:24,yt=new Date(B.getFullYear(),B.getMonth(),1),Ct=dt-1;Ct>=0;Ct--){var st=new Date(yt.getFullYear(),yt.getMonth()-Ct,1);R(st,$(st.getFullYear(),st.getMonth()))}return at}if(_==="trimestrale"){for(var wt=Math.floor(B.getMonth()/3)*3,Tt=new Date(B.getFullYear(),wt,1),Ft=11;Ft>=0;Ft--){var Pt=new Date(Tt.getFullYear(),Tt.getMonth()-Ft*3,1);R(Pt,W(new Date(Pt.getFullYear(),Pt.getMonth()+3,0)))}return at}if(_==="semestrale"){for(var At=B.getMonth()<6?0:6,te=new Date(B.getFullYear(),At,1),st=5;st>=0;st--){var Yt=new Date(te.getFullYear(),te.getMonth()-st*6,1);R(Yt,W(new Date(Yt.getFullYear(),Yt.getMonth()+6,0)))}return at}for(var Et=2;Et>=0;Et--){var bt=new Date(B.getFullYear()-Et,0,1);R(bt,W(new Date(bt.getFullYear(),12,0)))}return at}function ht(F){switch(String(F)){case"provv_gi":return"ProvvGI";case"provv_vsd":return"ProvvVSD";case"tot_provv":return"TotProvvigioni";default:return F}}function V(F,B,at,R){var W=R||a("dash"),$=String(W.type||"mensile").toLowerCase(),_=$==="ytd"||$==="ltm"?"mensile":$,N=q($);function T(ot,pt){var lt=new Date(pt.startDate).getTime(),dt=new Date(pt.endDate).getTime();return lt>=ot.s&&dt<=ot.e}function gt(ot,pt){if(!ot)return 0;if(pt==="VSDTotale")return Number(ot.VSDPersonale||0)+Number(ot.VSDIndiretto||0);if(pt==="ProvvGI")return Number(ot.ProvvGI||0);if(pt==="ProvvVSD")return Number(ot.ProvvVSD||0);if(pt==="TotProvvigioni"){var lt=ot.TotProvvigioni;return Number(lt!=null?lt:Number(ot.ProvvGI||0)+Number(ot.ProvvVSD||0))}return Number(ot[pt]||0)}var st=(function(){var ot=N.length?Ie(new Date(N[0].s)):Ie(new Date),pt=N.length?Ie(new Date(N[N.length-1].e)):Ie(new Date),lt="?global=1&type="+encodeURIComponent(_)+"&from="+encodeURIComponent(ot)+"&to="+encodeURIComponent(pt);return at&&(lt+="&userId="+encodeURIComponent(at)),lt})();return qt("/api/periods"+st).catch(function(){return qt("/api/periods"+st.replace("?global=1",""))}).then(function(ot){var pt=ot&&ot.periods||[],lt=pt.filter(function(Ct){return!(Ct.type!==_||at&&String(Ct.userId||Ct.uid||"")!==String(at))}),dt=ht(F),yt=N.map(function(Ct){for(var wt=0,Tt=0;Tt<lt.length;Tt++){var Ft=lt[Tt];if(T(Ct,Ft)){var Pt=B==="previsionale"?Ft.indicatorsPrev||{}:Ft.indicatorsCons||{};wt+=gt(Pt,dt)}}return{x:new Date(Ct.s),y:Math.round(wt*100)/100}});return yt})}function nt(F,B,at){var R=document.getElementById(F);if(R){if(typeof window.drawFullLine=="function"){window.drawFullLine(F,B,at);return}var W=R.getContext("2d");R.width=R.clientWidth||320,R.height=R.clientHeight||80,W.clearRect(0,0,R.width,R.height);var $=Math.max(1,...at),_=at.length>1?(R.width-8)/(at.length-1):0;W.strokeStyle="#2e6cff",W.lineWidth=2,W.beginPath();for(var N=0;N<at.length;N++){var T=4+N*_,gt=R.height-6-at[N]/$*(R.height-12);N===0?W.moveTo(T,gt):W.lineTo(T,gt)}W.stroke()}}function vt(){var F=(document.getElementById("dash_mode")||{}).value||"previsionale",B=a("dash"),at=s(B.type||"mensile"),R=new Date(B.start).getTime(),W=new Date(B.end).getTime(),$=document.getElementById("dash_cons"),_=$?$.value:Jt().id;function N(ot){return ot=Number(ot==null?"":ot),isFinite(ot)?ot:0}function T(ot){if(!ot)return 0;for(var pt=["VSDIndiretto","vsdIndiretto","VSD_indiretto","VSDI"],lt=0;lt<pt.length;lt++)if(ot[pt[lt]]!=null)return N(ot[pt[lt]]);return ot.VSDTotale!=null&&ot.VSDPersonale!=null?N(ot.VSDTotale)-N(ot.VSDPersonale):0}function gt(ot){return ot?ot.TotProvvigioni!=null?N(ot.TotProvvigioni):N(ot.ProvvGI)+N(ot.ProvvVSD):0}var st=(function(){var ot=Ie(new Date(R)),pt=Ie(new Date(W)),lt="?type="+encodeURIComponent(at)+"&from="+encodeURIComponent(ot)+"&to="+encodeURIComponent(pt);return _&&(lt+="&userId="+encodeURIComponent(_)),lt})();return qt("/api/periods"+st).then(function(ot){for(var pt=ot&&ot.periods||[],lt={VSS:0,VSDPersonale:0,VSDIndiretto:0,GI:0,NNCF:0,PROVV:0},dt=0;dt<pt.length;dt++){var yt=pt[dt];if(String(yt.type)===String(at)&&!(_&&String(yt.userId||yt.uid||"")!==String(_))){var Ct=new Date(yt.startDate).getTime(),wt=new Date(yt.endDate).getTime();if(!(Ct<R||wt>W)){var Tt=F==="previsionale"?yt.indicatorsPrev||{}:yt.indicatorsCons||{};lt.VSS+=N(Tt.VSS),lt.VSDPersonale+=N(Tt.VSDPersonale),lt.VSDIndiretto+=T(Tt),lt.GI+=N(Tt.GI),lt.NNCF+=N(Tt.NNCF),lt.PROVV+=gt(Tt)}}}S("kpi_vss",C(lt.VSS)),S("kpi_vsd",C(lt.VSDPersonale)),S("kpi_vsd_ind",C(lt.VSDIndiretto)),S("kpi_gi",C(lt.GI)),S("kpi_nncf",L(lt.NNCF)),S("kpi_provv",C(lt.PROVV))})}function K(){var F=(document.getElementById("dash_mode")||{}).value||"previsionale",B=document.getElementById("dash_cons"),at=B?B.value:Jt().id,R=a("dash"),W=String(R.type||"mensile").toLowerCase(),$=q(W),_=typeof l=="function"?l(W,$):$.map(function(T){return tt(new Date(T.s),W)});function N(T,gt){var st=T.map(function(ot){return ot.y});nt(gt,_,st)}Promise.all([V("VSS",F,at||null,R),V("VSDPersonale",F,at||null,R),V("VSDIndiretto",F,at||null,R),V("GI",F,at||null,R),V("NNCF",F,at||null,R),V("TotProvvigioni",F,at||null,R)]).then(function(T){N(T[0],"d_mini_vss"),N(T[1],"d_mini_vsdpersonale"),N(T[2],"d_mini_vsdindiretto"),N(T[3],"d_mini_gi"),N(T[4],"d_mini_nncf"),N(T[5],"d_mini_provv")}).catch(function(T){logger.error(T)})}function P(){var F=document.getElementById("dash_cons"),B=F?F.value:Jt().id,at=(typeof a=="function"?a("dash"):{})||{},R=typeof s=="function"?s(at.type||"mensile"):at.type||"mensile";(function(){var gt=document.getElementById("lastApps");if(gt){var st=gt.parentElement;if(!document.getElementById("nextApps")){var ot=document.createElement("div");ot.className="card",ot.innerHTML='<b>Prossimi appuntamenti</b><div id="nextApps" style="margin-top:8px"></div>',st.parentElement.insertBefore(ot,st)}}})();function W(T){return'<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px">'+T+"</div>"}function $(T){return T=String(T||"").toLowerCase(),T.indexOf("mezza")>-1?240:T.indexOf("giorn")>-1||T.indexOf("formaz")>-1||T.indexOf("mbs")>-1?570:T.indexOf("sottoprod")>-1?240:T.indexOf("riunione")>-1||T.indexOf("impegni personali")>-1?60:(T.indexOf("vend")>-1,90)}function _(T){var gt=new Date(T.start),st=new Date(T.end);(!(st instanceof Date)||isNaN(st)||st<gt)&&(st=new Date(gt.getTime()+$(T.type||"vendita")*6e4));var ot=Kt(gt)+" "+Xs(gt)+""+(("0"+st.getHours()).slice(-2)+":"+("0"+st.getMinutes()).slice(-2)),pt=T.nncf?"  NNCF ":"",lt=String(T.type||"").toLowerCase(),dt;return lt.indexOf("mbs")>-1?dt="VSD ind "+C(T.vsdIndiretto||0):lt.indexOf("sottoprod")>-1?dt="Tel "+L(T.telefonate||0)+"  AppFissati "+L(T.appFissati||0):lt.indexOf("formaz")>-1?dt="":dt="VSS "+C(T.vss||0)+"  VSD "+C(T.vsdPersonal||0)+pt,'<div class="card lastApp" data-aid="'+z(String(T.id||""))+'" style="cursor:pointer"><div class="small muted">'+z(ot)+"  "+z(T.type||"manuale")+'</div><div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><div><b>'+z(T.client||"")+'</b></div><div class="row" style="gap:6px"><button class="ghost btn-ics" title="Esporta .ics" data-ics="'+z(String(T.id||""))+'"></button></div></div>'+(dt?'<div class="small">'+dt+"</div>":"")+"</div>"}var N=(function(){var T=Ie(new Date(at.start)),gt=Ie(new Date(at.end)),st="?type="+encodeURIComponent(R)+"&from="+encodeURIComponent(T)+"&to="+encodeURIComponent(gt);return B&&(st+="&userId="+encodeURIComponent(B)),st})();Promise.all([qt("/api/appointments"),qt("/api/periods"+N),qt("/api/periods")]).then(function(T){var gt=T[0]&&T[0].appointments||[];T[1]&&T[1].periods;var st=T[2]&&T[2].periods||[];(function(){var pt=document.getElementById("nextApps");if(pt){var lt=new Date,dt=gt.filter(function(yt){var Ct=BPTimezone.parseUTCString(yt.start).getTime(),wt=Ct>=lt.getTime(),Tt=B?String(yt.userId||yt.uid||"")===String(B):!0;return wt&&Tt}).sort(function(yt,Ct){return BPTimezone.parseUTCString(yt.start)-BPTimezone.parseUTCString(Ct.start)}).slice(0,4);pt.innerHTML=dt.length?W(dt.map(_).join("")):'<div class="muted">Nessun prossimo appuntamento</div>',pt.querySelectorAll(".lastApp[data-aid]").forEach(function(yt){yt.addEventListener("click",function(){const Ct=yt.getAttribute("data-aid"),wt=dt.find(Tt=>String(Tt.id)===String(Ct));wt&&(p(),setTimeout(()=>{re(wt),window.scrollTo({top:0,behavior:"smooth"})},100))})}),pt.querySelectorAll("button[data-ics]").forEach(function(yt){yt.addEventListener("click",function(Ct){Ct.stopPropagation();var wt=yt.getAttribute("data-ics"),Tt=dt.find(Ft=>String(Ft.id)===String(wt))||gt.find(Ft=>String(Ft.id)===String(wt));if(!Tt){Nt("Appuntamento non trovato");return}if(window.BP&&BP.ICS&&typeof BP.ICS.downloadIcsForAppointment=="function")if(BP.ICS.downloadIcsForAppointment(Tt)){typeof haptic=="function"&&haptic("medium");try{document.dispatchEvent(new Event("ics:exported"))}catch(Pt){}Nt(".ics esportato")}else Nt("Export .ics non disponibile");else Nt("Export .ics non disponibile")})})}})(),(function(){var pt=document.getElementById("lastApps");if(pt){var lt=gt.filter(function(dt){return B?String(dt.userId||dt.uid||"")===String(B):!0}).sort(function(dt,yt){return new Date(yt.updatedAt||yt.createdAt||yt.start)-new Date(dt.updatedAt||dt.createdAt||dt.start)}).slice(0,4);pt.innerHTML=lt.length?W(lt.map(_).join("")):'<div class="muted">Nessun appuntamento</div>',pt.querySelectorAll(".lastApp[data-aid]").forEach(function(dt){dt.addEventListener("click",function(){const yt=dt.getAttribute("data-aid"),Ct=lt.find(wt=>String(wt.id)===String(yt));Ct&&(p(),setTimeout(()=>{re(Ct),window.scrollTo({top:0,behavior:"smooth"})},100))})}),pt.querySelectorAll("button[data-ics]").forEach(function(dt){dt.addEventListener("click",function(yt){yt.stopPropagation();var Ct=dt.getAttribute("data-ics"),wt=lt.find(Tt=>String(Tt.id)===String(Ct))||gt.find(Tt=>String(Tt.id)===String(Ct));if(!wt){Nt("Appuntamento non trovato");return}if(window.BP&&BP.ICS&&typeof BP.ICS.downloadIcsForAppointment=="function")if(BP.ICS.downloadIcsForAppointment(wt)){typeof haptic=="function"&&haptic("medium");try{document.dispatchEvent(new Event("ics:exported"))}catch(Ft){}Nt(".ics esportato")}else Nt("Export .ics non disponibile");else Nt("Export .ics non disponibile")})})}})(),(function(){var pt=document.getElementById("dash_bp_sent");if(!pt)return;function lt(Pt,At){At=At||new Date;var te=At.getFullYear();if(Pt==="settimanale"){var Yt=wn(te,De(At));return{start:Yt.start,end:Yt.end}}return Pt==="mensile"?{start:di(At),end:Xi(At)}:Pt==="trimestrale"?{start:Kn(At),end:Ki(At)}:Pt==="semestrale"?{start:Jn(At),end:Ji(At)}:{start:vi(At),end:bi(At)}}var dt=st.filter(function(Pt){return!(B&&String(Pt.userId||Pt.uid||"")!==String(B))});function yt(Pt,At,te){return dt.find(function(Yt){return Yt.type===Pt&&Ie(Yt.startDate)===Ie(At)&&Ie(Yt.endDate)===Ie(te)})}var Ct=new Date,wt="";["settimanale","mensile","trimestrale","semestrale","annuale"].forEach(function(Pt){var At=lt(Pt,Ct),te=yt(Pt,At.start,At.end);te&&(wt+='<div class="card" style="flex:1 1 360px"><div><b>'+z(pn(Pt,At.start))+'</b></div><div class="small muted">'+Kt(At.start)+"  "+Kt(At.end)+'</div><div class="right" style="margin-top:6px"><button class="ghost" type="button" data-edit="'+te.id+'">Modifica previs.</button><button type="button" data-cons="'+te.id+'">Consuntivo</button></div></div>')}),pt.innerHTML=wt||'<div class="muted">Nessun BP in essere</div>',pt.querySelectorAll("[data-edit]").forEach(function(Pt){Pt.addEventListener("click",function(){var At=Pt.getAttribute("data-edit"),te=dt.find(function(Yt){return String(Yt.id)===At});if(te){try{Xn("bp_open_period",{id:At,mode:!1})}catch(Yt){}u()}})}),pt.querySelectorAll("[data-cons]").forEach(function(Pt){Pt.addEventListener("click",function(){var At=Pt.getAttribute("data-cons"),te=dt.find(function(Yt){return String(Yt.id)===At});if(te){try{Xn("bp_open_period",{id:At,mode:!0})}catch(Yt){}u()}})});var Tt=document.getElementById("dash_bp_sent_head"),Ft=document.getElementById("dash_bp_sent_chev");Tt&&Ft&&(Tt.onclick=function(){var Pt=pt.classList.contains("open");Pt?(pt.classList.remove("open"),Ft.textContent="",Ft.style.transform="rotate(0deg)"):(pt.classList.add("open"),Ft.textContent="",Ft.style.transform="rotate(90deg)")})})()}).catch(function(T){logger.error(T)})}o("dash",function(){typeof haptic=="function"&&haptic("light"),vt(),K(),P()});var et=document.getElementById("dash_mode");et&&(et.onchange=function(){typeof haptic=="function"&&haptic("light"),vt(),K(),P()});var J=document.getElementById("dash_cons");J&&(J.onchange=function(){typeof haptic=="function"&&haptic("light"),vt(),K(),P()}),vt(),K(),P(),typeof kickFinal=="function"&&kickFinal("dashboard")}function d(){if(!Jt())return t();document.title="Battle Plan  Calendario",Ge("viewCalendar");const m=Jt().role==="admin";function g(J){return Xs(J)}if(!document.getElementById("cal_dynamic_css")){var S='\n      /* ============== CALENDAR ============== */\n      #cal_container{ overflow-x:auto; -webkit-overflow-scrolling:touch; }\n      #cal_container .calendar{ min-width: 860px; }\n\n      .calendar{ display:grid; grid-template-columns: 44px repeat(7, 1fr); gap:10px; }\n      .calendar .weekLabel{ color:var(--muted); font-size:12px; display:flex; align-items:center; justify-content:center; }\n\n      .calendar .day{\n        min-height:120px; background: var(--card);\n        border:2px solid var(--hair2); border-radius:14px; padding:8px;\n        display:flex; flex-direction:column; gap:3px; overflow:hidden;\n      }\n      .calendar .day.today{\n        outline: 2px solid var(--accent);\n        box-shadow: 0 0 0 2px rgba(0,0,0,.06) inset;\n      }\n      .calendar .day .dnum{ font-weight:800; }\n      .calendar .day .small{\n        font-size:12px; line-height:1.15;\n        white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:100%;\n      }\n      .calendar .day .tag{ padding:2px 6px; border-radius:999px; border:1px solid var(--hair2); font-size:11px; align-self:flex-start; }\n      .calendar .day.busy0{ border-color:#27ae60; background:rgba(39,174,96,.08); }\n      .calendar .day.busy1{ border-color:#ff9f1a; background:rgba(255,159,26,.10); }\n      .calendar .day.busy2{ border-color:#7d1731; background:rgba(125,23,49,.12); }\n      .calendar .day.dense .small{ font-size:11px; line-height:1.1; }\n      .calendar .day.dense .tag{ transform:scale(.9); transform-origin:left top; }\n\n      @media (max-width: 900px){\n        .calendar{ grid-template-columns: 36px repeat(7, 1fr); }\n        .calendar .weekLabel{ display:flex !important; font-size:11px; }\n        .calendar .day{ min-height:92px; padding:6px; }\n        .calendar .day .dnum{ font-size:16px; }\n        .calendar .day .small{ white-space: normal !important; overflow: visible !important; text-overflow: clip !important; }\n        .calendar .day.dense .small{ font-size:clamp(9px,2.4vw,11px); }\n        .calendar .day .tag{ font-size:10px; }\n      }\n\n      /* Header filters alignment (desktop + mobile) */\n      #cal_controls{\n        display:flex;\n        flex-direction:column;\n        gap:10px;\n      }\n      #cal_controls .cal-row{\n        display:flex;\n        gap:10px;\n        align-items:flex-end;\n      }\n      #cal_controls .cal-row > *{ flex:1 1 0; }\n      #cal_controls button{ flex:0 0 auto; }\n      .cal-filters{ display:flex; align-items:flex-end; gap:8px; flex-wrap:wrap; }\n      .cal-filters .chip{\n        display:inline-flex; align-items:center; gap:6px;\n        padding:6px 10px; border-radius:999px; border:1px solid var(--hair2);\n      }\n      .cal-filters .chip input[type=checkbox]{ width:16px; height:16px; }\n      @media (max-width: 600px){\n        #cal_controls{\n          display:grid;\n          grid-template-columns: 1fr 1fr 1fr;\n          grid-template-areas:\n            "consult consult consult"\n            "prev month next"\n            "add add add"\n            "free free free"\n            "fourh refresh refresh";\n          align-items:end;\n        }\n        #cal_controls .cal-row{ display:contents; }\n        #cal_consultant_wrap{ grid-area:consult; }\n        #cal_prev{ grid-area:prev; justify-self:start; }\n        #cal_month_wrap{ grid-area:month; }\n        #cal_next{ grid-area:next; }\n        #cal_add{ grid-area:add; justify-self:start; }\n        #only_free{ grid-area:free; }\n        #only_4h{ grid-area:fourh; }\n        #cal_refresh{ grid-area:refresh; justify-self:end; }\n        .cal-filters{ align-items:center; }\n\n        /* Force chips to occupy full width to avoid overlap */\n        #only_free, #only_4h{\n          display:flex !important;\n          width:100% !important;\n          min-width:0 !important;\n          align-items:center;\n        }\n        /* Ensure chips span all columns when areas fallback */\n        #only_free, #only_4h{ grid-column: 1 / -1; }\n        /* Allow buttons to shrink within grid cells */\n        #cal_prev, #cal_next, #cal_add, #cal_refresh{ min-width:0; }\n      }\n      \n      /* Modern Results Grid */\n      .cal-results-grid {\n        display: grid;\n        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));\n        gap: 12px;\n        margin-top: 8px;\n      }\n      \n      .cal-result-pill {\n        background: linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.04));\n        border: 1px solid var(--hair2);\n        border-radius: 12px;\n        padding: 12px 16px;\n        text-align: center;\n        transition: all 0.2s ease;\n        backdrop-filter: blur(10px);\n      }\n      \n      .cal-result-pill:hover {\n        border-color: var(--accent);\n        box-shadow: 0 4px 16px rgba(93,211,255,.1);\n        transform: translateY(-2px);\n      }\n      \n      .cal-result-label {\n        font-size: 11px;\n        color: var(--muted);\n        text-transform: uppercase;\n        letter-spacing: 0.5px;\n        margin-bottom: 4px;\n        font-weight: 600;\n      }\n      \n      .cal-result-value {\n        font-size: 14px;\n        color: var(--text);\n        font-weight: 700;\n        line-height: 1.2;\n      }\n      \n      @media (max-width: 768px) {\n        .cal-results-grid {\n          grid-template-columns: repeat(2, 1fr);\n          gap: 8px;\n        }\n        \n        .cal-result-pill {\n          padding: 10px 12px;\n        }\n        \n        .cal-result-label {\n          font-size: 10px;\n        }\n        \n        .cal-result-value {\n          font-size: 13px;\n        }\n      }\n      \n      /* BP Form Grid - Responsive layout for indicators */\n      #p_rows {\n        display: grid;\n        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));\n        gap: 16px;\n        margin-top: 12px;\n      }\n      \n      #p_rows .row {\n        background: linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.03));\n        border: 1px solid var(--hair2);\n        border-radius: 12px;\n        padding: 16px;\n        transition: all 0.2s ease;\n        backdrop-filter: blur(10px);\n      }\n      \n      #p_rows .row:hover {\n        border-color: var(--accent);\n        box-shadow: 0 4px 16px rgba(93,211,255,.1);\n        transform: translateY(-2px);\n      }\n      \n      #p_rows .row > div {\n        margin-bottom: 12px;\n      }\n      \n      #p_rows .row > div:last-child {\n        margin-bottom: 0;\n      }\n      \n      #p_rows .row label {\n        font-weight: 600;\n        color: var(--accent);\n        margin-bottom: 6px;\n        font-size: 12px;\n        text-transform: uppercase;\n        letter-spacing: 0.5px;\n        display: block;\n      }\n      \n      #p_rows .row input {\n        width: 100%;\n        background: rgba(255,255,255,.05);\n        border: 1px solid var(--hair2);\n        border-radius: 8px;\n        padding: 10px 12px;\n        color: var(--text);\n        font-size: 14px;\n        transition: all 0.2s ease;\n      }\n      \n      #p_rows .row input:focus {\n        border-color: var(--accent);\n        box-shadow: 0 0 0 3px rgba(93,211,255,.1);\n        background: rgba(255,255,255,.08);\n        outline: none;\n      }\n      \n      #p_rows .row input::placeholder {\n        color: var(--muted);\n      }\n      \n      @media (max-width: 768px) {\n        #p_rows {\n          grid-template-columns: 1fr;\n          gap: 12px;\n        }\n      }\n      \n      /* BP Inviati Grid - 4 columns like dashboard */\n      #bp_sent {\n        display: grid;\n        grid-template-columns: repeat(4, 1fr);\n        gap: 16px;\n        margin-top: 8px;\n      }\n      \n      #bp_sent .card {\n        background: linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.03));\n        border: 1px solid var(--hair2);\n        border-radius: 12px;\n        padding: 16px;\n        transition: all 0.2s ease;\n        backdrop-filter: blur(10px);\n      }\n      \n      #bp_sent .card:hover {\n        border-color: var(--accent);\n        box-shadow: 0 4px 16px rgba(93,211,255,.1);\n        transform: translateY(-2px);\n      }\n      \n      @media (max-width: 1200px) {\n        #bp_sent {\n          grid-template-columns: repeat(3, 1fr);\n        }\n      }\n      \n      @media (max-width: 900px) {\n        #bp_sent {\n          grid-template-columns: repeat(2, 1fr);\n        }\n      }\n      \n      @media (max-width: 768px) {\n        #bp_sent {\n          grid-template-columns: 1fr;\n          gap: 12px;\n        }\n      }\n    ',C=document.createElement("style");C.id="cal_dynamic_css",C.textContent=S,document.head.appendChild(C)}var L=new Date,z=Ie(di(L)).slice(0,7),tt=m?'<div id="cal_consultant_wrap"><label>Consulente</label><select id="cal_consultant"></select></div>':"";n.innerHTML=$e()+'<div class="wrap"><div class="card"><div id="cal_controls"><div class="cal-row">'+tt+'<button id="cal_prev" class="ghost" title="Mese precedente"></button><div id="cal_month_wrap"><label>Mese</label><input type="month" id="cal_month" value="'+z+'"></div><button id="cal_next" class="ghost" title="Mese successivo"></button></div><div class="cal-row cal-filters"><button id="cal_add" class="ghost">Aggiungi appuntamento</button><label id="only_free" class="chip small"><input type="checkbox" id="only_free_cb"> Solo giorni liberi</label> <label id="only_4h" class="chip small"><input type="checkbox" id="only_4h_cb"> Solo slot  4h</label><button id="cal_refresh" class="ghost">Aggiorna</button></div></div></div><div id="cal_container"></div><div id="cal_results" class="card" style="margin-top:8px;display:none"></div><div id="cal_day_box" class="card" style="margin-top:8px;display:none"></div><div class="card" id="cal_free_slots" style="margin-top:8px;display:none"></div></div>',Oe();var q=document.getElementById("cal_consultant");function ht(){if(q){var J=Jt()||{};q.innerHTML='<option value="'+Mt(J.id||"")+'">'+Mt(J.name||"")+"</option>",qt("/api/users").then(function(F){var B=F.users||[],at="";if(J.role==="admin"){at+='<option value="all">Tutti</option>';for(var R=0;R<B.length;R++){var W=B[R];at+='<option value="'+Mt(W.id)+'">'+Mt(W.name||W.email||W.id)+"</option>"}}q.innerHTML=at,q.value=J.id}).catch(function(){q.innerHTML='<option value="'+Mt(J.id||"")+'">'+Mt(J.name||"")+"</option>"})}}q&&ht();function V(J,F,B,at){var R="/api/appointments",W="/api/availability?from="+J+"-"+rn(F)+"-01&to="+J+"-"+rn(F)+"-"+rn(new Date(J,F,0).getDate());at==="all"?(R+="?global=1",W+="&global=1"):at&&at!==Jt().id&&(R+="?user="+at,W+="&user="+at),Promise.all([qt(R),qt(W)]).then(function($){var _=$[0]&&$[0].appointments?$[0].appointments:[],N=$[1]||{slots:[]},T=N.slots||[],gt=new Date(J,F-1,1),st=new Date(J,F,0,23,59,59,999);function ot(le,Pe){for(var ee={vss:0,vsd:0,vsdI:0,telefonate:0,appFissati:0,nncf:0,count:0},he=0;he<_.length;he++){var pe=_[he],He=BPTimezone.parseUTCString(pe.start);if(He>=le&&He<=Pe){ee.vss+=Number(pe.vss||0),ee.vsd+=Number(pe.vsdPersonal||0),ee.vsdI+=Number(pe.vsdIndiretto||0),ee.telefonate+=Number(pe.telefonate||0),ee.appFissati+=Number(pe.appFissati||0),ee.nncf+=pe.nncf?1:0;var ye=String(pe.type||"").toLowerCase();(ye.indexOf("vend")>-1||ye.indexOf("mezza")>-1||ye.indexOf("giorn")>-1)&&(ee.count+=1)}}return ee}function pt(le,Pe,ee){var he=document.getElementById("cal_results");if(he){var pe=ee?'<div class="right"><button id="res_reset" class="ghost">Torna al mese</button></div>':"";if(he.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><b style="color:var(--text);font-size:16px">Risultati  '+Pe+"</b>"+pe+'</div><div class="cal-results-grid"><div class="cal-result-pill"><div class="cal-result-label">VSS</div><div class="cal-result-value">'+$t(le.vss)+'</div></div><div class="cal-result-pill"><div class="cal-result-label">VSD</div><div class="cal-result-value">'+$t(le.vsd)+'</div></div><div class="cal-result-pill"><div class="cal-result-label">VSD ind</div><div class="cal-result-value">'+$t(le.vsdI)+'</div></div><div class="cal-result-pill"><div class="cal-result-label">Tel</div><div class="cal-result-value">'+Be(le.telefonate)+'</div></div><div class="cal-result-pill"><div class="cal-result-label">AppFiss</div><div class="cal-result-value">'+Be(le.appFissati)+'</div></div><div class="cal-result-pill"><div class="cal-result-label">NNCF</div><div class="cal-result-value">'+Be(le.nncf)+'</div></div><div class="cal-result-pill"><div class="cal-result-label">N. app</div><div class="cal-result-value">'+Be(le.count)+"</div></div></div>",he.style.display="block",ee){var He=document.getElementById("res_reset");He&&(He.onclick=function(){pt(ot(gt,st),Pt,!1)})}}}for(var lt={},dt=0;dt<_.length;dt++){var yt=_[dt],Ct=BPTimezone.parseUTCString(yt.start);if(!(Ct<gt||Ct>st)){var wt=Ie(Ct);lt[wt]||(lt[wt]={vss:0,vsd:0,vsdI:0,telefonate:0,appFissati:0,nncf:0,mins:0,count:0,salesCount:0,items:[]}),lt[wt].vss+=Number(yt.vss||0),lt[wt].vsd+=Number(yt.vsdPersonal||0),lt[wt].vsdI+=Number(yt.vsdIndiretto||0),lt[wt].telefonate+=Number(yt.telefonate||0),lt[wt].appFissati+=Number(yt.appFissati||0),lt[wt].nncf+=yt.nncf?1:0,lt[wt].mins+=Number(yt.durationMinutes||0),lt[wt].count+=1;var Tt=String(yt.type||"").toLowerCase();(Tt.indexOf("vend")>-1||Tt.indexOf("mezza")>-1||Tt.indexOf("giorn")>-1)&&(lt[wt].salesCount+=1),lt[wt].items.push(yt)}}var Ft=["Lun","Mar","Mer","Gio","Ven","Sab","Dom"],Pt=new Date(J,F-1,1).toLocaleString("it-IT",{month:"long",year:"numeric"}),At='<div class="card"><b class="neon">'+Pt+"</b></div>";At+='<div class="calendar">',At+='<div class="weekLabel">W</div>';for(var te=0;te<7;te++)At+='<div class="weekLabel">'+Ft[te]+"</div>";var Yt=new Date(J,F-1,1),Et=(Yt.getDay()+6)%7,bt=new Date(Yt);bt.setDate(Yt.getDate()-Et);for(var Dt=0;Dt<6;Dt++){var G=new Date(bt),mt="W"+De(G);At+='<div class="weekLabel" data-ws="'+Ie(G)+'" style="cursor:pointer">'+mt+"</div>";for(var Rt=0;Rt<7;Rt++){var jt=bt.getMonth()===F-1,wt=Ie(bt),zt=lt[wt]||{vss:0,vsd:0,vsdI:0,telefonate:0,appFissati:0,nncf:0,mins:0,count:0,items:[]},Qt=bt.getDay(),Bt=Qt===0||Qt===6,Lt=!Bt&&T.some(function(Pe){return Pe.date===wt});if(jt&&B){if(B.only_free&&zt.count>0){At+="<div></div>",bt.setDate(bt.getDate()+1);continue}if(B.only_4h&&!Lt){At+="<div></div>",bt.setDate(bt.getDate()+1);continue}}if(!jt)At+="<div></div>";else{var Ht="";Bt?zt.count>0&&(Ht="busy2"):zt.count===0?Ht="busy0":Lt?Ht="busy1":Ht="busy2";var j="",Z=0;Bt&&zt.count===0||(zt.vss>0&&(j+='<div class="small">VSS '+$t(zt.vss)+"</div>",Z++),zt.vsd>0&&(j+='<div class="small">VSD '+$t(zt.vsd)+"</div>",Z++),zt.vsdI>0&&(j+='<div class="small">VSD ind '+$t(zt.vsdI)+"</div>",Z++),zt.telefonate>0&&(j+='<div class="small">Tel '+Be(zt.telefonate)+"</div>",Z++),zt.appFissati>0&&(j+='<div class="small">AppFiss '+Be(zt.appFissati)+"</div>",Z++),zt.nncf>0&&(j+='<div class="small">NNCF '+Be(zt.nncf)+"</div>",Z++),zt.count>0&&(j+='<div class="small">App. '+Be(zt.count)+"</div>",Z++),Lt&&(j+='<div class="tag" style="margin-top:4px">slot 4h</div>',Z++));var xt=Z>=3?" dense":"",kt=Lt?" slot-free":"";At+='<div class="day '+Ht+xt+kt+'" data-day="'+wt+'" title="Settimana '+De(bt)+'"><div class="dnum">'+bt.getDate()+"</div>"+(j||"")+"</div>"}bt.setDate(bt.getDate()+1)}}At+="</div>",document.getElementById("cal_container").innerHTML=At,pt(ot(gt,st),Pt,!1),document.querySelectorAll(".calendar .weekLabel[data-ws]").forEach(function(le){le.addEventListener("click",function(){var Pe=le.getAttribute("data-ws"),ee=new Date(Pe),he=new Date(ee);he.setDate(he.getDate()+6),he.setHours(23,59,59,999);var pe="Settimana "+("W"+De(ee))+"  "+Kt(ee)+""+Kt(he);pt(ot(ee,he),pe,!0)})}),document.querySelectorAll(".day[data-day]").forEach(function(le){le.addEventListener("click",function(){var Pe=le.getAttribute("data-day"),ee=lt[Pe]&&lt[Pe].items?lt[Pe].items.slice():[];ee.sort(function(oe,we){return BPTimezone.parseUTCString(oe.start)-BPTimezone.parseUTCString(we.start)});var he=document.getElementById("cal_day_box"),pe="<b>Appuntamenti del "+Pe.split("-").reverse().join("/")+"</b>";if(!ee.length)pe+='<div class="muted" style="margin-top:6px">Nessun appuntamento</div>';else{pe+='<div class="row" style="margin-top:8px">';for(var He=0;He<ee.length;He++){var ye=ee[He],Eo=' data-start="'+ye.start+'" data-end="'+ye.end+'" data-title="'+Mt(ye.client||"Appuntamento")+'" ',ni=String(ye.type||"").toLowerCase(),xn;ni.indexOf("mbs")>-1?xn="VSD ind "+$t(ye.vsdIndiretto||0):ni.indexOf("sottoprod")>-1?xn="Tel "+Be(ye.telefonate||0)+"  AppFissati "+Be(ye.appFissati||0):ni.indexOf("formaz")>-1?xn="":xn="VSS "+$t(ye.vss)+"  VSD "+$t(ye.vsdPersonal)+"  NNCF "+(ye.nncf?"":""),pe+='<div class="card cal-app" data-aid="'+ye.id+'" '+Eo+' style="flex:1 1 320px;cursor:pointer"><div class="small muted">'+g(ye.start)+""+g(ye.end)+"  "+Mt(ye.type||"")+"</div><div><b>"+Mt(ye.client||"")+"</b></div>"+(xn?'<div class="small">'+xn+"</div>":"")+(ye.notes?'<div class="small muted">'+Mt(ye.notes)+"</div>":"")+"</div>"}pe+="</div>"}var Io=(T||[]).filter(function(oe){return oe.date===Pe}),ii=Io.filter(function(oe){var we=new Date(oe.start),xe=new Date(oe.end),je=_.some(function(dn){var Do=new Date(dn.start),al=new Date(dn.end||dn.start);return we<al&&xe>Do});return!je});if(ii.length){pe+='<div class="row" style="margin-top:8px">';for(var oi=0;oi<ii.length;oi++){var Pn=ii[oi],$n=Pn.part==="morning"?"mattina":"pomeriggio";pe+='<div class="card slotBtn" data-start="'+Pn.start+'" data-end="'+Pn.end+'" style="flex:1 1 280px;cursor:pointer"><div class="small">'+$n+"  "+g(Pn.start)+""+g(Pn.end)+"</div></div>"}pe+="</div>"}if(he.style.display="block",he.innerHTML=pe,he.querySelectorAll(".cal-app").forEach(function(oe){oe.addEventListener("click",function(we){we.stopPropagation();const xe=oe.getAttribute("data-aid"),je=ee.find(dn=>String(dn.id)===String(xe));je&&(p(),setTimeout(()=>{re(je),window.scrollTo({top:0,behavior:"smooth"})},100))})}),he.querySelectorAll(".slotBtn").forEach(function(oe){oe.addEventListener("click",function(we){we.stopPropagation(),Xn("bp_prefill_slot",{start:oe.getAttribute("data-start"),end:oe.getAttribute("data-end")}),p(),Nt("Slot precompilato negli appuntamenti")})}),window.scrollTo({top:he.getBoundingClientRect().top+window.scrollY-80,behavior:"smooth"}),typeof window.wireICSInsideDayBox=="function")try{window.wireICSInsideDayBox()}catch(oe){}})});var _t=document.getElementById("cal_free_slots"),Gt=(function(){var le=new Date;return le.getFullYear()+"-"+rn(le.getMonth()+1)+"-"+rn(le.getDate())})(),Wt=(T||[]).filter(function(le){return String(le.date||"").slice(0,10)>=Gt});if(at==="all"){var ue=N.details||[],se="<b>Slot liberi  4h per consulente (da oggi in poi)</b>";se+='<div class="cal-results-grid" style="margin-top:16px">';for(var Ee=0;Ee<ue.length;Ee++){var bt=ue[Ee];se+='<div class="cal-result-pill"><div class="cal-result-label">'+Mt(bt.name||"")+'</div><div class="cal-result-value">'+Be(bt.total||0)+"</div></div>"}se+="</div>",_t.style.display="block",_t.innerHTML=se}else if(Wt.length){var Ue='<b>Slot liberi  4h (da oggi in poi)</b>  <span class="badge">Tot: '+Wt.length+"</span>";Ue+='<div class="row" style="margin-top:8px">';for(var cn=0;cn<Wt.length&&cn<80;cn++){var Ct=Wt[cn],Yn=Ct.part==="morning"?"mattina":"pomeriggio";Ue+='<div class="card slotBtn" data-start="'+Ct.start+'" data-end="'+Ct.end+'" style="flex:1 1 280px;cursor:pointer"><div class="small"><b>'+Kt(Ct.start)+"</b>  "+Yn+'</div><div class="small">'+g(Ct.start)+""+g(Ct.end)+"</div></div>"}Ue+="</div>",_t.style.display="block",_t.innerHTML=Ue,_t.querySelectorAll(".slotBtn").forEach(function(le){le.addEventListener("click",function(){Xn("bp_prefill_slot",{start:le.getAttribute("data-start"),end:le.getAttribute("data-end")}),p(),Nt("Slot precompilato negli appuntamenti")})})}else _t.style.display="block",_t.innerHTML='<b>Slot liberi  4h (da oggi in poi)</b>  <span class="badge">Tot: 0</span><div class="muted" style="margin-top:6px">Nessuno slot libero disponibile.</div>';try{window.injectTodayCSS&&window.injectTodayCSS()}catch(le){}try{window.hookCalendar?window.hookCalendar():(window.markToday&&window.markToday(),window.clampSlotCounters&&window.clampSlotCounters())}catch(le){}}).catch(function($){logger.error($),Nt("Errore calendario")})}function nt(){var J=document.getElementById("cal_month").value,F=parseInt(J.split("-")[0],10),B=parseInt(J.split("-")[1],10),at={only_free:document.getElementById("only_free_cb").checked,only_4h:document.getElementById("only_4h_cb").checked},R=document.getElementById("cal_consultant"),W=R?R.value:Jt().id;V(F,B,at,W)}document.getElementById("cal_refresh").onclick=nt;var vt=document.getElementById("cal_add");vt&&(vt.onclick=function(){p()}),document.getElementById("cal_month").onchange=nt;function K(J){var F=document.getElementById("cal_month");if(F){var B=F.value.split("-"),at=+B[0],R=+B[1];R+=J,R<=0?(R=12,at--):R>12&&(R=1,at++),F.value=at+"-"+rn(R),nt()}}var P=document.getElementById("cal_prev"),et=document.getElementById("cal_next");P&&(P.onclick=function(){K(-1)}),et&&(et.onclick=function(){K(1)}),document.getElementById("only_free_cb").onchange=nt,document.getElementById("only_4h_cb").onchange=nt,q&&(q.onchange=nt),nt()}function u(){if(!Jt())return t();if(document.title="Battle Plan  BP",Ge("viewPeriods"),!document.getElementById("bp_modern_css")){const j=document.createElement("style");j.id="bp_modern_css",j.textContent='\n      /* ============== MODERN BP DESIGN ============== */\n      .bp-wrap {\n        max-width: 1200px;\n        margin: 0 auto;\n        padding: 0 20px;\n        margin-top: calc(56px + env(safe-area-inset-top) + 32px);\n      }\n      \n      /* Modern BP Cards */\n      .bp-card {\n        background: linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.04));\n        border: 1px solid var(--hair2);\n        border-radius: 16px;\n        padding: 20px;\n        margin-bottom: 20px;\n        backdrop-filter: blur(10px);\n        box-shadow: 0 4px 16px rgba(0,0,0,.08);\n        transition: all 0.2s ease;\n        position: relative;\n        overflow: hidden;\n      }\n      \n      .bp-card:hover {\n        border-color: var(--accent);\n        box-shadow: 0 8px 24px rgba(0,0,0,.12);\n        transform: translateY(-2px);\n      }\n      \n      .bp-card::before {\n        content: "";\n        position: absolute;\n        top: 0;\n        left: 0;\n        right: 0;\n        height: 3px;\n        background: linear-gradient(90deg, var(--accent), var(--accent2));\n        border-radius: 16px 16px 0 0;\n      }\n      \n      .bp-card b {\n        font-size: 16px;\n        font-weight: 700;\n        color: var(--text);\n        margin-bottom: 16px;\n        display: block;\n        position: relative;\n        padding-left: 12px;\n      }\n      \n      .bp-card b::before {\n        content: "";\n        position: absolute;\n        left: 0;\n        top: 50%;\n        transform: translateY(-50%);\n        width: 4px;\n        height: 16px;\n        background: linear-gradient(180deg, var(--accent), var(--accent2));\n        border-radius: 2px;\n      }\n      \n      /* Modern Form Layout */\n      .bp-form-grid {\n        display: grid;\n        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n        gap: 16px;\n        margin-top: 16px;\n      }\n      \n      .bp-form-group {\n        display: flex;\n        flex-direction: column;\n      }\n      \n      .bp-form-group label {\n        font-weight: 600;\n        color: var(--accent);\n        margin-bottom: 6px;\n        font-size: 12px;\n        text-transform: uppercase;\n        letter-spacing: 0.5px;\n      }\n      \n      .bp-form-group input, .bp-form-group select {\n        background: rgba(255,255,255,.05);\n        border: 1px solid var(--hair2);\n        border-radius: 8px;\n        padding: 10px 12px;\n        color: var(--text);\n        transition: all 0.2s ease;\n        font-size: 14px;\n      }\n      \n      .bp-form-group input:focus, .bp-form-group select:focus {\n        border-color: var(--accent);\n        box-shadow: 0 0 0 3px rgba(93,211,255,.1);\n        background: rgba(255,255,255,.08);\n        outline: none;\n      }\n      \n      /* Modern Buttons */\n      .bp-button {\n        background: rgba(255,255,255,.05);\n        border: 1px solid var(--hair2);\n        border-radius: 8px;\n        padding: 10px 16px;\n        color: var(--text);\n        font-weight: 500;\n        transition: all 0.2s ease;\n        cursor: pointer;\n        font-size: 14px;\n      }\n      \n      .bp-button:hover {\n        background: var(--accent);\n        border-color: var(--accent);\n        color: #fff;\n        transform: translateY(-1px);\n      }\n      \n      .bp-button.primary {\n        background: linear-gradient(135deg, var(--accent), var(--accent2));\n        color: #fff;\n        border-color: var(--accent);\n        box-shadow: 0 4px 12px rgba(93,211,255,.3);\n      }\n      \n      .bp-button.primary:hover {\n        box-shadow: 0 6px 16px rgba(93,211,255,.4);\n        transform: translateY(-2px);\n      }\n      \n      /* Modern Grid for BP Items */\n      .bp-grid {\n        display: grid;\n        gap: 12px;\n        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));\n        margin-top: 16px;\n      }\n      \n      .bp-item {\n        background: linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.03));\n        border: 1px solid var(--hair2);\n        border-radius: 12px;\n        padding: 16px;\n        transition: all 0.2s ease;\n        backdrop-filter: blur(10px);\n      }\n      \n      .bp-item:hover {\n        border-color: var(--accent);\n        box-shadow: 0 4px 16px rgba(93,211,255,.1);\n        transform: translateY(-2px);\n      }\n      \n      /* Accordion Header */\n      .bp-accordion-header {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        cursor: pointer;\n        padding: 12px 0;\n        transition: all 0.2s ease;\n        border-radius: 8px;\n      }\n      \n      .bp-accordion-header:hover {\n        background: rgba(93,211,255,.05);\n        padding-left: 8px;\n        padding-right: 8px;\n      }\n      \n      .bp-accordion-chevron {\n        transition: transform 0.2s ease;\n        font-size: 14px;\n        color: var(--accent);\n      }\n      \n      .bp-accordion-content {\n        margin-top: 16px;\n        display: none;\n      }\n      \n      .bp-accordion-content.open {\n        display: block;\n        animation: slideDown 0.3s ease;\n      }\n      \n      @keyframes slideDown {\n        from { opacity: 0; transform: translateY(-10px); }\n        to { opacity: 1; transform: translateY(0); }\n      }\n      \n      /* Status Labels */\n      .bp-status {\n        display: inline-block;\n        padding: 4px 8px;\n        border-radius: 12px;\n        font-size: 11px;\n        font-weight: 600;\n        text-transform: uppercase;\n        letter-spacing: 0.5px;\n      }\n      \n      .bp-status.suggested {\n        background: rgba(39,174,96,.2);\n        color: #27ae60;\n        border: 1px solid rgba(39,174,96,.3);\n      }\n      \n      .bp-status.sent {\n        background: rgba(93,211,255,.2);\n        color: var(--accent);\n        border: 1px solid rgba(93,211,255,.3);\n      }\n      \n      /* Mode Indicator */\n      .bp-mode-indicator {\n        display: inline-flex;\n        align-items: center;\n        gap: 8px;\n        padding: 6px 12px;\n        background: rgba(255,255,255,.05);\n        border: 1px solid var(--hair2);\n        border-radius: 12px;\n        font-size: 12px;\n        font-weight: 500;\n        color: var(--text);\n      }\n      \n      .bp-mode-indicator.active {\n        background: var(--accent);\n        color: #fff;\n        border-color: var(--accent);\n      }\n      \n      /* Action Buttons Container */\n      .bp-actions {\n        display: flex;\n        gap: 12px;\n        margin-top: 20px;\n        flex-wrap: wrap;\n        align-items: center;\n        justify-content: space-between;\n      }\n      \n      /* Responsive Design */\n      @media (max-width: 768px) {\n        .bp-wrap {\n          padding: 0 16px;\n          margin-top: calc(56px + env(safe-area-inset-top) + 16px);\n        }\n        \n        .bp-card {\n          padding: 16px;\n          margin-bottom: 16px;\n        }\n        \n        .bp-form-grid {\n          grid-template-columns: 1fr;\n          gap: 12px;\n        }\n        \n        .bp-grid {\n          grid-template-columns: 1fr;\n          gap: 8px;\n        }\n        \n        .bp-actions {\n          gap: 8px;\n          flex-direction: column;\n          align-items: stretch;\n        }\n        \n        .bp-actions .right {\n          margin-left: 0;\n          width: 100%;\n        }\n        \n        .bp-actions .right button {\n          width: 100%;\n        }\n      }\n      \n      @media (max-width: 480px) {\n        .bp-wrap {\n          padding: 0 12px;\n        }\n        \n        .bp-card {\n          padding: 12px;\n        }\n        \n        .bp-form-grid {\n          gap: 8px;\n        }\n      }\n      \n      /* Modern Indicator Cards Layout */\n      #p_rows {\n        display: grid;\n        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));\n        gap: 20px;\n        margin-top: 16px;\n      }\n      \n      .indicator-card {\n        background: linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.04));\n        border: 1px solid var(--hair2);\n        border-radius: 16px;\n        padding: 20px;\n        transition: all 0.3s ease;\n        backdrop-filter: blur(10px);\n        box-shadow: 0 4px 16px rgba(0,0,0,.08);\n      }\n      \n      .indicator-card:hover {\n        border-color: var(--accent);\n        box-shadow: 0 8px 24px rgba(0,0,0,.12);\n        transform: translateY(-2px);\n      }\n      \n      .indicator-header {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        margin-bottom: 16px;\n        padding-bottom: 12px;\n        border-bottom: 1px solid rgba(255,255,255,.1);\n      }\n      \n      .indicator-header h4 {\n        margin: 0;\n        font-size: 16px;\n        font-weight: 700;\n        color: var(--text);\n        text-transform: uppercase;\n        letter-spacing: 0.5px;\n      }\n      \n      .indicator-progress {\n        display: flex;\n        align-items: center;\n        gap: 8px;\n      }\n      \n      .progress-bar {\n        width: 60px;\n        height: 8px;\n        background: rgba(255,255,255,.12);\n        border-radius: 4px;\n        overflow: hidden;\n      }\n      \n      .progress-fill {\n        height: 100%;\n        background: linear-gradient(90deg, var(--accent), var(--accent2));\n        border-radius: 4px;\n        transition: width 0.3s ease;\n      }\n      \n      .progress-text {\n        font-size: 12px;\n        font-weight: 600;\n        color: var(--accent);\n        min-width: 30px;\n        text-align: right;\n      }\n      \n      .indicator-fields {\n        display: flex;\n        flex-direction: column;\n        gap: 12px;\n      }\n      \n      .field-group {\n        display: flex;\n        flex-direction: column;\n      }\n      \n      .field-group label {\n        font-size: 11px;\n        font-weight: 600;\n        color: var(--muted);\n        margin-bottom: 6px;\n        text-transform: uppercase;\n        letter-spacing: 0.5px;\n      }\n      \n      .field-group input {\n        background: rgba(255,255,255,.05);\n        border: 1px solid var(--hair2);\n        border-radius: 8px;\n        padding: 10px 12px;\n        color: var(--text);\n        font-size: 14px;\n        transition: all 0.2s ease;\n      }\n      \n      .field-group input:focus {\n        border-color: var(--accent);\n        box-shadow: 0 0 0 3px rgba(93,211,255,.1);\n        background: rgba(255,255,255,.08);\n        outline: none;\n      }\n      \n      .field-group input::placeholder {\n        color: var(--muted);\n      }\n      \n      /* Hide Consuntivo field in Previsionale mode */\n      .field-group[data-cons][hidden] {\n        display: none !important;\n      }\n      \n      @media (max-width: 768px) {\n        #p_rows {\n          grid-template-columns: 1fr;\n          gap: 16px;\n        }\n        \n        .indicator-fields {\n          gap: 10px;\n        }\n        \n        .indicator-header {\n          flex-direction: column;\n          align-items: flex-start;\n          gap: 8px;\n        }\n        \n        .indicator-progress {\n          align-self: flex-end;\n        }\n      }\n    ',document.head.appendChild(j)}n.innerHTML=$e()+'<div class="bp-wrap"><div class="bp-card"><b>Da inviare</b><div id="bp_to_send" class="bp-grid"></div></div><div class="bp-card" id="bp_sent_box"><div id="bp_sent_head" class="bp-accordion-header"><b>BP inviati (periodi in essere)</b><span id="bp_sent_chev" class="bp-accordion-chevron"></span></div><div id="bp_sent" class="bp-accordion-content"></div></div><div class="bp-card"><b>Crea/Aggiorna BP</b><div class="bp-form-grid"><div class="bp-form-group"><label>Tipo</label><select id="p_type"><option value="settimanale">Settimanale (lundom)</option><option value="mensile">Mensile</option><option value="trimestrale">Trimestrale</option><option value="semestrale">Semestrale</option><option value="annuale">Annuale</option></select></div><div class="bp-form-group" id="wrap_week" style="display:none"><label>Settimana ISO (153)</label><input type="number" id="p_week" min="1" max="53" value="'+De(new Date)+'"></div><div class="bp-form-group" id="wrap_month" style="display:none"><label>Mese</label><select id="p_month"><option value="1">Gennaio</option><option value="2">Febbraio</option><option value="3">Marzo</option><option value="4">Aprile</option><option value="5">Maggio</option><option value="6">Giugno</option><option value="7">Luglio</option><option value="8">Agosto</option><option value="9">Settembre</option><option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option></select></div><div class="bp-form-group" id="wrap_quarter" style="display:none"><label>Trimestre</label><select id="p_quarter"><option value="1">T1</option><option value="2">T2</option><option value="3">T3</option><option value="4">T4</option></select></div><div class="bp-form-group" id="wrap_semester" style="display:none"><label>Semestre</label><select id="p_sem"><option value="1">1 semestre</option><option value="2">2 semestre</option></select></div><div class="bp-form-group"><label>Anno</label><input type="number" id="p_year" min="2000" max="2100" value="'+new Date().getFullYear()+'"></div></div><div class="bp-mode-indicator" style="margin-top:16px"><span>Modalit:</span><b id="p_mode_lbl">Previsionale</b><button class="bp-button" id="btnImport" style="padding:4px 8px;margin-left:8px">Importa da agenda</button></div><div style="margin-top:12px"><div class="small"><b>Periodo selezionato:</b> <span id="p_label" class="neon"></span></div><input type="hidden" id="p_start"><input type="hidden" id="p_end"></div><div id="p_rows" style="margin-top:16px"></div><div class="bp-actions"><div id="p_delete_zone"></div><div class="right"><button id="btnSaveP" class="bp-button primary">Salva BP</button></div></div></div><div class="bp-card"><b>BP salvati</b><div id="p_list" class="bp-grid"></div></div></div>',Oe();var m=!1,g=null,S=[],C=null,L=Jt()||{};function z(j){return String(j).replace(/[&<>'"]/g,Z=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[Z])}function tt(j){if(!j)return"";var Z=new Date(j);return Z.getFullYear()+"-"+("0"+(Z.getMonth()+1)).slice(-2)+"-"+("0"+Z.getDate()).slice(-2)}function q(j){var Z=new Date(j);return("0"+Z.getDate()).slice(-2)+"/"+("0"+(Z.getMonth()+1)).slice(-2)+"/"+Z.getFullYear()}function ht(j){var Z=Number(j)||0;return Z.toLocaleString("it-IT")+""}function V(j){var Z=document.createElement("div");return Z.innerHTML=j.trim(),Z.firstChild}function nt(j){return!!(j&&j.indicatorsCons&&Object.keys(j.indicatorsCons).length>0)}function vt(){return L&&L.grade?Promise.resolve(L):qt("/api/usernames").then(function(j){var Z=String((Jt()||{}).id||""),xt=(j&&j.users||[]).find(function(kt){return String(kt.id)===Z});return xt&&xt.grade&&(L.grade=xt.grade),L}).catch(function(){return L})}function K(){var j=L&&L.grade||(Jt()||{}).grade;return j==="senior"?"senior":"junior"}vt();var P=document.getElementById("p_type"),et=document.getElementById("p_year"),J=document.getElementById("wrap_week"),F=document.getElementById("wrap_month"),B=document.getElementById("wrap_quarter"),at=document.getElementById("wrap_semester"),R=document.getElementById("p_week"),W=document.getElementById("p_month"),$=document.getElementById("p_quarter"),_=document.getElementById("p_sem"),N=document.getElementById("p_label"),T=document.getElementById("p_start"),gt=document.getElementById("p_end"),st=document.getElementById("p_mode_lbl"),ot=document.getElementById("btnImport");function pt(j){m=!!j,st.textContent=m?"Consuntivo":"Previsionale";var Z=document.querySelectorAll("[data-row]");Z.forEach(function(xt){var kt=xt.querySelector("[data-prev]"),_t=xt.querySelector("[data-cons]"),Gt=xt.querySelector("[data-bar]");if(m){if(kt){kt.removeAttribute("hidden");var Wt=kt.querySelector("input");Wt&&(Wt.setAttribute("readonly","readonly"),Wt.classList.add("disabled"))}if(_t){_t.removeAttribute("hidden");var ue=_t.querySelector("input");ue&&(ue.removeAttribute("readonly"),ue.classList.remove("disabled"))}Gt&&Gt.removeAttribute("hidden")}else{if(kt){kt.removeAttribute("hidden");var se=kt.querySelector("input");se&&(se.removeAttribute("readonly"),se.classList.remove("disabled"))}_t&&_t.setAttribute("hidden","hidden"),Gt&&Gt.setAttribute("hidden","hidden")}}),G()}function lt(){var j=P.value;J.style.display=j==="settimanale"?"":"none",F.style.display=j==="mensile"?"":"none",B.style.display=j==="trimestrale"?"":"none",at.style.display=j==="semestrale"?"":"none",dt()}function dt(){var j=P.value,Z=parseInt(et.value,10),xt,kt,_t;if(j==="settimanale"){var Gt=Math.max(1,Math.min(53,parseInt(R.value||"1",10))),Wt=wn(Z,Gt);xt=Wt.start,kt=Wt.end,_t="Sett. "+Gt+"  "+q(xt)+"  "+q(kt)}else if(j==="mensile"){var ue=parseInt(W.value,10);xt=new Date(Z,ue-1,1),kt=new Date(Z,ue,0),_t=xt.toLocaleString("it-IT",{month:"long",year:"numeric"})+"  "+q(xt)+"  "+q(kt)}else if(j==="trimestrale"){var se=parseInt($.value,10);xt=new Date(Z,(se-1)*3,1),kt=new Date(Z,se*3,0),_t="Trimestre "+se+" "+Z+"  "+q(xt)+"  "+q(kt)}else if(j==="semestrale"){var Ee=parseInt(_.value,10);xt=new Date(Z,Ee===1?0:6,1),kt=new Date(Z,Ee===1?6:12,0),_t=(Ee===1?"1":"2")+" semestre "+Z+"  "+q(xt)+"  "+q(kt)}else xt=new Date(Z,0,1),kt=new Date(Z,11,31),_t="Anno "+Z+"  "+q(xt)+"  "+q(kt);T.value=tt(xt),gt.value=tt(kt),N.textContent=_t,pt(!1),g=null,C=null,Ft(),G()}function yt(j){for(var Z="",xt=0;xt<j.length;xt++){var kt=j[xt],_t=/^(VSS|VSDPersonale|VSDIndiretto|GI)$/i.test(kt);Z+='<div class="indicator-card" data-row="'+kt+'"><div class="indicator-header"><h4>'+kt+'</h4><div class="indicator-progress"><div class="progress-bar"><div id="bar_'+kt+'" class="progress-fill" style="width:0%"></div></div><span id="pct_'+kt+'" class="progress-text">0%</span></div></div><div class="indicator-fields"><div class="field-group" data-prev><label>Previsionale</label><input type="number" step="1" id="prev_'+kt+'" placeholder="'+(_t?"":"n")+'"></div><div class="field-group" data-cons><label>Consuntivo</label><input type="number" step="1" id="cons_'+kt+'" placeholder="'+(_t?"":"n")+'"></div></div></div>'}document.getElementById("p_rows").innerHTML=Z,pt(!1),wt(),Ct()}function Ct(){for(var j=0;j<S.length;j++){var Z=S[j],xt=document.getElementById("prev_"+Z),kt=document.getElementById("cons_"+Z);if(!(!xt||!kt)){var _t=Number(xt.value||0),Gt=Number(kt.value||0),Wt=_t>0?Math.round(Gt/_t*100):Gt>0?100:0;Wt=Math.max(0,Math.min(200,Wt));var ue=document.getElementById("bar_"+Z),se=document.getElementById("pct_"+Z);ue&&(ue.style.width=Math.min(Wt,100)+"%"),se&&(se.textContent=Wt+"%")}}}function wt(){for(var j=0;j<S.length;j++)(function(Z){var xt=document.getElementById("prev_"+Z),kt=document.getElementById("cons_"+Z);xt&&(xt.oninput=Ct),kt&&(kt.oninput=Ct)})(S[j])}function Tt(){for(var j=0;j<S.length;j++){var Z=document.getElementById("prev_"+S[j]);Z&&(Z.value="")}Ct()}function Ft(){for(var j=0;j<S.length;j++){var Z=document.getElementById("cons_"+S[j]);Z&&(Z.value="")}Ct()}function Pt(j){for(var Z in j){var xt=document.getElementById("prev_"+Z);xt&&(xt.value=String(j[Z]||0))}Ct()}function At(j){for(var Z in j){var xt=document.getElementById("cons_"+Z);xt&&(xt.value=String(j[Z]||0))}Ct()}function te(){var j=T.value,Z=gt.value;if(!j||!Z){Nt("Seleziona il periodo");return}qt("/api/appointments").then(function(xt){for(var kt=xt.appointments||[],_t=new Date(j),Gt=new Date(Z),Wt={VSS:0,VSDPersonale:0,VSDIndiretto:0,GI:0,Telefonate:0,AppFissati:0,AppFatti:0,CorsiLeadership:0,iProfile:0,MBS:0,NNCF:0},ue=0;ue<kt.length;ue++){var se=kt[ue],Ee=BPTimezone.parseUTCString(se.start);if(Ee>=_t&&Ee<=Gt){Wt.VSS+=Number(se.vss||0),Wt.VSDPersonale+=Number(se.vsdPersonal||0),Wt.VSDIndiretto+=Number(se.vsdIndiretto||0),Wt.Telefonate+=Number(se.telefonate||0),Wt.AppFissati+=Number(se.appFissati||0);var Ue=String(se.type||"").toLowerCase();(Ue.indexOf("vend")>-1||Ue.indexOf("mezza")>-1||Ue.indexOf("giorn")>-1)&&(Wt.AppFatti+=1),se.nncf&&(Wt.NNCF+=1)}}m?(At(Wt),Nt("Consuntivo compilato dalla tua agenda")):(Pt(Wt),Nt("Previsionale compilato dalla tua agenda"),Gi(),window.addXP(10))}).catch(function(){Nt("Errore import agenda")})}function Yt(j,Z){j=Object.assign({},j||{});var xt=Number(j.GI||0),kt=Number(j.VSDPersonale||0),_t=xt*.15,Gt=kt*(String(Z)==="senior"?.25:.2);return j.ProvvGI=Math.round(_t*100)/100,j.ProvvVSD=Math.round(Gt*100)/100,j.TotProvvigioni=Math.round((j.ProvvGI+j.ProvvVSD)*100)/100,j}function Et(j,Z,xt){return fetch(Z,{method:j,headers:xt?{"Content-Type":"application/json"}:void 0,body:xt?JSON.stringify(xt):void 0}).then(function(kt){return kt.ok?kt.json().catch(function(){return{}}):Promise.reject(new Error("HTTP "+kt.status))})}function bt(j){for(var Z=encodeURIComponent(j),xt=[function(){return Et("POST","/api/periods/delete",{id:j})},function(){return Et("POST","/api/periods",{id:j,_delete:!0})},function(){return Et("POST","/api/periods/"+Z,{_method:"DELETE"})},function(){return Et("DELETE","/api/periods/"+Z,null)},function(){return Et("DELETE","/api/periods?id="+Z,null)}],kt=Promise.reject(new Error("start")),_t=0;_t<xt.length;_t++)(function(Gt){kt=kt.catch(Gt)})(xt[_t]);return kt.catch(function(Gt){throw logger.warn("Delete fallback: tutte le route fallite",Gt),Gt})}function Dt(j){return C?{id:g||C.id,type:C.type,startDate:tt(C.startDate),endDate:tt(C.endDate),indicatorsPrev:Object.assign({},C.indicatorsPrev||{}),indicatorsCons:j!=null?j:Object.assign({},C.indicatorsCons||{})}:null}function G(){var j=document.getElementById("p_delete_zone");if(j){if(!g){j.innerHTML="";return}var Z=!!(C&&nt(C)),xt="";Z&&(xt+='<button id="btnDelCons" class="ghost" style="border-color:#7d1731;color:#7d1731">Elimina Consuntivo</button> '),xt+='<button id="btnDelBP" class="ghost" style="border-color:#7d1731;color:#7d1731">Elimina BP</button>',j.innerHTML=xt;var kt=document.getElementById("btnDelBP");kt&&(kt.onclick=function(){if(confirm("Eliminare definitivamente questo BP?")){kt.disabled=!0;var Gt=C?JSON.parse(JSON.stringify(C)):null;bt(g).then(function(){Nt("BP eliminato");try{document.dispatchEvent(new Event("bp:deleted"))}catch(ue){}if(g=null,C=null,Tt(),Ft(),pt(!1),dt(),Rt(),typeof showUndo=="function"&&Gt){var Wt={type:Gt.type,startDate:tt(Gt.startDate),endDate:tt(Gt.endDate),indicatorsPrev:Object.assign({},Gt.indicatorsPrev||{}),indicatorsCons:Object.assign({},Gt.indicatorsCons||{})};showUndo("BP eliminato",function(){return Le("/api/periods",Wt).then(function(){Rt()})},5e3)}}).catch(function(){Nt("Endpoint delete non disponibile")}).finally(function(){kt.disabled=!1})}});var _t=document.getElementById("btnDelCons");_t&&(_t.onclick=function(){if(confirm("Rimuovere solo il Consuntivo?")){_t.disabled=!0;var Gt=C?JSON.parse(JSON.stringify(C.indicatorsCons||{})):null,Wt=Dt({});if(!Wt){_t.disabled=!1;return}var ue=K();Wt.indicatorsPrev=Yt(Wt.indicatorsPrev,ue),Wt.indicatorsCons={},Le("/api/periods",Wt).then(function(){Nt("Consuntivo eliminato");try{document.dispatchEvent(new Event("bp:saved"))}catch(Ee){}if(C&&(C.indicatorsCons={}),pt(!0),Rt(),G(),typeof showUndo=="function"&&Gt){var se=Dt(Gt);showUndo("Consuntivo eliminato",function(){return Le("/api/periods",se).then(function(){C&&(C.indicatorsCons=Gt),Rt(),G()})},5e3)}}).catch(function(){Nt("Errore eliminazione Consuntivo")}).finally(function(){_t.disabled=!1})}})}}function mt(){var j=P.value,Z=T.value,xt=gt.value;if(!Z||!xt){Nt("Seleziona il periodo");return}for(var kt={},_t={},Gt=0;Gt<S.length;Gt++){var Wt=S[Gt];kt[Wt]=Number(document.getElementById("prev_"+Wt).value||0),m&&(_t[Wt]=Number(document.getElementById("cons_"+Wt).value||0))}var ue=K();kt=Yt(kt,ue),m&&(_t=Yt(_t,ue));var se={type:j,startDate:Z,endDate:xt,indicatorsPrev:kt};m&&(se.indicatorsCons=_t),g&&(se.id=g),Le("/api/periods",se).then(function(Ee){Nt("BP salvato"),m?window.addXP(20):window.addXP(10),Gi();try{document.dispatchEvent(new Event("bp:saved"))}catch(Ue){}Rt(),!g&&Ee&&Ee.id&&(g=Ee.id),g&&C&&(C.indicatorsPrev=kt,m&&(C.indicatorsCons=_t)),G()}).catch(function(){Nt("Errore salvataggio BP")})}function Rt(){qt("/api/periods").then(function(j){var Z=j.periods||[];Z.sort(function(ee,he){return new Date(he.startDate)-new Date(ee.startDate)});for(var xt={settimanale:[],mensile:[],trimestrale:[],semestrale:[],annuale:[]},kt=0;kt<Z.length;kt++){var _t=Z[kt],Gt=pn(_t.type,_t.startDate)+"  "+q(_t.startDate)+"  "+q(_t.endDate),Wt='<div class="card" style="flex:1 1 360px"><div><b>'+z(Gt)+'</b></div><div class="small">Prev VSS '+ht((_t.indicatorsPrev||{}).VSS||0)+"  Cons "+ht((_t.indicatorsCons||{}).VSS||0)+'</div><div class="right" style="margin-top:6px"><button class="ghost" data-edit="'+_t.id+'">Modifica previs.</button><button data-cons="'+_t.id+'">Consuntivo</button></div></div>';xt[_t.type]&&xt[_t.type].push(Wt)}for(var ue=["settimanale","mensile","trimestrale","semestrale","annuale"],se={settimanale:"Settimanali",mensile:"Mensili",trimestrale:"Trimestrali",semestrale:"Semestrali",annuale:"Annuali"},Ee="",Ue=0;Ue<ue.length;Ue++){var cn=ue[Ue],Yn=xt[cn].join("");Yn&&(Ee+="<details><summary>"+se[cn]+'</summary><div class="row">'+Yn+"</div></details>")}document.getElementById("p_list").innerHTML=Ee||'<div class="muted">Nessun BP</div>',document.querySelectorAll("[data-edit]").forEach(function(ee){ee.addEventListener("click",function(){var he=ee.getAttribute("data-edit"),pe=(j.periods||[]).find(function(He){return He.id===he});pe&&jt(pe,!1)})}),document.querySelectorAll("[data-cons]").forEach(function(ee){ee.addEventListener("click",function(){var he=ee.getAttribute("data-cons"),pe=(j.periods||[]).find(function(He){return He.id===he});pe&&jt(pe,!0)})}),Ht(Z);var le=sa("bp_open_period",null);if(le){vo("bp_open_period");var Pe=Z.find(function(ee){return ee.id===le.id});Pe&&jt(Pe,le.mode===!0)}})}function jt(j,Z){C=j||null,P.value=j.type;var xt=new Date(j.startDate),kt=xt.getFullYear();if(et.value=String(kt),j.type==="settimanale")R.value=String(De(xt));else if(j.type==="mensile")W.value=String(xt.getMonth()+1);else if(j.type==="trimestrale"){var _t=Math.floor(xt.getMonth()/3)+1;$.value=String(_t)}else j.type==="semestrale"&&(_.value=xt.getMonth()<6?"1":"2");lt(),Tt(),Ft(),Pt(j.indicatorsPrev||{}),At(j.indicatorsCons||{}),pt(!!Z),g=j.id||null,G(),Nt(Z?"Compila il consuntivo":"Modifica previsionale"),window.scrollTo({top:0,behavior:"smooth"})}function zt(j,Z){Z=Z||new Date;var xt=Z.getFullYear();if(j==="settimanale"){var kt=wn(xt,De(Z));return{start:kt.start,end:kt.end}}return j==="mensile"?{start:di(Z),end:Xi(Z)}:j==="trimestrale"?{start:Kn(Z),end:Ki(Z)}:j==="semestrale"?{start:Jn(Z),end:Ji(Z)}:{start:vi(Z),end:bi(Z)}}function Qt(j,Z){return Z=Z||new Date,j==="settimanale"?Rf(Z):j==="mensile"?zf(Z):j==="trimestrale"?Vf(Z):j==="semestrale"?Uf(Z):Hf(Z)}function Bt(j){var Z=wn(new Date().getFullYear(),De(new Date)),xt=Z.start,kt=Math.floor((new Date(j)-xt)/(1e3*60*60*24));return kt<=13}function Lt(j,Z,xt,kt,_t,Gt){var Wt=pn(Z,xt),ue=V('<div class="card" style="position:relative"><div class="small muted">'+z(j)+"</div><div><b>"+z(Wt)+'</b></div><div class="small muted">'+q(xt)+"  "+q(kt)+'</div><div class="right" style="margin-top:6px"><button class="ghost" type="button" data-sug="1">'+z(_t)+"</button></div></div>");return ue.querySelector("[data-sug]").addEventListener("click",Gt),ue}function Ht(j){var Z=document.getElementById("bp_to_send"),xt=document.getElementById("bp_sent");Z.innerHTML="",xt.innerHTML="";function kt(oe,we,xe){return j.find(function(je){return je.type===oe&&tt(je.startDate)===tt(we)&&tt(je.endDate)===tt(xe)})}var _t=new Date,Gt=_t.getDay(),Wt=Gt===5||Gt===6||Gt===0,ue=Xi(_t),se=Ki(_t),Ee=Ji(_t),Ue=bi(_t),cn=Wt&&Bt(ue),Yn=Wt&&Bt(se),le=Wt&&Bt(Ee),Pe=Wt&&Bt(Ue);["settimanale","mensile","trimestrale","semestrale","annuale"].forEach(function(oe){var we=zt(oe,_t),xe=kt(oe,we.start,we.end);if(xe){var je=V('<div class="card"><div><b>'+z(pn(oe,we.start))+'</b></div><div class="small muted">'+q(we.start)+"  "+q(we.end)+'</div><div class="right" style="margin-top:6px"><button class="ghost" type="button" data-edit="'+xe.id+'">Modifica previs.</button><button type="button" data-cons="'+xe.id+'">Consuntivo</button></div></div>');je.querySelector("[data-edit]").addEventListener("click",function(){jt(xe,!1)}),je.querySelector("[data-cons]").addEventListener("click",function(){jt(xe,!0)}),xt.appendChild(je)}});function ee(oe,we,xe){var je=kt(oe,xe.start,xe.end),dn=kt(oe,we.start,we.end);je?Z.appendChild(Lt("Previsionale",oe,xe.start,xe.end,"Modifica",function(){jt(je,!1)})):Z.appendChild(Lt("Previsionale",oe,xe.start,xe.end,"Compila",function(){if(P.value=oe,et.value=String(xe.start.getFullYear()),oe==="settimanale")R.value=String(De(xe.start));else if(oe==="mensile")W.value=String(xe.start.getMonth()+1);else if(oe==="trimestrale"){var Do=Math.floor(xe.start.getMonth()/3)+1;$.value=String(Do)}else oe==="semestrale"&&(_.value=xe.start.getMonth()<6?"1":"2");lt()})),dn&&!nt(dn)&&Z.appendChild(Lt("Consuntivo",oe,we.start,we.end,"Consuntivo",function(){jt(dn,!0)}))}if(Wt){var he=zt("settimanale",_t),pe=Qt("settimanale",_t);ee("settimanale",he,pe)}if(cn){var He=zt("mensile",_t),ye=Qt("mensile",_t);ee("mensile",He,ye)}if(Yn){var Eo=zt("trimestrale",_t),ni=Qt("trimestrale",_t);ee("trimestrale",Eo,ni)}if(le){var xn=zt("semestrale",_t),Io=Qt("semestrale",_t);ee("semestrale",xn,Io)}if(Pe){var ii=zt("annuale",_t),oi=Qt("annuale",_t);ee("annuale",ii,oi)}Z.children.length||(Z.innerHTML='<div class="muted">Nessun suggerimento attivo in questo momento</div>');var Pn=document.getElementById("bp_sent_head"),$n=document.getElementById("bp_sent_chev");Pn.onclick=function(){var oe=document.getElementById("bp_sent"),we=oe.classList.contains("open");we?(oe.classList.remove("open"),$n.textContent="",$n.style.transform="rotate(0deg)"):(oe.classList.add("open"),$n.textContent="",$n.style.transform="rotate(90deg)")}}qt("/api/settings").then(function(j){S=j&&j.indicators||["VSS","VSDPersonale","VSDIndiretto","GI","Telefonate","AppFissati","AppFatti","CorsiLeadership","iProfile","MBS","NNCF"],yt(S)}).catch(function(){S=["VSS","VSDPersonale","GI","NNCF"],yt(S)}),P.onchange=lt,et.oninput=dt,R.oninput=dt,W.onchange=dt,$.onchange=dt,_.onchange=dt,ot.onclick=te,document.getElementById("btnSaveP").onclick=mt,lt(),Rt()}function p(){if(!Jt())return t();if(document.title="Battle Plan  Appuntamenti",Ge("viewAppointments"),!document.getElementById("appts_css")){const P=document.createElement("style");P.id="appts_css",P.textContent='\n      /* ============== MODERN APPOINTMENTS DESIGN ============== */\n      .appointments-wrap {\n        max-width: 1200px;\n        margin: 0 auto;\n        padding: 0 20px;\n        margin-top: calc(56px + env(safe-area-inset-top) + 32px);\n      }\n      \n      /* Modern Appointments Cards */\n      .appt-card {\n        background: linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.04));\n        border: 1px solid var(--hair2);\n        border-radius: 16px;\n        padding: 20px;\n        margin-bottom: 20px;\n        backdrop-filter: blur(10px);\n        box-shadow: 0 4px 16px rgba(0,0,0,.08);\n        transition: all 0.2s ease;\n        position: relative;\n        overflow: hidden;\n      }\n      \n      .appt-card:hover {\n        border-color: var(--accent);\n        box-shadow: 0 8px 24px rgba(0,0,0,.12);\n        transform: translateY(-2px);\n      }\n      \n      .appt-card::before {\n        content: "";\n        position: absolute;\n        top: 0;\n        left: 0;\n        right: 0;\n        height: 3px;\n        background: linear-gradient(90deg, var(--accent), var(--accent2));\n        border-radius: 16px 16px 0 0;\n      }\n      \n      .appt-card b {\n        font-size: 16px;\n        font-weight: 700;\n        color: var(--text);\n        margin-bottom: 16px;\n        display: block;\n        position: relative;\n        padding-left: 12px;\n      }\n      \n      .appt-card b::before {\n        content: "";\n        position: absolute;\n        left: 0;\n        top: 50%;\n        transform: translateY(-50%);\n        width: 4px;\n        height: 16px;\n        background: linear-gradient(180deg, var(--accent), var(--accent2));\n        border-radius: 2px;\n      }\n      \n      /* Modern Form Layout */\n      .appt-form-grid {\n        display: grid;\n        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n        gap: 16px;\n        margin-top: 16px;\n      }\n      \n      .appt-form-group {\n        display: flex;\n        flex-direction: column;\n      }\n      \n      .appt-form-group label {\n        font-weight: 600;\n        color: var(--accent);\n        margin-bottom: 6px;\n        font-size: 12px;\n        text-transform: uppercase;\n        letter-spacing: 0.5px;\n      }\n      \n      .appt-form-group input, .appt-form-group select, .appt-form-group textarea {\n        background: rgba(255,255,255,.05);\n        border: 1px solid var(--hair2);\n        border-radius: 8px;\n        padding: 10px 12px;\n        color: var(--text);\n        transition: all 0.2s ease;\n        font-size: 14px;\n      }\n      \n      .appt-form-group input:focus, .appt-form-group select:focus, .appt-form-group textarea:focus {\n        border-color: var(--accent);\n        box-shadow: 0 0 0 3px rgba(93,211,255,.1);\n        background: rgba(255,255,255,.08);\n        outline: none;\n      }\n      \n      /* Modern Segment Buttons */\n      .appt-type .seg, #a_nncf.seg {\n        padding: 8px 12px;\n        border: 1px solid var(--hair2);\n        border-radius: 12px;\n        background: rgba(255,255,255,.05);\n        color: var(--text);\n        cursor: pointer;\n        user-select: none;\n        transition: all 0.2s ease;\n        font-weight: 500;\n        font-size: 13px;\n      }\n      \n      .appt-type .seg:hover, #a_nncf.seg:hover {\n        border-color: var(--accent);\n        background: rgba(93,211,255,.1);\n        color: var(--accent);\n        transform: translateY(-1px);\n      }\n      \n      .appt-type .seg.active, #a_nncf.seg.active {\n        background: linear-gradient(135deg, var(--accent), var(--accent2));\n        color: #fff;\n        border-color: var(--accent);\n        box-shadow: 0 4px 12px rgba(93,211,255,.3);\n        transform: translateY(-1px);\n      }\n      \n      .appt-type .seg:disabled, #a_nncf.seg:disabled {\n        opacity: 0.5;\n        cursor: not-allowed;\n        pointer-events: none;\n      }\n      \n      .appt-type > div {\n        display: flex;\n        flex-wrap: wrap;\n        gap: 8px;\n        margin-top: 8px;\n      }\n      \n      /* Modern Buttons */\n      .appt-button {\n        background: rgba(255,255,255,.05);\n        border: 1px solid var(--hair2);\n        border-radius: 8px;\n        padding: 10px 16px;\n        color: var(--text);\n        font-weight: 500;\n        transition: all 0.2s ease;\n        cursor: pointer;\n        font-size: 14px;\n      }\n      \n      .appt-button:hover {\n        background: var(--accent);\n        border-color: var(--accent);\n        color: #fff;\n        transform: translateY(-1px);\n      }\n      \n      .appt-button.primary {\n        background: linear-gradient(135deg, var(--accent), var(--accent2));\n        color: #fff;\n        border-color: var(--accent);\n        box-shadow: 0 4px 12px rgba(93,211,255,.3);\n      }\n      \n      .appt-button.primary:hover {\n        box-shadow: 0 6px 16px rgba(93,211,255,.4);\n        transform: translateY(-2px);\n      }\n      \n      .appt-button.danger {\n        background: rgba(220,53,69,.1);\n        border-color: rgba(220,53,69,.3);\n        color: #dc3545;\n      }\n      \n      .appt-button.danger:hover {\n        background: #dc3545;\n        border-color: #dc3545;\n        color: #fff;\n      }\n      \n      /* Modern Grid for Appointments List */\n      .appt-grid {\n        display: grid;\n        gap: 12px;\n        grid-template-columns: repeat(4, 1fr);\n        margin-top: 16px;\n      }\n      \n      .appt-item {\n        background: linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.03));\n        border: 1px solid var(--hair2);\n        border-radius: 12px;\n        padding: 16px;\n        transition: all 0.2s ease;\n        backdrop-filter: blur(10px);\n      }\n      \n      .appt-item:hover {\n        border-color: var(--accent);\n        box-shadow: 0 4px 16px rgba(93,211,255,.1);\n        transform: translateY(-2px);\n      }\n      \n      /* Filter Controls */\n      .appt-filters {\n        display: flex;\n        gap: 12px;\n        align-items: flex-end;\n        flex-wrap: wrap;\n        margin-top: 16px;\n      }\n      \n      .appt-filters .appt-form-group {\n        min-width: 120px;\n      }\n      \n      .appt-filters .right {\n        margin-left: auto;\n        display: flex;\n        gap: 8px;\n      }\n      \n      /* Action Buttons Container */\n      .appt-actions {\n        display: flex;\n        gap: 12px;\n        margin-top: 20px;\n        flex-wrap: wrap;\n        align-items: center;\n        justify-content: space-between;\n      }\n      \n      /* Client Input with NNCF Button */\n      .appt-client-group {\n        display: flex;\n        gap: 8px;\n        align-items: center;\n      }\n      \n      .appt-client-group input {\n        flex: 1;\n      }\n      \n      /* Client dropdown styles - uniformi al resto del form */\n      .appt-card .client-dropdown {\n        position: relative;\n        width: 100%;\n      }\n      \n      .appt-card .client-dropdown-input {\n        width: 100%;\n        background: rgba(255,255,255,.05);\n        border: 1px solid var(--hair2);\n        border-radius: 8px;\n        padding: 10px 12px;\n        transition: all 0.2s ease;\n        color: var(--text);\n        font-size: 14px;\n        cursor: text;\n      }\n      \n      .appt-card .client-dropdown-input input {\n        width: 100%;\n        background: transparent;\n        border: none;\n        outline: none;\n        color: var(--text);\n        font-size: 14px;\n        pointer-events: auto;\n      }\n      \n      .appt-card .client-dropdown-input:focus {\n        border-color: var(--accent);\n        box-shadow: 0 0 0 3px rgba(93,211,255,.1);\n        background: rgba(255,255,255,.08);\n        outline: none;\n      }\n      \n      .appt-card .client-dropdown-input input:focus {\n        outline: none;\n      }\n      \n      .appt-card .client-dropdown-input::placeholder {\n        color: var(--muted);\n      }\n      \n      .appt-card .client-dropdown-input input::placeholder {\n        color: var(--muted);\n      }\n      \n      .appt-card .client-dropdown-arrow {\n        transition: transform 0.2s ease;\n        color: var(--muted);\n        font-size: 12px;\n      }\n      \n      .appt-card .client-dropdown.open .client-dropdown-arrow {\n        transform: rotate(180deg);\n      }\n      \n      .appt-card .client-dropdown-list {\n        position: absolute;\n        top: 100%;\n        left: 0;\n        right: 0;\n        background: var(--card);\n        border: 1px solid var(--hair2);\n        border-radius: 8px;\n        max-height: 300px;\n        overflow-y: auto;\n        z-index: 1000;\n        margin-top: 4px;\n        box-shadow: 0 20px 60px rgba(0,0,0,.3);\n        backdrop-filter: blur(10px);\n      }\n      \n      .appt-card .client-dropdown-search {\n        padding: 12px;\n        border-bottom: 1px solid var(--hair2);\n        background: rgba(255,255,255,.03);\n      }\n      \n      .appt-card .client-dropdown-search input {\n        width: 100%;\n        background: rgba(255,255,255,.05);\n        border: 1px solid var(--hair2);\n        border-radius: 8px;\n        padding: 8px 12px;\n        color: var(--text);\n        font-size: 14px;\n      }\n      \n      .appt-card .client-dropdown-search input:focus {\n        border-color: var(--accent);\n        box-shadow: 0 0 0 3px rgba(93,211,255,.1);\n        background: rgba(255,255,255,.08);\n      }\n      \n      .appt-card .client-dropdown-options {\n        max-height: 250px;\n        overflow-y: auto;\n      }\n      \n      .appt-card .client-option {\n        padding: 12px 16px;\n        cursor: pointer;\n        transition: all 0.2s ease;\n        border-bottom: 1px solid var(--hair);\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        color: var(--text);\n      }\n      \n      .appt-card .client-option:hover {\n        background: rgba(93,211,255,.1);\n        color: var(--accent);\n      }\n      \n      .appt-card .client-option:last-child {\n        border-bottom: none;\n      }\n      \n      .appt-card .client-option.selected {\n        background: rgba(93,211,255,.15);\n        color: var(--accent);\n        font-weight: 600;\n      }\n      \n      .appt-card .client-option-icon {\n        width: 36px;\n        height: 36px;\n        border-radius: 50%;\n        background: linear-gradient(135deg, var(--accent), var(--accent2));\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        color: #fff;\n        font-weight: 700;\n        font-size: 14px;\n        flex-shrink: 0;\n      }\n      \n      .appt-card .client-option-text {\n        flex: 1;\n        font-size: 14px;\n      }\n      \n      .appt-card .client-option-name {\n        font-weight: 500;\n        margin-bottom: 2px;\n        color: var(--text);\n      }\n      \n      .appt-card .client-option-consultant {\n        font-size: 11px;\n        color: var(--accent);\n        margin-bottom: 2px;\n        font-weight: 500;\n        opacity: 0.8;\n      }\n      \n      .appt-card .client-option-status {\n        font-size: 12px;\n        color: var(--muted);\n        text-transform: capitalize;\n      }\n      \n      /* Duration and End Time Group */\n      .appt-row-end-dur {\n        display: flex;\n        gap: 8px;\n        align-items: flex-end;\n      }\n      \n      /* Description Textarea */\n      #a_desc {\n        width: 100%;\n        min-height: 3.2em;\n        resize: vertical;\n      }\n      \n      /* Responsive Design */\n      @media (max-width: 768px) {\n        .appointments-wrap {\n          padding: 0 16px;\n          margin-top: calc(56px + env(safe-area-inset-top) + 16px);\n        }\n        \n        .appt-card {\n          padding: 16px;\n          margin-bottom: 16px;\n        }\n        \n        .appt-form-grid {\n          grid-template-columns: 1fr;\n          gap: 12px;\n        }\n        \n        .appt-grid {\n          grid-template-columns: repeat(3, 1fr);\n          gap: 8px;\n        }\n      }\n      \n      @media (max-width: 900px) {\n        .appt-grid {\n          grid-template-columns: repeat(2, 1fr);\n        }\n      }\n      \n      @media (max-width: 768px) {\n        .appt-grid {\n          grid-template-columns: 1fr;\n          gap: 8px;\n        }\n        \n        .appt-filters {\n          flex-direction: column;\n          align-items: stretch;\n          gap: 8px;\n        }\n        \n        .appt-filters .right {\n          margin-left: 0;\n          justify-content: space-between;\n        }\n        \n        .appt-actions {\n          gap: 8px;\n          flex-direction: column;\n          align-items: stretch;\n        }\n        \n        .appt-actions .right {\n          margin-left: 0;\n          width: 100%;\n        }\n        \n        .appt-actions .right button {\n          width: 100%;\n        }\n        \n        .appt-type > div {\n          gap: 6px;\n        }\n        \n        .appt-type .seg {\n          padding: 6px 10px;\n          font-size: 12px;\n        }\n      }\n      \n      @media (max-width: 480px) {\n        .appointments-wrap {\n          padding: 0 12px;\n        }\n        \n        .appt-card {\n          padding: 12px;\n        }\n        \n        .appt-form-grid {\n          gap: 8px;\n        }\n        \n        .appt-row-end-dur {\n          flex-direction: column;\n          align-items: stretch;\n        }\n      }\n    ',document.head.appendChild(P)}n.innerHTML=$e()+'<div class="appointments-wrap"><div class="appt-card"><b id="a_form_title">Nuovo appuntamento</b><div class="appt-form-grid"><div class="appt-form-group" style="grid-column: 1 / -1;"><label>Cliente *</label><div class="appt-client-group"><div class="client-dropdown" style="flex: 1;"><input type="text" id="a_client_display" placeholder=" seleziona cliente " autocomplete="off" class="client-dropdown-input"><input type="hidden" id="a_client_select" value=""><div class="client-dropdown-list" id="a_client_list" style="display:none"><div class="client-dropdown-search"><input type="text" id="a_client_search" placeholder="Cerca cliente..." autocomplete="off"></div><div class="client-dropdown-options" id="a_client_options"><div style="padding:16px;text-align:center;color:var(--muted)">Caricamento clienti...</div></div></div></div><button id="a_nncf" class="seg" data-active="0" aria-pressed="false">NNCF</button></div></div><div class="appt-form-group"><label>Data/ora inizio</label><input id="a_start" type="datetime-local"></div><div class="appt-form-group"><label>Ora fine</label><input id="a_end" type="time"></div><div class="appt-form-group"><label>Durata (min)</label><input id="a_dur" type="number" placeholder="60" min="1" style="width:80px"></div></div><div class="appt-form-group" style="margin-top:16px;"><label>Descrizione appuntamento</label><textarea id="a_desc" rows="2"></textarea></div><div class="appt-form-grid" style="margin-top:16px;"><div class="appt-form-group appt-type"><label>Tipo</label><div><button type="button" id="t_vendita" class="seg">Vendita</button><button type="button" id="t_mezza"   class="seg" data-vsd="1000">Mezza giornata</button><button type="button" id="t_full"    class="seg" data-vsd="2000">Giornata intera</button><button type="button" id="t_form"    class="seg">Formazione</button><button type="button" id="t_mbs"     class="seg">MBS</button><button type="button" id="t_sotto"   class="seg">Sottoprodotti</button><button type="button" id="t_riunione" class="seg">Riunione</button><button type="button" id="t_impegni"  class="seg">Impegni personali</button></div><input id="a_type" type="hidden" value="vendita"></div><div class="appt-form-group" id="row_vss"><label>VSS</label><input id="a_vss" type="number" step="1" placeholder="0"></div><div class="appt-form-group" id="row_vsd_p"><label>VSD personale</label><input id="a_vsd" type="number" step="1" placeholder="0"></div><div class="appt-form-group" id="row_vsd_i" style="display:none"><label>VSD indiretto</label><input id="a_vsd_i" type="number" step="1" placeholder="0"></div><div class="appt-form-group" id="row_tel" style="display:none"><label>Telefonate</label><input id="a_tel" type="number" step="1" placeholder="0"></div><div class="appt-form-group" id="row_app" style="display:none"><label>Appunt. fissati</label><input id="a_app" type="number" step="1" placeholder="0"></div></div><div class="appt-actions"><div><button id="btnSaveA" class="appt-button primary">Salva</button></div><div><button id="btnSaveExportA" class="appt-button">Salva ed esporta</button></div><div class="right"><button id="btnDeleteA" class="appt-button danger" style="display:none">Elimina</button></div></div></div><div class="appt-card"><b>Elenco appuntamenti</b><div class="appt-filters"><div class="appt-form-group"><label>Vista</label><select id="af_type"><option value="sett">Settimana</option><option value="tutti">Tutti</option><option value="mese">Mese</option></select></div><div class="appt-form-group" id="af_week_wrap"><label>Settimana ISO</label><input id="af_week" type="number" min="1" max="53" value="'+De(new Date)+'"></div><div class="appt-form-group" id="af_month_wrap" style="display:none"><label>Mese</label><select id="af_month"><option value="1">Gennaio</option><option value="2">Febbraio</option><option value="3">Marzo</option><option value="4">Aprile</option><option value="5">Maggio</option><option value="6">Giugno</option><option value="7">Luglio</option><option value="8">Agosto</option><option value="9">Settembre</option><option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option></select></div><div class="appt-form-group"><label>Anno</label><input id="af_year" type="number" min="2000" max="2100" value="'+new Date().getFullYear()+'"></div><div class="right"><button id="af_prev" class="appt-button"></button><button id="af_next" class="appt-button"></button></div></div><div id="a_list" class="appt-grid"></div></div></div>',Oe(),(async function(){const et=document.getElementById("a_client_display"),J=document.getElementById("a_client_select"),F=document.getElementById("a_client_list"),B=document.getElementById("a_client_options"),at=document.getElementById("a_client_search");if(!et||!J||!F||!B||!at)return;if(window._clients&&window._clients.length===0)try{const $=await qt("/api/clients");window._clients=$&&$.clients||[]}catch($){console.error("Errore caricamento clienti:",$),B.innerHTML='<div style="padding:16px;text-align:center;color:var(--danger)">Errore caricamento clienti</div>';return}let R=window._clients||[];if(R.length===0)try{const $=await qt("/api/clients");R=$&&$.clients||[],window._clients=R}catch($){console.error("Errore caricamento clienti:",$),B.innerHTML='<div style="padding:16px;text-align:center;color:var(--danger)">Errore caricamento clienti</div>';return}b=[...R].sort(($,_)=>String($.name||"").localeCompare(String(_.name||""),"it",{sensitivity:"base"}));function W($=b){if($.length===0){B.innerHTML='<div style="padding:16px;text-align:center;color:var(--muted)">Nessun cliente trovato</div>';return}B.innerHTML=$.map(_=>{const N=(_.name||"").split(" ").map(gt=>gt.charAt(0)).join("").toUpperCase().slice(0,2),T=_.consultantName||"";return'\n          <div class="client-option" data-client-id="'.concat(_.id,'" data-client-name="').concat(Mt(_.name||""),'" data-client-status="').concat(_.status||"attivo",'">\n            <div class="client-option-icon">').concat(N,'</div>\n            <div class="client-option-text">\n              <div class="client-option-name">').concat(Mt(_.name||""),"</div>\n              ").concat(T?'<div class="client-option-consultant">'.concat(Mt(T),"</div>"):"","\n            </div>\n          </div>\n        ")}).join("")}W(),et.addEventListener("click",$=>{$.stopPropagation(),F.style.display="block"}),et.addEventListener("input",$=>{J.value="";const _=document.getElementById("a_nncf");_.disabled=!1,_.style.opacity="1",_.style.cursor="pointer",F.style.display="block"}),et.addEventListener("focus",$=>{F.style.display="block"}),et.addEventListener("blur",$=>{setTimeout(()=>{!F.contains(document.activeElement)&&document.activeElement!==et&&(F.style.display="none")},150)}),at.addEventListener("input",$=>{const _=$.target.value.toLowerCase().trim();if(!_){W();return}const N=b.filter(T=>String(T.name||"").toLowerCase().includes(_));W(N)}),document.addEventListener("click",$=>{!et.contains($.target)&&!F.contains($.target)&&(F.style.display="none")}),B.addEventListener("click",$=>{const _=$.target.closest(".client-option");if(!_)return;const N=_.dataset.clientId,T=_.dataset.clientName,gt=_.dataset.clientStatus;et.value=T,J.value=N,B.querySelectorAll(".client-option").forEach(pt=>pt.classList.remove("selected")),_.classList.add("selected");const st=document.getElementById("a_nncf");gt==="attivo"?(st.setAttribute("data-active","0"),st.setAttribute("aria-pressed","false"),st.classList.remove("active"),st.disabled=!0,st.style.opacity="0.5",st.style.cursor="not-allowed"):(st.disabled=!1,st.style.opacity="1",st.style.cursor="pointer");const ot=new Event("change",{bubbles:!0});J.dispatchEvent(ot)}),et.addEventListener("keydown",$=>{$.key==="Enter"&&($.preventDefault(),F.style.display="block")}),at.addEventListener("keydown",$=>{$.key==="Escape"&&(F.style.display="none",et.focus())})})(),v=document.getElementById("a_nncf"),v.addEventListener("click",()=>{const P=v.getAttribute("data-active")!=="1";v.setAttribute("data-active",P?"1":"0"),v.setAttribute("aria-pressed",P?"true":"false"),v.classList.toggle("active",P),P&&m(document.getElementById("t_vendita"),!0)}),y=document.getElementById("t_vendita"),E=document.getElementById("t_mezza"),M=document.getElementById("t_full"),X=document.getElementById("t_form"),it=document.getElementById("t_mbs"),Q=document.getElementById("t_sotto"),ft=document.getElementById("t_riunione"),ut=document.getElementById("t_impegni"),ct=[y,E,M,X,it,Q,ft,ut];function m(P,et=!1){ct.forEach(N=>N.classList.toggle("active",N===P));const J=document.getElementById("a_type"),F=document.getElementById("a_client_display"),B=document.getElementById("a_client_select"),at=document.getElementById("row_vss"),R=document.getElementById("row_vsd_p"),W=document.getElementById("row_vsd_i"),$=document.getElementById("row_tel"),_=document.getElementById("row_app");document.getElementById("a_vss").value="",document.getElementById("a_vsd").value="",document.getElementById("a_vsd_i").value="",document.getElementById("a_tel").value="",document.getElementById("a_app").value="",at.style.display="",R.style.display="",W.style.display="none",$.style.display="none",_.style.display="none",F.disabled=!1,v.style.display="",et||(v.setAttribute("data-active","0"),v.setAttribute("aria-pressed","false"),v.classList.remove("active")),(F.value==="Formazione"||F.value==="MBS"||F.value==="Sottoprodotti"||F.value==="Riunione"||F.value==="Impegni personali")&&(F.value="",B.value=""),P===y?(J.value="vendita",Ot(90)):P===E?(J.value="mezza",Ot(240),document.getElementById("a_vsd").value="1000"):P===M?(J.value="giornata",Ot(570),document.getElementById("a_vsd").value="2000"):P===X?(J.value="formazione",Ot(570),F.value="Formazione",F.disabled=!0,at.style.display="none",R.style.display="none",v.style.display="none"):P===it?(J.value="MBS",Ot(570),F.value="MBS",F.disabled=!0,at.style.display="none",R.style.display="none",W.style.display="",document.getElementById("a_vsd_i").value="2000",v.style.display="none"):P===Q?(J.value="sottoprodotti",Ot(240),F.value="Sottoprodotti",F.disabled=!0,at.style.display="none",R.style.display="none",$.style.display="",_.style.display="",v.style.display="none"):P===ft?(J.value="riunione",Ot(60),F.value="Riunione",F.disabled=!0,at.style.display="none",R.style.display="none",v.style.display="none"):P===ut&&(J.value="impegni personali",Ot(60),F.value="Impegni personali",F.disabled=!0,at.style.display="none",R.style.display="none",v.style.display="none")}ct.forEach(P=>P.addEventListener("click",et=>{et.preventDefault(),m(P)})),m(y),document.getElementById("a_start").addEventListener("change",Ut),document.getElementById("a_dur").addEventListener("input",Ut),document.getElementById("a_end").addEventListener("change",Vt);function g(){f=null,document.getElementById("a_form_title").textContent="Nuovo appuntamento",document.getElementById("a_client_display").value="",document.getElementById("a_client_select").value="",document.getElementById("a_start").value="",document.getElementById("a_end").value="",document.getElementById("a_dur").value="",document.getElementById("a_vss").value="",document.getElementById("a_vsd").value="",document.getElementById("a_vsd_i").value="",document.getElementById("a_tel").value="",document.getElementById("a_app").value="",document.getElementById("a_desc").value="",v.style.display="",v.setAttribute("data-active","0"),v.setAttribute("aria-pressed","false"),v.classList.remove("active"),v.disabled=!1,v.style.opacity="1",v.style.cursor="pointer",m(y),document.getElementById("btnDeleteA").style.display="none"}function S(){let P=(document.getElementById("a_client_display").value||"").trim();const et=document.getElementById("a_client_select").value,J=document.getElementById("a_type").value;if(!P){const $=String(J||"").toLowerCase();if($==="formazione"||$==="mbs"||$==="sottoprodotti")P=J;else return Nt("Cliente obbligatorio"),null}const F=document.getElementById("a_start").value;if(!F)return Nt("Data/ora obbligatorie"),null;let B=parseInt(document.getElementById("a_dur").value||"60",10);(!isFinite(B)||B<=0)&&(B=60);const at=document.getElementById("a_end").value;let R;if(at){const $=new Date(F),_=at.split(":"),N=new Date($);N.setHours(parseInt(_[0],10)||0,parseInt(_[1],10)||0,0,0),N<$&&N.setDate(N.getDate()+1),R=N.toISOString(),B=Math.max(1,Math.round((N-$)/6e4)),document.getElementById("a_dur").value=String(B)}else R=new Date(new Date(F).getTime()+B*6e4).toISOString();const W=document.getElementById("a_desc").value||"";return{id:f||void 0,client:P,clientId:et,start:Zt(F),end:R,durationMinutes:B,type:J,vss:Number(document.getElementById("a_vss").value||0),vsdPersonal:Number(document.getElementById("a_vsd").value||0),vsdIndiretto:Number(document.getElementById("a_vsd_i").value||0),telefonate:Number(document.getElementById("a_tel").value||0),appFissati:Number(document.getElementById("a_app").value||0),notes:W,nncf:v.getAttribute("data-active")==="1"}}function C(P){const et=S();if(!et)return;const J=!f;Le("/api/appointments",et).then(()=>{if(Nt("Appuntamento salvato"),typeof haptics<"u"&&haptics.try("success"),document.dispatchEvent(new Event("appt:saved")),typeof window.BP<"u"&&window.BP.Coach&&typeof window.BP.Coach.say=="function"&&window.BP.Coach.say(J?"appointment_created":"appointment_updated",{intensity:J?"medium":"low"}),J)try{document.dispatchEvent(new Event("appt:created"))}catch(F){}if(P&&window.BP&&BP.ICS&&typeof BP.ICS.downloadIcsForAppointment=="function")if(BP.ICS.downloadIcsForAppointment(et)){typeof haptics<"u"&&haptics.try("medium");try{document.dispatchEvent(new Event("ics:exported"))}catch(B){}Nt(".ics esportato")}else Nt("Export .ics non disponibile");g(),K()}).catch(()=>Nt("Errore salvataggio"))}function L(){if(!f||!confirm("Eliminare l'appuntamento?"))return;const P=S();fetch("/api/appointments?id="+encodeURIComponent(f),{method:"DELETE",headers:{Authorization:"Bearer "+ro()}}).then(et=>{if(!et.ok)throw new Error("HTTP "+et.status);return et.json()}).then(()=>{Nt("Eliminato"),typeof showUndo=="function"&&P&&showUndo("Appuntamento eliminato",function(){return Le("/api/appointments",P)},5e3),g(),K()}).catch(()=>Nt("Errore eliminazione"))}document.getElementById("btnSaveA").onclick=()=>C(!1),document.getElementById("btnSaveExportA").onclick=()=>C(!0),document.getElementById("btnDeleteA").onclick=L;function z(){const P=document.getElementById("af_type").value;if(P==="tutti")return{s:new Date(2e3,0,1),e:new Date(2100,11,31,23,59,59,999)};const et=parseInt(document.getElementById("af_year").value,10);if(P==="sett"){const J=Math.max(1,Math.min(53,parseInt(document.getElementById("af_week").value||De(new Date),10))),F=wn(et,J);return{s:new Date(F.start),e:new Date(F.end)}}else{const J=parseInt(document.getElementById("af_month").value||new Date().getMonth()+1,10);return{s:new Date(et,J-1,1),e:new Date(et,J,0,23,59,59,999)}}}function tt(P){const et=document.getElementById("af_type").value,J=parseInt(document.getElementById("af_year").value,10);if(et==="sett"){const F=parseInt(document.getElementById("af_week").value,10),B=new Date(wn(J,F).start);B.setDate(B.getDate()+7*P),document.getElementById("af_year").value=B.getFullYear(),document.getElementById("af_week").value=De(B)}else{const F=parseInt(document.getElementById("af_month").value,10),B=new Date(J,F-1,1);B.setMonth(B.getMonth()+P),document.getElementById("af_year").value=B.getFullYear(),document.getElementById("af_month").value=B.getMonth()+1}K()}document.getElementById("af_prev").onclick=()=>tt(-1),document.getElementById("af_next").onclick=()=>tt(1);const q=document.getElementById("af_type"),ht=document.getElementById("af_week"),V=document.getElementById("af_month"),nt=document.getElementById("af_year");q.onchange=function(){const P=q.value;document.getElementById("af_week_wrap").style.display=P==="sett"?"":"none",document.getElementById("af_month_wrap").style.display=P==="mese"?"":"none",K()},[ht,V,nt].forEach(P=>{P&&(P.onchange=K)});function vt(P){const et=BPTimezone.parseUTCString(P.start);let J=P.end?BPTimezone.parseUTCString(P.end):null;if(!(J instanceof Date)||isNaN(J)||J<et){const R=isFinite(P.durationMinutes)?Number(P.durationMinutes):Ce(P.type||"vendita");J=BPTimezone.addMinutes(et,R)}const F=BPTimezone.toLocalDisplay(et).split(" ")[0]+" "+BPTimezone.timeHMLocal(et)+""+BPTimezone.timeHMLocal(J);var B,at=String(P.type||"").toLowerCase();return at.indexOf("mbs")>-1?B="VSD ind "+$t(P.vsdIndiretto||0):at.indexOf("sottoprod")>-1?B="Tel "+Be(P.telefonate||0)+"  AppFissati "+Be(P.appFissati||0):at.indexOf("formaz")>-1||at.indexOf("riunione")>-1||at.indexOf("impegni personali")>-1?B="":B="VSS "+$t(P.vss||0)+"  VSD "+$t(P.vsdPersonal||0)+"  NNCF "+(P.nncf?"":""),'<div class="card" data-aid="'+Mt(String(P.id||""))+'" style="flex:1 1 320px;cursor:pointer"><div class="small muted">'+Mt(F)+"  "+Mt(P.type||"vendita")+'</div><div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><div><b>'+Mt(P.client||"")+'</b></div><button class="ghost btn-ics" title="Esporta" data-ics="'+Mt(String(P.id||""))+'"></button></div>'+(B?'<div class="small">'+B+"</div>":"")+"</div>"}function K(){qt("/api/appointments").then(P=>{const et=P&&P.appointments||[],J=z(),F=J.s.getTime(),B=J.e.getTime(),at=et.filter(ot=>{const pt=BPTimezone.parseUTCString(ot.start).getTime();return pt>=F&&pt<=B}).sort((ot,pt)=>BPTimezone.parseUTCString(ot.start)-BPTimezone.parseUTCString(pt.start)),R=new Date,W=at.filter(ot=>BPTimezone.parseUTCString(ot.start)>=R),$=at.filter(ot=>BPTimezone.parseUTCString(ot.start)<R),_=document.getElementById("a_list");let N="";N+="<div><b>Prossimi</b></div>",N+=W.length?'<div class="grid3">'+W.map(vt).join("")+"</div>":'<div class="muted" style="margin:6px 0 12px">Nessun appuntamento futuro</div>';const T="past_"+Math.random().toString(36).slice(2,8);N+='<div id="'+T+'_head" style="margin-top:12px;display:flex;align-items:center;justify-content:space-between;cursor:pointer"><b>Passati</b><span class="chev"></span></div><div id="'+T+'_box" style="margin-top:8px">'+($.length?'<div class="grid3">'+$.map(vt).join("")+"</div>":'<div class="muted">Nessun appuntamento passato</div>')+"</div>",_.innerHTML=N,(function(){const ot=document.getElementById(T+"_head"),pt=document.getElementById(T+"_box"),lt=ot.querySelector(".chev");ot.onclick=function(){const dt=pt.style.display==="none";pt.style.display=dt?"":"none",lt.textContent=dt?"":""}})();const gt=at;_.querySelectorAll("[data-ics]").forEach(ot=>{ot.addEventListener("click",pt=>{pt.stopPropagation();const lt=ot.getAttribute("data-ics"),dt=gt.find(yt=>String(yt.id)===String(lt));if(!dt){Nt("Appuntamento non trovato");return}if(window.BP&&BP.ICS&&typeof BP.ICS.downloadIcsForAppointment=="function")if(BP.ICS.downloadIcsForAppointment(dt)){typeof haptics<"u"&&haptics.try("medium");try{document.dispatchEvent(new Event("ics:exported"))}catch(Ct){}Nt("Esportato")}else Nt("Export .ics non disponibile");else Nt("Export .ics non disponibile")})}),document.querySelectorAll("#a_list .card[data-aid]").forEach(ot=>{ot.addEventListener("click",()=>{const pt=ot.getAttribute("data-aid"),lt=gt.find(dt=>String(dt.id)===String(pt));lt&&(re(lt),window.scrollTo({top:0,behavior:"smooth"}))})})})}try{const P=sa("bp_prefill_slot",null);if(P&&P.start){const et=new Date(P.start),J=new Date(P.end||P.start),F=new Date(et.getTime()-et.getTimezoneOffset()*6e4).toISOString().slice(0,16);document.getElementById("a_start").value=F,document.getElementById("a_dur").value=String(Math.max(1,Math.round((J-et)/6e4))),Ut(),Nt("Slot precompilato negli appuntamenti")}vo("bp_prefill_slot")}catch(P){}document.getElementById("btnSaveA").onclick=()=>C(!1),document.getElementById("btnSaveExportA").onclick=()=>C(!0),document.getElementById("btnDeleteA").onclick=L,qt("/api/clients").then(()=>{}),K()}let f=null,b=[],v=null,y=null,E=null,M=null,X=null,it=null,Q=null,ft=null,ut=null,ct=[];function It(m,g=!1){ct.forEach(nt=>nt.classList.toggle("active",nt===m));const S=document.getElementById("a_type"),C=document.getElementById("a_client_display"),L=document.getElementById("a_client_select"),z=document.getElementById("row_vss"),tt=document.getElementById("row_vsd_p"),q=document.getElementById("row_vsd_i"),ht=document.getElementById("row_tel"),V=document.getElementById("row_app");g||(v.setAttribute("data-active","0"),v.setAttribute("aria-pressed","false"),v.classList.remove("active")),C.disabled=!1,C.value="",L.value="",z.style.display="",tt.style.display="",q.style.display="none",ht.style.display="none",V.style.display="none",v.style.display="",m===y?(S.value="vendita",Ot(90)):m===E?(S.value="mezza",Ot(240),document.getElementById("a_vsd").value="1000"):m===M?(S.value="giornata",Ot(570),document.getElementById("a_vsd").value="2000"):m===X?(S.value="formazione",Ot(570),C.value="Formazione",C.disabled=!0,z.style.display="none",tt.style.display="none",v.style.display="none"):m===it?(S.value="MBS",Ot(570),C.value="MBS",C.disabled=!0,z.style.display="none",tt.style.display="none",q.style.display="",document.getElementById("a_vsd_i").value="2000",v.style.display="none"):m===Q?(S.value="sottoprodotti",Ot(240),C.value="Sottoprodotti",C.disabled=!0,z.style.display="none",tt.style.display="none",ht.style.display="",V.style.display="",v.style.display="none"):m===ft?(S.value="riunione",Ot(60),C.value="Riunione",C.disabled=!0,z.style.display="none",tt.style.display="none",v.style.display="none"):m===ut&&(S.value="impegni personali",Ot(60),C.value="Impegni personali",C.disabled=!0,z.style.display="none",tt.style.display="none",v.style.display="none")}function Ot(m){const g=document.getElementById("a_dur");g.value=String(m),Ut()}function Ut(){const m=document.getElementById("a_start").value,g=parseInt(document.getElementById("a_dur").value||"0",10);if(!m||!isFinite(g)||g<=0){document.getElementById("a_end").value="";return}const S=new Date(m),C=new Date(S.getTime()+g*6e4);document.getElementById("a_end").value=("0"+C.getHours()).slice(-2)+":"+("0"+C.getMinutes()).slice(-2)}function Vt(){const m=document.getElementById("a_start").value,g=document.getElementById("a_end").value;if(!m||!g)return;const S=new Date(m),C=g.split(":");if(C.length<2)return;const L=new Date(S);L.setHours(parseInt(C[0],10)||0,parseInt(C[1],10)||0,0,0),L<S&&L.setDate(L.getDate()+1);let z=Math.round((L-S)/6e4);document.getElementById("a_dur").value=String(Math.max(1,z))}function Mt(m){return String(m).replace(/[&<>'"]/g,g=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[g])}function $t(m){var g=Number(m)||0;return g.toLocaleString("it-IT")+""}function Kt(m){var g=new Date(m);return("0"+g.getDate()).slice(-2)+"/"+("0"+(g.getMonth()+1)).slice(-2)+"/"+g.getFullYear()}function Zt(m){if(!m)return"";const g=new Date(m);return isNaN(g)?"":g.toISOString()}function ae(m){if(!m)return"";const g=BPTimezone.parseUTCString(m);return isNaN(g)?"":new Date(g.getTime()-g.getTimezoneOffset()*6e4).toISOString().slice(0,16)}function Ce(m){return m=String(m||"").toLowerCase(),m.indexOf("mezza")>-1?240:m.indexOf("giorn")>-1||m.indexOf("formaz")>-1||m.indexOf("mbs")>-1?570:m.indexOf("sottoprod")>-1?240:m.indexOf("riunione")>-1||m.indexOf("impegni personali")>-1?60:90}function re(m){try{f=m.id;const S=document.getElementById("a_form_title");S&&(S.textContent="Modifica appuntamento");var g=String(m.type||"vendita").toLowerCase();try{g.indexOf("mezza")>-1?It(E):g.indexOf("giorn")>-1?It(M):g.indexOf("formaz")>-1?It(X):g.indexOf("mbs")>-1?It(it):g.indexOf("sottoprod")>-1?It(Q):g.indexOf("riunione")>-1?It(ft):g.indexOf("impegni personali")>-1?It(ut):It(y)}catch(R){console.error("Error in selectSeg:",R),It(y)}const C=document.getElementById("a_client_display"),L=document.getElementById("a_client_select");if(C&&(C.value=m.client||""),L&&(L.value=m.clientId||""),m.clientId&&b){const R=b.find(W=>W.id===m.clientId);R&&R.status==="attivo"?(v.disabled=!0,v.style.opacity="0.5",v.style.cursor="not-allowed"):(v.disabled=!1,v.style.opacity="1",v.style.cursor="pointer")}else v.disabled=!1,v.style.opacity="1",v.style.cursor="pointer";const z=document.getElementById("a_start");z&&(z.value=ae(m.start));const tt=BPTimezone.parseUTCString(m.start);let q=m.end?BPTimezone.parseUTCString(m.end):null,ht=Number(m.durationMinutes);q instanceof Date&&!isNaN(q)&&q>=tt?ht=Math.max(1,Math.round((q-tt)/6e4)):isFinite(ht)&&ht>0?q=new Date(tt.getTime()+ht*6e4):(ht=Ce(m.type||"vendita"),q=new Date(tt.getTime()+ht*6e4));const V=document.getElementById("a_dur"),nt=document.getElementById("a_end");V&&(V.value=String(ht)),nt&&(nt.value=("0"+q.getHours()).slice(-2)+":"+("0"+q.getMinutes()).slice(-2));const vt=document.getElementById("a_vss"),K=document.getElementById("a_vsd"),P=document.getElementById("a_vsd_i"),et=document.getElementById("a_tel"),J=document.getElementById("a_app"),F=document.getElementById("a_desc");vt&&(vt.value=m.vss||""),K&&(K.value=m.vsdPersonal||m.vsd||""),P&&(P.value=m.vsdIndiretto||""),et&&(et.value=m.telefonate||""),J&&(J.value=m.appFissati||""),F&&(F.value=m.notes||"");const B=!!m.nncf;v.setAttribute("data-active",B?"1":"0"),v.setAttribute("aria-pressed",B?"true":"false"),v.classList.toggle("active",B);const at=document.getElementById("btnDeleteA");at&&(at.style.display="")}catch(S){console.error("Error in fillForm:",S),Nt("Errore nel caricamento dell'appuntamento")}}function Se(){if(!Jt())return t();document.title="Battle Plan  Classifiche",Ge("viewLeaderboard"),n.innerHTML=$e()+('<div class="wrap"><div class="card"><div class="row"><div><label>Vista</label><select id="lb_tab"><option value="per_indicator">Per indicatore</option><option value="overall">Generale (score)</option></select></div><div><label>Modalit</label><select id="lb_mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div><div id="lb_ind_wrap"><label>Indicatore</label><select id="lb_indicator"><option value="VSS">VSS</option><option value="VSDPersonale">VSD</option><option value="GI">GI</option><option value="NNCF">NNCF</option></select></div></div>'+e("lb")+'</div><div class="card"><b id="lb_title">Classifica</b><div id="lb_podium" style="margin:10px 0"></div><div id="lb_table"></div></div></div>'),Oe();function m(V){if(!V)return"";var nt=new Date(V);return nt.getFullYear()+"-"+("0"+(nt.getMonth()+1)).slice(-2)+"-"+("0"+nt.getDate()).slice(-2)}function g(V){return V==="ytd"||V==="ltm"?"mensile":V}document.getElementById("lb_tab").onchange=function(){var V=this.value;document.getElementById("lb_ind_wrap").style.display=V==="per_indicator"?"":"none",C()},o("lb",C),document.getElementById("lb_mode").onchange=C,document.getElementById("lb_indicator").onchange=C;function S(){var V=a("lb"),nt=m(V.start),vt=m(V.end),K=g(V.type||"mensile");return"&from="+encodeURIComponent(nt)+"&to="+encodeURIComponent(vt)+"&type="+encodeURIComponent(K)}function C(){var V=document.getElementById("lb_tab").value,nt=S(),vt=document.getElementById("lb_mode").value;if(V==="overall")qt("/api/leaderboard_overall?mode="+encodeURIComponent(vt)+nt).then(ht);else{var K=document.getElementById("lb_indicator").value;qt("/api/leaderboard?indicator="+encodeURIComponent(K)+"&mode="+encodeURIComponent(vt)+nt).then(function(P){q(P,K)})}}function L(V){return V===0?"":V===1?"":V===2?"":V+1+"."}function z(V){var nt=document.getElementById("lb_podium");if(!V||!V.length){nt.innerHTML="";return}for(var vt=V.slice(0,3),K='<div class="row" style="align-items:flex-end">',P=0;P<vt.length;P++){var et=80-P*15;K+='<div class="card" style="flex:1 1 120px;height:'+et+'px;display:flex;align-items:flex-end;justify-content:center"><div>'+Mt(L(P)+" "+vt[P].name)+"</div></div>"}K+="</div>",nt.innerHTML=K}function tt(V,nt,vt){var K=Math.min(100,Math.max(0,Math.round(vt)));return'<div class="card lb-card" style="flex:1 1 280px"><div class="big">'+Mt(V)+'</div><div class="small muted">'+Mt(nt)+'</div><div class="lb-bar"><div style="width:'+K+'%"></div></div></div>'}function q(V,nt){document.getElementById("lb_title").textContent="Classifica  "+nt;var vt=V.ranking||[];if(z(vt),!vt.length){document.getElementById("lb_table").innerHTML='<div class="muted">Nessun dato</div>';return}for(var K='<div class="row">',P=vt[0].total||1,et=0;et<vt.length;et++){var J=vt[et];K+=tt(L(et)+" "+J.name,"Totale: "+Be(J.total),J.total/P*100)}K+="</div>",document.getElementById("lb_table").innerHTML=K}function ht(V){document.getElementById("lb_title").textContent="Classifica generale";var nt=V.ranking||[];if(z(nt),!nt.length){document.getElementById("lb_table").innerHTML='<div class="muted">Nessun dato</div>';return}for(var vt=nt[0].score||0,K='<div class="row">',P=0;P<nt.length;P++){var et=nt[P];K+=tt(L(P)+" "+et.name,"Score: "+Be(et.score)+"/100",vt?et.score/vt*100:0)}K+="</div>",document.getElementById("lb_table").innerHTML=K}C()}(function(){function m(){var g=document.getElementById("bp-overlay");return g||(g=document.createElement("div"),g.id="bp-overlay",g.className="hidden",g.setAttribute("role","dialog"),g.setAttribute("aria-modal","true"),g.innerHTML='<div class="bp-overlay-backdrop" id="bp-overlay-backdrop"></div><div class="bp-overlay-panel" id="bp-overlay-panel"></div>',document.body.appendChild(g),document.getElementById("bp-overlay-backdrop").addEventListener("click",hideOverlay)),g}window.showOverlay=function(g){var S=m(),C=document.getElementById("bp-overlay-panel");C.innerHTML=g||"",S.classList.remove("hidden");var L=C.querySelector("input, textarea, select, button");L&&setTimeout(function(){try{L.focus()}catch(z){}},0)},window.hideOverlay=function(){var g=document.getElementById("bp-overlay");g&&g.classList.add("hidden")}})();function We(){if(!Jt())return t();document.title="Battle Plan  Clienti",Ge("viewClients");const m=Jt().role==="admin",g=m?'<div><label>Consulente</label><select id="cl_new_owner"><option value=""></option></select></div>':"",S=m?'<div><label>Consulente</label><select id="cl_f_cons"><option value="">Tutti</option></select></div>':"";n.innerHTML=$e()+'<div class="wrap"><div class="card"><b>Nuovo cliente</b><div class="row" style="margin-top:8px"><div><label>Ragione sociale</label><input id="cl_name" type="text" placeholder="Es. Rossi S.r.l."></div><div><label>Stato</label><select id="cl_new_state"><option value="potenziale">Potenziale</option><option value="lead non chiuso">Lead non chiuso</option><option value="attivo">Attivo</option></select></div>'+g+'<div class="right"><button id="cl_add">Aggiungi</button></div></div></div><div class="card"><b>Filtri elenco</b><div class="row" style="margin-top:8px"><div><label>Stato</label><select id="cl_f_state"><option value="">Tutti</option><option value="attivo">Attivo</option><option value="lead non chiuso">Lead non chiuso</option><option value="potenziale">Potenziale</option></select></div>'+S+'<div><label>Ordina per</label><select id="cl_order"><option value="az">Ragione sociale (AZ)</option><option value="last_desc">Ultimo appuntamento (recenti prima)</option></select></div><div class="right"><button class="ghost" id="cl_f_apply">Applica</button></div></div></div><div class="card"><b>Elenco clienti</b><div id="cl_list" class="row" style="margin-top:8px"></div></div></div>',Oe();function C(){const tt=(document.getElementById("cl_name").value||"").trim();if(!tt){Nt("Nome obbligatorio");return}const q=document.getElementById("cl_new_state"),ht=document.getElementById("cl_new_owner"),V={name:tt};q&&(V.status=q.value),ht&&ht.value?V.consultantId=ht.value:m||(V.consultantId=Jt().id),Le("/api/clients",V).then(function(){document.getElementById("cl_name").value="",z(),Gi(),window.addXP(5),typeof window.BP<"u"&&window.BP.Coach&&typeof window.BP.Coach.say=="function"&&window.BP.Coach.say("client_created",{intensity:"medium"})}).catch(function(nt){logger.error(nt),Nt("Errore creazione cliente")})}function L(){m&&qt("/api/usernames").then(function(tt){const q=tt&&tt.users||[],ht=document.getElementById("cl_f_cons"),V=document.getElementById("cl_new_owner"),nt=Jt()||{};if(ht){var vt="";nt.role==="admin"&&(vt+='<option value="">Tutti</option>',vt+=q.map(function(P){return'<option value="'+P.id+'">'+Mt(P.name)+(P.grade?" ("+P.grade+")":"")+"</option>"}).join("")),ht.innerHTML=vt,ht.value=nt.role==="admin"?"":nt.id}if(V){var K='<option value=""></option>';K+=q.map(function(P){return'<option value="'+P.id+'">'+Mt(P.name)+(P.grade?" ("+P.grade+")":"")+"</option>"}).join(""),V.innerHTML=K,V.value=nt.id}}).catch(function(tt){logger.error(tt)})}function z(){qt("/api/clients").then(function(tt){const q=tt&&tt.clients||[],ht=document.getElementById("cl_f_state").value,V=document.getElementById("cl_f_cons"),nt=V?V.value:String(Jt().id);function vt(et){return String(et||"").trim().toLowerCase()}const P=q.filter(function(et){return!(ht&&vt(et.status)!==vt(ht)||nt&&String(et.consultantId||"")!==String(nt))}).map(function(et){const J=Mt(et.name||""),F=Mt(et.status||"potenziale"),B=et.consultantName?Mt(et.consultantName):"unknown",at=String(et.id||"");return'<div class="card" data-clid="'+at+'" data-name-lower="'+J.toLowerCase()+'" data-status="'+F+'" data-consultant-id="'+Mt(String(et.consultantId||""))+'" style="flex:1 1 380px"><div><b>'+J+'</b></div><div class="small">Stato: <b class="cl-status">'+F+'</b></div><div class="small">Consulente: <b class="cl-cons">'+B+'</b></div><div class="small muted">Ultimo appuntamento: <span class="last-appt"></span></div><div class="right" style="margin-top:6px"><button class="ghost" data-del="'+at+'">Rimuovi</button></div></div>'}).join("");document.getElementById("cl_list").innerHTML=P||'<div class="muted">Nessun cliente</div>',document.querySelectorAll("[data-del]").forEach(function(et){et.addEventListener("click",function(){const J=et.getAttribute("data-del");confirm("Rimuovere il cliente?")&&fetch("/api/clients?id="+encodeURIComponent(J),{method:"DELETE",headers:{Authorization:"Bearer "+ro()}}).then(function(F){if(!F.ok)throw new Error("HTTP "+F.status);return F.json()}).then(function(){Nt("Cliente rimosso"),z()}).catch(function(F){logger.error(F),Nt("Errore rimozione")})})}),window.BPFinal&&typeof BPFinal.ensureClientSection=="function"?BPFinal.ensureClientSection():setTimeout(function(){const et=document.getElementById("cl_list"),J=Array.from(et.children).filter(F=>F.classList.contains("card"));J.sort((F,B)=>String(F.getAttribute("data-name-lower")||"").localeCompare(String(B.getAttribute("data-name-lower")||"")));for(const F of J)et.appendChild(F)},0)})}document.getElementById("cl_add").onclick=C,document.getElementById("cl_f_apply").onclick=z,m&&L(),z(),typeof kickFinal=="function"&&kickFinal("clients")}function Te(){if(!Jt())return t();document.title="Battle Plan  Squadra",Ge("viewTeam");const m=Jt().role==="admin";var g=$e()+'<div class="wrap">'+(m?'<div class="card"><b>Vista Amministratore</b><div id="t_adminbar" class="row" style="margin-top:8px;display:flex;align-items:flex-end;gap:16px;flex-wrap:wrap"><div><label>Modalit</label><select id="t_mode" name="mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div><div id="t_unified_wrap">'+e("t")+"</div></div></div>":"")+'<div class="card"><b>Grafico</b><div class="row" style="margin-top:8px;align-items:flex-end;gap:16px;flex-wrap:wrap"><div><label>Indicatore grafico</label><select id="t_ind"><option value="VSS">VSS</option><option value="VSDPersonale">VSD Personale</option><option value="VSDIndiretto">VSD Indiretto</option><option value="VSDTotale">VSD Totale</option><option value="GI">GI</option><option value="NNCF">NNCF</option><option value="provv_gi">Provv GI</option><option value="provv_vsd">Provv VSD</option><option value="tot_provv" selected>Tot Provvigioni</option></select></div><div><label>Consulente</label><select id="t_cons">'+(m?'<option value="">Tutti</option>':"")+'</select></div></div><div style="margin-top:8px"><canvas id="t_chart" height="160" style="width:100%"></canvas></div></div><div class="card"><b>Aggregato Squadra</b><div id="t_agg" class="row" style="margin-top:8px"></div></div><div class="card"><b>'+(m?"Riepilogo per utente":"Il mio riepilogo")+'</b><div id="t_users" class="row" style="margin-top:8px"></div></div></div>';n.innerHTML=g,Oe(),(function(){var N=document.getElementById("t_adminbar"),T=document.getElementById("t_unified_wrap");if(!(!N||!T)){var gt=T.querySelector(".row");gt&&(Array.from(gt.children).forEach(function(st){st.classList.remove("right"),st.style.marginTop="0",N.appendChild(st)}),T.remove())}})();function S(_){return _=Number(_||0),isFinite(_)?_:0}function C(_){if(!_)return"";var N=new Date(_);return N.getFullYear()+"-"+("0"+(N.getMonth()+1)).slice(-2)+"-"+("0"+N.getDate()).slice(-2)}function L(_){return _=String(_||"mensile").toLowerCase(),_.indexOf("sett")===0?"settimanale":_.indexOf("mes")===0?"mensile":_.indexOf("tri")===0?"trimestrale":_.indexOf("sem")===0?"semestrale":_.indexOf("ann")===0?"annuale":"mensile"}function z(){var _=a("t"),N=C(_.start),T=C(_.end),gt=L(_.type);return"&from="+encodeURIComponent(N)+"&to="+encodeURIComponent(T)+"&type="+encodeURIComponent(gt)}function tt(_){switch(String(_)){case"provv_gi":return"ProvvGI";case"provv_vsd":return"ProvvVSD";case"tot_provv":return"TotProvvigioni";default:return _}}function q(_){var N=Number(_)||0;return N.toLocaleString("it-IT")+""}function ht(_){var N=Number(_)||0;return String(Math.round(N))}function V(_){return String(_).replace(/[&<>'"]/g,N=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[N])}var nt=null;function vt(_,N){return N==="settimanale"?window.isoWeekNum?window.isoWeekNum(_):Math.ceil(_.getDate()/7):N==="mensile"||N==="ytd"||N==="ltm"?_.getMonth()+1:N==="trimestrale"?Math.floor(_.getMonth()/3)+1:N==="semestrale"?_.getMonth()<6?1:2:_.getFullYear()}function K(_,N){var T=document.getElementById("t_chart");if(T){var gt=F(N),st=typeof l=="function"?l(N,gt):_.map(function(wt){return vt(wt.x,N)}),ot=_.map(function(wt){return wt.y});if(!mn){var dt=T.getContext("2d");T.width=T.clientWidth||600,T.height=T.clientHeight||160,dt.clearRect(0,0,T.width,T.height);var pt=Math.max(1,...ot),lt=ot.length>1?(T.width-8)/(ot.length-1):0;dt.beginPath(),dt.lineWidth=2,dt.strokeStyle="#2e6cff",ot.forEach(function(Tt,Ft){var Pt=4+Ft*lt,At=T.height-6-Tt/pt*(T.height-12);Ft?dt.lineTo(Pt,At):dt.moveTo(Pt,At)}),dt.stroke(),dt.fillStyle="#2e6cff",ot.forEach(function(Tt,Ft){var Pt=4+Ft*lt,At=T.height-6-Tt/pt*(T.height-12);dt.beginPath(),dt.arc(Pt,At,2,0,Math.PI*2),dt.fill()});return}T.style.width="100%",T.width=T.parentNode.clientWidth;var dt=T.getContext("2d"),yt=typeof window.computeTickOptions=="function"?window.computeTickOptions(st,T.width||600):{autoSkip:!0,maxRotation:0,minRotation:0};if(nt)nt.data.labels=st,nt.data.datasets[0].data=ot,nt.options.scales.x.ticks=yt,nt.update();else{var Ct=typeof mn.getChart=="function"?mn.getChart(T):null;Ct&&Ct.destroy(),nt=new mn(dt,{type:"line",data:{labels:st,datasets:[{label:"",data:ot,tension:.3,pointRadius:3,pointHoverRadius:5}]},options:{responsive:!0,maintainAspectRatio:!1,animation:!1,animations:!1,plugins:{legend:{display:!1}},scales:{x:{grid:{display:!1},ticks:yt},y:{beginAtZero:!0}}}})}nt.resize()}}function P(_){return'<div class="card" style="flex:1 1 360px"><div style="display:flex;align-items:center;gap:8px"><div><b>'+V(_.name||"User #"+_.userId)+"</b></div>"+(_.grade?'<span class="chip small">'+V(_.grade)+"</span>":"")+'</div><div class="small" style="margin-top:6px">VSS '+q(_.vss||0)+'</div><div class="small">VSD Pers. '+q(_.vsdP||0)+'</div><div class="small">VSD Ind. '+q(_.vsdI||0)+'</div><div class="small">VSD Tot. '+q((_.vsdP||0)+(_.vsdI||0))+'</div><div class="small">GI '+q(_.gi||0)+'</div><div class="small">NNCF '+ht(_.nncf||0)+'</div><div class="small muted" style="margin-top:6px">Provv GI '+q(_.provvGi||0)+'</div><div class="small muted">Provv VSD '+q(_.provvVsd||0)+'</div><div class="small"><b>Tot Provvigioni '+q(_.provvTot||0)+"</b></div></div>"}function et(_){return'<div class="card" style="flex:1 1 460px"><div class="neon" style="font-weight:900">Totali squadra</div><div class="small" style="margin-top:6px">VSS '+q(_.vss)+'</div><div class="small">VSD Pers. '+q(_.vsdP)+'</div><div class="small">VSD Ind. '+q(_.vsdI)+'</div><div class="small">VSD Tot. '+q(_.vsdP+_.vsdI)+'</div><div class="small">GI '+q(_.gi)+'</div><div class="small">NNCF '+ht(_.nncf)+'</div><div class="small muted" style="margin-top:6px">Provv GI '+q(_.provvGi)+'</div><div class="small muted">Provv VSD '+q(_.provvVsd)+'</div><div class="small"><b>Tot Provvigioni '+q(_.provvTot)+"</b></div></div>"}function J(){var _=(document.getElementById("t_mode")||{}).value||"consuntivo",N=z();Promise.all([qt("/api/usernames"),qt("/api/leaderboard?indicator="+encodeURIComponent("VSS")+N+"&mode="+encodeURIComponent(_)),qt("/api/leaderboard?indicator="+encodeURIComponent("VSDPersonale")+N+"&mode="+encodeURIComponent(_)),qt("/api/leaderboard?indicator="+encodeURIComponent("VSDIndiretto")+N+"&mode="+encodeURIComponent(_)),qt("/api/leaderboard?indicator="+encodeURIComponent("GI")+N+"&mode="+encodeURIComponent(_)),qt("/api/leaderboard?indicator="+encodeURIComponent("NNCF")+N+"&mode="+encodeURIComponent(_)),qt("/api/leaderboard?indicator="+encodeURIComponent("ProvvGI")+N+"&mode="+encodeURIComponent(_)),qt("/api/leaderboard?indicator="+encodeURIComponent("ProvvVSD")+N+"&mode="+encodeURIComponent(_))]).then(function(T){var gt=T[0]||{},st=T[1]&&(T[1].rows||T[1].ranking)||[],ot=T[2]&&(T[2].rows||T[2].ranking)||[],pt=T[3]&&(T[3].rows||T[3].ranking)||[],lt=T[4]&&(T[4].rows||T[4].ranking)||[],dt=T[5]&&(T[5].rows||T[5].ranking)||[],yt=T[6]&&(T[6].rows||T[6].ranking)||[],Ct=T[7]&&(T[7].rows||T[7].ranking)||[],wt=(gt.users||[]).map(function(Bt){return{id:String(Bt.id),name:Bt.name||Bt.email||"User #"+Bt.id,grade:Bt.grade==="senior"?"senior":"junior"}}),Tt=document.getElementById("t_cons");if(Tt){var Ft=Jt();m?Tt.innerHTML='<option value="">Tutti</option>'+wt.map(function(Bt){return'<option value="'+Bt.id+'">'+V(Bt.name)+"</option>"}).join(""):Tt.innerHTML='<option value="'+Ft.id+'">'+V(Ft.name||Ft.email||"User #"+Ft.id)+"</option>"}function Pt(Bt){for(var Lt={},Ht=0;Ht<Bt.length;Ht++){var j=Bt[Ht],Z=String(j.userId||j.id||j.uid||""),xt=S(j.total||j.value||j.sum||0);Z&&(Lt[Z]=xt)}return Lt}var At=Pt(st),te=Pt(ot),Yt=Pt(pt),Et=Pt(lt),bt=Pt(dt),Dt=Pt(yt),G=Pt(Ct),mt=wt.map(function(Bt){var Lt=S(At[Bt.id]),Ht=S(te[Bt.id]),j=S(Yt[Bt.id]),Z=S(Et[Bt.id]),xt=S(bt[Bt.id]),kt=S(Dt[Bt.id]),_t=S(G[Bt.id]);return{userId:Bt.id,name:Bt.name,grade:Bt.grade,vss:Lt,vsdP:Ht,vsdI:j,gi:Z,nncf:xt,provvGi:kt,provvVsd:_t,provvTot:kt+_t}}),Rt=document.getElementById("t_users");if(Rt){var Ft=Jt(),jt=m?mt:mt.filter(function(Lt){return String(Lt.userId)===String(Ft.id)});Rt.innerHTML=jt.length?jt.map(P).join(""):'<div class="muted">Nessun dato</div>'}var zt=mt.reduce(function(Bt,Lt){return Bt.vss+=Lt.vss,Bt.vsdP+=Lt.vsdP,Bt.vsdI+=Lt.vsdI,Bt.gi+=Lt.gi,Bt.nncf+=Lt.nncf,Bt.provvGi+=Lt.provvGi,Bt.provvVsd+=Lt.provvVsd,Bt.provvTot+=Lt.provvTot,Bt},{vss:0,vsdP:0,vsdI:0,gi:0,nncf:0,provvGi:0,provvVsd:0,provvTot:0}),Qt=document.getElementById("t_agg");Qt&&(Qt.innerHTML=et(zt)),at()}).catch(function(T){logger.error(T),Nt("Errore caricamento squadra")})}function F(_){return(typeof r=="function"?r(_,new Date):[]).map(function(N){return{s:N.s,e:N.e}})}function B(_,N,T,gt){var st=gt||a("t"),ot=String(st.type||"mensile").toLowerCase(),pt=ot==="ytd"||ot==="ltm"?"mensile":ot,lt=F(ot);function dt(wt,Tt){var Ft=new Date(Tt.startDate).getTime(),Pt=new Date(Tt.endDate).getTime();return Ft>=wt.s&&Pt<=wt.e}function yt(wt,Tt){if(!wt)return 0;if(Tt==="VSDTotale")return Number(wt.VSDPersonale||0)+Number(wt.VSDIndiretto||0);if(Tt==="ProvvGI")return Number(wt.ProvvGI||0);if(Tt==="ProvvVSD")return Number(wt.ProvvVSD||0);if(Tt==="TotProvvigioni"){var Ft=wt.TotProvvigioni;return Number(Ft!=null?Ft:Number(wt.ProvvGI||0)+Number(wt.ProvvVSD||0))}return Number(wt[Tt]||0)}var Ct=(function(){var wt=lt.length?C(new Date(lt[0].s)):C(new Date),Tt=lt.length?C(new Date(lt[lt.length-1].e)):C(new Date),Ft="?global=1&type="+encodeURIComponent(pt)+"&from="+encodeURIComponent(wt)+"&to="+encodeURIComponent(Tt);return T&&(Ft+="&userId="+encodeURIComponent(T)),Ft})();return qt("/api/periods"+Ct).catch(function(){return qt("/api/periods"+Ct.replace("?global=1",""))}).then(function(wt){var Tt=wt&&wt.periods||[],Ft=Tt.filter(function(At){return!(At.type!==pt||T&&String(At.userId||At.uid||"")!==String(T))}),Pt=lt.map(function(At){for(var te=0,Yt=0;Yt<Ft.length;Yt++){var Et=Ft[Yt];if(dt(At,Et)){var bt=N==="previsionale"?Et.indicatorsPrev||{}:Et.indicatorsCons||{};te+=yt(bt,tt(_))}}return{x:new Date(At.s),y:Math.round(te*100)/100}});return Pt})}function at(){var _=document.getElementById("t_ind"),N=_?_.value:"VSS",T=document.getElementById("t_mode"),gt=T?T.value:"consuntivo",st=document.getElementById("t_cons"),ot=st?st.value:m?"":Jt().id,pt=a("t"),lt=pt.type,dt=tt(N);z()+(ot?"&userId="+encodeURIComponent(ot):"")+("&indicator="+encodeURIComponent(dt))+("&mode="+encodeURIComponent(gt));var yt=B(dt,gt,ot||null,pt);yt.then(function(Ct){K(Ct,lt)}).catch(function(Ct){logger.error(Ct),K([],lt)})}m&&o("t",function(){typeof haptic=="function"&&haptic("light"),J()});var R=document.getElementById("t_mode");R&&(R.onchange=function(){typeof haptic=="function"&&haptic("light"),J()});var W=document.getElementById("t_ind");W&&(W.onchange=function(){typeof haptic=="function"&&haptic("light"),at()});var $=document.getElementById("t_cons");$&&($.onchange=function(){typeof haptic=="function"&&haptic("light"),at()}),J()}function Ke(){if(!Jt())return t();Ge("viewCommissions");var m=Jt().role==="admin";document.title="Battle Plan  Provvigioni",n.innerHTML=$e()+'<div class="wrap"><div class="card"><b>Calcolo provvigioni</b><div class="row" style="margin-top:8px; gap:12px; flex-wrap:wrap">'+(m?'<div><label>Utente</label><select id="comm_user"><option value="__all">Tutta la squadra</option></select></div>':"")+'<div><label>Modalit</label><select id="comm_mode" name="mode"><option value="previsionale">Previsionale</option><option value="consuntivo">Consuntivo</option></select></div></div>'+e("comm")+'</div><div class="card"><b>Indicatori periodo</b><div id="comm_total" style="margin-top:8px"></div></div><div class="card"><b>Provvigioni  ripartizione</b><div class="small muted">Confronto tra Provvigioni GI e Provvigioni VSD sul periodo selezionato</div><div class="row" style="margin-top:8px; align-items:center; gap:16px; flex-wrap:wrap"><canvas id="cm_pie_provv" width="260" height="260" style="max-width:260px; max-height:260px"></canvas><div id="cm_pie_legend" class="small"></div></div></div><div class="card"><b>Dettaglio</b><div id="comm_rows" class="row" style="margin-top:8px; gap:12px; flex-wrap:wrap"></div></div></div>',Oe();function g(K){return document.getElementById(K)}function S(K){if(!K)return"";var P=new Date(K);return P.getFullYear()+"-"+("0"+(P.getMonth()+1)).slice(-2)+"-"+("0"+P.getDate()).slice(-2)}function C(K){var P=Number(K)||0;return P.toLocaleString("it-IT")+""}function L(K){return K=Number(K==null?"":K),isFinite(K)?K:0}function z(K){return K?K.TotProvvigioni!=null?L(K.TotProvvigioni):L(K.ProvvGI)+L(K.ProvvVSD):0}function tt(K,P){return'<div class="card"><div class="small muted">'+Mt(K)+'</div><div style="font-weight:700; font-size:20px; margin-top:4px">'+P+"</div></div>"}function q(K){return'<div class="table" style="overflow:auto"><table class="simple" style="width:100%; border-collapse:separate; border-spacing:12px 8px"><tbody><tr><td>'+tt("VSD personale",C(K.vsd||0))+"</td><td>"+tt("GI",C(K.gi||0))+"</td></tr><tr><td>"+tt("Provv. VSD",C(K.provv_vsd||0))+"</td><td>"+tt("Provv. GI",C(K.provv_gi||0))+"</td><td>"+tt("Totale Provvigioni",C(K.provv_total||0))+"</td></tr></tbody></table></div>"}function ht(K){return K.length?K.map(function(P){return'<div class="card" style="flex:1 1 320px"><div><b>'+Mt(P.name)+'</b></div><div class="small" style="margin-top:4px">GI '+C(P.gi||0)+"  VSD "+C(P.vsd||0)+'</div><div class="small muted" style="margin-top:2px">Provv. GI '+C(P.provv_gi||0)+"  Provv. VSD "+C(P.provv_vsd||0)+'</div><div class="small" style="margin-top:6px"><b>Totale: '+C(P.provv_total||0)+"</b></div></div>"}).join(""):'<div class="muted">Nessun dato</div>'}function V(K,P,et){var J=document.getElementById("cm_pie_provv"),F=document.getElementById("cm_pie_legend");if(!J||!J.getContext){F&&(F.innerHTML="");return}var B=J.getContext("2d"),at=J.width,R=J.height,W=at/2,$=R/2,_=Math.min(at,R)/2-8;B.clearRect(0,0,at,R);var N=Math.max(0,K||0),T=Math.max(0,P||0),gt=N+T,st=et>0?Math.round(gt/et*100):null;if(gt<=0){B.beginPath(),B.arc(W,$,_,0,Math.PI*2),B.strokeStyle="#ccd0d5",B.lineWidth=10,B.setLineDash([6,6]),B.stroke(),B.setLineDash([]),B.globalCompositeOperation="destination-out",B.beginPath(),B.arc(W,$,_*.55,0,Math.PI*2),B.fill(),B.globalCompositeOperation="source-over",B.fillStyle="#111",B.textAlign="center",B.textBaseline="middle",B.font="bold 20px system-ui, -apple-system, Segoe UI, Roboto, sans-serif",B.fillText(st==null?"":st+"%",W,$),F&&(F.innerHTML='<div class="muted">Nessuna provvigione nel periodo</div>');return}var ot=[{label:"Provv. GI",value:N,color:"#4F8EF7"},{label:"Provv. VSD",value:T,color:"#F79F4F"}],pt=-Math.PI/2;ot.forEach(function(yt){var Ct=yt.value/gt*Math.PI*2;B.beginPath(),B.moveTo(W,$),B.arc(W,$,_,pt,pt+Ct),B.closePath(),B.fillStyle=yt.color,B.fill(),pt+=Ct}),B.globalCompositeOperation="destination-out",B.beginPath(),B.arc(W,$,_*.55,0,Math.PI*2),B.fill(),B.globalCompositeOperation="source-over",B.fillStyle="#111",B.textAlign="center",B.textBaseline="middle",B.font="bold 20px system-ui, -apple-system, Segoe UI, Roboto, sans-serif",B.fillText(st==null?"":st+"%",W,$);var lt=Math.round(N/gt*100),dt=Math.round(T/gt*100);F&&(F.innerHTML='<div class="row" style="gap:16px; flex-wrap:wrap"><div class="row" style="gap:8px; align-items:center"><span style="display:inline-block;width:12px;height:12px;background:#4F8EF7;border-radius:3px"></span><span><b>Provv. GI</b> '+C(N)+"  "+lt+'%</span></div><div class="row" style="gap:8px; align-items:center"><span style="display:inline-block;width:12px;height:12px;background:#F79F4F;border-radius:3px"></span><span><b>Provv. VSD</b> '+C(T)+"  "+dt+"%</span></div></div>")}function nt(){var K=a("comm"),P=g("comm_mode").value||"consuntivo",et=m?g("comm_user").value||"__all":String(Jt().id),J=new Date(K.start).getTime(),F=new Date(K.end).getTime(),B=s(K.type||"mensile"),at=(function(){var R=S(new Date(J)),W=S(new Date(F)),$="?type="+encodeURIComponent(B)+"&from="+encodeURIComponent(R)+"&to="+encodeURIComponent(W);return m&&et&&et!=="__all"&&($+="&userId="+encodeURIComponent(et)),$})();qt("/api/periods"+at).then(function(R){var W=R&&R.periods||[],$=W.filter(function(T){if(T.type!==B)return!1;var gt=new Date(T.startDate).getTime(),st=new Date(T.endDate).getTime();return!(gt<J||st>F||m&&et!=="__all"&&String(T.userId||T.uid||"")!==String(et)||!m&&String(T.userId||T.uid||"")!==String(Jt().id))}),_={gi:0,vsd:0,provv_gi:0,provv_vsd:0,provv_total:0},N={};$.forEach(function(T){var gt=P==="previsionale"?T.indicatorsPrev||{}:T.indicatorsCons||{},st=String(T.userId||T.uid||""),ot=T.userName||T.name||"User "+st,pt=L(gt.GI),lt=L(gt.VSDPersonale),dt=L(gt.ProvvGI),yt=L(gt.ProvvVSD),Ct=z(gt);_.gi+=pt,_.vsd+=lt,_.provv_gi+=dt,_.provv_vsd+=yt,_.provv_total+=Ct,N[st]||(N[st]={userId:st,name:ot,gi:0,vsd:0,provv_gi:0,provv_vsd:0,provv_total:0}),N[st].gi+=pt,N[st].vsd+=lt,N[st].provv_gi+=dt,N[st].provv_vsd+=yt,N[st].provv_total+=Ct}),g("comm_total").innerHTML=q(_),g("comm_rows").innerHTML=ht(Object.values(N).sort(function(T,gt){return(gt.provv_total||0)-(T.provv_total||0)})),V(_.provv_gi||0,_.provv_vsd||0,_.gi||0)}).catch(function(R){logger.error(R),Nt("Errore nel caricamento dati")})}function vt(){m&&qt("/api/usernames").then(function(K){var P=g("comm_user");if(P){for(var et='<option value="__all">Tutta la squadra</option>',J=K&&K.users||[],F=0;F<J.length;F++){var B=J[F];et+='<option value="'+B.id+'">'+Mt(B.name||"User "+B.id)+"</option>"}P.innerHTML=et;var at=Jt()||{};P.value=at.id||"__all"}})}o("comm",function(){nt()}),g("comm_mode").onchange=function(){haptic("light"),nt()},m&&(g("comm_user").onchange=function(){haptic("light"),nt()}),vt(),nt()}function Ve(){if(!Jt())return t();document.title="Battle Plan  Vendite e Riordini",Ge("viewVendite");const m=Jt().role==="admin";n.innerHTML=$e()+'\n    <div class="wrap">\n\n      <div class="card">\n        <b>Filtro</b>\n        <div class="row" style="margin-top:6px;align-items:flex-end;gap:16px;flex-wrap:wrap">\n          '.concat(m?'<div><label>Consulente</label><select id="vr_cons"><option value="">Tutti</option></select></div>':"","\n        </div>\n        ").concat(e("vr"),'\n      </div>\n\n      <div class="card">\n        <b>Vendite e Riordini</b>\n        <div class="table" style="overflow:auto">\n          <table class="simple" style="min-width:980px">\n            <thead>\n              <tr>\n                <th>Data</th>\n                <th>Cliente</th>\n                <th>Consulente</th>\n              </tr>\n            </thead>\n            <tbody id="vr_rows">\n              <tr><td colspan="3" class="muted">Nessun dato</td></tr>\n            </tbody>\n          </table>\n        </div>\n      </div>\n\n    </div>'),Oe(),o("vr",()=>{})}function Je(){if(!Jt())return t();document.title="Battle Plan  GI & Scadenzario",Ge("viewGI");const m=Jt().role==="admin";n.innerHTML=$e()+'\n  <div class="wrap">\n\n    <!-- Hero Section -->\n    <div class="gi-card" style="background: linear-gradient(135deg, rgba(93,211,255,.12), rgba(141,123,255,.08)); border: 1px solid rgba(93,211,255,.3);">\n      <div class="gi-card-header">\n        <h1 class="gi-card-title">GI & Scadenzario</h1>\n        <div class="gi-card-actions">\n          <button class="ghost" id="gi_add" style="background: rgba(255,255,255,.1); border: 1px solid rgba(255,255,255,.2);">\n            <span style="margin-right: 8px;">+</span>Nuova vendita\n          </button>\n      </div>\n    </div>\n\n      <!-- Stats Grid -->\n      <div class="gi-stats-grid">\n        <div class="gi-stat-card">\n          <div class="gi-stat-value" id="gi-total-sales">-</div>\n          <div class="gi-stat-label">Vendite Totali</div>\n      </div>\n        <div class="gi-stat-card">\n          <div class="gi-stat-value" id="gi-total-amount">-</div>\n          <div class="gi-stat-label">Valore Totale</div>\n        </div>\n        <div class="gi-stat-card">\n          <div class="gi-stat-value" id="gi-pending-payments">-</div>\n          <div class="gi-stat-label">Pagamenti in Sospeso</div>\n        </div>\n        <div class="gi-stat-card">\n          <div class="gi-stat-value" id="gi-completed-payments">-</div>\n          <div class="gi-stat-label">Pagamenti Completati</div>\n        </div>\n      </div>\n    </div>\n\n    <!-- Sales Table -->\n    <div class="gi-card">\n      <div class="gi-card-header">\n        <h2 class="gi-card-title">Vendite (GI)</h2>\n        <div class="gi-card-actions">\n          <button class="ghost" onclick="refreshGIData()" style="background: rgba(255,255,255,.05);">\n            <span style="margin-right: 6px;"></span>Aggiorna\n          </button>\n        </div>\n      </div>\n      <div class="table">\n        <table>\n          <thead>\n            <tr>\n              <th>Data vendita</th>\n              <th>Cliente</th>\n              <th>Consulente</th>\n              <th>Servizi</th>\n              <th style="text-align:right">Tot. VSS</th>\n              <th>Piano pagamenti</th>\n              <th>Stato</th>\n              <th></th>\n            </tr>\n          </thead>\n          <tbody id="gi_rows"></tbody>\n        </table>\n      </div>\n    </div>\n\n    <!-- Forecast Section -->\n    <div class="gi-card">\n      <div class="gi-card-header">\n        <h2 class="gi-card-title">Forecast Incassi</h2>\n        <div class="gi-card-actions">\n          <div class="row" style="align-items:flex-end;gap:16px;flex-wrap:wrap">\n        <div><label>Granularit</label><select id="gi-forecast-granularity">\n          <option value="settimanale">settimanale</option>\n          <option value="mensile" selected>mensile</option>\n          <option value="trimestrale">trimestrale</option>\n          <option value="semestrale">semestrale</option>\n          <option value="annuale">annuale</option>\n        </select></div>\n        '.concat(m?'<div><label>Consulente</label><select id="gi-forecast-consultant"><option value="">Tutti</option></select></div>':"",'\n      </div>\n        </div>\n      </div>\n      \n      <div class="table">\n        <table>\n          <thead>\n            <tr>\n              <th>Periodo</th>\n              <th style="text-align:right">Totale</th>\n              <th>Dettaglio</th>\n              <th>Stato</th>\n            </tr>\n          </thead>\n          <tbody id="gi-forecast-future"></tbody>\n        </table>\n      </div>\n      \n      <details id="gi-forecast-past" style="margin-top:20px">\n        <summary style="cursor: pointer; padding: 12px 0; font-weight: 600; color: var(--accent);">\n          <span style="margin-right: 8px;"></span>Incassi passati\n        </summary>\n        <div class="table" style="margin-top: 16px;">\n          <table>\n            <thead>\n              <tr>\n                <th>Periodo</th>\n                <th style="text-align:right">Totale</th>\n                <th>Dettaglio</th>\n                <th>Stato</th>\n              </tr>\n            </thead>\n            <tbody id="gi-forecast-past-body"></tbody>\n          </table>\n        </div>\n      </details>\n    </div>\n\n  </div>\n  \n  <!-- Floating Action Button -->\n  <button class="fab" id="gi_fab" onclick="document.getElementById(\'gi_add\').click()" title="Nuova vendita">\n    +\n  </button>'),Oe();const g=R=>document.getElementById(R);window.refreshGIData=function(){loadGIData()};const S=R=>String(R||"").replace(/[&<>'"]/g,W=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[W]),C=R=>(Number(R)||0).toLocaleString("it-IT")+"",L=R=>{const W=new Date(R);return W.getFullYear()+"-"+("0"+(W.getMonth()+1)).slice(-2)+"-"+("0"+W.getDate()).slice(-2)};let z=[],tt=[];function q(R){const W=Array.isArray(R.schedule)?R.schedule.slice():[];if(!W.length)return'<span class="muted"></span>';const $=W.find(st=>st.kind==="deposit"||/acconto/i.test(st.note||"")),_=W.filter(st=>st!==$),N=$?"Acconto: "+C($.amount):"";if(!_.length)return N||'<span class="muted"></span>';const T=Math.round(_[0].amount||0),gt=_.every(st=>Math.abs(Math.round(st.amount||0)-T)<=1);return(N?N+" + ":"")+(gt?_.length+" rate da "+C(T):"piano personalizzato")}function ht(R){const W=R.schedule||[],$=W.length>0;let _="pending",N="Da Avviare";if($){const T=new Date,gt=W.sort((dt,yt)=>new Date(dt.dueDate)-new Date(yt.dueDate)),st=gt[0],ot=gt[gt.length-1],pt=new Date(st.dueDate),lt=new Date(ot.dueDate);pt>T?(_="pending",N="Da Avviare"):lt<=T?(_="completed",N="Saldato"):(_="started",N="Avviato")}return'<tr data-id="'+S(String(R.id))+'"><td><strong>'+new Date(R.date||R.createdAt).toLocaleDateString("it-IT")+'</strong></td><td><div style="font-weight: 600;">'+S(R.clientName||"")+'</div></td><td><span style="color: var(--muted);">'+S(R.consultantName||"")+'</span></td><td><div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">'+S(R.services||"")+'</div></td><td style="text-align:right"><span class="amount">'+C(R.vssTotal||0)+'</span></td><td><div style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">'+q(R)+'</div></td><td><span class="status '+_+'">'+N+'</span></td><td class="right"><button class="ghost" data-edit="'+S(String(R.id))+'">Modifica</button></td></tr>'}function V(R){if(!m)return;const W=g("gi-forecast-consultant");if(!W)return;const $=new Map;R.forEach(_=>{const N=String(_.consultantId||"");N&&($.has(N)||$.set(N,_.consultantName||"User "+N))}),W.innerHTML='<option value="">Tutti</option>'+Array.from($.entries()).map(([_,N])=>'<option value="'+S(_)+'">'+S(N)+"</option>").join("")}function nt(R,W){const $=R.getFullYear();if(W==="settimanale"){const _=De(R);return{key:$*100+_,label:pn("settimanale",ol(R))}}if(W==="mensile"){const _=R.getMonth()+1;return{key:$*100+_,label:pn("mensile",di(R))}}if(W==="trimestrale"){const _=Math.floor(R.getMonth()/3)+1;return{key:$*10+_,label:pn("trimestrale",Kn(R))}}if(W==="semestrale"){const _=R.getMonth()<6?1:2;return{key:$*10+_,label:pn("semestrale",Jn(R))}}return{key:$,label:pn("annuale",vi(R))}}function vt(){const R=g("gi-forecast-granularity"),W=g("gi-forecast-consultant"),$=R?R.value:"mensile",_=W?W.value:"",N=tt.filter(dt=>!_||String(dt.consultantId||"")===String(_)),T={};N.forEach(dt=>{const yt=dt.clientName||"";(Array.isArray(dt.schedule)?dt.schedule:[]).forEach(Ct=>{const wt=Ct&&Ct.dueDate?new Date(Ct.dueDate):null;if(!wt||isNaN(wt))return;const{key:Tt,label:Ft}=nt(wt,$),Pt=Number(Ct.amount||0);T[Tt]||(T[Tt]={label:Ft,total:0,details:[]}),T[Tt].total+=Pt,T[Tt].details.push({cliente:yt,amount:Pt})})});const gt=nt(new Date,$).key,st=[],ot=[];Object.keys(T).sort((dt,yt)=>dt-yt).forEach(dt=>{const yt=T[dt],Ct=yt.details.map(At=>S(At.cliente)+"  "+C(At.amount)).join("<br>"),wt=Number(dt)<gt,Tt=wt?"completed":"pending",Ft=wt?"Completato":"In attesa",Pt="<tr><td><strong>"+S(yt.label)+'</strong></td><td style="text-align:right"><span class="amount">'+C(yt.total)+"</span></td><td>"+Ct+'</td><td><span class="status '+Tt+'">'+Ft+"</span></td></tr>";wt?st.push(Pt):ot.push(Pt)});const pt=g("gi-forecast-future"),lt=g("gi-forecast-past-body");pt&&(pt.innerHTML=ot.join("")||'<tr><td colspan="4" class="muted" style="text-align: center; padding: 40px;">Nessun dato futuro</td></tr>'),lt&&(lt.innerHTML=st.join("")||'<tr><td colspan="4" class="muted" style="text-align: center; padding: 40px;">Nessun dato passato</td></tr>')}function K(){const R="?from=1900-01-01&to=2999-12-31",W=document.querySelectorAll(".gi-card");W.forEach($=>$.classList.add("gi-loading")),qt("/api/gi"+R).then($=>{let _=$&&$.sales||[];_.sort((N,T)=>+new Date(T.date||T.createdAt||0)-+new Date(N.date||N.createdAt||0)),tt=_,g("gi_rows").innerHTML=_.length?_.map(ht).join(""):'<tr><td colspan="8" class="muted" style="text-align: center; padding: 40px;">Nessuna vendita trovata</td></tr>',J(),V(_),vt(),P(_),W.forEach(N=>N.classList.remove("gi-loading"))}).catch($=>{logger.error($),Nt("Errore caricamento GI"),W.forEach(_=>_.classList.remove("gi-loading"))})}function P(R){var gt;const W=R.length,$=R.reduce((st,ot)=>st+(Number(ot.vssTotal)||0),0);let _=0,N=0;R.forEach(st=>{(st.schedule||[]).forEach(pt=>{const lt=new Date(pt.dueDate),dt=new Date,yt=Number(pt.amount||0);lt>dt?_+=yt:N+=yt})}),console.log("GI Stats Debug:",{totalSales:W,totalAmount:$,pendingAmount:_,completedAmount:N,sampleRow:R[0],sampleSchedule:((gt=R[0])==null?void 0:gt.schedule)||[]});const T={"gi-total-sales":g("gi-total-sales"),"gi-total-amount":g("gi-total-amount"),"gi-pending-payments":g("gi-pending-payments"),"gi-completed-payments":g("gi-completed-payments")};console.log("GI DOM Elements:",T),T["gi-total-sales"]&&(T["gi-total-sales"].textContent=W),T["gi-total-amount"]&&(T["gi-total-amount"].textContent=C($)),T["gi-pending-payments"]&&(T["gi-pending-payments"].textContent=C(_)),T["gi-completed-payments"]&&(T["gi-completed-payments"].textContent=C(N))}function et(R){const W=R.sale||{},$=Array.isArray(W.schedule)?W.schedule.slice():[],_=$.find(Et=>Et.kind==="deposit"||/acconto/i.test(Et.note||"")),N=$.filter(Et=>Et!==_),T=N.length>0?N.every(Et=>Math.abs((+Et.amount||0)-(+N[0].amount||0))<=1):!0,gt=N.length&&T?"rate":"manual",st=L(new Date),ot='<div class="modal"><div class="card gi-modal"><style>.gi-modal{min-width:min(800px,96vw);max-width:1000px;max-height:90vh;overflow:auto;background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));border:1px solid var(--hair2);box-shadow:0 20px 60px rgba(0,0,0,.3), inset 0 1px 0 rgba(255,255,255,.1);padding:24px;margin:20px auto;position:relative;transform:translateY(0);transition:all 0.3s ease}@media (max-width:768px){ .gi-modal{min-width:98vw;max-width:98vw;width:98vw;padding:16px;max-height:96vh;margin:10px auto;border-radius:16px} .gi-grid{display:block;gap:16px} .gi-col{width:100%;min-width:0} .gi-foot{flex-direction:column !important;gap:16px !important;align-items:stretch !important} .gi-foot>div:last-child{justify-content:center} .pilltabs{flex-direction:column !important;gap:10px !important} .pilltabs label{width:100% !important;justify-content:center !important;padding:14px 20px !important;font-size:15px !important} }@media (max-width:480px){ .gi-modal{padding:12px;min-width:100vw;max-width:100vw;width:100vw;height:100vh;max-height:100vh;margin:0;border-radius:0;position:fixed;top:0;left:0;z-index:9999} .gi-section{margin-top:20px !important;padding-top:20px !important} .mrow{flex-direction:column !important;align-items:stretch !important;gap:10px !important} .mrow label{min-width:0 !important;font-size:14px !important} .mrow input,.mrow select{min-width:0 !important;max-width:100% !important;padding:14px 16px !important;font-size:16px !important;border-radius:12px !important} .mrow.mini{flex-direction:column !important;align-items:stretch !important;gap:10px !important} .mrow.mini button{width:100% !important;max-width:none !important;padding:14px 20px !important;font-size:15px !important} .gi-totals{flex-direction:column !important;gap:12px !important;text-align:center !important;padding:16px !important} .gi-foot button{padding:16px 24px !important;font-size:16px !important;border-radius:12px !important} .pilltabs label{padding:16px 20px !important;font-size:16px !important} }.gi-grid{display:flex; gap:16px; flex-wrap:wrap} .gi-col{flex:1; min-width:240px}.gi-col input, .gi-col select, .gi-col textarea{width:100%; min-width:0;background:rgba(255,255,255,.05);border:1px solid var(--hair2);border-radius:12px;padding:12px 16px;transition:all 0.2s ease}.gi-col input:focus, .gi-col select:focus, .gi-col textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(93,211,255,.1);background:rgba(255,255,255,.08)}.gi-col label{font-weight:600;color:var(--accent);margin-bottom:8px;display:block;font-size:13px;text-transform:uppercase;letter-spacing:0.5px}.client-dropdown{position:relative;width:100%}.client-dropdown-input{width:100%;background:rgba(255,255,255,.05);border:1px solid var(--hair2);border-radius:12px;padding:12px 16px;transition:all 0.2s ease;cursor:pointer;display:flex;justify-content:space-between;align-items:center;color:var(--text)}.client-dropdown-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(93,211,255,.1);background:rgba(255,255,255,.08)}.client-dropdown-arrow{transition:transform 0.2s ease;color:var(--muted);font-size:12px}.client-dropdown.open .client-dropdown-arrow{transform:rotate(180deg)}.client-dropdown-list{position:absolute;top:100%;left:0;right:0;background:rgba(255,255,255,.08);border:1px solid var(--hair2);border-radius:12px;max-height:300px;overflow-y:auto;z-index:1000;margin-top:4px;box-shadow:0 20px 60px rgba(0,0,0,.3);backdrop-filter:blur(10px)}.client-dropdown-search{padding:12px;border-bottom:1px solid var(--hair2);background:rgba(255,255,255,.03)}.client-dropdown-search input{width:100%;background:rgba(255,255,255,.05);border:1px solid var(--hair2);border-radius:8px;padding:8px 12px;color:var(--text);font-size:14px}.client-dropdown-search input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(93,211,255,.1);background:rgba(255,255,255,.08)}.client-dropdown-options{max-height:250px;overflow-y:auto}.client-option{padding:12px 16px;cursor:pointer;transition:all 0.2s ease;border-bottom:1px solid var(--hair);display:flex;align-items:center;gap:12px;color:var(--text)}.client-option:hover{background:rgba(93,211,255,.1);color:var(--accent)}.client-option:last-child{border-bottom:none}.client-option.selected{background:rgba(93,211,255,.15);color:var(--accent);font-weight:600}.client-option-icon{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg, var(--accent), var(--accent2));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:14px;flex-shrink:0}.client-option-text{flex:1;font-size:14px}.client-option-name{font-weight:500;margin-bottom:2px;color:var(--text)}.client-option-consultant{font-size:11px;color:var(--accent);margin-bottom:2px;font-weight:500;opacity:0.8}.client-option-status{font-size:12px;color:var(--muted);text-transform:capitalize}.gi-section{border-top:1px solid var(--hair2); padding-top:20px; margin-top:24px;position:relative}.gi-section::before{content:"";position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg, var(--accent), var(--accent2));border-radius:1px}.gi-section b{font-size:16px;font-weight:700;color:var(--text);margin-bottom:16px;display:block}.pilltabs{display:flex; gap:12px; align-items:center;margin:12px 0 16px} .pilltabs label{display:flex; align-items:center; gap:8px; cursor:pointer; padding:10px 16px; border:1px solid var(--hair2); border-radius:999px;background:rgba(255,255,255,.03);transition:all 0.2s ease;font-weight:500}.pilltabs label:hover{border-color:var(--accent);background:rgba(93,211,255,.05)}.pilltabs input:checked + span, .pilltabs label:has(input:checked){background:linear-gradient(135deg, var(--accent), var(--accent2));border-color:var(--accent);color:#fff}.mrow{display:flex; gap:12px; align-items:center; flex-wrap:wrap;margin-top:12px}.mrow label{min-width:100px;font-weight:500;color:var(--muted);font-size:13px}.mrow input[type=date], .mrow select{min-width:160px; max-width:100%;background:rgba(255,255,255,.05);border:1px solid var(--hair2);border-radius:8px;padding:8px 12px}.mrow input[type=text]{flex:1; min-width:220px; max-width:100%;background:rgba(255,255,255,.05);border:1px solid var(--hair2);border-radius:8px;padding:8px 12px}.mrow input[type=number]{background:rgba(255,255,255,.05);border:1px solid var(--hair2);border-radius:8px;padding:8px 12px}.mini input[type=number]{width:120px}.gi-rlist{margin-top:12px; max-height:250px; overflow:auto; border:1px solid var(--hair2); border-radius:12px; padding:12px;background:rgba(255,255,255,.02)}.gi-r{display:flex; gap:8px; align-items:center; padding:8px 0;border-bottom:1px solid var(--hair);transition:all 0.2s ease}.gi-r:hover{background:rgba(255,255,255,.03);border-radius:8px;padding:8px;margin:0 -8px}.gi-r:last-child{border-bottom:none}.gi-r input[type=date]{min-width:160px;background:rgba(255,255,255,.05);border:1px solid var(--hair2);border-radius:6px;padding:6px 10px} .gi-r input[type=number]{width:120px;background:rgba(255,255,255,.05);border:1px solid var(--hair2);border-radius:6px;padding:6px 10px} .gi-r input[type=text]{flex:1; min-width:220px; max-width:100%;background:rgba(255,255,255,.05);border:1px solid var(--hair2);border-radius:6px;padding:6px 10px}.gi-r button{background:rgba(255,92,92,.1);border:1px solid rgba(255,92,92,.3);color:var(--danger);border-radius:6px;padding:4px 8px;cursor:pointer;transition:all 0.2s ease}.gi-r button:hover{background:rgba(255,92,92,.2);transform:scale(1.05)}.gi-foot{display:flex; justify-content:space-between; align-items:center; gap:16px; margin-top:24px;padding-top:20px;border-top:1px solid var(--hair2)}.gi-foot button{background:linear-gradient(135deg, var(--accent), var(--accent2));border:none;color:#fff;border-radius:12px;padding:12px 24px;font-weight:600;cursor:pointer;transition:all 0.2s ease;box-shadow:0 4px 12px rgba(93,211,255,.3)}.gi-foot button:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(93,211,255,.4)}.gi-foot button.ghost{background:transparent;border:1px solid var(--hair2);color:var(--text);box-shadow:none}.gi-foot button.ghost:hover{border-color:var(--accent);background:rgba(93,211,255,.05)}.gi-foot button.danger{background:linear-gradient(135deg, var(--danger), #ff4444);box-shadow:0 4px 12px rgba(255,92,92,.3)}.gi-foot button.danger:hover{box-shadow:0 6px 20px rgba(255,92,92,.4)}.gi-totals{background:rgba(93,211,255,.05);border:1px solid rgba(93,211,255,.2);border-radius:8px;padding:12px;margin-top:8px}.gi-totals div{font-weight:600;color:var(--accent)}.gi-totals div:first-child{font-size:14px;margin-bottom:4px}.gi-totals div:last-child{font-size:16px}</style><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid var(--hair2)"><div style="display:flex;align-items:center;gap:12px"><div style="width:4px;height:24px;background:linear-gradient(180deg, var(--accent), var(--accent2));border-radius:2px"></div><b style="font-size:20px;font-weight:800;color:var(--text)">'+(R.title||(W.id?"Modifica vendita":"Nuova vendita"))+'</b></div><button class="ghost" id="m_close" style="background:rgba(255,255,255,.05);border:1px solid var(--hair2);border-radius:8px;padding:8px 12px;transition:all 0.2s ease"><span style="margin-right:6px"></span>Chiudi</button></div><div class="gi-grid"><div class="gi-col"><label>Data</label><input id="m_date" type="date" value="'+S(L(W.date||st))+'"></div><div class="gi-col"><label>Cliente</label><div class="client-dropdown"><div class="client-dropdown-input" id="gi_client_input"><span id="gi_client_display"> seleziona cliente </span><span class="client-dropdown-arrow"></span></div><input type="hidden" id="gi_client_select" value=""><div class="client-dropdown-list" id="gi_client_list" style="display:none"><div class="client-dropdown-search"><input type="text" id="gi_client_search" placeholder="Cerca cliente..." autocomplete="off"></div><div class="client-dropdown-options" id="gi_client_options"><div style="padding:16px;text-align:center;color:var(--muted)">Caricamento clienti...</div></div></div></div></div><div class="gi-col"><label>Totale VSS</label><input id="m_vss" type="number" step="1" value="'+S(Number(W.vssTotal||0))+'"></div></div><div class="gi-section"><label>Servizi</label><textarea id="m_srv" rows="2">'+S(W.services||"")+'</textarea></div><div class="gi-section"><b>Acconto</b><div class="mrow mini" style="margin-top:6px"><label><input id="acc_enable" type="checkbox" '+(_?"checked":"")+'> Abilita</label><label>Tipo</label><select id="acc_type"><option value="abs">Valore assoluto</option><option value="perc">Percentuale</option></select><label>Valore</label><input id="acc_value" type="number" step="1" value="'+(_?S(Number(_._fromPerc?_._rawPerc:_.amount)):"0")+'"><label>Scadenza</label><input id="acc_date" type="date" value="'+S(L(_?_.dueDate:W.date||st))+'"><label>Nota</label><input id="acc_note" placeholder="es. Acconto" value="'+S(_&&_.note||"Acconto")+'"></div></div><div class="gi-section"><b>Modalit pagamenti</b><div class="pilltabs" style="margin:6px 0 8px"><label><input type="radio" name="pmode" value="rate" '+(gt==="rate"?"checked":"")+'><span> Rateale</span></label><label><input type="radio" name="pmode" value="manual" '+(gt!=="rate"?"checked":"")+'><span> Scaglioni manuali</span></label></div><div id="p_rate" style="display:'+(gt==="rate"?"block":"none")+'"><div class="mrow mini"><label>N rate</label><input id="rt_n" type="number" value="'+S(N.length||12)+'"><label>Frequenza</label><select id="rt_freq"><option value="M">Mensile</option><option value="Q">Trimestrale</option><option value="W">Settimanale</option><option value="Y">Annuale</option></select><label>Prima scadenza</label><input id="rt_first" type="date" value="'+S(N[0]?L(N[0].dueDate):L(W.date||st))+'"><button class="ghost" id="rt_build" style="background:rgba(93,211,255,.1);border:1px solid rgba(93,211,255,.3);color:var(--accent);border-radius:8px;padding:8px 16px;font-weight:500;transition:all 0.2s ease"><span style="margin-right:6px"></span>Ricalcola rate</button></div><div id="rt_preview" class="gi-rlist muted small"></div></div><div id="p_manual" style="display:'+(gt!=="rate"?"block":"none")+'"><div class="mrow mini"><button class="ghost" id="mn_add" style="background:rgba(93,211,255,.1);border:1px solid rgba(93,211,255,.3);color:var(--accent);border-radius:8px;padding:8px 16px;font-weight:500;transition:all 0.2s ease"><span style="margin-right:6px"></span>Aggiungi scaglione</button></div><div id="mn_list" class="gi-rlist"></div></div></div><div class="gi-foot"><div class="gi-totals"><div id="tot_prog">Programmato: 0</div><div id="tot_chk">Totale VSS: 0</div></div><div style="display:flex;gap:12px">'+(W.id?'<button class="ghost danger" id="m_del"><span style="margin-right:6px"></span>Elimina</button>':"")+'<button id="m_save"><span style="margin-right:6px"></span>Salva</button></div></div></div></div>';showOverlay(ot);const pt=document.documentElement.style.overflow;document.documentElement.style.overflow="hidden";function lt(){document.documentElement.style.overflow=pt,hideOverlay()}(async function(){const bt=g("gi_client_input"),Dt=g("gi_client_display"),G=g("gi_client_select"),mt=g("gi_client_list"),Rt=g("gi_client_options"),jt=g("gi_client_search");if(!bt||!Dt||!G||!mt||!Rt||!jt)return;if(z.length===0)try{const Lt=await qt("/api/clients");z=Lt&&Lt.clients||[]}catch(Lt){console.error("Errore caricamento clienti:",Lt),Rt.innerHTML='<div style="padding:16px;text-align:center;color:var(--danger)">Errore caricamento clienti</div>';return}const zt=[...z].sort((Lt,Ht)=>String(Lt.name||"").localeCompare(String(Ht.name||""),"it",{sensitivity:"base"}));function Qt(Lt=zt){if(Lt.length===0){Rt.innerHTML='<div style="padding:16px;text-align:center;color:var(--muted)">Nessun cliente trovato</div>';return}Rt.innerHTML=Lt.map(Ht=>{const j=String(Ht.name||"").split(" ").map(xt=>xt[0]).join("").toUpperCase().slice(0,2),Z=Ht.consultantName||"";return'\n            <div class="client-option" data-id="'.concat(S(Ht.id),'" data-name="').concat(S(Ht.name),'">\n              <div class="client-option-icon">').concat(j,'</div>\n              <div class="client-option-text">\n                <div class="client-option-name">').concat(S(Ht.name),"</div>\n                ").concat(Z?'<div class="client-option-consultant">'.concat(S(Z),"</div>"):"","\n              </div>\n            </div>\n          ")}).join(""),Rt.querySelectorAll(".client-option").forEach(Ht=>{Ht.addEventListener("click",()=>{const j=Ht.getAttribute("data-id"),Z=Ht.getAttribute("data-name");G.value=j,Dt.textContent=Z,mt.style.display="none",bt.parentElement.classList.remove("open"),Rt.querySelectorAll(".client-option").forEach(xt=>xt.classList.remove("selected")),Ht.classList.add("selected"),Yt()})})}bt.addEventListener("click",()=>{const Lt=mt.style.display==="block";mt.style.display=Lt?"none":"block",bt.parentElement.classList.toggle("open",!Lt),Lt||(jt.focus(),Qt())}),jt.addEventListener("input",Lt=>{const Ht=Lt.target.value.toLowerCase().trim();if(!Ht){Qt();return}const j=zt.filter(Z=>String(Z.name||"").toLowerCase().includes(Ht)||String(Z.status||"").toLowerCase().includes(Ht));Qt(j)}),document.addEventListener("click",Lt=>{!bt.contains(Lt.target)&&!mt.contains(Lt.target)&&(mt.style.display="none",bt.parentElement.classList.remove("open"))});const Bt=W.clientId||W.client_id||"";if(Bt){const Lt=zt.find(Ht=>String(Ht.id)===String(Bt));Lt&&(G.value=String(Lt.id),Dt.textContent=Lt.name)}else if(W.clientName){const Lt=zt.find(Ht=>String(Ht.name).trim().toLowerCase()===String(W.clientName).trim().toLowerCase());Lt&&(G.value=String(Lt.id),Dt.textContent=Lt.name)}Qt()})(),_&&_._fromPerc&&(g("acc_type").value="perc"),Array.from(document.querySelectorAll('input[name="pmode"]')).forEach(Et=>{Et.addEventListener("change",()=>{const bt=document.querySelector('input[name="pmode"]:checked').value==="rate";g("p_rate").style.display=bt?"block":"none",g("p_manual").style.display=bt?"none":"block",Yt()})});function dt(Et,bt){const Dt=new Date(Et);return Dt.setMonth(Dt.getMonth()+bt),Dt}function yt(Et,bt){const Dt=new Date(Et);return Dt.setDate(Dt.getDate()+bt*7),Dt}function Ct(Et,bt){const Dt=new Date(Et);return Dt.setMonth(Dt.getMonth()+bt*3),Dt}function wt(Et,bt){const Dt=new Date(Et);return Dt.setFullYear(Dt.getFullYear()+bt),Dt}function Tt(){const Et=Math.max(1,Number(g("rt_n").value||0)),bt=g("rt_freq").value,Dt=new Date(g("rt_first").value||st),G=Math.max(0,Number(g("m_vss").value||0)),mt=At(),Rt=Math.max(0,G-mt),jt=Math.round(Rt/Et),zt=[];for(let Qt=0;Qt<Et;Qt++){let Bt;bt==="M"?Bt=dt(Dt,Qt):bt==="Q"?Bt=Ct(Dt,Qt):bt==="W"?Bt=yt(Dt,Qt):Bt=wt(Dt,Qt),zt.push({dueDate:Bt.toISOString(),amount:jt,note:"Rata "+(Qt+1)+"/"+Et,kind:"installment"})}return Ft(zt),zt}function Ft(Et){g("rt_preview").innerHTML=Et.map(bt=>"<div>"+new Date(bt.dueDate).toLocaleDateString("it-IT")+"  "+C(bt.amount)+' <span class="muted">'+S(bt.note||"")+"</span></div>").join(""),g("rt_preview")._data=Et,Yt()}function Pt(Et){const bt=g("mn_list");bt.innerHTML="",Et.forEach((Dt,G)=>{const mt=document.createElement("div");mt.className="gi-r",mt.innerHTML='<input type="date" data-k="dueDate" value="'+S(L(Dt.dueDate))+'"><input type="number" step="1" data-k="amount" value="'+S(Number(Dt.amount||0))+'" style="width:120px"><input type="text" data-k="note"   value="'+S(Dt.note||"")+'" placeholder="nota" style="flex:1"><button class="ghost" data-del="'+G+'"></button>',bt.appendChild(mt)}),bt.querySelectorAll("[data-del]").forEach(Dt=>{Dt.onclick=()=>{const G=Number(Dt.getAttribute("data-del")),mt=bt._data||[];mt.splice(G,1),Pt(mt)}}),bt.oninput=()=>{const Dt=bt._data||[];Array.from(bt.children).forEach((mt,Rt)=>{const jt=Dt[Rt];if(!jt)return;const zt=mt.querySelector('[data-k="dueDate"]').value,Qt=Number(mt.querySelector('[data-k="amount"]').value||0),Bt=mt.querySelector('[data-k="note"]').value;jt.dueDate=new Date(zt).toISOString(),jt.amount=Math.round(Qt),jt.note=Bt}),Yt()},bt._data=Et,Yt()}if(g("m_date").value=S(L(W.date||st)),g("m_vss").value=S(Number(W.vssTotal||0)),g("m_srv").value=S(W.services||""),g("acc_type").value=_&&_._fromPerc?"perc":"abs",g("acc_value").value=_?_._fromPerc?_._rawPerc:_.amount:0,g("acc_date").value=S(L(_?_.dueDate:W.date||st)),g("acc_note").value=_?S(_.note||"Acconto"):"Acconto",gt==="rate"){const Et=N.length||12;g("rt_n").value=Et,g("rt_first").value=N[0]?S(L(N[0].dueDate)):S(L(W.date||st)),Ft(N.length?N:Tt())}else Pt(N);g("rt_build").onclick=()=>Ft(Tt()),g("mn_add").onclick=()=>{const bt=g("mn_list")._data||[];bt.push({dueDate:new Date().toISOString(),amount:0,note:"",kind:"manual"}),Pt(bt)},g("m_close").onclick=lt;function At(){if(!g("acc_enable").checked)return 0;const Et=Math.max(0,Number(g("m_vss").value||0)),bt=g("acc_type").value,Dt=Number(g("acc_value").value||0);return Math.round(bt==="perc"?Et*(Dt/100):Dt)}function te(){const Et=[];if(g("acc_enable").checked){const Dt=At();Et.push({dueDate:new Date(g("acc_date").value||st).toISOString(),amount:Dt,note:g("acc_note").value||"Acconto",kind:"deposit",_fromPerc:g("acc_type").value==="perc",_rawPerc:Number(g("acc_value").value||0)})}if(document.querySelector('input[name="pmode"]:checked').value==="rate"){const Dt=(g("rt_preview")._data||[]).map(G=>Object.assign({},G));return Et.concat(Dt)}else{const Dt=(g("mn_list")._data||[]).map(G=>Object.assign({kind:"manual"},G));return Et.concat(Dt)}}function Yt(){const Et=Math.max(0,Number(g("m_vss").value||0)),bt=te(),Dt=Math.round(bt.reduce((G,mt)=>G+Number(mt.amount||0),0));g("tot_prog").textContent="Programmato: "+C(Dt),g("tot_chk").textContent="Totale VSS: "+C(Et)+(Dt===Et?" OK":" (manca "+C(Et-Dt)+")"),g("m_save").disabled=Dt!==Et||!g("gi_client_select").value}if(["m_vss","acc_enable","acc_type","acc_value","acc_date","rt_n","rt_freq","rt_first"].forEach(Et=>{const bt=g(Et);bt&&bt.addEventListener("input",Yt)}),g("gi_client_select").addEventListener("change",Yt),Yt(),g("m_save").onclick=()=>{const Et=g("gi_client_select").value||"",bt=z.find(G=>String(G.id)===String(Et));if(!bt){Nt("Seleziona un cliente");return}const Dt={id:W.id||void 0,date:new Date(g("m_date").value||st).toISOString(),clientId:bt.id,clientName:bt.name,vssTotal:Math.round(Number(g("m_vss").value||0)),services:g("m_srv").value||"",schedule:te()};Promise.resolve(Le("/api/gi",Dt)).then(()=>{lt(),haptic("light"),K(),typeof window.BP<"u"&&window.BP.Coach&&typeof window.BP.Coach.say=="function"&&window.BP.Coach.say("gi_saved",{intensity:"medium"})}).catch(G=>{logger.error(G),Nt("Errore salvataggio")})},W.id){const Et=g("m_del");Et&&(Et.onclick=async()=>{if(!confirm("Eliminare definitivamente questa vendita?"))return;const bt=W?JSON.parse(JSON.stringify(W)):null;try{if(await Nf("/api/gi?id="+encodeURIComponent(W.id)).catch(()=>Le("/api/gi/delete",{id:W.id})),lt(),Nt("Vendita eliminata"),K(),typeof showUndo=="function"&&bt){const Dt={date:new Date(bt.date||bt.createdAt||new Date).toISOString(),clientId:bt.clientId,clientName:bt.clientName,vssTotal:Math.round(Number(bt.vssTotal||0)),services:bt.services||"",schedule:Array.isArray(bt.schedule)?bt.schedule:[]};showUndo("Vendita eliminata",function(){return Le("/api/gi",Dt).then(function(){K()})},5e3)}}catch(Dt){logger.error(Dt),Nt("Errore eliminazione")}})}}function J(){document.querySelectorAll("[data-edit]").forEach(R=>{R.addEventListener("click",()=>{const W=R.getAttribute("data-edit");F(W)})})}document.addEventListener("gi:edit",function(R){const W=R&&R.detail&&R.detail.id;W&&F(W)}),g("gi_add").onclick=()=>{et({title:"Nuova vendita"})};function F(R){qt("/api/gi?from=1900-01-01&to=2999-12-31").then(W=>{const $=(W&&W.sales||[]).find(_=>String(_.id)===String(R));if(!$){Nt("Vendita non trovata");return}et({title:"Modifica vendita",sale:$})})}const B=g("gi-forecast-granularity");B&&(B.onchange=()=>{haptic("light"),vt()});const at=g("gi-forecast-consultant");at&&(at.onchange=()=>{haptic("light"),vt()}),K()}window.viewGI=window.viewGI||Je;function k(){if(!Jt())return t();if(document.title="Battle Plan  Report",Ge("viewReport"),!document.getElementById("report_pill_css")){const G=document.createElement("style");G.id="report_pill_css",G.textContent='\n      /* Modern pill buttons matching GI design */\n      .pill {\n        background: rgba(255,255,255,.05);\n        color: var(--text);\n        border: 1px solid var(--hair2);\n        border-radius: 999px;\n        padding: 10px 16px;\n        font-weight: 500;\n        cursor: pointer;\n        transition: all 0.2s ease;\n        opacity: 1;\n        font-size: 14px;\n      }\n      .pill:hover {\n        border-color: var(--accent);\n        background: rgba(93,211,255,.1);\n        color: var(--accent);\n        transform: translateY(-1px);\n      }\n      .pill.active {\n        background: linear-gradient(135deg, var(--accent), var(--accent2));\n        color: #fff;\n        border-color: var(--accent);\n        box-shadow: 0 4px 12px rgba(93,211,255,.3);\n        opacity: 1;\n        font-weight: 600;\n        transform: translateY(-1px);\n      }\n      \n      /* Modern card design for report sections */\n      .report-card {\n        background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));\n        border: 1px solid var(--hair2);\n        border-radius: 16px;\n        padding: 24px;\n        margin-bottom: 20px;\n        box-shadow: 0 8px 32px rgba(0,0,0,.1);\n        backdrop-filter: blur(10px);\n        position: relative;\n        overflow: hidden;\n      }\n      \n      .report-card::before {\n        content: "";\n        position: absolute;\n        top: 0;\n        left: 0;\n        right: 0;\n        height: 3px;\n        background: linear-gradient(90deg, var(--accent), var(--accent2));\n        border-radius: 16px 16px 0 0;\n      }\n      \n      .report-card b {\n        font-size: 18px;\n        font-weight: 700;\n        color: var(--text);\n        margin-bottom: 16px;\n        display: block;\n        position: relative;\n        padding-left: 12px;\n      }\n      \n      .report-card b::before {\n        content: "";\n        position: absolute;\n        left: 0;\n        top: 50%;\n        transform: translateY(-50%);\n        width: 4px;\n        height: 20px;\n        background: linear-gradient(180deg, var(--accent), var(--accent2));\n        border-radius: 2px;\n      }\n      \n      /* Modern input styling */\n      .report-card input, .report-card textarea {\n        background: rgba(255,255,255,.05);\n        border: 1px solid var(--hair2);\n        border-radius: 12px;\n        padding: 12px 16px;\n        color: var(--text);\n        font-size: 14px;\n        transition: all 0.2s ease;\n        width: 100%;\n        box-sizing: border-box;\n      }\n      \n      .report-card input:focus, .report-card textarea:focus {\n        border-color: var(--accent);\n        box-shadow: 0 0 0 3px rgba(93,211,255,.1);\n        background: rgba(255,255,255,.08);\n        outline: none;\n      }\n      \n      .report-card label {\n        font-weight: 600;\n        color: var(--accent);\n        margin-bottom: 8px;\n        display: block;\n        font-size: 13px;\n        text-transform: uppercase;\n        letter-spacing: 0.5px;\n      }\n      \n      /* Modern button styling */\n      .report-card .ghost {\n        background: rgba(255,255,255,.05);\n        border: 1px solid var(--hair2);\n        border-radius: 8px;\n        padding: 10px 16px;\n        color: var(--text);\n        font-weight: 500;\n        transition: all 0.2s ease;\n        cursor: pointer;\n      }\n      \n      .report-card .ghost:hover {\n        background: var(--accent);\n        border-color: var(--accent);\n        color: #fff;\n        transform: translateY(-1px);\n      }\n      \n      /* Pill container styling */\n      .pill-container {\n        display: flex;\n        gap: 10px;\n        flex-wrap: wrap;\n        margin-top: 16px;\n      }\n      \n      /* Action buttons container */\n      .report-actions {\n        display: flex;\n        gap: 12px;\n        margin-top: 20px;\n        flex-wrap: wrap;\n        align-items: center;\n      }\n      \n      /* Responsive adjustments */\n      @media (max-width: 768px) {\n        .report-card {\n          padding: 16px;\n          margin-bottom: 16px;\n        }\n        \n        .pill-container {\n          gap: 8px;\n        }\n        \n        .pill {\n          padding: 8px 12px;\n          font-size: 13px;\n        }\n        \n        .report-actions {\n          gap: 8px;\n        }\n      }\n    ',document.head.appendChild(G)}n.innerHTML=$e()+'<div class="wrap"><div class="report-card"><b>Sezioni da includere</b><div id="rep_toggles" class="pill-container"><button class="pill" data-type="mensile" id="tog_mese">Mese</button><button class="pill" data-type="trimestrale" id="tog_trimestre">Trimestre</button><button class="pill" data-type="semestrale" id="tog_semestre">Semestre</button><button class="pill" data-type="annuale" id="tog_anno">Anno</button></div></div><div class="report-card"><b>Indicatori aggiuntivi</b><div id="rep_indicators" class="pill-container"><button class="pill" data-key="Telefonate" id="ind_Telefonate">Telefonate</button><button class="pill" data-key="AppFissati" id="ind_AppFissati">AppFissati</button><button class="pill" data-key="AppFatti" id="ind_AppFatti">AppFatti</button><button class="pill" data-key="CorsiLeadership" id="ind_CorsiLeadership">CorsiLeadership</button><button class="pill" data-key="iProfile" id="ind_iProfile">iProfile</button><button class="pill" data-key="MBS" id="ind_MBS">MBS</button><button class="pill" data-key="Note" id="ind_Note">Note</button></div></div><div class="report-card"><b>Report</b><div class="row" style="margin-top:16px"><div style="min-width:320px"><label>Oggetto email</label><input id="report_subject" placeholder="Report BP"></div></div><div class="row" style="margin-top:16px; flex-wrap:wrap"><div style="flex:1 1 100%; min-width:0"><label>Corpo email</label><textarea id="report_body" rows="12" placeholder="Testo del report" style="width:100%; box-sizing:border-box; overflow:auto; resize:vertical; max-height:70vh; white-space:pre-wrap; word-break:break-word"></textarea></div></div><div class="report-actions" id="report-actions"><button class="ghost" id="rep_copy">Copia report</button><button class="ghost" id="rep_gmail_web">Gmail Web</button><button class="ghost" id="rep_gmail_app">Gmail App</button></div></div></div>',Oe();var m=[],g={mensile:!1,trimestrale:!1,semestrale:!1,annuale:!1},S={Telefonate:!1,AppFissati:!1,AppFatti:!1,CorsiLeadership:!1,iProfile:!1,MBS:!1,Note:!1},C=[{k:"VSS",money:!0,label:"VSS"},{k:"VSDPersonale",money:!0,label:"VSDPersonale"},{k:"VSDIndiretto",money:!0,label:"VSDIndiretto"},{k:"GI",money:!0,label:"GI"},{k:"Telefonate",money:!1,label:"Telefonate"},{k:"AppFissati",money:!1,label:"AppFissati"},{k:"AppFatti",money:!1,label:"AppFatti"},{k:"CorsiLeadership",money:!1,label:"CorsiLeadership"},{k:"iProfile",money:!1,label:"iProfile"},{k:"MBS",money:!1,label:"MBS"},{k:"NNCF",money:!1,label:"NNCF"}];function L(G){return S[G]!==!1}function z(G){return document.getElementById(G)}var tt=z("report_body");function q(G,mt){var Rt=new Date(G.getTime());return Rt.setDate(Rt.getDate()+mt),Rt}function ht(G){return wn(G.getFullYear(),De(G))}function V(G){var mt=ht(G);return ht(q(mt.start,7))}function nt(G){var mt=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];return mt[G.getMonth()]}function vt(G){return Math.floor(G.getMonth()/3)+1}function K(G){return G.getMonth()<6?1:2}function P(G){var mt=G.getDay();return mt===5||mt===6||mt===0}function et(G,mt){return G==="mensile"?{start:di(mt),end:Xi(mt)}:G==="trimestrale"?{start:Kn(mt),end:Ki(mt)}:G==="semestrale"?{start:Jn(mt),end:Ji(mt)}:{start:vi(mt),end:bi(mt)}}function J(G,mt){return mt>=q(G,-7)&&mt<=q(G,5)}function F(G,mt){var Rt=et(G,mt),jt=et(G,q(Rt.start,-1)),zt=et(G,q(Rt.end,1)),Qt=J(jt.end,mt),Bt=J(Rt.end,mt);return Qt&&!Bt?{closing:jt,next:Rt}:{closing:Rt,next:zt}}function B(G,mt,Rt){for(var jt=0;jt<m.length;jt++){var zt=m[jt];if(zt.type===G&&Ie(zt.startDate)===Ie(mt)&&Ie(zt.endDate)===Ie(Rt))return zt}return null}function at(G,mt){var Rt=G&&G[mt];return Number(Rt||0)}function R(G){return Be(G)+""}function W(G,mt){var Rt=C.some(function(jt){return jt.k===G&&jt.money});return Rt?R(mt):Be(mt)}function $(G,mt){return G>mt?"":G<mt?"":"="}function _(G,mt,Rt,jt){var zt=B(mt,Rt,jt)||{},Qt=zt.indicatorsPrev||{},Bt=zt.indicatorsCons||{},Lt=[G,""];return C.forEach(function(Ht){if(L(Ht.k)){var j=at(Qt,Ht.k),Z=at(Bt,Ht.k);Lt.push(Ht.label+" "+W(Ht.k,Z)+" vs "+W(Ht.k,j)+" di previsionali ("+$(Z,j)+")")}}),S.Note&&Lt.push("Note:"),Lt.join("\n")}function N(G,mt,Rt,jt){var zt=B(mt,Rt,jt)||{},Qt=zt.indicatorsPrev||{},Bt=[G,""];return C.forEach(function(Lt){L(Lt.k)&&Bt.push(Lt.label+" "+W(Lt.k,at(Qt,Lt.k)))}),S.Note&&Bt.push("Possibili note:"),Bt.join("\n")}function T(G){return"BP CONSUNTIVO SETT. "+De(G)+" "+G.getFullYear()}function gt(G){return"BP PREVISIONALE SETT. "+De(G)+" "+G.getFullYear()}function st(G){return"BP CONSUNTIVO "+nt(G)+" "+G.getFullYear()}function ot(G){var mt=nt(G);return"BP PREVISIONALE "+mt+" "+G.getFullYear()}function pt(G){return"BP CONSUNTIVO T"+vt(G)+" "+G.getFullYear()}function lt(G){return"BP PREVISIONALE T"+vt(G)+" "+G.getFullYear()}function dt(G){return"BP CONSUNTIVO S"+K(G)+" "+G.getFullYear()}function yt(G){return"BP PREVISIONALE S"+K(G)+" "+G.getFullYear()}function Ct(G){return"BP CONSUNTIVO "+G.getFullYear()}function wt(G){return"BP PREVISIONALE "+G.getFullYear()}function Tt(){var G=new Date,mt=[];if(P(G)){var Rt=ht(G),jt=V(G);mt.push(_(T(Rt.start),"settimanale",Rt.start,Rt.end)),mt.push(N(gt(jt.start),"settimanale",jt.start,jt.end))}function zt(Qt,Bt,Lt){var Ht=F(Qt,G);mt.push(_(Bt(Ht.closing.start),Qt,Ht.closing.start,Ht.closing.end)),mt.push(N(Lt(Ht.next.start),Qt,Ht.next.start,Ht.next.end))}g.mensile&&zt("mensile",st,ot),g.trimestrale&&zt("trimestrale",pt,lt),g.semestrale&&zt("semestrale",dt,yt),g.annuale&&zt("annuale",Ct,wt),tt.value=mt.join("\n\n")+(mt.length?"\n":"")}function Ft(G,mt){G.classList.toggle("active",!!mt)}function Pt(){Ft(z("tog_mese"),g.mensile),Ft(z("tog_trimestre"),g.trimestrale),Ft(z("tog_semestre"),g.semestrale),Ft(z("tog_anno"),g.annuale)}function At(){Object.keys(S).forEach(function(G){var mt=z("ind_"+G);mt&&Ft(mt,S[G])})}function te(){function G(mt){var Rt=mt.currentTarget.getAttribute("data-type");g[Rt]=!g[Rt],Pt(),Tt()}z("tog_mese").onclick=G,z("tog_trimestre").onclick=G,z("tog_semestre").onclick=G,z("tog_anno").onclick=G}function Yt(){function G(mt){var Rt=mt.currentTarget.getAttribute("data-key");S[Rt]=!S[Rt],At(),Tt()}Object.keys(S).forEach(function(mt){var Rt=z("ind_"+mt);Rt&&(Rt.onclick=G)})}function Et(G){return encodeURIComponent(String(G||""))}function bt(){var G=z("rep_gmail_web"),mt=z("rep_gmail_app"),Rt=z("rep_copy");Rt&&(Rt.onclick=function(){try{navigator.clipboard.writeText(tt.value||"");var jt=Rt.textContent;Rt.textContent="Copiato!",setTimeout(function(){Rt.textContent=jt},1200)}catch(zt){}}),!(!G||!mt)&&qt("/api/users_emails").then(function(jt){var zt=(jt&&jt.emails||(jt&&jt.users||[]).map(function(Lt){return Lt.email})).filter(Boolean).join(",");function Qt(){return z("report_subject").value||"Report BP"}function Bt(){return tt.value||""}G.onclick=function(){try{navigator.clipboard.writeText(Bt())}catch(Ht){}var Lt="https://mail.google.com/mail/?view=cm&fs=1&tf=1&su="+Et(Qt())+"&cc="+Et(zt)+"&body="+Et(Bt());window.open(Lt,"_blank"),document.dispatchEvent(new Event("report:composed"))},mt.onclick=function(){try{navigator.clipboard.writeText(Bt())}catch(Ht){}var Lt="googlegmail:///co?subject="+Et(Qt())+"&cc="+Et(zt)+"&body="+Et(Bt());location.href=Lt,document.dispatchEvent(new Event("report:composed")),setTimeout(function(){document.hidden||(location.href="mailto:?subject="+Et(Qt())+"&cc="+Et(zt)+"&body="+Et(Bt()),document.dispatchEvent(new Event("report:composed")))},1200)}})}function Dt(){qt("/api/periods").then(function(G){m=G&&G.periods||[],Pt(),At(),Yt(),te(),Tt(),bt()})}Dt()}function w(){var m=Jt();if(!m)return t();if(m.role!=="admin")return c();document.title="Battle Plan  Impostazioni",Ge("viewSettings"),n.innerHTML=$e()+'<div class="wrap"><div class="card"><h2> Impostazioni Sistema</h2><div class="settings-tabs"><button class="settings-tab active" onclick="showSettingsSection(\'classifications\')"> Classifiche</button><button class="settings-tab" onclick="showSettingsSection(\'commissions\')"> Provvigioni</button><button class="settings-tab" onclick="showSettingsSection(\'notifications\')"> Notifiche</button></div><div id="settings-content" class="settings-content"><div id="classifications-section" class="settings-section active"><h3> Impostazioni Classifiche</h3><div class="settings-grid"><div class="settings-card"><h4>Pesi KPI</h4><div id="kpi-weights" class="kpi-weights"><div class="weight-item"><label>VSS (Vendite Singole):</label><input type="number" id="weight_VSS" value="0.25" min="0" max="10" step="0.1"></div><div class="weight-item"><label>VSD Personale:</label><input type="number" id="weight_VSDPersonale" value="0.25" min="0" max="10" step="0.1"></div><div class="weight-item"><label>VSD Indiretto:</label><input type="number" id="weight_VSDIndiretto" value="1.5" min="0" max="10" step="0.1"></div><div class="weight-item"><label>GI (Gestione Indipendente):</label><input type="number" id="weight_GI" value="0.3" min="0" max="10" step="0.1"></div><div class="weight-item"><label>Telefonate:</label><input type="number" id="weight_Telefonate" value="0.1" min="0" max="10" step="0.1"></div><div class="weight-item"><label>Appuntamenti Fissati:</label><input type="number" id="weight_AppFissati" value="0.5" min="0" max="10" step="0.1"></div><div class="weight-item"><label>Appuntamenti Fatti:</label><input type="number" id="weight_AppFatti" value="0.8" min="0" max="10" step="0.1"></div><div class="weight-item"><label>Corsi Leadership:</label><input type="number" id="weight_CorsiLeadership" value="0.3" min="0" max="10" step="0.1"></div><div class="weight-item"><label>iProfile:</label><input type="number" id="weight_iProfile" value="0.2" min="0" max="10" step="0.1"></div><div class="weight-item"><label>MBS:</label><input type="number" id="weight_MBS" value="0.4" min="0" max="10" step="0.1"></div><div class="weight-item"><label>NNCF:</label><input type="number" id="weight_NNCF" value="0.2" min="0" max="10" step="0.1"></div></div><button class="btn-primary" onclick="saveKpiWeights()"> Salva Pesi</button></div></div></div><div id="commissions-section" class="settings-section"><h3> Impostazioni Provvigioni</h3><div class="settings-grid"><div class="settings-card"><h4>Provvigioni GI</h4><div class="commission-item"><label>Percentuale GI:</label><input type="number" id="comm_gi" value="15.0" min="0" max="100" step="0.1">%</div></div><div class="settings-card"><h4>Provvigioni VSD Senior</h4><div class="commission-item"><label>Percentuale VSD Senior:</label><input type="number" id="comm_vsdSenior" value="25.0" min="0" max="100" step="0.1">%</div></div><div class="settings-card"><h4>Provvigioni VSD Junior</h4><div class="commission-item"><label>Percentuale VSD Junior:</label><input type="number" id="comm_vsdJunior" value="20.0" min="0" max="100" step="0.1">%</div></div></div><button class="btn-primary" onclick="saveCommissions()"> Salva Provvigioni</button></div><div id="notifications-section" class="settings-section"><h3> Gestione Notifiche</h3><div class="settings-grid"><div class="settings-card"><h4> Invia Notifica Manuale</h4><div class="notification-compose"><label>Messaggio:</label><textarea id="manual-notification-text" placeholder="Scrivi il messaggio da inviare..." rows="4"></textarea><div class="notification-recipients"><label>Destinatari:</label><div class="recipient-options"><label><input type="radio" name="recipients" value="all" checked> Tutti gli utenti</label><label><input type="radio" name="recipients" value="selected"> Utenti selezionati</label></div><div id="user-selection" class="user-selection" style="display:none;"><div id="users-checklist" class="users-checklist"></div></div></div><button class="btn-primary" onclick="sendManualNotification()"> Invia Notifica</button></div></div></div><div class="settings-grid" style="margin-top: 20px;"><div class="settings-card"><h4> Log Notifiche Manuali</h4><div id="manual-notifications-log" class="notifications-log"></div></div><div class="settings-card"><h4> Notifiche Sistema</h4><div id="system-notifications" class="system-notifications"><div class="system-notification-item"><label>Weekend Reminder:</label><div class="notification-config"><textarea id="weekend-reminder-text" rows="2">Ricorda di completare Previsionale e Consuntivo della settimana.</textarea><div class="notification-timing"><label>Giorni:</label><select id="weekend-reminder-days"><option value="0,6">Sabato e Domenica</option><option value="6">Solo Sabato</option><option value="0">Solo Domenica</option></select><label>Ora:</label><input type="time" id="weekend-reminder-time" value="12:00"></div></div><button class="btn-secondary" onclick="saveSystemNotification(\'weekend-reminder\')"> Salva</button></div><div class="system-notification-item"><label>Post-Appuntamento:</label><div class="notification-config"><textarea id="post-appointment-text" rows="2">Allora, hai venduto a {client}? Appuntamento del {date}</textarea><div class="notification-timing"><label>Ritardo:</label><select id="post-appointment-delay"><option value="0">Immediato</option><option value="30">30 minuti</option><option value="60">1 ora</option><option value="120">2 ore</option><option value="1440">24 ore</option></select><label>Attiva:</label><input type="checkbox" id="post-appointment-enabled" checked></div></div><button class="btn-secondary" onclick="saveSystemNotification(\'post-appointment\')"> Salva</button></div><div class="system-notification-item"><label>Post-Appuntamento NNCF:</label><div class="notification-config"><textarea id="post-nncf-text" rows="2">Ehi, {client}  diventato cliente? Appuntamento del {date}</textarea><div class="notification-timing"><label>Ritardo:</label><select id="post-nncf-delay"><option value="0">Immediato</option><option value="30">30 minuti</option><option value="60">1 ora</option><option value="120">2 ore</option><option value="1440">24 ore</option></select><label>Attiva:</label><input type="checkbox" id="post-nncf-enabled" checked></div></div><button class="btn-secondary" onclick="saveSystemNotification(\'post-nncf\')"> Salva</button></div></div></div></div></div></div></div></div>',Oe(),x(),A(),I()}window.viewSettings=w;function I(){if(document.getElementById("settings-css"))return;document.head.insertAdjacentHTML("beforeend",'\n    <style id="settings-css">\n      .settings-tabs {\n        display: flex;\n        gap: 8px;\n        margin-bottom: 20px;\n        border-bottom: 1px solid var(--border);\n        padding-bottom: 10px;\n      }\n      \n      .settings-tab {\n        padding: 8px 16px;\n        border: none;\n        background: transparent;\n        color: var(--muted);\n        cursor: pointer;\n        border-radius: 6px;\n        transition: all 0.2s ease;\n        font-size: 14px;\n        font-weight: 500;\n      }\n      \n      .settings-tab:hover {\n        background: var(--hover);\n        color: var(--text);\n      }\n      \n      .settings-tab.active {\n        background: var(--accent);\n        color: white;\n      }\n      \n      .settings-content {\n        position: relative;\n      }\n      \n      .settings-section {\n        display: none;\n      }\n      \n      .settings-section.active {\n        display: block;\n      }\n      \n      .settings-grid {\n        display: grid;\n        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));\n        gap: 20px;\n        margin-top: 20px;\n      }\n      \n      .settings-card {\n        background: var(--card);\n        border: 1px solid var(--border);\n        border-radius: 12px;\n        padding: 20px;\n        backdrop-filter: blur(10px);\n        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\n      }\n      \n      .settings-card h4 {\n        margin: 0 0 15px 0;\n        color: var(--text);\n        font-size: 16px;\n        font-weight: 600;\n      }\n      \n      .kpi-weights {\n        display: flex;\n        flex-direction: column;\n        gap: 12px;\n        margin-bottom: 20px;\n      }\n      \n      .weight-item {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        padding: 8px 0;\n      }\n      \n      .weight-item label {\n        font-weight: 500;\n        color: var(--text);\n      }\n      \n      .weight-item input {\n        width: 80px;\n        padding: 6px 8px;\n        border: 1px solid var(--border);\n        border-radius: 6px;\n        background: var(--bg);\n        color: var(--text);\n      }\n      \n      .commission-item {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        padding: 8px 0;\n        margin-bottom: 10px;\n      }\n      \n      .commission-item label {\n        font-weight: 500;\n        color: var(--text);\n      }\n      \n      .commission-item input {\n        width: 100px;\n        padding: 6px 8px;\n        border: 1px solid var(--border);\n        border-radius: 6px;\n        background: var(--bg);\n        color: var(--text);\n      }\n      \n      .notification-compose {\n        display: flex;\n        flex-direction: column;\n        gap: 15px;\n      }\n      \n      .notification-compose label {\n        font-weight: 500;\n        color: var(--text);\n      }\n      \n      .notification-compose textarea {\n        width: 100%;\n        padding: 12px;\n        border: 1px solid var(--border);\n        border-radius: 8px;\n        background: var(--bg);\n        color: var(--text);\n        resize: vertical;\n        font-family: inherit;\n      }\n      \n      .notification-recipients {\n        display: flex;\n        flex-direction: column;\n        gap: 10px;\n      }\n      \n      .recipient-options {\n        display: flex;\n        gap: 20px;\n      }\n      \n      .recipient-options label {\n        display: flex;\n        align-items: center;\n        gap: 8px;\n        cursor: pointer;\n      }\n      \n      .user-selection {\n        margin-top: 10px;\n        padding: 15px;\n        background: var(--hover);\n        border-radius: 8px;\n        max-height: 200px;\n        overflow-y: auto;\n      }\n      \n      .users-checklist {\n        display: flex;\n        flex-direction: column;\n        gap: 8px;\n      }\n      \n      .user-checkbox {\n        display: flex;\n        align-items: center;\n        gap: 8px;\n        cursor: pointer;\n        padding: 4px 0;\n      }\n      \n      .notifications-log {\n        max-height: 300px;\n        overflow-y: auto;\n        border: 1px solid var(--border);\n        border-radius: 8px;\n        padding: 10px;\n        background: var(--bg);\n      }\n      \n      .notification-log-item {\n        padding: 10px;\n        border-bottom: 1px solid var(--border);\n        margin-bottom: 10px;\n      }\n      \n      .notification-log-item:last-child {\n        border-bottom: none;\n        margin-bottom: 0;\n      }\n      \n      .notification-log-header {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        margin-bottom: 5px;\n      }\n      \n      .notification-log-recipients {\n        font-size: 12px;\n        color: var(--muted);\n        background: var(--accent);\n        color: white;\n        padding: 2px 8px;\n        border-radius: 12px;\n      }\n      \n      .notification-log-text {\n        color: var(--text);\n        font-size: 14px;\n        line-height: 1.4;\n      }\n      \n      .notification-config {\n        display: flex;\n        flex-direction: column;\n        gap: 10px;\n      }\n      \n      .notification-timing {\n        display: flex;\n        gap: 15px;\n        align-items: center;\n        flex-wrap: wrap;\n      }\n      \n      .notification-timing label {\n        font-size: 12px;\n        color: var(--muted);\n        font-weight: 500;\n      }\n      \n      .notification-timing select,\n      .notification-timing input[type="time"],\n      .notification-timing input[type="checkbox"] {\n        background: var(--card);\n        border: 1px solid var(--border);\n        border-radius: 6px;\n        padding: 6px 8px;\n        color: var(--text);\n        font-size: 12px;\n      }\n      \n      .notification-timing input[type="checkbox"] {\n        width: 16px;\n        height: 16px;\n        accent-color: var(--accent);\n      }\n      \n      .system-notifications {\n        display: flex;\n        flex-direction: column;\n        gap: 15px;\n      }\n      \n      .system-notification-item {\n        display: flex;\n        flex-direction: column;\n        gap: 8px;\n        padding: 15px;\n        background: var(--hover);\n        border-radius: 8px;\n      }\n      \n      .system-notification-item label {\n        font-weight: 500;\n        color: var(--text);\n        font-size: 14px;\n      }\n      \n      .system-notification-item textarea {\n        width: 100%;\n        padding: 8px;\n        border: 1px solid var(--border);\n        border-radius: 6px;\n        background: var(--bg);\n        color: var(--text);\n        resize: vertical;\n        font-family: inherit;\n        font-size: 14px;\n      }\n      \n      .btn-primary, .btn-secondary {\n        padding: 10px 20px;\n        border: none;\n        border-radius: 6px;\n        cursor: pointer;\n        font-weight: 500;\n        transition: all 0.2s ease;\n        font-size: 14px;\n      }\n      \n      .btn-primary {\n        background: var(--accent);\n        color: white;\n      }\n      \n      .btn-primary:hover {\n        background: var(--accent-hover);\n        transform: translateY(-1px);\n      }\n      \n      .btn-secondary {\n        background: var(--hover);\n        color: var(--text);\n        border: 1px solid var(--border);\n      }\n      \n      .btn-secondary:hover {\n        background: var(--border);\n      }\n      \n      @media (max-width: 768px) {\n        .settings-tabs {\n          flex-wrap: wrap;\n        }\n        \n        .settings-grid {\n          grid-template-columns: 1fr;\n        }\n        \n        .weight-item, .commission-item {\n          flex-direction: column;\n          align-items: flex-start;\n          gap: 5px;\n        }\n        \n        .weight-item input, .commission-item input {\n          width: 100%;\n        }\n      }\n    </style>\n  ')}function h(m){document.querySelectorAll(".settings-section").forEach(g=>g.classList.remove("active")),document.querySelectorAll(".settings-tab").forEach(g=>g.classList.remove("active")),document.getElementById(m+"-section").classList.add("active"),event.target.classList.add("active")}window.showSettingsSection=h;function x(){qt("/api/settings/classifications").then(function(m){m&&m.weights&&Object.keys(m.weights).forEach(g=>{const S=document.getElementById("weight_"+g);S&&(S.value=m.weights[g])})}).catch(()=>{}),qt("/api/settings/commissions").then(function(m){if(m&&m.commissions){const g=document.getElementById("comm_gi"),S=document.getElementById("comm_vsdSenior"),C=document.getElementById("comm_vsdJunior");g&&m.commissions.gi!==void 0&&(g.value=(m.commissions.gi*100).toFixed(1)),S&&m.commissions.vsdSenior!==void 0&&(S.value=(m.commissions.vsdSenior*100).toFixed(1)),C&&m.commissions.vsdJunior!==void 0&&(C.value=(m.commissions.vsdJunior*100).toFixed(1))}}).catch(()=>{}),D(),U(),Y()}function A(){document.querySelectorAll('input[name="recipients"]').forEach(m=>{m.addEventListener("change",function(){const g=document.getElementById("user-selection");this.value==="selected"?g.style.display="block":g.style.display="none"})})}function O(){const m=document.getElementById("manual-notification-text").value.trim();if(!m){Nt("Inserisci un messaggio");return}const S=document.querySelector('input[name="recipients"]:checked').value==="selected"?Array.from(document.querySelectorAll("#users-checklist input:checked")).map(L=>L.value):"all";Le("/api/notifications/send",{text:m,recipients:S,type:"manual"}).then(function(L){L.ok?(Nt("Notifica inviata con successo!"),document.getElementById("manual-notification-text").value="",D()):Nt("Errore nell'invio della notifica")}).catch(()=>{Nt("Errore nell'invio della notifica")})}window.sendManualNotification=O;function D(){qt("/api/notifications/manual-log").then(function(m){const g=document.getElementById("manual-notifications-log");m&&m.notifications?g.innerHTML=m.notifications.map(S=>'\n        <div class="notification-log-item">\n          <div class="notification-log-header">\n            <strong>'.concat(new Date(S.sentAt).toLocaleString("it-IT"),'</strong>\n            <span class="notification-log-recipients">').concat(S.recipients==="all"?"Tutti":S.recipients.length+" utenti",'</span>\n          </div>\n          <div class="notification-log-text">').concat(S.text,"</div>\n        </div>\n      ")).join(""):g.innerHTML="<p>Nessuna notifica manuale inviata</p>"}).catch(()=>{document.getElementById("manual-notifications-log").innerHTML="<p>Errore nel caricamento del log</p>"})}function U(){qt("/api/settings/system-notifications").then(function(m){if(m&&m.notifications){if(m.notifications["weekend-reminder"]){const g=m.notifications["weekend-reminder"];typeof g=="string"?document.getElementById("weekend-reminder-text").value=g:typeof g=="object"&&(document.getElementById("weekend-reminder-text").value=g.text||"Completa il BP della settimana",g.days&&(document.getElementById("weekend-reminder-days").value=g.days),g.time&&(document.getElementById("weekend-reminder-time").value=g.time))}if(m.notifications["post-appointment"]){const g=m.notifications["post-appointment"];typeof g=="string"?document.getElementById("post-appointment-text").value=g:typeof g=="object"&&(document.getElementById("post-appointment-text").value=g.text||"Allora, hai venduto a {client}? Appuntamento del {date}",g.delay!==void 0&&(document.getElementById("post-appointment-delay").value=g.delay),g.enabled!==void 0&&(document.getElementById("post-appointment-enabled").checked=g.enabled))}if(m.notifications["post-nncf"]){const g=m.notifications["post-nncf"];typeof g=="string"?document.getElementById("post-nncf-text").value=g:typeof g=="object"&&(document.getElementById("post-nncf-text").value=g.text||"Ehi, {client}  diventato cliente? Appuntamento del {date}",g.delay!==void 0&&(document.getElementById("post-nncf-delay").value=g.delay),g.enabled!==void 0&&(document.getElementById("post-nncf-enabled").checked=g.enabled))}}}).catch(()=>{})}function H(m){const g=document.getElementById(m+"-text").value.trim();if(!g){Nt("Inserisci un messaggio");return}let S={text:g};if(m==="weekend-reminder"){const C=document.getElementById("weekend-reminder-days"),L=document.getElementById("weekend-reminder-time");C&&(S.days=C.value),L&&(S.time=L.value)}if(m==="post-appointment"){const C=document.getElementById("post-appointment-delay"),L=document.getElementById("post-appointment-enabled");C&&(S.delay=parseInt(C.value)),L&&(S.enabled=L.checked)}if(m==="post-nncf"){const C=document.getElementById("post-nncf-delay"),L=document.getElementById("post-nncf-enabled");C&&(S.delay=parseInt(C.value)),L&&(S.enabled=L.checked)}Le("/api/settings/system-notifications",{type:m,config:S}).then(function(C){C.ok?Nt("Notifica sistema salvata con successo!"):Nt("Errore nel salvataggio della notifica sistema")}).catch(()=>{Nt("Errore nel salvataggio della notifica sistema")})}window.saveSystemNotification=H;function Y(){qt("/api/users").then(function(m){const g=document.getElementById("users-checklist");m&&m.users&&(g.innerHTML=m.users.map(S=>'\n        <label class="user-checkbox">\n          <input type="checkbox" value="'.concat(S.id,'">\n          ').concat(Mt(S.name||S.email),"\n        </label>\n      ")).join(""))}).catch(()=>{document.getElementById("users-checklist").innerHTML="<p>Errore nel caricamento degli utenti</p>"})}function rt(){var m=Jt();if(!m)return t();document.title="Battle Plan  Utenti",Ge("viewUsers"),n.innerHTML=$e()+'<div class="wrap"><div class="card"><b>'+(m.role==="admin"?"Gestione utenti":"Il mio profilo")+'</b><div id="users_list" class="row" style="margin-top:8px"></div></div></div>',Oe();function g(C){var L=Mt(C.name||C.email||"user_"+C.id),z=C.grade==="senior"?"senior":"junior",tt=C.role==="admin"?"admin":"consultant";return'<div class="card" style="flex:1 1 380px"><div><b>'+L+'</b> <span class="small muted">('+Mt(tt)+')</span></div><div class="row" style="margin-top:6px"><div><label>Nome</label><input data-nfor="'+C.id+'" type="text" value="'+Mt(C.name||"")+'"></div><div><label>Email</label><input data-efor="'+C.id+'" type="email" value="'+Mt(C.email||"")+'"></div></div><div class="row"><div><label>Nuova password</label><input data-pfor="'+C.id+'" type="password" placeholder="(opzionale)"></div><div><label>Grade</label><select data-gfor="'+C.id+'"><option value="junior"'+(z==="junior"?" selected":"")+'>Junior</option><option value="senior"'+(z==="senior"?" selected":"")+'>Senior</option></select></div><div><label>Ruolo</label><select data-rfor="'+C.id+'"'+(m.role!=="admin"?" disabled":"")+'><option value="consultant"'+(tt==="consultant"?" selected":"")+'>Consulente</option><option value="admin"'+(tt==="admin"?" selected":"")+'>Admin</option></select></div><div class="right" style="align-self:flex-end"><button class="ghost" data-save="'+C.id+'">Aggiorna</button> '+(m.role==="admin"?'<button class="danger" data-del="'+C.id+'" title="Elimina utente">Elimina</button>':"")+"</div></div></div>"}function S(){qt("/api/users").then(function(C){var L=C&&C.users||[],z=m.role==="admin"?L:L.filter(function(q){return String(q.id)===String(m.id)}),tt=Nn("#users_list");tt&&(tt.innerHTML=z.map(g).join(""),jo("[data-save]").forEach(function(q){q.addEventListener("click",function(){var ht=q.getAttribute("data-save"),V=(Nn('input[data-nfor="'+ht+'"]')||{}).value||"",nt=(Nn('input[data-efor="'+ht+'"]')||{}).value||"",vt=(Nn('select[data-gfor="'+ht+'"]')||{}).value||"junior",K=(Nn('select[data-rfor="'+ht+'"]')||{}).value||"consultant",P=Nn('input[data-pfor="'+ht+'"]'),et=P?P.value:"",J={id:ht,name:V,email:nt,grade:vt};m.role==="admin"&&(J.role=K),et&&(J.password=et),Le("/api/users",J).then(function(){Nt("Aggiornato"),window.addXP(5),P&&(P.value="")}).catch(function(F){logger.error(F),Nt("Errore aggiornamento")})})}),jo("[data-del]").forEach(function(q){q.addEventListener("click",function(){var ht=q.getAttribute("data-del");if(m.role==="admin"&&confirm("Eliminare definitivamente questo utente?")){var V=(Array.isArray(z)?z:[]).find(function(nt){return String(nt.id)===String(ht)});fetch("/api/users?id="+encodeURIComponent(ht),{method:"DELETE",headers:{Authorization:"Bearer "+ro()}}).then(function(nt){if(!nt.ok)throw new Error("HTTP "+nt.status);return nt.json()}).then(function(){if(Nt("Utente eliminato"),S(),typeof showUndo=="function"&&V){var nt={id:V.id,name:V.name,email:V.email,grade:V.grade,role:V.role};showUndo("Utente eliminato",function(){return Le("/api/users",nt).then(function(){S()})},5e3)}}).catch(function(nt){logger.error(nt),Nt("Errore eliminazione")})}})}))})}S()}window.viewHome=c,window.viewCalendar=d,window.viewPeriods=u,window.viewAppointments=p,window.viewLeaderboard=Se,window.viewClients=We,window.viewTeam=Te,window.viewCommissions=Ke,window.viewVendite=Ve,window.viewReport=k,window.viewUsers=rt,window.toggleDrawer=bo,window.logout=kf,window.rerenderTopbarSoon=Mf,document.addEventListener("DOMContentLoaded",function(){xf(),Jt()?(Oe(),c()):t()})})();export{Wf as __vite_legacy_guard};
