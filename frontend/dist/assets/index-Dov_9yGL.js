function Xt(){import.meta.url,import("_").catch(()=>1),(async function*(){})().next()}(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const le of document.querySelectorAll('link[rel="modulepreload"]'))de(le);new MutationObserver(le=>{for(const ue of le)if(ue.type==="childList")for(const Te of ue.addedNodes)Te.tagName==="LINK"&&Te.rel==="modulepreload"&&de(Te)}).observe(document,{childList:!0,subtree:!0});function z(le){const ue={};return le.integrity&&(ue.integrity=le.integrity),le.referrerPolicy&&(ue.referrerPolicy=le.referrerPolicy),le.crossOrigin==="use-credentials"?ue.credentials="include":le.crossOrigin==="anonymous"?ue.credentials="omit":ue.credentials="same-origin",ue}function de(le){if(le.ep)return;le.ep=!0;const ue=z(le);fetch(le.href,ue)}})();function Ne(d,t){localStorage.setItem(d,typeof t=="string"?t:JSON.stringify(t))}function Ge(d,t){const z=localStorage.getItem(d);if(z==null)return t;try{return JSON.parse(z)}catch(de){return z}}function Oe(d){localStorage.removeItem(d)}function Mt(d,t){t?Ne("bp_token",d):sessionStorage.setItem("bp_token",d)}function et(){return localStorage.getItem("bp_token")||sessionStorage.getItem("bp_token")||""}function kt(d){Ne("bp_user",d)}function me(){return Ge("bp_user",null)||null}function Nt(){Oe("bp_token"),sessionStorage.removeItem("bp_token"),Oe("bp_user"),location.href="/?v=13"}function rt(d,t={}){t.method=t.method||"GET";const z={...t.headers||{}},de=et();return de&&(z.Authorization="Bearer "+de),t.body!=null&&typeof t.body!="string"&&(z["Content-Type"]="application/json; charset=utf-8",t.body=JSON.stringify(t.body)),t.headers=z,fetch(d,t).then(Lt)}async function Lt(d){const t=await d.text();if(!d.ok)throw At(t,d);return Ft(t,d)}function At(d,t){try{const z=JSON.parse(d).error||"";return new Error(z||t.statusText||"HTTP "+t.status)}catch(z){return new Error(t.statusText||"HTTP "+t.status)}}function Ft(d,t){try{if((t.headers.get("content-type")||"").toLowerCase().indexOf("application/json")!==-1)return d?JSON.parse(d):{}}catch(z){}return d}function ne(d,t){return rt(d,Object.assign({method:"GET"},{}))}function Ie(d,t){return rt(d,{method:"POST",body:t||{}})}function xe(d){return(d<10?"0":"")+d}function Re(d){const t=new Date(d);return xe(t.getDate())+"/"+xe(t.getMonth()+1)+"/"+t.getFullYear()}function Ce(d){const t=new Date(d);return t.getFullYear()+"-"+xe(t.getMonth()+1)+"-"+xe(t.getDate())}function Vt(d){const t=new Date(d);return xe(t.getHours())+":"+xe(t.getMinutes())}function Ot(d){const t=new Date(d);t.setHours(0,0,0,0);const z=(t.getDay()+6)%7;return t.setDate(t.getDate()-z),t}function Je(d){const t=new Date(d);return new Date(t.getFullYear(),t.getMonth(),1)}function Ke(d){const t=new Date(d);return new Date(t.getFullYear(),t.getMonth()+1,0,23,59,59,999)}function be(d){const t=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate())),z=t.getUTCDay()||7;t.setUTCDate(t.getUTCDate()+4-z);const de=new Date(Date.UTC(t.getUTCFullYear(),0,1));return Math.ceil(((t-de)/864e5+1)/7)}function ze(d){const t=new Date(d),z=Math.floor(t.getMonth()/3);return new Date(t.getFullYear(),z*3,1)}function Ze(d){const t=ze(d);return new Date(t.getFullYear(),t.getMonth()+3,0,23,59,59,999)}function je(d){const t=new Date(d),z=t.getMonth()<6?0:6;return new Date(t.getFullYear(),z,1)}function Qe(d){const t=je(d);return new Date(t.getFullYear(),t.getMonth()+6,0,23,59,59,999)}function tt(d){const t=new Date(d);return new Date(t.getFullYear(),0,1)}function qe(d){const t=new Date(d);return new Date(t.getFullYear(),11,31,23,59,59,999)}function Ut(d,t){const z=new Date(d,0,1+(t-1)*7),de=z.getDay()||7,le=new Date(z);return le.setDate(z.getDate()-(de-1)),le.setHours(0,0,0,0),le}function ke(d,t){const z=Ut(d,t),de=new Date(z);return de.setDate(z.getDate()+6),de.setHours(23,59,59,999),{start:z,end:de}}function Rt(d){const t=Ot(d);t.setDate(t.getDate()+7);const z=new Date(t);return z.setDate(t.getDate()+6),z.setHours(23,59,59,999),{start:t,end:z}}function Ht(d){const t=new Date(d.getFullYear(),d.getMonth()+1,1);return{start:t,end:new Date(t.getFullYear(),t.getMonth()+1,0,23,59,59,999)}}function Yt(d){const t=ze(new Date(d.getFullYear(),d.getMonth()+3,1));return{start:t,end:new Date(t.getFullYear(),t.getMonth()+3,0,23,59,59,999)}}function Gt(d){const t=je(new Date(d.getFullYear(),d.getMonth()+6,1));return{start:t,end:new Date(t.getFullYear(),t.getMonth()+6,0,23,59,59,999)}}function qt(d){const t=tt(new Date(d.getFullYear()+1,0,1));return{start:t,end:qe(t)}}function He(d,t){const z=new Date(t);return d==="settimanale"?"Sett. "+be(new Date(t))+" "+z.getFullYear():d==="mensile"?z.toLocaleString("it-IT",{month:"long",year:"numeric"}):d==="trimestrale"?"Trimestre "+(Math.floor(z.getMonth()/3)+1)+" "+z.getFullYear():d==="semestrale"?(z.getMonth()<6?"1°":"2°")+" semestre "+z.getFullYear():d==="annuale"?"Anno "+z.getFullYear():d==="ytd"?"YTD "+z.getFullYear():d==="ltm"?"Ultimi 12 mesi":d}function K(d){const t=document.createElement("div");t.className="toast",t.textContent=d,document.body.appendChild(t),setTimeout(function(){try{t.remove()}catch(z){}},2200)}function Ye(){const d=document.createElement("div");d.className="confetti",document.body.appendChild(d);for(let t=0;t<26;t++){const z=document.createElement("span");z.style.position="absolute",z.style.left=2+t*4+"%",z.style.top="0",z.style.width="6px",z.style.height="10px",z.style.background="hsl("+t*14+",90%,60%)",z.style.opacity="0.95",d.appendChild(z),(function(de,le){setTimeout(function(){de.animate&&de.animate([{transform:"translateY(-20px) rotate(0deg)"},{transform:"translateY(110vh) rotate(540deg)"}],{duration:1200+Math.random()*800,easing:"cubic-bezier(.2,.6,.2,1)"})},le)})(z,t*35)}setTimeout(function(){try{d.remove()}catch(t){}},2500)}function ve(d){return String(d).replace(/[&<>'"]/g,function(t){return{"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"}[t]})}function Ae(d){return(Number(d)||0).toLocaleString("it-IT")+"€"}function Me(d){const t=Number(d)||0;return String(Math.round(t))}function zt(){if(document.getElementById("bp-mobile-drawer-fix"))return;const d="\n  @media (max-width:980px){\n    .topbar{\n      background: rgba(20,24,34,.90) !important;\n      border-bottom: 1px solid rgba(255,255,255,.08) !important;\n    }\n    .drawer{\n      background: rgba(20,24,34,.96) !important;\n      box-shadow: 14px 0 28px rgba(0,0,0,.45) !important;\n      width: 86vw !important;\n      overflow-y: auto !important;\n    }\n    .drawer .row{ gap:10px !important; }\n    .drawer button{\n      background: rgba(255,255,255,.10) !important;\n      border: 1px solid rgba(255,255,255,.22) !important;\n      color: #fff !important;\n      padding: 12px 14px !important;\n      font-weight: 700 !important;\n      border-radius: 12px !important;\n      -webkit-tap-highlight-color: transparent;\n    }\n    .drawer button:hover{\n      background: rgba(255,255,255,.14) !important;\n      border-color: rgba(255,255,255,.30) !important;\n    }\n    .drawer button.ghost{\n      background: rgba(255,255,255,.10) !important;\n      box-shadow: none !important;\n    }\n  }",t=document.createElement("style");t.id="bp-mobile-drawer-fix",t.textContent=d,document.head.appendChild(t)}function jt(){if(document.getElementById("bp-mobile-light-fix"))return;const d="\n    @media (max-width:980px) and (prefers-color-scheme: light){\n      .topbar{\n        background:#fff !important;\n        border-bottom:1px solid rgba(0,0,0,.08) !important;\n        box-shadow:none !important;\n      }\n      .topbar .brand .logo{\n        color:#0f172a !important;\n        font-weight:900 !important;\n        letter-spacing:.4px;\n        text-shadow:none !important;\n        opacity:1 !important;\n      }\n      .topbar .hamb span{ background:#0f172a !important; }\n      .card{\n        background:#fff !important;\n        background-image:none !important;\n        box-shadow:none !important;\n      }\n      .drawer{\n        background:#fff !important;\n        box-shadow:14px 0 28px rgba(0,0,0,.10) !important;\n      }\n      .drawer button{\n        color:#0f172a !important;\n        background:rgba(0,0,0,.04) !important;\n        border:1px solid rgba(0,0,0,.12) !important;\n      }\n      .drawer button:hover{\n        background:rgba(0,0,0,.08) !important;\n      }\n    }\n  ",t=document.createElement("style");t.id="bp-mobile-light-fix",t.textContent=d,document.head.appendChild(t)}function Wt(){if(document.getElementById("bp-badge-light-css"))return;const d="\n    @media (prefers-color-scheme: light){\n      .badge{\n        background: linear-gradient(180deg, #eef2ff, #f8fafc) !important;\n        border: 1px solid #c7d2fe !important;\n        color: #0f172a !important;\n        font-weight: 700 !important;\n        padding: 6px 10px !important;\n        border-radius: 9999px !important;\n        letter-spacing: .2px !important;\n        box-shadow: 0 1px 0 rgba(15,23,42,.05) inset !important;\n      }\n      .chip, .tag{\n        background: #ffffff !important;\n        border: 1px solid #cbd5e1 !important;\n        color: #0f172a !important;\n        font-weight: 600 !important;\n        border-radius: 9999px !important;\n      }\n      .card .badge{\n        background: #fff !important;\n      }\n    }\n  ",t=document.createElement("style");t.id="bp-badge-light-css",t.textContent=d,document.head.appendChild(t)}function Se(){const d=me();if(!d)return"";const t=d.role==="admin",z='<span class="badge">Lvl '+(window.level?window.level():"")+" · XP "+(window.getXP?window.getXP():"")+"</span>",de='<div id="drawer" class="drawer" role="dialog" aria-modal="true" aria-label="Menu"><div class="row"><button class="ghost" onclick="viewHome();toggleDrawer(false)">Dashboard</button><button class="ghost" onclick="viewCalendar();toggleDrawer(false)">Calendario</button><button class="ghost" onclick="viewPeriods();toggleDrawer(false)">BP</button><button class="ghost" onclick="viewAppointments();toggleDrawer(false)">Appuntamenti</button><button class="ghost" onclick="viewLeaderboard();toggleDrawer(false)">Classifiche</button><button class="ghost" onclick="viewCommissions();toggleDrawer(false)">Provvigioni</button><button class="ghost" onclick="viewGI();toggleDrawer(false)">GI &amp; Scadenzario</button><button class="ghost" onclick="viewReport();toggleDrawer(false)">Report</button><button class="ghost" onclick="viewClients();toggleDrawer(false)">Clienti</button><button class="ghost" onclick="viewTeam();toggleDrawer(false)">Squadra</button>'+(t?'<button class="ghost" onclick="viewUsers();toggleDrawer(false)">Utenti</button>':"")+'<button onclick="logout()">Logout</button></div></div>';return'<div class="topbar"><div class="brand"><button class="hamb" id="hamb" aria-label="Apri menu" aria-controls="drawer" aria-expanded="false"><span></span><span></span><span></span></button><div class="logo">BATTLE PLAN</div></div><div class="nav right">'+z+'<button class="ghost" onclick="viewHome()">Dashboard</button><button class="ghost" onclick="viewCalendar()">Calendario</button><button class="ghost" onclick="viewPeriods()">BP</button><button class="ghost" onclick="viewAppointments()">Appuntamenti</button><button class="ghost" onclick="viewLeaderboard()">Classifiche</button><button class="ghost" onclick="viewCommissions()">Provvigioni</button><button class="ghost" onclick="viewGI()">GI &amp; Scadenzario</button><button class="ghost" onclick="viewReport()">Report</button><button class="ghost" onclick="viewClients()">Clienti</button><button class="ghost" onclick="viewTeam()">Squadra</button>'+(t?'<button class="ghost" onclick="viewUsers()">Utenti</button>':"")+'<button onclick="logout()">Logout</button></div></div>'+de}function ye(){if(!me())return;if(!document.getElementById("bp_nav_contrast_css")){const ue="\n      @media (min-width: 1024px){\n        .topbar .nav .ghost{\n          background: rgba(255,255,255,.06);\n          border: 1px solid rgba(255,255,255,.18);\n        }\n        .topbar .nav .ghost:hover{\n          background: rgba(255,255,255,.12);\n        }\n      }\n    ",Te=document.createElement("style");Te.id="bp_nav_contrast_css",Te.textContent=ue,document.head.appendChild(Te)}const d=document.getElementById("app"),t=document.querySelector(".topbar"),z=Se();t?t.outerHTML=z:d&&d.insertAdjacentHTML("afterbegin",z);try{zt()}catch(ue){}try{jt()}catch(ue){}try{Wt()}catch(ue){}const de=document.getElementById("hamb");de&&(de.onclick=function(){We()});const le=document.getElementById("drawer");le&&le.addEventListener("click",function(ue){ue.target.id==="drawer"&&We(!1)}),document.removeEventListener("keydown",at,!1),document.addEventListener("keydown",at,!1)}function at(d){if(d&&d.key==="Escape"){const t=document.getElementById("drawer");t&&t.classList.contains("open")&&We(!1)}}function We(d){const t=document.getElementById("drawer");if(!t)return;const z=typeof d=="boolean"?d:!t.classList.contains("open");t.classList.toggle("open",z);const de=document.getElementById("hamb");de&&de.setAttribute("aria-expanded",String(z)),document.body.classList.toggle("no-scroll",z)}let it=null;function $t(){clearTimeout(it),it=setTimeout(ye,60)}function Ee(d){return document.querySelector(d)}function ot(d){return Array.from(document.querySelectorAll(d))}(function(){var d=document.getElementById("app");window.$1=window.$1||Ee,window.$all=window.$all||ot,typeof window.haptic!="function"&&(window.haptic=function(){});function t(){document.title="Battle Plan – Login";var n='<div class="hero" id="hero"><div class="layer glow"></div><div class="layer grid"></div><div class="title">Pianifica. Eroga. Vinci. <span class="small muted">BP – stile gaming</span></div></div><div class="wrap"><div class="grid"><div class="card"><h3>Accedi</h3><form id="loginForm" autocomplete="on"><div class="row"><div><label>Email</label><input id="li_email" name="email" type="email" autocomplete="username" required></div><div><label>Password</label><input id="li_password" name="password" type="password" autocomplete="current-password" required></div></div><div class="row"><label class="small"><input type="checkbox" id="li_remember" checked> Rimani collegato</label></div><div class="right" style="margin-top:8px"><button type="submit" id="btnLogin">Accedi</button></div></form></div><div class="card"><h3>Registrati</h3><form id="regForm" autocomplete="on"><div class="row"><div><label>Nome</label><input id="re_name" name="name" type="text" required></div><div><label>Email</label><input id="re_email" name="email" type="email" autocomplete="username" required></div><div><label>Password</label><input id="re_password" name="new-password" type="password" autocomplete="new-password" required></div></div><div class="right" style="margin-top:8px"><button type="submit" id="btnRegister">Registrati</button></div></form></div></div></div>';d.innerHTML=n;var a=document.getElementById("hero");a&&a.addEventListener("pointermove",function(U){var w=a.getBoundingClientRect();a.style.setProperty("--gx",(U.clientX-w.left)/w.width*100+"%"),a.style.setProperty("--gy",(U.clientY-w.top)/w.height*100+"%")});var k=document.getElementById("loginForm"),l=document.getElementById("regForm");k.addEventListener("submit",function(U){U.preventDefault();var w=document.getElementById("btnLogin");w.disabled=!0;var B=document.getElementById("li_email").value.trim().toLowerCase(),x=document.getElementById("li_password").value,te=document.getElementById("li_remember").checked;Ie("/api/login",{email:B,password:x}).then(function(L){if(typeof L=="string")try{L=JSON.parse(L)}catch(R){}Mt(L.token,te),kt(L.user),K("Bentornato "+L.user.name+"!"),addXP(10),$e(),ye(),window.BPPush&&window.BPPush.subscribe()}).catch(function(L){K("Credenziali errate"),logger.error(L)}).finally(function(){w.disabled=!1})}),l.addEventListener("submit",function(U){U.preventDefault();var w=document.getElementById("btnRegister");w.disabled=!0;var B=document.getElementById("re_name").value.trim(),x=document.getElementById("re_email").value.trim().toLowerCase(),te=document.getElementById("re_password").value;Ie("/api/register",{name:B,email:x,password:te}).then(function(){K("Registrazione ok. Ora accedi"),Ye(),addXP(20),window.scrollTo({top:0,behavior:"smooth"})}).catch(function(L){K("Email già registrata?"),logger.error(L)}).finally(function(){w.disabled=!1})})}function z(n){const a=new Date().getFullYear(),k=new Date().getMonth()+1,l=be(new Date);return'<div class="row"><div><label>Granularità</label><select id="'+n+'_gran"><option value="settimanale">Settimanale</option><option value="mensile" selected>Mensile</option><option value="trimestrale">Trimestrale</option><option value="semestrale">Semestrale</option><option value="annuale">Annuale</option><option value="ytd">Anno corrente (YTD)</option><option value="ltm">Ultimi 12 mesi (LTM)</option></select></div><div id="'+n+'_wrap_week" style="display:none"><label>Settimana ISO</label><div class="row"><input type="number" id="'+n+'_week" min="1" max="53" value="'+l+'"><input type="number" id="'+n+'_year_w" min="2000" max="2100" value="'+a+'"></div></div><div id="'+n+'_wrap_month"><label>Mese</label><div class="row"><input type="number" id="'+n+'_month" min="1" max="12" value="'+k+'"><input type="number" id="'+n+'_year_m" min="2000" max="2100" value="'+a+'"></div></div><div id="'+n+'_wrap_quarter" style="display:none"><label>Trimestre</label><div class="row"><input type="number" id="'+n+'_quarter" min="1" max="4" value="'+Math.floor((k-1)/3)+1+'"><input type="number" id="'+n+'_year_q" min="2000" max="2100" value="'+a+'"></div></div><div id="'+n+'_wrap_sem" style="display:none"><label>Semestre</label><div class="row"><select id="'+n+'_sem"><option value="1">1°</option><option value="2">2°</option></select><input type="number" id="'+n+'_year_s" min="2000" max="2100" value="'+a+'"></div></div><div id="'+n+'_wrap_year" style="display:none"><label>Anno</label><input type="number" id="'+n+'_year" min="2000" max="2100" value="'+a+'"></div><div style="align-self:flex-end"><button id="'+n+'_refresh" class="ghost">Aggiorna</button></div></div>'}(function(){const n=[];window.onUnifiedRangeChange=function(a){typeof a=="function"&&n.push(a)},window.emitUnifiedRangeChange=function(a){for(const k of n)try{k(a)}catch(l){logger.error(l)}}})();function de(n){return n==="d"||n==="dash"?"dash":n==="cm"||n==="comm"?"comm":n==="tg"||n==="t"||n==="team"?"t":n}function le(n,a){function k(){const U=document.getElementById(n+"_gran").value;["week","month","quarter","sem","year"].forEach(B=>{const x=document.getElementById(n+"_wrap_"+B);x&&(x.style.display="none")}),U==="settimanale"?document.getElementById(n+"_wrap_week").style.display="":U==="mensile"?document.getElementById(n+"_wrap_month").style.display="":U==="trimestrale"?document.getElementById(n+"_wrap_quarter").style.display="":U==="semestrale"?document.getElementById(n+"_wrap_sem").style.display="":U==="annuale"&&(document.getElementById(n+"_wrap_year").style.display="")}["gran","week","year_w","month","year_m","quarter","year_q","sem","year_s","year"].forEach(U=>{const w=document.getElementById(n+"_"+U);w&&(w.onchange=()=>{k(),a&&a(),window.emitUnifiedRangeChange(de(n))},w.oninput=()=>{k()})});const l=document.getElementById(n+"_refresh");l&&(l.onclick=()=>{a&&a(),window.emitUnifiedRangeChange(de(n))}),k()}function ue(n){var a=new Date;function k(c,o){var P=document.getElementById(n+"_"+c),y=P?parseInt(P.value,10):NaN;return isFinite(y)?y:o}var l=document.getElementById(n+"_gran"),U=l?l.value:"mensile",w={type:U,start:null,end:null};if(U==="settimanale"){var B=k("year_w",a.getFullYear()),x=Math.max(1,Math.min(53,k("week",be(a)))),te=ke(B,x);return w.start=te.start,w.end=te.end,w}if(U==="mensile"){var L=k("year_m",a.getFullYear()),R=Math.max(1,Math.min(12,k("month",a.getMonth()+1)));return w.start=new Date(L,R-1,1),w.end=new Date(L,R,0,23,59,59,999),w}if(U==="trimestrale"){var h=k("year_q",a.getFullYear()),b=Math.max(1,Math.min(4,k("quarter",Math.floor(a.getMonth()/3)+1)));return w.start=new Date(h,(b-1)*3,1),w.end=new Date(h,b*3,0,23,59,59,999),w}if(U==="semestrale"){var p=k("year_s",a.getFullYear()),i=k("sem",a.getMonth()<6?1:2);return w.start=new Date(p,i===1?0:6,1),w.end=new Date(p,i===1?6:12,0,23,59,59,999),w}if(U==="annuale"){var f=k("year",a.getFullYear());return w.start=new Date(f,0,1),w.end=new Date(f,11,31,23,59,59,999),w}if(U==="ytd"){var s=new Date(a.getFullYear(),a.getMonth()+1,0,23,59,59,999);return w.start=new Date(a.getFullYear(),0,1),w.end=s,w}if(U==="ltm"){var F=new Date(a.getFullYear(),a.getMonth()+1,0,23,59,59,999),r=new Date(F.getFullYear(),F.getMonth()-11,1);return w.start=r,w.end=F,w}return w.type="mensile",w.start=new Date(a.getFullYear(),a.getMonth(),1),w.end=new Date(a.getFullYear(),a.getMonth()+1,0,23,59,59,999),w}function Te(n){return n==="ytd"||n==="ltm"?"mensile":n}window.effectivePeriodType=Te;function Ue(n,a){var k=Te(n||"mensile"),l=a?new Date(a):new Date,U=l.getUTCFullYear(),w=[];function B(C,E){w.push({s:C.getTime(),e:E.getTime()})}function x(C,E,O){return new Date(Date.UTC(C,E,O))}function te(C){return new Date(C.getTime()+24*3600*1e3-1)}function L(C,E){return new Date(Date.UTC(C,E+1,0))}if(k==="settimanale"){var R=new Date(Date.UTC(l.getUTCFullYear(),l.getUTCMonth(),l.getUTCDate())),h=(R.getUTCDay()+6)%7;R.setUTCDate(R.getUTCDate()-h);for(var b=52;b>=0;b--){var p=new Date(R);p.setUTCDate(R.getUTCDate()-b*7);var i=new Date(p);i.setUTCDate(p.getUTCDate()+6),i.setUTCHours(23,59,59,999),B(p,i)}return w}if(k==="mensile"){for(var f=new Date(Date.UTC(l.getUTCFullYear(),l.getUTCMonth(),1)),s=23;s>=0;s--){var F=new Date(Date.UTC(f.getUTCFullYear(),f.getUTCMonth()-s,1));B(F,te(L(F.getUTCFullYear(),F.getUTCMonth())))}return w}if(k==="trimestrale"){for(var r=Math.floor(l.getUTCMonth()/3),c=11;c>=0;c--){var o=r-c,P=U+Math.floor(o/4),y=(o%4+4)%4,p=x(P,y*3,1),i=te(new Date(Date.UTC(P,y*3+3,0)));B(p,i)}return w}if(k==="semestrale"){for(var Y=l.getUTCMonth()<6?0:1,_=5;_>=0;_--){var A=Y-_,G=U+Math.floor(A/2),W=(A%2+2)%2,j=W===0?0:6,e=x(G,j,1),v=te(new Date(Date.UTC(G,j+6,0)));B(e,v)}return w}for(var D=2;D>=0;D--){var V=U-D;B(x(V,0,1),te(new Date(Date.UTC(V,12,0))))}return w}function $e(){if(!me())return t();document.title="Battle Plan – Dashboard",d.innerHTML=Se()+'<div class="wrap"><div class="card"><b>Filtro</b><div class="row" style="margin-top:6px;align-items:flex-end;gap:16px;flex-wrap:wrap"><div><label>Modalità</label><select id="dash_mode" name="mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div><div><label>Consulente</label><select id="dash_cons"><option value="">Tutti</option></select></div></div>'+z("dash")+'</div><div class="grid" id="kpiGrid"><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>VSS</b><span id="kpi_vss" class="big">—</span></div><canvas id="d_mini_vss" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>VSD personale</b><span id="kpi_vsd" class="big">—</span></div><canvas id="d_mini_vsdpersonale" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>VSD indiretto</b><span id="kpi_vsd_ind" class="big">—</span></div><canvas id="d_mini_vsdindiretto" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>GI</b><span id="kpi_gi" class="big">—</span></div><canvas id="d_mini_gi" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>NNCF</b><span id="kpi_nncf" class="big">—</span></div><canvas id="d_mini_nncf" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>Tot Provvigioni</b><span id="kpi_provv" class="big">—</span></div><canvas id="d_mini_provv" width="320" height="90"></canvas></div></div><div class="card"><b>Ultimi appuntamenti</b><div id="lastApps" class="row" style="margin-top:8px"></div></div><div class="card"><b>Ultimi BP inviati</b><div id="lastBPs" class="row" style="margin-top:8px"></div></div></div>',ye();function n(i,f){var s=document.getElementById(i);s&&(s.textContent=f)}function a(i){var f=Number(i)||0;return f.toLocaleString("it-IT")+"€"}function k(i){var f=Number(i)||0;return String(Math.round(f))}function l(i){return String(i).replace(/[&<>'"]/g,f=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[f])}(function(){ne("/api/usernames").then(function(f){var s=f&&f.users||[],F=document.getElementById("dash_cons");F&&(F.innerHTML='<option value="">Tutti</option>'+s.map(function(r){return'<option value="'+l(String(r.id))+'">'+l(r.name||r.email||"User #"+r.id)+"</option>"}).join(""))}).catch(function(){})})();function U(i,f){return f==="settimanale"?window.isoWeekNum?window.isoWeekNum(i):Math.ceil(i.getDate()/7):f==="mensile"||f==="ytd"||f==="ltm"?i.getMonth()+1:f==="trimestrale"?Math.floor(i.getMonth()/3)+1:f==="semestrale"?i.getMonth()<6?1:2:i.getFullYear()}function w(i){if(typeof Ue=="function")return(Ue(i,new Date)||[]).map(function(u){return{s:u.s,e:u.e}});var f=new Date,s=[];function F(u,N){s.push({s:u.getTime(),e:N.getTime()})}function r(u){var N=new Date(u);return N.setHours(23,59,59,999),N}function c(u,N){return new Date(u,N+1,0,23,59,59,999)}var o=String(i||"mensile").toLowerCase();if(o==="settimanale"){var P=new Date(f),y=(P.getDay()+6)%7;P.setDate(P.getDate()-y),P.setHours(0,0,0,0);for(var Y=52;Y>=0;Y--){var _=new Date(P);_.setDate(_.getDate()-Y*7);var A=new Date(_);A.setDate(_.getDate()+6),A.setHours(23,59,59,999),F(_,A)}return s}if(o==="mensile"||o==="ytd"||o==="ltm"){if(o==="ytd")for(var G=0;G<=f.getMonth();G++){var W=new Date(f.getFullYear(),G,1);F(W,c(f.getFullYear(),G))}else for(var j=o==="ltm"?12:24,e=new Date(f.getFullYear(),f.getMonth(),1),v=j-1;v>=0;v--){var _=new Date(e.getFullYear(),e.getMonth()-v,1);F(_,c(_.getFullYear(),_.getMonth()))}return s}if(o==="trimestrale"){for(var D=Math.floor(f.getMonth()/3)*3,V=new Date(f.getFullYear(),D,1),C=11;C>=0;C--){var E=new Date(V.getFullYear(),V.getMonth()-C*3,1);F(E,r(new Date(E.getFullYear(),E.getMonth()+3,0)))}return s}if(o==="semestrale"){for(var O=f.getMonth()<6?0:6,H=new Date(f.getFullYear(),O,1),_=5;_>=0;_--){var Z=new Date(H.getFullYear(),H.getMonth()-_*6,1);F(Z,r(new Date(Z.getFullYear(),Z.getMonth()+6,0)))}return s}for(var oe=2;oe>=0;oe--){var ie=new Date(f.getFullYear()-oe,0,1);F(ie,r(new Date(ie.getFullYear(),12,0)))}return s}function B(i){switch(String(i)){case"provv_gi":return"ProvvGI";case"provv_vsd":return"ProvvVSD";case"tot_provv":return"TotProvvigioni";default:return i}}function x(i,f,s,F){var r=F||ue("dash"),c=String(r.type||"mensile").toLowerCase(),o=c==="ytd"||c==="ltm"?"mensile":c,P=w(c);function y(_,A){var G=new Date(A.startDate).getTime(),W=new Date(A.endDate).getTime();return G>=_.s&&W<=_.e}function Y(_,A){if(!_)return 0;if(A==="VSDTotale")return Number(_.VSDPersonale||0)+Number(_.VSDIndiretto||0);if(A==="ProvvGI")return Number(_.ProvvGI||0);if(A==="ProvvVSD")return Number(_.ProvvVSD||0);if(A==="TotProvvigioni"){var G=_.TotProvvigioni;return Number(G!=null?G:Number(_.ProvvGI||0)+Number(_.ProvvVSD||0))}return Number(_[A]||0)}return ne("/api/periods?global=1").catch(function(){return ne("/api/periods")}).then(function(_){var A=_&&_.periods||[],G=A.filter(function(e){return!(e.type!==o||s&&String(e.userId||e.uid||"")!==String(s))}),W=B(i),j=P.map(function(e){for(var v=0,D=0;D<G.length;D++){var V=G[D];if(y(e,V)){var C=f==="previsionale"?V.indicatorsPrev||{}:V.indicatorsCons||{};v+=Y(C,W)}}return{x:new Date(e.s),y:Math.round(v*100)/100}});return j})}function te(i,f,s){var F=document.getElementById(i);if(F){if(typeof window.drawFullLine=="function"){window.drawFullLine(i,f,s);return}var r=F.getContext("2d");F.width=F.clientWidth||320,F.height=F.clientHeight||80,r.clearRect(0,0,F.width,F.height);var c=Math.max(1,...s),o=s.length>1?(F.width-8)/(s.length-1):0;r.strokeStyle="#2e6cff",r.lineWidth=2,r.beginPath();for(var P=0;P<s.length;P++){var y=4+P*o,Y=F.height-6-s[P]/c*(F.height-12);P===0?r.moveTo(y,Y):r.lineTo(y,Y)}r.stroke()}}function L(){var i=(document.getElementById("dash_mode")||{}).value||"consuntivo",f=ue("dash"),s=new Date(f.start).getTime(),F=new Date(f.end).getTime(),r=(document.getElementById("dash_cons")||{}).value||"";function c(y){return y=Number(y==null?"":y),isFinite(y)?y:0}function o(y){if(!y)return 0;for(var Y=["VSDIndiretto","vsdIndiretto","VSD_indiretto","VSDI"],_=0;_<Y.length;_++)if(y[Y[_]]!=null)return c(y[Y[_]]);return y.VSDTotale!=null&&y.VSDPersonale!=null?c(y.VSDTotale)-c(y.VSDPersonale):0}function P(y){return y?y.TotProvvigioni!=null?c(y.TotProvvigioni):c(y.ProvvGI)+c(y.ProvvVSD):0}return ne("/api/periods").then(function(y){for(var Y=y&&y.periods||[],_={VSS:0,VSDPersonale:0,VSDIndiretto:0,GI:0,NNCF:0,PROVV:0},A=0;A<Y.length;A++){var G=Y[A];if(!(r&&String(G.userId||G.uid||"")!==String(r))){var W=new Date(G.startDate).getTime(),j=new Date(G.endDate).getTime();if(!(W<s||j>F)){var e=i==="previsionale"?G.indicatorsPrev||{}:G.indicatorsCons||{};_.VSS+=c(e.VSS),_.VSDPersonale+=c(e.VSDPersonale),_.VSDIndiretto+=o(e),_.GI+=c(e.GI),_.NNCF+=c(e.NNCF),_.PROVV+=P(e)}}}n("kpi_vss",a(_.VSS)),n("kpi_vsd",a(_.VSDPersonale)),n("kpi_vsd_ind",a(_.VSDIndiretto)),n("kpi_gi",a(_.GI)),n("kpi_nncf",k(_.NNCF)),n("kpi_provv",a(_.PROVV))})}function R(){var i=(document.getElementById("dash_mode")||{}).value||"consuntivo",f=(document.getElementById("dash_cons")||{}).value||"",s=ue("dash"),F=String(s.type||"mensile").toLowerCase();function r(c,o){var P=c.map(function(Y){return U(Y.x,F)}),y=c.map(function(Y){return Y.y});te(o,P,y)}Promise.all([x("VSS",i,f||null,s),x("VSDPersonale",i,f||null,s),x("VSDIndiretto",i,f||null,s),x("GI",i,f||null,s),x("NNCF",i,f||null,s),x("TotProvvigioni",i,f||null,s)]).then(function(c){r(c[0],"d_mini_vss"),r(c[1],"d_mini_vsdpersonale"),r(c[2],"d_mini_vsdindiretto"),r(c[3],"d_mini_gi"),r(c[4],"d_mini_nncf"),r(c[5],"d_mini_provv")}).catch(function(c){logger.error(c)})}function h(){var i=(document.getElementById("dash_cons")||{}).value||"";(function(){var P=document.getElementById("lastApps");if(P){var y=P.parentElement;if(!document.getElementById("nextApps")){var Y=document.createElement("div");Y.className="card",Y.innerHTML='<b>Prossimi appuntamenti (oggi + domani)</b><div id="nextApps" style="margin-top:8px"></div>',y.parentElement.insertBefore(Y,y)}}})();function f(o){return'<div style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px">'+o+"</div>"}function s(o){return o=String(o||"").toLowerCase(),o.indexOf("mezza")>-1?240:o.indexOf("giorn")>-1?570:(o.indexOf("vend")>-1,90)}function F(o){var P=new Date(o.start),y=new Date(o.end);(!(y instanceof Date)||isNaN(y)||y<P)&&(y=new Date(P.getTime()+s(o.type||"vendita")*6e4));var Y=Re(P)+" "+Vt(P)+"–"+(("0"+y.getHours()).slice(-2)+":"+("0"+y.getMinutes()).slice(-2)),_=o.nncf?" · NNCF ✅":"";return'<div class="card lastApp" data-aid="'+l(String(o.id||""))+'" style="cursor:pointer"><div class="small muted">'+l(Y)+" · "+l(o.type||"manuale")+'</div><div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><div><b>'+l(o.client||"")+'</b></div><div class="row" style="gap:6px"><button class="ghost" title="Esporta .ics" data-ics="'+l(String(o.id||""))+'">.ics</button></div></div><div class="small">VSS '+a(o.vss||0)+" · VSD "+a(o.vsdPersonal||0)+_+"</div></div>"}function r(o){return o&&Object.keys(o).length>0}function c(o){return o=Number(o||0),isFinite(o)?o:0}Promise.all([ne("/api/appointments"),ne("/api/periods")]).then(function(o){var P=o[0]&&o[0].appointments||[],y=o[1]&&o[1].periods||[];(function(){var _=document.getElementById("nextApps");if(_){var A=new Date,G=new Date(A.getFullYear(),A.getMonth(),A.getDate(),0,0,0,0),W=new Date(A.getFullYear(),A.getMonth(),A.getDate()+2,0,0,0,0),j=P.filter(function(e){var v=new Date(e.start).getTime(),D=v>=G.getTime()&&v<W.getTime(),V=i?String(e.userId||e.uid||"")===String(i):!0;return D&&V}).sort(function(e,v){return new Date(e.start)-new Date(v.start)});_.innerHTML=j.length?f(j.map(F).join("")):'<div class="muted">Nessun appuntamento tra oggi e domani</div>',_.querySelectorAll(".lastApp[data-aid]").forEach(function(e){e.addEventListener("click",function(){try{Ne("bp_edit_aid",e.getAttribute("data-aid"))}catch(v){}Fe()})}),_.querySelectorAll("button[data-ics]").forEach(function(e){e.addEventListener("click",function(v){v.stopPropagation();var D=e.getAttribute("data-ics"),V=j.find(C=>String(C.id)===String(D))||P.find(C=>String(C.id)===String(D));if(!V){K("Appuntamento non trovato");return}typeof icsFromAppt=="function"&&typeof downloadICS=="function"?(downloadICS("bp_".concat((V.client||"app").replace(/\s+/g,"_"),"_").concat((V.start||"").slice(0,10)),icsFromAppt(V)),typeof haptic=="function"&&haptic("medium"),K(".ics esportato")):K("Export .ics non disponibile")})})}})(),(function(){var _=document.getElementById("lastApps");if(_){var A=P.filter(function(G){return i?String(G.userId||G.uid||"")===String(i):!0}).sort(function(G,W){return new Date(W.start)-new Date(G.start)}).slice(0,6);_.innerHTML=A.length?f(A.map(F).join("")):'<div class="muted">Nessun appuntamento</div>',_.querySelectorAll(".lastApp[data-aid]").forEach(function(G){G.addEventListener("click",function(){try{Ne("bp_edit_aid",G.getAttribute("data-aid"))}catch(W){}Fe()})}),_.querySelectorAll("button[data-ics]").forEach(function(G){G.addEventListener("click",function(W){W.stopPropagation();var j=G.getAttribute("data-ics"),e=A.find(v=>String(v.id)===String(j))||P.find(v=>String(v.id)===String(j));if(!e){K("Appuntamento non trovato");return}typeof icsFromAppt=="function"&&typeof downloadICS=="function"?(downloadICS("bp_".concat((e.client||"app").replace(/\s+/g,"_"),"_").concat((e.start||"").slice(0,10)),icsFromAppt(e)),typeof haptic=="function"&&haptic("medium"),K(".ics esportato")):K("Export .ics non disponibile")})})}})(),(function(){var _=document.getElementById("lastBPs");if(_){var A=y.filter(function(W){return!(i&&String(W.userId||W.uid||"")!==String(i))}).sort(function(W,j){return new Date(j.endDate)-new Date(W.endDate)}).slice(0,3),G=A.map(function(W){var j=He(W.type,W.startDate),e=W.userName||W.userId||"",v=W.indicatorsPrev||{},D=W.indicatorsCons||{},V=r(D),C=V?D:v,E=c(C.VSS),O=c(C.VSDPersonale),H=c(C.VSDIndiretto),Z=c(C.GI),oe=c(C.NNCF),ie=O+H;return'<div class="card lastBP" data-pid="'+l(String(W.id||""))+'" style="cursor:pointer;flex:1 1 320px"><div style="display:flex;align-items:center;gap:8px"><div><b>'+l(j)+'</b></div><span class="chip small">'+(V?"Consuntivo":"Previsionale")+'</span></div><div class="small muted">'+l(e)+'</div><div class="row" style="margin-top:6px;gap:8px;flex-wrap:wrap"><span class="chip small">VSS <b>'+a(E)+'</b></span><span class="chip small">VSD <b>'+a(ie)+'</b> <span class="muted">(P '+a(O)+" · I "+a(H)+')</span></span><span class="chip small">GI <b>'+a(Z)+'</b></span><span class="chip small">NNCF <b>'+k(oe)+"</b></span></div></div>"}).join("");_.innerHTML=G?'<div style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px">'+G+"</div>":'<div class="muted">Nessun BP</div>',_.querySelectorAll(".lastBP[data-pid]").forEach(function(W){W.addEventListener("click",function(){try{Ne("bp_open_period",{id:W.getAttribute("data-pid"),mode:!1})}catch(j){}nt()})})}})()}).catch(function(o){logger.error(o)})}le("dash",function(){typeof haptic=="function"&&haptic("light"),L(),R(),h()});var b=document.getElementById("dash_mode");b&&(b.onchange=function(){typeof haptic=="function"&&haptic("light"),L(),R(),h()});var p=document.getElementById("dash_cons");p&&(p.onchange=function(){typeof haptic=="function"&&haptic("light"),L(),R(),h()}),L(),R(),h(),typeof kickFinal=="function"&&kickFinal("dashboard")}function lt(){if(!me())return t();document.title="Battle Plan – Calendario";function n(h){if(!h)return new Date(NaN);if(typeof h=="string"){var b=h.match(/^(\d{4})-(\d{2})-(\d{2})[T ](\d{2}):(\d{2})/);if(b)return new Date(+b[1],+b[2]-1,+b[3],+b[4],+b[5])}return new Date(h)}function a(h){var b=n(h),p=isFinite(b)?("0"+b.getHours()).slice(-2):"--",i=isFinite(b)?("0"+b.getMinutes()).slice(-2):"--";return p+":"+i}if(!document.getElementById("cal_dynamic_css")){var k="\n      /* ============== CALENDAR ============== */\n      #cal_container{ overflow-x:auto; -webkit-overflow-scrolling:touch; }\n      #cal_container .calendar{ min-width: 860px; }\n\n      .calendar{ display:grid; grid-template-columns: 44px repeat(7, 1fr); gap:10px; }\n      .calendar .weekLabel{ color:var(--muted); font-size:12px; display:flex; align-items:center; justify-content:center; }\n\n      .calendar .day{\n        min-height:120px; background: var(--card);\n        border:2px solid var(--hair2); border-radius:14px; padding:8px;\n        display:flex; flex-direction:column; gap:3px; overflow:hidden;\n      }\n      .calendar .day.today{\n        outline: 2px solid var(--accent);\n        box-shadow: 0 0 0 2px rgba(0,0,0,.06) inset;\n      }\n      .calendar .day .dnum{ font-weight:800; }\n      .calendar .day .small{\n        font-size:12px; line-height:1.15;\n        white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:100%;\n      }\n      .calendar .day .tag{ padding:2px 6px; border-radius:999px; border:1px solid var(--hair2); font-size:11px; align-self:flex-start; }\n      .calendar .day.busy0{ border-color:#27ae60; background:rgba(39,174,96,.08); }\n      .calendar .day.busy1{ border-color:#ff9f1a; background:rgba(255,159,26,.10); }\n      .calendar .day.busy2{ border-color:#7d1731; background:rgba(125,23,49,.12); }\n      .calendar .day.dense .small{ font-size:11px; line-height:1.1; }\n      .calendar .day.dense .tag{ transform:scale(.9); transform-origin:left top; }\n\n      @media (max-width: 900px){\n        .calendar{ grid-template-columns: 36px repeat(7, 1fr); }\n        .calendar .weekLabel{ display:flex !important; font-size:11px; }\n        .calendar .day{ min-height:92px; padding:6px; }\n        .calendar .day .dnum{ font-size:16px; }\n        .calendar .day .small{ white-space: normal !important; overflow: visible !important; text-overflow: clip !important; }\n        .calendar .day.dense .small{ font-size:clamp(9px,2.4vw,11px); }\n        .calendar .day .tag{ font-size:10px; }\n      }\n\n      .cal-filters .chip{\n        display:inline-flex; align-items:center; gap:6px;\n        padding:6px 10px; border-radius:999px; border:1px solid var(--hair2);\n      }\n    ",l=document.createElement("style");l.id="cal_dynamic_css",l.textContent=k,document.head.appendChild(l)}var U=new Date,w=Ce(Je(U)).slice(0,7);d.innerHTML=Se()+'<div class="wrap"><div class="card"><div class="row" style="align-items:flex-end;gap:12px;flex-wrap:wrap"><div class="row" style="align-items:flex-end;gap:8px"><button id="cal_prev" class="ghost" title="Mese precedente">◀</button><div><label>Mese</label><input type="month" id="cal_month" value="'+w+'"></div><button id="cal_next" class="ghost" title="Mese successivo">▶</button></div><div class="cal-filters"><label class="chip small"><input type="checkbox" id="only_free"> Solo giorni liberi</label> <label class="chip small"><input type="checkbox" id="only_4h"> Solo slot ≥ 4h</label></div><div class="right" style="margin-left:auto"><button id="cal_refresh" class="ghost">Aggiorna</button></div></div></div><div id="cal_container"></div><div id="cal_results" class="card" style="margin-top:8px;display:none"></div><div id="cal_day_box" class="card" style="margin-top:8px;display:none"></div><div class="card" id="cal_free_slots" style="margin-top:8px;display:none"></div></div>',ye();function B(h,b,p){Promise.all([ne("/api/appointments"),ne("/api/availability?from="+h+"-"+xe(b)+"-01&to="+h+"-"+xe(b)+"-"+xe(new Date(h,b,0).getDate()))]).then(function(i){var f=i[0]&&i[0].appointments?i[0].appointments:[],s=i[1]||{slots:[]},F=s.slots||[],r=new Date(h,b-1,1),c=new Date(h,b,0,23,59,59,999);function o(S,T){for(var M={vss:0,vsd:0,nncf:0,count:0},$=0;$<f.length;$++){var J=f[$],re=new Date(J.start);re>=S&&re<=T&&(M.vss+=Number(J.vss||0),M.vsd+=Number(J.vsdPersonal||0),M.nncf+=J.nncf?1:0,M.count+=1)}return M}function P(S,T,M){var $=document.getElementById("cal_results");if($){var J=M?'<div class="right"><button id="res_reset" class="ghost">Torna al mese</button></div>':"";if($.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center"><b>Risultati · '+T+"</b>"+J+'</div><div class="row" style="margin-top:8px;gap:8px;flex-wrap:wrap"><span class="chip small">VSS <b>'+Ae(S.vss)+'</b></span><span class="chip small">VSD <b>'+Ae(S.vsd)+'</b></span><span class="chip small">NNCF <b>'+Me(S.nncf)+'</b></span><span class="chip small">N. app <b>'+Me(S.count)+"</b></span></div>",$.style.display="block",M){var re=document.getElementById("res_reset");re&&(re.onclick=function(){P(o(r,c),j,!1)})}}}for(var y={},Y=0;Y<f.length;Y++){var _=f[Y],A=new Date(_.start);if(!(A<r||A>c)){var G=Ce(A);y[G]||(y[G]={vss:0,vsd:0,nncf:0,mins:0,count:0,items:[]}),y[G].vss+=Number(_.vss||0),y[G].vsd+=Number(_.vsdPersonal||0),y[G].nncf+=_.nncf?1:0,y[G].mins+=Number(_.durationMinutes||0),y[G].count+=1,y[G].items.push(_)}}var W=["Lun","Mar","Mer","Gio","Ven","Sab","Dom"],j=new Date(h,b-1,1).toLocaleString("it-IT",{month:"long",year:"numeric"}),e='<div class="card"><b class="neon">'+j+"</b></div>";e+='<div class="calendar">',e+='<div class="weekLabel">W</div>';for(var v=0;v<7;v++)e+='<div class="weekLabel">'+W[v]+"</div>";var D=new Date(h,b-1,1),V=(D.getDay()+6)%7,C=new Date(D);C.setDate(D.getDate()-V);for(var E=0;E<6;E++){var O=new Date(C),H="W"+be(O);e+='<div class="weekLabel" data-ws="'+Ce(O)+'" style="cursor:pointer">'+H+"</div>";for(var Z=0;Z<7;Z++){var oe=C.getMonth()===b-1,G=Ce(C),ie=y[G]||{vss:0,vsd:0,nncf:0,mins:0,count:0,items:[]},u=C.getDay(),N=u===0||u===6,q=!N&&F.some(function(T){return T.date===G});if(oe&&p){if(p.only_free&&ie.count>0){e+="<div></div>",C.setDate(C.getDate()+1);continue}if(p.only_4h&&!q){e+="<div></div>",C.setDate(C.getDate()+1);continue}}if(!oe)e+="<div></div>";else{var I="";N?ie.count>0&&(I="busy2"):ie.count===0?I="busy0":q?I="busy1":I="busy2";var X="",ee=0;N&&ie.count===0||(ie.vss>0&&(X+='<div class="small">VSS '+Ae(ie.vss)+"</div>",ee++),ie.vsd>0&&(X+='<div class="small">VSD '+Ae(ie.vsd)+"</div>",ee++),ie.nncf>0&&(X+='<div class="small">NNCF '+Me(ie.nncf)+"</div>",ee++),ie.count>0&&(X+='<div class="small">App. '+Me(ie.count)+"</div>",ee++),q&&(X+='<div class="tag" style="margin-top:4px">slot ≥4h</div>',ee++));var ae=ee>=3?" dense":"",ce=q?" slot-free":"";e+='<div class="day '+I+ae+ce+'" data-day="'+G+'" title="Settimana '+be(C)+'"><div class="dnum">'+C.getDate()+"</div>"+(X||"")+"</div>"}C.setDate(C.getDate()+1)}}e+="</div>",document.getElementById("cal_container").innerHTML=e,P(o(r,c),j,!1),document.querySelectorAll(".calendar .weekLabel[data-ws]").forEach(function(S){S.addEventListener("click",function(){var T=S.getAttribute("data-ws"),M=new Date(T),$=new Date(M);$.setDate($.getDate()+6),$.setHours(23,59,59,999);var J="Settimana "+("W"+be(M))+" · "+Re(M)+"–"+Re($);P(o(M,$),J,!0)})}),document.querySelectorAll(".day[data-day]").forEach(function(S){S.addEventListener("click",function(){var T=S.getAttribute("data-day"),M=y[T]&&y[T].items?y[T].items.slice():[];M.sort(function(_e,Pe){return new Date(_e.start)-new Date(Pe.start)});var $=document.getElementById("cal_day_box"),J="<b>Appuntamenti del "+T.split("-").reverse().join("/")+"</b>";if(!M.length)J+='<div class="muted" style="margin-top:6px">Nessun appuntamento</div>';else{J+='<div class="row" style="margin-top:8px">';for(var re=0;re<M.length;re++){var Q=M[re],pe=' data-start="'+Q.start+'" data-end="'+Q.end+'" data-title="'+ve(Q.client||"Appuntamento")+'" ';J+='<div class="card cal-app" data-aid="'+Q.id+'" '+pe+' style="flex:1 1 320px;cursor:pointer"><div class="small muted">'+a(Q.start)+"–"+a(Q.end)+" · "+ve(Q.type||"")+"</div><div><b>"+ve(Q.client||"")+'</b></div><div class="small">VSS '+Ae(Q.vss)+" · VSD "+Ae(Q.vsdPersonal)+" · NNCF "+(Q.nncf?"✅":"—")+"</div>"+(Q.notes?'<div class="small muted">'+ve(Q.notes)+"</div>":"")+"</div>"}J+="</div>"}if($.style.display="block",$.innerHTML=J,$.querySelectorAll(".cal-app").forEach(function(_e){_e.addEventListener("click",function(Pe){Pe.stopPropagation(),Ne("bp_edit_aid",_e.getAttribute("data-aid")),Fe()})}),window.scrollTo({top:$.getBoundingClientRect().top+window.scrollY-80,behavior:"smooth"}),typeof window.wireICSInsideDayBox=="function")try{window.wireICSInsideDayBox()}catch(_e){}})});var se=document.getElementById("cal_free_slots"),De=(function(){var S=new Date;return S.getFullYear()+"-"+xe(S.getMonth()+1)+"-"+xe(S.getDate())})(),we=(F||[]).filter(function(S){return String(S.date||"").slice(0,10)>=De});if(we.length){var Le='<b>Slot liberi ≥ 4h (da oggi in poi)</b> · <span class="badge">Tot: '+we.length+"</span>";Le+='<div class="row" style="margin-top:8px">';for(var m=0;m<we.length&&m<80;m++){var A=we[m],g=A.part==="morning"?"mattina":"pomeriggio";Le+='<div class="card slotBtn" data-start="'+A.start+'" data-end="'+A.end+'" style="flex:1 1 280px;cursor:pointer"><div class="small"><b>'+Re(A.start)+"</b> · "+g+'</div><div class="small">'+a(A.start)+"–"+a(A.end)+"</div></div>"}Le+="</div>",se.style.display="block",se.innerHTML=Le,se.querySelectorAll(".slotBtn").forEach(function(S){S.addEventListener("click",function(){Ne("bp_prefill_slot",{start:S.getAttribute("data-start"),end:S.getAttribute("data-end")}),Fe(),K("Slot precompilato negli appuntamenti")})})}else se.style.display="block",se.innerHTML='<b>Slot liberi ≥ 4h (da oggi in poi)</b> · <span class="badge">Tot: 0</span><div class="muted" style="margin-top:6px">Nessuno slot libero disponibile.</div>';try{window.injectTodayCSS&&window.injectTodayCSS()}catch(S){}try{window.hookCalendar?window.hookCalendar():(window.markToday&&window.markToday(),window.clampSlotCounters&&window.clampSlotCounters())}catch(S){}}).catch(function(i){logger.error(i),K("Errore calendario")})}function x(){var h=document.getElementById("cal_month").value,b=parseInt(h.split("-")[0],10),p=parseInt(h.split("-")[1],10),i={only_free:document.getElementById("only_free").checked,only_4h:document.getElementById("only_4h").checked};B(b,p,i)}document.getElementById("cal_refresh").onclick=x,document.getElementById("cal_month").onchange=x;function te(h){var b=document.getElementById("cal_month");if(b){var p=b.value.split("-"),i=+p[0],f=+p[1];f+=h,f<=0?(f=12,i--):f>12&&(f=1,i++),b.value=i+"-"+xe(f),x()}}var L=document.getElementById("cal_prev"),R=document.getElementById("cal_next");L&&(L.onclick=function(){te(-1)}),R&&(R.onclick=function(){te(1)}),document.getElementById("only_free").onchange=x,document.getElementById("only_4h").onchange=x,x()}function nt(){if(!me())return t();document.title="Battle Plan – BP",d.innerHTML=Se()+'<div class="wrap"><div class="card"><b>Da inviare</b><div id="bp_to_send" class="grid" style="margin-top:8px"></div></div><div class="card" id="bp_sent_box" style="margin-top:8px"><div id="bp_sent_head" style="display:flex;align-items:center;justify-content:space-between;cursor:pointer"><b>BP inviati (periodi in essere)</b><span id="bp_sent_chev" class="chev">▸</span></div><div id="bp_sent" class="row" style="margin-top:8px;display:none"></div></div><div class="card" style="margin-top:8px"><b>Crea/Aggiorna BP</b><div class="row" style="margin-top:8px"><div><label>Tipo</label><select id="p_type"><option value="settimanale">Settimanale (lun–dom)</option><option value="mensile">Mensile</option><option value="trimestrale">Trimestrale</option><option value="semestrale">Semestrale</option><option value="annuale">Annuale</option></select></div><div id="wrap_week" style="display:none"><label>Settimana ISO (1–53)</label><input type="number" id="p_week" min="1" max="53" value="'+be(new Date)+'"></div><div id="wrap_month" style="display:none"><label>Mese</label><select id="p_month"><option value="1">Gennaio</option><option value="2">Febbraio</option><option value="3">Marzo</option><option value="4">Aprile</option><option value="5">Maggio</option><option value="6">Giugno</option><option value="7">Luglio</option><option value="8">Agosto</option><option value="9">Settembre</option><option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option></select></div><div id="wrap_quarter" style="display:none"><label>Trimestre</label><select id="p_quarter"><option value="1">T1</option><option value="2">T2</option><option value="3">T3</option><option value="4">T4</option></select></div><div id="wrap_semester" style="display:none"><label>Semestre</label><select id="p_sem"><option value="1">1° semestre</option><option value="2">2° semestre</option></select></div><div><label>Anno</label><input type="number" id="p_year" min="2000" max="2100" value="'+new Date().getFullYear()+'"></div></div><div class="row"><div class="small muted">Modalità: <b id="p_mode_lbl">Previsionale</b> · <button class="ghost" id="btnImport" style="padding:4px 8px">Importa da agenda</button></div></div><div class="row" style="align-items:center"><div class="small"><b>Periodo selezionato:</b> <span id="p_label" class="neon">—</span></div><input type="hidden" id="p_start"><input type="hidden" id="p_end"></div><div class="row small" style="margin-top:6px;opacity:.9"><div><b>Previsionale</b></div><div><b>Consuntivo</b></div><div><b>Avanzamento</b></div></div><div class="row" id="p_rows" style="margin-top:4px"></div><div class="row" style="margin-top:8px;align-items:center;gap:8px;justify-content:space-between"><div id="p_delete_zone"></div><div class="right"><button id="btnSaveP">Salva BP</button></div></div></div><div class="card"><b>BP salvati</b><div id="p_list" class="row" style="margin-top:8px"></div></div></div>',ye();var n=!1,a=null,k=[],l=null,U=me()||{};function w(m){return String(m).replace(/[&<>'"]/g,g=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[g])}function B(m){if(!m)return"";var g=new Date(m);return g.getFullYear()+"-"+("0"+(g.getMonth()+1)).slice(-2)+"-"+("0"+g.getDate()).slice(-2)}function x(m){var g=new Date(m);return("0"+g.getDate()).slice(-2)+"/"+("0"+(g.getMonth()+1)).slice(-2)+"/"+g.getFullYear()}function te(m){var g=Number(m)||0;return g.toLocaleString("it-IT")+"€"}function L(m){var g=document.createElement("div");return g.innerHTML=m.trim(),g.firstChild}function R(m){return!!(m&&m.indicatorsCons&&Object.keys(m.indicatorsCons).length>0)}function h(){return U&&U.grade?Promise.resolve(U):ne("/api/usernames").then(function(m){var g=String((me()||{}).id||""),S=(m&&m.users||[]).find(function(T){return String(T.id)===g});return S&&S.grade&&(U.grade=S.grade),U}).catch(function(){return U})}function b(){var m=U&&U.grade||(me()||{}).grade;return m==="senior"?"senior":"junior"}h();var p=document.getElementById("p_type"),i=document.getElementById("p_year"),f=document.getElementById("wrap_week"),s=document.getElementById("wrap_month"),F=document.getElementById("wrap_quarter"),r=document.getElementById("wrap_semester"),c=document.getElementById("p_week"),o=document.getElementById("p_month"),P=document.getElementById("p_quarter"),y=document.getElementById("p_sem"),Y=document.getElementById("p_label"),_=document.getElementById("p_start"),A=document.getElementById("p_end"),G=document.getElementById("p_mode_lbl"),W=document.getElementById("btnImport");function j(m){n=!!m,G.textContent=n?"Consuntivo":"Previsionale",W.style.display=n?"none":"";var g=document.querySelectorAll("[data-row]");g.forEach(function(S){var T=S.querySelector("[data-prev]"),M=S.querySelector("[data-cons]"),$=S.querySelector("[data-bar]");if(n){if(T){T.removeAttribute("hidden");var J=T.querySelector("input");J&&(J.setAttribute("readonly","readonly"),J.classList.add("disabled"))}if(M){M.removeAttribute("hidden");var re=M.querySelector("input");re&&(re.removeAttribute("readonly"),re.classList.remove("disabled"))}$&&$.removeAttribute("hidden")}else{if(T){T.removeAttribute("hidden");var Q=T.querySelector("input");Q&&(Q.removeAttribute("readonly"),Q.classList.remove("disabled"))}M&&M.setAttribute("hidden","hidden"),$&&$.setAttribute("hidden","hidden")}}),I()}function e(){var m=p.value;f.style.display=m==="settimanale"?"":"none",s.style.display=m==="mensile"?"":"none",F.style.display=m==="trimestrale"?"":"none",r.style.display=m==="semestrale"?"":"none",v()}function v(){var m=p.value,g=parseInt(i.value,10),S,T,M;if(m==="settimanale"){var $=Math.max(1,Math.min(53,parseInt(c.value||"1",10))),J=ke(g,$);S=J.start,T=J.end,M="Sett. "+$+" · "+x(S)+" → "+x(T)}else if(m==="mensile"){var re=parseInt(o.value,10);S=new Date(g,re-1,1),T=new Date(g,re,0),M=S.toLocaleString("it-IT",{month:"long",year:"numeric"})+" · "+x(S)+" → "+x(T)}else if(m==="trimestrale"){var Q=parseInt(P.value,10);S=new Date(g,(Q-1)*3,1),T=new Date(g,Q*3,0),M="Trimestre "+Q+" "+g+" · "+x(S)+" → "+x(T)}else if(m==="semestrale"){var pe=parseInt(y.value,10);S=new Date(g,pe===1?0:6,1),T=new Date(g,pe===1?6:12,0),M=(pe===1?"1°":"2°")+" semestre "+g+" · "+x(S)+" → "+x(T)}else S=new Date(g,0,1),T=new Date(g,11,31),M="Anno "+g+" · "+x(S)+" → "+x(T);_.value=B(S),A.value=B(T),Y.textContent=M,j(!1),a=null,l=null,O(),I()}function D(m){for(var g="",S=0;S<m.length;S++){var T=m[S],M=/^(VSS|VSDPersonale|VSDIndiretto|GI)$/i.test(T);g+='<div class="row" data-row="'+T+'"><div data-prev><label>'+T+' (Prev)</label><input type="number" step="1" id="prev_'+T+'" placeholder="'+(M?"€":"n")+'"></div><div data-cons><label>'+T+' (Cons)</label><input type="number" step="1" id="cons_'+T+'" placeholder="'+(M?"€":"n")+'"></div><div data-bar class="small"><div style="height:10px;background:rgba(255,255,255,.12);border-radius:999px;overflow:hidden"><div id="bar_'+T+'" style="height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2));"></div></div><div id="pct_'+T+'" class="small muted">0%</div></div></div>'}document.getElementById("p_rows").innerHTML=g,j(!1),C(),V()}function V(){for(var m=0;m<k.length;m++){var g=k[m],S=document.getElementById("prev_"+g),T=document.getElementById("cons_"+g);if(!(!S||!T)){var M=Number(S.value||0),$=Number(T.value||0),J=M>0?Math.round($/M*100):$>0?100:0;J=Math.max(0,Math.min(200,J));var re=document.getElementById("bar_"+g),Q=document.getElementById("pct_"+g);re&&(re.style.width=Math.min(J,100)+"%"),Q&&(Q.textContent=J+"%")}}}function C(){for(var m=0;m<k.length;m++)(function(g){var S=document.getElementById("prev_"+g),T=document.getElementById("cons_"+g);S&&(S.oninput=V),T&&(T.oninput=V)})(k[m])}function E(){for(var m=0;m<k.length;m++){var g=document.getElementById("prev_"+k[m]);g&&(g.value="")}V()}function O(){for(var m=0;m<k.length;m++){var g=document.getElementById("cons_"+k[m]);g&&(g.value="")}V()}function H(m){for(var g in m){var S=document.getElementById("prev_"+g);S&&(S.value=String(m[g]||0))}V()}function Z(m){for(var g in m){var S=document.getElementById("cons_"+g);S&&(S.value=String(m[g]||0))}V()}function oe(){if(!n){var m=_.value,g=A.value;if(!m||!g){K("Seleziona il periodo");return}ne("/api/appointments").then(function(S){for(var T=S.appointments||[],M=new Date(m),$=new Date(g),J={VSS:0,VSDPersonale:0,VSDIndiretto:0,GI:0,Telefonate:0,AppFissati:0,AppFatti:0,CorsiLeadership:0,iProfile:0,MBS:0,NNCF:0},re=0;re<T.length;re++){var Q=T[re],pe=new Date(Q.start);pe>=M&&pe<=$&&(J.VSS+=Number(Q.vss||0),J.VSDPersonale+=Number(Q.vsdPersonal||0),Q.nncf&&(J.NNCF+=1))}H(J),K("Previsionale compilato dalla tua agenda"),Ye(),addXP(10)}).catch(function(){K("Errore import agenda")})}}function ie(m,g){m=Object.assign({},m||{});var S=Number(m.GI||0),T=Number(m.VSDPersonale||0),M=S*.15,$=T*(String(g)==="senior"?.25:.2);return m.ProvvGI=Math.round(M*100)/100,m.ProvvVSD=Math.round($*100)/100,m.TotProvvigioni=Math.round((m.ProvvGI+m.ProvvVSD)*100)/100,m}function u(m,g,S){return fetch(g,{method:m,headers:S?{"Content-Type":"application/json"}:void 0,body:S?JSON.stringify(S):void 0}).then(function(T){return T.ok?T.json().catch(function(){return{}}):Promise.reject(new Error("HTTP "+T.status))})}function N(m){for(var g=encodeURIComponent(m),S=[function(){return u("POST","/api/periods/delete",{id:m})},function(){return u("POST","/api/periods",{id:m,_delete:!0})},function(){return u("POST","/api/periods/"+g,{_method:"DELETE"})},function(){return u("DELETE","/api/periods/"+g,null)},function(){return u("DELETE","/api/periods?id="+g,null)}],T=Promise.reject(new Error("start")),M=0;M<S.length;M++)(function($){T=T.catch($)})(S[M]);return T.catch(function($){throw logger.warn("Delete fallback: tutte le route fallite",$),$})}function q(m){return l?{id:a||l.id,type:l.type,startDate:B(l.startDate),endDate:B(l.endDate),indicatorsPrev:Object.assign({},l.indicatorsPrev||{}),indicatorsCons:m!=null?m:Object.assign({},l.indicatorsCons||{})}:null}function I(){var m=document.getElementById("p_delete_zone");if(m){if(!a){m.innerHTML="";return}var g=!!(n&&l&&R(l)),S="";g&&(S+='<button id="btnDelCons" class="ghost" style="border-color:#7d1731;color:#7d1731">Elimina Consuntivo</button> '),S+='<button id="btnDelBP" class="ghost" style="border-color:#7d1731;color:#7d1731">Elimina BP</button>',m.innerHTML=S;var T=document.getElementById("btnDelBP");T&&(T.onclick=function(){confirm("Eliminare definitivamente questo BP?")&&(T.disabled=!0,N(a).then(function(){K("BP eliminato"),a=null,l=null,E(),O(),j(!1),v(),ee()}).catch(function(){K("Endpoint delete non disponibile")}).finally(function(){T.disabled=!1}))});var M=document.getElementById("btnDelCons");M&&(M.onclick=function(){if(confirm("Rimuovere solo il Consuntivo?")){M.disabled=!0;var $=q({});if(!$){M.disabled=!1;return}var J=b();$.indicatorsPrev=ie($.indicatorsPrev,J),$.indicatorsCons={},Ie("/api/periods",$).then(function(){K("Consuntivo eliminato"),l&&(l.indicatorsCons={}),j(!0),ee(),I()}).catch(function(){K("Errore eliminazione Consuntivo")}).finally(function(){M.disabled=!1})}})}}function X(){var m=p.value,g=_.value,S=A.value;if(!g||!S){K("Seleziona il periodo");return}for(var T={},M={},$=0;$<k.length;$++){var J=k[$];T[J]=Number(document.getElementById("prev_"+J).value||0),n&&(M[J]=Number(document.getElementById("cons_"+J).value||0))}var re=b();T=ie(T,re),n&&(M=ie(M,re));var Q={type:m,startDate:g,endDate:S,indicatorsPrev:T};n&&(Q.indicatorsCons=M),a&&(Q.id=a),Ie("/api/periods",Q).then(function(pe){K("BP salvato"),n?addXP(20):addXP(10),Ye(),ee(),!a&&pe&&pe.id&&(a=pe.id),a&&l&&(l.indicatorsPrev=T,n&&(l.indicatorsCons=M)),I()}).catch(function(){K("Errore salvataggio BP")})}function ee(){ne("/api/periods").then(function(m){var g=m.periods||[];g.sort(function(Q,pe){return new Date(pe.startDate)-new Date(Q.startDate)});for(var S="",T=0;T<g.length;T++){var M=g[T],$=He(M.type,M.startDate)+" · "+x(M.startDate)+" → "+x(M.endDate);S+='<div class="card" style="flex:1 1 360px"><div><b>'+w($)+'</b></div><div class="small">Prev VSS '+te((M.indicatorsPrev||{}).VSS||0)+" · Cons "+te((M.indicatorsCons||{}).VSS||0)+'</div><div class="right" style="margin-top:6px"><button class="ghost" data-edit="'+M.id+'">Modifica previs.</button><button data-cons="'+M.id+'">Consuntivo…</button></div></div>'}document.getElementById("p_list").innerHTML=S||'<div class="muted">Nessun BP</div>',document.querySelectorAll("[data-edit]").forEach(function(Q){Q.addEventListener("click",function(){var pe=Q.getAttribute("data-edit"),_e=(m.periods||[]).find(function(Pe){return Pe.id===pe});_e&&ae(_e,!1)})}),document.querySelectorAll("[data-cons]").forEach(function(Q){Q.addEventListener("click",function(){var pe=Q.getAttribute("data-cons"),_e=(m.periods||[]).find(function(Pe){return Pe.id===pe});_e&&ae(_e,!0)})}),Le(g);var J=Ge("bp_open_period",null);if(J){Oe("bp_open_period");var re=g.find(function(Q){return Q.id===J.id});re&&ae(re,J.mode===!0)}})}function ae(m,g){l=m||null,p.value=m.type;var S=new Date(m.startDate),T=S.getFullYear();if(i.value=String(T),m.type==="settimanale")c.value=String(be(S));else if(m.type==="mensile")o.value=String(S.getMonth()+1);else if(m.type==="trimestrale"){var M=Math.floor(S.getMonth()/3)+1;P.value=String(M)}else m.type==="semestrale"&&(y.value=S.getMonth()<6?"1":"2");e(),E(),O(),H(m.indicatorsPrev||{}),Z(m.indicatorsCons||{}),j(!!g),a=m.id||null,I(),K(g?"Compila il consuntivo":"Modifica previsionale"),window.scrollTo({top:0,behavior:"smooth"})}function ce(m,g){g=g||new Date;var S=g.getFullYear();if(m==="settimanale"){var T=ke(S,be(g));return{start:T.start,end:T.end}}return m==="mensile"?{start:Je(g),end:Ke(g)}:m==="trimestrale"?{start:ze(g),end:Ze(g)}:m==="semestrale"?{start:je(g),end:Qe(g)}:{start:tt(g),end:qe(g)}}function se(m,g){return g=g||new Date,m==="settimanale"?Rt(g):m==="mensile"?Ht(g):m==="trimestrale"?Yt(g):m==="semestrale"?Gt(g):qt(g)}function De(m){var g=ke(new Date().getFullYear(),be(new Date)),S=g.start,T=Math.floor((new Date(m)-S)/(1e3*60*60*24));return T<=13}function we(m,g,S,T,M,$){var J=He(g,S),re=L('<div class="card" style="position:relative"><div class="small muted">'+w(m)+"</div><div><b>"+w(J)+'</b></div><div class="small muted">'+x(S)+" → "+x(T)+'</div><div class="right" style="margin-top:6px"><button class="ghost" type="button" data-sug="1">'+w(M)+"</button></div></div>");return re.querySelector("[data-sug]").addEventListener("click",$),re}function Le(m){var g=document.getElementById("bp_to_send"),S=document.getElementById("bp_sent");g.innerHTML="",S.innerHTML="";function T(fe,he,ge){return m.find(function(Be){return Be.type===fe&&B(Be.startDate)===B(he)&&B(Be.endDate)===B(ge)})}var M=new Date,$=M.getDay(),J=$===5||$===6||$===0,re=Ke(M),Q=Ze(M),pe=Qe(M),_e=qe(M),Pe=J&&De(re),ft=J&&De(Q),gt=J&&De(pe),bt=J&&De(_e);["settimanale","mensile","trimestrale","semestrale","annuale"].forEach(function(fe){var he=ce(fe,M),ge=T(fe,he.start,he.end);if(ge){var Be=L('<div class="card" style="flex:1 1 360px"><div><b>'+w(He(fe,he.start))+'</b></div><div class="small muted">'+x(he.start)+" → "+x(he.end)+'</div><div class="right" style="margin-top:6px"><button class="ghost" type="button" data-mid="'+ge.id+'">Modifica</button></div></div>');Be.querySelector("[data-mid]").addEventListener("click",function(){ae(ge,!1)}),S.appendChild(Be)}});function Ve(fe,he,ge){var Be=T(fe,ge.start,ge.end),Xe=T(fe,he.start,he.end);Be?g.appendChild(we("Previsionale",fe,ge.start,ge.end,"Modifica",function(){ae(Be,!1)})):g.appendChild(we("Previsionale",fe,ge.start,ge.end,"Compila",function(){if(p.value=fe,i.value=String(ge.start.getFullYear()),fe==="settimanale")c.value=String(be(ge.start));else if(fe==="mensile")o.value=String(ge.start.getMonth()+1);else if(fe==="trimestrale"){var Ct=Math.floor(ge.start.getMonth()/3)+1;P.value=String(Ct)}else fe==="semestrale"&&(y.value=ge.start.getMonth()<6?"1":"2");e()})),Xe&&!R(Xe)&&g.appendChild(we("Consuntivo",fe,he.start,he.end,"Consuntivo",function(){ae(Xe,!0)}))}if(J){var ht=ce("settimanale",M),yt=se("settimanale",M);Ve("settimanale",ht,yt)}if(Pe){var wt=ce("mensile",M),_t=se("mensile",M);Ve("mensile",wt,_t)}if(ft){var St=ce("trimestrale",M),Dt=se("trimestrale",M);Ve("trimestrale",St,Dt)}if(gt){var It=ce("semestrale",M),xt=se("semestrale",M);Ve("semestrale",It,xt)}if(bt){var Et=ce("annuale",M),Tt=se("annuale",M);Ve("annuale",Et,Tt)}g.children.length||(g.innerHTML='<div class="muted">Nessun suggerimento attivo in questo momento</div>');var Pt=document.getElementById("bp_sent_head"),Bt=document.getElementById("bp_sent_chev");Pt.onclick=function(){var fe=document.getElementById("bp_sent"),he=fe.style.display!=="none";fe.style.display=he?"none":"",Bt.textContent=he?"▸":"▾"}}ne("/api/settings").then(function(m){k=m&&m.indicators||["VSS","VSDPersonale","VSDIndiretto","GI","Telefonate","AppFissati","AppFatti","CorsiLeadership","iProfile","MBS","NNCF"],D(k)}).catch(function(){k=["VSS","VSDPersonale","GI","NNCF"],D(k)}),p.onchange=e,i.oninput=v,c.oninput=v,o.onchange=v,P.onchange=v,y.onchange=v,W.onclick=oe,document.getElementById("btnSaveP").onclick=X,e(),ee()}function Fe(){if(!me())return t();if(document.title="Battle Plan – Appuntamenti",!document.getElementById("appts_css")){const e=document.createElement("style");e.id="appts_css",e.textContent="\n      .appt-type .seg, #a_nncf.seg{\n        padding:8px 12px;border:1px solid #bcd7ff;border-radius:12px;\n        background:#eef5ff;color:#1463ff;cursor:pointer;user-select:none;\n        transition:.15s;\n      }\n      .appt-type .seg.active, #a_nncf.seg.active{\n        background:var(--accent);color:#fff;border-color:var(--accent);\n        box-shadow:0 0 0 2px rgba(20,99,255,.08) inset;\n      }\n      #a_list .grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}\n    ",document.head.appendChild(e)}d.innerHTML=Se()+'<div class="wrap"><div class="card"><b id="a_form_title">Nuovo appuntamento</b><div class="row" style="margin-top:8px;align-items:flex-end;gap:12px;flex-wrap:wrap"><div style="min-width:320px"><label>Cliente *</label><div style="display:flex;gap:8px;align-items:center"><input id="a_client" list="clientList" placeholder="Denominazione" style="flex:1"><datalist id="clientList"></datalist><button id="a_nncf" class="seg" data-active="0" aria-pressed="false">NNCF</button></div></div><div><label>Data/ora inizio</label><input id="a_start" type="datetime-local"></div><div><label>Ora fine</label><input id="a_end" type="time"></div><div><label>Durata (min)</label><input id="a_dur" type="number" placeholder="60" min="1"></div></div><div class="row" style="align-items:flex-end;gap:12px;flex-wrap:wrap"><div class="appt-type"><label>Tipo</label><div><button type="button" id="t_vendita" class="seg">Vendita</button><button type="button" id="t_mezza"   class="seg" data-vsd="1000">Mezza giornata</button><button type="button" id="t_full"    class="seg" data-vsd="2000">Giornata intera</button></div><input id="a_type" type="hidden" value="vendita"></div><div><label>VSS</label><input id="a_vss" type="number" step="1" placeholder="0"></div><div><label>VSD personale</label><input id="a_vsd" type="number" step="1" placeholder="0"></div></div><div class="row" style="margin-top:8px;gap:8px;align-items:center"><div><button id="btnSaveA">Salva</button></div><div><button id="btnSaveExportA" class="ghost">Salva ed esporta</button></div><div class="right" style="margin-left:auto"><button id="btnDeleteA" class="danger" style="display:none">Elimina</button></div></div></div><div class="card"><b>Elenco appuntamenti</b><div class="row" style="margin-top:8px;align-items:flex-end;gap:12px;flex-wrap:wrap"><div><label>Vista</label><select id="af_type"><option value="sett">Settimana</option><option value="mese">Mese</option></select></div><div id="af_week_wrap"><label>Settimana ISO</label><input id="af_week" type="number" min="1" max="53" value="'+be(new Date)+'"></div><div id="af_month_wrap" style="display:none"><label>Mese</label><select id="af_month"><option value="1">Gennaio</option><option value="2">Febbraio</option><option value="3">Marzo</option><option value="4">Aprile</option><option value="5">Maggio</option><option value="6">Giugno</option><option value="7">Luglio</option><option value="8">Agosto</option><option value="9">Settembre</option><option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option></select></div><div><label>Anno</label><input id="af_year" type="number" min="2000" max="2100" value="'+new Date().getFullYear()+'"></div><div class="right" style="margin-left:auto;display:flex;gap:8px"><button id="af_prev" class="ghost">◀</button><button id="af_next" class="ghost">▶</button></div></div><div id="a_list" style="margin-top:8px"></div></div></div>',ye();function n(e){return String(e).replace(/[&<>'"]/g,v=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[v])}function a(e){var v=Number(e)||0;return v.toLocaleString("it-IT")+"€"}function k(e){var v=new Date(e);return("0"+v.getDate()).slice(-2)+"/"+("0"+(v.getMonth()+1)).slice(-2)+"/"+v.getFullYear()}function l(e){if(!e)return"";const v=new Date(e);return isNaN(v)?"":v.toISOString()}function U(e){if(!e)return"";const v=new Date(e);return isNaN(v)?"":new Date(v.getTime()-v.getTimezoneOffset()*6e4).toISOString().slice(0,16)}function w(e){return e=String(e||"").toLowerCase(),e.indexOf("mezza")>-1?240:e.indexOf("giorn")>-1?570:90}const B=document.getElementById("a_nncf");B.addEventListener("click",()=>{const e=B.getAttribute("data-active")!=="1";B.setAttribute("data-active",e?"1":"0"),B.setAttribute("aria-pressed",e?"true":"false"),B.classList.toggle("active",e),e&&h(document.getElementById("t_vendita"))});const x=document.getElementById("t_vendita"),te=document.getElementById("t_mezza"),L=document.getElementById("t_full"),R=[x,te,L];function h(e){R.forEach(D=>D.classList.toggle("active",D===e));const v=document.getElementById("a_type");e===x&&(v.value="vendita",b(90)),e===te&&(v.value="mezza",b(240),document.getElementById("a_vsd").value="1000"),e===L&&(v.value="giornata",b(570),document.getElementById("a_vsd").value="2000")}function b(e){const v=document.getElementById("a_dur");v.value=String(e),p()}R.forEach(e=>e.addEventListener("click",v=>{v.preventDefault(),h(e)})),h(x);function p(){const e=document.getElementById("a_start").value,v=parseInt(document.getElementById("a_dur").value||"0",10);if(!e||!isFinite(v)||v<=0){document.getElementById("a_end").value="";return}const D=new Date(e),V=new Date(D.getTime()+v*6e4);document.getElementById("a_end").value=("0"+V.getHours()).slice(-2)+":"+("0"+V.getMinutes()).slice(-2)}function i(){const e=document.getElementById("a_start").value,v=document.getElementById("a_end").value;if(!e||!v)return;const D=new Date(e),V=v.split(":");if(V.length<2)return;const C=new Date(D);C.setHours(parseInt(V[0],10)||0,parseInt(V[1],10)||0,0,0),C<D&&C.setDate(C.getDate()+1);let E=Math.round((C-D)/6e4);document.getElementById("a_dur").value=String(Math.max(1,E))}document.getElementById("a_start").addEventListener("change",p),document.getElementById("a_dur").addEventListener("input",p),document.getElementById("a_end").addEventListener("change",i),ne("/api/clients").then(e=>{const v=e&&e.clients||[],D=document.getElementById("clientList");D&&(D.innerHTML=v.map(V=>'<option value="'+n(V.name)+'"></option>').join(""))});let f=null;function s(){f=null,document.getElementById("a_form_title").textContent="Nuovo appuntamento",document.getElementById("a_client").value="",document.getElementById("a_start").value="",document.getElementById("a_end").value="",document.getElementById("a_dur").value="",document.getElementById("a_vss").value="",document.getElementById("a_vsd").value="",B.setAttribute("data-active","0"),B.setAttribute("aria-pressed","false"),B.classList.remove("active"),h(x),document.getElementById("btnDeleteA").style.display="none"}function F(e){f=e.id,document.getElementById("a_form_title").textContent="Modifica appuntamento",document.getElementById("a_client").value=e.client||"",document.getElementById("a_start").value=U(e.start);const v=new Date(e.start);let D=new Date(e.end),V=Math.max(1,Math.round((D-v)/6e4));if(!(D instanceof Date)||isNaN(D)||D<v){const E=w(e.type||"vendita");D=new Date(v.getTime()+E*6e4),V=E}document.getElementById("a_dur").value=String(V),document.getElementById("a_end").value=("0"+D.getHours()).slice(-2)+":"+("0"+D.getMinutes()).slice(-2),document.getElementById("a_vss").value=e.vss||"",document.getElementById("a_vsd").value=e.vsdPersonal||e.vsd||"";const C=!!e.nncf;B.setAttribute("data-active",C?"1":"0"),B.setAttribute("aria-pressed",C?"true":"false"),B.classList.toggle("active",C),h(V===240?te:V===570?L:x),document.getElementById("btnDeleteA").style.display=""}function r(){const e=(document.getElementById("a_client").value||"").trim();if(!e)return K("Cliente obbligatorio"),null;const v=document.getElementById("a_start").value;if(!v)return K("Data/ora obbligatorie"),null;let D=parseInt(document.getElementById("a_dur").value||"60",10);(!isFinite(D)||D<=0)&&(D=60);const V=document.getElementById("a_end").value;let C;if(V){const E=new Date(v),O=V.split(":"),H=new Date(E);H.setHours(parseInt(O[0],10)||0,parseInt(O[1],10)||0,0,0),H<E&&H.setDate(H.getDate()+1),C=H.toISOString(),D=Math.max(1,Math.round((H-E)/6e4)),document.getElementById("a_dur").value=String(D)}else C=new Date(new Date(v).getTime()+D*6e4).toISOString();return{id:f||void 0,client:e,start:l(v),end:C,type:document.getElementById("a_type").value,vss:Number(document.getElementById("a_vss").value||0),vsdPersonal:Number(document.getElementById("a_vsd").value||0),nncf:B.getAttribute("data-active")==="1"}}function c(e){const v=r();v&&Ie("/api/appointments",v).then(()=>{K("Appuntamento salvato"),typeof haptics<"u"&&haptics.try("success"),document.dispatchEvent(new Event("appt:saved")),e&&window.BP&&BP.ICS&&typeof BP.ICS.downloadIcsForAppointment=="function"&&(BP.ICS.downloadIcsForAppointment(v),typeof haptics<"u"&&haptics.try("medium"),document.dispatchEvent(new Event("ics:exported"))),s(),j()}).catch(()=>K("Errore salvataggio"))}function o(){if(!f||!confirm("Eliminare l'appuntamento?"))return;const e=r();fetch("/api/appointments?id="+encodeURIComponent(f),{method:"DELETE",headers:{Authorization:"Bearer "+et()}}).then(v=>{if(!v.ok)throw new Error("HTTP "+v.status);return v.json()}).then(()=>{K("Eliminato"),typeof showUndo=="function"&&e&&showUndo("Appuntamento eliminato",function(){return Ie("/api/appointments",e)},5e3),s(),j()}).catch(()=>K("Errore eliminazione"))}document.getElementById("btnSaveA").onclick=()=>c(!1),document.getElementById("btnSaveExportA").onclick=()=>c(!0),document.getElementById("btnDeleteA").onclick=o;function P(){const e=document.getElementById("af_type").value,v=parseInt(document.getElementById("af_year").value,10);if(e==="sett"){const D=Math.max(1,Math.min(53,parseInt(document.getElementById("af_week").value||be(new Date),10))),V=ke(v,D);return{s:new Date(V.start),e:new Date(V.end)}}else{const D=parseInt(document.getElementById("af_month").value||new Date().getMonth()+1,10);return{s:new Date(v,D-1,1),e:new Date(v,D,0,23,59,59,999)}}}function y(e){const v=document.getElementById("af_type").value,D=parseInt(document.getElementById("af_year").value,10);if(v==="sett"){const V=parseInt(document.getElementById("af_week").value,10),C=new Date(ke(D,V).start);C.setDate(C.getDate()+7*e),document.getElementById("af_year").value=C.getFullYear(),document.getElementById("af_week").value=be(C)}else{const V=parseInt(document.getElementById("af_month").value,10),C=new Date(D,V-1,1);C.setMonth(C.getMonth()+e),document.getElementById("af_year").value=C.getFullYear(),document.getElementById("af_month").value=C.getMonth()+1}j()}document.getElementById("af_prev").onclick=()=>y(-1),document.getElementById("af_next").onclick=()=>y(1);const Y=document.getElementById("af_type"),_=document.getElementById("af_week"),A=document.getElementById("af_month"),G=document.getElementById("af_year");Y.onchange=function(){const e=Y.value;document.getElementById("af_week_wrap").style.display=e==="sett"?"":"none",document.getElementById("af_month_wrap").style.display=e==="mese"?"":"none",j()},[_,A,G].forEach(e=>{e&&(e.onchange=j)});function W(e){const v=new Date(e.start);let D=new Date(e.end);(!(D instanceof Date)||isNaN(D)||D<v)&&(D=new Date(v.getTime()+w(e.type||"vendita")*6e4));const V=k(v)+" "+("0"+v.getHours()).slice(-2)+":"+("0"+v.getMinutes()).slice(-2)+"–"+("0"+D.getHours()).slice(-2)+":"+("0"+D.getMinutes()).slice(-2),C="VSS "+a(e.vss||0)+" · VSD "+a(e.vsdPersonal||0)+" · NNCF "+(e.nncf?"✅":"—");return'<div class="card" data-aid="'+n(String(e.id||""))+'" style="flex:1 1 320px"><div class="small muted">'+n(V)+" · "+n(e.type||"vendita")+'</div><div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><div><b>'+n(e.client||"")+'</b></div><div class="row" style="gap:6px"><button class="ghost" title="Esporta" data-ics="'+n(String(e.id||""))+'">Esporta</button><button class="ghost" title="Modifica" data-edit="'+n(String(e.id||""))+'">✏️</button></div></div><div class="small">'+C+"</div></div>"}function j(){ne("/api/appointments").then(e=>{const v=e&&e.appointments||[],D=P(),V=D.s.getTime(),C=D.e.getTime(),E=v.filter(q=>{const I=new Date(q.start).getTime();return I>=V&&I<=C}).sort((q,I)=>new Date(q.start)-new Date(I.start)),O=new Date,H=E.filter(q=>new Date(q.start)>=O),Z=E.filter(q=>new Date(q.start)<O),oe=document.getElementById("a_list");let ie="";ie+="<div><b>Prossimi</b></div>",ie+=H.length?'<div class="grid3">'+H.map(W).join("")+"</div>":'<div class="muted" style="margin:6px 0 12px">Nessun appuntamento futuro</div>';const u="past_"+Math.random().toString(36).slice(2,8);ie+='<div id="'+u+'_head" style="margin-top:12px;display:flex;align-items:center;justify-content:space-between;cursor:pointer"><b>Passati</b><span class="chev">▸</span></div><div id="'+u+'_box" style="display:none;margin-top:8px">'+(Z.length?'<div class="grid3">'+Z.map(W).join("")+"</div>":'<div class="muted">Nessun appuntamento passato</div>')+"</div>",oe.innerHTML=ie,(function(){const q=document.getElementById(u+"_head"),I=document.getElementById(u+"_box"),X=q.querySelector(".chev");q.onclick=function(){const ee=I.style.display==="none";I.style.display=ee?"":"none",X.textContent=ee?"▾":"▸"}})();const N=E;oe.querySelectorAll("[data-ics]").forEach(q=>{q.addEventListener("click",I=>{I.stopPropagation();const X=q.getAttribute("data-ics"),ee=N.find(ae=>String(ae.id)===String(X));if(!ee){K("Appuntamento non trovato");return}window.BP&&BP.ICS&&typeof BP.ICS.downloadIcsForAppointment=="function"?(BP.ICS.downloadIcsForAppointment(ee),typeof haptics<"u"&&haptics.try("medium"),document.dispatchEvent(new Event("ics:exported")),K("Esportato")):K("Export .ics non disponibile")})}),oe.querySelectorAll("[data-edit]").forEach(q=>{q.addEventListener("click",I=>{I.stopPropagation();const X=q.getAttribute("data-edit"),ee=N.find(ae=>String(ae.id)===String(X));ee&&(F(ee),window.scrollTo({top:0,behavior:"smooth"}))})})})}try{const e=Ge("bp_prefill_slot",null);if(e&&e.start){const v=new Date(e.start),D=new Date(e.end||e.start),V=new Date(v.getTime()-v.getTimezoneOffset()*6e4).toISOString().slice(0,16);document.getElementById("a_start").value=V,document.getElementById("a_dur").value=String(Math.max(1,Math.round((D-v)/6e4))),p(),K("Slot precompilato negli appuntamenti")}Oe("bp_prefill_slot")}catch(e){}try{const e=Ge("bp_edit_aid",null);e&&ne("/api/appointments").then(v=>{const V=(v&&v.appointments||[]).find(C=>String(C.id)===String(e));V&&(F(V),window.scrollTo({top:0,behavior:"smooth"}))}).finally(()=>{try{Oe("bp_edit_aid")}catch(v){}})}catch(e){}document.getElementById("btnSaveA").onclick=()=>c(!1),document.getElementById("btnSaveExportA").onclick=()=>c(!0),document.getElementById("btnDeleteA").onclick=o,ne("/api/clients").then(()=>{}),j()}function st(){if(!me())return t();document.title="Battle Plan – Classifiche",d.innerHTML=Se()+('<div class="wrap"><div class="card"><div class="row"><div><label>Vista</label><select id="lb_tab"><option value="per_indicator">Per indicatore</option><option value="overall">Generale (score)</option></select></div><div><label>Modalità</label><select id="lb_mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div><div id="lb_ind_wrap"><label>Indicatore</label><select id="lb_indicator"><option value="VSS">VSS</option><option value="VSDPersonale">VSD</option><option value="GI">GI</option><option value="NNCF">NNCF</option></select></div></div>'+z("lb")+'</div><div class="card"><b id="lb_title">Classifica</b><div id="lb_podium" style="margin:10px 0"></div><div id="lb_table"></div></div></div>'),ye();function n(L){if(!L)return"";var R=new Date(L);return R.getFullYear()+"-"+("0"+(R.getMonth()+1)).slice(-2)+"-"+("0"+R.getDate()).slice(-2)}function a(L){return L==="ytd"||L==="ltm"?"mensile":L}document.getElementById("lb_tab").onchange=function(){var L=this.value;document.getElementById("lb_ind_wrap").style.display=L==="per_indicator"?"":"none",l()},le("lb",l),document.getElementById("lb_mode").onchange=l,document.getElementById("lb_indicator").onchange=l;function k(){var L=ue("lb"),R=n(L.start),h=n(L.end),b=a(L.type||"mensile");return"&from="+encodeURIComponent(R)+"&to="+encodeURIComponent(h)+"&type="+encodeURIComponent(b)}function l(){var L=document.getElementById("lb_tab").value,R=k(),h=document.getElementById("lb_mode").value;if(L==="overall")ne("/api/leaderboard_overall?mode="+encodeURIComponent(h)+R).then(te);else{var b=document.getElementById("lb_indicator").value;ne("/api/leaderboard?indicator="+encodeURIComponent(b)+"&mode="+encodeURIComponent(h)+R).then(function(p){x(p,b)})}}function U(L){return L===0?"🥇":L===1?"🥈":L===2?"🥉":L+1+"."}function w(L){var R=document.getElementById("lb_podium");if(!L||!L.length){R.innerHTML="";return}for(var h=L.slice(0,3),b='<div class="row" style="align-items:flex-end">',p=0;p<h.length;p++){var i=80-p*15;b+='<div class="card" style="flex:1 1 120px;height:'+i+'px;display:flex;align-items:flex-end;justify-content:center"><div>'+ve(U(p)+" "+h[p].name)+"</div></div>"}b+="</div>",R.innerHTML=b}function B(L,R,h){var b=Math.min(100,Math.max(0,Math.round(h)));return'<div class="card" style="flex:1 1 280px"><div><b>'+ve(L)+'</b></div><div class="small muted">'+ve(R)+'</div><div style="height:10px;background:rgba(255,255,255,0.1);border-radius:6px;overflow:hidden;margin-top:6px"><div style="height:10px;width:'+b+'%;background:linear-gradient(90deg,var(--accent),var(--accent2));"></div></div></div>'}function x(L,R){document.getElementById("lb_title").textContent="Classifica – "+R;var h=L.ranking||[];if(w(h),!h.length){document.getElementById("lb_table").innerHTML='<div class="muted">Nessun dato</div>';return}for(var b='<div class="row">',p=h[0].total||1,i=0;i<h.length;i++){var f=h[i];b+=B(U(i)+" "+f.name,"Totale: "+Me(f.total),f.total/p*100)}b+="</div>",document.getElementById("lb_table").innerHTML=b}function te(L){document.getElementById("lb_title").textContent="Classifica generale";var R=L.ranking||[];if(w(R),!R.length){document.getElementById("lb_table").innerHTML='<div class="muted">Nessun dato</div>';return}for(var h=R[0].score||0,b='<div class="row">',p=0;p<R.length;p++){var i=R[p];b+=B(U(p)+" "+i.name,"Score: "+Me(i.score)+"/100",h?i.score/h*100:0)}b+="</div>",document.getElementById("lb_table").innerHTML=b}l()}(function(){function n(){var a=document.getElementById("bp-overlay");return a||(a=document.createElement("div"),a.id="bp-overlay",a.className="hidden",a.setAttribute("role","dialog"),a.setAttribute("aria-modal","true"),a.innerHTML='<div class="bp-overlay-backdrop" id="bp-overlay-backdrop"></div><div class="bp-overlay-panel" id="bp-overlay-panel"></div>',document.body.appendChild(a),document.getElementById("bp-overlay-backdrop").addEventListener("click",hideOverlay)),a}window.showOverlay=function(a){var k=n(),l=document.getElementById("bp-overlay-panel");l.innerHTML=a||"",k.classList.remove("hidden");var U=l.querySelector("input, textarea, select, button");U&&setTimeout(function(){try{U.focus()}catch(w){}},0)},window.hideOverlay=function(){var a=document.getElementById("bp-overlay");a&&a.classList.add("hidden")}})();function dt(){if(!me())return t();document.title="Battle Plan – Clienti",d.innerHTML=Se()+'<div class="wrap"><div class="card"><b>Nuovo cliente</b><div class="row" style="margin-top:8px"><div><label>Ragione sociale</label><input id="cl_name" type="text" placeholder="Es. Rossi S.r.l."></div><div><label>Stato</label><select id="cl_new_state"><option value="potenziale">Potenziale</option><option value="lead non chiuso">Lead non chiuso</option><option value="attivo">Attivo</option></select></div><div><label>Consulente</label><select id="cl_new_owner"><option value="">—</option></select></div><div class="right"><button id="cl_add">Aggiungi</button></div></div></div><div class="card"><b>Filtri elenco</b><div class="row" style="margin-top:8px"><div><label>Stato</label><select id="cl_f_state"><option value="">Tutti</option><option value="attivo">Attivo</option><option value="lead non chiuso">Lead non chiuso</option><option value="potenziale">Potenziale</option></select></div><div><label>Consulente</label><select id="cl_f_cons"><option value="">Tutti</option></select></div><div><label>Ordina per</label><select id="cl_order"><option value="az">Ragione sociale (A→Z)</option><option value="last_desc">Ultimo appuntamento (recenti prima)</option></select></div><div class="right"><button class="ghost" id="cl_f_apply">Applica</button></div></div></div><div class="card"><b>Elenco clienti</b><div id="cl_list" class="row" style="margin-top:8px"></div></div></div>',ye();function n(){const l=(document.getElementById("cl_name").value||"").trim();if(!l){K("Nome obbligatorio");return}const U=document.getElementById("cl_new_state"),w=document.getElementById("cl_new_owner"),B={name:l};U&&(B.status=U.value),w&&w.value&&(B.consultantId=w.value),Ie("/api/clients",B).then(function(){document.getElementById("cl_name").value="",k(),Ye(),addXP(5)}).catch(function(x){logger.error(x),K("Errore creazione cliente")})}function a(){ne("/api/usernames").then(function(l){const U=l&&l.users||[],w=document.getElementById("cl_f_cons"),B=document.getElementById("cl_new_owner");w&&(w.innerHTML='<option value="">Tutti</option>'+U.map(function(x){return'<option value="'+x.id+'">'+ve(x.name)+(x.grade?" ("+x.grade+")":"")+"</option>"}).join("")),B&&(B.innerHTML='<option value="">—</option>'+U.map(function(x){return'<option value="'+x.id+'">'+ve(x.name)+(x.grade?" ("+x.grade+")":"")+"</option>"}).join(""))}).catch(function(l){logger.error(l)})}function k(){ne("/api/clients").then(function(l){const U=l&&l.clients||[],w=document.getElementById("cl_f_state").value,B=document.getElementById("cl_f_cons").value;function x(R){return String(R||"").trim().toLowerCase()}const L=U.filter(function(R){return!(w&&x(R.status)!==x(w)||B&&String(R.consultantId||"")!==String(B))}).map(function(R){const h=ve(R.name||""),b=ve(R.status||"potenziale"),p=R.consultantName?ve(R.consultantName):"unknown",i=String(R.id||"");return'<div class="card" data-clid="'+i+'" data-name-lower="'+h.toLowerCase()+'" data-status="'+b+'" data-consultant-id="'+ve(String(R.consultantId||""))+'" style="flex:1 1 380px"><div><b>'+h+'</b></div><div class="small">Stato: <b class="cl-status">'+b+'</b></div><div class="small">Consulente: <b class="cl-cons">'+p+'</b></div><div class="small muted">Ultimo appuntamento: <span class="last-appt">—</span></div><div class="right" style="margin-top:6px"><button class="ghost" data-del="'+i+'">Rimuovi</button></div></div>'}).join("");document.getElementById("cl_list").innerHTML=L||'<div class="muted">Nessun cliente</div>',document.querySelectorAll("[data-del]").forEach(function(R){R.addEventListener("click",function(){const h=R.getAttribute("data-del");confirm("Rimuovere il cliente?")&&fetch("/api/clients?id="+encodeURIComponent(h),{method:"DELETE",headers:{Authorization:"Bearer "+et()}}).then(function(b){if(!b.ok)throw new Error("HTTP "+b.status);return b.json()}).then(function(){K("Cliente rimosso"),k()}).catch(function(b){logger.error(b),K("Errore rimozione")})})}),window.BPFinal&&typeof BPFinal.ensureClientSection=="function"?BPFinal.ensureClientSection():setTimeout(function(){const R=document.getElementById("cl_list"),h=Array.from(R.children).filter(b=>b.classList.contains("card"));h.sort((b,p)=>String(b.getAttribute("data-name-lower")||"").localeCompare(String(p.getAttribute("data-name-lower")||"")));for(const b of h)R.appendChild(b)},0)})}document.getElementById("cl_add").onclick=n,document.getElementById("cl_f_apply").onclick=k,a(),k()}function ct(){if(!me())return t();document.title="Battle Plan – Squadra";var n=Se()+'<div class="wrap">'+('<div class="card"><b>Vista Amministratore</b><div id="t_adminbar" class="row" style="margin-top:8px;display:flex;align-items:flex-end;gap:16px;flex-wrap:nowrap"><div><label>Modalità</label><select id="t_mode" name="mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div><div id="t_unified_wrap">'+z("t")+'</div></div></div><div class="card"><b>Riepilogo per utente</b><div id="t_users" class="row" style="margin-top:8px"></div></div><div class="card"><b>Aggregato Squadra</b><div id="t_agg" class="row" style="margin-top:8px"></div><div class="row" style="margin-top:12px;align-items:flex-end;gap:16px;flex-wrap:nowrap"><div><label>Indicatore grafico</label><select id="t_ind"><option value="VSS">VSS</option><option value="VSDPersonale">VSD Personale</option><option value="VSDIndiretto">VSD Indiretto</option><option value="VSDTotale">VSD Totale</option><option value="GI">GI</option><option value="NNCF">NNCF</option><option value="provv_gi">Provv GI</option><option value="provv_vsd">Provv VSD</option><option value="tot_provv" selected>Tot Provvigioni</option></select></div><div><label>Consulente</label><select id="t_cons"><option value="">Tutti</option></select></div></div><div style="margin-top:8px"><canvas id="t_chart" height="160"></canvas></div></div>')+"</div>";d.innerHTML=n,ye(),(function(){var c=document.getElementById("t_adminbar"),o=document.getElementById("t_unified_wrap");if(!(!c||!o)){var P=o.querySelector(".row");P&&(Array.from(P.children).forEach(function(y){y.classList.remove("right"),y.style.marginTop="0",c.appendChild(y)}),o.remove())}})();function a(r){return r=Number(r||0),isFinite(r)?r:0}function k(r){if(!r)return"";var c=new Date(r);return c.getFullYear()+"-"+("0"+(c.getMonth()+1)).slice(-2)+"-"+("0"+c.getDate()).slice(-2)}function l(r){return r=String(r||"mensile").toLowerCase(),r.indexOf("sett")===0?"settimanale":r.indexOf("mes")===0?"mensile":r.indexOf("tri")===0?"trimestrale":r.indexOf("sem")===0?"semestrale":r.indexOf("ann")===0?"annuale":"mensile"}function U(){var r=ue("t"),c=k(r.start),o=k(r.end),P=l(r.type);return"&from="+encodeURIComponent(c)+"&to="+encodeURIComponent(o)+"&type="+encodeURIComponent(P)}function w(r){switch(String(r)){case"provv_gi":return"ProvvGI";case"provv_vsd":return"ProvvVSD";case"tot_provv":return"TotProvvigioni";default:return r}}function B(r){var c=Number(r)||0;return c.toLocaleString("it-IT")+"€"}function x(r){var c=Number(r)||0;return String(Math.round(c))}function te(r){return String(r).replace(/[&<>'"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[c])}var L=null;function R(r,c){return c==="settimanale"?window.isoWeekNum?window.isoWeekNum(r):Math.ceil(r.getDate()/7):c==="mensile"||c==="ytd"||c==="ltm"?r.getMonth()+1:c==="trimestrale"?Math.floor(r.getMonth()/3)+1:c==="semestrale"?r.getMonth()<6?1:2:r.getFullYear()}function h(r,c){var o=document.getElementById("t_chart");if(o){var P=r.map(function(G){return R(G.x,c)}),y=r.map(function(G){return G.y});if(typeof Chart>"u"){var A=o.getContext("2d");o.width=o.clientWidth||600,o.height=o.clientHeight||160,A.clearRect(0,0,o.width,o.height);var Y=Math.max(1,...y),_=y.length>1?(o.width-8)/(y.length-1):0;A.beginPath(),A.lineWidth=2,A.strokeStyle="#2e6cff",y.forEach(function(W,j){var e=4+j*_,v=o.height-6-W/Y*(o.height-12);j?A.lineTo(e,v):A.moveTo(e,v)}),A.stroke();return}var A=o.getContext("2d");L?(L.data.labels=P,L.data.datasets[0].data=y,L.update()):L=new Chart(A,{type:"line",data:{labels:P,datasets:[{label:"",data:y,tension:.3,pointRadius:3}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{x:{grid:{display:!1},ticks:{autoSkip:!1,maxRotation:0,minRotation:0}},y:{beginAtZero:!0}}}})}}function b(r){return'<div class="card" style="flex:1 1 360px"><div style="display:flex;align-items:center;gap:8px"><div><b>'+te(r.name||"User #"+r.userId)+"</b></div>"+(r.grade?'<span class="chip small">'+te(r.grade)+"</span>":"")+'</div><div class="small" style="margin-top:6px">VSS '+B(r.vss||0)+'</div><div class="small">VSD Pers. '+B(r.vsdP||0)+'</div><div class="small">VSD Ind. '+B(r.vsdI||0)+'</div><div class="small">VSD Tot. '+B((r.vsdP||0)+(r.vsdI||0))+'</div><div class="small">GI '+B(r.gi||0)+'</div><div class="small">NNCF '+x(r.nncf||0)+'</div><div class="small muted" style="margin-top:6px">Provv GI '+B(r.provvGi||0)+'</div><div class="small muted">Provv VSD '+B(r.provvVsd||0)+'</div><div class="small"><b>Tot Provvigioni '+B(r.provvTot||0)+"</b></div></div>"}function p(r){return'<div class="card" style="flex:1 1 460px"><div class="neon" style="font-weight:900">Totali squadra</div><div class="small" style="margin-top:6px">VSS '+B(r.vss)+'</div><div class="small">VSD Pers. '+B(r.vsdP)+'</div><div class="small">VSD Ind. '+B(r.vsdI)+'</div><div class="small">VSD Tot. '+B(r.vsdP+r.vsdI)+'</div><div class="small">GI '+B(r.gi)+'</div><div class="small">NNCF '+x(r.nncf)+'</div><div class="small muted" style="margin-top:6px">Provv GI '+B(r.provvGi)+'</div><div class="small muted">Provv VSD '+B(r.provvVsd)+'</div><div class="small"><b>Tot Provvigioni '+B(r.provvTot)+"</b></div></div>"}function i(){var r=(document.getElementById("t_mode")||{}).value||"consuntivo",c=U();Promise.all([ne("/api/usernames"),ne("/api/leaderboard?indicator="+encodeURIComponent("VSS")+c+"&mode="+encodeURIComponent(r)),ne("/api/leaderboard?indicator="+encodeURIComponent("VSDPersonale")+c+"&mode="+encodeURIComponent(r)),ne("/api/leaderboard?indicator="+encodeURIComponent("VSDIndiretto")+c+"&mode="+encodeURIComponent(r)),ne("/api/leaderboard?indicator="+encodeURIComponent("GI")+c+"&mode="+encodeURIComponent(r)),ne("/api/leaderboard?indicator="+encodeURIComponent("NNCF")+c+"&mode="+encodeURIComponent(r)),ne("/api/leaderboard?indicator="+encodeURIComponent("ProvvGI")+c+"&mode="+encodeURIComponent(r)),ne("/api/leaderboard?indicator="+encodeURIComponent("ProvvVSD")+c+"&mode="+encodeURIComponent(r))]).then(function(o){var P=o[0]||{},y=o[1]&&(o[1].rows||o[1].ranking)||[],Y=o[2]&&(o[2].rows||o[2].ranking)||[],_=o[3]&&(o[3].rows||o[3].ranking)||[],A=o[4]&&(o[4].rows||o[4].ranking)||[],G=o[5]&&(o[5].rows||o[5].ranking)||[],W=o[6]&&(o[6].rows||o[6].ranking)||[],j=o[7]&&(o[7].rows||o[7].ranking)||[],e=(P.users||[]).map(function(I){return{id:String(I.id),name:I.name||I.email||"User #"+I.id,grade:I.grade==="senior"?"senior":"junior"}}),v=document.getElementById("t_cons");v&&(v.innerHTML='<option value="">Tutti</option>'+e.map(function(I){return'<option value="'+I.id+'">'+te(I.name)+"</option>"}).join(""));function D(I){for(var X={},ee=0;ee<I.length;ee++){var ae=I[ee],ce=String(ae.userId||ae.id||ae.uid||""),se=a(ae.total||ae.value||ae.sum||0);ce&&(X[ce]=se)}return X}var V=D(y),C=D(Y),E=D(_),O=D(A),H=D(G),Z=D(W),oe=D(j),ie=e.map(function(I){var X=a(V[I.id]),ee=a(C[I.id]),ae=a(E[I.id]),ce=a(O[I.id]),se=a(H[I.id]),De=a(Z[I.id]),we=a(oe[I.id]);return{userId:I.id,name:I.name,grade:I.grade,vss:X,vsdP:ee,vsdI:ae,gi:ce,nncf:se,provvGi:De,provvVsd:we,provvTot:De+we}}),u=document.getElementById("t_users");u&&(u.innerHTML=ie.length?ie.map(b).join(""):'<div class="muted">Nessun dato</div>');var N=ie.reduce(function(I,X){return I.vss+=X.vss,I.vsdP+=X.vsdP,I.vsdI+=X.vsdI,I.gi+=X.gi,I.nncf+=X.nncf,I.provvGi+=X.provvGi,I.provvVsd+=X.provvVsd,I.provvTot+=X.provvTot,I},{vss:0,vsdP:0,vsdI:0,gi:0,nncf:0,provvGi:0,provvVsd:0,provvTot:0}),q=document.getElementById("t_agg");q&&(q.innerHTML=p(N)),F()}).catch(function(o){logger.error(o),K("Errore caricamento squadra")})}function f(r){return(typeof Ue=="function"?Ue(r,new Date):[]).map(function(c){return{s:c.s,e:c.e}})}function s(r,c,o,P){var y=P||ue("t"),Y=String(y.type||"mensile").toLowerCase(),_=Y==="ytd"||Y==="ltm"?"mensile":Y,A=f(Y);function G(j,e){var v=new Date(e.startDate).getTime(),D=new Date(e.endDate).getTime();return v>=j.s&&D<=j.e}function W(j,e){if(!j)return 0;if(e==="VSDTotale")return Number(j.VSDPersonale||0)+Number(j.VSDIndiretto||0);if(e==="ProvvGI")return Number(j.ProvvGI||0);if(e==="ProvvVSD")return Number(j.ProvvVSD||0);if(e==="TotProvvigioni"){var v=j.TotProvvigioni;return Number(v!=null?v:Number(j.ProvvGI||0)+Number(j.ProvvVSD||0))}return Number(j[e]||0)}return ne("/api/periods?global=1").catch(function(){return ne("/api/periods")}).then(function(j){var e=j&&j.periods||[],v=e.filter(function(V){return!(V.type!==_||o&&String(V.userId||V.uid||"")!==String(o))}),D=A.map(function(V){for(var C=0,E=0;E<v.length;E++){var O=v[E];if(G(V,O)){var H=c==="previsionale"?O.indicatorsPrev||{}:O.indicatorsCons||{};C+=W(H,w(r))}}return{x:new Date(V.s),y:Math.round(C*100)/100}});return D})}function F(){var r=document.getElementById("t_ind").value,c=document.getElementById("t_mode").value||"consuntivo",o=document.getElementById("t_cons").value||"",P=ue("t"),y=P.type,Y=w(r);U()+(o?"&userId="+encodeURIComponent(o):"")+("&indicator="+encodeURIComponent(Y))+("&mode="+encodeURIComponent(c));var _=s(Y,c,o||null,P);_.then(function(A){h(A,y)}).catch(function(A){logger.error(A),h([],y)})}le("t",function(){typeof haptic=="function"&&haptic("light"),i()}),document.getElementById("t_mode").onchange=function(){typeof haptic=="function"&&haptic("light"),i()},document.getElementById("t_ind").onchange=function(){typeof haptic=="function"&&haptic("light"),F()},document.getElementById("t_cons").onchange=function(){typeof haptic=="function"&&haptic("light"),F()},i()}function ut(){if(!me())return t();var n=me().role==="admin";document.title="Battle Plan – Provvigioni",d.innerHTML=Se()+'<div class="wrap"><div class="card"><b>Calcolo provvigioni</b><div class="row" style="margin-top:8px; gap:12px; flex-wrap:wrap">'+(n?'<div><label>Utente</label><select id="comm_user"><option value="__all">Tutta la squadra</option></select></div>':"")+'<div><label>Modalità</label><select id="comm_mode" name="mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div></div>'+z("comm")+'</div><div class="card"><b>Indicatori periodo</b><div id="comm_total" class="row" style="margin-top:8px; gap:12px; flex-wrap:wrap"></div></div><div class="card"><b>Provvigioni – ripartizione</b><div class="small muted">Confronto tra Provvigioni GI e Provvigioni VSD sul periodo selezionato</div><div class="row" style="margin-top:8px; align-items:center; gap:16px; flex-wrap:wrap"><canvas id="cm_pie_provv" width="260" height="260" style="max-width:260px; max-height:260px"></canvas><div id="cm_pie_legend" class="small"></div></div></div><div class="card"><b>Dettaglio</b><div id="comm_rows" class="row" style="margin-top:8px; gap:12px; flex-wrap:wrap"></div></div></div>',ye();function a(h){return document.getElementById(h)}function k(h){var b=Number(h)||0;return b.toLocaleString("it-IT")+"€"}function l(h){return h=Number(h==null?"":h),isFinite(h)?h:0}function U(h){return h?h.TotProvvigioni!=null?l(h.TotProvvigioni):l(h.ProvvGI)+l(h.ProvvVSD):0}function w(h,b){return'<div class="card" style="flex:1 1 180px"><div class="small muted">'+ve(h)+'</div><div style="font-weight:700; font-size:20px; margin-top:4px">'+b+"</div></div>"}function B(h){return""+w("VSD personale",k(h.vsd||0))+w("GI",k(h.gi||0))+w("Provv. VSD",k(h.provv_vsd||0))+w("Provv. GI",k(h.provv_gi||0))+w("Totale Provvigioni",k(h.provv_total||0))}function x(h){return h.length?h.map(function(b){return'<div class="card" style="flex:1 1 320px"><div><b>'+ve(b.name)+'</b></div><div class="small" style="margin-top:4px">GI '+k(b.gi||0)+" · VSD "+k(b.vsd||0)+'</div><div class="small muted" style="margin-top:2px">Provv. GI '+k(b.provv_gi||0)+" · Provv. VSD "+k(b.provv_vsd||0)+'</div><div class="small" style="margin-top:6px"><b>Totale: '+k(b.provv_total||0)+"</b></div></div>"}).join(""):'<div class="muted">Nessun dato</div>'}function te(h,b,p){var i=document.getElementById("cm_pie_provv"),f=document.getElementById("cm_pie_legend");if(!i||!i.getContext){f&&(f.innerHTML="");return}var s=i.getContext("2d"),F=i.width,r=i.height,c=F/2,o=r/2,P=Math.min(F,r)/2-8;s.clearRect(0,0,F,r);var y=Math.max(0,h||0),Y=Math.max(0,b||0),_=y+Y,A=p>0?Math.round(_/p*100):null;if(_<=0){s.beginPath(),s.arc(c,o,P,0,Math.PI*2),s.strokeStyle="#ccd0d5",s.lineWidth=10,s.setLineDash([6,6]),s.stroke(),s.setLineDash([]),s.globalCompositeOperation="destination-out",s.beginPath(),s.arc(c,o,P*.55,0,Math.PI*2),s.fill(),s.globalCompositeOperation="source-over",s.fillStyle="#111",s.textAlign="center",s.textBaseline="middle",s.font="bold 20px system-ui, -apple-system, Segoe UI, Roboto, sans-serif",s.fillText(A==null?"—":A+"%",c,o),f&&(f.innerHTML='<div class="muted">Nessuna provvigione nel periodo</div>');return}var G=[{label:"Provv. GI",value:y,color:"#4F8EF7"},{label:"Provv. VSD",value:Y,color:"#F79F4F"}],W=-Math.PI/2;G.forEach(function(v){var D=v.value/_*Math.PI*2;s.beginPath(),s.moveTo(c,o),s.arc(c,o,P,W,W+D),s.closePath(),s.fillStyle=v.color,s.fill(),W+=D}),s.globalCompositeOperation="destination-out",s.beginPath(),s.arc(c,o,P*.55,0,Math.PI*2),s.fill(),s.globalCompositeOperation="source-over",s.fillStyle="#111",s.textAlign="center",s.textBaseline="middle",s.font="bold 20px system-ui, -apple-system, Segoe UI, Roboto, sans-serif",s.fillText(A==null?"—":A+"%",c,o);var j=Math.round(y/_*100),e=Math.round(Y/_*100);f&&(f.innerHTML='<div class="row" style="gap:16px; flex-wrap:wrap"><div class="row" style="gap:8px; align-items:center"><span style="display:inline-block;width:12px;height:12px;background:#4F8EF7;border-radius:3px"></span><span><b>Provv. GI</b> '+k(y)+" · "+j+'%</span></div><div class="row" style="gap:8px; align-items:center"><span style="display:inline-block;width:12px;height:12px;background:#F79F4F;border-radius:3px"></span><span><b>Provv. VSD</b> '+k(Y)+" · "+e+"%</span></div></div>")}function L(){var h=ue("comm"),b=a("comm_mode").value||"consuntivo",p=n?a("comm_user").value||"__all":String(me().id),i=new Date(h.start).getTime(),f=new Date(h.end).getTime();ne("/api/periods").then(function(s){var F=s&&s.periods||[],r=F.filter(function(P){var y=new Date(P.startDate).getTime(),Y=new Date(P.endDate).getTime();return!(y<i||Y>f||n&&p!=="__all"&&String(P.userId||P.uid||"")!==String(p)||!n&&String(P.userId||P.uid||"")!==String(me().id))}),c={gi:0,vsd:0,provv_gi:0,provv_vsd:0,provv_total:0},o={};r.forEach(function(P){var y=b==="previsionale"?P.indicatorsPrev||{}:P.indicatorsCons||{},Y=String(P.userId||P.uid||""),_=P.userName||P.name||"User "+Y,A=l(y.GI),G=l(y.VSDPersonale),W=l(y.ProvvGI),j=l(y.ProvvVSD),e=U(y);c.gi+=A,c.vsd+=G,c.provv_gi+=W,c.provv_vsd+=j,c.provv_total+=e,o[Y]||(o[Y]={userId:Y,name:_,gi:0,vsd:0,provv_gi:0,provv_vsd:0,provv_total:0}),o[Y].gi+=A,o[Y].vsd+=G,o[Y].provv_gi+=W,o[Y].provv_vsd+=j,o[Y].provv_total+=e}),a("comm_total").innerHTML=B(c),a("comm_rows").innerHTML=x(Object.values(o).sort(function(P,y){return(y.provv_total||0)-(P.provv_total||0)})),te(c.provv_gi||0,c.provv_vsd||0,c.gi||0)}).catch(function(s){logger.error(s),K("Errore nel caricamento dati")})}function R(){n&&ne("/api/usernames").then(function(h){var b=a("comm_user");if(b){for(var p='<option value="__all">Tutta la squadra</option>',i=h&&h.users||[],f=0;f<i.length;f++){var s=i[f];p+='<option value="'+s.id+'">'+ve(s.name||"User "+s.id)+"</option>"}b.innerHTML=p}})}le("comm",function(){L()}),a("comm_mode").onchange=function(){haptic("light"),L()},n&&(a("comm_user").onchange=function(){haptic("light"),L()}),R(),L()}function vt(){if(!me())return t();document.title="Battle Plan – GI & Scadenzario",d.innerHTML=Se()+'\n  <div class="wrap">\n\n    <div class="card">\n      <b>Filtro</b>\n      <div class="row" style="margin-top:6px;align-items:flex-end;gap:16px;flex-wrap:wrap">\n        <div>\n          <label>Consulente</label>\n          <select id="gi_cons"><option value="">Tutti</option></select>\n        </div>\n      </div>\n      '.concat(z("gi"),'\n    </div>\n\n    <div class="card">\n      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">\n        <b>Vendite (GI)</b>\n        <button class="ghost" id="gi_add">Nuova vendita</button>\n      </div>\n      <div class="table" style="overflow:auto">\n        <table class="simple" style="min-width:980px">\n          <thead>\n            <tr>\n              <th>Data vendita</th>\n              <th>Cliente</th>\n              <th>Consulente</th>\n              <th>Servizi</th>\n              <th style="text-align:right">Tot. VSS</th>\n              <th>Piano pagamenti</th>\n              <th></th>\n            </tr>\n          </thead>\n          <tbody id="gi_rows"></tbody>\n        </table>\n      </div>\n    </div>\n\n  </div>'),ye();const n=p=>document.getElementById(p),a=p=>String(p||"").replace(/[&<>'"]/g,i=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[i]),k=p=>(Number(p)||0).toLocaleString("it-IT")+"€",l=p=>{const i=new Date(p);return i.getFullYear()+"-"+("0"+(i.getMonth()+1)).slice(-2)+"-"+("0"+i.getDate()).slice(-2)};function U(){const p=window.readUnifiedRange&&window.readUnifiedRange("gi")||{};if(!p||!p.start||!p.end){const i=new Date,f=new Date(i.getFullYear(),0,1),s=new Date(i.getFullYear(),11,31,23,59,59);return{from:l(f),to:l(s)}}return{from:l(p.start),to:l(p.end)}}let w=[];function B(){return ne("/api/clients").then(p=>(w=p&&p.clients||[],ne("/api/usernames"))).then(p=>{const i=p&&p.users||[],f=n("gi_cons");f&&(f.innerHTML='<option value="">Tutti</option>'+i.map(s=>'<option value="'+a(String(s.id))+'">'+a(s.name)+"</option>").join(""))})}function x(p){const i=Array.isArray(p.schedule)?p.schedule.slice():[];if(!i.length)return'<span class="muted">—</span>';const f=i.find(o=>o.kind==="deposit"||/acconto/i.test(o.note||"")),s=i.filter(o=>o!==f),F=f?"Acconto: "+k(f.amount):"";if(!s.length)return F||'<span class="muted">—</span>';const r=Math.round(s[0].amount||0),c=s.every(o=>Math.abs(Math.round(o.amount||0)-r)<=1);return(F?F+" + ":"")+(c?s.length+" rate da "+k(r):"piano personalizzato")}function te(p){return'<tr data-id="'+a(String(p.id))+'"><td>'+new Date(p.date||p.createdAt).toLocaleDateString("it-IT")+"</td><td>"+a(p.clientName||"")+"</td><td>"+a(p.consultantName||"")+"</td><td>"+a(p.services||"")+'</td><td style="text-align:right"><b>'+k(p.vssTotal||0)+"</b></td><td>"+x(p)+'</td><td class="right"><button class="ghost" data-edit="'+a(String(p.id))+'">Modifica</button></td></tr>'}function L(){const p=U(),i=(n("gi_cons")||{}).value||"",f="?from="+encodeURIComponent(p.from)+"&to="+encodeURIComponent(p.to)+(i?"&userId="+encodeURIComponent(i):"");ne("/api/gi"+f).then(s=>{let F=s&&s.sales||[];F.sort((r,c)=>+new Date(c.date||c.createdAt||0)-+new Date(r.date||r.createdAt||0)),n("gi_rows").innerHTML=F.length?F.map(te).join(""):'<tr><td colspan="7" class="muted">Nessuna vendita</td></tr>',h()}).catch(s=>{logger.error(s),K("Errore caricamento GI")})}function R(p){const i=p.sale||{},f=Array.isArray(i.schedule)?i.schedule.slice():[],s=f.find(E=>E.kind==="deposit"||/acconto/i.test(E.note||"")),F=f.filter(E=>E!==s),r=F.length>0?F.every(E=>Math.abs((+E.amount||0)-(+F[0].amount||0))<=1):!0,c=F.length&&r?"rate":"manual",o=l(new Date),P='<div class="modal"><div class="card gi-modal"><style>.gi-modal{min-width:min(760px,96vw);max-width:980px;max-height:86vh;overflow:auto}@media (max-width:740px){ .gi-grid{display:block} .gi-col{width:100%} .gi-modal{min-width:96vw} }.gi-grid{display:flex; gap:12px; flex-wrap:wrap} .gi-col{flex:1; min-width:240px}.gi-section{border-top:1px solid var(--hair, rgba(0,0,0,.12)); padding-top:10px; margin-top:10px}.pilltabs{display:flex; gap:12px; align-items:center} .pilltabs label{display:flex; align-items:center; gap:6px; cursor:pointer}.mrow{display:flex; gap:8px; align-items:center; flex-wrap:wrap}.mini input[type=number]{width:120px}.gi-rlist{margin-top:6px; max-height:200px; overflow:auto; border:1px dashed rgba(0,0,0,.15); border-radius:8px; padding:6px}.gi-r{display:flex; gap:6px; align-items:center; padding:4px 0}.gi-foot{display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:12px}</style><div style="display:flex;justify-content:space-between;align-items:center"><b>'+(p.title||(i.id?"Modifica vendita":"Nuova vendita"))+'</b><button class="ghost" id="m_close">Chiudi</button></div><div class="gi-grid"><div class="gi-col"><label>Data</label><input id="m_date" type="date" value="'+a(l(i.date||o))+'"></div><div class="gi-col"><label>Cliente</label><select id="gi_client_select"><option value="">Caricamento…</option></select></div><div class="gi-col"><label>Totale VSS</label><input id="m_vss" type="number" step="1" value="'+a(Number(i.vssTotal||0))+'"></div></div><div class="gi-section"><label>Servizi</label><textarea id="m_srv" rows="2">'+a(i.services||"")+'</textarea></div><div class="gi-section"><b>Acconto</b><div class="mrow mini" style="margin-top:6px"><label><input id="acc_enable" type="checkbox" '+(s?"checked":"")+'> Abilita</label><label>Tipo</label><select id="acc_type"><option value="abs">Valore assoluto</option><option value="perc">Percentuale</option></select><label>Valore</label><input id="acc_value" type="number" step="1" value="'+(s?a(Number(s._fromPerc?s._rawPerc:s.amount)):"0")+'"><label>Scadenza</label><input id="acc_date" type="date" value="'+a(l(s?s.dueDate:i.date||o))+'"><label>Nota</label><input id="acc_note" placeholder="es. Acconto" value="'+a(s&&s.note||"Acconto")+'"></div></div><div class="gi-section"><b>Modalità pagamenti</b><div class="pilltabs" style="margin:6px 0 8px"><label><input type="radio" name="pmode" value="rate" '+(c==="rate"?"checked":"")+'> Rateale</label><label><input type="radio" name="pmode" value="manual" '+(c!=="rate"?"checked":"")+'> Scaglioni manuali</label></div><div id="p_rate" style="display:'+(c==="rate"?"block":"none")+'"><div class="mrow mini"><label>N° rate</label><input id="rt_n" type="number" value="'+a(F.length||12)+'"><label>Frequenza</label><select id="rt_freq"><option value="M">Mensile</option><option value="Q">Trimestrale</option><option value="W">Settimanale</option><option value="Y">Annuale</option></select><label>Prima scadenza</label><input id="rt_first" type="date" value="'+a(F[0]?l(F[0].dueDate):l(i.date||o))+'"><button class="ghost" id="rt_build">Ricalcola rate</button></div><div id="rt_preview" class="gi-rlist muted small">—</div></div><div id="p_manual" style="display:'+(c!=="rate"?"block":"none")+'"><div class="mrow mini"><button class="ghost" id="mn_add">Aggiungi scaglione</button></div><div id="mn_list" class="gi-rlist"></div></div></div><div class="gi-foot"><div><div id="tot_prog" class="small muted">Programmato: 0€</div><div id="tot_chk"  class="small muted">Totale VSS: 0€</div></div><div style="display:flex;gap:8px">'+(i.id?'<button class="ghost danger" id="m_del">Elimina</button>':"")+'<button id="m_save">Salva</button></div></div></div></div>';showOverlay(P);const y=document.documentElement.style.overflow;document.documentElement.style.overflow="hidden";function Y(){document.documentElement.style.overflow=y,hideOverlay()}(function(){const O=n("gi_client_select");O.innerHTML='<option value="">— seleziona cliente —</option>'+w.map(Z=>'<option value="'+a(Z.id)+'">'+a(Z.name)+"</option>").join("");const H=i.clientId||i.client_id||"";if(H&&(O.value=String(H)),!O.value&&i.clientName){const Z=w.find(oe=>String(oe.name).trim().toLowerCase()===String(i.clientName).trim().toLowerCase());Z&&(O.value=String(Z.id))}})(),s&&s._fromPerc&&(n("acc_type").value="perc"),Array.from(document.querySelectorAll('input[name="pmode"]')).forEach(E=>{E.addEventListener("change",()=>{const O=document.querySelector('input[name="pmode"]:checked').value==="rate";n("p_rate").style.display=O?"block":"none",n("p_manual").style.display=O?"none":"block",C()})});function _(E,O){const H=new Date(E);return H.setMonth(H.getMonth()+O),H}function A(E,O){const H=new Date(E);return H.setDate(H.getDate()+O*7),H}function G(E,O){const H=new Date(E);return H.setMonth(H.getMonth()+O*3),H}function W(E,O){const H=new Date(E);return H.setFullYear(H.getFullYear()+O),H}function j(){const E=Math.max(1,Number(n("rt_n").value||0)),O=n("rt_freq").value,H=new Date(n("rt_first").value||o),Z=Math.max(0,Number(n("m_vss").value||0)),oe=D(),ie=Math.max(0,Z-oe),u=Math.round(ie/E),N=[];for(let q=0;q<E;q++){let I;O==="M"?I=_(H,q):O==="Q"?I=G(H,q):O==="W"?I=A(H,q):I=W(H,q),N.push({dueDate:I.toISOString(),amount:u,note:"Rata "+(q+1)+"/"+E,kind:"installment"})}return e(N),N}function e(E){n("rt_preview").innerHTML=E.map(O=>"<div>"+new Date(O.dueDate).toLocaleDateString("it-IT")+" · "+k(O.amount)+' <span class="muted">'+a(O.note||"")+"</span></div>").join(""),n("rt_preview")._data=E,C()}function v(E){const O=n("mn_list");O.innerHTML="",E.forEach((H,Z)=>{const oe=document.createElement("div");oe.className="gi-r",oe.innerHTML='<input type="date" data-k="dueDate" value="'+a(l(H.dueDate))+'"><input type="number" step="1" data-k="amount" value="'+a(Number(H.amount||0))+'" style="width:120px"><input type="text" data-k="note"   value="'+a(H.note||"")+'" placeholder="nota" style="flex:1"><button class="ghost" data-del="'+Z+'">✕</button>',O.appendChild(oe)}),O.querySelectorAll("[data-del]").forEach(H=>{H.onclick=()=>{const Z=Number(H.getAttribute("data-del")),oe=O._data||[];oe.splice(Z,1),v(oe)}}),O.oninput=()=>{const H=O._data||[];Array.from(O.children).forEach((oe,ie)=>{const u=H[ie];if(!u)return;const N=oe.querySelector('[data-k="dueDate"]').value,q=Number(oe.querySelector('[data-k="amount"]').value||0),I=oe.querySelector('[data-k="note"]').value;u.dueDate=new Date(N).toISOString(),u.amount=Math.round(q),u.note=I}),C()},O._data=E,C()}if(n("m_date").value=a(l(i.date||o)),n("m_vss").value=a(Number(i.vssTotal||0)),n("m_srv").value=a(i.services||""),n("acc_type").value=s&&s._fromPerc?"perc":"abs",n("acc_value").value=s?s._fromPerc?s._rawPerc:s.amount:0,n("acc_date").value=a(l(s?s.dueDate:i.date||o)),n("acc_note").value=s?a(s.note||"Acconto"):"Acconto",c==="rate"){const E=F.length||12;n("rt_n").value=E,n("rt_first").value=F[0]?a(l(F[0].dueDate)):a(l(i.date||o)),e(F.length?F:j())}else v(F);n("rt_build").onclick=()=>e(j()),n("mn_add").onclick=()=>{const O=n("mn_list")._data||[];O.push({dueDate:new Date().toISOString(),amount:0,note:"",kind:"manual"}),v(O)},n("m_close").onclick=Y;function D(){if(!n("acc_enable").checked)return 0;const E=Math.max(0,Number(n("m_vss").value||0)),O=n("acc_type").value,H=Number(n("acc_value").value||0);return Math.round(O==="perc"?E*(H/100):H)}function V(){const E=[];if(n("acc_enable").checked){const H=D();E.push({dueDate:new Date(n("acc_date").value||o).toISOString(),amount:H,note:n("acc_note").value||"Acconto",kind:"deposit",_fromPerc:n("acc_type").value==="perc",_rawPerc:Number(n("acc_value").value||0)})}if(document.querySelector('input[name="pmode"]:checked').value==="rate"){const H=(n("rt_preview")._data||[]).map(Z=>Object.assign({},Z));return E.concat(H)}else{const H=(n("mn_list")._data||[]).map(Z=>Object.assign({kind:"manual"},Z));return E.concat(H)}}function C(){const E=Math.max(0,Number(n("m_vss").value||0)),O=V(),H=Math.round(O.reduce((Z,oe)=>Z+Number(oe.amount||0),0));n("tot_prog").textContent="Programmato: "+k(H),n("tot_chk").textContent="Totale VSS: "+k(E)+(H===E?" OK":" (manca "+k(E-H)+")"),n("m_save").disabled=H!==E||!n("gi_client_select").value}if(["m_vss","acc_enable","acc_type","acc_value","acc_date","rt_n","rt_freq","rt_first"].forEach(E=>{const O=n(E);O&&O.addEventListener("input",C)}),n("gi_client_select").addEventListener("change",C),C(),n("m_save").onclick=()=>{const E=n("gi_client_select").value||"",O=w.find(Z=>String(Z.id)===String(E));if(!O){K("Seleziona un cliente");return}const H={id:i.id||void 0,date:new Date(n("m_date").value||o).toISOString(),clientId:O.id,clientName:O.name,vssTotal:Math.round(Number(n("m_vss").value||0)),services:n("m_srv").value||"",schedule:V()};Promise.resolve(Ie("/api/gi",H)).then(()=>{Y(),haptic("light"),L()}).catch(Z=>{logger.error(Z),K("Errore salvataggio")})},i.id){const E=n("m_del");E&&(E.onclick=async()=>{if(confirm("Eliminare definitivamente questa vendita?"))try{await Ie("/api/gi/delete",{id:i.id}).catch(()=>Ie("/api/gi",{id:i.id,_delete:1})),Y(),K("Vendita eliminata"),L()}catch(O){logger.error(O),K("Errore eliminazione")}})}}function h(){document.querySelectorAll("[data-edit]").forEach(p=>{p.addEventListener("click",()=>{const i=p.getAttribute("data-edit");b(i)})})}document.addEventListener("gi:edit",function(p){const i=p&&p.detail&&p.detail.id;i&&b(i)}),n("gi_add").onclick=()=>{R({title:"Nuova vendita"})};function b(p){ne("/api/gi?from=1900-01-01&to=2999-12-31").then(i=>{const f=(i&&i.sales||[]).find(s=>String(s.id)===String(p));if(!f){K("Vendita non trovata");return}R({title:"Modifica vendita",sale:f})})}le("gi",()=>{haptic("light"),L()}),(n("gi_cons")||{}).onchange=()=>{haptic("light"),L()},B().then(L)}window.viewGI=window.viewGI||vt;function mt(){if(!me())return t();document.title="Battle Plan – Report",d.innerHTML=Se()+'<div class="wrap"><div class="card"><b>Sezioni da includere</b><div id="rep_toggles" class="row" style="margin-top:8px; gap:8px; flex-wrap:wrap"><button class="pill" data-type="mensile" id="tog_mese">Mese</button><button class="pill" data-type="trimestrale" id="tog_trimestre">Trimestre</button><button class="pill" data-type="semestrale" id="tog_semestre">Semestre</button><button class="pill" data-type="annuale" id="tog_anno">Anno</button></div></div><div class="card"><b>Report</b><div class="row" style="margin-top:8px"><div style="min-width:320px"><label>Oggetto email</label><input id="report_subject" placeholder="Report BP"></div></div><div class="row" style="margin-top:8px; flex-wrap:wrap"><div style="flex:1 1 100%; min-width:0"><label>Corpo email</label><textarea id="report_body" rows="12" placeholder="Testo del report…" style="width:100%; box-sizing:border-box; overflow:auto; resize:vertical; max-height:70vh; white-space:pre-wrap; word-break:break-word"></textarea></div></div><div class="row" id="report-actions" style="gap:8px;margin-top:8px;flex-wrap:wrap"><button class="ghost" id="rep_copy">Copia report</button><span style="flex:0 0 8px"></span><button class="ghost" id="rep_gmail_web">Gmail Web</button><button class="ghost" id="rep_gmail_app">Gmail App</button></div></div></div>',ye();var n=[],a={mensile:!1,trimestrale:!1,semestrale:!1,annuale:!1},k=[{k:"VSS",money:!0,label:"VSS"},{k:"VSDPersonale",money:!0,label:"VSDPersonale"},{k:"VSDIndiretto",money:!0,label:"VSDIndiretto"},{k:"GI",money:!0,label:"GI"},{k:"Telefonate",money:!1,label:"Telefonate"},{k:"AppFissati",money:!1,label:"AppFissati"},{k:"AppFatti",money:!1,label:"AppFatti"},{k:"CorsiLeadership",money:!1,label:"CorsiLeadership"},{k:"iProfile",money:!1,label:"iProfile"},{k:"MBS",money:!1,label:"MBS"},{k:"NNCF",money:!1,label:"NNCF"}];function l(u){return document.getElementById(u)}var U=l("report_body");function w(u,N){var q=new Date(u.getTime());return q.setDate(q.getDate()+N),q}function B(u){return ke(u.getFullYear(),be(u))}function x(u){var N=B(u);return B(w(N.start,7))}function te(u){var N=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];return N[u.getMonth()]}function L(u){return Math.floor(u.getMonth()/3)+1}function R(u){return u.getMonth()<6?1:2}function h(u){var N=u.getDay();return N===5||N===6||N===0}function b(u,N){return u==="mensile"?{start:Je(N),end:Ke(N)}:u==="trimestrale"?{start:ze(N),end:Ze(N)}:u==="semestrale"?{start:je(N),end:Qe(N)}:{start:tt(N),end:qe(N)}}function p(u,N){return N>=w(u,-7)&&N<=w(u,5)}function i(u,N){var q=b(u,N),I=b(u,w(q.start,-1)),X=b(u,w(q.end,1)),ee=p(I.end,N),ae=p(q.end,N);return ee&&!ae?{closing:I,next:q}:{closing:q,next:X}}function f(u,N,q){for(var I=0;I<n.length;I++){var X=n[I];if(X.type===u&&Ce(X.startDate)===Ce(N)&&Ce(X.endDate)===Ce(q))return X}return null}function s(u,N){var q=u&&u[N];return Number(q||0)}function F(u){return Me(u)+"€"}function r(u,N){var q=k.some(function(I){return I.k===u&&I.money});return q?F(N):Me(N)}function c(u,N){return u>N?"↑":u<N?"↓":"="}function o(u,N,q,I){var X=f(N,q,I)||{},ee=X.indicatorsPrev||{},ae=X.indicatorsCons||{},ce=[u,""];return k.forEach(function(se){var De=s(ee,se.k),we=s(ae,se.k);ce.push(se.label+" "+r(se.k,we)+" vs "+r(se.k,De)+" di previsionali ("+c(we,De)+")")}),ce.push("Note:"),ce.join("\n")}function P(u,N,q,I){var X=f(N,q,I)||{},ee=X.indicatorsPrev||{},ae=[u,""];return k.forEach(function(ce){ae.push(ce.label+" "+r(ce.k,s(ee,ce.k)))}),ae.push("Possibili note:"),ae.join("\n")}function y(u){return"BP CONSUNTIVO SETT. "+be(u)+" "+u.getFullYear()}function Y(u){return"BP PREVISIONALE SETT. "+be(u)+" "+u.getFullYear()}function _(u){return"BP CONSUNTIVO "+te(u)+" "+u.getFullYear()}function A(u){var N=te(u);return"BP PREVISIONALE "+N+" "+u.getFullYear()}function G(u){return"BP CONSUNTIVO T"+L(u)+" "+u.getFullYear()}function W(u){return"BP PREVISIONALE T"+L(u)+" "+u.getFullYear()}function j(u){return"BP CONSUNTIVO S"+R(u)+" "+u.getFullYear()}function e(u){return"BP PREVISIONALE S"+R(u)+" "+u.getFullYear()}function v(u){return"BP CONSUNTIVO "+u.getFullYear()}function D(u){return"BP PREVISIONALE "+u.getFullYear()}function V(){var u=new Date,N=[];if(h(u)){var q=B(u),I=x(u);N.push(o(y(q.start),"settimanale",q.start,q.end)),N.push(P(Y(I.start),"settimanale",I.start,I.end))}function X(ee,ae,ce){var se=i(ee,u);N.push(o(ae(se.closing.start),ee,se.closing.start,se.closing.end)),N.push(P(ce(se.next.start),ee,se.next.start,se.next.end))}a.mensile&&X("mensile",_,A),a.trimestrale&&X("trimestrale",G,W),a.semestrale&&X("semestrale",j,e),a.annuale&&X("annuale",v,D),U.value=N.join("\n\n")+(N.length?"\n":"")}function C(u,N){u.classList.toggle("active",!!N),u.style.opacity=N?"1":"0.65"}function E(){C(l("tog_mese"),a.mensile),C(l("tog_trimestre"),a.trimestrale),C(l("tog_semestre"),a.semestrale),C(l("tog_anno"),a.annuale)}function O(){var u=new Date;function N(q){var I=b(q,u),X=b(q,w(I.start,-1));return p(I.end,u)||p(X.end,u)}a.mensile=N("mensile"),a.trimestrale=N("trimestrale"),a.semestrale=N("semestrale"),a.annuale=N("annuale"),E()}function H(){function u(N){var q=N.currentTarget.getAttribute("data-type");a[q]=!a[q],E(),V()}l("tog_mese").onclick=u,l("tog_trimestre").onclick=u,l("tog_semestre").onclick=u,l("tog_anno").onclick=u}function Z(u){return encodeURIComponent(String(u||""))}function oe(){var u=l("rep_gmail_web"),N=l("rep_gmail_app"),q=l("rep_copy");q&&(q.onclick=function(){try{navigator.clipboard.writeText(U.value||"");var I=q.textContent;q.textContent="Copiato!",setTimeout(function(){q.textContent=I},1200)}catch(X){}}),!(!u||!N)&&ne("/api/users_emails").then(function(I){var X=(I&&I.emails||(I&&I.users||[]).map(function(ce){return ce.email})).filter(Boolean).join(",");function ee(){return l("report_subject").value||"Report BP"}function ae(){return U.value||""}u.onclick=function(){try{navigator.clipboard.writeText(ae())}catch(se){}var ce="https://mail.google.com/mail/?view=cm&fs=1&tf=1&su="+Z(ee())+"&cc="+Z(X)+"&body="+Z(ae());window.open(ce,"_blank"),document.dispatchEvent(new Event("report:composed"))},N.onclick=function(){try{navigator.clipboard.writeText(ae())}catch(se){}var ce="googlegmail:///co?subject="+Z(ee())+"&cc="+Z(X)+"&body="+Z(ae());location.href=ce,document.dispatchEvent(new Event("report:composed")),setTimeout(function(){document.hidden||(location.href="mailto:?subject="+Z(ee())+"&cc="+Z(X)+"&body="+Z(ae()),document.dispatchEvent(new Event("report:composed")))},1200)}})}function ie(){ne("/api/periods").then(function(u){n=u&&u.periods||[],O(),H(),V(),oe()})}ie()}function pt(){var n=me();if(!n)return t();if(document.title="Battle Plan – Utenti",n.role!=="admin"){d.innerHTML=Se()+'<div class="wrap"><div class="card"><b>Il mio profilo</b><div class="row" style="margin-top:8px"><div><label>Nome</label><input id="p_name" type="text" value="'+ve(n.name||"")+'"></div><div><label>Email</label><input id="p_email" type="email" value="'+ve(n.email||"")+'"></div></div><div class="row"><div><label>Nuova password</label><input id="p_pwd" type="password" placeholder="Lascia vuoto per non cambiare"></div><div class="right" style="align-self:flex-end"><button id="p_save">Aggiorna</button></div></div><div class="row"><div><label>Ruolo</label><input value="'+ve(n.role||"consultant")+'" disabled></div><div><label>Grade</label><input value="'+ve(n.grade||"junior")+'" disabled></div></div></div></div>',ye(),Ee("#p_save").onclick=function(){var l=Ee("#p_name").value.trim(),U=Ee("#p_email").value.trim(),w=Ee("#p_pwd").value,B={id:n.id,name:l,email:U};w&&(B.password=w),Ie("/api/users",B).then(function(){K("Profilo aggiornato"),addXP(3);var x=me();x&&(x.name=l,x.email=U,localStorage.setItem("user",JSON.stringify(x)))}).catch(function(x){logger.error(x),K("Errore aggiornamento")})};return}d.innerHTML=Se()+'<div class="wrap"><div class="card"><b>Gestione utenti</b><div id="users_list" class="row" style="margin-top:8px"></div></div></div>',ye();function a(l){var U=ve(l.name||l.email||"user_"+l.id),w=l.grade==="senior"?"senior":"junior",B=l.role==="admin"?"admin":"consultant";return'<div class="card" style="flex:1 1 380px"><div><b>'+U+'</b> <span class="small muted">('+ve(B)+')</span></div><div class="row" style="margin-top:6px"><div><label>Nome</label><input data-nfor="'+l.id+'" type="text" value="'+ve(l.name||"")+'"></div><div><label>Email</label><input data-efor="'+l.id+'" type="email" value="'+ve(l.email||"")+'"></div></div><div class="row"><div><label>Nuova password</label><input data-pfor="'+l.id+'" type="password" placeholder="(opzionale)"></div><div><label>Grade</label><select data-gfor="'+l.id+'"><option value="junior"'+(w==="junior"?" selected":"")+'>Junior</option><option value="senior"'+(w==="senior"?" selected":"")+'>Senior</option></select></div><div><label>Ruolo</label><select data-rfor="'+l.id+'"><option value="consultant"'+(B==="consultant"?" selected":"")+'>Consulente</option><option value="admin"'+(B==="admin"?" selected":"")+'>Admin</option></select></div><div class="right" style="align-self:flex-end"><button class="ghost" data-save="'+l.id+'">Aggiorna</button></div></div></div>'}function k(){ne("/api/users").then(function(l){var U=l&&l.users||[],w=Ee("#users_list");w&&(w.innerHTML=U.map(a).join(""),ot("[data-save]").forEach(function(B){B.addEventListener("click",function(){var x=B.getAttribute("data-save"),te=(Ee('input[data-nfor="'+x+'"]')||{}).value||"",L=(Ee('input[data-efor="'+x+'"]')||{}).value||"",R=(Ee('select[data-gfor="'+x+'"]')||{}).value||"junior",h=(Ee('select[data-rfor="'+x+'"]')||{}).value||"consultant",b=Ee('input[data-pfor="'+x+'"]'),p=b?b.value:"",i={id:x,name:te,email:L,grade:R,role:h};p&&(i.password=p),Ie("/api/users",i).then(function(){K("Aggiornato"),addXP(5),b&&(b.value="")}).catch(function(f){logger.error(f),K("Errore aggiornamento")})})}))})}k()}window.viewHome=$e,window.viewCalendar=lt,window.viewPeriods=nt,window.viewAppointments=Fe,window.viewLeaderboard=st,window.viewClients=dt,window.viewTeam=ct,window.viewCommissions=ut,window.viewReport=mt,window.viewUsers=pt,window.toggleDrawer=We,window.logout=Nt,window.rerenderTopbarSoon=$t,document.addEventListener("DOMContentLoaded",function(){me()?(ye(),$e()):t()})})();export{Xt as __vite_legacy_guard};
