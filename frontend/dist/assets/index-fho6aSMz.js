function nn(){import.meta.url,import("_").catch(()=>1),(async function*(){})().next()}(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const H of document.querySelectorAll('link[rel="modulepreload"]'))Z(H);new MutationObserver(H=>{for(const Y of H)if(Y.type==="childList")for(const ee of Y.addedNodes)ee.tagName==="LINK"&&ee.rel==="modulepreload"&&Z(ee)}).observe(document,{childList:!0,subtree:!0});function D(H){const Y={};return H.integrity&&(Y.integrity=H.integrity),H.referrerPolicy&&(Y.referrerPolicy=H.referrerPolicy),H.crossOrigin==="use-credentials"?Y.credentials="include":H.crossOrigin==="anonymous"?Y.credentials="omit":Y.credentials="same-origin",Y}function Z(H){if(H.ep)return;H.ep=!0;const Y=D(H);fetch(H.href,Y)}})();function Ft(m){return m?(m=String(m).toLowerCase(),m==="ytd"||m==="ltm"?"mensile":m):""}function Ot(m){var s=new Date(Date.UTC(m.getFullYear(),m.getMonth(),m.getDate())),D=s.getUTCDay()||7;s.setUTCDate(s.getUTCDate()+4-D);var Z=new Date(Date.UTC(s.getUTCFullYear(),0,1));return Math.ceil(((s-Z)/864e5+1)/7)}typeof window<"u"&&(typeof window.effectivePeriodType!="function"&&(window.effectivePeriodType=Ft),typeof window.isoWeekNum!="function"&&(window.isoWeekNum=Ot));(function(){const m=window.fetch.bind(window);function s(){try{const Z=JSON.parse(localStorage.getItem("user")||"{}");if(Z&&(Z.token||Z.jwt||Z.accessToken))return Z.token||Z.jwt||Z.accessToken}catch(Z){}const D=["token","authToken","jwt","bp_token","accessToken","id_token"];for(const Z of D){let H=localStorage.getItem(Z)||sessionStorage.getItem(Z);if(H){try{const Y=JSON.parse(H);if(Y&&(Y.token||Y.jwt||Y.accessToken))return Y.token||Y.jwt||Y.accessToken}catch(Y){}if(H=String(H).replace(/^"+|"+$/g,""),/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+$/.test(H))return H}}return null}window.fetch=function(D,Z){const H=typeof D=="string"?D:D&&D.url||"";if(!(typeof H=="string"&&(H.startsWith("/api/")||H.startsWith(location.origin+"/api/"))))return m(D,Z);const ee=s(),te=Object.assign({},Z);return te.headers=new Headers(te&&te.headers||{}),ee&&!te.headers.has("Authorization")&&te.headers.set("Authorization","Bearer "+ee),m(D,te)}})();(function(){function m(){const H=te=>String(te).replace(/^"+|"+$/g,""),Y=te=>/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+$/.test(te||""),ee=["token","authToken","jwt","bp_token","accessToken","id_token"];for(const te of ee){let O=localStorage.getItem(te)||sessionStorage.getItem(te);if(O){try{const re=JSON.parse(O);if(re&&(re.token||re.jwt||re.accessToken))return re.token||re.jwt||re.accessToken}catch(re){}if(O=H(O),Y(O))return O}}try{const te=JSON.parse(localStorage.getItem("user")||"{}");if(te&&(te.token||te.jwt||te.accessToken))return te.token||te.jwt||te.accessToken}catch(te){}return null}typeof window.users>"u"&&(window.users=[]),(async function H(){try{if(window.GET){const te=await window.GET("/api/usernames");te&&Array.isArray(te.users)&&(window.users=te.users);return}const Y=m(),ee=await fetch("/api/usernames",{headers:{Accept:"application/json",...Y?{Authorization:"Bearer "+Y}:{}}});if(ee.status===401){setTimeout(H,800);return}if(ee.ok){const te=await ee.json();te&&Array.isArray(te.users)&&(window.users=te.users)}}catch(Y){setTimeout(H,1200)}})();function s(H,Y,ee){return new Date(Date.UTC(H,Y,ee))}function D(H){return new Date(H.getTime()+24*3600*1e3-1)}function Z(H,Y){return new Date(Date.UTC(H,Y+1,0))}typeof window.buildBuckets!="function"&&(window.buildBuckets=function(H,Y){var ee=String(H||"mensile").toLowerCase(),te=effectivePeriodType(ee),O=Y?new Date(Y):new Date,re=O.getUTCFullYear(),ie=[];function ye(g,P){ie.push({s:g.getTime(),e:P.getTime()})}if(te==="settimanale"){var we=new Date(Date.UTC(O.getUTCFullYear(),O.getUTCMonth(),O.getUTCDate())),le=(we.getUTCDay()+6)%7;we.setUTCDate(we.getUTCDate()-le);for(var se=52;se>=0;se--){var ve=new Date(we);ve.setUTCDate(we.getUTCDate()-se*7);var ce=new Date(ve);ce.setUTCDate(ve.getUTCDate()+6),ce.setUTCHours(23,59,59,999),ye(ve,ce)}return ie}if(te==="mensile"){for(var xe=new Date(Date.UTC(O.getUTCFullYear(),O.getUTCMonth(),1)),ge=23;ge>=0;ge--){var _e=new Date(Date.UTC(xe.getUTCFullYear(),xe.getUTCMonth()-ge,1));ye(_e,D(Z(_e.getUTCFullYear(),_e.getUTCMonth())))}return ie}if(te==="trimestrale"){for(var Ve=Math.floor(O.getUTCMonth()/3),f=11;f>=0;f--){var y=Ve-f,z=re+Math.floor(y/4),b=(y%4+4)%4,ve=s(z,b*3,1),ce=D(new Date(Date.UTC(z,b*3+3,0)));ye(ve,ce)}return ie}if(te==="semestrale"){for(var U=O.getUTCMonth()<6?0:1,A=5;A>=0;A--){var x=U-A,L=re+Math.floor(x/2),C=(x%2+2)%2,_=C===0?0:6,B=s(L,_,1),G=D(new Date(Date.UTC(L,_+6,0)));ye(B,G)}return ie}for(var I=2;I>=0;I--){var w=re-I;ye(s(w,0,1),D(new Date(Date.UTC(w,12,0))))}return ie}),typeof window.labelsForBuckets!="function"&&(window.labelsForBuckets=function(H,Y){var ee=effectivePeriodType(H||"mensile");return(Y||[]).map(function(te){var O=new Date(te.s);return ee==="settimanale"?"W"+isoWeekNum(O):ee==="mensile"?String(O.getUTCMonth()+1).padStart(2,"0")+"/"+O.getUTCFullYear():ee==="trimestrale"?"Q"+(Math.floor(O.getUTCMonth()/3)+1)+" "+O.getUTCFullYear():ee==="semestrale"?(O.getUTCMonth()<6?"S1 ":"S2 ")+O.getUTCFullYear():String(O.getUTCFullYear())})}),typeof window.sumIndicator!="function"&&(window.sumIndicator=function(H,Y,ee){var re,ie;var te=String(Y).toLowerCase()==="previsionale"?H.indicatorsPrev||{}:H.indicatorsCons||{};if(ee==="VSDTotale")return Number(te.VSDPersonale||0)+Number(te.VSDIndiretto||0);var O=Number((ie=(re=te[ee])!=null?re:te[ee.toUpperCase()])!=null?ie:0);return Number.isFinite(O)?O:0})})();(function(m){const s=["localhost","127.0.0.1"].includes(m.location.hostname),D=m.pino?m.pino({level:s?"debug":"info"}):console,Z={info:(...H)=>D.info?D.info(...H):console.log(...H),error:(...H)=>D.error?D.error(...H):console.error(...H),warn:(...H)=>D.warn?D.warn(...H):console.warn(...H),debug:(...H)=>D.debug?D.debug(...H):console.debug(...H)};m.logger=Z})(window);window.BP_PHRASES=(function(){const m=["Ottimo, {name}! üéØ","Ben fatto, {name}! üôå","Avanti cos√¨, {name}! üöÄ","Perfetto, {name}! ü§©","Bel colpo, {name}! üí•","Ci siamo, {name}! üëå","Grande {name}! üß±","Pezzo dopo pezzo, {name}! üß©","Molto bene, {name}! üëç","Stai andando bene, {name}! ‚û°Ô∏è"],s=["Che figata, {name}! üî•","Ma cosa dico grande‚Ä¶ grandissimo, {name}! üí™","Super, {name}! ‚ú®","Non ti ferma nessuno, {name}!! üèéÔ∏è","Stai andando alla grande, {name}! üìà","Gran progressione, {name}! ‚è©","Il ritmo √® giusto, {name}! ü•Å","Questa spinge, {name}! üß®","Bello tosto, {name}! üõ°Ô∏è","Gran focus, {name}! üéØ"],D=["BOOM! {name}, questo √® livello PRO! üèÜ","Risultato pazzesco, {name}! ü§Ø","Clamoroso {name}, cos√¨ si fa! ‚ö°","√à ufficiale: {name} ON FIRE! üî•üî•","Top di gamma, {name}! ü•á","Mostruoso upgrade, {name}! üöÄ","Record personale in vista, {name}! üß†","Spacchi tutto, {name}! üí£","Da incorniciare, {name}! üñºÔ∏è","Questo alza l‚Äôasticella, {name}! üìè"],Z={lite:m,mid:s,mega:D};return Z.standard=m,Z.rilevante=s,Z.grande=D,Z.pick=function(H,Y){const ee=Z[H]||m,te=Y||JSON.parse(localStorage.getItem("bp_user")||"{}").name||"campione";return(ee[Math.floor(Math.random()*ee.length)]||"Grande!").replace(/\{name\}/g,te)},Z.random=function(H){const Y=[m,s,D],ee=Y[Math.floor(Math.random()*Y.length)];return Z.pick(ee===D?"mega":ee===s?"rilevante":"standard",H)},Z})();(function(){const m=window.BP=window.BP||{},s=m.Haptics=m.Haptics||{};function D(){const H=navigator.userAgent||navigator.vendor||"";return/android|iphone|ipad|ipod|mobile/i.test(H)}function Z(H){if(D()&&"vibrate"in navigator)try{switch(H){case"light":navigator.vibrate(12);break;case"heavy":navigator.vibrate([10,30,10]);break;default:navigator.vibrate(18);break}}catch(Y){}}s.impact=Z})();(function(){const m=window.BP=window.BP||{},s=m.Undo=m.Undo||{},D=document.createElement("div");D.className="bp-undo-host",document.body.appendChild(D);const Z="\n  .bp-undo-host{\n    position: fixed; left:50%; transform: translateX(-50%);\n    bottom: 20px; z-index: 1201; display:flex; flex-direction:column; gap:8px;\n  }\n  .bp-undo{\n    min-width: 280px; max-width: 540px;\n    background: rgba(15,19,28,.95);\n    border:1px solid rgba(255,255,255,.18);\n    border-radius: 12px; padding: 10px 12px;\n    box-shadow: 0 10px 24px rgba(0,0,0,.35);\n    display:flex; align-items:center; gap:10px;\n    animation: bpUndoPop .16s ease-out;\n  }\n  .bp-undo .lbl{ font-weight:700; }\n  .bp-undo .spacer{ flex:1; }\n  .bp-undo button{ white-space:nowrap; }\n  @keyframes bpUndoPop{ from{ transform: translate(-50%, 4px); opacity:0 } to{ transform: translate(-50%, 0); opacity:1 } }\n  ",H=document.createElement("style");H.textContent=Z,document.head.appendChild(H);function Y(ee){const te=document.createElement("div");te.className="bp-undo",te.innerHTML='\n      <div class="lbl">'.concat(ee&&ee.label||"Operazione eseguita",'</div>\n      <div class="spacer"></div>\n      <button type="button" class="ghost" data-undo>Annulla</button>\n    '),D.appendChild(te);let O=!1;const re=setTimeout(()=>{O||(O=!0,te.remove())},ee&&ee.timeoutMs||5e3);te.querySelector("[data-undo]").addEventListener("click",()=>{if(!O){O=!0,clearTimeout(re);try{ee&&ee.onUndo&&ee.onUndo()}catch(ie){}te.remove()}})}s.push=Y})();(function(){const m=window.BP=window.BP||{},s=m.ClientsHelpers=m.ClientsHelpers||{};function D(ee){return String(ee||"").trim().toLowerCase()}function Z(ee){const te={};return(ee||[]).forEach(O=>{const re=D(O.client);if(!re)return;const ie=O.start||O.end;if(!ie)return;const ye=te[re];(!ye||new Date(ie)>new Date(ye))&&(te[re]=ie)}),te}function H(ee,te){const O=Z(te);return(ee||[]).map(re=>{const ie=O[D(re.name)]||null;return{...re,lastAppointment:ie}})}function Y(ee,{status:te,consultantId:O,consultantName:re}){const ie=le=>String(le||"").trim().toLowerCase(),ye=le=>{const se=ie(le).replace(/\s+/g,"_").replace(/-/g,"_");return se==="lead_non_chiuso"||se==="lead_non-chiuso"?"lead_non_chiuso":se};let we=ee||[];if(te&&te!=="tutti"&&(we=we.filter(le=>ye(le.status)===ye(te))),O)we=we.filter(le=>(le.consultantId||"")===String(O));else if(re){const le=ie(re);we=we.filter(se=>ie(se.consultantName)===le)}return we}s.withLastAppointment=H,s.filter=Y})();(function(){const m=window.BP=window.BP||{},s=m.Targets=m.Targets||{},D=["VSS","VSDPersonale","VSDIndiretto","GI"],Z=["NNCF","AppFatti","Telefonate"],H=D.concat(Z),Y={senior:{VSS:3e4,VSDPersonale:15e3,VSDIndiretto:5e3,GI:15e3,NNCF:1,AppFatti:4,Telefonate:0},junior:{VSS:15e3,VSDPersonale:5e3,VSDIndiretto:5e3,GI:1e4,NNCF:4,AppFatti:30,Telefonate:300}};function ee(le,se){const ve=Number(le||0),ce=Number(se||0);return ce?Math.ceil(ve/ce)*ce:Math.ceil(ve)}function te(le){switch(String(le||"mensile").toLowerCase()){case"settimanale":return 1/4;case"mensile":return 1;case"trimestrale":return 3;case"semestrale":return 6;case"annuale":return 12;default:return 1}}function O(le){return D.indexOf(le)>=0}function re(le){const se=String(le||"junior").toLowerCase()==="senior"?"senior":"junior";return{...Y[se]}}function ie(le,se){const ve=te(se),ce=re(le),xe={};for(const ge of H){const _e=Number(ce[ge]||0)*ve;O(ge)?String(se).toLowerCase()==="settimanale"?xe[ge]=ee(_e,500):xe[ge]=ee(_e,5e3):xe[ge]=Math.ceil(_e)}return xe}function ye(le,se){const ve={};for(const ce of H){const xe=Number((le||{})[ce]||0),ge=Number((se||{})[ce]||0),_e=xe-ge,Ve=ge>0?Math.round(xe/ge*100):xe>0?100:0;ve[ce]={value:xe,target:ge,delta:_e,pct:Math.max(0,Ve)}}return ve}function we(le){const se=[];for(const ce of H){const xe=(le||{})[ce];xe&&xe.target>0&&se.push(Number(xe.pct||0))}if(!se.length)return 0;const ve=se.reduce((ce,xe)=>ce+xe,0)/se.length;return Math.round(ve)}s.MONEY_KEYS=D,s.COUNT_KEYS=Z,s.ALL_KEYS=H,s.getMonthly=re,s.getForPeriod=ie,s.compare=ye,s.summarize=we})();(function(){const m=window.BP=window.BP||{},s=m.ICS=m.ICS||{};function D(Z){try{logger.warn("[BP ICS bulk disabled] chiamata a:",Z)}catch(H){}}s.createCalendarForRange=function(){return D("createCalendarForRange()"),null},s.downloadForRange=function(){return D("downloadForRange()"),!1}})();(function(){const m=window.BP=window.BP||{},s=m.ClientStatus=m.ClientStatus||{},D="bp_banner_seen";function Z(){try{return JSON.parse(localStorage.getItem(D)||"{}")}catch(le){return{}}}function H(le){try{localStorage.setItem(D,JSON.stringify(le||{}))}catch(se){}}function Y(le){return!!Z()[le]}function ee(le){const se=Z();se[le]=!0,H(se)}async function te(le){const se=window.authToken||"",ve=await fetch(le,{headers:se?{Authorization:"Bearer "+se}:{}});if(!ve.ok)throw new Error("GET "+le+" failed");return ve.json()}async function O(le,se){const ve=window.authToken||"",ce=await fetch(le,{method:"POST",headers:{"Content-Type":"application/json",...ve?{Authorization:"Bearer "+ve}:{}},body:JSON.stringify(se||{})});if(!ce.ok)throw new Error("POST "+le+" failed");return ce.json()}async function re({clientId:le,status:se}){if(!le)throw new Error("missing clientId");return O("/api/clients",{id:le,status:String(se||"")})}s.setClientStatusByName=ie;async function ie({clientName:le,status:se}){const ve=String(le||"").trim();if(!ve)throw new Error("missing clientName");const xe=((await te("/api/clients")).clients||[]).find(Ve=>String(Ve.name||"").toLowerCase()===ve.toLowerCase());if(xe)return re({clientId:xe.id,status:se});await O("/api/clients",{name:ve});const _e=((await te("/api/clients")).clients||[]).find(Ve=>String(Ve.name||"").toLowerCase()===ve.toLowerCase());if(!_e)throw new Error("client creation failed");return re({clientId:_e.id,status:se})}function ye({appointment:le,clientName:se},ve){const ce=le||{},xe=se||ce.client||"Cliente",ge=document.createElement("div");return ge.className="bp-banner-client",ge.innerHTML='\n      <div class="bp-banner-inner">\n        <div class="bp-banner-title">√à diventato cliente?</div>\n        <div class="bp-banner-sub">Appuntamento con <b>'.concat(we(xe),'</b></div>\n        <div class="bp-banner-actions">\n          <button type="button" data-yes>S√¨</button>\n          <button type="button" class="ghost" data-no>No</button>\n        </div>\n      </div>\n    '),ge.querySelector("[data-yes]").addEventListener("click",()=>ve&&ve(!0,ce)),ge.querySelector("[data-no]").addEventListener("click",()=>ve&&ve(!1,ce)),ge}function we(le){return String(le).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}(function(){if(document.getElementById("bp-clientstatus-css"))return;const se="\n.bp-banner-client{\n  position: fixed; left:50%; transform:translateX(-50%);\n  top: 70px; z-index: 1200;\n  background: rgba(20,24,34,.95);\n  color: #fff;\n  border: 1px solid rgba(255,255,255,.18);\n  box-shadow: 0 10px 24px rgba(0,0,0,.35);\n  border-radius:14px; padding:10px; min-width:280px;\n  animation: bpBannerPop .18s ease-out;\n}\n.bp-banner-inner{ display:flex; flex-direction:column; gap:6px; }\n.bp-banner-title{ font-weight:800; }\n.bp-banner-sub{ font-size:12px; opacity:.92; }\n.bp-banner-actions{ display:flex; gap:8px; margin-top:6px; justify-content:flex-end; }\n@keyframes bpBannerPop{ from{ transform:translate(-50%, -6px); opacity:0 } to{ transform:translate(-50%, 0); opacity:1 } }\n",ve=document.createElement("style");ve.id="bp-clientstatus-css",ve.textContent=se,document.head.appendChild(ve)})(),s.hasSeen=Y,s.markSeen=ee,s.renderBecameClientBanner=ye,s.setClientStatus=re,s.setClientStatusByName=ie})();(function(){function m(s){try{fetch("/api/client_error",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:location.href,info:{ua:navigator.userAgent},...s})})}catch(D){}}window.addEventListener("error",function(s){try{m({message:s.message,stack:s.error&&s.error.stack||null})}catch(D){}}),window.addEventListener("unhandledrejection",function(s){try{m({message:"unhandledrejection",stack:s.reason&&s.reason.stack||String(s.reason)})}catch(D){}})})();(function(){function m(s){return String(s||"event").normalize("NFKD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9._-]+/g,"_").replace(/^_+|_+$/g,"").slice(0,80)||"event"}if(window.saveICS&&!window.__icsSanitized){const s=window.saveICS;window.saveICS=function(D,Z){try{D=m(D)}catch(H){}return s(D,Z)},window.__icsSanitized=!0}window.__icsSanitize=m})();(function(m){function s(D){const Z=window.BANNERS_LOOKBACK_DAYS||7,H="nncf",Y="sale",ee=(C,_)=>"bp_snooze_".concat(_,"_").concat(C),te=(C,_)=>"bp_done_".concat(_,"_").concat(C),O=(C,_)=>{try{const B=localStorage.getItem(ee(C,_));return B&&new Date(B).getTime()>Date.now()}catch(B){return!1}},re=(C,_)=>{try{const B=new Date;B.setDate(B.getDate()+1),localStorage.setItem(ee(C,_),B.toISOString())}catch(B){}},ie=(C,_)=>{try{return localStorage.getItem(te(C,_))==="1"}catch(B){return!1}},ye=(C,_)=>{try{localStorage.setItem(te(C,_),"1")}catch(B){}},we=window.BPFinal&&BPFinal.GET||window.GET,le=window.BPFinal&&BPFinal.POST||window.POST,se=window.toast||(C=>alert(C));function ve(C){return String(C||"").replace(/[&<>\"]/g,_=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"})[_])}function ce(){if(document.getElementById("bp-banner-css"))return;const C="\n      #bp_banner_host{position:fixed;left:16px;right:16px;bottom:16px;z-index:9999;display:flex;justify-content:center;pointer-events:none}\n      .bp-banner-card{pointer-events:auto;width:100%;max-width:720px;background:var(--card,#fff);color:var(--text,#111);\n        border:1px solid rgba(0,0,0,.12);border-radius:14px;box-shadow:0 10px 28px rgba(0,0,0,.28);padding:12px;display:flex;gap:12px;align-items:center;opacity:0;transform:translateY(8px);transition:opacity .2s,transform .2s}\n      .bp-banner-card.show{opacity:1;transform:none}\n      .bp-banner-card .msg{flex:1}.bp-banner-card .row{display:flex;gap:8px;align-items:center}\n      .bp-banner-card .ghost{background:rgba(0,0,0,.06);border:1px solid rgba(0,0,0,.12)}\n      @media (prefers-color-scheme: dark){ .bp-banner-card{background:rgba(15,18,28,.96);color:#fff;border-color:rgba(255,255,255,.16)}\n        .bp-banner-card .ghost{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.18)}}\n    ",_=document.createElement("style");_.id="bp-banner-css",_.textContent=C,document.head.appendChild(_)}function xe(){let C=document.getElementById("bp_banner_host");return C||(C=document.createElement("div"),C.id="bp_banner_host",document.body.appendChild(C)),C}let ge=[],_e=!1;function Ve(C){ge.push(C),f()}function f(){if(_e)return;const C=ge.shift();if(!C)return;_e=!0,ce();const _=xe();_.innerHTML="";const B=C(G);_.appendChild(B),requestAnimationFrame(()=>B.classList.add("show"));function G(){_.innerHTML="",_e=!1,setTimeout(f,40)}}async function y(C,_){if(!C)return;const B=await we("/api/clients"),I=(B&&B.clients||[]).find(w=>String(w.name||"").trim().toLowerCase()===String(C).trim().toLowerCase());I&&await le("/api/clients",{id:I.id,status:_})}function z(C){if(C)try{if(typeof window.openPaymentBuilderById=="function"){window.openPaymentBuilderById(C);return}if(typeof window.gotoGIAndOpenBuilder=="function"){window.gotoGIAndOpenBuilder(C);return}if(document.querySelector("#gi_rows")){document.dispatchEvent(new CustomEvent("gi:edit",{detail:{id:C}}));return}if(typeof window.viewGI=="function"){try{window.viewGI()}catch(B){}let _=0;(function B(){if(document.getElementById("gi_rows")||_>40){try{document.dispatchEvent(new CustomEvent("gi:edit",{detail:{id:C}}))}catch(I){}return}_++,setTimeout(B,100)})();return}document.dispatchEvent(new CustomEvent("gi:edit",{detail:{id:C}}))}catch(_){}}function b(C,_){const B=Number(C.vss||C.vsdPersonal||0)||0,G=C.client||"Cliente",I='\n      <div class="card" style="min-width:min(380px,96vw);max-width:480px">\n        <div style="display:flex;justify-content:space-between;align-items:center">\n          <b>VSS per '.concat(ve(G),'</b>\n          <button class="ghost" id="vss_x">Chiudi</button>\n        </div>\n        <div class="row" style="margin-top:8px;gap:8px;align-items:flex-end;flex-wrap:wrap">\n          <div style="min-width:200px">\n            <label>Valore VSS</label>\n            <input id="vss_val" type="number" step="1" value="').concat(B,'">\n          </div>\n          <div class="muted small">Modifica consentita solo per VSS</div>\n        </div>\n        <div class="right" style="margin-top:12px">\n          <button id="vss_ok">Salva</button>\n        </div>\n      </div>');if(typeof window.showOverlay=="function"&&typeof window.hideOverlay=="function"){showOverlay(I);const P=document.getElementById("bp-overlay-panel")||document.body,N=E=>P.querySelector(E),M=()=>{try{hideOverlay()}catch(E){}};N("#vss_x").onclick=M,N("#vss_ok").onclick=async()=>{try{const E=Math.max(0,Number(N("#vss_val").value||0));if(await le("/api/appointments",{id:C.id,vss:E}),D("medium"),se("Appuntamento aggiornato"),M(),E>0)try{const R=await U(C,E);if(R&&(R.id||R._id)){const T=R.id||R._id;z(T)}}catch(R){logger.error(R)}_&&typeof _.onSaved=="function"&&_.onSaved(E)}catch(E){logger.error(E),se("Errore salvataggio VSS")}};return}const w=document.createElement("div");w.className="modal",w.innerHTML=I,document.body.appendChild(w);const g=()=>{try{w.remove()}catch(P){}};w.querySelector("#vss_x").onclick=g,w.querySelector("#vss_ok").onclick=async()=>{try{const P=Math.max(0,Number(w.querySelector("#vss_val").value||0));if(await le("/api/appointments",{id:C.id,vss:P}),D("medium"),se("Appuntamento aggiornato"),g(),P>0)try{const N=await U(C,P);if(N&&(N.id||N._id)){const M=N.id||N._id;z(M)}}catch(N){logger.error(N)}_&&typeof _.onSaved=="function"&&_.onSaved(P)}catch(P){logger.error(P),se("Errore salvataggio VSS")}}}async function U(C,_){const B={apptId:C.id,date:new Date(C.end||C.start||Date.now()).toISOString(),clientName:C.client||"Cliente",vssTotal:Math.round(Number(_||0)),services:C.services||C.note||"",consultantId:C.userId||C.ownerId||null},G=await le("/api/gi",B);return G&&(G.sale||G.gi||G.data)||G}function A(C){return function(_){const B=document.createElement("div");B.className="bp-banner-card",B.setAttribute("role","alertdialog"),B.setAttribute("aria-live","assertive");const G=new Date(C.end||C.start||Date.now()).toLocaleString("it-IT",{dateStyle:"short",timeStyle:"short"});return B.innerHTML='<div class="msg"><b>Allora, hai venduto a '.concat(ve(C.client||"Cliente"),'?</b>\n           <div class="small muted">Appuntamento del ').concat(ve(G),'</div></div>\n         <div class="row">\n           <button class="ghost" data-act="later">Posticipa</button>\n           <button class="ghost" data-act="no">No</button>\n           <button data-act="yes">S√¨</button>\n         </div>'),B.querySelector('[data-act="yes"]').onclick=function(){_(),b(C,{onSaved:()=>ye(C.id,Y)})},B.querySelector('[data-act="no"]').onclick=async function(){_();try{await le("/api/appointments",{id:C.id,vss:0}),ye(C.id,Y),se("Registrato: nessuna vendita")}catch(I){}},B.querySelector('[data-act="later"]').onclick=function(){re(C.id,Y),se("Te lo ripropongo domani"),_()},B}}function x(C){return function(_){const B=document.createElement("div");B.className="bp-banner-card",B.setAttribute("role","alertdialog"),B.setAttribute("aria-live","assertive");const G=new Date(C.end||C.start||Date.now()).toLocaleString("it-IT",{dateStyle:"short",timeStyle:"short"});return B.innerHTML='<div class="msg"><b>√à diventato cliente?</b> '.concat(ve(C.client||""),'\n           <div class="small muted">Appuntamento del ').concat(ve(G),'</div></div>\n         <div class="row">\n           <button class="ghost" data-act="later">Posticipa</button>\n           <button class="ghost" data-act="no">No</button>\n           <button data-act="yes">S√¨</button>\n         </div>'),B.querySelector('[data-act="yes"]').onclick=async function(){_();try{await y(C.client,"attivo")}catch(I){}b(C,{onSaved:()=>ye(C.id,H)})},B.querySelector('[data-act="no"]').onclick=async function(){_();try{await y(C.client,"lead non chiuso"),await le("/api/appointments",{id:C.id,vss:0}),ye(C.id,H),se("Aggiornato: Lead non chiuso, VSS=0")}catch(I){}},B.querySelector('[data-act="later"]').onclick=function(){re(C.id,H),se("Te lo ripropongo domani"),_()},B}}async function L(){try{const C=await we("/api/appointments"),_=Date.now(),B=_-Z*24*60*60*1e3,G=C&&C.appointments||[];G.sort((I,w)=>+new Date(w.end||w.start||0)-+new Date(I.end||I.start||0)),G.forEach(I=>{try{const w=+new Date(I.end||I.start||0);if(!w||w>_||w<B||!(String(I.type||"").toLowerCase()==="vendita"))return;if(I.nncf){if(ie(I.id,H)||O(I.id,H))return;Ve(x(I))}else{if(ie(I.id,Y)||O(I.id,Y))return;Ve(A(I))}}catch(w){}})}catch(C){}}window.scanBanners=L,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",L,{once:!0}):L();try{document.addEventListener("appt:saved",function(){setTimeout(L,50)})}catch(C){}try{document.addEventListener("visibilitychange",function(){document.hidden||setTimeout(L,50)})}catch(C){}try{setInterval(function(){L()},60*1e3)}catch(C){}}typeof m<"u"&&(m.initPostSaleBanners=s)})(typeof window<"u"?window:void 0);const Ee=window.BP&&BP.Haptics&&BP.Haptics.impact?BP.Haptics.impact:()=>{};(function(){window.bpAuthToken||(window.bpAuthToken=function(){try{const e=localStorage.getItem("bp_user")||sessionStorage.getItem("bp_user");if(e)try{const i=JSON.parse(e);if(i&&(i.token||i.jwt||i.accessToken))return i.token||i.jwt||i.accessToken}catch(i){}}catch(e){}const a=["bp_token","authToken","token","jwt","accessToken","id_token","auth","authorization","session","user"];for(const e of a)try{const i=localStorage.getItem(e)||sessionStorage.getItem(e);if(!i)continue;try{const t=JSON.parse(i);if(t&&(t.token||t.jwt||t.accessToken))return t.token||t.jwt||t.accessToken}catch(t){}if(/^[A-Za-z0-9\-_]+\.[A-Za-z0-9\-_]+\.[A-Za-z0-9\-_]+$/.test(i))return i}catch(i){}try{for(let e=0;e<localStorage.length;e++){const i=localStorage.key(e),t=localStorage.getItem(i);if(t){try{const l=JSON.parse(t);if(l&&(l.token||l.jwt||l.accessToken))return l.token||l.jwt||l.accessToken}catch(l){}if(/^[A-Za-z0-9\-_]+\.[A-Za-z0-9\-_]+\.[A-Za-z0-9\-_]+$/.test(t))return t}}}catch(e){}try{const e=JSON.parse(localStorage.getItem("user")||"{}");if(e&&(e.token||e.jwt||e.accessToken))return e.token||e.jwt||e.accessToken}catch(e){}return null}),window.GET||(window.GET=async function(a){const e=window.bpAuthToken&&window.bpAuthToken()||null,i=await fetch(a,{headers:{Accept:"application/json",...e?{Authorization:"Bearer "+e}:{}}});return i.status===204?null:(i.headers.get("content-type")||"").includes("application/json")?i.json():{ok:i.ok,status:i.status,text:await i.text()}}),window.POST||(window.POST=async function(a,e){const i=window.bpAuthToken&&window.bpAuthToken()||null,t=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json",...i?{Authorization:"Bearer "+i}:{}},body:JSON.stringify(e||{})});return t.status===204?null:(t.headers.get("content-type")||"").includes("application/json")?t.json():{ok:t.ok,status:t.status,text:await t.text()}}),typeof window<"u"&&typeof window.initPostSaleBanners=="function"&&window.initPostSaleBanners(Ee),(function(){if(document.getElementById("bp-qvss-css"))return;const e=document.createElement("style");e.id="bp-qvss-css",e.textContent='\n    #bp_overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);\n      display:flex;align-items:center;justify-content:center;z-index:9999;padding:16px}\n    .bp-modal{max-width:620px;width:clamp(300px,92vw,620px);background:var(--card,#fff);\n      color:var(--text,#111);border-radius:14px;border:1px solid rgba(0,0,0,.12);\n      box-shadow:0 12px 34px rgba(0,0,0,.35)}\n    .bp-modal .hd{display:flex;align-items:center;justify-content:space-between;padding:12px 14px}\n    .bp-modal .bd{padding:10px 14px 14px}\n    .bp-modal .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}\n    .bp-modal .right{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}\n    .bp-modal input[type="number"], .bp-modal input[type="date"], .bp-modal select, .bp-modal textarea{\n      width:100%;padding:8px;border:1px solid rgba(0,0,0,.18);border-radius:10px}\n    @media (prefers-color-scheme:dark){\n      .bp-modal{background:rgba(15,18,28,.98);color:#fff;border-color:rgba(255,255,255,.14)}\n      .bp-modal input, .bp-modal select, .bp-modal textarea{background:rgba(255,255,255,.04);color:#fff;border-color:rgba(255,255,255,.18)}\n    }\n  ',document.head.appendChild(e)})();function m(a){return String(a||"").replace(/[&<>'"]/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[e])}function s(a){if(window.showOverlay)window.showOverlay(a);else{const e=document.createElement("div");e.id="bp_overlay",e.innerHTML=a,document.body.appendChild(e)}}function D(){if(window.hideOverlay)window.hideOverlay();else{const a=document.getElementById("bp_overlay");a&&a.remove()}}async function Z(a){try{const e=await ge("/api/clients"),i=e&&e.clients||[],t=String(a||"").trim().toLowerCase(),l=i.find(h=>String(h.name||"").trim().toLowerCase()===t);return l?l.id:null}catch(e){return null}}async function H(a,e){if(!(Number(e)>0))return null;const i=new Date(a.end||a.start||Date.now()).toISOString();let t=a.clientId||null;t||(t=await Z(a.client));const l={date:i,vssTotal:Number(e)||0,services:a.services||"",consultantId:a.userId||(JSON.parse(localStorage.getItem("user")||"{}")||{}).id,clientId:t||void 0,clientName:a.client||void 0},h=await _e("/api/gi",l);return h&&(h.id||h.sale&&h.sale.id)||null}async function Y(a){if(typeof viewGI=="function"&&document.querySelector("#gi_rows")){document.dispatchEvent(new CustomEvent("gi:edit",{detail:{id:a}}));return}if(typeof viewGI=="function"){try{viewGI()}catch(e){}setTimeout(()=>document.dispatchEvent(new CustomEvent("gi:edit",{detail:{id:a}})),350);return}try{let h=function(u){const c=l("pb_rates");if(!u||!u.length){c.textContent="Nessuna rata",c._data=[];return}c.innerHTML=u.map(p=>{const n=new Date(p.dueDate).toLocaleDateString("it-IT");return"<div>".concat(n," ¬∑ ").concat(Number(p.amount||0).toLocaleString("it-IT"),'‚Ç¨ <span class="muted">').concat(m(p.note||""),"</span></div>")}).join(""),c._data=u};const e=await ge("/api/gi?from=1900-01-01&to=2999-12-31"),i=(e&&e.sales||[]).find(u=>String(u.id)===String(a));if(!i){ce("Vendita non trovata");return}const t=new Date().toISOString().slice(0,10);s('<div class="bp-modal"><div class="hd"><b>Builder pagamenti ‚Äì '+m(i.clientName||"Cliente")+'</b><button class="ghost" id="pb_x">Chiudi</button></div><div class="bd"><div class="row"><div style="flex:1"><label>Totale VSS</label><input id="pb_vss" type="number" value="'+Number(i.vssTotal||0)+'"></div></div><div class="row" style="margin-top:8px;gap:12px"><div><label>Regola rapida</label><select id="pb_rule"><option value="0">Manuale</option><option value="50-25-25">50% + 25% / 30-60gg</option><option value="20+12">20% + 12 rate mensili</option></select></div><div><label>Prima scadenza</label><input id="pb_first" type="date" value="'+t+'"></div></div><div style="margin-top:8px"><label>Rate</label><div id="pb_rates" class="small muted">Nessuna rata</div></div><div class="right"><button class="ghost" id="pb_apply">Ricalcola</button><button id="pb_save">Salva</button></div></div></div>');const l=u=>document.getElementById(u);l("pb_apply").onclick=function(){const u=l("pb_rule").value||"0",c=Math.max(0,Number(l("pb_vss").value||0)),p=new Date(l("pb_first").value||new Date),n=[],o=(r,d,v)=>n.push({dueDate:new Date(r).toISOString(),amount:Math.round(d),note:v||""});if(u==="50-25-25"){o(p,c*.5,"Acconto 50%");const r=new Date(p);r.setDate(r.getDate()+30),o(r,c*.25,"Saldo 25% a 30gg");const d=new Date(p);d.setDate(d.getDate()+60),o(d,c*.25,"Saldo 25% a 60gg")}else if(u==="20+12"){o(p,c*.2,"Acconto 20%");const r=c*.8,d=12,v=r/d;for(let k=0;k<d;k++){const W=new Date(p);W.setMonth(W.getMonth()+k+1),o(W,v,"Rata "+(k+1)+"/"+d)}}h(n)},l("pb_save").onclick=async function(){const u=Math.max(0,Number(l("pb_vss").value||0)),c=l("pb_rates")._data||[];try{await _e("/api/gi",{id:i.id,vssTotal:u,schedule:c});try{document.dispatchEvent(new CustomEvent("payments:defined",{detail:{id:i.id,vssTotal:u,schedule:c}}))}catch(p){}ce("Piano pagamenti salvato"),D()}catch(p){logger.error(p),ce("Errore salvataggio")}},l("pb_x").onclick=D}catch(e){logger.error(e)}}function ee(a){const e=a.client||"Cliente",i=Number(a.vss||a.vsdPersonal||0)||0;s('<div class="bp-modal"><div class="hd"><b>VSS per '+m(e)+'</b><button class="ghost" id="qvss_x">Chiudi</button></div><div class="bd"><div><label>Valore VSS</label><input id="qvss_val" type="number" step="1" value="'+i+'"></div><div class="small muted" style="margin-top:6px">Modifica consentita solo per VSS</div><div class="right"><button id="qvss_ok">Salva</button></div></div></div>'),document.getElementById("qvss_x").onclick=D,document.getElementById("qvss_ok").onclick=async function(){try{const t=Math.max(0,Number(document.getElementById("qvss_val").value||0));await _e("/api/appointments",{id:a.id,vss:t});const l=await H(a,t);D(),ce("VSS salvato"),l&&Y(l);try{l&&document.dispatchEvent(new CustomEvent("gi:created",{detail:{id:l}}))}catch(h){}document.dispatchEvent(new Event("bp:saved"))}catch(t){logger.error(t),ce("Errore salvataggio VSS")}}}async function te(a){try{a.nncf&&(await(async function(){try{const i=await ge("/api/clients"),t=i&&i.clients||[],l=String(a.client||"").trim().toLowerCase(),h=t.find(u=>String(u.name||"").trim().toLowerCase()===l);h&&await _e("/api/clients",{id:h.id,status:"attivo"})}catch(i){}})(),document.dispatchEvent(new Event("client:converted"))),ee(a)}catch(e){logger.error(e)}}async function O(a){try{if(a.nncf)try{const e=await ge("/api/clients"),i=e&&e.clients||[],t=String(a.client||"").trim().toLowerCase(),l=i.find(h=>String(h.name||"").trim().toLowerCase()===t);l&&await _e("/api/clients",{id:l.id,status:"lead non chiuso"})}catch(e){}await _e("/api/appointments",{id:a.id,vss:0}),ce("Ok, segnato come non venduto")}catch(e){logger.error(e),ce("Errore aggiornamento")}}window.pipelineYes=te,window.pipelineNo=O,(function(){function a(){if(document.getElementById("bp-center-css"))return;const n="\n      #bp_overlay{display:flex;align-items:center;justify-content:center}\n      .bp-modal-card{min-width:min(560px,96vw);max-width:680px;max-height:86vh;overflow:auto}\n      @media (max-width:640px){ .bp-modal-card{min-width:96vw} }\n      .bp-modal-foot{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}\n    ",o=document.createElement("style");o.id="bp-center-css",o.textContent=n,document.head.appendChild(o)}function e(n){try{document.documentElement.style.overflow=n?"hidden":""}catch(o){}}async function i(n){if(!n)return null;try{const o=await ge("/api/clients"),r=o&&o.clients||[],d=String(n).trim().toLowerCase(),v=r.find(k=>String(k.name||"").trim().toLowerCase()===d);return v?v.id:null}catch(o){return null}}async function t(n,o){const r=await i(n);if(r)try{await _e("/api/clients",{id:r,status:o})}catch(d){}}async function l(n,o){return _e("/api/appointments",{id:n,vss:Math.max(0,Number(o||0))})}async function h(n,o){const r=await i(n.client||""),d={date:new Date(n.end||n.start||Date.now()).toISOString(),clientId:r||void 0,clientName:n.client||"",vssTotal:Math.max(0,Number(o||0)),services:n.services||"",schedule:[]},v=await _e("/api/gi",d);return v&&(v.id||v.sale&&v.sale.id||Array.isArray(v.sales)&&v.sales[0]&&v.sales[0].id)||null}async function u(n){if(!n)return;try{typeof window.viewGI=="function"&&window.viewGI()}catch(r){}let o=0;(function r(){if(document.getElementById("gi_rows")||o>40){try{const v=new CustomEvent("gi:edit",{detail:{id:n}});document.dispatchEvent(v)}catch(v){}return}o++,setTimeout(r,100)})()}function c(n,o){a(),e(!0);const r=Math.max(0,Number(n.vss||0)),d='<div class="modal"><div class="card bp-modal-card"><div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><b>VSS per '+(n.client?p(n.client):"appuntamento")+'</b><button class="ghost" id="qvss_x">Chiudi</button></div><div style="margin-top:8px"><label>Valore VSS</label><input id="qvss_val" type="number" step="1" value="'+r+'"><div class="small muted" style="margin-top:6px">Modifica consentita solo per VSS</div></div><div class="bp-modal-foot"><button id="qvss_ok">Salva</button></div></div></div>';showOverlay(d);function v(){e(!1),hideOverlay()}const k=document.getElementById("qvss_val");document.getElementById("qvss_x").onclick=v,document.getElementById("qvss_ok").onclick=async function(){try{const W=Math.max(0,Number(k.value||0));await l(n.id,W);const J=await h(n,W);if(v(),J)try{document.dispatchEvent(new CustomEvent("gi:created",{detail:{id:J}}))}catch(S){}typeof window.coachSay=="function"&&q("medium"),u(J)}catch(W){logger.error(W),ce("Errore salvataggio VSS")}}}function p(n){return String(n||"").replace(/[&<>'"]/g,o=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[o])}window.pipelineYes=async function(n){try{n.nncf&&await t(n.client,"cliente"),c(n)}catch(o){logger.error(o)}},window.pipelineNo=async function(n){try{n.nncf&&await t(n.client,"lead non chiuso"),await l(n.id,0),Ee("light"),ce("Segnato VSS 0")}catch(o){logger.error(o)}}})(),(function(){function a(u){return encodeURIComponent(String(u||""))}function e(){try{const o=document.getElementById("rep_label");if(o&&o.textContent)return o.textContent.trim()}catch(o){}const u=(document.getElementById("rep_type")||{}).value||"mensile",c=new Date,p=String(c.getMonth()+1).padStart(2,"0"),n=c.getFullYear();return u==="settimanale"?"Settimana ISO "+(isoWeekNum?isoWeekNum(c):"corrente")+" "+n:u==="trimestrale"?"Q"+(Math.floor(c.getMonth()/3)+1)+" "+n:u==="semestrale"?"Semestre "+(c.getMonth()<6?"1¬∞":"2¬∞")+" "+n:u==="annuale"?"Anno "+n:"Mese "+p+"/"+n}async function i(){try{const u=await ge("/api/usernames");return(u&&u.users||[]).map(p=>p.email).filter(Boolean).join(",")}catch(u){return""}}function t(){const u=document.getElementById("report_subject");return u&&u.value&&u.value.trim()?u.value.trim():"Report BP ‚Äì "+e()}function l(){const u=document.getElementById("report_body");return u&&u.value&&u.value.trim()?u.value:"Ciao,\n\ndi seguito il report del periodo "+e()+".\n\n‚Äì VSS\n‚Äì VSD\n‚Äì GI\n‚Äì NNCF\n\nA presto."}async function h(){const u=document.getElementById("rep_gmail_web"),c=document.getElementById("rep_gmail_app");if(!u&&!c)return;const p=await i(),n=t(),o=l();try{await navigator.clipboard.writeText(o)}catch(r){}u&&(u.onclick=function(){const r="https://mail.google.com/mail/?view=cm&fs=1&tf=1&su="+a(n)+"&cc="+a(p)+"&body="+a(o);window.open(r,"_blank");try{document.dispatchEvent(new Event("report:composed"))}catch(d){}}),c&&(c.onclick=function(){const r="googlegmail:///co?subject="+a(n)+"&cc="+a(p)+"&body="+a(o);location.href=r;try{document.dispatchEvent(new Event("report:composed"))}catch(d){}setTimeout(function(){if(!document.hidden){location.href="mailto:?subject="+a(n)+"&cc="+a(p)+"&body="+a(o);try{document.dispatchEvent(new Event("report:composed"))}catch(d){}}},1200)})}window.wireReportButtons=h})(),(function(){function a(c){var p=c instanceof Date?c:new Date(c||Date.now()),n=p.getFullYear(),o=("0"+(p.getMonth()+1)).slice(-2),r=("0"+p.getDate()).slice(-2);return n+"-"+o+"-"+r}function e(c){for(var p=a(new Date),n=c.querySelectorAll("[data-date], [data-day]"),o=0;o<n.length;o++){var r=n[o],d=r.getAttribute("data-date")||r.getAttribute("data-day")||"";if(d){var v=String(d).slice(0,10);v===p&&r.classList.add("today")}}}function i(c){if(typeof window.attachICSButtons=="function"){try{window.attachICSButtons(c)}catch(W){logger.error(W)}return}for(var p=c.querySelectorAll("[data-appt], [data-start][data-title], .appt, .calendar-appt"),n=0;n<p.length;n++){var o=p[n];if(!o.querySelector(".bp-ics")){var r=o.getAttribute("data-start")||"",d=o.getAttribute("data-end")||"",v=o.getAttribute("data-title")||o.getAttribute("data-client")||"Appuntamento";if(r){var k=document.createElement("a");k.href="#",k.className="bp-ics btn-ics",k.textContent="üìÖ",k.style.marginLeft="6px",k.onclick=function(W){W.preventDefault();try{var J=W.currentTarget.parentElement||document.body,S=J.getAttribute("data-start")||r,V=J.getAttribute("data-end")||d||S,ae=J.getAttribute("data-title")||J.getAttribute("data-client")||v,K=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//BP//Calendar//IT","BEGIN:VEVENT","UID:"+Date.now()+"@bp","DTSTAMP:"+new Date().toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z"),"DTSTART:"+new Date(S).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z"),"DTEND:"+new Date(V).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z"),"SUMMARY:"+ae,"END:VEVENT","END:VCALENDAR"].join("\r\n"),oe=new Blob([K],{type:"text/calendar"}),de=URL.createObjectURL(oe),me=document.createElement("a");me.href=de,me.download=(ae||"appuntamento")+".ics",document.body.appendChild(me),me.click(),setTimeout(function(){URL.revokeObjectURL(de);try{me.remove()}catch(be){}},0)}catch(be){logger.error(be)}},o.appendChild(k)}}}}function t(){var c=document.getElementById("calendar")||document.querySelector(".calendar")||document;e(c),i(c)}window.hookCalendar=t;function l(c){if(document.readyState==="complete"||document.readyState==="interactive")return c();document.addEventListener("DOMContentLoaded",c,{once:!0})}l(t);var h=document.getElementById("calendar")||document.querySelector(".calendar");if(h&&!h.__bpCalObs){h.__bpCalObs=!0;var u=new MutationObserver(function(){try{t()}catch(c){}});u.observe(h,{childList:!0,subtree:!0})}})(),(function(){var a=!1;function e(){if(!a){a=!0;var i='.today{outline:2px solid var(--accent, #5dd3ff); outline-offset:-2px; border-radius:8px; position:relative;}.today::after{content:"OGGI"; position:absolute; top:6px; right:8px; font-size:10px; font-weight:700; color:#fff; background:var(--accent, #5dd3ff); padding:2px 6px; border-radius:6px;}',t=document.createElement("style");t.setAttribute("data-bp-today","1"),t.textContent=i,document.head.appendChild(t)}}window.injectTodayCSS=e,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e,{once:!0}):e()})(),(function(){function a(){try{return JSON.parse(localStorage.getItem("user")||"{}")}catch(n){return{}}}function e(){var n=a();return n&&n.role==="admin"}function i(n,o){return(o||document).querySelector(n)}function t(n,o){return Array.prototype.slice.call((o||document).querySelectorAll(n))}function l(n){var o=new Date(n);return!o||isNaN(o)?"‚Äî":("0"+o.getDate()).slice(-2)+"/"+("0"+(o.getMonth()+1)).slice(-2)+"/"+o.getFullYear()}async function h(){try{for(var n=await ge("/api/appointments"),o=n&&n.appointments||[],r={},d=0;d<o.length;d++){var v=o[d],k=String(v.client||"").trim().toLowerCase();if(k){var W=new Date(v.start||v.end||0).getTime();(!r[k]||W>r[k])&&(r[k]=W)}}return r}catch(J){return logger.error(J),{}}}async function u(){var n=document.getElementById("cl_list");if(n){var o=await h();t(".card",n).forEach(function(r){var d=i("b",r);if(d){var v=(d.textContent||"").trim().toLowerCase();if(v){var k=o[v],W=i(".bp-lastapp",r),J="Ultimo appuntamento: "+(k?l(k):"‚Äî");if(W)W.textContent=J;else{var S=document.createElement("div");S.className="small muted bp-lastapp",S.textContent=J,r.appendChild(S)}}}})}}async function c(){if(!e())return;var n=document.getElementById("cl_list");if(!n)return;var[o,r]=await Promise.all([ge("/api/clients"),ge("/api/usernames")]),d=o&&o.clients||[],v=r&&r.users||[];function k(W){var J=i("b",W),S=(J&&J.textContent||"").trim().toLowerCase();return d.find(function(V){return String(V.name||"").trim().toLowerCase()===S})}n.__bpInlineReady||(n.__bpInlineReady=!0,t(".card",n).forEach(function(W){if(!W.__bpInline){W.__bpInline=!0;var J=k(W);if(J){var S=document.createElement("div");S.style.display="flex",S.style.gap="8px",S.style.marginTop="6px";var V=document.createElement("button");V.className="ghost",V.textContent="Modifica",S.appendChild(V),W.appendChild(S);var ae=document.createElement("div");ae.style.display="none",ae.style.marginTop="8px",ae.innerHTML='<div class="row" style="gap:8px"><div><label>Nome</label><input class="bp-ed-name" type="text" value="'+(J.name||"")+'"></div><div><label>Stato</label><select class="bp-ed-state"><option value="prospect" '+(J.status==="prospect"?"selected":"")+'>Prospect</option><option value="attivo" '+(J.status==="attivo"?"selected":"")+'>Attivo</option><option value="cliente" '+(J.status==="cliente"?"selected":"")+'>Cliente</option></select></div><div><label>Consulente</label><select class="bp-ed-consulente"></select></div><div style="align-self:flex-end"><button class="ghost bp-ed-save">Salva</button></div></div>',W.appendChild(ae);var K=i(".bp-ed-consulente",ae);K.innerHTML='<option value="">‚Äî</option>'+v.map(function(oe){return'<option value="'+oe.id+'" '+(String(J.consultantId||"")===String(oe.id)?"selected":"")+">"+(oe.name||"User "+oe.id)+"</option>"}).join(""),V.onclick=function(){ae.style.display=ae.style.display==="none"?"block":"none"},i(".bp-ed-save",ae).onclick=async function(oe){oe.preventDefault();try{var de={id:J.id,name:i(".bp-ed-name",ae).value.trim(),status:i(".bp-ed-state",ae).value,consultantId:i(".bp-ed-consulente",ae).value||null};await _e("/api/clients",de);var me=i("b",W);me&&(me.textContent=de.name);var be=i(".small",W);be&&/Stato:/.test(be.textContent||"")&&(be.innerHTML="Stato: <b>"+de.status+"</b>");var Se=t(".small",W).find(function(ke){return/Consulente:/.test(ke.textContent||"")});if(Se){var Pe=v.find(function(ke){return String(ke.id)===String(de.consultantId||"")});Se.innerHTML="Consulente: <b>"+(Pe?Pe.name||"User "+Pe.id:"‚Äî")+"</b>"}Ee("medium")}catch(ke){logger.error(ke),Ee("heavy")}}}}}))}window.applyClientsLastAppointment=u,window.ensureClientInlineEdit=c;function p(){var n=document.getElementById("cl_list");if(n&&(u(),c(),!n.__bpCliObs)){n.__bpCliObs=!0;var o=new MutationObserver(function(){u(),c()});o.observe(n,{childList:!0,subtree:!0})}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",p,{once:!0}):p()})();function re(a){const e=["#".concat(a,"_mode"),"#dash_mode","#comm_mode",'[data-scope="'.concat(a,'"] [name="mode"]'),"#".concat(a,' select[name="mode"]'),'#dashboard select[name="mode"]','select[name="mode"]'];for(const i of e){const t=document.querySelector(i);if(t&&t.value)return t.value}return"consuntivo"}if(window.__BP_FINAL_READY__)return;window.__BP_FINAL_READY__=!0;const ie=(a,e)=>(e||document).querySelector(a),ye=(a,e,i)=>a&&a.addEventListener(e,i,!1),we=a=>document.readyState!=="loading"?a():document.addEventListener("DOMContentLoaded",a),le=(a,e)=>{try{return JSON.parse(a)}catch(i){return e}},se=a=>a<10?"0"+a:""+a,ve=()=>{const a=new Date;return"".concat(a.getFullYear(),"-").concat(se(a.getMonth()+1),"-").concat(se(a.getDate()))};function ce(a){try{(window.showToast?window.showToast:alert)(a)}catch(e){alert(a)}}function xe(){const a=i=>{if(!i)return null;i=String(i).replace(/^"+|"+$/g,"");try{const t=JSON.parse(i);if(t&&(t.token||t.jwt||t.accessToken))return t.token||t.jwt||t.accessToken}catch(t){}return/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+$/.test(i)?i:null};for(let i=0;i<localStorage.length;i++){const t=a(localStorage.getItem(localStorage.key(i)));if(t)return t}const e=["token","authToken","jwt","bp_token","accessToken","id_token","auth","authorization","bp.jwt","_token","session","user"];for(const i of e){const t=a(localStorage.getItem(i)||sessionStorage.getItem(i));if(t)return t}try{const i=le(localStorage.getItem("user")||"{}",{});if(i&&(i.token||i.jwt||i.accessToken))return i.token||i.jwt||i.accessToken}catch(i){}return null}async function ge(a,e={}){if(typeof window.GET=="function"&&!e.forceFetch)try{return await window.GET(a)}catch(l){}const i=xe(),t=await fetch(a,{headers:{Accept:"application/json",...i?{Authorization:"Bearer "+i}:{}}});return t.status===401&&window.GET?window.GET(a):t.status===204?null:t.json()}async function _e(a,e,i={}){if(typeof window.POST=="function"&&!i.forceFetch)try{return await window.POST(a,e)}catch(h){}const t=xe(),l=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json",...t?{Authorization:"Bearer "+t}:{}},body:JSON.stringify(e||{})});return!l.ok&&l.status===401&&window.POST?window.POST(a,e):l.status===204?null:l.json()}function Ve(a,e,i){const t=document.getElementById(a);if(!t)return;const l=t.getContext("2d"),h=window.devicePixelRatio||1,u=Math.max(220,t.clientWidth||320),c=Math.max(80,t.clientHeight||80);t.style.width=u+"px",t.style.height=c+"px",t.width=u*h,t.height=c*h,l.scale(h,h),l.clearRect(0,0,u,c);const p=Array.isArray(i)?i.map(S=>+S||0):[];if(!p.length)return;const n=Math.max(...p),o=Math.min(...p),r=n-o===0?(n||1)*.2:(n-o)*.2,d=n+r,v=Math.max(0,o-r),k=p.length>1?(u-8)/(p.length-1):0,W=S=>4+S*k,J=S=>{const V=(S-v)/(d-v||1);return c-6-V*(c-12)};l.lineWidth=2,l.lineJoin=l.lineCap="round",l.strokeStyle="#2e6cff",l.beginPath(),l.moveTo(W(0),J(p[0]));for(let S=1;S<p.length;S++)l.lineTo(W(S),J(p[S]));l.stroke(),l.fillStyle="#2e6cff";for(let S=0;S<p.length;S++)l.beginPath(),l.arc(W(S),J(p[S]),2,0,Math.PI*2),l.fill()}(function(){const e=function(i,t,l){const h=document.getElementById(i);if(h){if(window.Chart)try{h.__chart&&typeof h.__chart.destroy=="function"&&h.__chart.destroy();const u={type:"line",data:{labels:t,datasets:[{data:l,tension:.35,pointRadius:2,borderWidth:2}]},options:{responsive:!0,plugins:{legend:{display:!1}},scales:{x:{display:!0},y:{display:!0}}}};h.__chart=new Chart(h.getContext("2d"),u);return}catch(u){}Ve(i,t,l)}};(!window.drawFullLine||!window.drawFullLine.__patched)&&(window.drawFullLine=e,window.drawFullLine.__patched=!0)})();const f=typeof window<"u"?window.__periodsCache||(window.__periodsCache={}):{};function y(a){try{const e=new Date(a),i=e.getUTCFullYear(),t=String(e.getUTCMonth()+1).padStart(2,"0"),l=String(e.getUTCDate()).padStart(2,"0");return i+"-"+t+"-"+l}catch(e){return""}}function z(a){try{return typeof effectivePeriodType=="function"?effectivePeriodType(String(a||"mensile").toLowerCase()):String(a||"mensile").toLowerCase()}catch(e){return String(a||"mensile").toLowerCase()}}async function b(a){if(!a){if(Array.isArray(window.periods)&&window.periods.length)return window.periods;try{const p=await ge("/api/periods?global=1");if(p&&Array.isArray(p.periods))return window.periods=p.periods,p.periods}catch(p){}return window.periods||[]}let e,i,t,l=null;if(typeof a=="string"){const p=window.readUnifiedRange&&window.readUnifiedRange(a)||{type:"mensile",end:new Date};e=p.type||"mensile";const n=window.buildBuckets?window.buildBuckets(e,p.end):[];if(n&&n.length)i=y(new Date(n[0].s)),t=y(new Date(n[n.length-1].e));else if(p.start&&p.end)i=y(new Date(p.start)),t=y(new Date(p.end));else{const o=new Date;i=y(o),t=y(o)}}else{const p=a||{};e=p.type||"mensile",i=p.from||y(new Date),t=p.to||y(new Date),l=p.userId||null}const h=z(e),u=[h,i,t,l||""].join("|");if(f[u])return f[u];const c=["?global=1","type="+encodeURIComponent(h),"from="+encodeURIComponent(i),"to="+encodeURIComponent(t)].concat(l?["userId="+encodeURIComponent(l)]:[]).join("&").replace("?&","?");try{const p=await ge("/api/periods"+c).catch(function(){return ge("/api/periods"+c.replace("?global=1","?").replace("??","?"))}),n=p&&Array.isArray(p.periods)?p.periods:[];return f[u]=n,n}catch(p){return[]}}function U(a,e,i){const t=String(e).toLowerCase()==="previsionale"?a.indicatorsPrev||{}:a.indicatorsCons||{},l=Number(t[i]||0);return Number.isFinite(l)?l:0}function A(a,e,i){if(typeof window.drawFullLine=="function")return window.drawFullLine(a,e,i);Ve(a,e,i)}async function x(){const a=window.readUnifiedRange&&window.readUnifiedRange("dash")||{type:"mensile",end:new Date},e=a.type||"mensile",i=re("dash"),t=window.buildBuckets?window.buildBuckets(e,a.end):[],l=await b("dash"),h=window.labelsFor?window.labelsFor(e,t):t.map((u,c)=>String(c+1));["VSS","VSDPersonale","GI","NNCF"].forEach(u=>{const c=t.map(p=>{let n=0;return l.forEach(o=>{if(o.type!==effectivePeriodType(e))return;const r=new Date(o.startDate).getTime(),d=new Date(o.endDate).getTime();r>=p.s&&d<=p.e&&(n+=U(o,i,u))}),Math.round(n)});A("d_mini_"+u.toLowerCase(),h,c)});try{if(window.BP&&BP.Targets&&typeof BP.Targets.getForPeriod=="function"){const u=JSON.parse(localStorage.getItem("user")||"{}")||{},c=String(u.grade||"junior").toLowerCase()==="senior"?"senior":"junior",p=BP.Targets.getForPeriod(c,effectivePeriodType(e))||{},n=["VSS","VSDPersonale","GI","NNCF"],o={};n.forEach(r=>{let d=0;const v=t[t.length-1];v&&(l.forEach(k=>{if(k.type!==effectivePeriodType(e))return;const W=new Date(k.startDate).getTime(),J=new Date(k.endDate).getTime();W>=v.s&&J<=v.e&&(d+=U(k,i,r))}),o[r]=Math.round(d))}),window.__bpCoachKpiFired=window.__bpCoachKpiFired||{},n.forEach(r=>{const d=Number(p[r]||0);if(d<=0)return;const v=Number(o[r]||0),k=Math.round(v/d*100),W=effectivePeriodType(e)+"_"+r;if(k>=100&&!window.__bpCoachKpiFired[W+"_100"]){window.__bpCoachKpiFired[W+"_100"]=!0;try{document.dispatchEvent(new CustomEvent("kpi:goal-reached",{detail:{key:r,value:v,target:d}}))}catch(J){}}else if(k>=80&&!window.__bpCoachKpiFired[W+"_80"]){window.__bpCoachKpiFired[W+"_80"]=!0;try{document.dispatchEvent(new CustomEvent("kpi:goal-80",{detail:{key:r,value:v,target:d}}))}catch(J){}}})}}catch(u){}}async function L(){const a="comm",e=window.readUnifiedRange&&(window.readUnifiedRange(a)||window.readUnifiedRange("cm"))||{type:"mensile",end:new Date},i=e.type||"mensile",t=re&&re(a)||re&&re("cm")||"cons",l=window.buildBuckets?window.buildBuckets(i,e.end):[],h=await b("comm"),u=window.labelsFor?window.labelsFor(i,l):l.map((p,n)=>String(n+1)),c=l.map(p=>{let n=0;return h.forEach(o=>{if(o.type!==effectivePeriodType(i))return;const r=new Date(o.startDate).getTime(),d=new Date(o.endDate).getTime();r>=p.s&&d<=p.e&&(n+=U(o,t,"VSDPersonale"))}),Math.round(n)});A("cm_mini_vsd",u,c)}async function C(){const a=window.readUnifiedRange&&(window.readUnifiedRange("t")||window.readUnifiedRange("tg"))||{type:"mensile",end:new Date},e=a.type||"mensile",i=re&&re("t")||re&&re("tg")||"cons",t=(ie("#tg_user")||{}).value||"",l=(ie("#tg_ind")||{}).value||"VSS",h=window.buildBuckets?window.buildBuckets(e,a.end):[];function u(d){try{const v=new Date(d),k=v.getUTCFullYear(),W=String(v.getUTCMonth()+1).padStart(2,"0"),J=String(v.getUTCDate()).padStart(2,"0");return k+"-"+W+"-"+J}catch(v){return""}}const c=h.length?u(new Date(h[0].s)):u(new Date),p=h.length?u(new Date(h[h.length-1].e)):u(new Date),n=await b({type:e,from:c,to:p,userId:t||null}),o=window.labelsFor?window.labelsFor(e,h):h.map((d,v)=>String(v+1)),r=h.map(d=>{let v=0;return n.forEach(k=>{if(k.type!==effectivePeriodType(e)||t&&String(k.userId)!==String(t))return;const W=new Date(k.startDate).getTime(),J=new Date(k.endDate).getTime();W>=d.s&&J<=d.e&&(v+=U(k,i,l))}),Math.round(v)});A("tg_chart",o,r)}function _(){ye(ie("#dash_mode"),"change",()=>{Ee("light"),window.recomputeDashboard&&recomputeDashboard(),window.recomputeDashboardMini&&x()}),ye(ie("#d_mode"),"change",()=>{Ee("light"),window.recomputeDashboard&&recomputeDashboard(),window.recomputeDashboardMini&&x()}),ye(ie("#comm_mode"),"change",()=>{Ee("light"),window.recomputeCommsMini&&L()}),ye(ie("#cm_mode"),"change",()=>{Ee("light"),window.recomputeCommsMini&&L()});const a=ie("#tg_user");a&&a.options.length<=1&&ge("/api/usernames").then(t=>{(t&&t.users||[]).forEach(l=>{var h=document.createElement("option");h.value=l.id,h.textContent=(l.name||"User "+l.id)+(l.grade?" ‚Äì "+l.grade:""),a.appendChild(h)})}).catch(t=>logger.error(t));const e=()=>{window.recomputeTeamChart&&C(),window.recomputeTeamAggChart&&recomputeTeamAggChart()};ye(ie("#t_mode"),"change",()=>{Ee("light"),e()}),["#t_y","#t_m","#t_q","#t_from","#t_to"].forEach(t=>{const l=ie(t);l&&ye(l,"change",e)}),a&&ye(a,"change",()=>{Ee("light"),window.recomputeTeamChart&&C()});const i=ie("#t_ind");i&&ye(i,"change",()=>{Ee("light"),window.recomputeTeamAggChart&&recomputeTeamAggChart()}),ie("#tg_chart")&&window.recomputeTeamChart&&C(),ie("#t_chart")&&window.recomputeTeamAggChart&&recomputeTeamAggChart()}typeof window.todayKey!="function"&&(window.todayKey=function(){var e=new Date,i=e.getFullYear(),t=("0"+(e.getMonth()+1)).slice(-2),l=("0"+e.getDate()).slice(-2);return i+"-"+t+"-"+l});function B(){try{var a=ve(),e=document.querySelector('.calendar .day[data-day="'+a+'"], .calendar .day[data-date="'+a+'"]');if(!e)for(var i=parseInt(a.slice(8,10),10),t=document.querySelectorAll(".calendar .day"),l=0;l<t.length;l++){var h=t[l],u=parseInt((h.getAttribute("data-day")||h.getAttribute("data-date")||"").slice(8,10)||h.textContent.trim(),10);if(u===i){e=h;break}}e&&e.classList.add("today")}catch(c){}}function G(){try{for(var a=ve(),e=document.querySelectorAll(".calendar .day[data-day], .calendar .day[data-date]"),i=0;i<e.length;i++){var t=e[i],l=(t.getAttribute("data-day")||t.getAttribute("data-date")||"").slice(0,10);l&&l<a&&t.classList.remove("slot-free")}}catch(h){}}function I(){try{var a=document.getElementById("cal_day_box");if(!a)return;for(var e=a.querySelectorAll(".cal-app"),i=0;i<e.length;i++){var t=e[i];if(!t.querySelector("[data-ics-inline]")){var l=t.getAttribute("data-start")||"",h=t.getAttribute("data-end")||"",u=t.getAttribute("data-title")||(t.querySelector("b")?t.querySelector("b").textContent.trim():"Appuntamento");if(!(!l||!h)&&window.BP&&BP.ICS&&typeof BP.ICS.downloadIcsForAppointment=="function"){var c=document.createElement("button");c.className="ghost btn-ics",c.textContent="üìÖ",c.setAttribute("data-ics-inline","1"),c.style.marginTop="6px",c.addEventListener("click",function(p){p.stopPropagation();var n=p.currentTarget.parentElement,o=n.getAttribute("data-start"),r=n.getAttribute("data-end"),d=n.getAttribute("data-title")||(n.querySelector("b")?n.querySelector("b").textContent.trim():"Appuntamento"),v={client:d,start:o,end:r,type:"manuale",vss:0,vsdPersonal:0,nncf:!1};try{BP.ICS.downloadIcsForAppointment(v),Ee("medium")}catch(k){}}),t.appendChild(c)}}}}catch(p){}}window.markToday=window.markToday||B,window.clampSlotCounters=window.clampSlotCounters||G,window.wireICSInsideDayBox=window.wireICSInsideDayBox||I,(function(){function a(u){return encodeURIComponent(String(u||""))}function e(){return ge("/api/users_emails").then(function(u){return u&&Array.isArray(u.emails)?u.emails.filter(Boolean):u&&Array.isArray(u.users)?u.users.map(c=>c.email).filter(Boolean):[]}).catch(function(){return ge("/api/usernames").then(function(u){var c=u&&u.users||[];return c.map(p=>p.email).filter(Boolean)}).catch(function(){return[]})})}function i(){var u=document.getElementById("report_subject");return u&&u.value.trim()||"Report BP"}function t(){var u=document.getElementById("report_body");return u&&u.value||""}function l(){var u=document.getElementById("rep_gmail_web"),c=document.getElementById("rep_gmail_app");!u&&!c||e().then(function(p){var n=(p||[]).join(",");function o(){return"https://mail.google.com/mail/?view=cm&fs=1&tf=1&su="+a(i())+"&cc="+a(n)+"&body="+a(t())}function r(){return"googlegmail:///co?subject="+a(i())+"&cc="+a(n)+"&body="+a(t())}u&&(u.onclick=function(){try{navigator.clipboard&&navigator.clipboard.writeText(t())}catch(d){}window.open(o(),"_blank")}),c&&(c.onclick=function(){try{navigator.clipboard&&navigator.clipboard.writeText(t())}catch(d){}location.href=r(),setTimeout(function(){if(!document.hidden){var d="mailto:?subject="+a(i())+"&cc="+a(n)+"&body="+a(t());location.href=d}},1200)})})}var h=window.BPFinal=window.BPFinal||{};h.wireReportButtons=l,window.wireReportButtons||(window.wireReportButtons=l)})(),(function(){let a={ts:0,map:null},e=null;function i(t){const l=Object.create(null);for(const h of t||[]){const u=String(h.client||"").toLowerCase();if(!u)continue;const c=+new Date(h.end||h.start||0);(!l[u]||c>l[u])&&(l[u]=c)}return l}window.BPFinal=window.BPFinal||{},BPFinal.getLastApptMap=function(){const l=Date.now();return a.map&&l-a.ts<15e3?Promise.resolve(a.map):e||(e=ge("/api/appointments?global=1").then(h=>i(h&&h.appointments||[])).then(h=>(a={ts:Date.now(),map:h},h)).catch(()=>({})).finally(()=>{e=null}),e)}})();function w(a){var t;if(!a)return;const e=a.getAttribute("data-clid")||"",i=(((t=a.querySelector("b"))==null?void 0:t.textContent)||"").trim();ge("/api/appointments?global=1").then(l=>{const h=l&&l.appointments||[],u=i.toLowerCase(),c=h.filter(r=>String(r.clientId||"")===e||String(r.client||"").trim().toLowerCase()===u);c.sort((r,d)=>new Date(d.start)-new Date(r.start));const p=c.map(r=>{const d=new Date(r.start),v=("0"+d.getDate()).slice(-2)+"/"+("0"+(d.getMonth()+1)).slice(-2)+"/"+d.getFullYear(),k=[];return Number(r.vss)>0&&k.push("VSS "+Number(r.vss).toLocaleString("it-IT")+"‚Ç¨"),Number(r.vsdPersonal)>0&&k.push("VSD "+Number(r.vsdPersonal).toLocaleString("it-IT")+"‚Ç¨"),Number(r.vsdIndiretto)>0&&k.push("VSD ind "+Number(r.vsdIndiretto).toLocaleString("it-IT")+"‚Ç¨"),Number(r.telefonate)>0&&k.push("Tel "+Number(r.telefonate)),Number(r.appFissati)>0&&k.push("AppFiss "+Number(r.appFissati)),'<div class="small">'.concat(m(r.type||"")," ‚Äì ").concat(v).concat(k.length?" ‚Äì "+k.join(" ¬∑ "):"","</div>")}).join("")||'<div class="muted">Nessun appuntamento</div>',n=document.createElement("div");n.className="modal",n.innerHTML='<div class="card"><h3>Appuntamenti per '.concat(m(i),'</h3><div style="margin-top:8px">').concat(p,'</div><div class="row right"><button class="ghost" data-x>Chiudi</button></div></div>'),document.body.appendChild(n);const o=n.querySelector("[data-x]");o&&(o.onclick=()=>n.remove()),n.addEventListener("click",r=>{r.target===n&&n.remove()})}).catch(l=>{logger.error(l),ce("Errore caricamento appuntamenti")})}BPFinal.showClientAppointments=w,BPFinal.enrichClientCards=function(){const e=document.getElementById("cl_list");e&&BPFinal.getLastApptMap().then(i=>{const t=e.querySelectorAll(".card[data-clid], .card");for(const l of t){const h=l.querySelector("b"),u=(h?h.textContent:l.getAttribute("data-name")||"").trim().toLowerCase(),c=i[u]||0,p=l.querySelector(".last-appt, .client-last");if(p)if(c){const n=new Date(c),o=("0"+n.getDate()).slice(-2),r=("0"+(n.getMonth()+1)).slice(-2),d=n.getFullYear();p.textContent="".concat(o,"/").concat(r,"/").concat(d)}else p.textContent="‚Äî";l.setAttribute("data-last-ts",String(c||0)),!l.getAttribute("data-name-lower")&&u&&l.setAttribute("data-name-lower",u),l.__bp_appts||(l.__bp_appts=!0,l.addEventListener("click",n=>{n.target.closest("button,select,input,a")||w(l)}))}})},BPFinal.enableClientsInlineAdmin=function(){const e=document.getElementById("cl_list");if(!e||e.__bp_inline_admin_wired)return;e.__bp_inline_admin_wired=!0;let i=null;function t(){return i?Promise.resolve(i):ge("/api/usernames").then(c=>i=c&&c.users||[]).catch(()=>[])}const l=["attivo","lead non chiuso","potenziale"];function h(c){if(!c||c.nodeType!==1||c.querySelector("[data-edit-client]"))return;c.style.position="relative";const p=document.createElement("button");p.className="ghost small",p.textContent="Modifica",p.title="Modifica cliente",p.setAttribute("data-edit-client","1"),p.style.position="absolute",p.style.right="8px",p.style.top="8px",p.style.zIndex="2",p.style.cursor="pointer",c.appendChild(p),p.addEventListener("click",function(){const n=c.getAttribute("data-clid")||c.dataset.clid||"",o=c.querySelector("b"),r=c.querySelector(".cl-status, .client-status"),d=c.querySelector(".cl-cons, .client-owner"),v={name:o?o.textContent.trim():"",status:String(r&&r.textContent||c.getAttribute("data-status")||"potenziale").toLowerCase(),consId:c.getAttribute("data-consultant-id")||"",consText:d?d.textContent:"‚Äî"},k=document.createElement("input");k.type="text",k.value=v.name,k.style.width="100%",o&&o.replaceWith(k);const W=document.createElement("select");W.innerHTML=l.map(J=>'<option value="'.concat(J,'">').concat(J.charAt(0).toUpperCase()+J.slice(1),"</option>")).join(""),W.value=l.includes(v.status)?v.status:"potenziale",r&&(r.textContent="",r.appendChild(W)),t().then(J=>{const S=document.createElement("select");S.innerHTML='<option value="">‚Äî</option>'+J.map(oe=>'<option value="'.concat(oe.id,'">').concat(oe.name||"User "+oe.id).concat(oe.grade?" ("+oe.grade+")":"","</option>")).join(""),v.consId&&(S.value=String(v.consId)),d&&(d.textContent="",d.appendChild(S));const V=document.createElement("div");V.className="row",V.style.marginTop="8px";const ae=document.createElement("button");ae.textContent="Salva";const K=document.createElement("button");K.textContent="Annulla",K.className="ghost",V.appendChild(ae),V.appendChild(K),c.appendChild(V),K.addEventListener("click",function(){const oe=document.createElement("b");oe.textContent=v.name,k.replaceWith(oe),r&&(r.textContent=v.status),d.textContent=v.consText||"‚Äî",V.remove()}),ae.addEventListener("click",function(){const oe={id:n,name:k.value.trim(),status:W.value},de=S.value?String(S.value):"";de&&(oe.consultantId=de),_e("/api/clients",oe).then(function(){ce("Cliente aggiornato"),typeof addXP=="function"&&addXP(4);const me=document.createElement("b");me.textContent=oe.name||v.name,k.replaceWith(me),r&&(r.textContent=oe.status),de?(d.textContent=S.options[S.selectedIndex].textContent||"#"+de,c.setAttribute("data-consultant-id",de)):(d.textContent="‚Äî",c.setAttribute("data-consultant-id","")),c.setAttribute("data-status",oe.status),V.remove()}).catch(function(me){logger.error(me),ce("Errore aggiornamento cliente")})})})})}e.querySelectorAll(".card[data-clid], .card").forEach(h),new MutationObserver(c=>{for(const p of c)for(const n of p.addedNodes)n.nodeType===1&&n.matches(".card[data-clid], .card")&&h(n),n.nodeType===1&&n.querySelectorAll&&n.querySelectorAll(".card[data-clid], .card").forEach(h)}).observe(e,{childList:!0,subtree:!0})},BPFinal.applyClientSort=function(){const e=document.getElementById("cl_list");if(!e)return;const i=document.getElementById("cl_order"),t=i?i.value:"az",l=Array.from(e.children).filter(h=>h.classList.contains("card"));if(l.length){t==="last_desc"?l.sort((h,u)=>(+u.getAttribute("data-last-ts")||0)-(+h.getAttribute("data-last-ts")||0)):l.sort((h,u)=>String(h.getAttribute("data-name-lower")||"").localeCompare(String(u.getAttribute("data-name-lower")||"")));for(const h of l)e.appendChild(h)}},BPFinal.ensureClientFilters=function(){const e=document.getElementById("cl_f_apply");e&&!e.__bp_wired&&(e.__bp_wired=!0,e.addEventListener("click",()=>{setTimeout(()=>{BPFinal.enrichClientCards(),BPFinal.applyClientSort()},0)}));const i=document.getElementById("cl_order");i&&!i.__bp_wired&&(i.__bp_wired=!0,i.addEventListener("change",()=>BPFinal.applyClientSort()))},BPFinal.wireCreateClientExtras=function(){const e=document.getElementById("cl_add");!e||e.__bp_wired||(e.__bp_wired=!0,e.addEventListener("click",i=>{const t=document.getElementById("cl_name"),l=document.getElementById("cl_new_state"),h=document.getElementById("cl_new_owner");if(!t)return;const u=(t.value||"").trim();if(!u||!l&&!h)return;i.stopPropagation(),i.preventDefault();const c={name:u};l&&(c.status=l.value),h&&h.value&&(c.consultantId=h.value),_e("/api/clients",c).then(()=>{ce("Cliente aggiunto"),addXP&&addXP(5),t.value="",setTimeout(()=>{BPFinal.enrichClientCards(),BPFinal.applyClientSort()},150)}).catch(()=>ce("Errore creazione cliente"))},!0))},BPFinal.ensureClientSection=function(){BPFinal.ensureClientFilters(),BPFinal.wireCreateClientExtras(),BPFinal.enrichClientCards(),BPFinal.enableClientsInlineAdmin(),BPFinal.applyClientSort()};async function g(){const a=ie("#tg_user");if(!a||a.options.length>1)return;const e=await ge("/api/usernames").catch(()=>null);(e&&e.users||[]).forEach(i=>{const t=document.createElement("option");t.value=i.id,t.textContent=i.name+(i.grade?" ("+i.grade+")":""),a.appendChild(t)})}function P(){const a=ie("#users, .users");if(!a||a.__userEditWired)return;a.__userEditWired=!0,a.addEventListener("click",i=>{var n,o;const t=i.target.closest("[data-edit-user]");if(!t)return;const l=t.closest("[data-user-id]"),h=l==null?void 0:l.getAttribute("data-user-id"),u=((n=l==null?void 0:l.querySelector(".u-name"))==null?void 0:n.textContent)||"",c=((o=l==null?void 0:l.querySelector(".u-email"))==null?void 0:o.textContent)||"",p=document.createElement("div");p.className="modal",p.innerHTML='<div class="card"><h3>Modifica utente</h3><label>Nome <input id="u_name" value="'+u+'"></label><label>Email <input id="u_email" value="'+c+'"></label><label>Password <input id="u_pass" type="password" placeholder="(lascia vuoto per non cambiare)"></label><div class="row right"><button id="u_ok" class="btn-ghost">Salva</button><button id="u_x" class="btn-ghost">Chiudi</button></div></div>',document.body.appendChild(p),ie("#u_x",p).onclick=()=>p.remove(),ie("#u_ok",p).onclick=async()=>{try{const r={id:h,name:ie("#u_name",p).value,email:ie("#u_email",p).value},d=ie("#u_pass",p).value.trim();d&&(r.password=d),await _e("/api/users",r),ce("Utente aggiornato"),p.remove(),location.reload()}catch(r){ce("Errore aggiornamento utente")}}});const e=ie("#btnProfile")||ie("[data-edit-self]");e&&!e.__wired&&(e.__wired=!0,e.onclick=()=>{const i=le(localStorage.getItem("user")||"{}",{}),t=document.createElement("div");t.className="modal",t.innerHTML='<div class="card"><h3>Profilo</h3><label>Nome <input id="me_name" value="'+(i.name||"")+'"></label><label>Email <input id="me_email" value="'+(i.email||"")+'"></label><label>Password <input id="me_pass" type="password" placeholder="(nuova password)"></label><div class="row right"><button id="me_ok" class="btn-ghost">Salva</button><button id="me_x" class="btn-ghost">Chiudi</button></div></div>',document.body.appendChild(t),ie("#me_x",t).onclick=()=>t.remove(),ie("#me_ok",t).onclick=async()=>{try{const l={id:i.id,name:ie("#me_name",t).value,email:ie("#me_email",t).value},h=ie("#me_pass",t).value.trim();h&&(l.password=h),await _e("/api/users",l),ce("Profilo aggiornato"),t.remove(),location.reload()}catch(l){ce("Errore aggiornamento profilo")}}})}const N=document.createElement("div");N.className="bp-coach-host",N.style.cssText="position:fixed;left:50%;transform:translateX(-50%);z-index:1200;display:flex;flex-direction:column;gap:6px;pointer-events:none;",document.documentElement.appendChild(N);const M="\n    /* Desktop default */\n    .bp-coach-host{ top:14px; }\n    /* Mobile: place below header + safe-area */\n    @media (max-width:980px){\n      .bp-coach-host{ top: calc(env(safe-area-inset-top) + 56px + 12px); }\n    }\n    .bp-coach{background:rgba(20,24,34,.92);color:#fff;border:1px solid rgba(255,255,255,.16);\n      border-radius:12px;padding:8px 10px;font-weight:700;box-shadow:0 12px 24px rgba(0,0,0,.35);opacity:.98;transform:translateY(0);transition:all .18s;}\n    @keyframes bpCoachPop{from{transform:translateY(-6px);opacity:0}to{transform:translateY(0);opacity:1}}\n  ",E=document.createElement("style");E.textContent=M,document.head.appendChild(E);function R(){return le(localStorage.getItem("user")||"{}",{})}function T(a){const e=R().name||"campione",i=window.BP&&window.BP.Phrases?window.BP.Phrases:null;let t=[];return i?t=a==="high"?i.high||i.standard||[]:a==="low"?i.low||i.standard||[]:i.medium||i.standard||[]:t=["Grande {{name}}!","Che figata, {{name}}!","Super!","Non ti ferma nessuno!!","Grandissimo!"],t.length||(t=["Grande {{name}}!"]),t[Math.floor(Math.random()*t.length)].replace(/{{\s*name\s*}}/gi,e)}function q(a){const e=document.createElement("div");e.className="bp-coach",e.textContent=T(a||"medium"),N.appendChild(e),setTimeout(()=>{e.style.opacity="0",e.style.transform="translateY(-4px)"},2200),setTimeout(()=>{e.remove()},2420)}window.coachSay=window.coachSay||q;try{window.BP=window.BP||{},window.BP.Coach=window.BP.Coach||{},window.BP.Coach.say=window.BP.Coach.say||function(a,e){try{const i=String(a||"").toLowerCase();let t=e&&e.intensity||(i==="low"||i==="medium"||i==="high"?i:void 0);t||(i==="bp_saved"||i==="client_converted"||i==="gi_created"?t="high":i==="appointment_created"||i==="payments_defined"||i==="report_composed"?t="medium":t="low"),q(t)}catch(i){q("medium")}}}catch(a){}(function(){var a="bp-nncf-banner",e="bp_seen_nncf_appt";function i(){if(!document.getElementById("bp-nncf-css")){var c="\n      #".concat(a,"{\n        position: fixed; left: 16px; right:16px; bottom: 16px; z-index: 9999;\n        background: var(--card, rgba(15,18,28,.96));\n        border: 1px solid var(--hair2, rgba(255,255,255,.12));\n        border-radius: 14px; box-shadow: 0 8px 28px rgba(0,0,0,.35);\n        padding: 12px; display:flex; align-items:center; gap:12px; backdrop-filter: blur(6px);\n      }\n      #").concat(a," .msg{ flex:1; }\n      #").concat(a," .row{ display:flex; gap:8px; align-items:center; }\n      #").concat(a," .ghost{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.18); }\n      @media (prefers-color-scheme: light){\n        #").concat(a,"{ background:#fff; border-color: rgba(0,0,0,.12); }\n        #").concat(a," .ghost{ background:rgba(0,0,0,.04); border-color: rgba(0,0,0,.12); }\n      }\n    "),p=document.createElement("style");p.id="bp-nncf-css",p.textContent=c,document.head.appendChild(p)}}function t(c,p){return c?(c=String(c).trim().toLowerCase(),ge("/api/clients").then(function(n){var o=n&&n.clients||[],r=o.find(function(d){return String(d.name||"").trim().toLowerCase()===c});if(!r)throw new Error("Cliente non trovato: "+c);return _e("/api/clients",{id:r.id,status:p})})):Promise.reject(new Error("Nome cliente mancante"))}function l(c){if(document.getElementById(a))return;i();var p=c.client||"Cliente",n=document.createElement("div");n.id=a,n.innerHTML='<div class="msg"><b>√à diventato cliente?</b> '+m(p)+'</div><div class="row"><button class="ghost" id="bp_nncf_yes">S√¨</button><button class="ghost" id="bp_nncf_notyet">Non ancora</button><button id="bp_nncf_close">Chiudi</button></div>',document.body.appendChild(n);function o(){try{localStorage.setItem(e,String(c.id||c.end||Date.now()))}catch(d){}}function r(){try{n.remove()}catch(d){}}document.getElementById("bp_nncf_yes").onclick=function(){t(p,"cliente").then(function(){ce("Stato cliente aggiornato")}).catch(function(){ce("Impossibile aggiornare lo stato")}).finally(function(){o(),r()})},document.getElementById("bp_nncf_notyet").onclick=function(){t(p,"prospect").catch(function(){}).finally(function(){o(),r()})},document.getElementById("bp_nncf_close").onclick=function(){o(),r()}}function h(){var c=localStorage.getItem(e)||"";return ge("/api/appointments").then(function(p){var n=Date.now(),o=p&&p.appointments||[],r=o.filter(function(k){if(!k||!k.nncf)return!1;var W=+new Date(k.end||k.start||0);return W&&W<n-60*1e3}).sort(function(k,W){return+new Date(W.end||W.start||0)-+new Date(k.end||k.start||0)});if(r.length){var d=r[0],v=String(d.id||d.end||"");v&&c&&String(c)===v||l(d)}}).catch(function(p){})}var u=window.BPFinal=window.BPFinal||{};u.injectBannerCSS=i,u.updateClientStatusByName=t,u.scanNNCF=h,window.scanNNCF||(window.scanNNCF=h)})(),(function(){window.showUndo=window.showUndo||function(a,e,i){try{var t=document.getElementById("bp_undo_bar");t||(t=document.createElement("div"),t.id="bp_undo_bar",t.style.position="fixed",t.style.left="16px",t.style.bottom="16px",t.style.zIndex="9999",t.style.background="rgba(20,22,28,0.95)",t.style.color="#fff",t.style.padding="10px 12px",t.style.borderRadius="10px",t.style.boxShadow="0 8px 24px rgba(0,0,0,.25)",t.style.display="flex",t.style.alignItems="center",t.style.gap="12px",document.body.appendChild(t)),t.innerHTML="<span>"+a+'</span><button id="bp_undo_btn" class="ghost" style="background:#fff;color:#111;border-radius:8px;padding:6px 10px">Annulla</button>';var l=document.getElementById("bp_undo_btn"),h=setTimeout(function(){try{t.remove()}catch(u){}},i||5e3);l.onclick=function(){clearTimeout(h);try{t.remove()}catch(u){}typeof e=="function"&&Promise.resolve(e()).then(function(){Ee("medium");try{document.dispatchEvent(new Event("undo:performed"))}catch(u){}}).catch(function(){Ee("heavy")})},Ee("light")}catch(u){logger.error(u)}},window.pushUndo=window.pushUndo||function(a){if(!(!a||typeof a.undo!="function")){var e=a.label||"Annulla ultima operazione";window.showUndo(e,a.undo,a.ttl||5e3)}},window.wireCoachUndoHaptics=function(){function a(){try{window.__periodsCache&&Object.keys(window.__periodsCache).forEach(function(i){delete window.__periodsCache[i]}),delete window.periods}catch(i){}}document.addEventListener("bp:saved",function(){window.coachSay&&q("high"),Ee("heavy"),a()}),document.addEventListener("bp:deleted",function(){window.coachSay&&q("medium"),Ee("medium"),a()}),document.addEventListener("appt:saved",function(){window.coachSay&&q("medium"),Ee("medium")}),document.addEventListener("ics:exported",function(){window.coachSay&&q("low"),Ee("light")}),document.addEventListener("report:composed",function(){window.coachSay&&q("medium"),Ee("medium")}),document.addEventListener("client:converted",function(){window.coachSay&&q("high"),Ee("heavy")}),document.addEventListener("gi:created",function(){window.coachSay&&q("high"),Ee("heavy")}),document.addEventListener("payments:defined",function(){window.coachSay&&q("medium"),Ee("medium")}),document.addEventListener("user:profile-updated",function(){window.coachSay&&q("low"),Ee("light")}),document.addEventListener("appt:created",function(){window.coachSay&&q("medium"),Ee("medium")}),document.addEventListener("undo:performed",function(){window.coachSay&&q("low"),Ee("light")}),document.addEventListener("kpi:goal-80",function(){window.coachSay&&q("medium"),Ee("medium")}),document.addEventListener("kpi:goal-reached",function(){window.coachSay&&q("high"),Ee("heavy")}),document.addEventListener("click",function(i){try{for(var t=i.target,l=0;l<3&&t;l++){if(t.matches&&(t.matches('[data-close], [aria-label*="Chiudi" i], [aria-label*="Close" i]')||(t.id||"").toLowerCase().includes("close")||(t.className||"").toLowerCase().includes("close")||/^\s*(chiudi|close)\s*$/i.test(t.textContent||""))){window.coachSay&&q("low"),Ee("light");break}t=t.parentElement}}catch(h){}},!0);var e=document.getElementById("app")||document.body;e&&!e.__undoWired&&(e.__undoWired=!0,e.addEventListener("click",function(i){var t=i.target.closest("[data-delete], .btn-delete");if(t){var l=t.getAttribute("href"),h=t.getAttribute("data-id");(l||h)&&(i.preventDefault(),showUndo("Eliminato ‚Äî Annulla",async function(){try{if(l){var u=l+(l.indexOf("?")>=0?"&":"?")+"undo=1";await ge(u)}else h&&await _e("/api/restore",{id:h});location.reload()}catch(c){logger.error(c)}}))}},!0))},window.wireHapticsUI=function(){var a=document.body;if(!a.__hapticsWired){a.__hapticsWired=!0,a.addEventListener("click",function(i){var t=i.target.closest('button, .button, .btn, .ghost, [role="button"], a.button, a.btn, [data-action]');if(t){var l="light";t.classList.contains("danger")||t.getAttribute("data-danger")==="1"?l="heavy":(t.classList.contains("primary")||t.getAttribute("data-primary")==="1")&&(l="medium"),Ee(l)}},!0),a.addEventListener("change",function(i){var t=i.target;t&&t.matches('select, input[type="checkbox"], input[type="radio"], input[type="range"]')&&Ee("light")},!0);var e=document.querySelector("[data-drawer-toggle], #menuToggle, .menu-toggle");e&&!e.__hW&&(e.__hW=!0,e.addEventListener("click",function(){Ee("light")},!0))}}})(),window.recomputeDashboardMini=typeof x=="function"?x:()=>{},window.recomputeCommsMini=typeof L=="function"?L:()=>{},window.recomputeTeamChart=typeof C=="function"?C:()=>{},window.ensureTeamUserSelect=typeof g=="function"?g:()=>{},window.attachICSButtons=typeof attachICSButtons=="function"?attachICSButtons:()=>{},window.addSaveAndExport=typeof addSaveAndExport=="function"?addSaveAndExport:()=>{},window.BPFinal=window.BPFinal||{},(function(a){function e(i,t){typeof t=="function"&&(a[i]=t,window[i]||(window[i]=t))}typeof x<"u"&&e("recomputeDashboardMini",x),typeof L<"u"&&e("recomputeCommsMini",L),typeof C<"u"&&e("recomputeTeamChart",C),typeof viewGI<"u"&&e("viewGI",viewGI),typeof g<"u"&&e("ensureTeamUserSelect",g),typeof attachICSButtons<"u"&&e("attachICSButtons",attachICSButtons),typeof addSaveAndExport<"u"&&e("addSaveAndExport",addSaveAndExport),typeof q<"u"&&e("coachSay",q),typeof ensureClientFilters<"u"&&e("ensureClientFilters",ensureClientFilters),typeof enrichClientCards<"u"&&e("enrichClientCards",enrichClientCards),typeof w<"u"&&e("showClientAppointments",w),typeof wireReportButtons<"u"&&e("wireReportButtons",wireReportButtons),typeof scanNNCF<"u"&&e("scanNNCF",scanNNCF),typeof ensureNNCFChip<"u"&&e("ensureNNCFChip",ensureNNCFChip),typeof B<"u"&&e("markToday",B),typeof G<"u"&&e("clampSlotCounters",G),typeof filterPastAppointments<"u"&&e("filterPastAppointments",filterPastAppointments),typeof openWeb<"u"&&e("openWeb",openWeb),typeof openApp<"u"&&e("openApp",openApp),typeof notifyConversion<"u"&&e("notifyConversion",notifyConversion),typeof icsFromAppt<"u"&&e("icsFromAppt",icsFromAppt),typeof downloadICS<"u"&&e("downloadICS",downloadICS),typeof ge<"u"&&e("GET",ge),typeof _e<"u"&&e("POST",_e)})(window.BPFinal);const ne=new MutationObserver(()=>{typeof ensureNNCFChip=="function"&&ensureNNCFChip(),typeof addSaveAndExport=="function"&&addSaveAndExport(),typeof attachICSButtons=="function"&&attachICSButtons(),typeof wireReportButtons=="function"&&wireReportButtons(),typeof ensureClientFilters=="function"&&ensureClientFilters(),typeof enrichClientCards=="function"&&enrichClientCards(),typeof g=="function"&&g(),typeof P=="function"&&P(),typeof filterPastAppointments=="function"&&filterPastAppointments(document.body),typeof B=="function"&&B()});we(async()=>{typeof injectTodayCSS=="function"&&injectTodayCSS(),typeof B=="function"&&B(),typeof G=="function"&&G(),typeof _=="function"&&_(),typeof x=="function"&&await x(),typeof L=="function"&&await L(),typeof C=="function"&&await C(),typeof wireHapticsUI=="function"&&wireHapticsUI(),typeof wireCoachUndoHaptics=="function"&&wireCoachUndoHaptics(),typeof scanNNCF=="function"&&scanNNCF();try{const a="bpCoachGreetedDate",e=new Date().toISOString().slice(0,10);(localStorage.getItem(a)||"")!==e&&typeof window.coachSay=="function"&&(localStorage.setItem(a,e),q("low"))}catch(a){}ne.observe(document.body,{childList:!0,subtree:!0}),window.onUnifiedRangeChange&&window.onUnifiedRangeChange(a=>{const e=a==="d"?"dash":a==="cm"?"comm":a==="tg"?"t":a;e==="dash"&&typeof x=="function"&&(x(),typeof renderDashboard=="function"&&renderDashboard()),e==="comm"&&typeof L=="function"&&L(),(e==="t"||e==="team")&&typeof C=="function"&&C()})})})();(function(){if(!window.GET)return;const m=window.GET;window.GET=function(s){try{if(typeof s=="string"&&s.indexOf("/api/leaderboard")===0){if(!(s.indexOf("/api/leaderboard_overall")===0)&&s.indexOf("indicator=")===-1)return Promise.resolve({ranking:[]});if(window.readUnifiedRange){var D=window.readUnifiedRange("lb")||{},Z=D.type==="ytd"||D.type==="ltm"?"mensile":D.type;Z&&(s+=(s.includes("?")?"&":"?")+"type="+encodeURIComponent(Z))}var H=document.getElementById("lb_mode"),Y=H?H.value:"consuntivo";s+=(s.includes("?")?"&":"?")+"mode="+encodeURIComponent(Y)}}catch(ee){}return m.apply(this,arguments)}})();(function(){if(!("serviceWorker"in navigator)||!("PushManager"in window))return;function m(){try{const Y=JSON.parse(localStorage.getItem("bp_user")||"null")||{};if(Y.token)return Y.token}catch(Y){}return localStorage.getItem("bp_token")||localStorage.getItem("authToken")||localStorage.getItem("token")||""}function s(Y){const ee="=".repeat((4-Y.length%4)%4),te=(Y+ee).replace(/-/g,"+").replace(/_/g,"/"),O=atob(te),re=new Uint8Array(O.length);for(let ie=0;ie<O.length;ie++)re[ie]=O.charCodeAt(ie);return re}async function D(Y){const ee=m();if(ee)try{await fetch("/api/push/subscribe",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+ee},body:JSON.stringify(Y)})}catch(te){logger.warn("[BP] push subscribe error",te)}}async function Z(){try{const Y=await navigator.serviceWorker.ready;let ee=await Y.pushManager.getSubscription();if(!ee){const O=await(await fetch("/api/push/publicKey")).json(),re=O.publicKey||O.key||"";if(!re)return;ee=await Y.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:s(re)})}await D(ee.toJSON())}catch(Y){logger.warn("[BP] push subscribe fail",Y)}}async function H(){if(Notification.permission==="granted")return Z();if(Notification.permission==="default")try{if(await Notification.requestPermission()==="granted")return Z()}catch(Y){}}window.BPPush={init:H,subscribe:Z},window.addEventListener("load",H)})();function Ke(m,s){localStorage.setItem(m,typeof s=="string"?s:JSON.stringify(s))}function lt(m,s){const D=localStorage.getItem(m);if(D==null)return s;try{return JSON.parse(D)}catch(Z){return D}}function it(m){localStorage.removeItem(m)}function Ut(m,s){s?Ke("bp_token",m):sessionStorage.setItem("bp_token",m)}function dt(){return localStorage.getItem("bp_token")||sessionStorage.getItem("bp_token")||""}function Vt(m){Ke("bp_user",m)}function Be(){return lt("bp_user",null)||null}function Rt(){it("bp_token"),sessionStorage.removeItem("bp_token"),it("bp_user"),location.href="/?v=13"}function Ct(m,s={}){s.method=s.method||"GET";const D={...s.headers||{}},Z=dt();return Z&&(D.Authorization="Bearer "+Z),s.body!=null&&typeof s.body!="string"&&(D["Content-Type"]="application/json; charset=utf-8",s.body=JSON.stringify(s.body)),s.headers=D,fetch(m,s).then(jt)}async function jt(m){const s=await m.text();if(!m.ok)throw qt(s,m);return Ht(s,m)}function qt(m,s){try{const D=JSON.parse(m).error||"";return new Error(D||s.statusText||"HTTP "+s.status)}catch(D){return new Error(s.statusText||"HTTP "+s.status)}}function Ht(m,s){try{if((s.headers.get("content-type")||"").toLowerCase().indexOf("application/json")!==-1)return m?JSON.parse(m):{}}catch(D){}return m}function Ie(m,s){return Ct(m,Object.assign({method:"GET"},{}))}function Le(m,s){return Ct(m,{method:"POST",body:s||{}})}function ze(m){return(m<10?"0":"")+m}function ot(m){const s=new Date(m);return ze(s.getDate())+"/"+ze(s.getMonth()+1)+"/"+s.getFullYear()}function Fe(m){const s=new Date(m);return s.getFullYear()+"-"+ze(s.getMonth()+1)+"-"+ze(s.getDate())}function _t(m){const s=new Date(m);return ze(s.getHours())+":"+ze(s.getMinutes())}function Yt(m){const s=new Date(m);s.setHours(0,0,0,0);const D=(s.getDay()+6)%7;return s.setDate(s.getDate()-D),s}function ft(m){const s=new Date(m);return new Date(s.getFullYear(),s.getMonth(),1)}function gt(m){const s=new Date(m);return new Date(s.getFullYear(),s.getMonth()+1,0,23,59,59,999)}function Ne(m){const s=new Date(Date.UTC(m.getFullYear(),m.getMonth(),m.getDate())),D=s.getUTCDay()||7;s.setUTCDate(s.getUTCDate()+4-D);const Z=new Date(Date.UTC(s.getUTCFullYear(),0,1));return Math.ceil(((s-Z)/864e5+1)/7)}function ut(m){const s=new Date(m),D=Math.floor(s.getMonth()/3);return new Date(s.getFullYear(),D*3,1)}function ht(m){const s=ut(m);return new Date(s.getFullYear(),s.getMonth()+3,0,23,59,59,999)}function pt(m){const s=new Date(m),D=s.getMonth()<6?0:6;return new Date(s.getFullYear(),D,1)}function wt(m){const s=pt(m);return new Date(s.getFullYear(),s.getMonth()+6,0,23,59,59,999)}function bt(m){const s=new Date(m);return new Date(s.getFullYear(),0,1)}function ct(m){const s=new Date(m);return new Date(s.getFullYear(),11,31,23,59,59,999)}function zt(m,s){const D=new Date(m,0,1+(s-1)*7),Z=D.getDay()||7,H=new Date(D);return H.setDate(D.getDate()-(Z-1)),H.setHours(0,0,0,0),H}function et(m,s){const D=zt(m,s),Z=new Date(D);return Z.setDate(D.getDate()+6),Z.setHours(23,59,59,999),{start:D,end:Z}}function Gt(m){const s=Yt(m);s.setDate(s.getDate()+7);const D=new Date(s);return D.setDate(s.getDate()+6),D.setHours(23,59,59,999),{start:s,end:D}}function $t(m){const s=new Date(m.getFullYear(),m.getMonth()+1,1);return{start:s,end:new Date(s.getFullYear(),s.getMonth()+1,0,23,59,59,999)}}function Wt(m){const s=ut(new Date(m.getFullYear(),m.getMonth()+3,1));return{start:s,end:new Date(s.getFullYear(),s.getMonth()+3,0,23,59,59,999)}}function Jt(m){const s=pt(new Date(m.getFullYear(),m.getMonth()+6,1));return{start:s,end:new Date(s.getFullYear(),s.getMonth()+6,0,23,59,59,999)}}function Kt(m){const s=bt(new Date(m.getFullYear()+1,0,1));return{start:s,end:ct(s)}}function rt(m,s){const D=new Date(s);return m==="settimanale"?"Sett. "+Ne(new Date(s))+" "+D.getFullYear():m==="mensile"?D.toLocaleString("it-IT",{month:"long",year:"numeric"}):m==="trimestrale"?"Trimestre "+(Math.floor(D.getMonth()/3)+1)+" "+D.getFullYear():m==="semestrale"?(D.getMonth()<6?"1¬∞":"2¬∞")+" semestre "+D.getFullYear():m==="annuale"?"Anno "+D.getFullYear():m==="ytd"?"YTD "+D.getFullYear():m==="ltm"?"Ultimi 12 mesi":m}let $e;function Zt(){return $e||($e=document.getElementById("toast-container"),$e||($e=document.createElement("div"),$e.id="toast-container",$e.setAttribute("role","status"),$e.setAttribute("aria-live","polite"),document.body.appendChild($e))),$e}function fe(m){const s=Zt(),D=document.createElement("div");D.className="toast",D.setAttribute("role","alert"),D.textContent=m,s.appendChild(D),setTimeout(function(){try{D.remove(),s.children.length||(s.remove(),$e=null)}catch(Z){}},2200)}function st(){if(window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches)return;const m=document.createElement("div");m.className="confetti",document.body.appendChild(m);for(let s=0;s<26;s++){const D=document.createElement("span");D.style.position="absolute",D.style.left=2+s*4+"%",D.style.top="0",D.style.width="6px",D.style.height="10px",D.style.background="hsl("+s*14+",90%,60%)",D.style.opacity="0.95",m.appendChild(D),(function(Z,H){setTimeout(function(){Z.animate&&Z.animate([{transform:"translateY(-20px) rotate(0deg)"},{transform:"translateY(110vh) rotate(540deg)"}],{duration:1200+Math.random()*800,easing:"cubic-bezier(.2,.6,.2,1)"})},H)})(D,s*35)}setTimeout(function(){try{m.remove()}catch(s){}},2500)}function De(m){return String(m).replace(/[&<>'"]/g,function(s){return{"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"}[s]})}function Je(m){return(Number(m)||0).toLocaleString("it-IT")+"‚Ç¨"}function Oe(m){const s=Number(m)||0;return String(Math.round(s))}function Xt(){if(document.getElementById("bp-mobile-drawer-fix"))return;const m="\n  @media (max-width:980px){\n    .topbar{\n      background: rgba(20,24,34,.90) !important;\n      border-bottom: 1px solid rgba(255,255,255,.08) !important;\n    }\n    .drawer{\n      background: rgba(20,24,34,.96) !important;\n      box-shadow: 14px 0 28px rgba(0,0,0,.45) !important;\n      width: 86vw !important;\n      overflow-y: auto !important;\n    }\n    .drawer .row{ gap:10px !important; }\n    .drawer button{\n      background: rgba(255,255,255,.10) !important;\n      border: 1px solid rgba(255,255,255,.22) !important;\n      color: #fff !important;\n      padding: 12px 14px !important;\n      font-weight: 700 !important;\n      border-radius: 12px !important;\n      -webkit-tap-highlight-color: transparent;\n    }\n    .drawer button:hover{\n      background: rgba(255,255,255,.14) !important;\n      border-color: rgba(255,255,255,.30) !important;\n    }\n    .drawer button.ghost{\n      background: rgba(255,255,255,.10) !important;\n      box-shadow: none !important;\n    }\n  }",s=document.createElement("style");s.id="bp-mobile-drawer-fix",s.textContent=m,document.head.appendChild(s)}function Qt(){if(document.getElementById("bp-mobile-light-fix"))return;const m="\n    @media (max-width:980px) and (prefers-color-scheme: light){\n      .topbar{\n        background:#fff !important;\n        border-bottom:1px solid rgba(0,0,0,.08) !important;\n        box-shadow:none !important;\n      }\n      .topbar .brand .logo{\n        color:#0f172a !important;\n        font-weight:900 !important;\n        letter-spacing:.4px;\n        text-shadow:none !important;\n        opacity:1 !important;\n      }\n      .topbar .hamb span{ background:#0f172a !important; }\n      .card{\n        background:#fff !important;\n        background-image:none !important;\n        box-shadow:none !important;\n      }\n      .drawer{\n        background:#fff !important;\n        box-shadow:14px 0 28px rgba(0,0,0,.10) !important;\n      }\n      .drawer button{\n        color:#0f172a !important;\n        background:rgba(0,0,0,.04) !important;\n        border:1px solid rgba(0,0,0,.12) !important;\n      }\n      .drawer button:hover{\n        background:rgba(0,0,0,.08) !important;\n      }\n    }\n  ",s=document.createElement("style");s.id="bp-mobile-light-fix",s.textContent=m,document.head.appendChild(s)}function en(){if(document.getElementById("bp-badge-light-css"))return;const m="\n    @media (prefers-color-scheme: light){\n      .badge{\n        background: linear-gradient(180deg, #eef2ff, #f8fafc) !important;\n        border: 1px solid #c7d2fe !important;\n        color: #0f172a !important;\n        font-weight: 700 !important;\n        padding: 6px 10px !important;\n        border-radius: 9999px !important;\n        letter-spacing: .2px !important;\n        box-shadow: 0 1px 0 rgba(15,23,42,.05) inset !important;\n      }\n      .chip, .tag{\n        background: #ffffff !important;\n        border: 1px solid #cbd5e1 !important;\n        color: #0f172a !important;\n        font-weight: 600 !important;\n        border-radius: 9999px !important;\n      }\n      .card .badge{\n        background: #fff !important;\n      }\n    }\n  ",s=document.createElement("style");s.id="bp-badge-light-css",s.textContent=m,document.head.appendChild(s)}function je(){const m=Be();if(!m)return"";const s=m.role==="admin",D='<span class="badge">Lvl '+(window.level?window.level():"")+" ¬∑ XP "+(window.getXP?window.getXP():"")+"</span>",Z='<div id="drawer" class="drawer" role="dialog" aria-modal="true" aria-label="Menu"><div class="row"><button class="ghost" onclick="viewHome();toggleDrawer(false)">Dashboard</button><button class="ghost" onclick="viewCalendar();toggleDrawer(false)">Calendario</button><button class="ghost" onclick="viewPeriods();toggleDrawer(false)">BP</button><button class="ghost" onclick="viewAppointments();toggleDrawer(false)">Appuntamenti</button><button class="ghost" onclick="viewLeaderboard();toggleDrawer(false)">Classifiche</button><button class="ghost" onclick="viewCommissions();toggleDrawer(false)">Provvigioni</button><button class="ghost" onclick="viewVendite();toggleDrawer(false)">Vendite e Riordini</button><button class="ghost" onclick="viewGI();toggleDrawer(false)">GI &amp; Scadenzario</button><button class="ghost" onclick="viewReport();toggleDrawer(false)">Report</button><button class="ghost" onclick="viewClients();toggleDrawer(false)">Clienti</button><button class="ghost" onclick="viewTeam();toggleDrawer(false)">Squadra</button>'+(s?'<button class="ghost" onclick="viewUsers();toggleDrawer(false)">Utenti</button>':"")+'<button onclick="logout()">Logout</button></div></div>';return'<div class="topbar"><div class="brand"><button class="hamb" id="hamb" aria-label="Apri menu" aria-controls="drawer" aria-expanded="false"><span></span><span></span><span></span></button><div class="logo">BATTLE PLAN</div></div><div class="nav right">'+D+'<button class="ghost" onclick="viewHome()">Dashboard</button><button class="ghost" onclick="viewCalendar()">Calendario</button><button class="ghost" onclick="viewPeriods()">BP</button><button class="ghost" onclick="viewAppointments()">Appuntamenti</button><button class="ghost" onclick="viewLeaderboard()">Classifiche</button><button class="ghost" onclick="viewCommissions()">Provvigioni</button><button class="ghost" onclick="viewVendite()">Vendite e Riordini</button><button class="ghost" onclick="viewGI()">GI &amp; Scadenzario</button><button class="ghost" onclick="viewReport()">Report</button><button class="ghost" onclick="viewClients()">Clienti</button><button class="ghost" onclick="viewTeam()">Squadra</button>'+(s?'<button class="ghost" onclick="viewUsers()">Utenti</button>':"")+'<button onclick="logout()">Logout</button></div></div>'+Z}function Ue(){if(!Be())return;if(!document.getElementById("bp_nav_contrast_css")){const Y="\n      @media (min-width: 1024px){\n        .topbar .nav .ghost{\n          background: rgba(255,255,255,.06);\n          border: 1px solid rgba(255,255,255,.18);\n        }\n        .topbar .nav .ghost:hover{\n          background: rgba(255,255,255,.12);\n        }\n      }\n    ",ee=document.createElement("style");ee.id="bp_nav_contrast_css",ee.textContent=Y,document.head.appendChild(ee)}const m=document.getElementById("app"),s=document.querySelector(".topbar"),D=je();s?s.outerHTML=D:m&&m.insertAdjacentHTML("afterbegin",D);try{Xt()}catch(Y){}try{Qt()}catch(Y){}try{en()}catch(Y){}if(!document.getElementById("bp-unified-filters-css")){const Y="\n      /* Nested inputs align in two columns inside unified filters */\n      .uf .row .row{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }\n\n      @media (max-width: 980px){\n        .uf input, .uf select{ min-width: 0; width: 100%; }\n        .uf .row > div{ flex: 1 1 180px; min-width: 0; }\n\n        /* Squadra admin bar: grid on small screens */\n        #t_adminbar{ display:grid !important; grid-template-columns: 1fr 1fr; align-items:end; gap:10px; }\n        #t_adminbar > div{ min-width: 0; }\n        #t_adminbar .row{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }\n      }\n\n      @media (max-width: 560px){\n        #t_adminbar{ grid-template-columns: 1fr; }\n      }\n    ",ee=document.createElement("style");ee.id="bp-unified-filters-css",ee.textContent=Y,document.head.appendChild(ee)}const Z=document.getElementById("hamb");Z&&(Z.onclick=function(){mt()});const H=document.getElementById("drawer");H&&H.addEventListener("click",function(Y){Y.target.id==="drawer"&&mt(!1)}),document.removeEventListener("keydown",St,!1),document.addEventListener("keydown",St,!1)}function St(m){if(m&&m.key==="Escape"){const s=document.getElementById("drawer");s&&s.classList.contains("open")&&mt(!1)}}function mt(m){const s=document.getElementById("drawer");if(!s)return;const D=typeof m=="boolean"?m:!s.classList.contains("open");s.classList.toggle("open",D);const Z=document.getElementById("hamb");Z&&Z.setAttribute("aria-expanded",String(D)),document.body.classList.toggle("no-scroll",D)}let It=null;function tn(){clearTimeout(It),It=setTimeout(Ue,60)}function Ge(m){return document.querySelector(m)}function yt(m){return Array.from(document.querySelectorAll(m))}(function(){const m=window.BP=window.BP||{},s=m.ICS=m.ICS||{};function D(O){if(!O)return"";if(/[Zz]|[+\-]\d{2}:\d{2}$/.test(String(O)))return new Date(O).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z").slice(0,15)+"Z";const[re,ie="00:00"]=String(O).split("T"),[ye,we,le]=re.split("-").map(Number),[se,ve]=ie.split(":").map(Number);return new Date(ye,we-1,le,se,ve,0,0).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z").slice(0,15)+"Z"}function Z(O){return(O||"").replace(/\\/g,"\\\\").replace(/;/g,"\\;").replace(/,/g,"\\,").replace(/\n/g,"\\n")}function H(O){if(O.length<=74)return[O];const ie=[];let ye=0;for(;ye<O.length;){const we=O.slice(ye,ye+74);ie.push(ye===0?we:" "+we),ye+=74}return ie}function Y(O){const re=(O&&O.id||"bp-"+Date.now())+"@bpapp",ie=O&&O.client?"Appuntamento ¬∑ "+O.client:"Appuntamento",ye=D(O&&O.start),we=D(O&&O.end),le=D(new Date().toISOString().slice(0,16)),se=[];O&&O.type&&se.push("Tipo: "+O.type),O&&O.vss&&se.push("VSS: "+O.vss),O&&O.vsdPersonal&&se.push("VSD Personale: "+O.vsdPersonal),O&&O.notes&&se.push("Note: "+O.notes);const ve=Z(se.join("\n")),ce=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//BPApp//Calendario//IT","CALSCALE:GREGORIAN","METHOD:PUBLISH","BEGIN:VEVENT","UID:"+re,"DTSTAMP:"+le,ye?"DTSTART:"+ye:"",we?"DTEND:"+we:"","SUMMARY:"+Z(ie),ve?"DESCRIPTION:"+ve:"","END:VEVENT","END:VCALENDAR"].filter(Boolean),xe=[];return ce.forEach(ge=>xe.push.apply(xe,H(ge))),xe.join("\r\n")}function ee(){try{const O=navigator.userAgent||navigator.vendor||"",re=/iP(ad|hone|od)/.test(O),ie=/^((?!chrome|android|crios|fxios|edgi).)*safari/i.test(O);return re||ie}catch(O){return!1}}function te(O){try{const re=Y(O),ie=O&&O.start?String(O.start).split("T")[0]:"evento",ye=(O&&O.client||"appuntamento").trim().replace(/[^\w\-]+/g,"_").slice(0,40),we="bp_".concat(ye,"_").concat(ie,".ics");if(ee())try{const ve="data:text/calendar;charset=utf-8,"+encodeURIComponent(re),ce=document.createElement("a");return ce.href=ve,ce.setAttribute("target","_blank"),ce.setAttribute("download",we),document.body.appendChild(ce),ce.click(),ce.remove(),!0}catch(ve){try{return window.location.assign("data:text/calendar;charset=utf-8,"+encodeURIComponent(re)),!0}catch(ce){try{logger.error(ce)}catch(xe){}return!1}}const le=new Blob([re],{type:"text/calendar;charset=utf-8"}),se=document.createElement("a");return se.href=URL.createObjectURL(le),se.download=we,document.body.appendChild(se),se.click(),setTimeout(()=>{try{URL.revokeObjectURL(se.href)}catch(ve){}se.remove()},50),!0}catch(re){try{logger.error(re)}catch(ie){}return!1}}s.makeIcsForAppointment=Y,s.downloadIcsForAppointment=te,window.icsFromAppt=window.icsFromAppt||function(O){return Y(O)},window.downloadICS=window.downloadICS||function(O,re){try{var ie=window.__icsSanitize?__icsSanitize(O):O||"evento";/\.ics$/i.test(ie)||(ie+=".ics");var ye=new Blob([re],{type:"text/calendar;charset=utf-8"}),we=document.createElement("a");we.href=URL.createObjectURL(ye),we.download=ie,document.body.appendChild(we),we.click(),setTimeout(function(){URL.revokeObjectURL(we.href),we.remove()},50)}catch(le){logger.error(le)}}})();(function(){var m=document.getElementById("app");window.$1=window.$1||Ge,window.$all=window.$all||yt,window.addXP=window.addXP||function(){},typeof window.logger!="object"&&(window.logger=["debug","info","log","warn","error"].reduce((f,y)=>(f[y]=(console[y]||console.log).bind(console),f),{})),typeof window.haptic!="function"&&(window.haptic=window.BP&&BP.Haptics&&BP.Haptics.impact?BP.Haptics.impact:function(){}),(function(){const f=window.__miniCharts=window.__miniCharts||{};function y(b,U,A){const x=b.getContext("2d");b.width=b.clientWidth||320,b.height=b.clientHeight||80,x.clearRect(0,0,b.width,b.height);const L=Math.max(1,...A),C=A.length>1?(b.width-8)/(A.length-1):0;x.strokeStyle="#2e6cff",x.lineWidth=2,x.beginPath();for(let _=0;_<A.length;_++){const B=4+_*C,G=b.height-6-A[_]/L*(b.height-12);_===0?x.moveTo(B,G):x.lineTo(B,G)}x.stroke(),x.fillStyle="#2e6cff";for(let _=0;_<A.length;_++){const B=4+_*C,G=b.height-6-A[_]/L*(b.height-12);x.beginPath(),x.arc(B,G,2,0,Math.PI*2),x.fill()}}function z(b,U){try{const A=Array.isArray(b)?b.length:0;if(!A)return{autoSkip:!0,maxRotation:0,minRotation:0};const x=Math.max(0,...b.map(_=>String(_||"").length)),L=Math.max(28,Math.min(90,Math.round(x*7)));return A*L>(U||320)*1.2?{autoSkip:!0,maxRotation:45,minRotation:45,callback:_=>String(_||"")}:{autoSkip:!0,maxRotation:0,minRotation:0,callback:_=>String(_||"")}}catch(A){return{autoSkip:!0,maxRotation:0,minRotation:0}}}window.computeTickOptions=z,window.drawFullLine=function(b,U,A){const x=document.getElementById(b);if(!x)return;if(x.width=x.clientWidth||x.width||320,x.height=x.clientHeight||x.height||80,typeof Chart>"u"){y(x,U,A);return}const L=String(b),C=z(U,x.width||320);if(f[L]&&f[L].canvas!==x){try{f[L].destroy()}catch(_){}delete f[L]}if(f[L]){const _=f[L];_.data.labels=U,_.data.datasets[0].data=A,_.options.scales.x.ticks=z(U,x.width||320),_.update()}else{const _=x.getContext("2d");f[L]=new Chart(_,{type:"line",data:{labels:U,datasets:[{label:"",data:A,borderColor:"#2e6cff",backgroundColor:"rgba(46,108,255,0.10)",borderWidth:2,tension:.3,pointRadius:3,pointHoverRadius:5,fill:!1}]},options:{responsive:!1,maintainAspectRatio:!1,animation:!1,animations:!1,plugins:{legend:{display:!1}},scales:{x:{grid:{display:!1},ticks:C},y:{beginAtZero:!0}}}})}}})();function s(){document.title="Battle Plan ‚Äì Login";var f='<div class="hero" id="hero"><div class="layer glow"></div><div class="layer grid"></div><div class="title">Pianifica. Eroga. Vinci. <span class="small muted">BP ‚Äì stile gaming</span></div></div><div class="wrap"><div class="grid"><div class="card"><h3>Accedi</h3><form id="loginForm" autocomplete="on"><div class="row"><div><label>Email</label><input id="li_email" name="email" type="email" autocomplete="username" required></div><div><label>Password</label><input id="li_password" name="password" type="password" autocomplete="current-password" required></div></div><div class="row"><label class="small"><input type="checkbox" id="li_remember" checked> Rimani collegato</label></div><div class="right" style="margin-top:8px"><button type="submit" id="btnLogin">Accedi</button></div></form></div><div class="card"><h3>Registrati</h3><form id="regForm" autocomplete="on"><div class="row"><div><label>Nome</label><input id="re_name" name="name" type="text" required></div><div><label>Email</label><input id="re_email" name="email" type="email" autocomplete="username" required></div><div><label>Password</label><input id="re_password" name="new-password" type="password" autocomplete="new-password" required></div></div><div class="right" style="margin-top:8px"><button type="submit" id="btnRegister">Registrati</button></div></form></div></div></div>';m.innerHTML=f;var y=document.getElementById("hero");y&&y.addEventListener("pointermove",function(U){var A=y.getBoundingClientRect();y.style.setProperty("--gx",(U.clientX-A.left)/A.width*100+"%"),y.style.setProperty("--gy",(U.clientY-A.top)/A.height*100+"%")});var z=document.getElementById("loginForm"),b=document.getElementById("regForm");z.addEventListener("submit",function(U){U.preventDefault();var A=document.getElementById("btnLogin");A.disabled=!0;var x=document.getElementById("li_email").value.trim().toLowerCase(),L=document.getElementById("li_password").value,C=document.getElementById("li_remember").checked;Le("/api/login",{email:x,password:L}).then(function(_){if(typeof _=="string")try{_=JSON.parse(_)}catch(B){}Ut(_.token,C),Vt(_.user),fe("Bentornato "+_.user.name+"!"),window.addXP(10),re(),Ue(),window.BPPush&&window.BPPush.subscribe()},function(_){fe("Credenziali errate"),logger.error(_)}).catch(function(_){logger.error(_)}).finally(function(){A.disabled=!1})}),b.addEventListener("submit",function(U){U.preventDefault();var A=document.getElementById("btnRegister");A.disabled=!0;var x=document.getElementById("re_name").value.trim(),L=document.getElementById("re_email").value.trim().toLowerCase(),C=document.getElementById("re_password").value;Le("/api/register",{name:x,email:L,password:C}).then(function(){fe("Registrazione ok. Ora accedi"),st(),window.addXP(20),window.scrollTo({top:0,behavior:"smooth"})}).catch(function(_){fe("Email gi√† registrata?"),logger.error(_)}).finally(function(){A.disabled=!1})})}function D(f){const y=new Date,z=y.getFullYear(),b=y.getMonth()+1,U=Ne(y),A=Math.floor((b-1)/3)+1,x=2e3,L=2100,C=(function(){let I="";for(let w=x;w<=L;w++)I+='<option value="'.concat(w,'" ').concat(w===z?"selected":"",">").concat(w,"</option>");return I})(),_=(function(){let I="";for(let w=1;w<=12;w++)I+='<option value="'.concat(w,'" ').concat(w===b?"selected":"",">").concat(w,"</option>");return I})(),B=(function(){let I="";for(let w=1;w<=53;w++)I+='<option value="'.concat(w,'" ').concat(w===U?"selected":"",">").concat(w,"</option>");return I})(),G=(function(){let I="";for(let w=1;w<=4;w++)I+='<option value="'.concat(w,'" ').concat(w===A?"selected":"",">Q").concat(w,"</option>");return I})();return'<div class="uf"><div class="row"><div><label>Granularit√†</label><select id="'+f+'_gran"><option value="settimanale">Settimanale</option><option value="mensile" selected>Mensile</option><option value="trimestrale">Trimestrale</option><option value="semestrale">Semestrale</option><option value="annuale">Annuale</option><option value="ytd">Anno corrente (YTD)</option><option value="ltm">Ultimi 12 mesi (LTM)</option></select></div><div id="'+f+'_wrap_week" style="display:none"><label>Settimana ISO</label><div class="row"><select id="'+f+'_week">'+B+'</select><select id="'+f+'_year_w">'+C+'</select></div></div><div id="'+f+'_wrap_month"><label>Mese</label><div class="row"><select id="'+f+'_month">'+_+'</select><select id="'+f+'_year_m">'+C+'</select></div></div><div id="'+f+'_wrap_quarter" style="display:none"><label>Trimestre</label><div class="row"><select id="'+f+'_quarter">'+G+'</select><select id="'+f+'_year_q">'+C+'</select></div></div><div id="'+f+'_wrap_sem" style="display:none"><label>Semestre</label><div class="row"><select id="'+f+'_sem"><option value="1">1¬∞</option><option value="2">2¬∞</option></select><select id="'+f+'_year_s">'+C+'</select></div></div><div id="'+f+'_wrap_year" style="display:none"><label>Anno</label><select id="'+f+'_year">'+C+'</select></div><div class="actions"><button id="'+f+'_refresh" class="ghost">Aggiorna</button></div></div></div>'}(function(){const f=[];window.onUnifiedRangeChange=function(y){typeof y=="function"&&f.push(y)},window.emitUnifiedRangeChange=function(y){for(const z of f)try{z(y)}catch(b){logger.error(b)}}})();function Z(f){return f==="d"||f==="dash"?"dash":f==="cm"||f==="comm"?"comm":f==="tg"||f==="t"||f==="team"?"t":f}function H(f,y){function z(){const U=document.getElementById(f+"_gran").value;["week","month","quarter","sem","year"].forEach(x=>{const L=document.getElementById(f+"_wrap_"+x);L&&(L.style.display="none")}),U==="settimanale"?document.getElementById(f+"_wrap_week").style.display="":U==="mensile"?document.getElementById(f+"_wrap_month").style.display="":U==="trimestrale"?document.getElementById(f+"_wrap_quarter").style.display="":U==="semestrale"?document.getElementById(f+"_wrap_sem").style.display="":U==="annuale"&&(document.getElementById(f+"_wrap_year").style.display="")}["gran","week","year_w","month","year_m","quarter","year_q","sem","year_s","year"].forEach(U=>{const A=document.getElementById(f+"_"+U);A&&(A.onchange=()=>{z(),y&&y(),window.emitUnifiedRangeChange(Z(f))},A.oninput=()=>{z()})});const b=document.getElementById(f+"_refresh");b&&(b.onclick=()=>{y&&y(),window.emitUnifiedRangeChange(Z(f))}),z()}function Y(f){var y=new Date;function z(R,T){var q=document.getElementById(f+"_"+R),ne=q?parseInt(q.value,10):NaN;return isFinite(ne)?ne:T}var b=document.getElementById(f+"_gran"),U=b?b.value:"mensile",A={type:U,start:null,end:null};if(U==="settimanale"){var x=z("year_w",y.getFullYear()),L=Math.max(1,Math.min(53,z("week",Ne(y)))),C=et(x,L);return A.start=C.start,A.end=C.end,A}if(U==="mensile"){var _=z("year_m",y.getFullYear()),B=Math.max(1,Math.min(12,z("month",y.getMonth()+1)));return A.start=new Date(_,B-1,1),A.end=new Date(_,B,0,23,59,59,999),A}if(U==="trimestrale"){var G=z("year_q",y.getFullYear()),I=Math.max(1,Math.min(4,z("quarter",Math.floor(y.getMonth()/3)+1)));return A.start=new Date(G,(I-1)*3,1),A.end=new Date(G,I*3,0,23,59,59,999),A}if(U==="semestrale"){var w=z("year_s",y.getFullYear()),g=z("sem",y.getMonth()<6?1:2);return A.start=new Date(w,g===1?0:6,1),A.end=new Date(w,g===1?6:12,0,23,59,59,999),A}if(U==="annuale"){var P=z("year",y.getFullYear());return A.start=new Date(P,0,1),A.end=new Date(P,11,31,23,59,59,999),A}if(U==="ytd"){var N=new Date(y.getFullYear(),y.getMonth()+1,0,23,59,59,999);return A.start=new Date(y.getFullYear(),0,1),A.end=N,A}if(U==="ltm"){var M=new Date(y.getFullYear(),y.getMonth()+1,0,23,59,59,999),E=new Date(M.getFullYear(),M.getMonth()-11,1);return A.start=E,A.end=M,A}return A.type="mensile",A.start=new Date(y.getFullYear(),y.getMonth(),1),A.end=new Date(y.getFullYear(),y.getMonth()+1,0,23,59,59,999),A}function ee(f){return f==="ytd"||f==="ltm"?"mensile":f}window.effectivePeriodType=ee;function te(f,y){var z=ee(f||"mensile"),b=y?new Date(y):new Date,U=b.getUTCFullYear(),A=[];function x(o,r){A.push({s:o.getTime(),e:r.getTime()})}function L(o,r,d){return new Date(Date.UTC(o,r,d))}function C(o){return new Date(o.getTime()+24*3600*1e3-1)}function _(o,r){return new Date(Date.UTC(o,r+1,0))}if(z==="settimanale"){var B=new Date(Date.UTC(b.getUTCFullYear(),b.getUTCMonth(),b.getUTCDate())),G=(B.getUTCDay()+6)%7;B.setUTCDate(B.getUTCDate()-G);for(var I=52;I>=0;I--){var w=new Date(B);w.setUTCDate(B.getUTCDate()-I*7);var g=new Date(w);g.setUTCDate(w.getUTCDate()+6),g.setUTCHours(23,59,59,999),x(w,g)}return A}if(z==="mensile"){for(var P=new Date(Date.UTC(b.getUTCFullYear(),b.getUTCMonth(),1)),N=23;N>=0;N--){var M=new Date(Date.UTC(P.getUTCFullYear(),P.getUTCMonth()-N,1));x(M,C(_(M.getUTCFullYear(),M.getUTCMonth())))}return A}if(z==="trimestrale"){for(var E=Math.floor(b.getUTCMonth()/3),R=11;R>=0;R--){var T=E-R,q=U+Math.floor(T/4),ne=(T%4+4)%4,w=L(q,ne*3,1),g=C(new Date(Date.UTC(q,ne*3+3,0)));x(w,g)}return A}if(z==="semestrale"){for(var a=b.getUTCMonth()<6?0:1,e=5;e>=0;e--){var i=a-e,t=U+Math.floor(i/2),l=(i%2+2)%2,h=l===0?0:6,u=L(t,h,1),c=C(new Date(Date.UTC(t,h+6,0)));x(u,c)}return A}for(var p=2;p>=0;p--){var n=U-p;x(L(n,0,1),C(new Date(Date.UTC(n,12,0))))}return A}function O(f,y){var z=ee(f||"mensile");return(y||[]).map(function(b){var U=new Date(b.s);return z==="settimanale"?"W"+Ne(U)+" "+U.getUTCFullYear():z==="mensile"?String(U.getUTCMonth()+1).padStart(2,"0")+"/"+U.getUTCFullYear():z==="trimestrale"?"Q"+(Math.floor(U.getUTCMonth()/3)+1)+" "+U.getUTCFullYear():z==="semestrale"?(U.getUTCMonth()<6?"S1 ":"S2 ")+U.getUTCFullYear():String(U.getUTCFullYear())})}function re(){if(!Be())return s();document.title="Battle Plan ‚Äì Dashboard",m.innerHTML=je()+'<div class="wrap"><div class="card"><b>Filtro</b><div class="row uf-row" style="margin-top:6px;align-items:flex-end;gap:16px;flex-wrap:wrap"><div><label>Modalit√†</label><select id="dash_mode" name="mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div><div><label>Consulente</label><select id="dash_cons"><option value="">Tutti</option></select></div></div>'+D("dash")+'</div><div class="grid" id="kpiGrid"><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>VSS</b><span id="kpi_vss" class="big">‚Äî</span></div><canvas id="d_mini_vss" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>VSD personale</b><span id="kpi_vsd" class="big">‚Äî</span></div><canvas id="d_mini_vsdpersonale" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>VSD indiretto</b><span id="kpi_vsd_ind" class="big">‚Äî</span></div><canvas id="d_mini_vsdindiretto" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>GI</b><span id="kpi_gi" class="big">‚Äî</span></div><canvas id="d_mini_gi" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>NNCF</b><span id="kpi_nncf" class="big">‚Äî</span></div><canvas id="d_mini_nncf" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>Tot Provvigioni</b><span id="kpi_provv" class="big">‚Äî</span></div><canvas id="d_mini_provv" width="320" height="90"></canvas></div></div><div class="card"><b>Ultimi appuntamenti</b><div id="lastApps" class="row" style="margin-top:8px"></div></div><div class="card"><b>Ultimi BP inviati</b><div id="lastBPs" class="row" style="margin-top:8px"></div></div></div>',Ue();function f(g,P){var N=document.getElementById(g);N&&(N.textContent=P)}function y(g){var P=Number(g)||0;return P.toLocaleString("it-IT")+"‚Ç¨"}function z(g){var P=Number(g)||0;return String(Math.round(P))}function b(g){return String(g).replace(/[&<>'"]/g,P=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[P])}(function(){Ie("/api/usernames").then(function(P){var N=P&&P.users||[],M=document.getElementById("dash_cons");M&&(M.innerHTML='<option value="">Tutti</option>'+N.map(function(E){return'<option value="'+b(String(E.id))+'">'+b(E.name||E.email||"User #"+E.id)+"</option>"}).join(""))}).catch(function(){})})();function U(g,P){return P==="settimanale"?window.isoWeekNum?window.isoWeekNum(g):Math.ceil(g.getDate()/7):P==="mensile"||P==="ytd"||P==="ltm"?g.getMonth()+1:P==="trimestrale"?Math.floor(g.getMonth()/3)+1:P==="semestrale"?g.getMonth()<6?1:2:g.getFullYear()}function A(g){if(typeof te=="function")return(te(g,new Date)||[]).map(function(S){return{s:S.s,e:S.e}});var P=new Date,N=[];function M(S,V){N.push({s:S.getTime(),e:V.getTime()})}function E(S){var V=new Date(S);return V.setHours(23,59,59,999),V}function R(S,V){return new Date(S,V+1,0,23,59,59,999)}var T=String(g||"mensile").toLowerCase();if(T==="settimanale"){var q=new Date(P),ne=(q.getDay()+6)%7;q.setDate(q.getDate()-ne),q.setHours(0,0,0,0);for(var a=52;a>=0;a--){var e=new Date(q);e.setDate(e.getDate()-a*7);var i=new Date(e);i.setDate(e.getDate()+6),i.setHours(23,59,59,999),M(e,i)}return N}if(T==="mensile"||T==="ytd"||T==="ltm"){if(T==="ytd")for(var t=0;t<=P.getMonth();t++){var l=new Date(P.getFullYear(),t,1);M(l,R(P.getFullYear(),t))}else for(var h=T==="ltm"?12:24,u=new Date(P.getFullYear(),P.getMonth(),1),c=h-1;c>=0;c--){var e=new Date(u.getFullYear(),u.getMonth()-c,1);M(e,R(e.getFullYear(),e.getMonth()))}return N}if(T==="trimestrale"){for(var p=Math.floor(P.getMonth()/3)*3,n=new Date(P.getFullYear(),p,1),o=11;o>=0;o--){var r=new Date(n.getFullYear(),n.getMonth()-o*3,1);M(r,E(new Date(r.getFullYear(),r.getMonth()+3,0)))}return N}if(T==="semestrale"){for(var d=P.getMonth()<6?0:6,v=new Date(P.getFullYear(),d,1),e=5;e>=0;e--){var k=new Date(v.getFullYear(),v.getMonth()-e*6,1);M(k,E(new Date(k.getFullYear(),k.getMonth()+6,0)))}return N}for(var W=2;W>=0;W--){var J=new Date(P.getFullYear()-W,0,1);M(J,E(new Date(J.getFullYear(),12,0)))}return N}function x(g){switch(String(g)){case"provv_gi":return"ProvvGI";case"provv_vsd":return"ProvvVSD";case"tot_provv":return"TotProvvigioni";default:return g}}function L(g,P,N,M){var E=M||Y("dash"),R=String(E.type||"mensile").toLowerCase(),T=R==="ytd"||R==="ltm"?"mensile":R,q=A(R);function ne(i,t){var l=new Date(t.startDate).getTime(),h=new Date(t.endDate).getTime();return l>=i.s&&h<=i.e}function a(i,t){if(!i)return 0;if(t==="VSDTotale")return Number(i.VSDPersonale||0)+Number(i.VSDIndiretto||0);if(t==="ProvvGI")return Number(i.ProvvGI||0);if(t==="ProvvVSD")return Number(i.ProvvVSD||0);if(t==="TotProvvigioni"){var l=i.TotProvvigioni;return Number(l!=null?l:Number(i.ProvvGI||0)+Number(i.ProvvVSD||0))}return Number(i[t]||0)}var e=(function(){var i=q.length?Fe(new Date(q[0].s)):Fe(new Date),t=q.length?Fe(new Date(q[q.length-1].e)):Fe(new Date),l="?global=1&type="+encodeURIComponent(T)+"&from="+encodeURIComponent(i)+"&to="+encodeURIComponent(t);return N&&(l+="&userId="+encodeURIComponent(N)),l})();return Ie("/api/periods"+e).catch(function(){return Ie("/api/periods"+e.replace("?global=1",""))}).then(function(i){var t=i&&i.periods||[],l=t.filter(function(c){return!(c.type!==T||N&&String(c.userId||c.uid||"")!==String(N))}),h=x(g),u=q.map(function(c){for(var p=0,n=0;n<l.length;n++){var o=l[n];if(ne(c,o)){var r=P==="previsionale"?o.indicatorsPrev||{}:o.indicatorsCons||{};p+=a(r,h)}}return{x:new Date(c.s),y:Math.round(p*100)/100}});return u})}function C(g,P,N){var M=document.getElementById(g);if(M){if(typeof window.drawFullLine=="function"){window.drawFullLine(g,P,N);return}var E=M.getContext("2d");M.width=M.clientWidth||320,M.height=M.clientHeight||80,E.clearRect(0,0,M.width,M.height);var R=Math.max(1,...N),T=N.length>1?(M.width-8)/(N.length-1):0;E.strokeStyle="#2e6cff",E.lineWidth=2,E.beginPath();for(var q=0;q<N.length;q++){var ne=4+q*T,a=M.height-6-N[q]/R*(M.height-12);q===0?E.moveTo(ne,a):E.lineTo(ne,a)}E.stroke()}}function _(){var g=(document.getElementById("dash_mode")||{}).value||"consuntivo",P=Y("dash"),N=ee(P.type||"mensile"),M=new Date(P.start).getTime(),E=new Date(P.end).getTime(),R=(document.getElementById("dash_cons")||{}).value||"";function T(e){return e=Number(e==null?"":e),isFinite(e)?e:0}function q(e){if(!e)return 0;for(var i=["VSDIndiretto","vsdIndiretto","VSD_indiretto","VSDI"],t=0;t<i.length;t++)if(e[i[t]]!=null)return T(e[i[t]]);return e.VSDTotale!=null&&e.VSDPersonale!=null?T(e.VSDTotale)-T(e.VSDPersonale):0}function ne(e){return e?e.TotProvvigioni!=null?T(e.TotProvvigioni):T(e.ProvvGI)+T(e.ProvvVSD):0}var a=(function(){var e=Fe(new Date(M)),i=Fe(new Date(E)),t="?type="+encodeURIComponent(N)+"&from="+encodeURIComponent(e)+"&to="+encodeURIComponent(i);return R&&(t+="&userId="+encodeURIComponent(R)),t})();return Ie("/api/periods"+a).then(function(e){for(var i=e&&e.periods||[],t={VSS:0,VSDPersonale:0,VSDIndiretto:0,GI:0,NNCF:0,PROVV:0},l=0;l<i.length;l++){var h=i[l];if(String(h.type)===String(N)&&!(R&&String(h.userId||h.uid||"")!==String(R))){var u=new Date(h.startDate).getTime(),c=new Date(h.endDate).getTime();if(!(u<M||c>E)){var p=g==="previsionale"?h.indicatorsPrev||{}:h.indicatorsCons||{};t.VSS+=T(p.VSS),t.VSDPersonale+=T(p.VSDPersonale),t.VSDIndiretto+=q(p),t.GI+=T(p.GI),t.NNCF+=T(p.NNCF),t.PROVV+=ne(p)}}}f("kpi_vss",y(t.VSS)),f("kpi_vsd",y(t.VSDPersonale)),f("kpi_vsd_ind",y(t.VSDIndiretto)),f("kpi_gi",y(t.GI)),f("kpi_nncf",z(t.NNCF)),f("kpi_provv",y(t.PROVV))})}function B(){var g=(document.getElementById("dash_mode")||{}).value||"consuntivo",P=(document.getElementById("dash_cons")||{}).value||"",N=Y("dash"),M=String(N.type||"mensile").toLowerCase(),E=A(M),R=typeof O=="function"?O(M,E):E.map(function(q){return U(new Date(q.s),M)});function T(q,ne){var a=q.map(function(e){return e.y});C(ne,R,a)}Promise.all([L("VSS",g,P||null,N),L("VSDPersonale",g,P||null,N),L("VSDIndiretto",g,P||null,N),L("GI",g,P||null,N),L("NNCF",g,P||null,N),L("TotProvvigioni",g,P||null,N)]).then(function(q){T(q[0],"d_mini_vss"),T(q[1],"d_mini_vsdpersonale"),T(q[2],"d_mini_vsdindiretto"),T(q[3],"d_mini_gi"),T(q[4],"d_mini_nncf"),T(q[5],"d_mini_provv")}).catch(function(q){logger.error(q)})}function G(){var g=(document.getElementById("dash_cons")||{}).value||"",P=(typeof Y=="function"?Y("dash"):{})||{},N=typeof ee=="function"?ee(P.type||"mensile"):P.type||"mensile";(function(){var e=document.getElementById("lastApps");if(e){var i=e.parentElement;if(!document.getElementById("nextApps")){var t=document.createElement("div");t.className="card",t.innerHTML='<b>Prossimi appuntamenti (oggi + domani)</b><div id="nextApps" style="margin-top:8px"></div>',i.parentElement.insertBefore(t,i)}}})();function M(a){return'<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px">'+a+"</div>"}function E(a){return a=String(a||"").toLowerCase(),a.indexOf("mezza")>-1?240:a.indexOf("giorn")>-1||a.indexOf("formaz")>-1||a.indexOf("mbs")>-1?570:a.indexOf("sottoprod")>-1?240:(a.indexOf("vend")>-1,90)}function R(a){var e=new Date(a.start),i=new Date(a.end);(!(i instanceof Date)||isNaN(i)||i<e)&&(i=new Date(e.getTime()+E(a.type||"vendita")*6e4));var t=ot(e)+" "+_t(e)+"‚Äì"+(("0"+i.getHours()).slice(-2)+":"+("0"+i.getMinutes()).slice(-2)),l=a.nncf?" ¬∑ NNCF ‚úÖ":"",h=String(a.type||"").toLowerCase(),u;return h.indexOf("mbs")>-1?u="VSD ind "+y(a.vsdIndiretto||0):h.indexOf("sottoprod")>-1?u="Tel "+z(a.telefonate||0)+" ¬∑ AppFissati "+z(a.appFissati||0):h.indexOf("formaz")>-1?u="":u="VSS "+y(a.vss||0)+" ¬∑ VSD "+y(a.vsdPersonal||0)+l,'<div class="card lastApp" data-aid="'+b(String(a.id||""))+'" style="cursor:pointer"><div class="small muted">'+b(t)+" ¬∑ "+b(a.type||"manuale")+'</div><div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><div><b>'+b(a.client||"")+'</b></div><div class="row" style="gap:6px"><button class="ghost btn-ics" title="Esporta .ics" data-ics="'+b(String(a.id||""))+'">üìÖ</button></div></div>'+(u?'<div class="small">'+u+"</div>":"")+"</div>"}function T(a){return a&&Object.keys(a).length>0}function q(a){return a=Number(a||0),isFinite(a)?a:0}var ne=(function(){var a=Fe(new Date(P.start)),e=Fe(new Date(P.end)),i="?type="+encodeURIComponent(N)+"&from="+encodeURIComponent(a)+"&to="+encodeURIComponent(e);return g&&(i+="&userId="+encodeURIComponent(g)),i})();Promise.all([Ie("/api/appointments"),Ie("/api/periods"+ne)]).then(function(a){var e=a[0]&&a[0].appointments||[],i=a[1]&&a[1].periods||[];(function(){var l=document.getElementById("nextApps");if(l){var h=new Date,u=new Date(h.getFullYear(),h.getMonth(),h.getDate(),0,0,0,0),c=new Date(h.getFullYear(),h.getMonth(),h.getDate()+2,0,0,0,0),p=e.filter(function(n){var o=new Date(n.start).getTime(),r=o>=u.getTime()&&o<c.getTime(),d=g?String(n.userId||n.uid||"")===String(g):!0;return r&&d}).sort(function(n,o){return new Date(n.start)-new Date(o.start)});l.innerHTML=p.length?M(p.map(R).join("")):'<div class="muted">Nessun appuntamento tra oggi e domani</div>',l.querySelectorAll(".lastApp[data-aid]").forEach(function(n){n.addEventListener("click",function(){try{Ke("bp_edit_aid",n.getAttribute("data-aid"))}catch(o){}we()})}),l.querySelectorAll("button[data-ics]").forEach(function(n){n.addEventListener("click",function(o){o.stopPropagation();var r=n.getAttribute("data-ics"),d=p.find(v=>String(v.id)===String(r))||e.find(v=>String(v.id)===String(r));if(!d){fe("Appuntamento non trovato");return}if(window.BP&&BP.ICS&&typeof BP.ICS.downloadIcsForAppointment=="function")if(BP.ICS.downloadIcsForAppointment(d)){typeof haptic=="function"&&haptic("medium");try{document.dispatchEvent(new Event("ics:exported"))}catch(k){}fe(".ics esportato")}else fe("Export .ics non disponibile");else fe("Export .ics non disponibile")})})}})(),(function(){var l=document.getElementById("lastApps");if(l){var h=e.filter(function(u){return g?String(u.userId||u.uid||"")===String(g):!0}).sort(function(u,c){return new Date(c.start)-new Date(u.start)}).slice(0,6);l.innerHTML=h.length?M(h.map(R).join("")):'<div class="muted">Nessun appuntamento</div>',l.querySelectorAll(".lastApp[data-aid]").forEach(function(u){u.addEventListener("click",function(){try{Ke("bp_edit_aid",u.getAttribute("data-aid"))}catch(c){}we()})}),l.querySelectorAll("button[data-ics]").forEach(function(u){u.addEventListener("click",function(c){c.stopPropagation();var p=u.getAttribute("data-ics"),n=h.find(o=>String(o.id)===String(p))||e.find(o=>String(o.id)===String(p));if(!n){fe("Appuntamento non trovato");return}if(window.BP&&BP.ICS&&typeof BP.ICS.downloadIcsForAppointment=="function")if(BP.ICS.downloadIcsForAppointment(n)){typeof haptic=="function"&&haptic("medium");try{document.dispatchEvent(new Event("ics:exported"))}catch(r){}fe(".ics esportato")}else fe("Export .ics non disponibile");else fe("Export .ics non disponibile")})})}})(),(function(){var l=document.getElementById("lastBPs");if(l){var h=i.filter(function(c){return!(String(c.type)!==String(N)||g&&String(c.userId||c.uid||"")!==String(g))}).sort(function(c,p){return new Date(p.endDate)-new Date(c.endDate)}).slice(0,3),u=h.map(function(c){var p=rt(c.type,c.startDate),n=c.indicatorsPrev||{},o=c.indicatorsCons||{},r=T(o),d=r?o:n,v=q(d.VSS),k=q(d.VSDPersonale),W=q(d.VSDIndiretto),J=q(d.GI),S=q(d.NNCF),V=k+W;return'<div class="card lastBP" data-pid="'+b(String(c.id||""))+'" style="cursor:pointer;flex:1 1 320px"><div style="display:flex;align-items:center;gap:8px"><div><b>'+b(p)+'</b></div><span class="chip small">'+(r?"Consuntivo":"Previsionale")+'</span></div><div class="row" style="margin-top:6px;gap:8px;flex-wrap:wrap"><span class="chip small">VSS <b>'+y(v)+'</b></span><span class="chip small">VSD <b>'+y(V)+'</b> <span class="muted">(P '+y(k)+" ¬∑ I "+y(W)+')</span></span><span class="chip small">GI <b>'+y(J)+'</b></span><span class="chip small">NNCF <b>'+z(S)+"</b></span></div></div>"}).join("");l.innerHTML=u?M(u):'<div class="muted">Nessun BP</div>',l.querySelectorAll(".lastBP[data-pid]").forEach(function(c){c.addEventListener("click",function(){try{Ke("bp_open_period",{id:c.getAttribute("data-pid"),mode:!1})}catch(p){}ye()})})}})()}).catch(function(a){logger.error(a)})}H("dash",function(){typeof haptic=="function"&&haptic("light"),_(),B(),G()});var I=document.getElementById("dash_mode");I&&(I.onchange=function(){typeof haptic=="function"&&haptic("light"),_(),B(),G()});var w=document.getElementById("dash_cons");w&&(w.onchange=function(){typeof haptic=="function"&&haptic("light"),_(),B(),G()}),_(),B(),G(),typeof kickFinal=="function"&&kickFinal("dashboard")}function ie(){if(!Be())return s();document.title="Battle Plan ‚Äì Calendario";function f(G){return _t(G)}if(!document.getElementById("cal_dynamic_css")){var y="\n      /* ============== CALENDAR ============== */\n      #cal_container{ overflow-x:auto; -webkit-overflow-scrolling:touch; }\n      #cal_container .calendar{ min-width: 860px; }\n\n      .calendar{ display:grid; grid-template-columns: 44px repeat(7, 1fr); gap:10px; }\n      .calendar .weekLabel{ color:var(--muted); font-size:12px; display:flex; align-items:center; justify-content:center; }\n\n      .calendar .day{\n        min-height:120px; background: var(--card);\n        border:2px solid var(--hair2); border-radius:14px; padding:8px;\n        display:flex; flex-direction:column; gap:3px; overflow:hidden;\n      }\n      .calendar .day.today{\n        outline: 2px solid var(--accent);\n        box-shadow: 0 0 0 2px rgba(0,0,0,.06) inset;\n      }\n      .calendar .day .dnum{ font-weight:800; }\n      .calendar .day .small{\n        font-size:12px; line-height:1.15;\n        white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:100%;\n      }\n      .calendar .day .tag{ padding:2px 6px; border-radius:999px; border:1px solid var(--hair2); font-size:11px; align-self:flex-start; }\n      .calendar .day.busy0{ border-color:#27ae60; background:rgba(39,174,96,.08); }\n      .calendar .day.busy1{ border-color:#ff9f1a; background:rgba(255,159,26,.10); }\n      .calendar .day.busy2{ border-color:#7d1731; background:rgba(125,23,49,.12); }\n      .calendar .day.dense .small{ font-size:11px; line-height:1.1; }\n      .calendar .day.dense .tag{ transform:scale(.9); transform-origin:left top; }\n\n      @media (max-width: 900px){\n        .calendar{ grid-template-columns: 36px repeat(7, 1fr); }\n        .calendar .weekLabel{ display:flex !important; font-size:11px; }\n        .calendar .day{ min-height:92px; padding:6px; }\n        .calendar .day .dnum{ font-size:16px; }\n        .calendar .day .small{ white-space: normal !important; overflow: visible !important; text-overflow: clip !important; }\n        .calendar .day.dense .small{ font-size:clamp(9px,2.4vw,11px); }\n        .calendar .day .tag{ font-size:10px; }\n      }\n\n      .cal-filters .chip{\n        display:inline-flex; align-items:center; gap:6px;\n        padding:6px 10px; border-radius:999px; border:1px solid var(--hair2);\n      }\n    ",z=document.createElement("style");z.id="cal_dynamic_css",z.textContent=y,document.head.appendChild(z)}var b=new Date,U=Fe(ft(b)).slice(0,7);m.innerHTML=je()+'<div class="wrap"><div class="card"><div class="row" style="align-items:flex-end;gap:12px;flex-wrap:wrap"><div class="row" style="align-items:flex-end;gap:8px"><button id="cal_prev" class="ghost" title="Mese precedente">‚óÄ</button><div><label>Mese</label><input type="month" id="cal_month" value="'+U+'"></div><button id="cal_next" class="ghost" title="Mese successivo">‚ñ∂</button></div><div class="cal-filters"><label class="chip small"><input type="checkbox" id="only_free"> Solo giorni liberi</label> <label class="chip small"><input type="checkbox" id="only_4h"> Solo slot ‚â• 4h</label></div><button id="cal_add" class="ghost">Aggiungi appuntamento</button><div class="right" style="margin-left:auto"><button id="cal_refresh" class="ghost">Aggiorna</button></div></div></div><div id="cal_container"></div><div id="cal_results" class="card" style="margin-top:8px;display:none"></div><div id="cal_day_box" class="card" style="margin-top:8px;display:none"></div><div class="card" id="cal_free_slots" style="margin-top:8px;display:none"></div></div>',Ue();function A(G,I,w){Promise.all([Ie("/api/appointments"),Ie("/api/availability?from="+G+"-"+ze(I)+"-01&to="+G+"-"+ze(I)+"-"+ze(new Date(G,I,0).getDate()))]).then(function(g){var P=g[0]&&g[0].appointments?g[0].appointments:[],N=g[1]||{slots:[]},M=N.slots||[],E=new Date(G,I-1,1),R=new Date(G,I,0,23,59,59,999);function T($,X){for(var Q={vss:0,vsd:0,vsdI:0,telefonate:0,appFissati:0,nncf:0,count:0},pe=0;pe<P.length;pe++){var ue=P[pe],Ce=new Date(ue.start);Ce>=$&&Ce<=X&&(Q.vss+=Number(ue.vss||0),Q.vsd+=Number(ue.vsdPersonal||0),Q.vsdI+=Number(ue.vsdIndiretto||0),Q.telefonate+=Number(ue.telefonate||0),Q.appFissati+=Number(ue.appFissati||0),Q.nncf+=ue.nncf?1:0,Q.count+=1)}return Q}function q($,X,Q){var pe=document.getElementById("cal_results");if(pe){var ue=Q?'<div class="right"><button id="res_reset" class="ghost">Torna al mese</button></div>':"";if(pe.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center"><b>Risultati ¬∑ '+X+"</b>"+ue+'</div><div class="row" style="margin-top:8px;gap:8px;flex-wrap:wrap"><span class="chip small">VSS <b>'+Je($.vss)+'</b></span><span class="chip small">VSD <b>'+Je($.vsd)+'</b></span><span class="chip small">VSD ind <b>'+Je($.vsdI)+'</b></span><span class="chip small">Tel <b>'+Oe($.telefonate)+'</b></span><span class="chip small">AppFiss <b>'+Oe($.appFissati)+'</b></span><span class="chip small">NNCF <b>'+Oe($.nncf)+'</b></span><span class="chip small">N. app <b>'+Oe($.count)+"</b></span></div>",pe.style.display="block",Q){var Ce=document.getElementById("res_reset");Ce&&(Ce.onclick=function(){q(T(E,R),h,!1)})}}}for(var ne={},a=0;a<P.length;a++){var e=P[a],i=new Date(e.start);if(!(i<E||i>R)){var t=Fe(i);ne[t]||(ne[t]={vss:0,vsd:0,vsdI:0,telefonate:0,appFissati:0,nncf:0,mins:0,count:0,items:[]}),ne[t].vss+=Number(e.vss||0),ne[t].vsd+=Number(e.vsdPersonal||0),ne[t].vsdI+=Number(e.vsdIndiretto||0),ne[t].telefonate+=Number(e.telefonate||0),ne[t].appFissati+=Number(e.appFissati||0),ne[t].nncf+=e.nncf?1:0,ne[t].mins+=Number(e.durationMinutes||0),ne[t].count+=1,ne[t].items.push(e)}}var l=["Lun","Mar","Mer","Gio","Ven","Sab","Dom"],h=new Date(G,I-1,1).toLocaleString("it-IT",{month:"long",year:"numeric"}),u='<div class="card"><b class="neon">'+h+"</b></div>";u+='<div class="calendar">',u+='<div class="weekLabel">W</div>';for(var c=0;c<7;c++)u+='<div class="weekLabel">'+l[c]+"</div>";var p=new Date(G,I-1,1),n=(p.getDay()+6)%7,o=new Date(p);o.setDate(p.getDate()-n);for(var r=0;r<6;r++){var d=new Date(o),v="W"+Ne(d);u+='<div class="weekLabel" data-ws="'+Fe(d)+'" style="cursor:pointer">'+v+"</div>";for(var k=0;k<7;k++){var W=o.getMonth()===I-1,t=Fe(o),J=ne[t]||{vss:0,vsd:0,vsdI:0,telefonate:0,appFissati:0,nncf:0,mins:0,count:0,items:[]},S=o.getDay(),V=S===0||S===6,ae=!V&&M.some(function(X){return X.date===t});if(W&&w){if(w.only_free&&J.count>0){u+="<div></div>",o.setDate(o.getDate()+1);continue}if(w.only_4h&&!ae){u+="<div></div>",o.setDate(o.getDate()+1);continue}}if(!W)u+="<div></div>";else{var K="";V?J.count>0&&(K="busy2"):J.count===0?K="busy0":ae?K="busy1":K="busy2";var oe="",de=0;V&&J.count===0||(J.vss>0&&(oe+='<div class="small">VSS '+Je(J.vss)+"</div>",de++),J.vsd>0&&(oe+='<div class="small">VSD '+Je(J.vsd)+"</div>",de++),J.vsdI>0&&(oe+='<div class="small">VSD ind '+Je(J.vsdI)+"</div>",de++),J.telefonate>0&&(oe+='<div class="small">Tel '+Oe(J.telefonate)+"</div>",de++),J.appFissati>0&&(oe+='<div class="small">AppFiss '+Oe(J.appFissati)+"</div>",de++),J.nncf>0&&(oe+='<div class="small">NNCF '+Oe(J.nncf)+"</div>",de++),J.count>0&&(oe+='<div class="small">App. '+Oe(J.count)+"</div>",de++),ae&&(oe+='<div class="tag" style="margin-top:4px">slot ‚â•4h</div>',de++));var me=de>=3?" dense":"",be=ae?" slot-free":"";u+='<div class="day '+K+me+be+'" data-day="'+t+'" title="Settimana '+Ne(o)+'"><div class="dnum">'+o.getDate()+"</div>"+(oe||"")+"</div>"}o.setDate(o.getDate()+1)}}u+="</div>",document.getElementById("cal_container").innerHTML=u,q(T(E,R),h,!1),document.querySelectorAll(".calendar .weekLabel[data-ws]").forEach(function($){$.addEventListener("click",function(){var X=$.getAttribute("data-ws"),Q=new Date(X),pe=new Date(Q);pe.setDate(pe.getDate()+6),pe.setHours(23,59,59,999);var ue="Settimana "+("W"+Ne(Q))+" ¬∑ "+ot(Q)+"‚Äì"+ot(pe);q(T(Q,pe),ue,!0)})}),document.querySelectorAll(".day[data-day]").forEach(function($){$.addEventListener("click",function(){var X=$.getAttribute("data-day"),Q=ne[X]&&ne[X].items?ne[X].items.slice():[];Q.sort(function(qe,Qe){return new Date(qe.start)-new Date(Qe.start)});var pe=document.getElementById("cal_day_box"),ue="<b>Appuntamenti del "+X.split("-").reverse().join("/")+"</b>";if(!Q.length)ue+='<div class="muted" style="margin-top:6px">Nessun appuntamento</div>';else{ue+='<div class="row" style="margin-top:8px">';for(var Ce=0;Ce<Q.length;Ce++){var he=Q[Ce],Te=' data-start="'+he.start+'" data-end="'+he.end+'" data-title="'+De(he.client||"Appuntamento")+'" ',He=String(he.type||"").toLowerCase(),Ye;He.indexOf("mbs")>-1?Ye="VSD ind "+Je(he.vsdIndiretto||0):He.indexOf("sottoprod")>-1?Ye="Tel "+Oe(he.telefonate||0)+" ¬∑ AppFissati "+Oe(he.appFissati||0):He.indexOf("formaz")>-1?Ye="":Ye="VSS "+Je(he.vss)+" ¬∑ VSD "+Je(he.vsdPersonal)+" ¬∑ NNCF "+(he.nncf?"‚úÖ":"‚Äî"),ue+='<div class="card cal-app" data-aid="'+he.id+'" '+Te+' style="flex:1 1 320px;cursor:pointer"><div class="small muted">'+f(he.start)+"‚Äì"+f(he.end)+" ¬∑ "+De(he.type||"")+"</div><div><b>"+De(he.client||"")+"</b></div>"+(Ye?'<div class="small">'+Ye+"</div>":"")+(he.notes?'<div class="small muted">'+De(he.notes)+"</div>":"")+"</div>"}ue+="</div>"}var nt=(M||[]).filter(function(qe){return qe.date===X});if(nt.length){ue+='<div class="row" style="margin-top:8px">';for(var at=0;at<nt.length;at++){var Ze=nt[at],Xe=Ze.part==="morning"?"mattina":"pomeriggio";ue+='<div class="card slotBtn" data-start="'+Ze.start+'" data-end="'+Ze.end+'" style="flex:1 1 280px;cursor:pointer"><div class="small">'+Xe+" ¬∑ "+f(Ze.start)+"‚Äì"+f(Ze.end)+"</div></div>"}ue+="</div>"}if(pe.style.display="block",pe.innerHTML=ue,pe.querySelectorAll(".cal-app").forEach(function(qe){qe.addEventListener("click",function(Qe){Qe.stopPropagation(),Ke("bp_edit_aid",qe.getAttribute("data-aid")),we()})}),pe.querySelectorAll(".slotBtn").forEach(function(qe){qe.addEventListener("click",function(Qe){Qe.stopPropagation(),Ke("bp_prefill_slot",{start:qe.getAttribute("data-start"),end:qe.getAttribute("data-end")}),we(),fe("Slot precompilato negli appuntamenti")})}),window.scrollTo({top:pe.getBoundingClientRect().top+window.scrollY-80,behavior:"smooth"}),typeof window.wireICSInsideDayBox=="function")try{window.wireICSInsideDayBox()}catch(qe){}})});var Se=document.getElementById("cal_free_slots"),Pe=(function(){var $=new Date;return $.getFullYear()+"-"+ze($.getMonth()+1)+"-"+ze($.getDate())})(),ke=(M||[]).filter(function($){return String($.date||"").slice(0,10)>=Pe});if(ke.length){var tt='<b>Slot liberi ‚â• 4h (da oggi in poi)</b> ¬∑ <span class="badge">Tot: '+ke.length+"</span>";tt+='<div class="row" style="margin-top:8px">';for(var F=0;F<ke.length&&F<80;F++){var i=ke[F],j=i.part==="morning"?"mattina":"pomeriggio";tt+='<div class="card slotBtn" data-start="'+i.start+'" data-end="'+i.end+'" style="flex:1 1 280px;cursor:pointer"><div class="small"><b>'+ot(i.start)+"</b> ¬∑ "+j+'</div><div class="small">'+f(i.start)+"‚Äì"+f(i.end)+"</div></div>"}tt+="</div>",Se.style.display="block",Se.innerHTML=tt,Se.querySelectorAll(".slotBtn").forEach(function($){$.addEventListener("click",function(){Ke("bp_prefill_slot",{start:$.getAttribute("data-start"),end:$.getAttribute("data-end")}),we(),fe("Slot precompilato negli appuntamenti")})})}else Se.style.display="block",Se.innerHTML='<b>Slot liberi ‚â• 4h (da oggi in poi)</b> ¬∑ <span class="badge">Tot: 0</span><div class="muted" style="margin-top:6px">Nessuno slot libero disponibile.</div>';try{window.injectTodayCSS&&window.injectTodayCSS()}catch($){}try{window.hookCalendar?window.hookCalendar():(window.markToday&&window.markToday(),window.clampSlotCounters&&window.clampSlotCounters())}catch($){}}).catch(function(g){logger.error(g),fe("Errore calendario")})}function x(){var G=document.getElementById("cal_month").value,I=parseInt(G.split("-")[0],10),w=parseInt(G.split("-")[1],10),g={only_free:document.getElementById("only_free").checked,only_4h:document.getElementById("only_4h").checked};A(I,w,g)}document.getElementById("cal_refresh").onclick=x;var L=document.getElementById("cal_add");L&&(L.onclick=function(){we()}),document.getElementById("cal_month").onchange=x;function C(G){var I=document.getElementById("cal_month");if(I){var w=I.value.split("-"),g=+w[0],P=+w[1];P+=G,P<=0?(P=12,g--):P>12&&(P=1,g++),I.value=g+"-"+ze(P),x()}}var _=document.getElementById("cal_prev"),B=document.getElementById("cal_next");_&&(_.onclick=function(){C(-1)}),B&&(B.onclick=function(){C(1)}),document.getElementById("only_free").onchange=x,document.getElementById("only_4h").onchange=x,x()}function ye(){if(!Be())return s();document.title="Battle Plan ‚Äì BP",m.innerHTML=je()+'<div class="wrap"><div class="card"><b>Da inviare</b><div id="bp_to_send" class="grid" style="margin-top:8px"></div></div><div class="card" id="bp_sent_box" style="margin-top:8px"><div id="bp_sent_head" style="display:flex;align-items:center;justify-content:space-between;cursor:pointer"><b>BP inviati (periodi in essere)</b><span id="bp_sent_chev" class="chev">‚ñ∏</span></div><div id="bp_sent" class="row" style="margin-top:8px;display:none"></div></div><div class="card" style="margin-top:8px"><b>Crea/Aggiorna BP</b><div class="row" style="margin-top:8px"><div><label>Tipo</label><select id="p_type"><option value="settimanale">Settimanale (lun‚Äìdom)</option><option value="mensile">Mensile</option><option value="trimestrale">Trimestrale</option><option value="semestrale">Semestrale</option><option value="annuale">Annuale</option></select></div><div id="wrap_week" style="display:none"><label>Settimana ISO (1‚Äì53)</label><input type="number" id="p_week" min="1" max="53" value="'+Ne(new Date)+'"></div><div id="wrap_month" style="display:none"><label>Mese</label><select id="p_month"><option value="1">Gennaio</option><option value="2">Febbraio</option><option value="3">Marzo</option><option value="4">Aprile</option><option value="5">Maggio</option><option value="6">Giugno</option><option value="7">Luglio</option><option value="8">Agosto</option><option value="9">Settembre</option><option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option></select></div><div id="wrap_quarter" style="display:none"><label>Trimestre</label><select id="p_quarter"><option value="1">T1</option><option value="2">T2</option><option value="3">T3</option><option value="4">T4</option></select></div><div id="wrap_semester" style="display:none"><label>Semestre</label><select id="p_sem"><option value="1">1¬∞ semestre</option><option value="2">2¬∞ semestre</option></select></div><div><label>Anno</label><input type="number" id="p_year" min="2000" max="2100" value="'+new Date().getFullYear()+'"></div></div><div class="row"><div class="small muted">Modalit√†: <b id="p_mode_lbl">Previsionale</b> ¬∑ <button class="ghost" id="btnImport" style="padding:4px 8px">Importa da agenda</button></div></div><div class="row" style="align-items:center"><div class="small"><b>Periodo selezionato:</b> <span id="p_label" class="neon">‚Äî</span></div><input type="hidden" id="p_start"><input type="hidden" id="p_end"></div><div class="row small" style="margin-top:6px;opacity:.9"><div><b>Previsionale</b></div><div><b>Consuntivo</b></div><div><b>Avanzamento</b></div></div><div class="row" id="p_rows" style="margin-top:4px"></div><div class="row" style="margin-top:8px;align-items:center;gap:8px;justify-content:space-between"><div id="p_delete_zone"></div><div class="right"><button id="btnSaveP">Salva BP</button></div></div></div><div class="card"><b>BP salvati</b><div id="p_list" class="row" style="margin-top:8px"></div></div></div>',Ue();var f=!1,y=null,z=[],b=null,U=Be()||{};function A(F){return String(F).replace(/[&<>'"]/g,j=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[j])}function x(F){if(!F)return"";var j=new Date(F);return j.getFullYear()+"-"+("0"+(j.getMonth()+1)).slice(-2)+"-"+("0"+j.getDate()).slice(-2)}function L(F){var j=new Date(F);return("0"+j.getDate()).slice(-2)+"/"+("0"+(j.getMonth()+1)).slice(-2)+"/"+j.getFullYear()}function C(F){var j=Number(F)||0;return j.toLocaleString("it-IT")+"‚Ç¨"}function _(F){var j=document.createElement("div");return j.innerHTML=F.trim(),j.firstChild}function B(F){return!!(F&&F.indicatorsCons&&Object.keys(F.indicatorsCons).length>0)}function G(){return U&&U.grade?Promise.resolve(U):Ie("/api/usernames").then(function(F){var j=String((Be()||{}).id||""),$=(F&&F.users||[]).find(function(X){return String(X.id)===j});return $&&$.grade&&(U.grade=$.grade),U}).catch(function(){return U})}function I(){var F=U&&U.grade||(Be()||{}).grade;return F==="senior"?"senior":"junior"}G();var w=document.getElementById("p_type"),g=document.getElementById("p_year"),P=document.getElementById("wrap_week"),N=document.getElementById("wrap_month"),M=document.getElementById("wrap_quarter"),E=document.getElementById("wrap_semester"),R=document.getElementById("p_week"),T=document.getElementById("p_month"),q=document.getElementById("p_quarter"),ne=document.getElementById("p_sem"),a=document.getElementById("p_label"),e=document.getElementById("p_start"),i=document.getElementById("p_end"),t=document.getElementById("p_mode_lbl"),l=document.getElementById("btnImport");function h(F){f=!!F,t.textContent=f?"Consuntivo":"Previsionale",l.style.display=f?"none":"";var j=document.querySelectorAll("[data-row]");j.forEach(function($){var X=$.querySelector("[data-prev]"),Q=$.querySelector("[data-cons]"),pe=$.querySelector("[data-bar]");if(f){if(X){X.removeAttribute("hidden");var ue=X.querySelector("input");ue&&(ue.setAttribute("readonly","readonly"),ue.classList.add("disabled"))}if(Q){Q.removeAttribute("hidden");var Ce=Q.querySelector("input");Ce&&(Ce.removeAttribute("readonly"),Ce.classList.remove("disabled"))}pe&&pe.removeAttribute("hidden")}else{if(X){X.removeAttribute("hidden");var he=X.querySelector("input");he&&(he.removeAttribute("readonly"),he.classList.remove("disabled"))}Q&&Q.setAttribute("hidden","hidden"),pe&&pe.setAttribute("hidden","hidden")}}),K()}function u(){var F=w.value;P.style.display=F==="settimanale"?"":"none",N.style.display=F==="mensile"?"":"none",M.style.display=F==="trimestrale"?"":"none",E.style.display=F==="semestrale"?"":"none",c()}function c(){var F=w.value,j=parseInt(g.value,10),$,X,Q;if(F==="settimanale"){var pe=Math.max(1,Math.min(53,parseInt(R.value||"1",10))),ue=et(j,pe);$=ue.start,X=ue.end,Q="Sett. "+pe+" ¬∑ "+L($)+" ‚Üí "+L(X)}else if(F==="mensile"){var Ce=parseInt(T.value,10);$=new Date(j,Ce-1,1),X=new Date(j,Ce,0),Q=$.toLocaleString("it-IT",{month:"long",year:"numeric"})+" ¬∑ "+L($)+" ‚Üí "+L(X)}else if(F==="trimestrale"){var he=parseInt(q.value,10);$=new Date(j,(he-1)*3,1),X=new Date(j,he*3,0),Q="Trimestre "+he+" "+j+" ¬∑ "+L($)+" ‚Üí "+L(X)}else if(F==="semestrale"){var Te=parseInt(ne.value,10);$=new Date(j,Te===1?0:6,1),X=new Date(j,Te===1?6:12,0),Q=(Te===1?"1¬∞":"2¬∞")+" semestre "+j+" ¬∑ "+L($)+" ‚Üí "+L(X)}else $=new Date(j,0,1),X=new Date(j,11,31),Q="Anno "+j+" ¬∑ "+L($)+" ‚Üí "+L(X);e.value=x($),i.value=x(X),a.textContent=Q,h(!1),y=null,b=null,d(),K()}function p(F){for(var j="",$=0;$<F.length;$++){var X=F[$],Q=/^(VSS|VSDPersonale|VSDIndiretto|GI)$/i.test(X);j+='<div class="row" data-row="'+X+'"><div data-prev><label>'+X+' (Prev)</label><input type="number" step="1" id="prev_'+X+'" placeholder="'+(Q?"‚Ç¨":"n")+'"></div><div data-cons><label>'+X+' (Cons)</label><input type="number" step="1" id="cons_'+X+'" placeholder="'+(Q?"‚Ç¨":"n")+'"></div><div data-bar class="small"><div style="height:10px;background:rgba(255,255,255,.12);border-radius:999px;overflow:hidden"><div id="bar_'+X+'" style="height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2));"></div></div><div id="pct_'+X+'" class="small muted">0%</div></div></div>'}document.getElementById("p_rows").innerHTML=j,h(!1),o(),n()}function n(){for(var F=0;F<z.length;F++){var j=z[F],$=document.getElementById("prev_"+j),X=document.getElementById("cons_"+j);if(!(!$||!X)){var Q=Number($.value||0),pe=Number(X.value||0),ue=Q>0?Math.round(pe/Q*100):pe>0?100:0;ue=Math.max(0,Math.min(200,ue));var Ce=document.getElementById("bar_"+j),he=document.getElementById("pct_"+j);Ce&&(Ce.style.width=Math.min(ue,100)+"%"),he&&(he.textContent=ue+"%")}}}function o(){for(var F=0;F<z.length;F++)(function(j){var $=document.getElementById("prev_"+j),X=document.getElementById("cons_"+j);$&&($.oninput=n),X&&(X.oninput=n)})(z[F])}function r(){for(var F=0;F<z.length;F++){var j=document.getElementById("prev_"+z[F]);j&&(j.value="")}n()}function d(){for(var F=0;F<z.length;F++){var j=document.getElementById("cons_"+z[F]);j&&(j.value="")}n()}function v(F){for(var j in F){var $=document.getElementById("prev_"+j);$&&($.value=String(F[j]||0))}n()}function k(F){for(var j in F){var $=document.getElementById("cons_"+j);$&&($.value=String(F[j]||0))}n()}function W(){if(!f){var F=e.value,j=i.value;if(!F||!j){fe("Seleziona il periodo");return}Ie("/api/appointments").then(function($){for(var X=$.appointments||[],Q=new Date(F),pe=new Date(j),ue={VSS:0,VSDPersonale:0,VSDIndiretto:0,GI:0,Telefonate:0,AppFissati:0,AppFatti:0,CorsiLeadership:0,iProfile:0,MBS:0,NNCF:0},Ce=0;Ce<X.length;Ce++){var he=X[Ce],Te=new Date(he.start);Te>=Q&&Te<=pe&&(ue.VSS+=Number(he.vss||0),ue.VSDPersonale+=Number(he.vsdPersonal||0),ue.VSDIndiretto+=Number(he.vsdIndiretto||0),ue.Telefonate+=Number(he.telefonate||0),ue.AppFissati+=Number(he.appFissati||0),he.nncf&&(ue.AppFatti+=1,ue.NNCF+=1))}v(ue),fe("Previsionale compilato dalla tua agenda"),st(),window.addXP(10)}).catch(function(){fe("Errore import agenda")})}}function J(F,j){F=Object.assign({},F||{});var $=Number(F.GI||0),X=Number(F.VSDPersonale||0),Q=$*.15,pe=X*(String(j)==="senior"?.25:.2);return F.ProvvGI=Math.round(Q*100)/100,F.ProvvVSD=Math.round(pe*100)/100,F.TotProvvigioni=Math.round((F.ProvvGI+F.ProvvVSD)*100)/100,F}function S(F,j,$){return fetch(j,{method:F,headers:$?{"Content-Type":"application/json"}:void 0,body:$?JSON.stringify($):void 0}).then(function(X){return X.ok?X.json().catch(function(){return{}}):Promise.reject(new Error("HTTP "+X.status))})}function V(F){for(var j=encodeURIComponent(F),$=[function(){return S("POST","/api/periods/delete",{id:F})},function(){return S("POST","/api/periods",{id:F,_delete:!0})},function(){return S("POST","/api/periods/"+j,{_method:"DELETE"})},function(){return S("DELETE","/api/periods/"+j,null)},function(){return S("DELETE","/api/periods?id="+j,null)}],X=Promise.reject(new Error("start")),Q=0;Q<$.length;Q++)(function(pe){X=X.catch(pe)})($[Q]);return X.catch(function(pe){throw logger.warn("Delete fallback: tutte le route fallite",pe),pe})}function ae(F){return b?{id:y||b.id,type:b.type,startDate:x(b.startDate),endDate:x(b.endDate),indicatorsPrev:Object.assign({},b.indicatorsPrev||{}),indicatorsCons:F!=null?F:Object.assign({},b.indicatorsCons||{})}:null}function K(){var F=document.getElementById("p_delete_zone");if(F){if(!y){F.innerHTML="";return}var j=!!(b&&B(b)),$="";j&&($+='<button id="btnDelCons" class="ghost" style="border-color:#7d1731;color:#7d1731">Elimina Consuntivo</button> '),$+='<button id="btnDelBP" class="ghost" style="border-color:#7d1731;color:#7d1731">Elimina BP</button>',F.innerHTML=$;var X=document.getElementById("btnDelBP");X&&(X.onclick=function(){if(confirm("Eliminare definitivamente questo BP?")){X.disabled=!0;var pe=b?JSON.parse(JSON.stringify(b)):null;V(y).then(function(){fe("BP eliminato");try{document.dispatchEvent(new Event("bp:deleted"))}catch(Ce){}if(y=null,b=null,r(),d(),h(!1),c(),de(),typeof showUndo=="function"&&pe){var ue={type:pe.type,startDate:x(pe.startDate),endDate:x(pe.endDate),indicatorsPrev:Object.assign({},pe.indicatorsPrev||{}),indicatorsCons:Object.assign({},pe.indicatorsCons||{})};showUndo("BP eliminato",function(){return Le("/api/periods",ue).then(function(){try{document.dispatchEvent(new Event("bp:saved"))}catch(Ce){}de()})},5e3)}}).catch(function(){fe("Endpoint delete non disponibile")}).finally(function(){X.disabled=!1})}});var Q=document.getElementById("btnDelCons");Q&&(Q.onclick=function(){if(confirm("Rimuovere solo il Consuntivo?")){Q.disabled=!0;var pe=b?JSON.parse(JSON.stringify(b.indicatorsCons||{})):null,ue=ae({});if(!ue){Q.disabled=!1;return}var Ce=I();ue.indicatorsPrev=J(ue.indicatorsPrev,Ce),ue.indicatorsCons={},Le("/api/periods",ue).then(function(){fe("Consuntivo eliminato");try{document.dispatchEvent(new Event("bp:saved"))}catch(Te){}if(b&&(b.indicatorsCons={}),h(!0),de(),K(),typeof showUndo=="function"&&pe){var he=ae(pe);showUndo("Consuntivo eliminato",function(){return Le("/api/periods",he).then(function(){try{document.dispatchEvent(new Event("bp:saved"))}catch(Te){}b&&(b.indicatorsCons=pe),de(),K()})},5e3)}}).catch(function(){fe("Errore eliminazione Consuntivo")}).finally(function(){Q.disabled=!1})}})}}function oe(){var F=w.value,j=e.value,$=i.value;if(!j||!$){fe("Seleziona il periodo");return}for(var X={},Q={},pe=0;pe<z.length;pe++){var ue=z[pe];X[ue]=Number(document.getElementById("prev_"+ue).value||0),f&&(Q[ue]=Number(document.getElementById("cons_"+ue).value||0))}var Ce=I();X=J(X,Ce),f&&(Q=J(Q,Ce));var he={type:F,startDate:j,endDate:$,indicatorsPrev:X};f&&(he.indicatorsCons=Q),y&&(he.id=y),Le("/api/periods",he).then(function(Te){fe("BP salvato"),f?window.addXP(20):window.addXP(10),st();try{document.dispatchEvent(new Event("bp:saved"))}catch(He){}de(),!y&&Te&&Te.id&&(y=Te.id),y&&b&&(b.indicatorsPrev=X,f&&(b.indicatorsCons=Q)),K()}).catch(function(){fe("Errore salvataggio BP")})}function de(){Ie("/api/periods").then(function(F){var j=F.periods||[];j.sort(function(he,Te){return new Date(Te.startDate)-new Date(he.startDate)});for(var $="",X=0;X<j.length;X++){var Q=j[X],pe=rt(Q.type,Q.startDate)+" ¬∑ "+L(Q.startDate)+" ‚Üí "+L(Q.endDate);$+='<div class="card" style="flex:1 1 360px"><div><b>'+A(pe)+'</b></div><div class="small">Prev VSS '+C((Q.indicatorsPrev||{}).VSS||0)+" ¬∑ Cons "+C((Q.indicatorsCons||{}).VSS||0)+'</div><div class="right" style="margin-top:6px"><button class="ghost" data-edit="'+Q.id+'">Modifica previs.</button><button data-cons="'+Q.id+'">Consuntivo‚Ä¶</button></div></div>'}document.getElementById("p_list").innerHTML=$||'<div class="muted">Nessun BP</div>',document.querySelectorAll("[data-edit]").forEach(function(he){he.addEventListener("click",function(){var Te=he.getAttribute("data-edit"),He=(F.periods||[]).find(function(Ye){return Ye.id===Te});He&&me(He,!1)})}),document.querySelectorAll("[data-cons]").forEach(function(he){he.addEventListener("click",function(){var Te=he.getAttribute("data-cons"),He=(F.periods||[]).find(function(Ye){return Ye.id===Te});He&&me(He,!0)})}),tt(j);var ue=lt("bp_open_period",null);if(ue){it("bp_open_period");var Ce=j.find(function(he){return he.id===ue.id});Ce&&me(Ce,ue.mode===!0)}})}function me(F,j){b=F||null,w.value=F.type;var $=new Date(F.startDate),X=$.getFullYear();if(g.value=String(X),F.type==="settimanale")R.value=String(Ne($));else if(F.type==="mensile")T.value=String($.getMonth()+1);else if(F.type==="trimestrale"){var Q=Math.floor($.getMonth()/3)+1;q.value=String(Q)}else F.type==="semestrale"&&(ne.value=$.getMonth()<6?"1":"2");u(),r(),d(),v(F.indicatorsPrev||{}),k(F.indicatorsCons||{}),h(!!j),y=F.id||null,K(),fe(j?"Compila il consuntivo":"Modifica previsionale"),window.scrollTo({top:0,behavior:"smooth"})}function be(F,j){j=j||new Date;var $=j.getFullYear();if(F==="settimanale"){var X=et($,Ne(j));return{start:X.start,end:X.end}}return F==="mensile"?{start:ft(j),end:gt(j)}:F==="trimestrale"?{start:ut(j),end:ht(j)}:F==="semestrale"?{start:pt(j),end:wt(j)}:{start:bt(j),end:ct(j)}}function Se(F,j){return j=j||new Date,F==="settimanale"?Gt(j):F==="mensile"?$t(j):F==="trimestrale"?Wt(j):F==="semestrale"?Jt(j):Kt(j)}function Pe(F){var j=et(new Date().getFullYear(),Ne(new Date)),$=j.start,X=Math.floor((new Date(F)-$)/(1e3*60*60*24));return X<=13}function ke(F,j,$,X,Q,pe){var ue=rt(j,$),Ce=_('<div class="card" style="position:relative"><div class="small muted">'+A(F)+"</div><div><b>"+A(ue)+'</b></div><div class="small muted">'+L($)+" ‚Üí "+L(X)+'</div><div class="right" style="margin-top:6px"><button class="ghost" type="button" data-sug="1">'+A(Q)+"</button></div></div>");return Ce.querySelector("[data-sug]").addEventListener("click",pe),Ce}function tt(F){var j=document.getElementById("bp_to_send"),$=document.getElementById("bp_sent");j.innerHTML="",$.innerHTML="";function X(Ae,Re,Me){return F.find(function(We){return We.type===Ae&&x(We.startDate)===x(Re)&&x(We.endDate)===x(Me)})}var Q=new Date,pe=Q.getDay(),ue=pe===5||pe===6||pe===0,Ce=gt(Q),he=ht(Q),Te=wt(Q),He=ct(Q),Ye=ue&&Pe(Ce),nt=ue&&Pe(he),at=ue&&Pe(Te),Ze=ue&&Pe(He);["settimanale","mensile","trimestrale","semestrale","annuale"].forEach(function(Ae){var Re=be(Ae,Q),Me=X(Ae,Re.start,Re.end);if(Me){var We=_('<div class="card" style="flex:1 1 360px"><div><b>'+A(rt(Ae,Re.start))+'</b></div><div class="small muted">'+L(Re.start)+" ‚Üí "+L(Re.end)+'</div><div class="right" style="margin-top:6px"><button class="ghost" type="button" data-mid="'+Me.id+'">Modifica</button></div></div>');We.querySelector("[data-mid]").addEventListener("click",function(){me(Me,!1)}),$.appendChild(We)}});function Xe(Ae,Re,Me){var We=X(Ae,Me.start,Me.end),vt=X(Ae,Re.start,Re.end);We?j.appendChild(ke("Previsionale",Ae,Me.start,Me.end,"Modifica",function(){me(We,!1)})):j.appendChild(ke("Previsionale",Ae,Me.start,Me.end,"Compila",function(){if(w.value=Ae,g.value=String(Me.start.getFullYear()),Ae==="settimanale")R.value=String(Ne(Me.start));else if(Ae==="mensile")T.value=String(Me.start.getMonth()+1);else if(Ae==="trimestrale"){var Lt=Math.floor(Me.start.getMonth()/3)+1;q.value=String(Lt)}else Ae==="semestrale"&&(ne.value=Me.start.getMonth()<6?"1":"2");u()})),vt&&!B(vt)&&j.appendChild(ke("Consuntivo",Ae,Re.start,Re.end,"Consuntivo",function(){me(vt,!0)}))}if(ue){var qe=be("settimanale",Q),Qe=Se("settimanale",Q);Xe("settimanale",qe,Qe)}if(Ye){var xt=be("mensile",Q),Et=Se("mensile",Q);Xe("mensile",xt,Et)}if(nt){var Dt=be("trimestrale",Q),Tt=Se("trimestrale",Q);Xe("trimestrale",Dt,Tt)}if(at){var Bt=be("semestrale",Q),kt=Se("semestrale",Q);Xe("semestrale",Bt,kt)}if(Ze){var Pt=be("annuale",Q),At=Se("annuale",Q);Xe("annuale",Pt,At)}j.children.length||(j.innerHTML='<div class="muted">Nessun suggerimento attivo in questo momento</div>');var Nt=document.getElementById("bp_sent_head"),Mt=document.getElementById("bp_sent_chev");Nt.onclick=function(){var Ae=document.getElementById("bp_sent"),Re=Ae.style.display!=="none";Ae.style.display=Re?"none":"",Mt.textContent=Re?"‚ñ∏":"‚ñæ"}}Ie("/api/settings").then(function(F){z=F&&F.indicators||["VSS","VSDPersonale","VSDIndiretto","GI","Telefonate","AppFissati","AppFatti","CorsiLeadership","iProfile","MBS","NNCF"],p(z)}).catch(function(){z=["VSS","VSDPersonale","GI","NNCF"],p(z)}),w.onchange=u,g.oninput=c,R.oninput=c,T.onchange=c,q.onchange=c,ne.onchange=c,l.onclick=W,document.getElementById("btnSaveP").onclick=oe,u(),de()}function we(){if(!Be())return s();if(document.title="Battle Plan ‚Äì Appuntamenti",!document.getElementById("appts_css")){const n=document.createElement("style");n.id="appts_css",n.textContent="\n      .appt-type .seg, #a_nncf.seg{\n        padding:8px 12px;border:1px solid #bcd7ff;border-radius:12px;\n        background:#eef5ff;color:#1463ff;cursor:pointer;user-select:none;\n        transition:.15s;\n      }\n      .appt-type .seg.active, #a_nncf.seg.active{\n        background:var(--accent);color:#fff;border-color:var(--accent);\n        box-shadow:0 0 0 2px rgba(20,99,255,.08) inset;\n      }\n      #a_list .grid3{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}\n    ",document.head.appendChild(n)}m.innerHTML=je()+'<div class="wrap"><div class="card"><b id="a_form_title">Nuovo appuntamento</b><div class="row" style="margin-top:8px;align-items:flex-end;gap:12px;flex-wrap:wrap"><div style="min-width:320px"><label>Cliente *</label><div style="display:flex;gap:8px;align-items:center"><input id="a_client" list="clientList" placeholder="Denominazione" style="flex:1"><datalist id="clientList"></datalist><button id="a_nncf" class="seg" data-active="0" aria-pressed="false">NNCF</button></div></div><div><label>Data/ora inizio</label><input id="a_start" type="datetime-local"></div><div><label>Ora fine</label><input id="a_end" type="time"></div><div><label>Durata (min)</label><input id="a_dur" type="number" placeholder="60" min="1"></div></div><div class="row" style="margin-top:8px"><div style="flex:1"><label>Descrizione appuntamento</label><textarea id="a_desc" rows="2"></textarea></div></div><div class="row" style="align-items:flex-end;gap:12px;flex-wrap:wrap"><div class="appt-type"><label>Tipo</label><div><button type="button" id="t_vendita" class="seg">Vendita</button><button type="button" id="t_mezza"   class="seg" data-vsd="1000">Mezza giornata</button><button type="button" id="t_full"    class="seg" data-vsd="2000">Giornata intera</button><button type="button" id="t_form"    class="seg">Formazione</button><button type="button" id="t_mbs"     class="seg">MBS</button><button type="button" id="t_sotto"   class="seg">Sottoprodotti</button></div><input id="a_type" type="hidden" value="vendita"></div><div id="row_vss"><label>VSS</label><input id="a_vss" type="number" step="1" placeholder="0"></div><div id="row_vsd_p"><label>VSD personale</label><input id="a_vsd" type="number" step="1" placeholder="0"></div><div id="row_vsd_i" style="display:none"><label>VSD indiretto</label><input id="a_vsd_i" type="number" step="1" placeholder="0"></div><div id="row_tel" style="display:none"><label>Telefonate</label><input id="a_tel" type="number" step="1" placeholder="0"></div><div id="row_app" style="display:none"><label>Appunt. fissati</label><input id="a_app" type="number" step="1" placeholder="0"></div></div><div class="row" style="margin-top:8px;gap:8px;align-items:center"><div><button id="btnSaveA">Salva</button></div><div><button id="btnSaveExportA" class="ghost">Salva ed esporta</button></div><div class="right" style="margin-left:auto"><button id="btnDeleteA" class="danger" style="display:none">Elimina</button></div></div></div><div class="card"><b>Elenco appuntamenti</b><div class="row" style="margin-top:8px;align-items:flex-end;gap:12px;flex-wrap:wrap"><div><label>Vista</label><select id="af_type"><option value="sett">Settimana</option><option value="mese">Mese</option></select></div><div id="af_week_wrap"><label>Settimana ISO</label><input id="af_week" type="number" min="1" max="53" value="'+Ne(new Date)+'"></div><div id="af_month_wrap" style="display:none"><label>Mese</label><select id="af_month"><option value="1">Gennaio</option><option value="2">Febbraio</option><option value="3">Marzo</option><option value="4">Aprile</option><option value="5">Maggio</option><option value="6">Giugno</option><option value="7">Luglio</option><option value="8">Agosto</option><option value="9">Settembre</option><option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option></select></div><div><label>Anno</label><input id="af_year" type="number" min="2000" max="2100" value="'+new Date().getFullYear()+'"></div><div class="right" style="margin-left:auto;display:flex;gap:8px"><button id="af_prev" class="ghost">‚óÄ</button><button id="af_next" class="ghost">‚ñ∂</button></div></div><div id="a_list" style="margin-top:8px"></div></div></div>',Ue();function f(n){return String(n).replace(/[&<>'"]/g,o=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[o])}function y(n){var o=Number(n)||0;return o.toLocaleString("it-IT")+"‚Ç¨"}function z(n){var o=new Date(n);return("0"+o.getDate()).slice(-2)+"/"+("0"+(o.getMonth()+1)).slice(-2)+"/"+o.getFullYear()}function b(n){if(!n)return"";const o=new Date(n);return isNaN(o)?"":o.toISOString()}function U(n){if(!n)return"";const o=new Date(n);return isNaN(o)?"":new Date(o.getTime()-o.getTimezoneOffset()*6e4).toISOString().slice(0,16)}function A(n){return n=String(n||"").toLowerCase(),n.indexOf("mezza")>-1?240:n.indexOf("giorn")>-1||n.indexOf("formaz")>-1||n.indexOf("mbs")>-1?570:n.indexOf("sottoprod")>-1?240:90}const x=document.getElementById("a_nncf");x.addEventListener("click",()=>{const n=x.getAttribute("data-active")!=="1";x.setAttribute("data-active",n?"1":"0"),x.setAttribute("aria-pressed",n?"true":"false"),x.classList.toggle("active",n),n&&g(document.getElementById("t_vendita"))});const L=document.getElementById("t_vendita"),C=document.getElementById("t_mezza"),_=document.getElementById("t_full"),B=document.getElementById("t_form"),G=document.getElementById("t_mbs"),I=document.getElementById("t_sotto"),w=[L,C,_,B,G,I];function g(n){w.forEach(S=>S.classList.toggle("active",S===n));const o=document.getElementById("a_type"),r=document.getElementById("a_client"),d=document.getElementById("row_vss"),v=document.getElementById("row_vsd_p"),k=document.getElementById("row_vsd_i"),W=document.getElementById("row_tel"),J=document.getElementById("row_app");document.getElementById("a_vss").value="",document.getElementById("a_vsd").value="",document.getElementById("a_vsd_i").value="",document.getElementById("a_tel").value="",document.getElementById("a_app").value="",d.style.display="",v.style.display="",k.style.display="none",W.style.display="none",J.style.display="none",r.disabled=!1,x.style.display="",x.setAttribute("data-active","0"),x.setAttribute("aria-pressed","false"),x.classList.remove("active"),(r.value==="Formazione"||r.value==="MBS"||r.value==="Sottoprodotti")&&(r.value=""),n===L?(o.value="vendita",P(90)):n===C?(o.value="mezza",P(240),document.getElementById("a_vsd").value="1000"):n===_?(o.value="giornata",P(570),document.getElementById("a_vsd").value="2000"):n===B?(o.value="formazione",P(570),r.value="Formazione",r.disabled=!0,d.style.display="none",v.style.display="none",x.style.display="none"):n===G?(o.value="MBS",P(570),r.value="MBS",r.disabled=!0,d.style.display="none",v.style.display="none",k.style.display="",document.getElementById("a_vsd_i").value="2000",x.style.display="none"):n===I&&(o.value="sottoprodotti",P(240),r.value="Sottoprodotti",r.disabled=!0,d.style.display="none",v.style.display="none",W.style.display="",J.style.display="",x.style.display="none")}function P(n){const o=document.getElementById("a_dur");o.value=String(n),N()}w.forEach(n=>n.addEventListener("click",o=>{o.preventDefault(),g(n)})),g(L);function N(){const n=document.getElementById("a_start").value,o=parseInt(document.getElementById("a_dur").value||"0",10);if(!n||!isFinite(o)||o<=0){document.getElementById("a_end").value="";return}const r=new Date(n),d=new Date(r.getTime()+o*6e4);document.getElementById("a_end").value=("0"+d.getHours()).slice(-2)+":"+("0"+d.getMinutes()).slice(-2)}function M(){const n=document.getElementById("a_start").value,o=document.getElementById("a_end").value;if(!n||!o)return;const r=new Date(n),d=o.split(":");if(d.length<2)return;const v=new Date(r);v.setHours(parseInt(d[0],10)||0,parseInt(d[1],10)||0,0,0),v<r&&v.setDate(v.getDate()+1);let k=Math.round((v-r)/6e4);document.getElementById("a_dur").value=String(Math.max(1,k))}document.getElementById("a_start").addEventListener("change",N),document.getElementById("a_dur").addEventListener("input",N),document.getElementById("a_end").addEventListener("change",M),Ie("/api/clients").then(n=>{const o=n&&n.clients||[],r=document.getElementById("clientList");r&&(r.innerHTML=o.map(d=>'<option value="'+f(d.name)+'"></option>').join(""))});let E=null;function R(){E=null,document.getElementById("a_form_title").textContent="Nuovo appuntamento",document.getElementById("a_client").value="",document.getElementById("a_start").value="",document.getElementById("a_end").value="",document.getElementById("a_dur").value="",document.getElementById("a_vss").value="",document.getElementById("a_vsd").value="",document.getElementById("a_vsd_i").value="",document.getElementById("a_tel").value="",document.getElementById("a_app").value="",document.getElementById("a_desc").value="",document.getElementById("a_client").disabled=!1,x.style.display="",x.setAttribute("data-active","0"),x.setAttribute("aria-pressed","false"),x.classList.remove("active"),g(L),document.getElementById("btnDeleteA").style.display="none"}function T(n){E=n.id,document.getElementById("a_form_title").textContent="Modifica appuntamento";var o=String(n.type||"vendita").toLowerCase();o.indexOf("mezza")>-1?g(C):o.indexOf("giorn")>-1?g(_):o.indexOf("formaz")>-1?g(B):o.indexOf("mbs")>-1?g(G):o.indexOf("sottoprod")>-1?g(I):g(L),document.getElementById("a_client").value=n.client||"",document.getElementById("a_start").value=U(n.start);const r=new Date(n.start);let d=n.end?new Date(n.end):null,v=Number(n.durationMinutes);d instanceof Date&&!isNaN(d)&&d>=r?v=Math.max(1,Math.round((d-r)/6e4)):isFinite(v)&&v>0?d=new Date(r.getTime()+v*6e4):(v=A(n.type||"vendita"),d=new Date(r.getTime()+v*6e4)),document.getElementById("a_dur").value=String(v),document.getElementById("a_end").value=("0"+d.getHours()).slice(-2)+":"+("0"+d.getMinutes()).slice(-2),document.getElementById("a_vss").value=n.vss||"",document.getElementById("a_vsd").value=n.vsdPersonal||n.vsd||"",document.getElementById("a_vsd_i").value=n.vsdIndiretto||"",document.getElementById("a_tel").value=n.telefonate||"",document.getElementById("a_app").value=n.appFissati||"",document.getElementById("a_desc").value=n.notes||"";const k=!!n.nncf;x.setAttribute("data-active",k?"1":"0"),x.setAttribute("aria-pressed",k?"true":"false"),x.classList.toggle("active",k),document.getElementById("btnDeleteA").style.display=""}function q(){let n=(document.getElementById("a_client").value||"").trim();const o=document.getElementById("a_type").value;if(!n){const J=String(o||"").toLowerCase();if(J==="formazione"||J==="mbs"||J==="sottoprodotti")n=o;else return fe("Cliente obbligatorio"),null}const r=document.getElementById("a_start").value;if(!r)return fe("Data/ora obbligatorie"),null;let d=parseInt(document.getElementById("a_dur").value||"60",10);(!isFinite(d)||d<=0)&&(d=60);const v=document.getElementById("a_end").value;let k;if(v){const J=new Date(r),S=v.split(":"),V=new Date(J);V.setHours(parseInt(S[0],10)||0,parseInt(S[1],10)||0,0,0),V<J&&V.setDate(V.getDate()+1),k=V.toISOString(),d=Math.max(1,Math.round((V-J)/6e4)),document.getElementById("a_dur").value=String(d)}else k=new Date(new Date(r).getTime()+d*6e4).toISOString();const W=document.getElementById("a_desc").value||"";return{id:E||void 0,client:n,start:b(r),end:k,durationMinutes:d,type:o,vss:Number(document.getElementById("a_vss").value||0),vsdPersonal:Number(document.getElementById("a_vsd").value||0),vsdIndiretto:Number(document.getElementById("a_vsd_i").value||0),telefonate:Number(document.getElementById("a_tel").value||0),appFissati:Number(document.getElementById("a_app").value||0),notes:W,nncf:x.getAttribute("data-active")==="1"}}function ne(n){const o=q();if(!o)return;const r=!E;Le("/api/appointments",o).then(()=>{if(fe("Appuntamento salvato"),typeof haptics<"u"&&haptics.try("success"),document.dispatchEvent(new Event("appt:saved")),r)try{document.dispatchEvent(new Event("appt:created"))}catch(d){}if(n&&window.BP&&BP.ICS&&typeof BP.ICS.downloadIcsForAppointment=="function")if(BP.ICS.downloadIcsForAppointment(o)){typeof haptics<"u"&&haptics.try("medium");try{document.dispatchEvent(new Event("ics:exported"))}catch(v){}fe(".ics esportato")}else fe("Export .ics non disponibile");R(),p()}).catch(()=>fe("Errore salvataggio"))}function a(){if(!E||!confirm("Eliminare l'appuntamento?"))return;const n=q();fetch("/api/appointments?id="+encodeURIComponent(E),{method:"DELETE",headers:{Authorization:"Bearer "+dt()}}).then(o=>{if(!o.ok)throw new Error("HTTP "+o.status);return o.json()}).then(()=>{fe("Eliminato"),typeof showUndo=="function"&&n&&showUndo("Appuntamento eliminato",function(){return Le("/api/appointments",n)},5e3),R(),p()}).catch(()=>fe("Errore eliminazione"))}document.getElementById("btnSaveA").onclick=()=>ne(!1),document.getElementById("btnSaveExportA").onclick=()=>ne(!0),document.getElementById("btnDeleteA").onclick=a;function e(){const n=document.getElementById("af_type").value,o=parseInt(document.getElementById("af_year").value,10);if(n==="sett"){const r=Math.max(1,Math.min(53,parseInt(document.getElementById("af_week").value||Ne(new Date),10))),d=et(o,r);return{s:new Date(d.start),e:new Date(d.end)}}else{const r=parseInt(document.getElementById("af_month").value||new Date().getMonth()+1,10);return{s:new Date(o,r-1,1),e:new Date(o,r,0,23,59,59,999)}}}function i(n){const o=document.getElementById("af_type").value,r=parseInt(document.getElementById("af_year").value,10);if(o==="sett"){const d=parseInt(document.getElementById("af_week").value,10),v=new Date(et(r,d).start);v.setDate(v.getDate()+7*n),document.getElementById("af_year").value=v.getFullYear(),document.getElementById("af_week").value=Ne(v)}else{const d=parseInt(document.getElementById("af_month").value,10),v=new Date(r,d-1,1);v.setMonth(v.getMonth()+n),document.getElementById("af_year").value=v.getFullYear(),document.getElementById("af_month").value=v.getMonth()+1}p()}document.getElementById("af_prev").onclick=()=>i(-1),document.getElementById("af_next").onclick=()=>i(1);const t=document.getElementById("af_type"),l=document.getElementById("af_week"),h=document.getElementById("af_month"),u=document.getElementById("af_year");t.onchange=function(){const n=t.value;document.getElementById("af_week_wrap").style.display=n==="sett"?"":"none",document.getElementById("af_month_wrap").style.display=n==="mese"?"":"none",p()},[l,h,u].forEach(n=>{n&&(n.onchange=p)});function c(n){const o=new Date(n.start);let r=n.end?new Date(n.end):null;if(!(r instanceof Date)||isNaN(r)||r<o){const W=isFinite(n.durationMinutes)?Number(n.durationMinutes):A(n.type||"vendita");r=new Date(o.getTime()+W*6e4)}const d=z(o)+" "+("0"+o.getHours()).slice(-2)+":"+("0"+o.getMinutes()).slice(-2)+"‚Äì"+("0"+r.getHours()).slice(-2)+":"+("0"+r.getMinutes()).slice(-2);var v,k=String(n.type||"").toLowerCase();return k.indexOf("mbs")>-1?v="VSD ind "+y(n.vsdIndiretto||0):k.indexOf("sottoprod")>-1?v="Tel "+Oe(n.telefonate||0)+" ¬∑ AppFissati "+Oe(n.appFissati||0):k.indexOf("formaz")>-1?v="":v="VSS "+y(n.vss||0)+" ¬∑ VSD "+y(n.vsdPersonal||0)+" ¬∑ NNCF "+(n.nncf?"‚úÖ":"‚Äî"),'<div class="card" data-aid="'+f(String(n.id||""))+'" style="flex:1 1 320px;cursor:pointer"><div class="small muted">'+f(d)+" ¬∑ "+f(n.type||"vendita")+'</div><div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><div><b>'+f(n.client||"")+'</b></div><button class="ghost btn-ics" title="Esporta" data-ics="'+f(String(n.id||""))+'">üìÖ</button></div>'+(v?'<div class="small">'+v+"</div>":"")+"</div>"}function p(){Ie("/api/appointments").then(n=>{const o=n&&n.appointments||[],r=e(),d=r.s.getTime(),v=r.e.getTime(),k=o.filter(de=>{const me=new Date(de.start).getTime();return me>=d&&me<=v}).sort((de,me)=>new Date(de.start)-new Date(me.start)),W=new Date,J=k.filter(de=>new Date(de.start)>=W),S=k.filter(de=>new Date(de.start)<W),V=document.getElementById("a_list");let ae="";ae+="<div><b>Prossimi</b></div>",ae+=J.length?'<div class="grid3">'+J.map(c).join("")+"</div>":'<div class="muted" style="margin:6px 0 12px">Nessun appuntamento futuro</div>';const K="past_"+Math.random().toString(36).slice(2,8);ae+='<div id="'+K+'_head" style="margin-top:12px;display:flex;align-items:center;justify-content:space-between;cursor:pointer"><b>Passati</b><span class="chev">‚ñ∏</span></div><div id="'+K+'_box" style="display:none;margin-top:8px">'+(S.length?'<div class="grid3">'+S.map(c).join("")+"</div>":'<div class="muted">Nessun appuntamento passato</div>')+"</div>",V.innerHTML=ae,(function(){const de=document.getElementById(K+"_head"),me=document.getElementById(K+"_box"),be=de.querySelector(".chev");de.onclick=function(){const Se=me.style.display==="none";me.style.display=Se?"":"none",be.textContent=Se?"‚ñæ":"‚ñ∏"}})();const oe=k;V.querySelectorAll("[data-ics]").forEach(de=>{de.addEventListener("click",me=>{me.stopPropagation();const be=de.getAttribute("data-ics"),Se=oe.find(Pe=>String(Pe.id)===String(be));if(!Se){fe("Appuntamento non trovato");return}if(window.BP&&BP.ICS&&typeof BP.ICS.downloadIcsForAppointment=="function")if(BP.ICS.downloadIcsForAppointment(Se)){typeof haptics<"u"&&haptics.try("medium");try{document.dispatchEvent(new Event("ics:exported"))}catch(ke){}fe("Esportato")}else fe("Export .ics non disponibile");else fe("Export .ics non disponibile")})}),V.querySelectorAll(".card[data-aid]").forEach(de=>{de.addEventListener("click",()=>{const me=de.getAttribute("data-aid"),be=oe.find(Se=>String(Se.id)===String(me));be&&(T(be),window.scrollTo({top:0,behavior:"smooth"}))})})})}try{const n=lt("bp_prefill_slot",null);if(n&&n.start){const o=new Date(n.start),r=new Date(n.end||n.start),d=new Date(o.getTime()-o.getTimezoneOffset()*6e4).toISOString().slice(0,16);document.getElementById("a_start").value=d,document.getElementById("a_dur").value=String(Math.max(1,Math.round((r-o)/6e4))),N(),fe("Slot precompilato negli appuntamenti")}it("bp_prefill_slot")}catch(n){}try{const n=lt("bp_edit_aid",null);n&&Ie("/api/appointments").then(o=>{const d=(o&&o.appointments||[]).find(v=>String(v.id)===String(n));d&&(T(d),window.scrollTo({top:0,behavior:"smooth"}))}).finally(()=>{try{it("bp_edit_aid")}catch(o){}})}catch(n){}document.getElementById("btnSaveA").onclick=()=>ne(!1),document.getElementById("btnSaveExportA").onclick=()=>ne(!0),document.getElementById("btnDeleteA").onclick=a,Ie("/api/clients").then(()=>{}),p()}function le(){if(!Be())return s();document.title="Battle Plan ‚Äì Classifiche",m.innerHTML=je()+('<div class="wrap"><div class="card"><div class="row"><div><label>Vista</label><select id="lb_tab"><option value="per_indicator">Per indicatore</option><option value="overall">Generale (score)</option></select></div><div><label>Modalit√†</label><select id="lb_mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div><div id="lb_ind_wrap"><label>Indicatore</label><select id="lb_indicator"><option value="VSS">VSS</option><option value="VSDPersonale">VSD</option><option value="GI">GI</option><option value="NNCF">NNCF</option></select></div></div>'+D("lb")+'</div><div class="card"><b id="lb_title">Classifica</b><div id="lb_podium" style="margin:10px 0"></div><div id="lb_table"></div></div></div>'),Ue();function f(_){if(!_)return"";var B=new Date(_);return B.getFullYear()+"-"+("0"+(B.getMonth()+1)).slice(-2)+"-"+("0"+B.getDate()).slice(-2)}function y(_){return _==="ytd"||_==="ltm"?"mensile":_}document.getElementById("lb_tab").onchange=function(){var _=this.value;document.getElementById("lb_ind_wrap").style.display=_==="per_indicator"?"":"none",b()},H("lb",b),document.getElementById("lb_mode").onchange=b,document.getElementById("lb_indicator").onchange=b;function z(){var _=Y("lb"),B=f(_.start),G=f(_.end),I=y(_.type||"mensile");return"&from="+encodeURIComponent(B)+"&to="+encodeURIComponent(G)+"&type="+encodeURIComponent(I)}function b(){var _=document.getElementById("lb_tab").value,B=z(),G=document.getElementById("lb_mode").value;if(_==="overall")Ie("/api/leaderboard_overall?mode="+encodeURIComponent(G)+B).then(C);else{var I=document.getElementById("lb_indicator").value;Ie("/api/leaderboard?indicator="+encodeURIComponent(I)+"&mode="+encodeURIComponent(G)+B).then(function(w){L(w,I)})}}function U(_){return _===0?"ü•á":_===1?"ü•à":_===2?"ü•â":_+1+"."}function A(_){var B=document.getElementById("lb_podium");if(!_||!_.length){B.innerHTML="";return}for(var G=_.slice(0,3),I='<div class="row" style="align-items:flex-end">',w=0;w<G.length;w++){var g=80-w*15;I+='<div class="card" style="flex:1 1 120px;height:'+g+'px;display:flex;align-items:flex-end;justify-content:center"><div>'+De(U(w)+" "+G[w].name)+"</div></div>"}I+="</div>",B.innerHTML=I}function x(_,B,G){var I=Math.min(100,Math.max(0,Math.round(G)));return'<div class="card lb-card" style="flex:1 1 280px"><div class="big">'+De(_)+'</div><div class="small muted">'+De(B)+'</div><div class="lb-bar"><div style="width:'+I+'%"></div></div></div>'}function L(_,B){document.getElementById("lb_title").textContent="Classifica ‚Äì "+B;var G=_.ranking||[];if(A(G),!G.length){document.getElementById("lb_table").innerHTML='<div class="muted">Nessun dato</div>';return}for(var I='<div class="row">',w=G[0].total||1,g=0;g<G.length;g++){var P=G[g];I+=x(U(g)+" "+P.name,"Totale: "+Oe(P.total),P.total/w*100)}I+="</div>",document.getElementById("lb_table").innerHTML=I}function C(_){document.getElementById("lb_title").textContent="Classifica generale";var B=_.ranking||[];if(A(B),!B.length){document.getElementById("lb_table").innerHTML='<div class="muted">Nessun dato</div>';return}for(var G=B[0].score||0,I='<div class="row">',w=0;w<B.length;w++){var g=B[w];I+=x(U(w)+" "+g.name,"Score: "+Oe(g.score)+"/100",G?g.score/G*100:0)}I+="</div>",document.getElementById("lb_table").innerHTML=I}b()}(function(){function f(){var y=document.getElementById("bp-overlay");return y||(y=document.createElement("div"),y.id="bp-overlay",y.className="hidden",y.setAttribute("role","dialog"),y.setAttribute("aria-modal","true"),y.innerHTML='<div class="bp-overlay-backdrop" id="bp-overlay-backdrop"></div><div class="bp-overlay-panel" id="bp-overlay-panel"></div>',document.body.appendChild(y),document.getElementById("bp-overlay-backdrop").addEventListener("click",hideOverlay)),y}window.showOverlay=function(y){var z=f(),b=document.getElementById("bp-overlay-panel");b.innerHTML=y||"",z.classList.remove("hidden");var U=b.querySelector("input, textarea, select, button");U&&setTimeout(function(){try{U.focus()}catch(A){}},0)},window.hideOverlay=function(){var y=document.getElementById("bp-overlay");y&&y.classList.add("hidden")}})();function se(){if(!Be())return s();document.title="Battle Plan ‚Äì Clienti",m.innerHTML=je()+'<div class="wrap"><div class="card"><b>Nuovo cliente</b><div class="row" style="margin-top:8px"><div><label>Ragione sociale</label><input id="cl_name" type="text" placeholder="Es. Rossi S.r.l."></div><div><label>Stato</label><select id="cl_new_state"><option value="potenziale">Potenziale</option><option value="lead non chiuso">Lead non chiuso</option><option value="attivo">Attivo</option></select></div><div><label>Consulente</label><select id="cl_new_owner"><option value="">‚Äî</option></select></div><div class="right"><button id="cl_add">Aggiungi</button></div></div></div><div class="card"><b>Filtri elenco</b><div class="row" style="margin-top:8px"><div><label>Stato</label><select id="cl_f_state"><option value="">Tutti</option><option value="attivo">Attivo</option><option value="lead non chiuso">Lead non chiuso</option><option value="potenziale">Potenziale</option></select></div><div><label>Consulente</label><select id="cl_f_cons"><option value="">Tutti</option></select></div><div><label>Ordina per</label><select id="cl_order"><option value="az">Ragione sociale (A‚ÜíZ)</option><option value="last_desc">Ultimo appuntamento (recenti prima)</option></select></div><div class="right"><button class="ghost" id="cl_f_apply">Applica</button></div></div></div><div class="card"><b>Elenco clienti</b><div id="cl_list" class="row" style="margin-top:8px"></div></div></div>',Ue();function f(){const b=(document.getElementById("cl_name").value||"").trim();if(!b){fe("Nome obbligatorio");return}const U=document.getElementById("cl_new_state"),A=document.getElementById("cl_new_owner"),x={name:b};U&&(x.status=U.value),A&&A.value&&(x.consultantId=A.value),Le("/api/clients",x).then(function(){document.getElementById("cl_name").value="",z(),st(),window.addXP(5)}).catch(function(L){logger.error(L),fe("Errore creazione cliente")})}function y(){Ie("/api/usernames").then(function(b){const U=b&&b.users||[],A=document.getElementById("cl_f_cons"),x=document.getElementById("cl_new_owner");A&&(A.innerHTML='<option value="">Tutti</option>'+U.map(function(L){return'<option value="'+L.id+'">'+De(L.name)+(L.grade?" ("+L.grade+")":"")+"</option>"}).join("")),x&&(x.innerHTML='<option value="">‚Äî</option>'+U.map(function(L){return'<option value="'+L.id+'">'+De(L.name)+(L.grade?" ("+L.grade+")":"")+"</option>"}).join(""))}).catch(function(b){logger.error(b)})}function z(){Ie("/api/clients").then(function(b){const U=b&&b.clients||[],A=document.getElementById("cl_f_state").value,x=document.getElementById("cl_f_cons").value;function L(B){return String(B||"").trim().toLowerCase()}const _=U.filter(function(B){return!(A&&L(B.status)!==L(A)||x&&String(B.consultantId||"")!==String(x))}).map(function(B){const G=De(B.name||""),I=De(B.status||"potenziale"),w=B.consultantName?De(B.consultantName):"unknown",g=String(B.id||"");return'<div class="card" data-clid="'+g+'" data-name-lower="'+G.toLowerCase()+'" data-status="'+I+'" data-consultant-id="'+De(String(B.consultantId||""))+'" style="flex:1 1 380px"><div><b>'+G+'</b></div><div class="small">Stato: <b class="cl-status">'+I+'</b></div><div class="small">Consulente: <b class="cl-cons">'+w+'</b></div><div class="small muted">Ultimo appuntamento: <span class="last-appt">‚Äî</span></div><div class="right" style="margin-top:6px"><button class="ghost" data-del="'+g+'">Rimuovi</button></div></div>'}).join("");document.getElementById("cl_list").innerHTML=_||'<div class="muted">Nessun cliente</div>',document.querySelectorAll("[data-del]").forEach(function(B){B.addEventListener("click",function(){const G=B.getAttribute("data-del");confirm("Rimuovere il cliente?")&&fetch("/api/clients?id="+encodeURIComponent(G),{method:"DELETE",headers:{Authorization:"Bearer "+dt()}}).then(function(I){if(!I.ok)throw new Error("HTTP "+I.status);return I.json()}).then(function(){fe("Cliente rimosso"),z()}).catch(function(I){logger.error(I),fe("Errore rimozione")})})}),window.BPFinal&&typeof BPFinal.ensureClientSection=="function"?BPFinal.ensureClientSection():setTimeout(function(){const B=document.getElementById("cl_list"),G=Array.from(B.children).filter(I=>I.classList.contains("card"));G.sort((I,w)=>String(I.getAttribute("data-name-lower")||"").localeCompare(String(w.getAttribute("data-name-lower")||"")));for(const I of G)B.appendChild(I)},0)})}document.getElementById("cl_add").onclick=f,document.getElementById("cl_f_apply").onclick=z,y(),z(),typeof kickFinal=="function"&&kickFinal("clients")}function ve(){if(!Be())return s();document.title="Battle Plan ‚Äì Squadra";var f=je()+'<div class="wrap">'+('<div class="card"><b>Vista Amministratore</b><div id="t_adminbar" class="row" style="margin-top:8px;display:flex;align-items:flex-end;gap:16px;flex-wrap:wrap"><div><label>Modalit√†</label><select id="t_mode" name="mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div><div id="t_unified_wrap">'+D("t")+'</div></div></div><div class="card"><b>Riepilogo per utente</b><div id="t_users" class="row" style="margin-top:8px"></div></div><div class="card"><b>Aggregato Squadra</b><div id="t_agg" class="row" style="margin-top:8px"></div><div class="row" style="margin-top:12px;align-items:flex-end;gap:16px;flex-wrap:wrap"><div><label>Indicatore grafico</label><select id="t_ind"><option value="VSS">VSS</option><option value="VSDPersonale">VSD Personale</option><option value="VSDIndiretto">VSD Indiretto</option><option value="VSDTotale">VSD Totale</option><option value="GI">GI</option><option value="NNCF">NNCF</option><option value="provv_gi">Provv GI</option><option value="provv_vsd">Provv VSD</option><option value="tot_provv" selected>Tot Provvigioni</option></select></div><div><label>Consulente</label><select id="t_cons"><option value="">Tutti</option></select></div></div><div style="margin-top:8px"><canvas id="t_chart" height="160"></canvas></div></div>')+"</div>";m.innerHTML=f,Ue(),(function(){var R=document.getElementById("t_adminbar"),T=document.getElementById("t_unified_wrap");if(!(!R||!T)){var q=T.querySelector(".row");q&&(Array.from(q.children).forEach(function(ne){ne.classList.remove("right"),ne.style.marginTop="0",R.appendChild(ne)}),T.remove())}})();function y(E){return E=Number(E||0),isFinite(E)?E:0}function z(E){if(!E)return"";var R=new Date(E);return R.getFullYear()+"-"+("0"+(R.getMonth()+1)).slice(-2)+"-"+("0"+R.getDate()).slice(-2)}function b(E){return E=String(E||"mensile").toLowerCase(),E.indexOf("sett")===0?"settimanale":E.indexOf("mes")===0?"mensile":E.indexOf("tri")===0?"trimestrale":E.indexOf("sem")===0?"semestrale":E.indexOf("ann")===0?"annuale":"mensile"}function U(){var E=Y("t"),R=z(E.start),T=z(E.end),q=b(E.type);return"&from="+encodeURIComponent(R)+"&to="+encodeURIComponent(T)+"&type="+encodeURIComponent(q)}function A(E){switch(String(E)){case"provv_gi":return"ProvvGI";case"provv_vsd":return"ProvvVSD";case"tot_provv":return"TotProvvigioni";default:return E}}function x(E){var R=Number(E)||0;return R.toLocaleString("it-IT")+"‚Ç¨"}function L(E){var R=Number(E)||0;return String(Math.round(R))}function C(E){return String(E).replace(/[&<>'"]/g,R=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[R])}var _=null;function B(E,R){return R==="settimanale"?window.isoWeekNum?window.isoWeekNum(E):Math.ceil(E.getDate()/7):R==="mensile"||R==="ytd"||R==="ltm"?E.getMonth()+1:R==="trimestrale"?Math.floor(E.getMonth()/3)+1:R==="semestrale"?E.getMonth()<6?1:2:E.getFullYear()}function G(E,R){var T=document.getElementById("t_chart");if(T){var q=P(R),ne=typeof O=="function"?O(R,q):E.map(function(u){return B(u.x,R)}),a=E.map(function(u){return u.y});if(typeof Chart>"u"){var t=T.getContext("2d");T.width=T.clientWidth||600,T.height=T.clientHeight||160,t.clearRect(0,0,T.width,T.height);var e=Math.max(1,...a),i=a.length>1?(T.width-8)/(a.length-1):0;t.beginPath(),t.lineWidth=2,t.strokeStyle="#2e6cff",a.forEach(function(c,p){var n=4+p*i,o=T.height-6-c/e*(T.height-12);p?t.lineTo(n,o):t.moveTo(n,o)}),t.stroke(),t.fillStyle="#2e6cff",a.forEach(function(c,p){var n=4+p*i,o=T.height-6-c/e*(T.height-12);t.beginPath(),t.arc(n,o,2,0,Math.PI*2),t.fill()});return}var t=T.getContext("2d"),l=typeof window.computeTickOptions=="function"?window.computeTickOptions(ne,T.width||600):{autoSkip:!0,maxRotation:0,minRotation:0};if(_)_.data.labels=ne,_.data.datasets[0].data=a,_.options.scales.x.ticks=l,_.update();else{var h=typeof Chart.getChart=="function"?Chart.getChart(T):null;h&&h.destroy(),_=new Chart(t,{type:"line",data:{labels:ne,datasets:[{label:"",data:a,tension:.3,pointRadius:3,pointHoverRadius:5}]},options:{responsive:!1,maintainAspectRatio:!1,animation:!1,animations:!1,plugins:{legend:{display:!1}},scales:{x:{grid:{display:!1},ticks:l},y:{beginAtZero:!0}}}})}}}function I(E){return'<div class="card" style="flex:1 1 360px"><div style="display:flex;align-items:center;gap:8px"><div><b>'+C(E.name||"User #"+E.userId)+"</b></div>"+(E.grade?'<span class="chip small">'+C(E.grade)+"</span>":"")+'</div><div class="small" style="margin-top:6px">VSS '+x(E.vss||0)+'</div><div class="small">VSD Pers. '+x(E.vsdP||0)+'</div><div class="small">VSD Ind. '+x(E.vsdI||0)+'</div><div class="small">VSD Tot. '+x((E.vsdP||0)+(E.vsdI||0))+'</div><div class="small">GI '+x(E.gi||0)+'</div><div class="small">NNCF '+L(E.nncf||0)+'</div><div class="small muted" style="margin-top:6px">Provv GI '+x(E.provvGi||0)+'</div><div class="small muted">Provv VSD '+x(E.provvVsd||0)+'</div><div class="small"><b>Tot Provvigioni '+x(E.provvTot||0)+"</b></div></div>"}function w(E){return'<div class="card" style="flex:1 1 460px"><div class="neon" style="font-weight:900">Totali squadra</div><div class="small" style="margin-top:6px">VSS '+x(E.vss)+'</div><div class="small">VSD Pers. '+x(E.vsdP)+'</div><div class="small">VSD Ind. '+x(E.vsdI)+'</div><div class="small">VSD Tot. '+x(E.vsdP+E.vsdI)+'</div><div class="small">GI '+x(E.gi)+'</div><div class="small">NNCF '+L(E.nncf)+'</div><div class="small muted" style="margin-top:6px">Provv GI '+x(E.provvGi)+'</div><div class="small muted">Provv VSD '+x(E.provvVsd)+'</div><div class="small"><b>Tot Provvigioni '+x(E.provvTot)+"</b></div></div>"}function g(){var E=(document.getElementById("t_mode")||{}).value||"consuntivo",R=U();Promise.all([Ie("/api/usernames"),Ie("/api/leaderboard?indicator="+encodeURIComponent("VSS")+R+"&mode="+encodeURIComponent(E)),Ie("/api/leaderboard?indicator="+encodeURIComponent("VSDPersonale")+R+"&mode="+encodeURIComponent(E)),Ie("/api/leaderboard?indicator="+encodeURIComponent("VSDIndiretto")+R+"&mode="+encodeURIComponent(E)),Ie("/api/leaderboard?indicator="+encodeURIComponent("GI")+R+"&mode="+encodeURIComponent(E)),Ie("/api/leaderboard?indicator="+encodeURIComponent("NNCF")+R+"&mode="+encodeURIComponent(E)),Ie("/api/leaderboard?indicator="+encodeURIComponent("ProvvGI")+R+"&mode="+encodeURIComponent(E)),Ie("/api/leaderboard?indicator="+encodeURIComponent("ProvvVSD")+R+"&mode="+encodeURIComponent(E))]).then(function(T){var q=T[0]||{},ne=T[1]&&(T[1].rows||T[1].ranking)||[],a=T[2]&&(T[2].rows||T[2].ranking)||[],e=T[3]&&(T[3].rows||T[3].ranking)||[],i=T[4]&&(T[4].rows||T[4].ranking)||[],t=T[5]&&(T[5].rows||T[5].ranking)||[],l=T[6]&&(T[6].rows||T[6].ranking)||[],h=T[7]&&(T[7].rows||T[7].ranking)||[],u=(q.users||[]).map(function(K){return{id:String(K.id),name:K.name||K.email||"User #"+K.id,grade:K.grade==="senior"?"senior":"junior"}}),c=document.getElementById("t_cons");c&&(c.innerHTML='<option value="">Tutti</option>'+u.map(function(K){return'<option value="'+K.id+'">'+C(K.name)+"</option>"}).join(""));function p(K){for(var oe={},de=0;de<K.length;de++){var me=K[de],be=String(me.userId||me.id||me.uid||""),Se=y(me.total||me.value||me.sum||0);be&&(oe[be]=Se)}return oe}var n=p(ne),o=p(a),r=p(e),d=p(i),v=p(t),k=p(l),W=p(h),J=u.map(function(K){var oe=y(n[K.id]),de=y(o[K.id]),me=y(r[K.id]),be=y(d[K.id]),Se=y(v[K.id]),Pe=y(k[K.id]),ke=y(W[K.id]);return{userId:K.id,name:K.name,grade:K.grade,vss:oe,vsdP:de,vsdI:me,gi:be,nncf:Se,provvGi:Pe,provvVsd:ke,provvTot:Pe+ke}}),S=document.getElementById("t_users");S&&(S.innerHTML=J.length?J.map(I).join(""):'<div class="muted">Nessun dato</div>');var V=J.reduce(function(K,oe){return K.vss+=oe.vss,K.vsdP+=oe.vsdP,K.vsdI+=oe.vsdI,K.gi+=oe.gi,K.nncf+=oe.nncf,K.provvGi+=oe.provvGi,K.provvVsd+=oe.provvVsd,K.provvTot+=oe.provvTot,K},{vss:0,vsdP:0,vsdI:0,gi:0,nncf:0,provvGi:0,provvVsd:0,provvTot:0}),ae=document.getElementById("t_agg");ae&&(ae.innerHTML=w(V)),M()}).catch(function(T){logger.error(T),fe("Errore caricamento squadra")})}function P(E){return(typeof te=="function"?te(E,new Date):[]).map(function(R){return{s:R.s,e:R.e}})}function N(E,R,T,q){var ne=q||Y("t"),a=String(ne.type||"mensile").toLowerCase(),e=a==="ytd"||a==="ltm"?"mensile":a,i=P(a);function t(u,c){var p=new Date(c.startDate).getTime(),n=new Date(c.endDate).getTime();return p>=u.s&&n<=u.e}function l(u,c){if(!u)return 0;if(c==="VSDTotale")return Number(u.VSDPersonale||0)+Number(u.VSDIndiretto||0);if(c==="ProvvGI")return Number(u.ProvvGI||0);if(c==="ProvvVSD")return Number(u.ProvvVSD||0);if(c==="TotProvvigioni"){var p=u.TotProvvigioni;return Number(p!=null?p:Number(u.ProvvGI||0)+Number(u.ProvvVSD||0))}return Number(u[c]||0)}var h=(function(){var u=i.length?z(new Date(i[0].s)):z(new Date),c=i.length?z(new Date(i[i.length-1].e)):z(new Date),p="?global=1&type="+encodeURIComponent(e)+"&from="+encodeURIComponent(u)+"&to="+encodeURIComponent(c);return T&&(p+="&userId="+encodeURIComponent(T)),p})();return Ie("/api/periods"+h).catch(function(){return Ie("/api/periods"+h.replace("?global=1",""))}).then(function(u){var c=u&&u.periods||[],p=c.filter(function(o){return!(o.type!==e||T&&String(o.userId||o.uid||"")!==String(T))}),n=i.map(function(o){for(var r=0,d=0;d<p.length;d++){var v=p[d];if(t(o,v)){var k=R==="previsionale"?v.indicatorsPrev||{}:v.indicatorsCons||{};r+=l(k,A(E))}}return{x:new Date(o.s),y:Math.round(r*100)/100}});return n})}function M(){var E=document.getElementById("t_ind").value,R=document.getElementById("t_mode").value||"consuntivo",T=document.getElementById("t_cons").value||"",q=Y("t"),ne=q.type,a=A(E);U()+(T?"&userId="+encodeURIComponent(T):"")+("&indicator="+encodeURIComponent(a))+("&mode="+encodeURIComponent(R));var e=N(a,R,T||null,q);e.then(function(i){G(i,ne)}).catch(function(i){logger.error(i),G([],ne)})}H("t",function(){typeof haptic=="function"&&haptic("light"),g()}),document.getElementById("t_mode").onchange=function(){typeof haptic=="function"&&haptic("light"),g()},document.getElementById("t_ind").onchange=function(){typeof haptic=="function"&&haptic("light"),M()},document.getElementById("t_cons").onchange=function(){typeof haptic=="function"&&haptic("light"),M()},g()}function ce(){if(!Be())return s();var f=Be().role==="admin";document.title="Battle Plan ‚Äì Provvigioni",m.innerHTML=je()+'<div class="wrap"><div class="card"><b>Calcolo provvigioni</b><div class="row" style="margin-top:8px; gap:12px; flex-wrap:wrap">'+(f?'<div><label>Utente</label><select id="comm_user"><option value="__all">Tutta la squadra</option></select></div>':"")+'<div><label>Modalit√†</label><select id="comm_mode" name="mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div></div>'+D("comm")+'</div><div class="card"><b>Indicatori periodo</b><div id="comm_total" class="row" style="margin-top:8px; gap:12px; flex-wrap:wrap"></div></div><div class="card"><b>Provvigioni ‚Äì ripartizione</b><div class="small muted">Confronto tra Provvigioni GI e Provvigioni VSD sul periodo selezionato</div><div class="row" style="margin-top:8px; align-items:center; gap:16px; flex-wrap:wrap"><canvas id="cm_pie_provv" width="260" height="260" style="max-width:260px; max-height:260px"></canvas><div id="cm_pie_legend" class="small"></div></div></div><div class="card"><b>Dettaglio</b><div id="comm_rows" class="row" style="margin-top:8px; gap:12px; flex-wrap:wrap"></div></div></div>',Ue();function y(I){return document.getElementById(I)}function z(I){if(!I)return"";var w=new Date(I);return w.getFullYear()+"-"+("0"+(w.getMonth()+1)).slice(-2)+"-"+("0"+w.getDate()).slice(-2)}function b(I){var w=Number(I)||0;return w.toLocaleString("it-IT")+"‚Ç¨"}function U(I){return I=Number(I==null?"":I),isFinite(I)?I:0}function A(I){return I?I.TotProvvigioni!=null?U(I.TotProvvigioni):U(I.ProvvGI)+U(I.ProvvVSD):0}function x(I,w){return'<div class="card" style="flex:1 1 180px"><div class="small muted">'+De(I)+'</div><div style="font-weight:700; font-size:20px; margin-top:4px">'+w+"</div></div>"}function L(I){return""+x("VSD personale",b(I.vsd||0))+x("GI",b(I.gi||0))+x("Provv. VSD",b(I.provv_vsd||0))+x("Provv. GI",b(I.provv_gi||0))+x("Totale Provvigioni",b(I.provv_total||0))}function C(I){return I.length?I.map(function(w){return'<div class="card" style="flex:1 1 320px"><div><b>'+De(w.name)+'</b></div><div class="small" style="margin-top:4px">GI '+b(w.gi||0)+" ¬∑ VSD "+b(w.vsd||0)+'</div><div class="small muted" style="margin-top:2px">Provv. GI '+b(w.provv_gi||0)+" ¬∑ Provv. VSD "+b(w.provv_vsd||0)+'</div><div class="small" style="margin-top:6px"><b>Totale: '+b(w.provv_total||0)+"</b></div></div>"}).join(""):'<div class="muted">Nessun dato</div>'}function _(I,w,g){var P=document.getElementById("cm_pie_provv"),N=document.getElementById("cm_pie_legend");if(!P||!P.getContext){N&&(N.innerHTML="");return}var M=P.getContext("2d"),E=P.width,R=P.height,T=E/2,q=R/2,ne=Math.min(E,R)/2-8;M.clearRect(0,0,E,R);var a=Math.max(0,I||0),e=Math.max(0,w||0),i=a+e,t=g>0?Math.round(i/g*100):null;if(i<=0){M.beginPath(),M.arc(T,q,ne,0,Math.PI*2),M.strokeStyle="#ccd0d5",M.lineWidth=10,M.setLineDash([6,6]),M.stroke(),M.setLineDash([]),M.globalCompositeOperation="destination-out",M.beginPath(),M.arc(T,q,ne*.55,0,Math.PI*2),M.fill(),M.globalCompositeOperation="source-over",M.fillStyle="#111",M.textAlign="center",M.textBaseline="middle",M.font="bold 20px system-ui, -apple-system, Segoe UI, Roboto, sans-serif",M.fillText(t==null?"‚Äî":t+"%",T,q),N&&(N.innerHTML='<div class="muted">Nessuna provvigione nel periodo</div>');return}var l=[{label:"Provv. GI",value:a,color:"#4F8EF7"},{label:"Provv. VSD",value:e,color:"#F79F4F"}],h=-Math.PI/2;l.forEach(function(p){var n=p.value/i*Math.PI*2;M.beginPath(),M.moveTo(T,q),M.arc(T,q,ne,h,h+n),M.closePath(),M.fillStyle=p.color,M.fill(),h+=n}),M.globalCompositeOperation="destination-out",M.beginPath(),M.arc(T,q,ne*.55,0,Math.PI*2),M.fill(),M.globalCompositeOperation="source-over",M.fillStyle="#111",M.textAlign="center",M.textBaseline="middle",M.font="bold 20px system-ui, -apple-system, Segoe UI, Roboto, sans-serif",M.fillText(t==null?"‚Äî":t+"%",T,q);var u=Math.round(a/i*100),c=Math.round(e/i*100);N&&(N.innerHTML='<div class="row" style="gap:16px; flex-wrap:wrap"><div class="row" style="gap:8px; align-items:center"><span style="display:inline-block;width:12px;height:12px;background:#4F8EF7;border-radius:3px"></span><span><b>Provv. GI</b> '+b(a)+" ¬∑ "+u+'%</span></div><div class="row" style="gap:8px; align-items:center"><span style="display:inline-block;width:12px;height:12px;background:#F79F4F;border-radius:3px"></span><span><b>Provv. VSD</b> '+b(e)+" ¬∑ "+c+"%</span></div></div>")}function B(){var I=Y("comm"),w=y("comm_mode").value||"consuntivo",g=f?y("comm_user").value||"__all":String(Be().id),P=new Date(I.start).getTime(),N=new Date(I.end).getTime(),M=ee(I.type||"mensile"),E=(function(){var R=z(new Date(P)),T=z(new Date(N)),q="?type="+encodeURIComponent(M)+"&from="+encodeURIComponent(R)+"&to="+encodeURIComponent(T);return f&&g&&g!=="__all"&&(q+="&userId="+encodeURIComponent(g)),q})();Ie("/api/periods"+E).then(function(R){var T=R&&R.periods||[],q=T.filter(function(e){if(e.type!==M)return!1;var i=new Date(e.startDate).getTime(),t=new Date(e.endDate).getTime();return!(i<P||t>N||f&&g!=="__all"&&String(e.userId||e.uid||"")!==String(g)||!f&&String(e.userId||e.uid||"")!==String(Be().id))}),ne={gi:0,vsd:0,provv_gi:0,provv_vsd:0,provv_total:0},a={};q.forEach(function(e){var i=w==="previsionale"?e.indicatorsPrev||{}:e.indicatorsCons||{},t=String(e.userId||e.uid||""),l=e.userName||e.name||"User "+t,h=U(i.GI),u=U(i.VSDPersonale),c=U(i.ProvvGI),p=U(i.ProvvVSD),n=A(i);ne.gi+=h,ne.vsd+=u,ne.provv_gi+=c,ne.provv_vsd+=p,ne.provv_total+=n,a[t]||(a[t]={userId:t,name:l,gi:0,vsd:0,provv_gi:0,provv_vsd:0,provv_total:0}),a[t].gi+=h,a[t].vsd+=u,a[t].provv_gi+=c,a[t].provv_vsd+=p,a[t].provv_total+=n}),y("comm_total").innerHTML=L(ne),y("comm_rows").innerHTML=C(Object.values(a).sort(function(e,i){return(i.provv_total||0)-(e.provv_total||0)})),_(ne.provv_gi||0,ne.provv_vsd||0,ne.gi||0)}).catch(function(R){logger.error(R),fe("Errore nel caricamento dati")})}function G(){f&&Ie("/api/usernames").then(function(I){var w=y("comm_user");if(w){for(var g='<option value="__all">Tutta la squadra</option>',P=I&&I.users||[],N=0;N<P.length;N++){var M=P[N];g+='<option value="'+M.id+'">'+De(M.name||"User "+M.id)+"</option>"}w.innerHTML=g}})}H("comm",function(){B()}),y("comm_mode").onchange=function(){haptic("light"),B()},f&&(y("comm_user").onchange=function(){haptic("light"),B()}),G(),B()}function xe(){if(!Be())return s();document.title="Battle Plan ‚Äì Vendite e Riordini",m.innerHTML=je()+'\n    <div class="wrap">\n\n      <div class="card">\n        <b>Filtro</b>\n        <div class="row" style="margin-top:6px;align-items:flex-end;gap:16px;flex-wrap:wrap">\n          <div>\n            <label>Consulente</label>\n            <select id="vr_cons"><option value="">Tutti</option></select>\n          </div>\n        </div>\n        '.concat(D("vr"),'\n      </div>\n\n      <div class="card">\n        <b>Vendite e Riordini</b>\n        <div class="table" style="overflow:auto">\n          <table class="simple" style="min-width:980px">\n            <thead>\n              <tr>\n                <th>Data</th>\n                <th>Cliente</th>\n                <th>Consulente</th>\n              </tr>\n            </thead>\n            <tbody id="vr_rows">\n              <tr><td colspan="3" class="muted">Nessun dato</td></tr>\n            </tbody>\n          </table>\n        </div>\n      </div>\n\n    </div>'),Ue(),H("vr",()=>{})}function ge(){if(!Be())return s();document.title="Battle Plan ‚Äì GI & Scadenzario",m.innerHTML=je()+'\n  <div class="wrap">\n\n    <div class="card">\n      <b>Filtro</b>\n      <div class="row" style="margin-top:6px;align-items:flex-end;gap:16px;flex-wrap:wrap">\n        <div>\n          <label>Consulente</label>\n          <select id="gi_cons"><option value="">Tutti</option></select>\n        </div>\n      </div>\n      '.concat(D("gi"),'\n    </div>\n\n    <div class="card">\n      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">\n        <b>Vendite (GI)</b>\n        <button class="ghost" id="gi_add">Nuova vendita</button>\n      </div>\n      <div class="table" style="overflow:auto">\n        <table class="simple" style="min-width:980px">\n          <thead>\n            <tr>\n              <th>Data vendita</th>\n              <th>Cliente</th>\n              <th>Consulente</th>\n              <th>Servizi</th>\n              <th style="text-align:right">Tot. VSS</th>\n              <th>Piano pagamenti</th>\n              <th></th>\n            </tr>\n          </thead>\n          <tbody id="gi_rows"></tbody>\n        </table>\n      </div>\n    </div>\n\n  </div>'),Ue();const f=w=>document.getElementById(w),y=w=>String(w||"").replace(/[&<>'"]/g,g=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[g]),z=w=>(Number(w)||0).toLocaleString("it-IT")+"‚Ç¨",b=w=>{const g=new Date(w);return g.getFullYear()+"-"+("0"+(g.getMonth()+1)).slice(-2)+"-"+("0"+g.getDate()).slice(-2)};function U(){const w=window.readUnifiedRange&&window.readUnifiedRange("gi")||{};if(!w||!w.start||!w.end){const g=new Date,P=new Date(g.getFullYear(),0,1),N=new Date(g.getFullYear(),11,31,23,59,59);return{from:b(P),to:b(N)}}return{from:b(w.start),to:b(w.end)}}let A=[];function x(){return Ie("/api/clients").then(w=>(A=w&&w.clients||[],Ie("/api/usernames"))).then(w=>{const g=w&&w.users||[],P=f("gi_cons");P&&(P.innerHTML='<option value="">Tutti</option>'+g.map(N=>'<option value="'+y(String(N.id))+'">'+y(N.name)+"</option>").join(""))})}function L(w){const g=Array.isArray(w.schedule)?w.schedule.slice():[];if(!g.length)return'<span class="muted">‚Äî</span>';const P=g.find(T=>T.kind==="deposit"||/acconto/i.test(T.note||"")),N=g.filter(T=>T!==P),M=P?"Acconto: "+z(P.amount):"";if(!N.length)return M||'<span class="muted">‚Äî</span>';const E=Math.round(N[0].amount||0),R=N.every(T=>Math.abs(Math.round(T.amount||0)-E)<=1);return(M?M+" + ":"")+(R?N.length+" rate da "+z(E):"piano personalizzato")}function C(w){return'<tr data-id="'+y(String(w.id))+'"><td>'+new Date(w.date||w.createdAt).toLocaleDateString("it-IT")+"</td><td>"+y(w.clientName||"")+"</td><td>"+y(w.consultantName||"")+"</td><td>"+y(w.services||"")+'</td><td style="text-align:right"><b>'+z(w.vssTotal||0)+"</b></td><td>"+L(w)+'</td><td class="right"><button class="ghost" data-edit="'+y(String(w.id))+'">Modifica</button></td></tr>'}function _(){const w=U(),g=(f("gi_cons")||{}).value||"",P="?from="+encodeURIComponent(w.from)+"&to="+encodeURIComponent(w.to)+(g?"&userId="+encodeURIComponent(g):"");Ie("/api/gi"+P).then(N=>{let M=N&&N.sales||[];M.sort((E,R)=>+new Date(R.date||R.createdAt||0)-+new Date(E.date||E.createdAt||0)),f("gi_rows").innerHTML=M.length?M.map(C).join(""):'<tr><td colspan="7" class="muted">Nessuna vendita</td></tr>',G()}).catch(N=>{logger.error(N),fe("Errore caricamento GI")})}function B(w){const g=w.sale||{},P=Array.isArray(g.schedule)?g.schedule.slice():[],N=P.find(r=>r.kind==="deposit"||/acconto/i.test(r.note||"")),M=P.filter(r=>r!==N),E=M.length>0?M.every(r=>Math.abs((+r.amount||0)-(+M[0].amount||0))<=1):!0,R=M.length&&E?"rate":"manual",T=b(new Date),q='<div class="modal"><div class="card gi-modal"><style>.gi-modal{min-width:min(760px,96vw);max-width:980px;max-height:86vh;overflow:auto}@media (max-width:740px){ .gi-grid{display:block} .gi-col{width:100%} .gi-modal{min-width:96vw} }.gi-grid{display:flex; gap:12px; flex-wrap:wrap} .gi-col{flex:1; min-width:240px}.gi-section{border-top:1px solid var(--hair, rgba(0,0,0,.12)); padding-top:10px; margin-top:10px}.pilltabs{display:flex; gap:12px; align-items:center} .pilltabs label{display:flex; align-items:center; gap:6px; cursor:pointer}.mrow{display:flex; gap:8px; align-items:center; flex-wrap:wrap}.mini input[type=number]{width:120px}.gi-rlist{margin-top:6px; max-height:200px; overflow:auto; border:1px dashed rgba(0,0,0,.15); border-radius:8px; padding:6px}.gi-r{display:flex; gap:6px; align-items:center; padding:4px 0}.gi-foot{display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:12px}</style><div style="display:flex;justify-content:space-between;align-items:center"><b>'+(w.title||(g.id?"Modifica vendita":"Nuova vendita"))+'</b><button class="ghost" id="m_close">Chiudi</button></div><div class="gi-grid"><div class="gi-col"><label>Data</label><input id="m_date" type="date" value="'+y(b(g.date||T))+'"></div><div class="gi-col"><label>Cliente</label><select id="gi_client_select"><option value="">Caricamento‚Ä¶</option></select></div><div class="gi-col"><label>Totale VSS</label><input id="m_vss" type="number" step="1" value="'+y(Number(g.vssTotal||0))+'"></div></div><div class="gi-section"><label>Servizi</label><textarea id="m_srv" rows="2">'+y(g.services||"")+'</textarea></div><div class="gi-section"><b>Acconto</b><div class="mrow mini" style="margin-top:6px"><label><input id="acc_enable" type="checkbox" '+(N?"checked":"")+'> Abilita</label><label>Tipo</label><select id="acc_type"><option value="abs">Valore assoluto</option><option value="perc">Percentuale</option></select><label>Valore</label><input id="acc_value" type="number" step="1" value="'+(N?y(Number(N._fromPerc?N._rawPerc:N.amount)):"0")+'"><label>Scadenza</label><input id="acc_date" type="date" value="'+y(b(N?N.dueDate:g.date||T))+'"><label>Nota</label><input id="acc_note" placeholder="es. Acconto" value="'+y(N&&N.note||"Acconto")+'"></div></div><div class="gi-section"><b>Modalit√† pagamenti</b><div class="pilltabs" style="margin:6px 0 8px"><label><input type="radio" name="pmode" value="rate" '+(R==="rate"?"checked":"")+'> Rateale</label><label><input type="radio" name="pmode" value="manual" '+(R!=="rate"?"checked":"")+'> Scaglioni manuali</label></div><div id="p_rate" style="display:'+(R==="rate"?"block":"none")+'"><div class="mrow mini"><label>N¬∞ rate</label><input id="rt_n" type="number" value="'+y(M.length||12)+'"><label>Frequenza</label><select id="rt_freq"><option value="M">Mensile</option><option value="Q">Trimestrale</option><option value="W">Settimanale</option><option value="Y">Annuale</option></select><label>Prima scadenza</label><input id="rt_first" type="date" value="'+y(M[0]?b(M[0].dueDate):b(g.date||T))+'"><button class="ghost" id="rt_build">Ricalcola rate</button></div><div id="rt_preview" class="gi-rlist muted small">‚Äî</div></div><div id="p_manual" style="display:'+(R!=="rate"?"block":"none")+'"><div class="mrow mini"><button class="ghost" id="mn_add">Aggiungi scaglione</button></div><div id="mn_list" class="gi-rlist"></div></div></div><div class="gi-foot"><div><div id="tot_prog" class="small muted">Programmato: 0‚Ç¨</div><div id="tot_chk"  class="small muted">Totale VSS: 0‚Ç¨</div></div><div style="display:flex;gap:8px">'+(g.id?'<button class="ghost danger" id="m_del">Elimina</button>':"")+'<button id="m_save">Salva</button></div></div></div></div>';showOverlay(q);const ne=document.documentElement.style.overflow;document.documentElement.style.overflow="hidden";function a(){document.documentElement.style.overflow=ne,hideOverlay()}(function(){const d=f("gi_client_select");d.innerHTML='<option value="">‚Äî seleziona cliente ‚Äî</option>'+A.map(k=>'<option value="'+y(k.id)+'">'+y(k.name)+"</option>").join("");const v=g.clientId||g.client_id||"";if(v&&(d.value=String(v)),!d.value&&g.clientName){const k=A.find(W=>String(W.name).trim().toLowerCase()===String(g.clientName).trim().toLowerCase());k&&(d.value=String(k.id))}})(),N&&N._fromPerc&&(f("acc_type").value="perc"),Array.from(document.querySelectorAll('input[name="pmode"]')).forEach(r=>{r.addEventListener("change",()=>{const d=document.querySelector('input[name="pmode"]:checked').value==="rate";f("p_rate").style.display=d?"block":"none",f("p_manual").style.display=d?"none":"block",o()})});function e(r,d){const v=new Date(r);return v.setMonth(v.getMonth()+d),v}function i(r,d){const v=new Date(r);return v.setDate(v.getDate()+d*7),v}function t(r,d){const v=new Date(r);return v.setMonth(v.getMonth()+d*3),v}function l(r,d){const v=new Date(r);return v.setFullYear(v.getFullYear()+d),v}function h(){const r=Math.max(1,Number(f("rt_n").value||0)),d=f("rt_freq").value,v=new Date(f("rt_first").value||T),k=Math.max(0,Number(f("m_vss").value||0)),W=p(),J=Math.max(0,k-W),S=Math.round(J/r),V=[];for(let ae=0;ae<r;ae++){let K;d==="M"?K=e(v,ae):d==="Q"?K=t(v,ae):d==="W"?K=i(v,ae):K=l(v,ae),V.push({dueDate:K.toISOString(),amount:S,note:"Rata "+(ae+1)+"/"+r,kind:"installment"})}return u(V),V}function u(r){f("rt_preview").innerHTML=r.map(d=>"<div>"+new Date(d.dueDate).toLocaleDateString("it-IT")+" ¬∑ "+z(d.amount)+' <span class="muted">'+y(d.note||"")+"</span></div>").join(""),f("rt_preview")._data=r,o()}function c(r){const d=f("mn_list");d.innerHTML="",r.forEach((v,k)=>{const W=document.createElement("div");W.className="gi-r",W.innerHTML='<input type="date" data-k="dueDate" value="'+y(b(v.dueDate))+'"><input type="number" step="1" data-k="amount" value="'+y(Number(v.amount||0))+'" style="width:120px"><input type="text" data-k="note"   value="'+y(v.note||"")+'" placeholder="nota" style="flex:1"><button class="ghost" data-del="'+k+'">‚úï</button>',d.appendChild(W)}),d.querySelectorAll("[data-del]").forEach(v=>{v.onclick=()=>{const k=Number(v.getAttribute("data-del")),W=d._data||[];W.splice(k,1),c(W)}}),d.oninput=()=>{const v=d._data||[];Array.from(d.children).forEach((W,J)=>{const S=v[J];if(!S)return;const V=W.querySelector('[data-k="dueDate"]').value,ae=Number(W.querySelector('[data-k="amount"]').value||0),K=W.querySelector('[data-k="note"]').value;S.dueDate=new Date(V).toISOString(),S.amount=Math.round(ae),S.note=K}),o()},d._data=r,o()}if(f("m_date").value=y(b(g.date||T)),f("m_vss").value=y(Number(g.vssTotal||0)),f("m_srv").value=y(g.services||""),f("acc_type").value=N&&N._fromPerc?"perc":"abs",f("acc_value").value=N?N._fromPerc?N._rawPerc:N.amount:0,f("acc_date").value=y(b(N?N.dueDate:g.date||T)),f("acc_note").value=N?y(N.note||"Acconto"):"Acconto",R==="rate"){const r=M.length||12;f("rt_n").value=r,f("rt_first").value=M[0]?y(b(M[0].dueDate)):y(b(g.date||T)),u(M.length?M:h())}else c(M);f("rt_build").onclick=()=>u(h()),f("mn_add").onclick=()=>{const d=f("mn_list")._data||[];d.push({dueDate:new Date().toISOString(),amount:0,note:"",kind:"manual"}),c(d)},f("m_close").onclick=a;function p(){if(!f("acc_enable").checked)return 0;const r=Math.max(0,Number(f("m_vss").value||0)),d=f("acc_type").value,v=Number(f("acc_value").value||0);return Math.round(d==="perc"?r*(v/100):v)}function n(){const r=[];if(f("acc_enable").checked){const v=p();r.push({dueDate:new Date(f("acc_date").value||T).toISOString(),amount:v,note:f("acc_note").value||"Acconto",kind:"deposit",_fromPerc:f("acc_type").value==="perc",_rawPerc:Number(f("acc_value").value||0)})}if(document.querySelector('input[name="pmode"]:checked').value==="rate"){const v=(f("rt_preview")._data||[]).map(k=>Object.assign({},k));return r.concat(v)}else{const v=(f("mn_list")._data||[]).map(k=>Object.assign({kind:"manual"},k));return r.concat(v)}}function o(){const r=Math.max(0,Number(f("m_vss").value||0)),d=n(),v=Math.round(d.reduce((k,W)=>k+Number(W.amount||0),0));f("tot_prog").textContent="Programmato: "+z(v),f("tot_chk").textContent="Totale VSS: "+z(r)+(v===r?" OK":" (manca "+z(r-v)+")"),f("m_save").disabled=v!==r||!f("gi_client_select").value}if(["m_vss","acc_enable","acc_type","acc_value","acc_date","rt_n","rt_freq","rt_first"].forEach(r=>{const d=f(r);d&&d.addEventListener("input",o)}),f("gi_client_select").addEventListener("change",o),o(),f("m_save").onclick=()=>{const r=f("gi_client_select").value||"",d=A.find(k=>String(k.id)===String(r));if(!d){fe("Seleziona un cliente");return}const v={id:g.id||void 0,date:new Date(f("m_date").value||T).toISOString(),clientId:d.id,clientName:d.name,vssTotal:Math.round(Number(f("m_vss").value||0)),services:f("m_srv").value||"",schedule:n()};Promise.resolve(Le("/api/gi",v)).then(()=>{a(),haptic("light"),_()}).catch(k=>{logger.error(k),fe("Errore salvataggio")})},g.id){const r=f("m_del");r&&(r.onclick=async()=>{if(!confirm("Eliminare definitivamente questa vendita?"))return;const d=g?JSON.parse(JSON.stringify(g)):null;try{if(await Le("/api/gi/delete",{id:g.id}).catch(()=>Le("/api/gi",{id:g.id,_delete:1})),a(),fe("Vendita eliminata"),_(),typeof showUndo=="function"&&d){const v={date:new Date(d.date||d.createdAt||new Date).toISOString(),clientId:d.clientId,clientName:d.clientName,vssTotal:Math.round(Number(d.vssTotal||0)),services:d.services||"",schedule:Array.isArray(d.schedule)?d.schedule:[]};showUndo("Vendita eliminata",function(){return Le("/api/gi",v).then(function(){_()})},5e3)}}catch(v){logger.error(v),fe("Errore eliminazione")}})}}function G(){document.querySelectorAll("[data-edit]").forEach(w=>{w.addEventListener("click",()=>{const g=w.getAttribute("data-edit");I(g)})})}document.addEventListener("gi:edit",function(w){const g=w&&w.detail&&w.detail.id;g&&I(g)}),f("gi_add").onclick=()=>{B({title:"Nuova vendita"})};function I(w){Ie("/api/gi?from=1900-01-01&to=2999-12-31").then(g=>{const P=(g&&g.sales||[]).find(N=>String(N.id)===String(w));if(!P){fe("Vendita non trovata");return}B({title:"Modifica vendita",sale:P})})}H("gi",()=>{haptic("light"),_()}),(f("gi_cons")||{}).onchange=()=>{haptic("light"),_()},x().then(_)}window.viewGI=window.viewGI||ge;function _e(){if(!Be())return s();document.title="Battle Plan ‚Äì Report",m.innerHTML=je()+'<div class="wrap"><div class="card"><b>Sezioni da includere</b><div id="rep_toggles" class="row" style="margin-top:8px; gap:8px; flex-wrap:wrap"><button class="pill" data-type="mensile" id="tog_mese">Mese</button><button class="pill" data-type="trimestrale" id="tog_trimestre">Trimestre</button><button class="pill" data-type="semestrale" id="tog_semestre">Semestre</button><button class="pill" data-type="annuale" id="tog_anno">Anno</button></div></div><div class="card"><b>Report</b><div class="row" style="margin-top:8px"><div style="min-width:320px"><label>Oggetto email</label><input id="report_subject" placeholder="Report BP"></div></div><div class="row" style="margin-top:8px; flex-wrap:wrap"><div style="flex:1 1 100%; min-width:0"><label>Corpo email</label><textarea id="report_body" rows="12" placeholder="Testo del report‚Ä¶" style="width:100%; box-sizing:border-box; overflow:auto; resize:vertical; max-height:70vh; white-space:pre-wrap; word-break:break-word"></textarea></div></div><div class="row" id="report-actions" style="gap:8px;margin-top:8px;flex-wrap:wrap"><button class="ghost" id="rep_copy">Copia report</button><span style="flex:0 0 8px"></span><button class="ghost" id="rep_gmail_web">Gmail Web</button><button class="ghost" id="rep_gmail_app">Gmail App</button></div></div></div>',Ue();var f=[],y={mensile:!1,trimestrale:!1,semestrale:!1,annuale:!1},z=[{k:"VSS",money:!0,label:"VSS"},{k:"VSDPersonale",money:!0,label:"VSDPersonale"},{k:"VSDIndiretto",money:!0,label:"VSDIndiretto"},{k:"GI",money:!0,label:"GI"},{k:"Telefonate",money:!1,label:"Telefonate"},{k:"AppFissati",money:!1,label:"AppFissati"},{k:"AppFatti",money:!1,label:"AppFatti"},{k:"CorsiLeadership",money:!1,label:"CorsiLeadership"},{k:"iProfile",money:!1,label:"iProfile"},{k:"MBS",money:!1,label:"MBS"},{k:"NNCF",money:!1,label:"NNCF"}];function b(S){return document.getElementById(S)}var U=b("report_body");function A(S,V){var ae=new Date(S.getTime());return ae.setDate(ae.getDate()+V),ae}function x(S){return et(S.getFullYear(),Ne(S))}function L(S){var V=x(S);return x(A(V.start,7))}function C(S){var V=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];return V[S.getMonth()]}function _(S){return Math.floor(S.getMonth()/3)+1}function B(S){return S.getMonth()<6?1:2}function G(S){var V=S.getDay();return V===5||V===6||V===0}function I(S,V){return S==="mensile"?{start:ft(V),end:gt(V)}:S==="trimestrale"?{start:ut(V),end:ht(V)}:S==="semestrale"?{start:pt(V),end:wt(V)}:{start:bt(V),end:ct(V)}}function w(S,V){return V>=A(S,-7)&&V<=A(S,5)}function g(S,V){var ae=I(S,V),K=I(S,A(ae.start,-1)),oe=I(S,A(ae.end,1)),de=w(K.end,V),me=w(ae.end,V);return de&&!me?{closing:K,next:ae}:{closing:ae,next:oe}}function P(S,V,ae){for(var K=0;K<f.length;K++){var oe=f[K];if(oe.type===S&&Fe(oe.startDate)===Fe(V)&&Fe(oe.endDate)===Fe(ae))return oe}return null}function N(S,V){var ae=S&&S[V];return Number(ae||0)}function M(S){return Oe(S)+"‚Ç¨"}function E(S,V){var ae=z.some(function(K){return K.k===S&&K.money});return ae?M(V):Oe(V)}function R(S,V){return S>V?"‚Üë":S<V?"‚Üì":"="}function T(S,V,ae,K){var oe=P(V,ae,K)||{},de=oe.indicatorsPrev||{},me=oe.indicatorsCons||{},be=[S,""];return z.forEach(function(Se){var Pe=N(de,Se.k),ke=N(me,Se.k);be.push(Se.label+" "+E(Se.k,ke)+" vs "+E(Se.k,Pe)+" di previsionali ("+R(ke,Pe)+")")}),be.push("Note:"),be.join("\n")}function q(S,V,ae,K){var oe=P(V,ae,K)||{},de=oe.indicatorsPrev||{},me=[S,""];return z.forEach(function(be){me.push(be.label+" "+E(be.k,N(de,be.k)))}),me.push("Possibili note:"),me.join("\n")}function ne(S){return"BP CONSUNTIVO SETT. "+Ne(S)+" "+S.getFullYear()}function a(S){return"BP PREVISIONALE SETT. "+Ne(S)+" "+S.getFullYear()}function e(S){return"BP CONSUNTIVO "+C(S)+" "+S.getFullYear()}function i(S){var V=C(S);return"BP PREVISIONALE "+V+" "+S.getFullYear()}function t(S){return"BP CONSUNTIVO T"+_(S)+" "+S.getFullYear()}function l(S){return"BP PREVISIONALE T"+_(S)+" "+S.getFullYear()}function h(S){return"BP CONSUNTIVO S"+B(S)+" "+S.getFullYear()}function u(S){return"BP PREVISIONALE S"+B(S)+" "+S.getFullYear()}function c(S){return"BP CONSUNTIVO "+S.getFullYear()}function p(S){return"BP PREVISIONALE "+S.getFullYear()}function n(){var S=new Date,V=[];if(G(S)){var ae=x(S),K=L(S);V.push(T(ne(ae.start),"settimanale",ae.start,ae.end)),V.push(q(a(K.start),"settimanale",K.start,K.end))}function oe(de,me,be){var Se=g(de,S);V.push(T(me(Se.closing.start),de,Se.closing.start,Se.closing.end)),V.push(q(be(Se.next.start),de,Se.next.start,Se.next.end))}y.mensile&&oe("mensile",e,i),y.trimestrale&&oe("trimestrale",t,l),y.semestrale&&oe("semestrale",h,u),y.annuale&&oe("annuale",c,p),U.value=V.join("\n\n")+(V.length?"\n":"")}function o(S,V){S.classList.toggle("active",!!V),S.style.opacity=V?"1":"0.65"}function r(){o(b("tog_mese"),y.mensile),o(b("tog_trimestre"),y.trimestrale),o(b("tog_semestre"),y.semestrale),o(b("tog_anno"),y.annuale)}function d(){var S=new Date;function V(ae){var K=I(ae,S),oe=I(ae,A(K.start,-1));return w(K.end,S)||w(oe.end,S)}y.mensile=V("mensile"),y.trimestrale=V("trimestrale"),y.semestrale=V("semestrale"),y.annuale=V("annuale"),r()}function v(){function S(V){var ae=V.currentTarget.getAttribute("data-type");y[ae]=!y[ae],r(),n()}b("tog_mese").onclick=S,b("tog_trimestre").onclick=S,b("tog_semestre").onclick=S,b("tog_anno").onclick=S}function k(S){return encodeURIComponent(String(S||""))}function W(){var S=b("rep_gmail_web"),V=b("rep_gmail_app"),ae=b("rep_copy");ae&&(ae.onclick=function(){try{navigator.clipboard.writeText(U.value||"");var K=ae.textContent;ae.textContent="Copiato!",setTimeout(function(){ae.textContent=K},1200)}catch(oe){}}),!(!S||!V)&&Ie("/api/users_emails").then(function(K){var oe=(K&&K.emails||(K&&K.users||[]).map(function(be){return be.email})).filter(Boolean).join(",");function de(){return b("report_subject").value||"Report BP"}function me(){return U.value||""}S.onclick=function(){try{navigator.clipboard.writeText(me())}catch(Se){}var be="https://mail.google.com/mail/?view=cm&fs=1&tf=1&su="+k(de())+"&cc="+k(oe)+"&body="+k(me());window.open(be,"_blank"),document.dispatchEvent(new Event("report:composed"))},V.onclick=function(){try{navigator.clipboard.writeText(me())}catch(Se){}var be="googlegmail:///co?subject="+k(de())+"&cc="+k(oe)+"&body="+k(me());location.href=be,document.dispatchEvent(new Event("report:composed")),setTimeout(function(){document.hidden||(location.href="mailto:?subject="+k(de())+"&cc="+k(oe)+"&body="+k(me()),document.dispatchEvent(new Event("report:composed")))},1200)}})}function J(){Ie("/api/periods").then(function(S){f=S&&S.periods||[],d(),v(),n(),W()})}J()}function Ve(){var f=Be();if(!f)return s();if(document.title="Battle Plan ‚Äì Utenti",f.role!=="admin"){m.innerHTML=je()+'<div class="wrap"><div class="card"><b>Il mio profilo</b><div class="row" style="margin-top:8px"><div><label>Nome</label><input id="p_name" type="text" value="'+De(f.name||"")+'"></div><div><label>Email</label><input id="p_email" type="email" value="'+De(f.email||"")+'"></div></div><div class="row"><div><label>Nuova password</label><input id="p_pwd" type="password" placeholder="Lascia vuoto per non cambiare"></div><div class="right" style="align-self:flex-end"><button id="p_save">Aggiorna</button></div></div><div class="row"><div><label>Ruolo</label><input value="'+De(f.role||"consultant")+'" disabled></div><div><label>Grade</label><input value="'+De(f.grade||"junior")+'" disabled></div></div></div></div>',Ue(),Ge("#p_save").onclick=function(){var b=Ge("#p_name").value.trim(),U=Ge("#p_email").value.trim(),A=Ge("#p_pwd").value,x={id:f.id,name:b,email:U};A&&(x.password=A),Le("/api/users",x).then(function(){fe("Profilo aggiornato"),window.addXP(3);var L=Be();L&&(L.name=b,L.email=U,localStorage.setItem("user",JSON.stringify(L)));try{document.dispatchEvent(new Event("user:profile-updated"))}catch(C){}}).catch(function(L){logger.error(L),fe("Errore aggiornamento")})};return}m.innerHTML=je()+'<div class="wrap"><div class="card"><b>Gestione utenti</b><div id="users_list" class="row" style="margin-top:8px"></div></div></div>',Ue();function y(b){var U=De(b.name||b.email||"user_"+b.id),A=b.grade==="senior"?"senior":"junior",x=b.role==="admin"?"admin":"consultant";return'<div class="card" style="flex:1 1 380px"><div><b>'+U+'</b> <span class="small muted">('+De(x)+')</span></div><div class="row" style="margin-top:6px"><div><label>Nome</label><input data-nfor="'+b.id+'" type="text" value="'+De(b.name||"")+'"></div><div><label>Email</label><input data-efor="'+b.id+'" type="email" value="'+De(b.email||"")+'"></div></div><div class="row"><div><label>Nuova password</label><input data-pfor="'+b.id+'" type="password" placeholder="(opzionale)"></div><div><label>Grade</label><select data-gfor="'+b.id+'"><option value="junior"'+(A==="junior"?" selected":"")+'>Junior</option><option value="senior"'+(A==="senior"?" selected":"")+'>Senior</option></select></div><div><label>Ruolo</label><select data-rfor="'+b.id+'"><option value="consultant"'+(x==="consultant"?" selected":"")+'>Consulente</option><option value="admin"'+(x==="admin"?" selected":"")+'>Admin</option></select></div><div class="right" style="align-self:flex-end"><button class="ghost" data-save="'+b.id+'">Aggiorna</button> <button class="danger" data-del="'+b.id+'" title="Elimina utente">Elimina</button></div></div></div>'}function z(){Ie("/api/users").then(function(b){var U=b&&b.users||[],A=Ge("#users_list");A&&(A.innerHTML=U.map(y).join(""),yt("[data-save]").forEach(function(x){x.addEventListener("click",function(){var L=x.getAttribute("data-save"),C=(Ge('input[data-nfor="'+L+'"]')||{}).value||"",_=(Ge('input[data-efor="'+L+'"]')||{}).value||"",B=(Ge('select[data-gfor="'+L+'"]')||{}).value||"junior",G=(Ge('select[data-rfor="'+L+'"]')||{}).value||"consultant",I=Ge('input[data-pfor="'+L+'"]'),w=I?I.value:"",g={id:L,name:C,email:_,grade:B,role:G};w&&(g.password=w),Le("/api/users",g).then(function(){fe("Aggiornato"),window.addXP(5),I&&(I.value="")}).catch(function(P){logger.error(P),fe("Errore aggiornamento")})})}),yt("[data-del]").forEach(function(x){x.addEventListener("click",function(){var L=x.getAttribute("data-del");if(confirm("Eliminare definitivamente questo utente?")){var C=(Array.isArray(U)?U:[]).find(function(_){return String(_.id)===String(L)});fetch("/api/users?id="+encodeURIComponent(L),{method:"DELETE",headers:{Authorization:"Bearer "+dt()}}).then(function(_){if(!_.ok)throw new Error("HTTP "+_.status);return _.json()}).then(function(){if(fe("Utente eliminato"),z(),typeof showUndo=="function"&&C){var _={id:C.id,name:C.name,email:C.email,grade:C.grade,role:C.role};showUndo("Utente eliminato",function(){return Le("/api/users",_).then(function(){z()})},5e3)}}).catch(function(_){logger.error(_),fe("Errore eliminazione")})}})}))})}z()}window.viewHome=re,window.viewCalendar=ie,window.viewPeriods=ye,window.viewAppointments=we,window.viewLeaderboard=le,window.viewClients=se,window.viewTeam=ve,window.viewCommissions=ce,window.viewVendite=xe,window.viewReport=_e,window.viewUsers=Ve,window.toggleDrawer=mt,window.logout=Rt,window.rerenderTopbarSoon=tn,document.addEventListener("DOMContentLoaded",function(){Be()?(Ue(),re()):s()})})();export{nn as __vite_legacy_guard};
