function an(){import.meta.url,import("_").catch(()=>1),(async function*(){})().next()}(function(){const l=document.createElement("link").relList;if(l&&l.supports&&l.supports("modulepreload"))return;for(const H of document.querySelectorAll('link[rel="modulepreload"]'))J(H);new MutationObserver(H=>{for(const Y of H)if(Y.type==="childList")for(const K of Y.addedNodes)K.tagName==="LINK"&&K.rel==="modulepreload"&&J(K)}).observe(document,{childList:!0,subtree:!0});function D(H){const Y={};return H.integrity&&(Y.integrity=H.integrity),H.referrerPolicy&&(Y.referrerPolicy=H.referrerPolicy),H.crossOrigin==="use-credentials"?Y.credentials="include":H.crossOrigin==="anonymous"?Y.credentials="omit":Y.credentials="same-origin",Y}function J(H){if(H.ep)return;H.ep=!0;const Y=D(H);fetch(H.href,Y)}})();function Ft(m){return m?(m=String(m).toLowerCase(),m==="ytd"||m==="ltm"?"mensile":m):""}function Ot(m){var l=new Date(Date.UTC(m.getFullYear(),m.getMonth(),m.getDate())),D=l.getUTCDay()||7;l.setUTCDate(l.getUTCDate()+4-D);var J=new Date(Date.UTC(l.getUTCFullYear(),0,1));return Math.ceil(((l-J)/864e5+1)/7)}typeof window<"u"&&(typeof window.effectivePeriodType!="function"&&(window.effectivePeriodType=Ft),typeof window.isoWeekNum!="function"&&(window.isoWeekNum=Ot));(function(){const m=window.fetch.bind(window);function l(){try{const J=JSON.parse(localStorage.getItem("user")||"{}");if(J&&(J.token||J.jwt||J.accessToken))return J.token||J.jwt||J.accessToken}catch(J){}const D=["token","authToken","jwt","bp_token","accessToken","id_token"];for(const J of D){let H=localStorage.getItem(J)||sessionStorage.getItem(J);if(H){try{const Y=JSON.parse(H);if(Y&&(Y.token||Y.jwt||Y.accessToken))return Y.token||Y.jwt||Y.accessToken}catch(Y){}if(H=String(H).replace(/^"+|"+$/g,""),/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+$/.test(H))return H}}return null}window.fetch=function(D,J){const H=typeof D=="string"?D:D&&D.url||"";if(!(typeof H=="string"&&(H.startsWith("/api/")||H.startsWith(location.origin+"/api/"))))return m(D,J);const K=l(),X=Object.assign({},J);return X.headers=new Headers(X&&X.headers||{}),K&&!X.headers.has("Authorization")&&X.headers.set("Authorization","Bearer "+K),m(D,X)}})();(function(){function m(){const H=X=>String(X).replace(/^"+|"+$/g,""),Y=X=>/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+$/.test(X||""),K=["token","authToken","jwt","bp_token","accessToken","id_token"];for(const X of K){let V=localStorage.getItem(X)||sessionStorage.getItem(X);if(V){try{const ie=JSON.parse(V);if(ie&&(ie.token||ie.jwt||ie.accessToken))return ie.token||ie.jwt||ie.accessToken}catch(ie){}if(V=H(V),Y(V))return V}}try{const X=JSON.parse(localStorage.getItem("user")||"{}");if(X&&(X.token||X.jwt||X.accessToken))return X.token||X.jwt||X.accessToken}catch(X){}return null}typeof window.users>"u"&&(window.users=[]),(async function H(){try{if(window.GET){const X=await window.GET("/api/usernames");X&&Array.isArray(X.users)&&(window.users=X.users);return}const Y=m(),K=await fetch("/api/usernames",{headers:{Accept:"application/json",...Y?{Authorization:"Bearer "+Y}:{}}});if(K.status===401){setTimeout(H,800);return}if(K.ok){const X=await K.json();X&&Array.isArray(X.users)&&(window.users=X.users)}}catch(Y){setTimeout(H,1200)}})();function l(H,Y,K){return new Date(Date.UTC(H,Y,K))}function D(H){return new Date(H.getTime()+24*3600*1e3-1)}function J(H,Y){return new Date(Date.UTC(H,Y+1,0))}typeof window.buildBuckets!="function"&&(window.buildBuckets=function(H,Y){var K=String(H||"mensile").toLowerCase(),X=effectivePeriodType(K),V=Y?new Date(Y):new Date,ie=V.getUTCFullYear(),ee=[];function he(h,P){ee.push({s:h.getTime(),e:P.getTime()})}if(X==="settimanale"){var ge=new Date(Date.UTC(V.getUTCFullYear(),V.getUTCMonth(),V.getUTCDate())),re=(ge.getUTCDay()+6)%7;ge.setUTCDate(ge.getUTCDate()-re);for(var oe=52;oe>=0;oe--){var pe=new Date(ge);pe.setUTCDate(ge.getUTCDate()-oe*7);var de=new Date(pe);de.setUTCDate(pe.getUTCDate()+6),de.setUTCHours(23,59,59,999),he(pe,de)}return ee}if(X==="mensile"){for(var Ce=new Date(Date.UTC(V.getUTCFullYear(),V.getUTCMonth(),1)),ve=23;ve>=0;ve--){var be=new Date(Date.UTC(Ce.getUTCFullYear(),Ce.getUTCMonth()-ve,1));he(be,D(J(be.getUTCFullYear(),be.getUTCMonth())))}return ee}if(X==="trimestrale"){for(var ze=Math.floor(V.getUTCMonth()/3),g=11;g>=0;g--){var b=ze-g,G=ie+Math.floor(b/4),C=(b%4+4)%4,pe=l(G,C*3,1),de=D(new Date(Date.UTC(G,C*3+3,0)));he(pe,de)}return ee}if(X==="semestrale"){for(var z=V.getUTCMonth()<6?0:1,L=5;L>=0;L--){var A=z-L,M=ie+Math.floor(A/2),S=(A%2+2)%2,y=S===0?0:6,E=l(M,y,1),$=D(new Date(Date.UTC(M,y+6,0)));he(E,$)}return ee}for(var I=2;I>=0;I--){var v=ie-I;he(l(v,0,1),D(new Date(Date.UTC(v,12,0))))}return ee}),typeof window.labelsForBuckets!="function"&&(window.labelsForBuckets=function(H,Y){var K=effectivePeriodType(H||"mensile");return(Y||[]).map(function(X){var V=new Date(X.s);return K==="settimanale"?"W"+isoWeekNum(V):K==="mensile"?String(V.getUTCMonth()+1).padStart(2,"0")+"/"+V.getUTCFullYear():K==="trimestrale"?"Q"+(Math.floor(V.getUTCMonth()/3)+1)+" "+V.getUTCFullYear():K==="semestrale"?(V.getUTCMonth()<6?"S1 ":"S2 ")+V.getUTCFullYear():String(V.getUTCFullYear())})}),typeof window.sumIndicator!="function"&&(window.sumIndicator=function(H,Y,K){var ie,ee;var X=String(Y).toLowerCase()==="previsionale"?H.indicatorsPrev||{}:H.indicatorsCons||{};if(K==="VSDTotale")return Number(X.VSDPersonale||0)+Number(X.VSDIndiretto||0);var V=Number((ee=(ie=X[K])!=null?ie:X[K.toUpperCase()])!=null?ee:0);return Number.isFinite(V)?V:0})})();(function(m){const l=["localhost","127.0.0.1"].includes(m.location.hostname),D=m.pino?m.pino({level:l?"debug":"info"}):console,J={info:(...H)=>D.info?D.info(...H):console.log(...H),error:(...H)=>D.error?D.error(...H):console.error(...H),warn:(...H)=>D.warn?D.warn(...H):console.warn(...H),debug:(...H)=>D.debug?D.debug(...H):console.debug(...H)};m.logger=J})(window);window.BP_PHRASES=(function(){const m=["Ottimo, {name}! 🎯","Ben fatto, {name}! 🙌","Avanti così, {name}! 🚀","Perfetto, {name}! 🤩","Bel colpo, {name}! 💥","Ci siamo, {name}! 👌","Grande {name}! 🧱","Pezzo dopo pezzo, {name}! 🧩","Molto bene, {name}! 👍","Stai andando bene, {name}! ➡️"],l=["Che figata, {name}! 🔥","Ma cosa dico grande… grandissimo, {name}! 💪","Super, {name}! ✨","Non ti ferma nessuno, {name}!! 🏎️","Stai andando alla grande, {name}! 📈","Gran progressione, {name}! ⏩","Il ritmo è giusto, {name}! 🥁","Questa spinge, {name}! 🧨","Bello tosto, {name}! 🛡️","Gran focus, {name}! 🎯"],D=["BOOM! {name}, questo è livello PRO! 🏆","Risultato pazzesco, {name}! 🤯","Clamoroso {name}, così si fa! ⚡","È ufficiale: {name} ON FIRE! 🔥🔥","Top di gamma, {name}! 🥇","Mostruoso upgrade, {name}! 🚀","Record personale in vista, {name}! 🧠","Spacchi tutto, {name}! 💣","Da incorniciare, {name}! 🖼️","Questo alza l’asticella, {name}! 📏"],J={lite:m,mid:l,mega:D};return J.standard=m,J.rilevante=l,J.grande=D,J.pick=function(H,Y){const K=J[H]||m,X=Y||JSON.parse(localStorage.getItem("bp_user")||"{}").name||"campione";return(K[Math.floor(Math.random()*K.length)]||"Grande!").replace(/\{name\}/g,X)},J.random=function(H){const Y=[m,l,D],K=Y[Math.floor(Math.random()*Y.length)];return J.pick(K===D?"mega":K===l?"rilevante":"standard",H)},J})();(function(){const m=window.BP=window.BP||{},l=m.Haptics=m.Haptics||{};function D(){const H=navigator.userAgent||navigator.vendor||"";return/android|iphone|ipad|ipod|mobile/i.test(H)}function J(H){if(D()&&"vibrate"in navigator)try{switch(H){case"light":navigator.vibrate(12);break;case"heavy":navigator.vibrate([10,30,10]);break;default:navigator.vibrate(18);break}}catch(Y){}}l.impact=J})();(function(){const m=window.BP=window.BP||{},l=m.Undo=m.Undo||{},D=document.createElement("div");D.className="bp-undo-host",document.body.appendChild(D);const J="\n  .bp-undo-host{\n    position: fixed; left:50%; transform: translateX(-50%);\n    bottom: 20px; z-index: 1201; display:flex; flex-direction:column; gap:8px;\n  }\n  .bp-undo{\n    min-width: 280px; max-width: 540px;\n    background: rgba(15,19,28,.95);\n    border:1px solid rgba(255,255,255,.18);\n    border-radius: 12px; padding: 10px 12px;\n    box-shadow: 0 10px 24px rgba(0,0,0,.35);\n    display:flex; align-items:center; gap:10px;\n    animation: bpUndoPop .16s ease-out;\n  }\n  .bp-undo .lbl{ font-weight:700; }\n  .bp-undo .spacer{ flex:1; }\n  .bp-undo button{ white-space:nowrap; }\n  @keyframes bpUndoPop{ from{ transform: translate(-50%, 4px); opacity:0 } to{ transform: translate(-50%, 0); opacity:1 } }\n  ",H=document.createElement("style");H.textContent=J,document.head.appendChild(H);function Y(K){const X=document.createElement("div");X.className="bp-undo",X.innerHTML='\n      <div class="lbl">'.concat(K&&K.label||"Operazione eseguita",'</div>\n      <div class="spacer"></div>\n      <button type="button" class="ghost" data-undo>Annulla</button>\n    '),D.appendChild(X);let V=!1;const ie=setTimeout(()=>{V||(V=!0,X.remove())},K&&K.timeoutMs||5e3);X.querySelector("[data-undo]").addEventListener("click",()=>{if(!V){V=!0,clearTimeout(ie);try{K&&K.onUndo&&K.onUndo()}catch(ee){}X.remove()}})}l.push=Y})();(function(){const m=window.BP=window.BP||{},l=m.ClientsHelpers=m.ClientsHelpers||{};function D(K){return String(K||"").trim().toLowerCase()}function J(K){const X={};return(K||[]).forEach(V=>{const ie=D(V.client);if(!ie)return;const ee=V.start||V.end;if(!ee)return;const he=X[ie];(!he||new Date(ee)>new Date(he))&&(X[ie]=ee)}),X}function H(K,X){const V=J(X);return(K||[]).map(ie=>{const ee=V[D(ie.name)]||null;return{...ie,lastAppointment:ee}})}function Y(K,{status:X,consultantId:V,consultantName:ie}){const ee=re=>String(re||"").trim().toLowerCase(),he=re=>{const oe=ee(re).replace(/\s+/g,"_").replace(/-/g,"_");return oe==="lead_non_chiuso"||oe==="lead_non-chiuso"?"lead_non_chiuso":oe};let ge=K||[];if(X&&X!=="tutti"&&(ge=ge.filter(re=>he(re.status)===he(X))),V)ge=ge.filter(re=>(re.consultantId||"")===String(V));else if(ie){const re=ee(ie);ge=ge.filter(oe=>ee(oe.consultantName)===re)}return ge}l.withLastAppointment=H,l.filter=Y})();(function(){const m=window.BP=window.BP||{},l=m.Targets=m.Targets||{},D=["VSS","VSDPersonale","VSDIndiretto","GI"],J=["NNCF","AppFatti","Telefonate"],H=D.concat(J),Y={senior:{VSS:3e4,VSDPersonale:15e3,VSDIndiretto:5e3,GI:15e3,NNCF:1,AppFatti:4,Telefonate:0},junior:{VSS:15e3,VSDPersonale:5e3,VSDIndiretto:5e3,GI:1e4,NNCF:4,AppFatti:30,Telefonate:300}};function K(re,oe){const pe=Number(re||0),de=Number(oe||0);return de?Math.ceil(pe/de)*de:Math.ceil(pe)}function X(re){switch(String(re||"mensile").toLowerCase()){case"settimanale":return 1/4;case"mensile":return 1;case"trimestrale":return 3;case"semestrale":return 6;case"annuale":return 12;default:return 1}}function V(re){return D.indexOf(re)>=0}function ie(re){const oe=String(re||"junior").toLowerCase()==="senior"?"senior":"junior";return{...Y[oe]}}function ee(re,oe){const pe=X(oe),de=ie(re),Ce={};for(const ve of H){const be=Number(de[ve]||0)*pe;V(ve)?String(oe).toLowerCase()==="settimanale"?Ce[ve]=K(be,500):Ce[ve]=K(be,5e3):Ce[ve]=Math.ceil(be)}return Ce}function he(re,oe){const pe={};for(const de of H){const Ce=Number((re||{})[de]||0),ve=Number((oe||{})[de]||0),be=Ce-ve,ze=ve>0?Math.round(Ce/ve*100):Ce>0?100:0;pe[de]={value:Ce,target:ve,delta:be,pct:Math.max(0,ze)}}return pe}function ge(re){const oe=[];for(const de of H){const Ce=(re||{})[de];Ce&&Ce.target>0&&oe.push(Number(Ce.pct||0))}if(!oe.length)return 0;const pe=oe.reduce((de,Ce)=>de+Ce,0)/oe.length;return Math.round(pe)}l.MONEY_KEYS=D,l.COUNT_KEYS=J,l.ALL_KEYS=H,l.getMonthly=ie,l.getForPeriod=ee,l.compare=he,l.summarize=ge})();(function(){const m=window.BP=window.BP||{},l=m.ICS=m.ICS||{};function D(J){try{logger.warn("[BP ICS bulk disabled] chiamata a:",J)}catch(H){}}l.createCalendarForRange=function(){return D("createCalendarForRange()"),null},l.downloadForRange=function(){return D("downloadForRange()"),!1}})();(function(){const m=window.BP=window.BP||{},l=m.ClientStatus=m.ClientStatus||{},D="bp_banner_seen";function J(){try{return JSON.parse(localStorage.getItem(D)||"{}")}catch(re){return{}}}function H(re){try{localStorage.setItem(D,JSON.stringify(re||{}))}catch(oe){}}function Y(re){return!!J()[re]}function K(re){const oe=J();oe[re]=!0,H(oe)}async function X(re){const oe=window.authToken||"",pe=await fetch(re,{headers:oe?{Authorization:"Bearer "+oe}:{}});if(!pe.ok)throw new Error("GET "+re+" failed");return pe.json()}async function V(re,oe){const pe=window.authToken||"",de=await fetch(re,{method:"POST",headers:{"Content-Type":"application/json",...pe?{Authorization:"Bearer "+pe}:{}},body:JSON.stringify(oe||{})});if(!de.ok)throw new Error("POST "+re+" failed");return de.json()}async function ie({clientId:re,status:oe}){if(!re)throw new Error("missing clientId");return V("/api/clients",{id:re,status:String(oe||"")})}l.setClientStatusByName=ee;async function ee({clientName:re,status:oe}){const pe=String(re||"").trim();if(!pe)throw new Error("missing clientName");const Ce=((await X("/api/clients")).clients||[]).find(ze=>String(ze.name||"").toLowerCase()===pe.toLowerCase());if(Ce)return ie({clientId:Ce.id,status:oe});await V("/api/clients",{name:pe});const be=((await X("/api/clients")).clients||[]).find(ze=>String(ze.name||"").toLowerCase()===pe.toLowerCase());if(!be)throw new Error("client creation failed");return ie({clientId:be.id,status:oe})}function he({appointment:re,clientName:oe},pe){const de=re||{},Ce=oe||de.client||"Cliente",ve=document.createElement("div");return ve.className="bp-banner-client",ve.innerHTML='\n      <div class="bp-banner-inner">\n        <div class="bp-banner-title">È diventato cliente?</div>\n        <div class="bp-banner-sub">Appuntamento con <b>'.concat(ge(Ce),'</b></div>\n        <div class="bp-banner-actions">\n          <button type="button" data-yes>Sì</button>\n          <button type="button" class="ghost" data-no>No</button>\n        </div>\n      </div>\n    '),ve.querySelector("[data-yes]").addEventListener("click",()=>pe&&pe(!0,de)),ve.querySelector("[data-no]").addEventListener("click",()=>pe&&pe(!1,de)),ve}function ge(re){return String(re).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}(function(){if(document.getElementById("bp-clientstatus-css"))return;const oe="\n.bp-banner-client{\n  position: fixed; left:50%; transform:translateX(-50%);\n  top: 70px; z-index: 1200;\n  background: rgba(20,24,34,.95);\n  color: #fff;\n  border: 1px solid rgba(255,255,255,.18);\n  box-shadow: 0 10px 24px rgba(0,0,0,.35);\n  border-radius:14px; padding:10px; min-width:280px;\n  animation: bpBannerPop .18s ease-out;\n}\n.bp-banner-inner{ display:flex; flex-direction:column; gap:6px; }\n.bp-banner-title{ font-weight:800; }\n.bp-banner-sub{ font-size:12px; opacity:.92; }\n.bp-banner-actions{ display:flex; gap:8px; margin-top:6px; justify-content:flex-end; }\n@keyframes bpBannerPop{ from{ transform:translate(-50%, -6px); opacity:0 } to{ transform:translate(-50%, 0); opacity:1 } }\n",pe=document.createElement("style");pe.id="bp-clientstatus-css",pe.textContent=oe,document.head.appendChild(pe)})(),l.hasSeen=Y,l.markSeen=K,l.renderBecameClientBanner=he,l.setClientStatus=ie,l.setClientStatusByName=ee})();(function(){function m(l){try{fetch("/api/client_error",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:location.href,info:{ua:navigator.userAgent},...l})})}catch(D){}}window.addEventListener("error",function(l){try{m({message:l.message,stack:l.error&&l.error.stack||null})}catch(D){}}),window.addEventListener("unhandledrejection",function(l){try{m({message:"unhandledrejection",stack:l.reason&&l.reason.stack||String(l.reason)})}catch(D){}})})();(function(){function m(l){return String(l||"event").normalize("NFKD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9._-]+/g,"_").replace(/^_+|_+$/g,"").slice(0,80)||"event"}if(window.saveICS&&!window.__icsSanitized){const l=window.saveICS;window.saveICS=function(D,J){try{D=m(D)}catch(H){}return l(D,J)},window.__icsSanitized=!0}window.__icsSanitize=m})();(function(m){function l(D){const J=window.BANNERS_LOOKBACK_DAYS||7,H="nncf",Y="sale",K=(S,y)=>"bp_snooze_".concat(y,"_").concat(S),X=(S,y)=>"bp_done_".concat(y,"_").concat(S),V=(S,y)=>{try{const E=localStorage.getItem(K(S,y));return E&&new Date(E).getTime()>Date.now()}catch(E){return!1}},ie=(S,y)=>{try{const E=new Date;E.setDate(E.getDate()+1),localStorage.setItem(K(S,y),E.toISOString())}catch(E){}},ee=(S,y)=>{try{return localStorage.getItem(X(S,y))==="1"}catch(E){return!1}},he=(S,y)=>{try{localStorage.setItem(X(S,y),"1")}catch(E){}},ge=window.BPFinal&&BPFinal.GET||window.GET,re=window.BPFinal&&BPFinal.POST||window.POST,oe=window.toast||(S=>alert(S));function pe(S){return String(S||"").replace(/[&<>\"]/g,y=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"})[y])}function de(){if(document.getElementById("bp-banner-css"))return;const S="\n      #bp_banner_host{position:fixed;left:16px;right:16px;bottom:16px;z-index:9999;display:flex;justify-content:center;pointer-events:none}\n      .bp-banner-card{pointer-events:auto;width:100%;max-width:720px;background:var(--card,#fff);color:var(--text,#111);\n        border:1px solid rgba(0,0,0,.12);border-radius:14px;box-shadow:0 10px 28px rgba(0,0,0,.28);padding:12px;display:flex;gap:12px;align-items:center;opacity:0;transform:translateY(8px);transition:opacity .2s,transform .2s}\n      .bp-banner-card.show{opacity:1;transform:none}\n      .bp-banner-card .msg{flex:1}.bp-banner-card .row{display:flex;gap:8px;align-items:center}\n      .bp-banner-card .ghost{background:rgba(0,0,0,.06);border:1px solid rgba(0,0,0,.12)}\n      @media (prefers-color-scheme: dark){ .bp-banner-card{background:rgba(15,18,28,.96);color:#fff;border-color:rgba(255,255,255,.16)}\n        .bp-banner-card .ghost{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.18)}}\n    ",y=document.createElement("style");y.id="bp-banner-css",y.textContent=S,document.head.appendChild(y)}function Ce(){let S=document.getElementById("bp_banner_host");return S||(S=document.createElement("div"),S.id="bp_banner_host",document.body.appendChild(S)),S}let ve=[],be=!1;function ze(S){ve.push(S),g()}function g(){if(be)return;const S=ve.shift();if(!S)return;be=!0,de();const y=Ce();y.innerHTML="";const E=S($);y.appendChild(E),requestAnimationFrame(()=>E.classList.add("show"));function $(){y.innerHTML="",be=!1,setTimeout(g,40)}}async function b(S,y){if(!S)return;const E=await ge("/api/clients"),I=(E&&E.clients||[]).find(v=>String(v.name||"").trim().toLowerCase()===String(S).trim().toLowerCase());I&&await re("/api/clients",{id:I.id,status:y})}function G(S){if(S)try{if(typeof window.openPaymentBuilderById=="function"){window.openPaymentBuilderById(S);return}if(typeof window.gotoGIAndOpenBuilder=="function"){window.gotoGIAndOpenBuilder(S);return}if(document.querySelector("#gi_rows")){document.dispatchEvent(new CustomEvent("gi:edit",{detail:{id:S}}));return}if(typeof window.viewGI=="function"){try{window.viewGI()}catch(E){}let y=0;(function E(){if(document.getElementById("gi_rows")||y>40){try{document.dispatchEvent(new CustomEvent("gi:edit",{detail:{id:S}}))}catch(I){}return}y++,setTimeout(E,100)})();return}document.dispatchEvent(new CustomEvent("gi:edit",{detail:{id:S}}))}catch(y){}}function C(S,y){const E=Number(S.vss||S.vsdPersonal||0)||0,$=S.client||"Cliente",I='\n      <div class="card" style="min-width:min(380px,96vw);max-width:480px">\n        <div style="display:flex;justify-content:space-between;align-items:center">\n          <b>VSS per '.concat(pe($),'</b>\n          <button class="ghost" id="vss_x">Chiudi</button>\n        </div>\n        <div class="row" style="margin-top:8px;gap:8px;align-items:flex-end;flex-wrap:wrap">\n          <div style="min-width:200px">\n            <label>Valore VSS</label>\n            <input id="vss_val" type="number" step="1" value="').concat(E,'">\n          </div>\n          <div class="muted small">Modifica consentita solo per VSS</div>\n        </div>\n        <div class="right" style="margin-top:12px">\n          <button id="vss_ok">Salva</button>\n        </div>\n      </div>');if(typeof window.showOverlay=="function"&&typeof window.hideOverlay=="function"){showOverlay(I);const P=document.getElementById("bp-overlay-panel")||document.body,T=x=>P.querySelector(x),B=()=>{try{hideOverlay()}catch(x){}};T("#vss_x").onclick=B,T("#vss_ok").onclick=async()=>{try{const x=Math.max(0,Number(T("#vss_val").value||0));if(await re("/api/appointments",{id:S.id,vss:x}),D("medium"),oe("Appuntamento aggiornato"),B(),x>0)try{const U=await z(S,x);if(U&&(U.id||U._id)){const k=U.id||U._id;G(k)}}catch(U){logger.error(U)}y&&y.onSaved}catch(x){logger.error(x),oe("Errore salvataggio VSS")}};return}const v=document.createElement("div");v.className="modal",v.innerHTML=I,document.body.appendChild(v);const h=()=>{try{v.remove()}catch(P){}};v.querySelector("#vss_x").onclick=h,v.querySelector("#vss_ok").onclick=async()=>{try{const P=Math.max(0,Number(v.querySelector("#vss_val").value||0));if(await re("/api/appointments",{id:S.id,vss:P}),D("medium"),oe("Appuntamento aggiornato"),h(),P>0)try{const T=await z(S,P);if(T&&(T.id||T._id)){const B=T.id||T._id;G(B)}}catch(T){logger.error(T)}y&&y.onSaved}catch(P){logger.error(P),oe("Errore salvataggio VSS")}}}async function z(S,y){const E={apptId:S.id,date:new Date(S.end||S.start||Date.now()).toISOString(),clientName:S.client||"Cliente",vssTotal:Math.round(Number(y||0)),services:S.services||S.note||"",consultantId:S.userId||S.ownerId||null},$=await re("/api/gi",E);return $&&($.sale||$.gi||$.data)||$}function L(S){return function(y){const E=document.createElement("div");E.className="bp-banner-card",E.setAttribute("role","alertdialog"),E.setAttribute("aria-live","assertive");const $=new Date(S.end||S.start||Date.now()).toLocaleString("it-IT",{dateStyle:"short",timeStyle:"short"});return E.innerHTML='<div class="msg"><b>Allora, hai venduto a '.concat(pe(S.client||"Cliente"),'?</b>\n           <div class="small muted">Appuntamento del ').concat(pe($),'</div></div>\n         <div class="row">\n           <button class="ghost" data-act="later">Posticipa</button>\n           <button class="ghost" data-act="no">No</button>\n           <button data-act="yes">Sì</button>\n         </div>'),E.querySelector('[data-act="yes"]').onclick=function(){he(S.id,Y),y(),C(S)},E.querySelector('[data-act="no"]').onclick=async function(){he(S.id,Y),y();try{await re("/api/appointments",{id:S.id,vss:0}),oe("Registrato: nessuna vendita")}catch(I){}},E.querySelector('[data-act="later"]').onclick=function(){ie(S.id,Y),oe("Te lo ripropongo domani"),y()},E}}function A(S){return function(y){const E=document.createElement("div");E.className="bp-banner-card",E.setAttribute("role","alertdialog"),E.setAttribute("aria-live","assertive");const $=new Date(S.end||S.start||Date.now()).toLocaleString("it-IT",{dateStyle:"short",timeStyle:"short"});return E.innerHTML='<div class="msg"><b>È diventato cliente?</b> '.concat(pe(S.client||""),'\n           <div class="small muted">Appuntamento del ').concat(pe($),'</div></div>\n         <div class="row">\n           <button class="ghost" data-act="later">Posticipa</button>\n           <button class="ghost" data-act="no">No</button>\n           <button data-act="yes">Sì</button>\n         </div>'),E.querySelector('[data-act="yes"]').onclick=async function(){he(S.id,H),y();try{await b(S.client,"attivo")}catch(I){}C(S)},E.querySelector('[data-act="no"]').onclick=async function(){he(S.id,H),y();try{await b(S.client,"lead non chiuso"),await re("/api/appointments",{id:S.id,vss:0}),oe("Aggiornato: Lead non chiuso, VSS=0")}catch(I){}},E.querySelector('[data-act="later"]').onclick=function(){ie(S.id,H),oe("Te lo ripropongo domani"),y()},E}}async function M(){try{const S=await ge("/api/appointments"),y=Date.now(),E=y-J*24*60*60*1e3,$=S&&S.appointments||[];$.sort((I,v)=>+new Date(v.end||v.start||0)-+new Date(I.end||I.start||0)),$.forEach(I=>{try{const v=+new Date(I.end||I.start||0);if(!v||v>y||v<E||!(String(I.type||"").toLowerCase()==="vendita"))return;if(I.nncf){if(ee(I.id,H)||V(I.id,H))return;ze(A(I))}else{if(ee(I.id,Y)||V(I.id,Y))return;ze(L(I))}}catch(v){}})}catch(S){}}window.scanBanners=M,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",M,{once:!0}):M();try{document.addEventListener("appt:saved",function(){setTimeout(M,50)})}catch(S){}try{document.addEventListener("visibilitychange",function(){document.hidden||setTimeout(M,50)})}catch(S){}try{setInterval(function(){M()},60*1e3)}catch(S){}}typeof m<"u"&&(m.initPostSaleBanners=l)})(typeof window<"u"?window:void 0);const De=window.BP&&BP.Haptics&&BP.Haptics.impact?BP.Haptics.impact:()=>{};(function(){window.bpAuthToken||(window.bpAuthToken=function(){try{const e=localStorage.getItem("bp_user")||sessionStorage.getItem("bp_user");if(e)try{const i=JSON.parse(e);if(i&&(i.token||i.jwt||i.accessToken))return i.token||i.jwt||i.accessToken}catch(i){}}catch(e){}const a=["bp_token","authToken","token","jwt","accessToken","id_token","auth","authorization","session","user"];for(const e of a)try{const i=localStorage.getItem(e)||sessionStorage.getItem(e);if(!i)continue;try{const t=JSON.parse(i);if(t&&(t.token||t.jwt||t.accessToken))return t.token||t.jwt||t.accessToken}catch(t){}if(/^[A-Za-z0-9\-_]+\.[A-Za-z0-9\-_]+\.[A-Za-z0-9\-_]+$/.test(i))return i}catch(i){}try{for(let e=0;e<localStorage.length;e++){const i=localStorage.key(e),t=localStorage.getItem(i);if(t){try{const s=JSON.parse(t);if(s&&(s.token||s.jwt||s.accessToken))return s.token||s.jwt||s.accessToken}catch(s){}if(/^[A-Za-z0-9\-_]+\.[A-Za-z0-9\-_]+\.[A-Za-z0-9\-_]+$/.test(t))return t}}}catch(e){}try{const e=JSON.parse(localStorage.getItem("user")||"{}");if(e&&(e.token||e.jwt||e.accessToken))return e.token||e.jwt||e.accessToken}catch(e){}return null}),window.GET||(window.GET=async function(a){const e=window.bpAuthToken&&window.bpAuthToken()||null,i=await fetch(a,{headers:{Accept:"application/json",...e?{Authorization:"Bearer "+e}:{}}});return i.status===204?null:(i.headers.get("content-type")||"").includes("application/json")?i.json():{ok:i.ok,status:i.status,text:await i.text()}}),window.POST||(window.POST=async function(a,e){const i=window.bpAuthToken&&window.bpAuthToken()||null,t=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json",...i?{Authorization:"Bearer "+i}:{}},body:JSON.stringify(e||{})});return t.status===204?null:(t.headers.get("content-type")||"").includes("application/json")?t.json():{ok:t.ok,status:t.status,text:await t.text()}}),typeof window<"u"&&typeof window.initPostSaleBanners=="function"&&window.initPostSaleBanners(De),(function(){if(document.getElementById("bp-qvss-css"))return;const e=document.createElement("style");e.id="bp-qvss-css",e.textContent='\n    #bp_overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);\n      display:flex;align-items:center;justify-content:center;z-index:9999;padding:16px}\n    .bp-modal{max-width:620px;width:clamp(300px,92vw,620px);background:var(--card,#fff);\n      color:var(--text,#111);border-radius:14px;border:1px solid rgba(0,0,0,.12);\n      box-shadow:0 12px 34px rgba(0,0,0,.35)}\n    .bp-modal .hd{display:flex;align-items:center;justify-content:space-between;padding:12px 14px}\n    .bp-modal .bd{padding:10px 14px 14px}\n    .bp-modal .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}\n    .bp-modal .right{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}\n    .bp-modal input[type="number"], .bp-modal input[type="date"], .bp-modal select, .bp-modal textarea{\n      width:100%;padding:8px;border:1px solid rgba(0,0,0,.18);border-radius:10px}\n    @media (prefers-color-scheme:dark){\n      .bp-modal{background:rgba(15,18,28,.98);color:#fff;border-color:rgba(255,255,255,.14)}\n      .bp-modal input, .bp-modal select, .bp-modal textarea{background:rgba(255,255,255,.04);color:#fff;border-color:rgba(255,255,255,.18)}\n    }\n  ',document.head.appendChild(e)})();function m(a){return String(a||"").replace(/[&<>'"]/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[e])}function l(a){if(window.showOverlay)window.showOverlay(a);else{const e=document.createElement("div");e.id="bp_overlay",e.innerHTML=a,document.body.appendChild(e)}}function D(){if(window.hideOverlay)window.hideOverlay();else{const a=document.getElementById("bp_overlay");a&&a.remove()}}async function J(a){try{const e=await ve("/api/clients"),i=e&&e.clients||[],t=String(a||"").trim().toLowerCase(),s=i.find(w=>String(w.name||"").trim().toLowerCase()===t);return s?s.id:null}catch(e){return null}}async function H(a,e){if(!(Number(e)>0))return null;const i=new Date(a.end||a.start||Date.now()).toISOString();let t=a.clientId||null;t||(t=await J(a.client));const s={date:i,vssTotal:Number(e)||0,services:a.services||"",consultantId:a.userId||(JSON.parse(localStorage.getItem("user")||"{}")||{}).id,clientId:t||void 0,clientName:a.client||void 0},w=await be("/api/gi",s);return w&&(w.id||w.sale&&w.sale.id)||null}async function Y(a){if(typeof viewGI=="function"&&document.querySelector("#gi_rows")){document.dispatchEvent(new CustomEvent("gi:edit",{detail:{id:a}}));return}if(typeof viewGI=="function"){try{viewGI()}catch(e){}setTimeout(()=>document.dispatchEvent(new CustomEvent("gi:edit",{detail:{id:a}})),350);return}try{let w=function(p){const d=s("pb_rates");if(!p||!p.length){d.textContent="Nessuna rata",d._data=[];return}d.innerHTML=p.map(u=>{const n=new Date(u.dueDate).toLocaleDateString("it-IT");return"<div>".concat(n," · ").concat(Number(u.amount||0).toLocaleString("it-IT"),'€ <span class="muted">').concat(m(u.note||""),"</span></div>")}).join(""),d._data=p};const e=await ve("/api/gi?from=1900-01-01&to=2999-12-31"),i=(e&&e.sales||[]).find(p=>String(p.id)===String(a));if(!i){de("Vendita non trovata");return}const t=new Date().toISOString().slice(0,10);l('<div class="bp-modal"><div class="hd"><b>Builder pagamenti – '+m(i.clientName||"Cliente")+'</b><button class="ghost" id="pb_x">Chiudi</button></div><div class="bd"><div class="row"><div style="flex:1"><label>Totale VSS</label><input id="pb_vss" type="number" value="'+Number(i.vssTotal||0)+'"></div></div><div class="row" style="margin-top:8px;gap:12px"><div><label>Regola rapida</label><select id="pb_rule"><option value="0">Manuale</option><option value="50-25-25">50% + 25% / 30-60gg</option><option value="20+12">20% + 12 rate mensili</option></select></div><div><label>Prima scadenza</label><input id="pb_first" type="date" value="'+t+'"></div></div><div style="margin-top:8px"><label>Rate</label><div id="pb_rates" class="small muted">Nessuna rata</div></div><div class="right"><button class="ghost" id="pb_apply">Ricalcola</button><button id="pb_save">Salva</button></div></div></div>');const s=p=>document.getElementById(p);s("pb_apply").onclick=function(){const p=s("pb_rule").value||"0",d=Math.max(0,Number(s("pb_vss").value||0)),u=new Date(s("pb_first").value||new Date),n=[],o=(r,c,f)=>n.push({dueDate:new Date(r).toISOString(),amount:Math.round(c),note:f||""});if(p==="50-25-25"){o(u,d*.5,"Acconto 50%");const r=new Date(u);r.setDate(r.getDate()+30),o(r,d*.25,"Saldo 25% a 30gg");const c=new Date(u);c.setDate(c.getDate()+60),o(c,d*.25,"Saldo 25% a 60gg")}else if(p==="20+12"){o(u,d*.2,"Acconto 20%");const r=d*.8,c=12,f=r/c;for(let N=0;N<c;N++){const R=new Date(u);R.setMonth(R.getMonth()+N+1),o(R,f,"Rata "+(N+1)+"/"+c)}}w(n)},s("pb_save").onclick=async function(){const p=Math.max(0,Number(s("pb_vss").value||0)),d=s("pb_rates")._data||[];try{await be("/api/gi",{id:i.id,vssTotal:p,schedule:d});try{document.dispatchEvent(new CustomEvent("payments:defined",{detail:{id:i.id,vssTotal:p,schedule:d}}))}catch(u){}de("Piano pagamenti salvato"),D()}catch(u){logger.error(u),de("Errore salvataggio")}},s("pb_x").onclick=D}catch(e){logger.error(e)}}function K(a){const e=a.client||"Cliente",i=Number(a.vss||a.vsdPersonal||0)||0;l('<div class="bp-modal"><div class="hd"><b>VSS per '+m(e)+'</b><button class="ghost" id="qvss_x">Chiudi</button></div><div class="bd"><div><label>Valore VSS</label><input id="qvss_val" type="number" step="1" value="'+i+'"></div><div class="small muted" style="margin-top:6px">Modifica consentita solo per VSS</div><div class="right"><button id="qvss_ok">Salva</button></div></div></div>'),document.getElementById("qvss_x").onclick=D,document.getElementById("qvss_ok").onclick=async function(){try{const t=Math.max(0,Number(document.getElementById("qvss_val").value||0));await be("/api/appointments",{id:a.id,vss:t});const s=await H(a,t);D(),de("VSS salvato"),s&&Y(s);try{s&&document.dispatchEvent(new CustomEvent("gi:created",{detail:{id:s}}))}catch(w){}document.dispatchEvent(new Event("bp:saved"))}catch(t){logger.error(t),de("Errore salvataggio VSS")}}}async function X(a){try{a.nncf&&(await(async function(){try{const i=await ve("/api/clients"),t=i&&i.clients||[],s=String(a.client||"").trim().toLowerCase(),w=t.find(p=>String(p.name||"").trim().toLowerCase()===s);w&&await be("/api/clients",{id:w.id,status:"attivo"})}catch(i){}})(),document.dispatchEvent(new Event("client:converted"))),K(a)}catch(e){logger.error(e)}}async function V(a){try{if(a.nncf)try{const e=await ve("/api/clients"),i=e&&e.clients||[],t=String(a.client||"").trim().toLowerCase(),s=i.find(w=>String(w.name||"").trim().toLowerCase()===t);s&&await be("/api/clients",{id:s.id,status:"lead non chiuso"})}catch(e){}await be("/api/appointments",{id:a.id,vss:0}),de("Ok, segnato come non venduto")}catch(e){logger.error(e),de("Errore aggiornamento")}}window.pipelineYes=X,window.pipelineNo=V,(function(){function a(){if(document.getElementById("bp-center-css"))return;const n="\n      #bp_overlay{display:flex;align-items:center;justify-content:center}\n      .bp-modal-card{min-width:min(560px,96vw);max-width:680px;max-height:86vh;overflow:auto}\n      @media (max-width:640px){ .bp-modal-card{min-width:96vw} }\n      .bp-modal-foot{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}\n    ",o=document.createElement("style");o.id="bp-center-css",o.textContent=n,document.head.appendChild(o)}function e(n){try{document.documentElement.style.overflow=n?"hidden":""}catch(o){}}async function i(n){if(!n)return null;try{const o=await ve("/api/clients"),r=o&&o.clients||[],c=String(n).trim().toLowerCase(),f=r.find(N=>String(N.name||"").trim().toLowerCase()===c);return f?f.id:null}catch(o){return null}}async function t(n,o){const r=await i(n);if(r)try{await be("/api/clients",{id:r,status:o})}catch(c){}}async function s(n,o){return be("/api/appointments",{id:n,vss:Math.max(0,Number(o||0))})}async function w(n,o){const r=await i(n.client||""),c={date:new Date(n.end||n.start||Date.now()).toISOString(),clientId:r||void 0,clientName:n.client||"",vssTotal:Math.max(0,Number(o||0)),services:n.services||"",schedule:[]},f=await be("/api/gi",c);return f&&(f.id||f.sale&&f.sale.id||Array.isArray(f.sales)&&f.sales[0]&&f.sales[0].id)||null}async function p(n){if(!n)return;try{typeof window.viewGI=="function"&&window.viewGI()}catch(r){}let o=0;(function r(){if(document.getElementById("gi_rows")||o>40){try{const f=new CustomEvent("gi:edit",{detail:{id:n}});document.dispatchEvent(f)}catch(f){}return}o++,setTimeout(r,100)})()}function d(n,o){a(),e(!0);const r=Math.max(0,Number(n.vss||0)),c='<div class="modal"><div class="card bp-modal-card"><div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><b>VSS per '+(n.client?u(n.client):"appuntamento")+'</b><button class="ghost" id="qvss_x">Chiudi</button></div><div style="margin-top:8px"><label>Valore VSS</label><input id="qvss_val" type="number" step="1" value="'+r+'"><div class="small muted" style="margin-top:6px">Modifica consentita solo per VSS</div></div><div class="bp-modal-foot"><button id="qvss_ok">Salva</button></div></div></div>';showOverlay(c);function f(){e(!1),hideOverlay()}const N=document.getElementById("qvss_val");document.getElementById("qvss_x").onclick=f,document.getElementById("qvss_ok").onclick=async function(){try{const R=Math.max(0,Number(N.value||0));await s(n.id,R);const te=await w(n,R);if(f(),te)try{document.dispatchEvent(new CustomEvent("gi:created",{detail:{id:te}}))}catch(_){}typeof window.coachSay=="function"&&q("medium"),p(te)}catch(R){logger.error(R),de("Errore salvataggio VSS")}}}function u(n){return String(n||"").replace(/[&<>'"]/g,o=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[o])}window.pipelineYes=async function(n){try{n.nncf&&await t(n.client,"cliente"),d(n)}catch(o){logger.error(o)}},window.pipelineNo=async function(n){try{n.nncf&&await t(n.client,"lead non chiuso"),await s(n.id,0),De("light"),de("Segnato VSS 0")}catch(o){logger.error(o)}}})(),(function(){function a(p){return encodeURIComponent(String(p||""))}function e(){try{const o=document.getElementById("rep_label");if(o&&o.textContent)return o.textContent.trim()}catch(o){}const p=(document.getElementById("rep_type")||{}).value||"mensile",d=new Date,u=String(d.getMonth()+1).padStart(2,"0"),n=d.getFullYear();return p==="settimanale"?"Settimana ISO "+(isoWeekNum?isoWeekNum(d):"corrente")+" "+n:p==="trimestrale"?"Q"+(Math.floor(d.getMonth()/3)+1)+" "+n:p==="semestrale"?"Semestre "+(d.getMonth()<6?"1°":"2°")+" "+n:p==="annuale"?"Anno "+n:"Mese "+u+"/"+n}async function i(){try{const p=await ve("/api/usernames");return(p&&p.users||[]).map(u=>u.email).filter(Boolean).join(",")}catch(p){return""}}function t(){const p=document.getElementById("report_subject");return p&&p.value&&p.value.trim()?p.value.trim():"Report BP – "+e()}function s(){const p=document.getElementById("report_body");return p&&p.value&&p.value.trim()?p.value:"Ciao,\n\ndi seguito il report del periodo "+e()+".\n\n– VSS\n– VSD\n– GI\n– NNCF\n\nA presto."}async function w(){const p=document.getElementById("rep_gmail_web"),d=document.getElementById("rep_gmail_app");if(!p&&!d)return;const u=await i(),n=t(),o=s();try{await navigator.clipboard.writeText(o)}catch(r){}p&&(p.onclick=function(){const r="https://mail.google.com/mail/?view=cm&fs=1&tf=1&su="+a(n)+"&cc="+a(u)+"&body="+a(o);window.open(r,"_blank");try{document.dispatchEvent(new Event("report:composed"))}catch(c){}}),d&&(d.onclick=function(){const r="googlegmail:///co?subject="+a(n)+"&cc="+a(u)+"&body="+a(o);location.href=r;try{document.dispatchEvent(new Event("report:composed"))}catch(c){}setTimeout(function(){if(!document.hidden){location.href="mailto:?subject="+a(n)+"&cc="+a(u)+"&body="+a(o);try{document.dispatchEvent(new Event("report:composed"))}catch(c){}}},1200)})}window.wireReportButtons=w})(),(function(){function a(d){var u=d instanceof Date?d:new Date(d||Date.now()),n=u.getFullYear(),o=("0"+(u.getMonth()+1)).slice(-2),r=("0"+u.getDate()).slice(-2);return n+"-"+o+"-"+r}function e(d){for(var u=a(new Date),n=d.querySelectorAll("[data-date], [data-day]"),o=0;o<n.length;o++){var r=n[o],c=r.getAttribute("data-date")||r.getAttribute("data-day")||"";if(c){var f=String(c).slice(0,10);f===u&&r.classList.add("today")}}}function i(d){if(typeof window.attachICSButtons=="function"){try{window.attachICSButtons(d)}catch(R){logger.error(R)}return}for(var u=d.querySelectorAll("[data-appt], [data-start][data-title], .appt, .calendar-appt"),n=0;n<u.length;n++){var o=u[n];if(!o.querySelector(".bp-ics")){var r=o.getAttribute("data-start")||"",c=o.getAttribute("data-end")||"",f=o.getAttribute("data-title")||o.getAttribute("data-client")||"Appuntamento";if(r){var N=document.createElement("a");N.href="#",N.className="bp-ics btn-ics",N.textContent="📅",N.style.marginLeft="6px",N.onclick=function(R){R.preventDefault();try{var te=R.currentTarget.parentElement||document.body,_=te.getAttribute("data-start")||r,j=te.getAttribute("data-end")||c||_,ne=te.getAttribute("data-title")||te.getAttribute("data-client")||f,W=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//BP//Calendar//IT","BEGIN:VEVENT","UID:"+Date.now()+"@bp","DTSTAMP:"+new Date().toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z"),"DTSTART:"+new Date(_).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z"),"DTEND:"+new Date(j).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z"),"SUMMARY:"+ne,"END:VEVENT","END:VCALENDAR"].join("\r\n"),Z=new Blob([W],{type:"text/calendar"}),ue=URL.createObjectURL(Z),ce=document.createElement("a");ce.href=ue,ce.download=(ne||"appuntamento")+".ics",document.body.appendChild(ce),ce.click(),setTimeout(function(){URL.revokeObjectURL(ue);try{ce.remove()}catch(ye){}},0)}catch(ye){logger.error(ye)}},o.appendChild(N)}}}}function t(){var d=document.getElementById("calendar")||document.querySelector(".calendar")||document;e(d),i(d)}window.hookCalendar=t;function s(d){if(document.readyState==="complete"||document.readyState==="interactive")return d();document.addEventListener("DOMContentLoaded",d,{once:!0})}s(t);var w=document.getElementById("calendar")||document.querySelector(".calendar");if(w&&!w.__bpCalObs){w.__bpCalObs=!0;var p=new MutationObserver(function(){try{t()}catch(d){}});p.observe(w,{childList:!0,subtree:!0})}})(),(function(){var a=!1;function e(){if(!a){a=!0;var i='.today{outline:2px solid var(--accent, #5dd3ff); outline-offset:-2px; border-radius:8px; position:relative;}.today::after{content:"OGGI"; position:absolute; top:6px; right:8px; font-size:10px; font-weight:700; color:#fff; background:var(--accent, #5dd3ff); padding:2px 6px; border-radius:6px;}',t=document.createElement("style");t.setAttribute("data-bp-today","1"),t.textContent=i,document.head.appendChild(t)}}window.injectTodayCSS=e,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e,{once:!0}):e()})(),(function(){function a(){try{return JSON.parse(localStorage.getItem("user")||"{}")}catch(n){return{}}}function e(){var n=a();return n&&n.role==="admin"}function i(n,o){return(o||document).querySelector(n)}function t(n,o){return Array.prototype.slice.call((o||document).querySelectorAll(n))}function s(n){var o=new Date(n);return!o||isNaN(o)?"—":("0"+o.getDate()).slice(-2)+"/"+("0"+(o.getMonth()+1)).slice(-2)+"/"+o.getFullYear()}async function w(){try{for(var n=await ve("/api/appointments"),o=n&&n.appointments||[],r={},c=0;c<o.length;c++){var f=o[c],N=String(f.client||"").trim().toLowerCase();if(N){var R=new Date(f.start||f.end||0).getTime();(!r[N]||R>r[N])&&(r[N]=R)}}return r}catch(te){return logger.error(te),{}}}async function p(){var n=document.getElementById("cl_list");if(n){var o=await w();t(".card",n).forEach(function(r){var c=i("b",r);if(c){var f=(c.textContent||"").trim().toLowerCase();if(f){var N=o[f],R=i(".bp-lastapp",r),te="Ultimo appuntamento: "+(N?s(N):"—");if(R)R.textContent=te;else{var _=document.createElement("div");_.className="small muted bp-lastapp",_.textContent=te,r.appendChild(_)}}}})}}async function d(){if(!e())return;var n=document.getElementById("cl_list");if(!n)return;var[o,r]=await Promise.all([ve("/api/clients"),ve("/api/usernames")]),c=o&&o.clients||[],f=r&&r.users||[];function N(R){var te=i("b",R),_=(te&&te.textContent||"").trim().toLowerCase();return c.find(function(j){return String(j.name||"").trim().toLowerCase()===_})}n.__bpInlineReady||(n.__bpInlineReady=!0,t(".card",n).forEach(function(R){if(!R.__bpInline){R.__bpInline=!0;var te=N(R);if(te){var _=document.createElement("div");_.style.display="flex",_.style.gap="8px",_.style.marginTop="6px";var j=document.createElement("button");j.className="ghost",j.textContent="Modifica",_.appendChild(j),R.appendChild(_);var ne=document.createElement("div");ne.style.display="none",ne.style.marginTop="8px",ne.innerHTML='<div class="row" style="gap:8px"><div><label>Nome</label><input class="bp-ed-name" type="text" value="'+(te.name||"")+'"></div><div><label>Stato</label><select class="bp-ed-state"><option value="prospect" '+(te.status==="prospect"?"selected":"")+'>Prospect</option><option value="attivo" '+(te.status==="attivo"?"selected":"")+'>Attivo</option><option value="cliente" '+(te.status==="cliente"?"selected":"")+'>Cliente</option></select></div><div><label>Consulente</label><select class="bp-ed-consulente"></select></div><div style="align-self:flex-end"><button class="ghost bp-ed-save">Salva</button></div></div>',R.appendChild(ne);var W=i(".bp-ed-consulente",ne);W.innerHTML='<option value="">—</option>'+f.map(function(Z){return'<option value="'+Z.id+'" '+(String(te.consultantId||"")===String(Z.id)?"selected":"")+">"+(Z.name||"User "+Z.id)+"</option>"}).join(""),j.onclick=function(){ne.style.display=ne.style.display==="none"?"block":"none"},i(".bp-ed-save",ne).onclick=async function(Z){Z.preventDefault();try{var ue={id:te.id,name:i(".bp-ed-name",ne).value.trim(),status:i(".bp-ed-state",ne).value,consultantId:i(".bp-ed-consulente",ne).value||null};await be("/api/clients",ue);var ce=i("b",R);ce&&(ce.textContent=ue.name);var ye=i(".small",R);ye&&/Stato:/.test(ye.textContent||"")&&(ye.innerHTML="Stato: <b>"+ue.status+"</b>");var _e=t(".small",R).find(function(ke){return/Consulente:/.test(ke.textContent||"")});if(_e){var Be=f.find(function(ke){return String(ke.id)===String(ue.consultantId||"")});_e.innerHTML="Consulente: <b>"+(Be?Be.name||"User "+Be.id:"—")+"</b>"}De("medium")}catch(ke){logger.error(ke),De("heavy")}}}}}))}window.applyClientsLastAppointment=p,window.ensureClientInlineEdit=d;function u(){var n=document.getElementById("cl_list");if(n&&(p(),d(),!n.__bpCliObs)){n.__bpCliObs=!0;var o=new MutationObserver(function(){p(),d()});o.observe(n,{childList:!0,subtree:!0})}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",u,{once:!0}):u()})();function ie(a){const e=["#".concat(a,"_mode"),"#dash_mode","#comm_mode",'[data-scope="'.concat(a,'"] [name="mode"]'),"#".concat(a,' select[name="mode"]'),'#dashboard select[name="mode"]','select[name="mode"]'];for(const i of e){const t=document.querySelector(i);if(t&&t.value)return t.value}return"consuntivo"}if(window.__BP_FINAL_READY__)return;window.__BP_FINAL_READY__=!0;const ee=(a,e)=>(e||document).querySelector(a),he=(a,e,i)=>a&&a.addEventListener(e,i,!1),ge=a=>document.readyState!=="loading"?a():document.addEventListener("DOMContentLoaded",a),re=(a,e)=>{try{return JSON.parse(a)}catch(i){return e}},oe=a=>a<10?"0"+a:""+a,pe=()=>{const a=new Date;return"".concat(a.getFullYear(),"-").concat(oe(a.getMonth()+1),"-").concat(oe(a.getDate()))};function de(a){try{(window.showToast?window.showToast:alert)(a)}catch(e){alert(a)}}function Ce(){const a=i=>{if(!i)return null;i=String(i).replace(/^"+|"+$/g,"");try{const t=JSON.parse(i);if(t&&(t.token||t.jwt||t.accessToken))return t.token||t.jwt||t.accessToken}catch(t){}return/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+$/.test(i)?i:null};for(let i=0;i<localStorage.length;i++){const t=a(localStorage.getItem(localStorage.key(i)));if(t)return t}const e=["token","authToken","jwt","bp_token","accessToken","id_token","auth","authorization","bp.jwt","_token","session","user"];for(const i of e){const t=a(localStorage.getItem(i)||sessionStorage.getItem(i));if(t)return t}try{const i=re(localStorage.getItem("user")||"{}",{});if(i&&(i.token||i.jwt||i.accessToken))return i.token||i.jwt||i.accessToken}catch(i){}return null}async function ve(a,e={}){if(typeof window.GET=="function"&&!e.forceFetch)try{return await window.GET(a)}catch(s){}const i=Ce(),t=await fetch(a,{headers:{Accept:"application/json",...i?{Authorization:"Bearer "+i}:{}}});return t.status===401&&window.GET?window.GET(a):t.status===204?null:t.json()}async function be(a,e,i={}){if(typeof window.POST=="function"&&!i.forceFetch)try{return await window.POST(a,e)}catch(w){}const t=Ce(),s=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json",...t?{Authorization:"Bearer "+t}:{}},body:JSON.stringify(e||{})});return!s.ok&&s.status===401&&window.POST?window.POST(a,e):s.status===204?null:s.json()}function ze(a,e,i){const t=document.getElementById(a);if(!t)return;const s=t.getContext("2d"),w=window.devicePixelRatio||1,p=Math.max(220,t.clientWidth||320),d=Math.max(80,t.clientHeight||80);t.style.width=p+"px",t.style.height=d+"px",t.width=p*w,t.height=d*w,s.scale(w,w),s.clearRect(0,0,p,d);const u=Array.isArray(i)?i.map(_=>+_||0):[];if(!u.length)return;const n=Math.max(...u),o=Math.min(...u),r=n-o===0?(n||1)*.2:(n-o)*.2,c=n+r,f=Math.max(0,o-r),N=u.length>1?(p-8)/(u.length-1):0,R=_=>4+_*N,te=_=>{const j=(_-f)/(c-f||1);return d-6-j*(d-12)};s.lineWidth=2,s.lineJoin=s.lineCap="round",s.strokeStyle="#2e6cff",s.beginPath(),s.moveTo(R(0),te(u[0]));for(let _=1;_<u.length;_++)s.lineTo(R(_),te(u[_]));s.stroke(),s.fillStyle="#2e6cff";for(let _=0;_<u.length;_++)s.beginPath(),s.arc(R(_),te(u[_]),2,0,Math.PI*2),s.fill()}(function(){const e=function(i,t,s){const w=document.getElementById(i);if(w){if(window.Chart)try{w.__chart&&typeof w.__chart.destroy=="function"&&w.__chart.destroy();const p={type:"line",data:{labels:t,datasets:[{data:s,tension:.35,pointRadius:2,borderWidth:2}]},options:{responsive:!0,plugins:{legend:{display:!1}},scales:{x:{display:!0},y:{display:!0}}}};w.__chart=new Chart(w.getContext("2d"),p);return}catch(p){}ze(i,t,s)}};(!window.drawFullLine||!window.drawFullLine.__patched)&&(window.drawFullLine=e,window.drawFullLine.__patched=!0)})();const g=typeof window<"u"?window.__periodsCache||(window.__periodsCache={}):{};function b(a){try{const e=new Date(a),i=e.getUTCFullYear(),t=String(e.getUTCMonth()+1).padStart(2,"0"),s=String(e.getUTCDate()).padStart(2,"0");return i+"-"+t+"-"+s}catch(e){return""}}function G(a){try{return typeof effectivePeriodType=="function"?effectivePeriodType(String(a||"mensile").toLowerCase()):String(a||"mensile").toLowerCase()}catch(e){return String(a||"mensile").toLowerCase()}}async function C(a){if(!a){if(Array.isArray(window.periods)&&window.periods.length)return window.periods;try{const u=await ve("/api/periods?global=1");if(u&&Array.isArray(u.periods))return window.periods=u.periods,u.periods}catch(u){}return window.periods||[]}let e,i,t,s=null;if(typeof a=="string"){const u=window.readUnifiedRange&&window.readUnifiedRange(a)||{type:"mensile",end:new Date};e=u.type||"mensile";const n=window.buildBuckets?window.buildBuckets(e,u.end):[];if(n&&n.length)i=b(new Date(n[0].s)),t=b(new Date(n[n.length-1].e));else if(u.start&&u.end)i=b(new Date(u.start)),t=b(new Date(u.end));else{const o=new Date;i=b(o),t=b(o)}}else{const u=a||{};e=u.type||"mensile",i=u.from||b(new Date),t=u.to||b(new Date),s=u.userId||null}const w=G(e),p=[w,i,t,s||""].join("|");if(g[p])return g[p];const d=["?global=1","type="+encodeURIComponent(w),"from="+encodeURIComponent(i),"to="+encodeURIComponent(t)].concat(s?["userId="+encodeURIComponent(s)]:[]).join("&").replace("?&","?");try{const u=await ve("/api/periods"+d).catch(function(){return ve("/api/periods"+d.replace("?global=1","?").replace("??","?"))}),n=u&&Array.isArray(u.periods)?u.periods:[];return g[p]=n,n}catch(u){return[]}}function z(a,e,i){const t=String(e).toLowerCase()==="previsionale"?a.indicatorsPrev||{}:a.indicatorsCons||{},s=Number(t[i]||0);return Number.isFinite(s)?s:0}function L(a,e,i){if(typeof window.drawFullLine=="function")return window.drawFullLine(a,e,i);ze(a,e,i)}async function A(){const a=window.readUnifiedRange&&window.readUnifiedRange("dash")||{type:"mensile",end:new Date},e=a.type||"mensile",i=ie("dash"),t=window.buildBuckets?window.buildBuckets(e,a.end):[],s=await C("dash"),w=window.labelsFor?window.labelsFor(e,t):t.map((p,d)=>String(d+1));["VSS","VSDPersonale","GI","NNCF"].forEach(p=>{const d=t.map(u=>{let n=0;return s.forEach(o=>{if(o.type!==effectivePeriodType(e))return;const r=new Date(o.startDate).getTime(),c=new Date(o.endDate).getTime();r>=u.s&&c<=u.e&&(n+=z(o,i,p))}),Math.round(n)});L("d_mini_"+p.toLowerCase(),w,d)});try{if(window.BP&&BP.Targets&&typeof BP.Targets.getForPeriod=="function"){const p=JSON.parse(localStorage.getItem("user")||"{}")||{},d=String(p.grade||"junior").toLowerCase()==="senior"?"senior":"junior",u=BP.Targets.getForPeriod(d,effectivePeriodType(e))||{},n=["VSS","VSDPersonale","GI","NNCF"],o={};n.forEach(r=>{let c=0;const f=t[t.length-1];f&&(s.forEach(N=>{if(N.type!==effectivePeriodType(e))return;const R=new Date(N.startDate).getTime(),te=new Date(N.endDate).getTime();R>=f.s&&te<=f.e&&(c+=z(N,i,r))}),o[r]=Math.round(c))}),window.__bpCoachKpiFired=window.__bpCoachKpiFired||{},n.forEach(r=>{const c=Number(u[r]||0);if(c<=0)return;const f=Number(o[r]||0),N=Math.round(f/c*100),R=effectivePeriodType(e)+"_"+r;if(N>=100&&!window.__bpCoachKpiFired[R+"_100"]){window.__bpCoachKpiFired[R+"_100"]=!0;try{document.dispatchEvent(new CustomEvent("kpi:goal-reached",{detail:{key:r,value:f,target:c}}))}catch(te){}}else if(N>=80&&!window.__bpCoachKpiFired[R+"_80"]){window.__bpCoachKpiFired[R+"_80"]=!0;try{document.dispatchEvent(new CustomEvent("kpi:goal-80",{detail:{key:r,value:f,target:c}}))}catch(te){}}})}}catch(p){}}async function M(){const a="comm",e=window.readUnifiedRange&&(window.readUnifiedRange(a)||window.readUnifiedRange("cm"))||{type:"mensile",end:new Date},i=e.type||"mensile",t=ie&&ie(a)||ie&&ie("cm")||"cons",s=window.buildBuckets?window.buildBuckets(i,e.end):[],w=await C("comm"),p=window.labelsFor?window.labelsFor(i,s):s.map((u,n)=>String(n+1)),d=s.map(u=>{let n=0;return w.forEach(o=>{if(o.type!==effectivePeriodType(i))return;const r=new Date(o.startDate).getTime(),c=new Date(o.endDate).getTime();r>=u.s&&c<=u.e&&(n+=z(o,t,"VSDPersonale"))}),Math.round(n)});L("cm_mini_vsd",p,d)}async function S(){const a=window.readUnifiedRange&&(window.readUnifiedRange("t")||window.readUnifiedRange("tg"))||{type:"mensile",end:new Date},e=a.type||"mensile",i=ie&&ie("t")||ie&&ie("tg")||"cons",t=(ee("#tg_user")||{}).value||"",s=(ee("#tg_ind")||{}).value||"VSS",w=window.buildBuckets?window.buildBuckets(e,a.end):[];function p(c){try{const f=new Date(c),N=f.getUTCFullYear(),R=String(f.getUTCMonth()+1).padStart(2,"0"),te=String(f.getUTCDate()).padStart(2,"0");return N+"-"+R+"-"+te}catch(f){return""}}const d=w.length?p(new Date(w[0].s)):p(new Date),u=w.length?p(new Date(w[w.length-1].e)):p(new Date),n=await C({type:e,from:d,to:u,userId:t||null}),o=window.labelsFor?window.labelsFor(e,w):w.map((c,f)=>String(f+1)),r=w.map(c=>{let f=0;return n.forEach(N=>{if(N.type!==effectivePeriodType(e)||t&&String(N.userId)!==String(t))return;const R=new Date(N.startDate).getTime(),te=new Date(N.endDate).getTime();R>=c.s&&te<=c.e&&(f+=z(N,i,s))}),Math.round(f)});L("tg_chart",o,r)}function y(){he(ee("#dash_mode"),"change",()=>{De("light"),window.recomputeDashboard&&recomputeDashboard(),window.recomputeDashboardMini&&A()}),he(ee("#d_mode"),"change",()=>{De("light"),window.recomputeDashboard&&recomputeDashboard(),window.recomputeDashboardMini&&A()}),he(ee("#comm_mode"),"change",()=>{De("light"),window.recomputeCommsMini&&M()}),he(ee("#cm_mode"),"change",()=>{De("light"),window.recomputeCommsMini&&M()});const a=ee("#tg_user");a&&a.options.length<=1&&ve("/api/usernames").then(t=>{(t&&t.users||[]).forEach(s=>{var w=document.createElement("option");w.value=s.id,w.textContent=(s.name||"User "+s.id)+(s.grade?" – "+s.grade:""),a.appendChild(w)})}).catch(t=>logger.error(t));const e=()=>{window.recomputeTeamChart&&S(),window.recomputeTeamAggChart&&recomputeTeamAggChart()};he(ee("#t_mode"),"change",()=>{De("light"),e()}),["#t_y","#t_m","#t_q","#t_from","#t_to"].forEach(t=>{const s=ee(t);s&&he(s,"change",e)}),a&&he(a,"change",()=>{De("light"),window.recomputeTeamChart&&S()});const i=ee("#t_ind");i&&he(i,"change",()=>{De("light"),window.recomputeTeamAggChart&&recomputeTeamAggChart()}),ee("#tg_chart")&&window.recomputeTeamChart&&S(),ee("#t_chart")&&window.recomputeTeamAggChart&&recomputeTeamAggChart()}typeof window.todayKey!="function"&&(window.todayKey=function(){var e=new Date,i=e.getFullYear(),t=("0"+(e.getMonth()+1)).slice(-2),s=("0"+e.getDate()).slice(-2);return i+"-"+t+"-"+s});function E(){try{var a=pe(),e=document.querySelector('.calendar .day[data-day="'+a+'"], .calendar .day[data-date="'+a+'"]');if(!e)for(var i=parseInt(a.slice(8,10),10),t=document.querySelectorAll(".calendar .day"),s=0;s<t.length;s++){var w=t[s],p=parseInt((w.getAttribute("data-day")||w.getAttribute("data-date")||"").slice(8,10)||w.textContent.trim(),10);if(p===i){e=w;break}}e&&e.classList.add("today")}catch(d){}}function $(){try{for(var a=pe(),e=document.querySelectorAll(".calendar .day[data-day], .calendar .day[data-date]"),i=0;i<e.length;i++){var t=e[i],s=(t.getAttribute("data-day")||t.getAttribute("data-date")||"").slice(0,10);s&&s<a&&t.classList.remove("slot-free")}}catch(w){}}function I(){try{var a=document.getElementById("cal_day_box");if(!a)return;for(var e=a.querySelectorAll(".cal-app"),i=0;i<e.length;i++){var t=e[i];if(!t.querySelector("[data-ics-inline]")){var s=t.getAttribute("data-start")||"",w=t.getAttribute("data-end")||"",p=t.getAttribute("data-title")||(t.querySelector("b")?t.querySelector("b").textContent.trim():"Appuntamento");if(!(!s||!w)&&window.BP&&BP.ICS&&typeof BP.ICS.downloadIcsForAppointment=="function"){var d=document.createElement("button");d.className="ghost btn-ics",d.textContent="📅",d.setAttribute("data-ics-inline","1"),d.style.marginTop="6px",d.addEventListener("click",function(u){u.stopPropagation();var n=u.currentTarget.parentElement,o=n.getAttribute("data-start"),r=n.getAttribute("data-end"),c=n.getAttribute("data-title")||(n.querySelector("b")?n.querySelector("b").textContent.trim():"Appuntamento"),f={client:c,start:o,end:r,type:"manuale",vss:0,vsdPersonal:0,nncf:!1};try{BP.ICS.downloadIcsForAppointment(f),De("medium")}catch(N){}}),t.appendChild(d)}}}}catch(u){}}window.markToday=window.markToday||E,window.clampSlotCounters=window.clampSlotCounters||$,window.wireICSInsideDayBox=window.wireICSInsideDayBox||I,(function(){function a(p){return encodeURIComponent(String(p||""))}function e(){return ve("/api/users_emails").then(function(p){return p&&Array.isArray(p.emails)?p.emails.filter(Boolean):p&&Array.isArray(p.users)?p.users.map(d=>d.email).filter(Boolean):[]}).catch(function(){return ve("/api/usernames").then(function(p){var d=p&&p.users||[];return d.map(u=>u.email).filter(Boolean)}).catch(function(){return[]})})}function i(){var p=document.getElementById("report_subject");return p&&p.value.trim()||"Report BP"}function t(){var p=document.getElementById("report_body");return p&&p.value||""}function s(){var p=document.getElementById("rep_gmail_web"),d=document.getElementById("rep_gmail_app");!p&&!d||e().then(function(u){var n=(u||[]).join(",");function o(){return"https://mail.google.com/mail/?view=cm&fs=1&tf=1&su="+a(i())+"&cc="+a(n)+"&body="+a(t())}function r(){return"googlegmail:///co?subject="+a(i())+"&cc="+a(n)+"&body="+a(t())}p&&(p.onclick=function(){try{navigator.clipboard&&navigator.clipboard.writeText(t())}catch(c){}window.open(o(),"_blank")}),d&&(d.onclick=function(){try{navigator.clipboard&&navigator.clipboard.writeText(t())}catch(c){}location.href=r(),setTimeout(function(){if(!document.hidden){var c="mailto:?subject="+a(i())+"&cc="+a(n)+"&body="+a(t());location.href=c}},1200)})})}var w=window.BPFinal=window.BPFinal||{};w.wireReportButtons=s,window.wireReportButtons||(window.wireReportButtons=s)})(),(function(){let a={ts:0,map:null},e=null;function i(t){const s=Object.create(null);for(const w of t||[]){const p=String(w.client||"").toLowerCase();if(!p)continue;const d=+new Date(w.end||w.start||0);(!s[p]||d>s[p])&&(s[p]=d)}return s}window.BPFinal=window.BPFinal||{},BPFinal.getLastApptMap=function(){const s=Date.now();return a.map&&s-a.ts<15e3?Promise.resolve(a.map):e||(e=ve("/api/appointments?global=1").then(w=>i(w&&w.appointments||[])).then(w=>(a={ts:Date.now(),map:w},w)).catch(()=>({})).finally(()=>{e=null}),e)}})();function v(a){var t;if(!a)return;const e=a.getAttribute("data-clid")||"",i=(((t=a.querySelector("b"))==null?void 0:t.textContent)||"").trim();ve("/api/appointments?global=1").then(s=>{const w=s&&s.appointments||[],p=i.toLowerCase(),d=w.filter(r=>String(r.clientId||"")===e||String(r.client||"").trim().toLowerCase()===p);d.sort((r,c)=>new Date(c.start)-new Date(r.start));const u=d.map(r=>{const c=new Date(r.start),f=("0"+c.getDate()).slice(-2)+"/"+("0"+(c.getMonth()+1)).slice(-2)+"/"+c.getFullYear(),N=[];return Number(r.vss)>0&&N.push("VSS "+Number(r.vss).toLocaleString("it-IT")+"€"),Number(r.vsdPersonal)>0&&N.push("VSD "+Number(r.vsdPersonal).toLocaleString("it-IT")+"€"),Number(r.vsdIndiretto)>0&&N.push("VSD ind "+Number(r.vsdIndiretto).toLocaleString("it-IT")+"€"),Number(r.telefonate)>0&&N.push("Tel "+Number(r.telefonate)),Number(r.appFissati)>0&&N.push("AppFiss "+Number(r.appFissati)),'<div class="small">'.concat(m(r.type||"")," – ").concat(f).concat(N.length?" – "+N.join(" · "):"","</div>")}).join("")||'<div class="muted">Nessun appuntamento</div>',n=document.createElement("div");n.className="modal",n.innerHTML='<div class="card"><h3>Appuntamenti per '.concat(m(i),'</h3><div style="margin-top:8px">').concat(u,'</div><div class="row right"><button class="ghost" data-x>Chiudi</button></div></div>'),document.body.appendChild(n);const o=n.querySelector("[data-x]");o&&(o.onclick=()=>n.remove()),n.addEventListener("click",r=>{r.target===n&&n.remove()})}).catch(s=>{logger.error(s),de("Errore caricamento appuntamenti")})}BPFinal.showClientAppointments=v,BPFinal.enrichClientCards=function(){const e=document.getElementById("cl_list");e&&BPFinal.getLastApptMap().then(i=>{const t=e.querySelectorAll(".card[data-clid], .card");for(const s of t){const w=s.querySelector("b"),p=(w?w.textContent:s.getAttribute("data-name")||"").trim().toLowerCase(),d=i[p]||0,u=s.querySelector(".last-appt, .client-last");if(u)if(d){const n=new Date(d),o=("0"+n.getDate()).slice(-2),r=("0"+(n.getMonth()+1)).slice(-2),c=n.getFullYear();u.textContent="".concat(o,"/").concat(r,"/").concat(c)}else u.textContent="—";s.setAttribute("data-last-ts",String(d||0)),!s.getAttribute("data-name-lower")&&p&&s.setAttribute("data-name-lower",p),s.__bp_appts||(s.__bp_appts=!0,s.addEventListener("click",n=>{n.target.closest("button,select,input,a")||v(s)}))}})},BPFinal.enableClientsInlineAdmin=function(){const e=document.getElementById("cl_list");if(!e||e.__bp_inline_admin_wired)return;e.__bp_inline_admin_wired=!0;let i=null;function t(){return i?Promise.resolve(i):ve("/api/usernames").then(d=>i=d&&d.users||[]).catch(()=>[])}const s=["attivo","lead non chiuso","potenziale"];function w(d){if(!d||d.nodeType!==1||d.querySelector("[data-edit-client]"))return;d.style.position="relative";const u=document.createElement("button");u.className="ghost small",u.textContent="Modifica",u.title="Modifica cliente",u.setAttribute("data-edit-client","1"),u.style.position="absolute",u.style.right="8px",u.style.top="8px",u.style.zIndex="2",u.style.cursor="pointer",d.appendChild(u),u.addEventListener("click",function(){const n=d.getAttribute("data-clid")||d.dataset.clid||"",o=d.querySelector("b"),r=d.querySelector(".cl-status, .client-status"),c=d.querySelector(".cl-cons, .client-owner"),f={name:o?o.textContent.trim():"",status:String(r&&r.textContent||d.getAttribute("data-status")||"potenziale").toLowerCase(),consId:d.getAttribute("data-consultant-id")||"",consText:c?c.textContent:"—"},N=document.createElement("input");N.type="text",N.value=f.name,N.style.width="100%",o&&o.replaceWith(N);const R=document.createElement("select");R.innerHTML=s.map(te=>'<option value="'.concat(te,'">').concat(te.charAt(0).toUpperCase()+te.slice(1),"</option>")).join(""),R.value=s.includes(f.status)?f.status:"potenziale",r&&(r.textContent="",r.appendChild(R)),t().then(te=>{const _=document.createElement("select");_.innerHTML='<option value="">—</option>'+te.map(Z=>'<option value="'.concat(Z.id,'">').concat(Z.name||"User "+Z.id).concat(Z.grade?" ("+Z.grade+")":"","</option>")).join(""),f.consId&&(_.value=String(f.consId)),c&&(c.textContent="",c.appendChild(_));const j=document.createElement("div");j.className="row",j.style.marginTop="8px";const ne=document.createElement("button");ne.textContent="Salva";const W=document.createElement("button");W.textContent="Annulla",W.className="ghost",j.appendChild(ne),j.appendChild(W),d.appendChild(j),W.addEventListener("click",function(){const Z=document.createElement("b");Z.textContent=f.name,N.replaceWith(Z),r&&(r.textContent=f.status),c.textContent=f.consText||"—",j.remove()}),ne.addEventListener("click",function(){const Z={id:n,name:N.value.trim(),status:R.value},ue=_.value?String(_.value):"";ue&&(Z.consultantId=ue),be("/api/clients",Z).then(function(){de("Cliente aggiornato"),typeof addXP=="function"&&addXP(4);const ce=document.createElement("b");ce.textContent=Z.name||f.name,N.replaceWith(ce),r&&(r.textContent=Z.status),ue?(c.textContent=_.options[_.selectedIndex].textContent||"#"+ue,d.setAttribute("data-consultant-id",ue)):(c.textContent="—",d.setAttribute("data-consultant-id","")),d.setAttribute("data-status",Z.status),j.remove()}).catch(function(ce){logger.error(ce),de("Errore aggiornamento cliente")})})})})}e.querySelectorAll(".card[data-clid], .card").forEach(w),new MutationObserver(d=>{for(const u of d)for(const n of u.addedNodes)n.nodeType===1&&n.matches(".card[data-clid], .card")&&w(n),n.nodeType===1&&n.querySelectorAll&&n.querySelectorAll(".card[data-clid], .card").forEach(w)}).observe(e,{childList:!0,subtree:!0})},BPFinal.applyClientSort=function(){const e=document.getElementById("cl_list");if(!e)return;const i=document.getElementById("cl_order"),t=i?i.value:"az",s=Array.from(e.children).filter(w=>w.classList.contains("card"));if(s.length){t==="last_desc"?s.sort((w,p)=>(+p.getAttribute("data-last-ts")||0)-(+w.getAttribute("data-last-ts")||0)):s.sort((w,p)=>String(w.getAttribute("data-name-lower")||"").localeCompare(String(p.getAttribute("data-name-lower")||"")));for(const w of s)e.appendChild(w)}},BPFinal.ensureClientFilters=function(){const e=document.getElementById("cl_f_apply");e&&!e.__bp_wired&&(e.__bp_wired=!0,e.addEventListener("click",()=>{setTimeout(()=>{BPFinal.enrichClientCards(),BPFinal.applyClientSort()},0)}));const i=document.getElementById("cl_order");i&&!i.__bp_wired&&(i.__bp_wired=!0,i.addEventListener("change",()=>BPFinal.applyClientSort()))},BPFinal.wireCreateClientExtras=function(){const e=document.getElementById("cl_add");!e||e.__bp_wired||(e.__bp_wired=!0,e.addEventListener("click",i=>{const t=document.getElementById("cl_name"),s=document.getElementById("cl_new_state"),w=document.getElementById("cl_new_owner");if(!t)return;const p=(t.value||"").trim();if(!p||!s&&!w)return;i.stopPropagation(),i.preventDefault();const d={name:p};s&&(d.status=s.value),w&&w.value&&(d.consultantId=w.value),be("/api/clients",d).then(()=>{de("Cliente aggiunto"),addXP&&addXP(5),t.value="",setTimeout(()=>{BPFinal.enrichClientCards(),BPFinal.applyClientSort()},150)}).catch(()=>de("Errore creazione cliente"))},!0))},BPFinal.ensureClientSection=function(){BPFinal.ensureClientFilters(),BPFinal.wireCreateClientExtras(),BPFinal.enrichClientCards(),BPFinal.enableClientsInlineAdmin(),BPFinal.applyClientSort()};async function h(){const a=ee("#tg_user");if(!a||a.options.length>1)return;const e=await ve("/api/usernames").catch(()=>null);(e&&e.users||[]).forEach(i=>{const t=document.createElement("option");t.value=i.id,t.textContent=i.name+(i.grade?" ("+i.grade+")":""),a.appendChild(t)})}function P(){const a=ee("#users, .users");if(!a||a.__userEditWired)return;a.__userEditWired=!0,a.addEventListener("click",i=>{var n,o;const t=i.target.closest("[data-edit-user]");if(!t)return;const s=t.closest("[data-user-id]"),w=s==null?void 0:s.getAttribute("data-user-id"),p=((n=s==null?void 0:s.querySelector(".u-name"))==null?void 0:n.textContent)||"",d=((o=s==null?void 0:s.querySelector(".u-email"))==null?void 0:o.textContent)||"",u=document.createElement("div");u.className="modal",u.innerHTML='<div class="card"><h3>Modifica utente</h3><label>Nome <input id="u_name" value="'+p+'"></label><label>Email <input id="u_email" value="'+d+'"></label><label>Password <input id="u_pass" type="password" placeholder="(lascia vuoto per non cambiare)"></label><div class="row right"><button id="u_ok" class="btn-ghost">Salva</button><button id="u_x" class="btn-ghost">Chiudi</button></div></div>',document.body.appendChild(u),ee("#u_x",u).onclick=()=>u.remove(),ee("#u_ok",u).onclick=async()=>{try{const r={id:w,name:ee("#u_name",u).value,email:ee("#u_email",u).value},c=ee("#u_pass",u).value.trim();c&&(r.password=c),await be("/api/users",r),de("Utente aggiornato"),u.remove(),location.reload()}catch(r){de("Errore aggiornamento utente")}}});const e=ee("#btnProfile")||ee("[data-edit-self]");e&&!e.__wired&&(e.__wired=!0,e.onclick=()=>{const i=re(localStorage.getItem("user")||"{}",{}),t=document.createElement("div");t.className="modal",t.innerHTML='<div class="card"><h3>Profilo</h3><label>Nome <input id="me_name" value="'+(i.name||"")+'"></label><label>Email <input id="me_email" value="'+(i.email||"")+'"></label><label>Password <input id="me_pass" type="password" placeholder="(nuova password)"></label><div class="row right"><button id="me_ok" class="btn-ghost">Salva</button><button id="me_x" class="btn-ghost">Chiudi</button></div></div>',document.body.appendChild(t),ee("#me_x",t).onclick=()=>t.remove(),ee("#me_ok",t).onclick=async()=>{try{const s={id:i.id,name:ee("#me_name",t).value,email:ee("#me_email",t).value},w=ee("#me_pass",t).value.trim();w&&(s.password=w),await be("/api/users",s),de("Profilo aggiornato"),t.remove(),location.reload()}catch(s){de("Errore aggiornamento profilo")}}})}const T=document.createElement("div");T.className="bp-coach-host",T.style.cssText="position:fixed;left:50%;transform:translateX(-50%);z-index:1200;display:flex;flex-direction:column;gap:6px;pointer-events:none;",document.documentElement.appendChild(T);const B="\n    /* Desktop default */\n    .bp-coach-host{ top:14px; }\n    /* Mobile: place below header + safe-area */\n    @media (max-width:980px){\n      .bp-coach-host{ top: calc(env(safe-area-inset-top) + 56px + 12px); }\n    }\n    .bp-coach{background:rgba(20,24,34,.92);color:#fff;border:1px solid rgba(255,255,255,.16);\n      border-radius:12px;padding:8px 10px;font-weight:700;box-shadow:0 12px 24px rgba(0,0,0,.35);opacity:.98;transform:translateY(0);transition:all .18s;}\n    @keyframes bpCoachPop{from{transform:translateY(-6px);opacity:0}to{transform:translateY(0);opacity:1}}\n  ",x=document.createElement("style");x.textContent=B,document.head.appendChild(x);function U(){return re(localStorage.getItem("user")||"{}",{})}function k(a){const e=U().name||"campione",i=window.BP&&window.BP.Phrases?window.BP.Phrases:null;let t=[];return i?t=a==="high"?i.high||i.standard||[]:a==="low"?i.low||i.standard||[]:i.medium||i.standard||[]:t=["Grande {{name}}!","Che figata, {{name}}!","Super!","Non ti ferma nessuno!!","Grandissimo!"],t.length||(t=["Grande {{name}}!"]),t[Math.floor(Math.random()*t.length)].replace(/{{\s*name\s*}}/gi,e)}function q(a){const e=document.createElement("div");e.className="bp-coach",e.textContent=k(a||"medium"),T.appendChild(e),setTimeout(()=>{e.style.opacity="0",e.style.transform="translateY(-4px)"},2200),setTimeout(()=>{e.remove()},2420)}window.coachSay=window.coachSay||q;try{window.BP=window.BP||{},window.BP.Coach=window.BP.Coach||{},window.BP.Coach.say=window.BP.Coach.say||function(a,e){try{const i=String(a||"").toLowerCase();let t=e&&e.intensity||(i==="low"||i==="medium"||i==="high"?i:void 0);t||(i==="bp_saved"||i==="client_converted"||i==="gi_created"?t="high":i==="appointment_created"||i==="payments_defined"||i==="report_composed"?t="medium":t="low"),q(t)}catch(i){q("medium")}}}catch(a){}(function(){var a="bp-nncf-banner",e="bp_seen_nncf_appt";function i(){if(!document.getElementById("bp-nncf-css")){var d="\n      #".concat(a,"{\n        position: fixed; left: 16px; right:16px; bottom: 16px; z-index: 9999;\n        background: var(--card, rgba(15,18,28,.96));\n        border: 1px solid var(--hair2, rgba(255,255,255,.12));\n        border-radius: 14px; box-shadow: 0 8px 28px rgba(0,0,0,.35);\n        padding: 12px; display:flex; align-items:center; gap:12px; backdrop-filter: blur(6px);\n      }\n      #").concat(a," .msg{ flex:1; }\n      #").concat(a," .row{ display:flex; gap:8px; align-items:center; }\n      #").concat(a," .ghost{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.18); }\n      @media (prefers-color-scheme: light){\n        #").concat(a,"{ background:#fff; border-color: rgba(0,0,0,.12); }\n        #").concat(a," .ghost{ background:rgba(0,0,0,.04); border-color: rgba(0,0,0,.12); }\n      }\n    "),u=document.createElement("style");u.id="bp-nncf-css",u.textContent=d,document.head.appendChild(u)}}function t(d,u){return d?(d=String(d).trim().toLowerCase(),ve("/api/clients").then(function(n){var o=n&&n.clients||[],r=o.find(function(c){return String(c.name||"").trim().toLowerCase()===d});if(!r)throw new Error("Cliente non trovato: "+d);return be("/api/clients",{id:r.id,status:u})})):Promise.reject(new Error("Nome cliente mancante"))}function s(d){if(document.getElementById(a))return;i();var u=d.client||"Cliente",n=document.createElement("div");n.id=a,n.innerHTML='<div class="msg"><b>È diventato cliente?</b> '+m(u)+'</div><div class="row"><button class="ghost" id="bp_nncf_yes">Sì</button><button class="ghost" id="bp_nncf_notyet">Non ancora</button><button id="bp_nncf_close">Chiudi</button></div>',document.body.appendChild(n);function o(){try{localStorage.setItem(e,String(d.id||d.end||Date.now()))}catch(c){}}function r(){try{n.remove()}catch(c){}}document.getElementById("bp_nncf_yes").onclick=function(){t(u,"cliente").then(function(){de("Stato cliente aggiornato")}).catch(function(){de("Impossibile aggiornare lo stato")}).finally(function(){o(),r()})},document.getElementById("bp_nncf_notyet").onclick=function(){t(u,"prospect").catch(function(){}).finally(function(){o(),r()})},document.getElementById("bp_nncf_close").onclick=function(){o(),r()}}function w(){var d=localStorage.getItem(e)||"";return ve("/api/appointments").then(function(u){var n=Date.now(),o=u&&u.appointments||[],r=o.filter(function(N){if(!N||!N.nncf)return!1;var R=+new Date(N.end||N.start||0);return R&&R<n-60*1e3}).sort(function(N,R){return+new Date(R.end||R.start||0)-+new Date(N.end||N.start||0)});if(r.length){var c=r[0],f=String(c.id||c.end||"");f&&d&&String(d)===f||s(c)}}).catch(function(u){})}var p=window.BPFinal=window.BPFinal||{};p.injectBannerCSS=i,p.updateClientStatusByName=t,p.scanNNCF=w,window.scanNNCF||(window.scanNNCF=w)})(),(function(){window.showUndo=window.showUndo||function(a,e,i){try{var t=document.getElementById("bp_undo_bar");t||(t=document.createElement("div"),t.id="bp_undo_bar",t.style.position="fixed",t.style.left="16px",t.style.bottom="16px",t.style.zIndex="9999",t.style.background="rgba(20,22,28,0.95)",t.style.color="#fff",t.style.padding="10px 12px",t.style.borderRadius="10px",t.style.boxShadow="0 8px 24px rgba(0,0,0,.25)",t.style.display="flex",t.style.alignItems="center",t.style.gap="12px",document.body.appendChild(t)),t.innerHTML="<span>"+a+'</span><button id="bp_undo_btn" class="ghost" style="background:#fff;color:#111;border-radius:8px;padding:6px 10px">Annulla</button>';var s=document.getElementById("bp_undo_btn"),w=setTimeout(function(){try{t.remove()}catch(p){}},i||5e3);s.onclick=function(){clearTimeout(w);try{t.remove()}catch(p){}typeof e=="function"&&Promise.resolve(e()).then(function(){De("medium");try{document.dispatchEvent(new Event("undo:performed"))}catch(p){}}).catch(function(){De("heavy")})},De("light")}catch(p){logger.error(p)}},window.pushUndo=window.pushUndo||function(a){if(!(!a||typeof a.undo!="function")){var e=a.label||"Annulla ultima operazione";window.showUndo(e,a.undo,a.ttl||5e3)}},window.wireCoachUndoHaptics=function(){function a(){try{window.__periodsCache&&Object.keys(window.__periodsCache).forEach(function(i){delete window.__periodsCache[i]}),delete window.periods}catch(i){}}document.addEventListener("bp:saved",function(){window.coachSay&&q("high"),De("heavy"),a()}),document.addEventListener("bp:deleted",function(){window.coachSay&&q("medium"),De("medium"),a()}),document.addEventListener("appt:saved",function(){window.coachSay&&q("medium"),De("medium")}),document.addEventListener("ics:exported",function(){window.coachSay&&q("low"),De("light")}),document.addEventListener("report:composed",function(){window.coachSay&&q("medium"),De("medium")}),document.addEventListener("client:converted",function(){window.coachSay&&q("high"),De("heavy")}),document.addEventListener("gi:created",function(){window.coachSay&&q("high"),De("heavy")}),document.addEventListener("payments:defined",function(){window.coachSay&&q("medium"),De("medium")}),document.addEventListener("user:profile-updated",function(){window.coachSay&&q("low"),De("light")}),document.addEventListener("appt:created",function(){window.coachSay&&q("medium"),De("medium")}),document.addEventListener("undo:performed",function(){window.coachSay&&q("low"),De("light")}),document.addEventListener("kpi:goal-80",function(){window.coachSay&&q("medium"),De("medium")}),document.addEventListener("kpi:goal-reached",function(){window.coachSay&&q("high"),De("heavy")}),document.addEventListener("click",function(i){try{for(var t=i.target,s=0;s<3&&t;s++){if(t.matches&&(t.matches('[data-close], [aria-label*="Chiudi" i], [aria-label*="Close" i]')||(t.id||"").toLowerCase().includes("close")||(t.className||"").toLowerCase().includes("close")||/^\s*(chiudi|close)\s*$/i.test(t.textContent||""))){window.coachSay&&q("low"),De("light");break}t=t.parentElement}}catch(w){}},!0);var e=document.getElementById("app")||document.body;e&&!e.__undoWired&&(e.__undoWired=!0,e.addEventListener("click",function(i){var t=i.target.closest("[data-delete], .btn-delete");if(t){var s=t.getAttribute("href"),w=t.getAttribute("data-id");(s||w)&&(i.preventDefault(),showUndo("Eliminato — Annulla",async function(){try{if(s){var p=s+(s.indexOf("?")>=0?"&":"?")+"undo=1";await ve(p)}else w&&await be("/api/restore",{id:w});location.reload()}catch(d){logger.error(d)}}))}},!0))},window.wireHapticsUI=function(){var a=document.body;if(!a.__hapticsWired){a.__hapticsWired=!0,a.addEventListener("click",function(i){var t=i.target.closest('button, .button, .btn, .ghost, [role="button"], a.button, a.btn, [data-action]');if(t){var s="light";t.classList.contains("danger")||t.getAttribute("data-danger")==="1"?s="heavy":(t.classList.contains("primary")||t.getAttribute("data-primary")==="1")&&(s="medium"),De(s)}},!0),a.addEventListener("change",function(i){var t=i.target;t&&t.matches('select, input[type="checkbox"], input[type="radio"], input[type="range"]')&&De("light")},!0);var e=document.querySelector("[data-drawer-toggle], #menuToggle, .menu-toggle");e&&!e.__hW&&(e.__hW=!0,e.addEventListener("click",function(){De("light")},!0))}}})(),window.recomputeDashboardMini=typeof A=="function"?A:()=>{},window.recomputeCommsMini=typeof M=="function"?M:()=>{},window.recomputeTeamChart=typeof S=="function"?S:()=>{},window.ensureTeamUserSelect=typeof h=="function"?h:()=>{},window.attachICSButtons=typeof attachICSButtons=="function"?attachICSButtons:()=>{},window.addSaveAndExport=typeof addSaveAndExport=="function"?addSaveAndExport:()=>{},window.BPFinal=window.BPFinal||{},(function(a){function e(i,t){typeof t=="function"&&(a[i]=t,window[i]||(window[i]=t))}typeof A<"u"&&e("recomputeDashboardMini",A),typeof M<"u"&&e("recomputeCommsMini",M),typeof S<"u"&&e("recomputeTeamChart",S),typeof viewGI<"u"&&e("viewGI",viewGI),typeof h<"u"&&e("ensureTeamUserSelect",h),typeof attachICSButtons<"u"&&e("attachICSButtons",attachICSButtons),typeof addSaveAndExport<"u"&&e("addSaveAndExport",addSaveAndExport),typeof q<"u"&&e("coachSay",q),typeof ensureClientFilters<"u"&&e("ensureClientFilters",ensureClientFilters),typeof enrichClientCards<"u"&&e("enrichClientCards",enrichClientCards),typeof v<"u"&&e("showClientAppointments",v),typeof wireReportButtons<"u"&&e("wireReportButtons",wireReportButtons),typeof scanNNCF<"u"&&e("scanNNCF",scanNNCF),typeof ensureNNCFChip<"u"&&e("ensureNNCFChip",ensureNNCFChip),typeof E<"u"&&e("markToday",E),typeof $<"u"&&e("clampSlotCounters",$),typeof filterPastAppointments<"u"&&e("filterPastAppointments",filterPastAppointments),typeof openWeb<"u"&&e("openWeb",openWeb),typeof openApp<"u"&&e("openApp",openApp),typeof notifyConversion<"u"&&e("notifyConversion",notifyConversion),typeof icsFromAppt<"u"&&e("icsFromAppt",icsFromAppt),typeof downloadICS<"u"&&e("downloadICS",downloadICS),typeof ve<"u"&&e("GET",ve),typeof be<"u"&&e("POST",be)})(window.BPFinal);const le=new MutationObserver(()=>{typeof ensureNNCFChip=="function"&&ensureNNCFChip(),typeof addSaveAndExport=="function"&&addSaveAndExport(),typeof attachICSButtons=="function"&&attachICSButtons(),typeof wireReportButtons=="function"&&wireReportButtons(),typeof ensureClientFilters=="function"&&ensureClientFilters(),typeof enrichClientCards=="function"&&enrichClientCards(),typeof h=="function"&&h(),typeof P=="function"&&P(),typeof filterPastAppointments=="function"&&filterPastAppointments(document.body),typeof E=="function"&&E()});ge(async()=>{typeof injectTodayCSS=="function"&&injectTodayCSS(),typeof E=="function"&&E(),typeof $=="function"&&$(),typeof y=="function"&&y(),typeof A=="function"&&await A(),typeof M=="function"&&await M(),typeof S=="function"&&await S(),typeof wireHapticsUI=="function"&&wireHapticsUI(),typeof wireCoachUndoHaptics=="function"&&wireCoachUndoHaptics();try{const a="bpCoachGreetedDate",e=new Date().toISOString().slice(0,10);(localStorage.getItem(a)||"")!==e&&typeof window.coachSay=="function"&&(localStorage.setItem(a,e),q("low"))}catch(a){}le.observe(document.body,{childList:!0,subtree:!0}),window.onUnifiedRangeChange&&window.onUnifiedRangeChange(a=>{const e=a==="d"?"dash":a==="cm"?"comm":a==="tg"?"t":a;e==="dash"&&typeof A=="function"&&(A(),typeof renderDashboard=="function"&&renderDashboard()),e==="comm"&&typeof M=="function"&&M(),(e==="t"||e==="team")&&typeof S=="function"&&S()})})})();(function(){if(!window.GET)return;const m=window.GET;window.GET=function(l){try{if(typeof l=="string"&&l.indexOf("/api/leaderboard")===0){if(!(l.indexOf("/api/leaderboard_overall")===0)&&l.indexOf("indicator=")===-1)return Promise.resolve({ranking:[]});if(window.readUnifiedRange){var D=window.readUnifiedRange("lb")||{},J=D.type==="ytd"||D.type==="ltm"?"mensile":D.type;J&&(l+=(l.includes("?")?"&":"?")+"type="+encodeURIComponent(J))}var H=document.getElementById("lb_mode"),Y=H?H.value:"consuntivo";l+=(l.includes("?")?"&":"?")+"mode="+encodeURIComponent(Y)}}catch(K){}return m.apply(this,arguments)}})();(function(){if(!("serviceWorker"in navigator)||!("PushManager"in window))return;function m(){try{const Y=JSON.parse(localStorage.getItem("bp_user")||"null")||{};if(Y.token)return Y.token}catch(Y){}return localStorage.getItem("bp_token")||localStorage.getItem("authToken")||localStorage.getItem("token")||""}function l(Y){const K="=".repeat((4-Y.length%4)%4),X=(Y+K).replace(/-/g,"+").replace(/_/g,"/"),V=atob(X),ie=new Uint8Array(V.length);for(let ee=0;ee<V.length;ee++)ie[ee]=V.charCodeAt(ee);return ie}async function D(Y){const K=m();if(K)try{await fetch("/api/push/subscribe",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+K},body:JSON.stringify(Y)})}catch(X){logger.warn("[BP] push subscribe error",X)}}async function J(){try{const Y=await navigator.serviceWorker.ready;let K=await Y.pushManager.getSubscription();if(!K){const V=await(await fetch("/api/push/publicKey")).json(),ie=V.publicKey||V.key||"";if(!ie)return;K=await Y.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:l(ie)})}await D(K.toJSON())}catch(Y){logger.warn("[BP] push subscribe fail",Y)}}async function H(){if(Notification.permission==="granted")return J();if(Notification.permission==="default")try{if(await Notification.requestPermission()==="granted")return J()}catch(Y){}}window.BPPush={init:H,subscribe:J},window.addEventListener("load",H)})();function nt(m,l){localStorage.setItem(m,typeof l=="string"?l:JSON.stringify(l))}function mt(m,l){const D=localStorage.getItem(m);if(D==null)return l;try{return JSON.parse(D)}catch(J){return D}}function dt(m){localStorage.removeItem(m)}function Ut(m,l){l?nt("bp_token",m):sessionStorage.setItem("bp_token",m)}function vt(){return localStorage.getItem("bp_token")||sessionStorage.getItem("bp_token")||""}function Vt(m){nt("bp_user",m)}function Pe(){return mt("bp_user",null)||null}function Rt(){dt("bp_token"),sessionStorage.removeItem("bp_token"),dt("bp_user"),location.href="/?v=13"}function Bt(m,l={}){l.method=l.method||"GET";const D={...l.headers||{}},J=vt();return J&&(D.Authorization="Bearer "+J),l.body!=null&&typeof l.body!="string"&&(D["Content-Type"]="application/json; charset=utf-8",l.body=JSON.stringify(l.body)),l.headers=D,fetch(m,l).then(jt)}async function jt(m){const l=await m.text();if(!m.ok)throw Ht(l,m);return qt(l,m)}function Ht(m,l){try{const D=JSON.parse(m).error||"";return new Error(D||l.statusText||"HTTP "+l.status)}catch(D){return new Error(l.statusText||"HTTP "+l.status)}}function qt(m,l){try{if((l.headers.get("content-type")||"").toLowerCase().indexOf("application/json")!==-1)return m?JSON.parse(m):{}}catch(D){}return m}function Ie(m,l){return Bt(m,Object.assign({method:"GET"},{}))}function $e(m,l){return Bt(m,{method:"POST",body:l||{}})}function zt(m){return Bt(m,{method:"DELETE"})}function Ke(m){return(m<10?"0":"")+m}function ct(m){const l=new Date(m);return Ke(l.getDate())+"/"+Ke(l.getMonth()+1)+"/"+l.getFullYear()}function He(m){const l=new Date(m);return l.getFullYear()+"-"+Ke(l.getMonth()+1)+"-"+Ke(l.getDate())}function kt(m){const l=new Date(m);return Ke(l.getHours())+":"+Ke(l.getMinutes())}function Yt(m){const l=new Date(m);l.setHours(0,0,0,0);const D=(l.getDay()+6)%7;return l.setDate(l.getDate()-D),l}function It(m){const l=new Date(m);return new Date(l.getFullYear(),l.getMonth(),1)}function Ct(m){const l=new Date(m);return new Date(l.getFullYear(),l.getMonth()+1,0,23,59,59,999)}function Ve(m){const l=new Date(Date.UTC(m.getFullYear(),m.getMonth(),m.getDate())),D=l.getUTCDay()||7;l.setUTCDate(l.getUTCDate()+4-D);const J=new Date(Date.UTC(l.getUTCFullYear(),0,1));return Math.ceil(((l-J)/864e5+1)/7)}function gt(m){const l=new Date(m),D=Math.floor(l.getMonth()/3);return new Date(l.getFullYear(),D*3,1)}function xt(m){const l=gt(m);return new Date(l.getFullYear(),l.getMonth()+3,0,23,59,59,999)}function ht(m){const l=new Date(m),D=l.getMonth()<6?0:6;return new Date(l.getFullYear(),D,1)}function Et(m){const l=ht(m);return new Date(l.getFullYear(),l.getMonth()+6,0,23,59,59,999)}function Tt(m){const l=new Date(m);return new Date(l.getFullYear(),0,1)}function ft(m){const l=new Date(m);return new Date(l.getFullYear(),11,31,23,59,59,999)}function Gt(m,l){const D=new Date(m,0,1+(l-1)*7),J=D.getDay()||7,H=new Date(D);return H.setDate(D.getDate()-(J-1)),H.setHours(0,0,0,0),H}function ot(m,l){const D=Gt(m,l),J=new Date(D);return J.setDate(D.getDate()+6),J.setHours(23,59,59,999),{start:D,end:J}}function $t(m){const l=Yt(m);l.setDate(l.getDate()+7);const D=new Date(l);return D.setDate(l.getDate()+6),D.setHours(23,59,59,999),{start:l,end:D}}function Wt(m){const l=new Date(m.getFullYear(),m.getMonth()+1,1);return{start:l,end:new Date(l.getFullYear(),l.getMonth()+1,0,23,59,59,999)}}function Jt(m){const l=gt(new Date(m.getFullYear(),m.getMonth()+3,1));return{start:l,end:new Date(l.getFullYear(),l.getMonth()+3,0,23,59,59,999)}}function Kt(m){const l=ht(new Date(m.getFullYear(),m.getMonth()+6,1));return{start:l,end:new Date(l.getFullYear(),l.getMonth()+6,0,23,59,59,999)}}function Zt(m){const l=Tt(new Date(m.getFullYear()+1,0,1));return{start:l,end:ft(l)}}function ut(m,l){const D=new Date(l);return m==="settimanale"?"Sett. "+Ve(new Date(l))+" "+D.getFullYear():m==="mensile"?D.toLocaleString("it-IT",{month:"long",year:"numeric"}):m==="trimestrale"?"Trimestre "+(Math.floor(D.getMonth()/3)+1)+" "+D.getFullYear():m==="semestrale"?(D.getMonth()<6?"1°":"2°")+" semestre "+D.getFullYear():m==="annuale"?"Anno "+D.getFullYear():m==="ytd"?"YTD "+D.getFullYear():m==="ltm"?"Ultimi 12 mesi":m}let Xe;function Xt(){return Xe||(Xe=document.getElementById("toast-container"),Xe||(Xe=document.createElement("div"),Xe.id="toast-container",Xe.setAttribute("role","status"),Xe.setAttribute("aria-live","polite"),document.body.appendChild(Xe))),Xe}function me(m){const l=Xt(),D=document.createElement("div");D.className="toast",D.setAttribute("role","alert"),D.textContent=m,l.appendChild(D),setTimeout(function(){try{D.remove(),l.children.length||(l.remove(),Xe=null)}catch(J){}},2200)}function pt(){if(window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches)return;const m=document.createElement("div");m.className="confetti",document.body.appendChild(m);for(let l=0;l<26;l++){const D=document.createElement("span");D.style.position="absolute",D.style.left=2+l*4+"%",D.style.top="0",D.style.width="6px",D.style.height="10px",D.style.background="hsl("+l*14+",90%,60%)",D.style.opacity="0.95",m.appendChild(D),(function(J,H){setTimeout(function(){J.animate&&J.animate([{transform:"translateY(-20px) rotate(0deg)"},{transform:"translateY(110vh) rotate(540deg)"}],{duration:1200+Math.random()*800,easing:"cubic-bezier(.2,.6,.2,1)"})},H)})(D,l*35)}setTimeout(function(){try{m.remove()}catch(l){}},2500)}function Te(m){return String(m).replace(/[&<>'"]/g,function(l){return{"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"}[l]})}function et(m){return(Number(m)||0).toLocaleString("it-IT")+"€"}function je(m){const l=Number(m)||0;return String(Math.round(l))}function Qt(){if(document.getElementById("bp-mobile-drawer-fix"))return;const m="\n  @media (max-width:980px){\n    .topbar{\n      background: rgba(20,24,34,.90) !important;\n      border-bottom: 1px solid rgba(255,255,255,.08) !important;\n    }\n    .drawer{\n      background: rgba(20,24,34,.96) !important;\n      box-shadow: 14px 0 28px rgba(0,0,0,.45) !important;\n      width: 86vw !important;\n      overflow-y: auto !important;\n    }\n    .drawer .row{ gap:10px !important; }\n    .drawer button{\n      background: rgba(255,255,255,.10) !important;\n      border: 1px solid rgba(255,255,255,.22) !important;\n      color: #fff !important;\n      padding: 12px 14px !important;\n      font-weight: 700 !important;\n      border-radius: 12px !important;\n      -webkit-tap-highlight-color: transparent;\n    }\n    .drawer button:hover{\n      background: rgba(255,255,255,.14) !important;\n      border-color: rgba(255,255,255,.30) !important;\n    }\n    .drawer button.ghost{\n      background: rgba(255,255,255,.10) !important;\n      box-shadow: none !important;\n    }\n  }",l=document.createElement("style");l.id="bp-mobile-drawer-fix",l.textContent=m,document.head.appendChild(l)}function en(){if(document.getElementById("bp-mobile-light-fix"))return;const m="\n    @media (max-width:980px) and (prefers-color-scheme: light){\n      .topbar{\n        background:#fff !important;\n        border-bottom:1px solid rgba(0,0,0,.08) !important;\n        box-shadow:none !important;\n      }\n      .topbar .brand .logo{\n        color:#0f172a !important;\n        font-weight:900 !important;\n        letter-spacing:.4px;\n        text-shadow:none !important;\n        opacity:1 !important;\n      }\n      .topbar .hamb span{ background:#0f172a !important; }\n      .card{\n        background:#fff !important;\n        background-image:none !important;\n        box-shadow:none !important;\n      }\n      .drawer{\n        background:#fff !important;\n        box-shadow:14px 0 28px rgba(0,0,0,.10) !important;\n      }\n      .drawer button{\n        color:#0f172a !important;\n        background:rgba(0,0,0,.04) !important;\n        border:1px solid rgba(0,0,0,.12) !important;\n      }\n      .drawer button:hover{\n        background:rgba(0,0,0,.08) !important;\n      }\n    }\n  ",l=document.createElement("style");l.id="bp-mobile-light-fix",l.textContent=m,document.head.appendChild(l)}function tn(){if(document.getElementById("bp-badge-light-css"))return;const m="\n    @media (prefers-color-scheme: light){\n      .badge{\n        background: linear-gradient(180deg, #eef2ff, #f8fafc) !important;\n        border: 1px solid #c7d2fe !important;\n        color: #0f172a !important;\n        font-weight: 700 !important;\n        padding: 6px 10px !important;\n        border-radius: 9999px !important;\n        letter-spacing: .2px !important;\n        box-shadow: 0 1px 0 rgba(15,23,42,.05) inset !important;\n      }\n      .chip, .tag{\n        background: #ffffff !important;\n        border: 1px solid #cbd5e1 !important;\n        color: #0f172a !important;\n        font-weight: 600 !important;\n        border-radius: 9999px !important;\n      }\n      .card .badge{\n        background: #fff !important;\n      }\n    }\n  ",l=document.createElement("style");l.id="bp-badge-light-css",l.textContent=m,document.head.appendChild(l)}function We(){const m=Pe();if(!m)return"";const l=m.role==="admin",D='<span class="badge">Lvl '+(window.level?window.level():"")+" · XP "+(window.getXP?window.getXP():"")+"</span>",J='<div id="drawer" class="drawer" role="dialog" aria-modal="true" aria-label="Menu"><div class="row"><button class="ghost" onclick="viewHome();toggleDrawer(false)">Dashboard</button><button class="ghost" onclick="viewCalendar();toggleDrawer(false)">Calendario</button><button class="ghost" onclick="viewPeriods();toggleDrawer(false)">BP</button><button class="ghost" onclick="viewAppointments();toggleDrawer(false)">Appuntamenti</button><button class="ghost" onclick="viewLeaderboard();toggleDrawer(false)">Classifiche</button><button class="ghost" onclick="viewCommissions();toggleDrawer(false)">Provvigioni</button><button class="ghost" onclick="viewVendite();toggleDrawer(false)">Vendite e Riordini</button><button class="ghost" onclick="viewGI();toggleDrawer(false)">GI &amp; Scadenzario</button><button class="ghost" onclick="viewReport();toggleDrawer(false)">Report</button><button class="ghost" onclick="viewClients();toggleDrawer(false)">Clienti</button><button class="ghost" onclick="viewTeam();toggleDrawer(false)">Squadra</button>'+(l?'<button class="ghost" onclick="viewUsers();toggleDrawer(false)">Utenti</button>':"")+'<button onclick="logout()">Logout</button></div></div>';return'<div class="topbar"><div class="brand"><button class="hamb" id="hamb" aria-label="Apri menu" aria-controls="drawer" aria-expanded="false"><span></span><span></span><span></span></button><div class="logo">BATTLE PLAN</div></div><div class="nav right">'+D+'<button class="ghost" onclick="viewHome()">Dashboard</button><button class="ghost" onclick="viewCalendar()">Calendario</button><button class="ghost" onclick="viewPeriods()">BP</button><button class="ghost" onclick="viewAppointments()">Appuntamenti</button><button class="ghost" onclick="viewLeaderboard()">Classifiche</button><button class="ghost" onclick="viewCommissions()">Provvigioni</button><button class="ghost" onclick="viewVendite()">Vendite e Riordini</button><button class="ghost" onclick="viewGI()">GI &amp; Scadenzario</button><button class="ghost" onclick="viewReport()">Report</button><button class="ghost" onclick="viewClients()">Clienti</button><button class="ghost" onclick="viewTeam()">Squadra</button>'+(l?'<button class="ghost" onclick="viewUsers()">Utenti</button>':"")+'<button onclick="logout()">Logout</button></div></div>'+J}function qe(){if(!Pe())return;if(!document.getElementById("bp_nav_contrast_css")){const Y="\n      @media (min-width: 1024px){\n        .topbar .nav .ghost{\n          background: rgba(255,255,255,.06);\n          border: 1px solid rgba(255,255,255,.18);\n        }\n        .topbar .nav .ghost:hover{\n          background: rgba(255,255,255,.12);\n        }\n      }\n    ",K=document.createElement("style");K.id="bp_nav_contrast_css",K.textContent=Y,document.head.appendChild(K)}const m=document.getElementById("app"),l=document.querySelector(".topbar"),D=We();l?l.outerHTML=D:m&&m.insertAdjacentHTML("afterbegin",D);try{Qt()}catch(Y){}try{en()}catch(Y){}try{tn()}catch(Y){}if(!document.getElementById("bp-unified-filters-css")){const Y="\n      /* Nested inputs align in two columns inside unified filters */\n      .uf .row .row{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }\n\n      @media (max-width: 980px){\n        .uf input, .uf select{ min-width: 0; width: 100%; }\n        .uf .row > div{ flex: 1 1 180px; min-width: 0; }\n\n        /* Squadra admin bar: grid on small screens */\n        #t_adminbar{ display:grid !important; grid-template-columns: 1fr 1fr; align-items:end; gap:10px; }\n        #t_adminbar > div{ min-width: 0; }\n        #t_adminbar .row{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }\n      }\n\n      @media (max-width: 560px){\n        #t_adminbar{ grid-template-columns: 1fr; }\n      }\n    ",K=document.createElement("style");K.id="bp-unified-filters-css",K.textContent=Y,document.head.appendChild(K)}const J=document.getElementById("hamb");J&&(J.onclick=function(){wt()});const H=document.getElementById("drawer");H&&H.addEventListener("click",function(Y){Y.target.id==="drawer"&&wt(!1)}),document.removeEventListener("keydown",Pt,!1),document.addEventListener("keydown",Pt,!1)}function Pt(m){if(m&&m.key==="Escape"){const l=document.getElementById("drawer");l&&l.classList.contains("open")&&wt(!1)}}function wt(m){const l=document.getElementById("drawer");if(!l)return;const D=typeof m=="boolean"?m:!l.classList.contains("open");l.classList.toggle("open",D);const J=document.getElementById("hamb");J&&J.setAttribute("aria-expanded",String(D)),document.body.classList.toggle("no-scroll",D)}let At=null;function nn(){clearTimeout(At),At=setTimeout(qe,60)}function Ze(m){return document.querySelector(m)}function Dt(m){return Array.from(document.querySelectorAll(m))}(function(){const m=window.BP=window.BP||{},l=m.ICS=m.ICS||{};function D(V){if(!V)return"";if(/[Zz]|[+\-]\d{2}:\d{2}$/.test(String(V)))return new Date(V).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z").slice(0,15)+"Z";const[ie,ee="00:00"]=String(V).split("T"),[he,ge,re]=ie.split("-").map(Number),[oe,pe]=ee.split(":").map(Number);return new Date(he,ge-1,re,oe,pe,0,0).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z").slice(0,15)+"Z"}function J(V){return(V||"").replace(/\\/g,"\\\\").replace(/;/g,"\\;").replace(/,/g,"\\,").replace(/\n/g,"\\n")}function H(V){if(V.length<=74)return[V];const ee=[];let he=0;for(;he<V.length;){const ge=V.slice(he,he+74);ee.push(he===0?ge:" "+ge),he+=74}return ee}function Y(V){const ie=(V&&V.id||"bp-"+Date.now())+"@bpapp",ee=V&&V.client?"Appuntamento · "+V.client:"Appuntamento",he=D(V&&V.start),ge=D(V&&V.end),re=D(new Date().toISOString().slice(0,16)),oe=[];V&&V.type&&oe.push("Tipo: "+V.type),V&&V.vss&&oe.push("VSS: "+V.vss),V&&V.vsdPersonal&&oe.push("VSD Personale: "+V.vsdPersonal),V&&V.notes&&oe.push("Note: "+V.notes);const pe=J(oe.join("\n")),de=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//BPApp//Calendario//IT","CALSCALE:GREGORIAN","METHOD:PUBLISH","BEGIN:VEVENT","UID:"+ie,"DTSTAMP:"+re,he?"DTSTART:"+he:"",ge?"DTEND:"+ge:"","SUMMARY:"+J(ee),pe?"DESCRIPTION:"+pe:"","END:VEVENT","END:VCALENDAR"].filter(Boolean),Ce=[];return de.forEach(ve=>Ce.push.apply(Ce,H(ve))),Ce.join("\r\n")}function K(){try{const V=navigator.userAgent||navigator.vendor||"",ie=/iP(ad|hone|od)/.test(V),ee=/^((?!chrome|android|crios|fxios|edgi).)*safari/i.test(V);return ie||ee}catch(V){return!1}}function X(V){try{const ie=Y(V),ee=V&&V.start?String(V.start).split("T")[0]:"evento",he=(V&&V.client||"appuntamento").trim().replace(/[^\w\-]+/g,"_").slice(0,40),ge="bp_".concat(he,"_").concat(ee,".ics");if(K())try{const pe="data:text/calendar;charset=utf-8,"+encodeURIComponent(ie),de=document.createElement("a");return de.href=pe,de.setAttribute("target","_blank"),de.setAttribute("download",ge),document.body.appendChild(de),de.click(),de.remove(),!0}catch(pe){try{return window.location.assign("data:text/calendar;charset=utf-8,"+encodeURIComponent(ie)),!0}catch(de){try{logger.error(de)}catch(Ce){}return!1}}const re=new Blob([ie],{type:"text/calendar;charset=utf-8"}),oe=document.createElement("a");return oe.href=URL.createObjectURL(re),oe.download=ge,document.body.appendChild(oe),oe.click(),setTimeout(()=>{try{URL.revokeObjectURL(oe.href)}catch(pe){}oe.remove()},50),!0}catch(ie){try{logger.error(ie)}catch(ee){}return!1}}l.makeIcsForAppointment=Y,l.downloadIcsForAppointment=X,window.icsFromAppt=window.icsFromAppt||function(V){return Y(V)},window.downloadICS=window.downloadICS||function(V,ie){try{var ee=window.__icsSanitize?__icsSanitize(V):V||"evento";/\.ics$/i.test(ee)||(ee+=".ics");var he=new Blob([ie],{type:"text/calendar;charset=utf-8"}),ge=document.createElement("a");ge.href=URL.createObjectURL(he),ge.download=ee,document.body.appendChild(ge),ge.click(),setTimeout(function(){URL.revokeObjectURL(ge.href),ge.remove()},50)}catch(re){logger.error(re)}}})();(function(){var m=document.getElementById("app");window.$1=window.$1||Ze,window.$all=window.$all||Dt,window.addXP=window.addXP||function(){},typeof window.logger!="object"&&(window.logger=["debug","info","log","warn","error"].reduce((g,b)=>(g[b]=(console[b]||console.log).bind(console),g),{})),typeof window.haptic!="function"&&(window.haptic=window.BP&&BP.Haptics&&BP.Haptics.impact?BP.Haptics.impact:function(){}),(function(){const g=window.__miniCharts=window.__miniCharts||{};function b(A,M,S){const y=A.getContext("2d"),E=window.devicePixelRatio||1,$=A.clientWidth||320,I=A.clientHeight||80;A.width=Math.round($*E),A.height=Math.round(I*E),y.save(),y.scale(E,E),y.clearRect(0,0,$,I);const v=Math.max(1,...S),h=S.length>1?($-8)/(S.length-1):0;y.strokeStyle="#2e6cff",y.lineWidth=2,y.beginPath();for(let P=0;P<S.length;P++){const T=4+P*h,B=I-6-S[P]/v*(I-12);P===0?y.moveTo(T,B):y.lineTo(T,B)}y.stroke(),y.fillStyle="#2e6cff";for(let P=0;P<S.length;P++){const T=4+P*h,B=I-6-S[P]/v*(I-12);y.beginPath(),y.arc(T,B,2,0,Math.PI*2),y.fill()}y.restore()}function G(A,M){try{const S=Array.isArray(A)?A.length:0;if(!S)return{autoSkip:!0,maxRotation:0,minRotation:0};const y=Math.max(0,...A.map(I=>String(I||"").length)),E=Math.max(28,Math.min(90,Math.round(y*7)));return S*E>(M||320)*1.2?{autoSkip:!0,maxRotation:45,minRotation:45,callback:I=>String(I||"")}:{autoSkip:!0,maxRotation:0,minRotation:0,callback:I=>String(I||"")}}catch(S){return{autoSkip:!0,maxRotation:0,minRotation:0}}}window.computeTickOptions=G,window.drawFullLine=function(A,M,S){const y=document.getElementById(A);if(!y)return;if(y.width=y.clientWidth||y.width||320,y.height=y.clientHeight||y.height||80,typeof Chart>"u"){b(y,M,S),g[String(A)]={canvas:y,labels:M,data:S,fallback:!0};return}const E=String(A),$=G(M,y.width||320);if(g[E]&&g[E].canvas!==y){try{g[E].destroy()}catch(I){}delete g[E]}if(g[E]){const I=g[E];I.data.labels=M,I.data.datasets[0].data=S,I.options.scales.x.ticks=G(M,y.width||320),I.update()}else{const I=y.getContext("2d");g[E]=new Chart(I,{type:"line",data:{labels:M,datasets:[{label:"",data:S,borderColor:"#2e6cff",backgroundColor:"rgba(46,108,255,0.10)",borderWidth:2,tension:.3,pointRadius:3,pointHoverRadius:5,fill:!1}]},options:{responsive:!1,maintainAspectRatio:!1,animation:!1,animations:!1,plugins:{legend:{display:!1}},devicePixelRatio:window.devicePixelRatio||1,scales:{x:{grid:{display:!1},ticks:$},y:{beginAtZero:!0}}}})}};let C=window.devicePixelRatio||1;function z(){Object.keys(g).forEach(A=>{const M=g[A];if(M&&typeof M.resize=="function")try{M.resize()}catch(S){}else if(M&&M.fallback)try{b(M.canvas,M.labels,M.data)}catch(S){}})}function L(){const A=window.devicePixelRatio||1;A!==C&&(C=A,z())}window.addEventListener("pageshow",z),window.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&L()}),window.addEventListener("resize",L),window.addEventListener("orientationchange",()=>setTimeout(()=>{C=-1,L()},50))})();function l(){document.title="Battle Plan – Login";var g='<div class="hero" id="hero"><div class="layer glow"></div><div class="layer grid"></div><div class="title">Pianifica. Eroga. Vinci. <span class="small muted">BP – stile gaming</span></div></div><div class="wrap"><div class="grid"><div class="card"><h3>Accedi</h3><form id="loginForm" autocomplete="on"><div class="row"><div><label>Email</label><input id="li_email" name="email" type="email" autocomplete="username" required></div><div><label>Password</label><input id="li_password" name="password" type="password" autocomplete="current-password" required></div></div><div class="row"><label class="small"><input type="checkbox" id="li_remember" checked> Rimani collegato</label></div><div class="right" style="margin-top:8px"><button type="submit" id="btnLogin">Accedi</button></div></form></div><div class="card"><h3>Registrati</h3><form id="regForm" autocomplete="on"><div class="row"><div><label>Nome</label><input id="re_name" name="name" type="text" required></div><div><label>Email</label><input id="re_email" name="email" type="email" autocomplete="username" required></div><div><label>Password</label><input id="re_password" name="new-password" type="password" autocomplete="new-password" required></div></div><div class="right" style="margin-top:8px"><button type="submit" id="btnRegister">Registrati</button></div></form></div></div></div>';m.innerHTML=g;var b=document.getElementById("hero");b&&b.addEventListener("pointermove",function(z){var L=b.getBoundingClientRect();b.style.setProperty("--gx",(z.clientX-L.left)/L.width*100+"%"),b.style.setProperty("--gy",(z.clientY-L.top)/L.height*100+"%")});var G=document.getElementById("loginForm"),C=document.getElementById("regForm");G.addEventListener("submit",function(z){z.preventDefault();var L=document.getElementById("btnLogin");L.disabled=!0;var A=document.getElementById("li_email").value.trim().toLowerCase(),M=document.getElementById("li_password").value,S=document.getElementById("li_remember").checked;$e("/api/login",{email:A,password:M}).then(function(y){if(typeof y=="string")try{y=JSON.parse(y)}catch(E){}Ut(y.token,S),Vt(y.user),me("Bentornato "+y.user.name+"!"),window.addXP(10),ie(),qe(),window.BPPush&&window.BPPush.subscribe()},function(y){me("Credenziali errate"),logger.error(y)}).catch(function(y){logger.error(y)}).finally(function(){L.disabled=!1})}),C.addEventListener("submit",function(z){z.preventDefault();var L=document.getElementById("btnRegister");L.disabled=!0;var A=document.getElementById("re_name").value.trim(),M=document.getElementById("re_email").value.trim().toLowerCase(),S=document.getElementById("re_password").value;$e("/api/register",{name:A,email:M,password:S}).then(function(){me("Registrazione ok. Ora accedi"),pt(),window.addXP(20),window.scrollTo({top:0,behavior:"smooth"})}).catch(function(y){me("Email già registrata?"),logger.error(y)}).finally(function(){L.disabled=!1})})}function D(g){const b=new Date,G=b.getFullYear(),C=b.getMonth()+1,z=Ve(b),L=Math.floor((C-1)/3)+1,A=2e3,M=2100,S=(function(){let I="";for(let v=A;v<=M;v++)I+='<option value="'.concat(v,'" ').concat(v===G?"selected":"",">").concat(v,"</option>");return I})(),y=(function(){let I="";for(let v=1;v<=12;v++)I+='<option value="'.concat(v,'" ').concat(v===C?"selected":"",">").concat(v,"</option>");return I})(),E=(function(){let I="";for(let v=1;v<=53;v++)I+='<option value="'.concat(v,'" ').concat(v===z?"selected":"",">").concat(v,"</option>");return I})(),$=(function(){let I="";for(let v=1;v<=4;v++)I+='<option value="'.concat(v,'" ').concat(v===L?"selected":"",">Q").concat(v,"</option>");return I})();return'<div class="uf"><div class="row"><div><label>Granularità</label><select id="'+g+'_gran"><option value="settimanale">Settimanale</option><option value="mensile" selected>Mensile</option><option value="trimestrale">Trimestrale</option><option value="semestrale">Semestrale</option><option value="annuale">Annuale</option><option value="ytd">Anno corrente (YTD)</option><option value="ltm">Ultimi 12 mesi (LTM)</option></select></div><div id="'+g+'_wrap_week" style="display:none"><label>Settimana ISO</label><div class="row"><select id="'+g+'_week">'+E+'</select><select id="'+g+'_year_w">'+S+'</select></div></div><div id="'+g+'_wrap_month"><label>Mese</label><div class="row"><select id="'+g+'_month">'+y+'</select><select id="'+g+'_year_m">'+S+'</select></div></div><div id="'+g+'_wrap_quarter" style="display:none"><label>Trimestre</label><div class="row"><select id="'+g+'_quarter">'+$+'</select><select id="'+g+'_year_q">'+S+'</select></div></div><div id="'+g+'_wrap_sem" style="display:none"><label>Semestre</label><div class="row"><select id="'+g+'_sem"><option value="1">1°</option><option value="2">2°</option></select><select id="'+g+'_year_s">'+S+'</select></div></div><div id="'+g+'_wrap_year" style="display:none"><label>Anno</label><select id="'+g+'_year">'+S+'</select></div><div class="actions"><button id="'+g+'_refresh" class="ghost">Aggiorna</button></div></div></div>'}(function(){const g=[];window.onUnifiedRangeChange=function(b){typeof b=="function"&&g.push(b)},window.emitUnifiedRangeChange=function(b){for(const G of g)try{G(b)}catch(C){logger.error(C)}}})();function J(g){return g==="d"||g==="dash"?"dash":g==="cm"||g==="comm"?"comm":g==="tg"||g==="t"||g==="team"?"t":g}function H(g,b){function G(){const z=document.getElementById(g+"_gran").value;["week","month","quarter","sem","year"].forEach(A=>{const M=document.getElementById(g+"_wrap_"+A);M&&(M.style.display="none")}),z==="settimanale"?document.getElementById(g+"_wrap_week").style.display="":z==="mensile"?document.getElementById(g+"_wrap_month").style.display="":z==="trimestrale"?document.getElementById(g+"_wrap_quarter").style.display="":z==="semestrale"?document.getElementById(g+"_wrap_sem").style.display="":z==="annuale"&&(document.getElementById(g+"_wrap_year").style.display="")}["gran","week","year_w","month","year_m","quarter","year_q","sem","year_s","year"].forEach(z=>{const L=document.getElementById(g+"_"+z);L&&(L.onchange=()=>{G(),b&&b(),window.emitUnifiedRangeChange(J(g))},L.oninput=()=>{G()})});const C=document.getElementById(g+"_refresh");C&&(C.onclick=()=>{b&&b(),window.emitUnifiedRangeChange(J(g))}),G()}function Y(g){var b=new Date;function G(U,k){var q=document.getElementById(g+"_"+U),le=q?parseInt(q.value,10):NaN;return isFinite(le)?le:k}var C=document.getElementById(g+"_gran"),z=C?C.value:"mensile",L={type:z,start:null,end:null};if(z==="settimanale"){var A=G("year_w",b.getFullYear()),M=Math.max(1,Math.min(53,G("week",Ve(b)))),S=ot(A,M);return L.start=S.start,L.end=S.end,L}if(z==="mensile"){var y=G("year_m",b.getFullYear()),E=Math.max(1,Math.min(12,G("month",b.getMonth()+1)));return L.start=new Date(y,E-1,1),L.end=new Date(y,E,0,23,59,59,999),L}if(z==="trimestrale"){var $=G("year_q",b.getFullYear()),I=Math.max(1,Math.min(4,G("quarter",Math.floor(b.getMonth()/3)+1)));return L.start=new Date($,(I-1)*3,1),L.end=new Date($,I*3,0,23,59,59,999),L}if(z==="semestrale"){var v=G("year_s",b.getFullYear()),h=G("sem",b.getMonth()<6?1:2);return L.start=new Date(v,h===1?0:6,1),L.end=new Date(v,h===1?6:12,0,23,59,59,999),L}if(z==="annuale"){var P=G("year",b.getFullYear());return L.start=new Date(P,0,1),L.end=new Date(P,11,31,23,59,59,999),L}if(z==="ytd"){var T=new Date(b.getFullYear(),b.getMonth()+1,0,23,59,59,999);return L.start=new Date(b.getFullYear(),0,1),L.end=T,L}if(z==="ltm"){var B=new Date(b.getFullYear(),b.getMonth()+1,0,23,59,59,999),x=new Date(B.getFullYear(),B.getMonth()-11,1);return L.start=x,L.end=B,L}return L.type="mensile",L.start=new Date(b.getFullYear(),b.getMonth(),1),L.end=new Date(b.getFullYear(),b.getMonth()+1,0,23,59,59,999),L}function K(g){return g==="ytd"||g==="ltm"?"mensile":g}window.effectivePeriodType=K;function X(g,b){var G=K(g||"mensile"),C=b?new Date(b):new Date,z=C.getUTCFullYear(),L=[];function A(o,r){L.push({s:o.getTime(),e:r.getTime()})}function M(o,r,c){return new Date(Date.UTC(o,r,c))}function S(o){return new Date(o.getTime()+24*3600*1e3-1)}function y(o,r){return new Date(Date.UTC(o,r+1,0))}if(G==="settimanale"){var E=new Date(Date.UTC(C.getUTCFullYear(),C.getUTCMonth(),C.getUTCDate())),$=(E.getUTCDay()+6)%7;E.setUTCDate(E.getUTCDate()-$);for(var I=52;I>=0;I--){var v=new Date(E);v.setUTCDate(E.getUTCDate()-I*7);var h=new Date(v);h.setUTCDate(v.getUTCDate()+6),h.setUTCHours(23,59,59,999),A(v,h)}return L}if(G==="mensile"){for(var P=new Date(Date.UTC(C.getUTCFullYear(),C.getUTCMonth(),1)),T=23;T>=0;T--){var B=new Date(Date.UTC(P.getUTCFullYear(),P.getUTCMonth()-T,1));A(B,S(y(B.getUTCFullYear(),B.getUTCMonth())))}return L}if(G==="trimestrale"){for(var x=Math.floor(C.getUTCMonth()/3),U=11;U>=0;U--){var k=x-U,q=z+Math.floor(k/4),le=(k%4+4)%4,v=M(q,le*3,1),h=S(new Date(Date.UTC(q,le*3+3,0)));A(v,h)}return L}if(G==="semestrale"){for(var a=C.getUTCMonth()<6?0:1,e=5;e>=0;e--){var i=a-e,t=z+Math.floor(i/2),s=(i%2+2)%2,w=s===0?0:6,p=M(t,w,1),d=S(new Date(Date.UTC(t,w+6,0)));A(p,d)}return L}for(var u=2;u>=0;u--){var n=z-u;A(M(n,0,1),S(new Date(Date.UTC(n,12,0))))}return L}function V(g,b){var G=K(g||"mensile");return(b||[]).map(function(C){var z=new Date(C.s);return G==="settimanale"?"W"+Ve(z)+" "+z.getUTCFullYear():G==="mensile"?String(z.getUTCMonth()+1).padStart(2,"0")+"/"+z.getUTCFullYear():G==="trimestrale"?"Q"+(Math.floor(z.getUTCMonth()/3)+1)+" "+z.getUTCFullYear():G==="semestrale"?(z.getUTCMonth()<6?"S1 ":"S2 ")+z.getUTCFullYear():String(z.getUTCFullYear())})}function ie(){if(!Pe())return l();document.title="Battle Plan – Dashboard",m.innerHTML=We()+'<div class="wrap"><div class="card"><b>Filtro</b><div class="row uf-row" style="margin-top:6px;align-items:flex-end;gap:16px;flex-wrap:wrap"><div><label>Modalità</label><select id="dash_mode" name="mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div><div><label>Consulente</label><select id="dash_cons"><option value="">Tutti</option></select></div></div>'+D("dash")+'</div><div class="grid" id="kpiGrid"><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>VSS</b><span id="kpi_vss" class="big">—</span></div><canvas id="d_mini_vss" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>VSD personale</b><span id="kpi_vsd" class="big">—</span></div><canvas id="d_mini_vsdpersonale" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>VSD indiretto</b><span id="kpi_vsd_ind" class="big">—</span></div><canvas id="d_mini_vsdindiretto" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>GI</b><span id="kpi_gi" class="big">—</span></div><canvas id="d_mini_gi" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>NNCF</b><span id="kpi_nncf" class="big">—</span></div><canvas id="d_mini_nncf" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>Tot Provvigioni</b><span id="kpi_provv" class="big">—</span></div><canvas id="d_mini_provv" width="320" height="90"></canvas></div></div><div class="card"><b>Ultimi appuntamenti</b><div id="lastApps" class="row" style="margin-top:8px"></div></div><div class="card"><b>Ultimi BP inviati</b><div id="lastBPs" class="row" style="margin-top:8px"></div></div></div>',qe();function g(h,P){var T=document.getElementById(h);T&&(T.textContent=P)}function b(h){var P=Number(h)||0;return P.toLocaleString("it-IT")+"€"}function G(h){var P=Number(h)||0;return String(Math.round(P))}function C(h){return String(h).replace(/[&<>'"]/g,P=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[P])}(function(){Ie("/api/usernames").then(function(P){var T=P&&P.users||[],B=document.getElementById("dash_cons");B&&(B.innerHTML='<option value="">Tutti</option>'+T.map(function(x){return'<option value="'+C(String(x.id))+'">'+C(x.name||x.email||"User #"+x.id)+"</option>"}).join(""))}).catch(function(){})})();function z(h,P){return P==="settimanale"?window.isoWeekNum?window.isoWeekNum(h):Math.ceil(h.getDate()/7):P==="mensile"||P==="ytd"||P==="ltm"?h.getMonth()+1:P==="trimestrale"?Math.floor(h.getMonth()/3)+1:P==="semestrale"?h.getMonth()<6?1:2:h.getFullYear()}function L(h){if(typeof X=="function")return(X(h,new Date)||[]).map(function(_){return{s:_.s,e:_.e}});var P=new Date,T=[];function B(_,j){T.push({s:_.getTime(),e:j.getTime()})}function x(_){var j=new Date(_);return j.setHours(23,59,59,999),j}function U(_,j){return new Date(_,j+1,0,23,59,59,999)}var k=String(h||"mensile").toLowerCase();if(k==="settimanale"){var q=new Date(P),le=(q.getDay()+6)%7;q.setDate(q.getDate()-le),q.setHours(0,0,0,0);for(var a=52;a>=0;a--){var e=new Date(q);e.setDate(e.getDate()-a*7);var i=new Date(e);i.setDate(e.getDate()+6),i.setHours(23,59,59,999),B(e,i)}return T}if(k==="mensile"||k==="ytd"||k==="ltm"){if(k==="ytd")for(var t=0;t<=P.getMonth();t++){var s=new Date(P.getFullYear(),t,1);B(s,U(P.getFullYear(),t))}else for(var w=k==="ltm"?12:24,p=new Date(P.getFullYear(),P.getMonth(),1),d=w-1;d>=0;d--){var e=new Date(p.getFullYear(),p.getMonth()-d,1);B(e,U(e.getFullYear(),e.getMonth()))}return T}if(k==="trimestrale"){for(var u=Math.floor(P.getMonth()/3)*3,n=new Date(P.getFullYear(),u,1),o=11;o>=0;o--){var r=new Date(n.getFullYear(),n.getMonth()-o*3,1);B(r,x(new Date(r.getFullYear(),r.getMonth()+3,0)))}return T}if(k==="semestrale"){for(var c=P.getMonth()<6?0:6,f=new Date(P.getFullYear(),c,1),e=5;e>=0;e--){var N=new Date(f.getFullYear(),f.getMonth()-e*6,1);B(N,x(new Date(N.getFullYear(),N.getMonth()+6,0)))}return T}for(var R=2;R>=0;R--){var te=new Date(P.getFullYear()-R,0,1);B(te,x(new Date(te.getFullYear(),12,0)))}return T}function A(h){switch(String(h)){case"provv_gi":return"ProvvGI";case"provv_vsd":return"ProvvVSD";case"tot_provv":return"TotProvvigioni";default:return h}}function M(h,P,T,B){var x=B||Y("dash"),U=String(x.type||"mensile").toLowerCase(),k=U==="ytd"||U==="ltm"?"mensile":U,q=L(U);function le(i,t){var s=new Date(t.startDate).getTime(),w=new Date(t.endDate).getTime();return s>=i.s&&w<=i.e}function a(i,t){if(!i)return 0;if(t==="VSDTotale")return Number(i.VSDPersonale||0)+Number(i.VSDIndiretto||0);if(t==="ProvvGI")return Number(i.ProvvGI||0);if(t==="ProvvVSD")return Number(i.ProvvVSD||0);if(t==="TotProvvigioni"){var s=i.TotProvvigioni;return Number(s!=null?s:Number(i.ProvvGI||0)+Number(i.ProvvVSD||0))}return Number(i[t]||0)}var e=(function(){var i=q.length?He(new Date(q[0].s)):He(new Date),t=q.length?He(new Date(q[q.length-1].e)):He(new Date),s="?global=1&type="+encodeURIComponent(k)+"&from="+encodeURIComponent(i)+"&to="+encodeURIComponent(t);return T&&(s+="&userId="+encodeURIComponent(T)),s})();return Ie("/api/periods"+e).catch(function(){return Ie("/api/periods"+e.replace("?global=1",""))}).then(function(i){var t=i&&i.periods||[],s=t.filter(function(d){return!(d.type!==k||T&&String(d.userId||d.uid||"")!==String(T))}),w=A(h),p=q.map(function(d){for(var u=0,n=0;n<s.length;n++){var o=s[n];if(le(d,o)){var r=P==="previsionale"?o.indicatorsPrev||{}:o.indicatorsCons||{};u+=a(r,w)}}return{x:new Date(d.s),y:Math.round(u*100)/100}});return p})}function S(h,P,T){var B=document.getElementById(h);if(B){if(typeof window.drawFullLine=="function"){window.drawFullLine(h,P,T);return}var x=B.getContext("2d");B.width=B.clientWidth||320,B.height=B.clientHeight||80,x.clearRect(0,0,B.width,B.height);var U=Math.max(1,...T),k=T.length>1?(B.width-8)/(T.length-1):0;x.strokeStyle="#2e6cff",x.lineWidth=2,x.beginPath();for(var q=0;q<T.length;q++){var le=4+q*k,a=B.height-6-T[q]/U*(B.height-12);q===0?x.moveTo(le,a):x.lineTo(le,a)}x.stroke()}}function y(){var h=(document.getElementById("dash_mode")||{}).value||"consuntivo",P=Y("dash"),T=K(P.type||"mensile"),B=new Date(P.start).getTime(),x=new Date(P.end).getTime(),U=(document.getElementById("dash_cons")||{}).value||"";function k(e){return e=Number(e==null?"":e),isFinite(e)?e:0}function q(e){if(!e)return 0;for(var i=["VSDIndiretto","vsdIndiretto","VSD_indiretto","VSDI"],t=0;t<i.length;t++)if(e[i[t]]!=null)return k(e[i[t]]);return e.VSDTotale!=null&&e.VSDPersonale!=null?k(e.VSDTotale)-k(e.VSDPersonale):0}function le(e){return e?e.TotProvvigioni!=null?k(e.TotProvvigioni):k(e.ProvvGI)+k(e.ProvvVSD):0}var a=(function(){var e=He(new Date(B)),i=He(new Date(x)),t="?type="+encodeURIComponent(T)+"&from="+encodeURIComponent(e)+"&to="+encodeURIComponent(i);return U&&(t+="&userId="+encodeURIComponent(U)),t})();return Ie("/api/periods"+a).then(function(e){for(var i=e&&e.periods||[],t={VSS:0,VSDPersonale:0,VSDIndiretto:0,GI:0,NNCF:0,PROVV:0},s=0;s<i.length;s++){var w=i[s];if(String(w.type)===String(T)&&!(U&&String(w.userId||w.uid||"")!==String(U))){var p=new Date(w.startDate).getTime(),d=new Date(w.endDate).getTime();if(!(p<B||d>x)){var u=h==="previsionale"?w.indicatorsPrev||{}:w.indicatorsCons||{};t.VSS+=k(u.VSS),t.VSDPersonale+=k(u.VSDPersonale),t.VSDIndiretto+=q(u),t.GI+=k(u.GI),t.NNCF+=k(u.NNCF),t.PROVV+=le(u)}}}g("kpi_vss",b(t.VSS)),g("kpi_vsd",b(t.VSDPersonale)),g("kpi_vsd_ind",b(t.VSDIndiretto)),g("kpi_gi",b(t.GI)),g("kpi_nncf",G(t.NNCF)),g("kpi_provv",b(t.PROVV))})}function E(){var h=(document.getElementById("dash_mode")||{}).value||"consuntivo",P=(document.getElementById("dash_cons")||{}).value||"",T=Y("dash"),B=String(T.type||"mensile").toLowerCase(),x=L(B),U=typeof V=="function"?V(B,x):x.map(function(q){return z(new Date(q.s),B)});function k(q,le){var a=q.map(function(e){return e.y});S(le,U,a)}Promise.all([M("VSS",h,P||null,T),M("VSDPersonale",h,P||null,T),M("VSDIndiretto",h,P||null,T),M("GI",h,P||null,T),M("NNCF",h,P||null,T),M("TotProvvigioni",h,P||null,T)]).then(function(q){k(q[0],"d_mini_vss"),k(q[1],"d_mini_vsdpersonale"),k(q[2],"d_mini_vsdindiretto"),k(q[3],"d_mini_gi"),k(q[4],"d_mini_nncf"),k(q[5],"d_mini_provv")}).catch(function(q){logger.error(q)})}function $(){var h=(document.getElementById("dash_cons")||{}).value||"",P=(typeof Y=="function"?Y("dash"):{})||{},T=typeof K=="function"?K(P.type||"mensile"):P.type||"mensile";(function(){var e=document.getElementById("lastApps");if(e){var i=e.parentElement;if(!document.getElementById("nextApps")){var t=document.createElement("div");t.className="card",t.innerHTML='<b>Prossimi appuntamenti (oggi + domani)</b><div id="nextApps" style="margin-top:8px"></div>',i.parentElement.insertBefore(t,i)}}})();function B(a){return'<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px">'+a+"</div>"}function x(a){return a=String(a||"").toLowerCase(),a.indexOf("mezza")>-1?240:a.indexOf("giorn")>-1||a.indexOf("formaz")>-1||a.indexOf("mbs")>-1?570:a.indexOf("sottoprod")>-1?240:(a.indexOf("vend")>-1,90)}function U(a){var e=new Date(a.start),i=new Date(a.end);(!(i instanceof Date)||isNaN(i)||i<e)&&(i=new Date(e.getTime()+x(a.type||"vendita")*6e4));var t=ct(e)+" "+kt(e)+"–"+(("0"+i.getHours()).slice(-2)+":"+("0"+i.getMinutes()).slice(-2)),s=a.nncf?" · NNCF ✅":"",w=String(a.type||"").toLowerCase(),p;return w.indexOf("mbs")>-1?p="VSD ind "+b(a.vsdIndiretto||0):w.indexOf("sottoprod")>-1?p="Tel "+G(a.telefonate||0)+" · AppFissati "+G(a.appFissati||0):w.indexOf("formaz")>-1?p="":p="VSS "+b(a.vss||0)+" · VSD "+b(a.vsdPersonal||0)+s,'<div class="card lastApp" data-aid="'+C(String(a.id||""))+'" style="cursor:pointer"><div class="small muted">'+C(t)+" · "+C(a.type||"manuale")+'</div><div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><div><b>'+C(a.client||"")+'</b></div><div class="row" style="gap:6px"><button class="ghost btn-ics" title="Esporta .ics" data-ics="'+C(String(a.id||""))+'">📅</button></div></div>'+(p?'<div class="small">'+p+"</div>":"")+"</div>"}function k(a){return a&&Object.keys(a).length>0}function q(a){return a=Number(a||0),isFinite(a)?a:0}var le=(function(){var a=He(new Date(P.start)),e=He(new Date(P.end)),i="?type="+encodeURIComponent(T)+"&from="+encodeURIComponent(a)+"&to="+encodeURIComponent(e);return h&&(i+="&userId="+encodeURIComponent(h)),i})();Promise.all([Ie("/api/appointments"),Ie("/api/periods"+le)]).then(function(a){var e=a[0]&&a[0].appointments||[],i=a[1]&&a[1].periods||[];(function(){var s=document.getElementById("nextApps");if(s){var w=new Date,p=new Date(w.getFullYear(),w.getMonth(),w.getDate(),0,0,0,0),d=new Date(w.getFullYear(),w.getMonth(),w.getDate()+2,0,0,0,0),u=e.filter(function(n){var o=new Date(n.start).getTime(),r=o>=p.getTime()&&o<d.getTime(),c=h?String(n.userId||n.uid||"")===String(h):!0;return r&&c}).sort(function(n,o){return new Date(n.start)-new Date(o.start)});s.innerHTML=u.length?B(u.map(U).join("")):'<div class="muted">Nessun appuntamento tra oggi e domani</div>',s.querySelectorAll(".lastApp[data-aid]").forEach(function(n){n.addEventListener("click",function(){try{nt("bp_edit_aid",n.getAttribute("data-aid"))}catch(o){}ge()})}),s.querySelectorAll("button[data-ics]").forEach(function(n){n.addEventListener("click",function(o){o.stopPropagation();var r=n.getAttribute("data-ics"),c=u.find(f=>String(f.id)===String(r))||e.find(f=>String(f.id)===String(r));if(!c){me("Appuntamento non trovato");return}if(window.BP&&BP.ICS&&typeof BP.ICS.downloadIcsForAppointment=="function")if(BP.ICS.downloadIcsForAppointment(c)){typeof haptic=="function"&&haptic("medium");try{document.dispatchEvent(new Event("ics:exported"))}catch(N){}me(".ics esportato")}else me("Export .ics non disponibile");else me("Export .ics non disponibile")})})}})(),(function(){var s=document.getElementById("lastApps");if(s){var w=e.filter(function(p){return h?String(p.userId||p.uid||"")===String(h):!0}).sort(function(p,d){return new Date(d.start)-new Date(p.start)}).slice(0,6);s.innerHTML=w.length?B(w.map(U).join("")):'<div class="muted">Nessun appuntamento</div>',s.querySelectorAll(".lastApp[data-aid]").forEach(function(p){p.addEventListener("click",function(){try{nt("bp_edit_aid",p.getAttribute("data-aid"))}catch(d){}ge()})}),s.querySelectorAll("button[data-ics]").forEach(function(p){p.addEventListener("click",function(d){d.stopPropagation();var u=p.getAttribute("data-ics"),n=w.find(o=>String(o.id)===String(u))||e.find(o=>String(o.id)===String(u));if(!n){me("Appuntamento non trovato");return}if(window.BP&&BP.ICS&&typeof BP.ICS.downloadIcsForAppointment=="function")if(BP.ICS.downloadIcsForAppointment(n)){typeof haptic=="function"&&haptic("medium");try{document.dispatchEvent(new Event("ics:exported"))}catch(r){}me(".ics esportato")}else me("Export .ics non disponibile");else me("Export .ics non disponibile")})})}})(),(function(){var s=document.getElementById("lastBPs");if(s){var w=i.filter(function(d){return!(String(d.type)!==String(T)||h&&String(d.userId||d.uid||"")!==String(h))}).sort(function(d,u){return new Date(u.endDate)-new Date(d.endDate)}).slice(0,3),p=w.map(function(d){var u=ut(d.type,d.startDate),n=d.indicatorsPrev||{},o=d.indicatorsCons||{},r=k(o),c=r?o:n,f=q(c.VSS),N=q(c.VSDPersonale),R=q(c.VSDIndiretto),te=q(c.GI),_=q(c.NNCF),j=N+R;return'<div class="card lastBP" data-pid="'+C(String(d.id||""))+'" style="cursor:pointer;flex:1 1 320px"><div style="display:flex;align-items:center;gap:8px"><div><b>'+C(u)+'</b></div><span class="chip small">'+(r?"Consuntivo":"Previsionale")+'</span></div><div class="row" style="margin-top:6px;gap:8px;flex-wrap:wrap"><span class="chip small">VSS <b>'+b(f)+'</b></span><span class="chip small">VSD <b>'+b(j)+'</b> <span class="muted">(P '+b(N)+" · I "+b(R)+')</span></span><span class="chip small">GI <b>'+b(te)+'</b></span><span class="chip small">NNCF <b>'+G(_)+"</b></span></div></div>"}).join("");s.innerHTML=p?B(p):'<div class="muted">Nessun BP</div>',s.querySelectorAll(".lastBP[data-pid]").forEach(function(d){d.addEventListener("click",function(){try{nt("bp_open_period",{id:d.getAttribute("data-pid"),mode:!1})}catch(u){}he()})})}})()}).catch(function(a){logger.error(a)})}H("dash",function(){typeof haptic=="function"&&haptic("light"),y(),E(),$()});var I=document.getElementById("dash_mode");I&&(I.onchange=function(){typeof haptic=="function"&&haptic("light"),y(),E(),$()});var v=document.getElementById("dash_cons");v&&(v.onchange=function(){typeof haptic=="function"&&haptic("light"),y(),E(),$()}),y(),E(),$(),typeof kickFinal=="function"&&kickFinal("dashboard")}function ee(){if(!Pe())return l();document.title="Battle Plan – Calendario";function g(v){return kt(v)}if(!document.getElementById("cal_dynamic_css")){var b="\n      /* ============== CALENDAR ============== */\n      #cal_container{ overflow-x:auto; -webkit-overflow-scrolling:touch; }\n      #cal_container .calendar{ min-width: 860px; }\n\n      .calendar{ display:grid; grid-template-columns: 44px repeat(7, 1fr); gap:10px; }\n      .calendar .weekLabel{ color:var(--muted); font-size:12px; display:flex; align-items:center; justify-content:center; }\n\n      .calendar .day{\n        min-height:120px; background: var(--card);\n        border:2px solid var(--hair2); border-radius:14px; padding:8px;\n        display:flex; flex-direction:column; gap:3px; overflow:hidden;\n      }\n      .calendar .day.today{\n        outline: 2px solid var(--accent);\n        box-shadow: 0 0 0 2px rgba(0,0,0,.06) inset;\n      }\n      .calendar .day .dnum{ font-weight:800; }\n      .calendar .day .small{\n        font-size:12px; line-height:1.15;\n        white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:100%;\n      }\n      .calendar .day .tag{ padding:2px 6px; border-radius:999px; border:1px solid var(--hair2); font-size:11px; align-self:flex-start; }\n      .calendar .day.busy0{ border-color:#27ae60; background:rgba(39,174,96,.08); }\n      .calendar .day.busy1{ border-color:#ff9f1a; background:rgba(255,159,26,.10); }\n      .calendar .day.busy2{ border-color:#7d1731; background:rgba(125,23,49,.12); }\n      .calendar .day.dense .small{ font-size:11px; line-height:1.1; }\n      .calendar .day.dense .tag{ transform:scale(.9); transform-origin:left top; }\n\n      @media (max-width: 900px){\n        .calendar{ grid-template-columns: 36px repeat(7, 1fr); }\n        .calendar .weekLabel{ display:flex !important; font-size:11px; }\n        .calendar .day{ min-height:92px; padding:6px; }\n        .calendar .day .dnum{ font-size:16px; }\n        .calendar .day .small{ white-space: normal !important; overflow: visible !important; text-overflow: clip !important; }\n        .calendar .day.dense .small{ font-size:clamp(9px,2.4vw,11px); }\n        .calendar .day .tag{ font-size:10px; }\n      }\n\n      .cal-filters .chip{\n        display:inline-flex; align-items:center; gap:6px;\n        padding:6px 10px; border-radius:999px; border:1px solid var(--hair2);\n      }\n    ",G=document.createElement("style");G.id="cal_dynamic_css",G.textContent=b,document.head.appendChild(G)}var C=new Date,z=He(It(C)).slice(0,7);m.innerHTML=We()+'<div class="wrap"><div class="card"><div class="row" style="align-items:flex-end;gap:12px;flex-wrap:wrap"><div class="row" style="align-items:flex-end;gap:8px"><button id="cal_prev" class="ghost" title="Mese precedente">◀</button><div><label>Mese</label><input type="month" id="cal_month" value="'+z+'"></div><button id="cal_next" class="ghost" title="Mese successivo">▶</button></div><div><label>Consulente</label><select id="cal_consultant"></select></div><div class="cal-filters"><label class="chip small"><input type="checkbox" id="only_free"> Solo giorni liberi</label> <label class="chip small"><input type="checkbox" id="only_4h"> Solo slot ≥ 4h</label></div><button id="cal_add" class="ghost">Aggiungi appuntamento</button><div class="right" style="margin-left:auto"><button id="cal_refresh" class="ghost">Aggiorna</button></div></div></div><div id="cal_container"></div><div id="cal_results" class="card" style="margin-top:8px;display:none"></div><div id="cal_day_box" class="card" style="margin-top:8px;display:none"></div><div class="card" id="cal_free_slots" style="margin-top:8px;display:none"></div></div>',qe();var L=document.getElementById("cal_consultant");function A(){var v=Pe()||{};L.innerHTML='<option value="'+Te(v.id||"")+'">'+Te(v.name||"")+"</option>",Ie("/api/users").then(function(h){for(var P=h.users||[],T='<option value="all">Tutti</option>',B=0;B<P.length;B++){var x=P[B];T+='<option value="'+Te(x.id)+'">'+Te(x.name||x.email||x.id)+"</option>"}L.innerHTML=T,L.value=v.id}).catch(function(){L.innerHTML='<option value="'+Te(v.id||"")+'">'+Te(v.name||"")+"</option>"})}A();function M(v,h,P,T){var B="/api/appointments",x="/api/availability?from="+v+"-"+Ke(h)+"-01&to="+v+"-"+Ke(h)+"-"+Ke(new Date(v,h,0).getDate());T==="all"?(B+="?global=1",x+="&global=1"):T&&T!==Pe().id&&(B+="?user="+T,x+="&user="+T),Promise.all([Ie(B),Ie(x)]).then(function(U){var k=U[0]&&U[0].appointments?U[0].appointments:[],q=U[1]||{slots:[]},le=q.slots||[],a=new Date(v,h-1,1),e=new Date(v,h,0,23,59,59,999);function i(xe,Fe){for(var Ae={vss:0,vsd:0,vsdI:0,telefonate:0,appFissati:0,nncf:0,count:0},Le=0;Le<k.length;Le++){var Me=k[Le],Ye=new Date(Me.start);Ye>=xe&&Ye<=Fe&&(Ae.vss+=Number(Me.vss||0),Ae.vsd+=Number(Me.vsdPersonal||0),Ae.vsdI+=Number(Me.vsdIndiretto||0),Ae.telefonate+=Number(Me.telefonate||0),Ae.appFissati+=Number(Me.appFissati||0),Ae.nncf+=Me.nncf?1:0,Ae.count+=1)}return Ae}function t(xe,Fe,Ae){var Le=document.getElementById("cal_results");if(Le){var Me=Ae?'<div class="right"><button id="res_reset" class="ghost">Torna al mese</button></div>':"";if(Le.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center"><b>Risultati · '+Fe+"</b>"+Me+'</div><div class="row" style="margin-top:8px;gap:8px;flex-wrap:wrap"><span class="chip small">VSS <b>'+et(xe.vss)+'</b></span><span class="chip small">VSD <b>'+et(xe.vsd)+'</b></span><span class="chip small">VSD ind <b>'+et(xe.vsdI)+'</b></span><span class="chip small">Tel <b>'+je(xe.telefonate)+'</b></span><span class="chip small">AppFiss <b>'+je(xe.appFissati)+'</b></span><span class="chip small">NNCF <b>'+je(xe.nncf)+'</b></span><span class="chip small">N. app <b>'+je(xe.count)+"</b></span></div>",Le.style.display="block",Ae){var Ye=document.getElementById("res_reset");Ye&&(Ye.onclick=function(){t(i(a,e),o,!1)})}}}for(var s={},w=0;w<k.length;w++){var p=k[w],d=new Date(p.start);if(!(d<a||d>e)){var u=He(d);s[u]||(s[u]={vss:0,vsd:0,vsdI:0,telefonate:0,appFissati:0,nncf:0,mins:0,count:0,items:[]}),s[u].vss+=Number(p.vss||0),s[u].vsd+=Number(p.vsdPersonal||0),s[u].vsdI+=Number(p.vsdIndiretto||0),s[u].telefonate+=Number(p.telefonate||0),s[u].appFissati+=Number(p.appFissati||0),s[u].nncf+=p.nncf?1:0,s[u].mins+=Number(p.durationMinutes||0),s[u].count+=1,s[u].items.push(p)}}var n=["Lun","Mar","Mer","Gio","Ven","Sab","Dom"],o=new Date(v,h-1,1).toLocaleString("it-IT",{month:"long",year:"numeric"}),r='<div class="card"><b class="neon">'+o+"</b></div>";r+='<div class="calendar">',r+='<div class="weekLabel">W</div>';for(var c=0;c<7;c++)r+='<div class="weekLabel">'+n[c]+"</div>";var f=new Date(v,h-1,1),N=(f.getDay()+6)%7,R=new Date(f);R.setDate(f.getDate()-N);for(var te=0;te<6;te++){var _=new Date(R),j="W"+Ve(_);r+='<div class="weekLabel" data-ws="'+He(_)+'" style="cursor:pointer">'+j+"</div>";for(var ne=0;ne<7;ne++){var W=R.getMonth()===h-1,u=He(R),Z=s[u]||{vss:0,vsd:0,vsdI:0,telefonate:0,appFissati:0,nncf:0,mins:0,count:0,items:[]},ue=R.getDay(),ce=ue===0||ue===6,ye=!ce&&le.some(function(Fe){return Fe.date===u});if(W&&P){if(P.only_free&&Z.count>0){r+="<div></div>",R.setDate(R.getDate()+1);continue}if(P.only_4h&&!ye){r+="<div></div>",R.setDate(R.getDate()+1);continue}}if(!W)r+="<div></div>";else{var _e="";ce?Z.count>0&&(_e="busy2"):Z.count===0?_e="busy0":ye?_e="busy1":_e="busy2";var Be="",ke=0;ce&&Z.count===0||(Z.vss>0&&(Be+='<div class="small">VSS '+et(Z.vss)+"</div>",ke++),Z.vsd>0&&(Be+='<div class="small">VSD '+et(Z.vsd)+"</div>",ke++),Z.vsdI>0&&(Be+='<div class="small">VSD ind '+et(Z.vsdI)+"</div>",ke++),Z.telefonate>0&&(Be+='<div class="small">Tel '+je(Z.telefonate)+"</div>",ke++),Z.appFissati>0&&(Be+='<div class="small">AppFiss '+je(Z.appFissati)+"</div>",ke++),Z.nncf>0&&(Be+='<div class="small">NNCF '+je(Z.nncf)+"</div>",ke++),Z.count>0&&(Be+='<div class="small">App. '+je(Z.count)+"</div>",ke++),ye&&(Be+='<div class="tag" style="margin-top:4px">slot ≥4h</div>',ke++));var yt=ke>=3?" dense":"",F=ye?" slot-free":"";r+='<div class="day '+_e+yt+F+'" data-day="'+u+'" title="Settimana '+Ve(R)+'"><div class="dnum">'+R.getDate()+"</div>"+(Be||"")+"</div>"}R.setDate(R.getDate()+1)}}r+="</div>",document.getElementById("cal_container").innerHTML=r,t(i(a,e),o,!1),document.querySelectorAll(".calendar .weekLabel[data-ws]").forEach(function(xe){xe.addEventListener("click",function(){var Fe=xe.getAttribute("data-ws"),Ae=new Date(Fe),Le=new Date(Ae);Le.setDate(Le.getDate()+6),Le.setHours(23,59,59,999);var Me="Settimana "+("W"+Ve(Ae))+" · "+ct(Ae)+"–"+ct(Le);t(i(Ae,Le),Me,!0)})}),document.querySelectorAll(".day[data-day]").forEach(function(xe){xe.addEventListener("click",function(){var Fe=xe.getAttribute("data-day"),Ae=s[Fe]&&s[Fe].items?s[Fe].items.slice():[];Ae.sort(function(Je,it){return new Date(Je.start)-new Date(it.start)});var Le=document.getElementById("cal_day_box"),Me="<b>Appuntamenti del "+Fe.split("-").reverse().join("/")+"</b>";if(!Ae.length)Me+='<div class="muted" style="margin-top:6px">Nessun appuntamento</div>';else{Me+='<div class="row" style="margin-top:8px">';for(var Ye=0;Ye<Ae.length;Ye++){var Oe=Ae[Ye],bt=' data-start="'+Oe.start+'" data-end="'+Oe.end+'" data-title="'+Te(Oe.client||"Appuntamento")+'" ',rt=String(Oe.type||"").toLowerCase(),tt;rt.indexOf("mbs")>-1?tt="VSD ind "+et(Oe.vsdIndiretto||0):rt.indexOf("sottoprod")>-1?tt="Tel "+je(Oe.telefonate||0)+" · AppFissati "+je(Oe.appFissati||0):rt.indexOf("formaz")>-1?tt="":tt="VSS "+et(Oe.vss)+" · VSD "+et(Oe.vsdPersonal)+" · NNCF "+(Oe.nncf?"✅":"—"),Me+='<div class="card cal-app" data-aid="'+Oe.id+'" '+bt+' style="flex:1 1 320px;cursor:pointer"><div class="small muted">'+g(Oe.start)+"–"+g(Oe.end)+" · "+Te(Oe.type||"")+"</div><div><b>"+Te(Oe.client||"")+"</b></div>"+(tt?'<div class="small">'+tt+"</div>":"")+(Oe.notes?'<div class="small muted">'+Te(Oe.notes)+"</div>":"")+"</div>"}Me+="</div>"}var st=(le||[]).filter(function(Je){return Je.date===Fe});if(st.length){Me+='<div class="row" style="margin-top:8px">';for(var lt=0;lt<st.length;lt++){var at=st[lt],_t=at.part==="morning"?"mattina":"pomeriggio";Me+='<div class="card slotBtn" data-start="'+at.start+'" data-end="'+at.end+'" style="flex:1 1 280px;cursor:pointer"><div class="small">'+_t+" · "+g(at.start)+"–"+g(at.end)+"</div></div>"}Me+="</div>"}if(Le.style.display="block",Le.innerHTML=Me,Le.querySelectorAll(".cal-app").forEach(function(Je){Je.addEventListener("click",function(it){it.stopPropagation(),nt("bp_edit_aid",Je.getAttribute("data-aid")),ge()})}),Le.querySelectorAll(".slotBtn").forEach(function(Je){Je.addEventListener("click",function(it){it.stopPropagation(),nt("bp_prefill_slot",{start:Je.getAttribute("data-start"),end:Je.getAttribute("data-end")}),ge(),me("Slot precompilato negli appuntamenti")})}),window.scrollTo({top:Le.getBoundingClientRect().top+window.scrollY-80,behavior:"smooth"}),typeof window.wireICSInsideDayBox=="function")try{window.wireICSInsideDayBox()}catch(Je){}})});var O=document.getElementById("cal_free_slots"),ae=(function(){var xe=new Date;return xe.getFullYear()+"-"+Ke(xe.getMonth()+1)+"-"+Ke(xe.getDate())})(),Q=(le||[]).filter(function(xe){return String(xe.date||"").slice(0,10)>=ae});if(T==="all"){var se=q.details||[],we="<b>Slot liberi ≥ 4h per consulente</b>";we+='<div class="row" style="margin-top:8px;gap:8px;flex-wrap:wrap">';for(var fe=0;fe<se.length;fe++){var R=se[fe];we+='<span class="chip small">'+Te(R.name||"")+" <b>"+je(R.total||0)+"</b></span>"}we+="</div>",O.style.display="block",O.innerHTML=we}else if(Q.length){var Ee='<b>Slot liberi ≥ 4h (da oggi in poi)</b> · <span class="badge">Tot: '+Q.length+"</span>";Ee+='<div class="row" style="margin-top:8px">';for(var Se=0;Se<Q.length&&Se<80;Se++){var d=Q[Se],Ne=d.part==="morning"?"mattina":"pomeriggio";Ee+='<div class="card slotBtn" data-start="'+d.start+'" data-end="'+d.end+'" style="flex:1 1 280px;cursor:pointer"><div class="small"><b>'+ct(d.start)+"</b> · "+Ne+'</div><div class="small">'+g(d.start)+"–"+g(d.end)+"</div></div>"}Ee+="</div>",O.style.display="block",O.innerHTML=Ee,O.querySelectorAll(".slotBtn").forEach(function(xe){xe.addEventListener("click",function(){nt("bp_prefill_slot",{start:xe.getAttribute("data-start"),end:xe.getAttribute("data-end")}),ge(),me("Slot precompilato negli appuntamenti")})})}else O.style.display="block",O.innerHTML='<b>Slot liberi ≥ 4h (da oggi in poi)</b> · <span class="badge">Tot: 0</span><div class="muted" style="margin-top:6px">Nessuno slot libero disponibile.</div>';try{window.injectTodayCSS&&window.injectTodayCSS()}catch(xe){}try{window.hookCalendar?window.hookCalendar():(window.markToday&&window.markToday(),window.clampSlotCounters&&window.clampSlotCounters())}catch(xe){}}).catch(function(U){logger.error(U),me("Errore calendario")})}function S(){var v=document.getElementById("cal_month").value,h=parseInt(v.split("-")[0],10),P=parseInt(v.split("-")[1],10),T={only_free:document.getElementById("only_free").checked,only_4h:document.getElementById("only_4h").checked},B=document.getElementById("cal_consultant").value;M(h,P,T,B)}document.getElementById("cal_refresh").onclick=S;var y=document.getElementById("cal_add");y&&(y.onclick=function(){ge()}),document.getElementById("cal_month").onchange=S;function E(v){var h=document.getElementById("cal_month");if(h){var P=h.value.split("-"),T=+P[0],B=+P[1];B+=v,B<=0?(B=12,T--):B>12&&(B=1,T++),h.value=T+"-"+Ke(B),S()}}var $=document.getElementById("cal_prev"),I=document.getElementById("cal_next");$&&($.onclick=function(){E(-1)}),I&&(I.onclick=function(){E(1)}),document.getElementById("only_free").onchange=S,document.getElementById("only_4h").onchange=S,L.onchange=S,S()}function he(){if(!Pe())return l();document.title="Battle Plan – BP",m.innerHTML=We()+'<div class="wrap"><div class="card"><b>Da inviare</b><div id="bp_to_send" class="grid" style="margin-top:8px"></div></div><div class="card" id="bp_sent_box" style="margin-top:8px"><div id="bp_sent_head" style="display:flex;align-items:center;justify-content:space-between;cursor:pointer"><b>BP inviati (periodi in essere)</b><span id="bp_sent_chev" class="chev">▸</span></div><div id="bp_sent" class="row" style="margin-top:8px;display:none"></div></div><div class="card" style="margin-top:8px"><b>Crea/Aggiorna BP</b><div class="row" style="margin-top:8px"><div><label>Tipo</label><select id="p_type"><option value="settimanale">Settimanale (lun–dom)</option><option value="mensile">Mensile</option><option value="trimestrale">Trimestrale</option><option value="semestrale">Semestrale</option><option value="annuale">Annuale</option></select></div><div id="wrap_week" style="display:none"><label>Settimana ISO (1–53)</label><input type="number" id="p_week" min="1" max="53" value="'+Ve(new Date)+'"></div><div id="wrap_month" style="display:none"><label>Mese</label><select id="p_month"><option value="1">Gennaio</option><option value="2">Febbraio</option><option value="3">Marzo</option><option value="4">Aprile</option><option value="5">Maggio</option><option value="6">Giugno</option><option value="7">Luglio</option><option value="8">Agosto</option><option value="9">Settembre</option><option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option></select></div><div id="wrap_quarter" style="display:none"><label>Trimestre</label><select id="p_quarter"><option value="1">T1</option><option value="2">T2</option><option value="3">T3</option><option value="4">T4</option></select></div><div id="wrap_semester" style="display:none"><label>Semestre</label><select id="p_sem"><option value="1">1° semestre</option><option value="2">2° semestre</option></select></div><div><label>Anno</label><input type="number" id="p_year" min="2000" max="2100" value="'+new Date().getFullYear()+'"></div></div><div class="row"><div class="small muted">Modalità: <b id="p_mode_lbl">Previsionale</b> · <button class="ghost" id="btnImport" style="padding:4px 8px">Importa da agenda</button></div></div><div class="row" style="align-items:center"><div class="small"><b>Periodo selezionato:</b> <span id="p_label" class="neon">—</span></div><input type="hidden" id="p_start"><input type="hidden" id="p_end"></div><div class="row small" style="margin-top:6px;opacity:.9"><div><b>Previsionale</b></div><div><b>Consuntivo</b></div><div><b>Avanzamento</b></div></div><div class="row" id="p_rows" style="margin-top:4px"></div><div class="row" style="margin-top:8px;align-items:center;gap:8px;justify-content:space-between"><div id="p_delete_zone"></div><div class="right"><button id="btnSaveP">Salva BP</button></div></div></div><div class="card"><b>BP salvati</b><div id="p_list" class="row" style="margin-top:8px"></div></div></div>',qe();var g=!1,b=null,G=[],C=null,z=Pe()||{};function L(F){return String(F).replace(/[&<>'"]/g,O=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[O])}function A(F){if(!F)return"";var O=new Date(F);return O.getFullYear()+"-"+("0"+(O.getMonth()+1)).slice(-2)+"-"+("0"+O.getDate()).slice(-2)}function M(F){var O=new Date(F);return("0"+O.getDate()).slice(-2)+"/"+("0"+(O.getMonth()+1)).slice(-2)+"/"+O.getFullYear()}function S(F){var O=Number(F)||0;return O.toLocaleString("it-IT")+"€"}function y(F){var O=document.createElement("div");return O.innerHTML=F.trim(),O.firstChild}function E(F){return!!(F&&F.indicatorsCons&&Object.keys(F.indicatorsCons).length>0)}function $(){return z&&z.grade?Promise.resolve(z):Ie("/api/usernames").then(function(F){var O=String((Pe()||{}).id||""),ae=(F&&F.users||[]).find(function(Q){return String(Q.id)===O});return ae&&ae.grade&&(z.grade=ae.grade),z}).catch(function(){return z})}function I(){var F=z&&z.grade||(Pe()||{}).grade;return F==="senior"?"senior":"junior"}$();var v=document.getElementById("p_type"),h=document.getElementById("p_year"),P=document.getElementById("wrap_week"),T=document.getElementById("wrap_month"),B=document.getElementById("wrap_quarter"),x=document.getElementById("wrap_semester"),U=document.getElementById("p_week"),k=document.getElementById("p_month"),q=document.getElementById("p_quarter"),le=document.getElementById("p_sem"),a=document.getElementById("p_label"),e=document.getElementById("p_start"),i=document.getElementById("p_end"),t=document.getElementById("p_mode_lbl"),s=document.getElementById("btnImport");function w(F){g=!!F,t.textContent=g?"Consuntivo":"Previsionale",s.style.display=g?"none":"";var O=document.querySelectorAll("[data-row]");O.forEach(function(ae){var Q=ae.querySelector("[data-prev]"),se=ae.querySelector("[data-cons]"),we=ae.querySelector("[data-bar]");if(g){if(Q){Q.removeAttribute("hidden");var fe=Q.querySelector("input");fe&&(fe.setAttribute("readonly","readonly"),fe.classList.add("disabled"))}if(se){se.removeAttribute("hidden");var Ee=se.querySelector("input");Ee&&(Ee.removeAttribute("readonly"),Ee.classList.remove("disabled"))}we&&we.removeAttribute("hidden")}else{if(Q){Q.removeAttribute("hidden");var Se=Q.querySelector("input");Se&&(Se.removeAttribute("readonly"),Se.classList.remove("disabled"))}se&&se.setAttribute("hidden","hidden"),we&&we.setAttribute("hidden","hidden")}}),W()}function p(){var F=v.value;P.style.display=F==="settimanale"?"":"none",T.style.display=F==="mensile"?"":"none",B.style.display=F==="trimestrale"?"":"none",x.style.display=F==="semestrale"?"":"none",d()}function d(){var F=v.value,O=parseInt(h.value,10),ae,Q,se;if(F==="settimanale"){var we=Math.max(1,Math.min(53,parseInt(U.value||"1",10))),fe=ot(O,we);ae=fe.start,Q=fe.end,se="Sett. "+we+" · "+M(ae)+" → "+M(Q)}else if(F==="mensile"){var Ee=parseInt(k.value,10);ae=new Date(O,Ee-1,1),Q=new Date(O,Ee,0),se=ae.toLocaleString("it-IT",{month:"long",year:"numeric"})+" · "+M(ae)+" → "+M(Q)}else if(F==="trimestrale"){var Se=parseInt(q.value,10);ae=new Date(O,(Se-1)*3,1),Q=new Date(O,Se*3,0),se="Trimestre "+Se+" "+O+" · "+M(ae)+" → "+M(Q)}else if(F==="semestrale"){var Ne=parseInt(le.value,10);ae=new Date(O,Ne===1?0:6,1),Q=new Date(O,Ne===1?6:12,0),se=(Ne===1?"1°":"2°")+" semestre "+O+" · "+M(ae)+" → "+M(Q)}else ae=new Date(O,0,1),Q=new Date(O,11,31),se="Anno "+O+" · "+M(ae)+" → "+M(Q);e.value=A(ae),i.value=A(Q),a.textContent=se,w(!1),b=null,C=null,c(),W()}function u(F){for(var O="",ae=0;ae<F.length;ae++){var Q=F[ae],se=/^(VSS|VSDPersonale|VSDIndiretto|GI)$/i.test(Q);O+='<div class="row" data-row="'+Q+'"><div data-prev><label>'+Q+' (Prev)</label><input type="number" step="1" id="prev_'+Q+'" placeholder="'+(se?"€":"n")+'"></div><div data-cons><label>'+Q+' (Cons)</label><input type="number" step="1" id="cons_'+Q+'" placeholder="'+(se?"€":"n")+'"></div><div data-bar class="small"><div style="height:10px;background:rgba(255,255,255,.12);border-radius:999px;overflow:hidden"><div id="bar_'+Q+'" style="height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2));"></div></div><div id="pct_'+Q+'" class="small muted">0%</div></div></div>'}document.getElementById("p_rows").innerHTML=O,w(!1),o(),n()}function n(){for(var F=0;F<G.length;F++){var O=G[F],ae=document.getElementById("prev_"+O),Q=document.getElementById("cons_"+O);if(!(!ae||!Q)){var se=Number(ae.value||0),we=Number(Q.value||0),fe=se>0?Math.round(we/se*100):we>0?100:0;fe=Math.max(0,Math.min(200,fe));var Ee=document.getElementById("bar_"+O),Se=document.getElementById("pct_"+O);Ee&&(Ee.style.width=Math.min(fe,100)+"%"),Se&&(Se.textContent=fe+"%")}}}function o(){for(var F=0;F<G.length;F++)(function(O){var ae=document.getElementById("prev_"+O),Q=document.getElementById("cons_"+O);ae&&(ae.oninput=n),Q&&(Q.oninput=n)})(G[F])}function r(){for(var F=0;F<G.length;F++){var O=document.getElementById("prev_"+G[F]);O&&(O.value="")}n()}function c(){for(var F=0;F<G.length;F++){var O=document.getElementById("cons_"+G[F]);O&&(O.value="")}n()}function f(F){for(var O in F){var ae=document.getElementById("prev_"+O);ae&&(ae.value=String(F[O]||0))}n()}function N(F){for(var O in F){var ae=document.getElementById("cons_"+O);ae&&(ae.value=String(F[O]||0))}n()}function R(){if(!g){var F=e.value,O=i.value;if(!F||!O){me("Seleziona il periodo");return}Ie("/api/appointments").then(function(ae){for(var Q=ae.appointments||[],se=new Date(F),we=new Date(O),fe={VSS:0,VSDPersonale:0,VSDIndiretto:0,GI:0,Telefonate:0,AppFissati:0,AppFatti:0,CorsiLeadership:0,iProfile:0,MBS:0,NNCF:0},Ee=0;Ee<Q.length;Ee++){var Se=Q[Ee],Ne=new Date(Se.start);Ne>=se&&Ne<=we&&(fe.VSS+=Number(Se.vss||0),fe.VSDPersonale+=Number(Se.vsdPersonal||0),fe.VSDIndiretto+=Number(Se.vsdIndiretto||0),fe.Telefonate+=Number(Se.telefonate||0),fe.AppFissati+=Number(Se.appFissati||0),Se.nncf&&(fe.AppFatti+=1,fe.NNCF+=1))}f(fe),me("Previsionale compilato dalla tua agenda"),pt(),window.addXP(10)}).catch(function(){me("Errore import agenda")})}}function te(F,O){F=Object.assign({},F||{});var ae=Number(F.GI||0),Q=Number(F.VSDPersonale||0),se=ae*.15,we=Q*(String(O)==="senior"?.25:.2);return F.ProvvGI=Math.round(se*100)/100,F.ProvvVSD=Math.round(we*100)/100,F.TotProvvigioni=Math.round((F.ProvvGI+F.ProvvVSD)*100)/100,F}function _(F,O,ae){return fetch(O,{method:F,headers:ae?{"Content-Type":"application/json"}:void 0,body:ae?JSON.stringify(ae):void 0}).then(function(Q){return Q.ok?Q.json().catch(function(){return{}}):Promise.reject(new Error("HTTP "+Q.status))})}function j(F){for(var O=encodeURIComponent(F),ae=[function(){return _("POST","/api/periods/delete",{id:F})},function(){return _("POST","/api/periods",{id:F,_delete:!0})},function(){return _("POST","/api/periods/"+O,{_method:"DELETE"})},function(){return _("DELETE","/api/periods/"+O,null)},function(){return _("DELETE","/api/periods?id="+O,null)}],Q=Promise.reject(new Error("start")),se=0;se<ae.length;se++)(function(we){Q=Q.catch(we)})(ae[se]);return Q.catch(function(we){throw logger.warn("Delete fallback: tutte le route fallite",we),we})}function ne(F){return C?{id:b||C.id,type:C.type,startDate:A(C.startDate),endDate:A(C.endDate),indicatorsPrev:Object.assign({},C.indicatorsPrev||{}),indicatorsCons:F!=null?F:Object.assign({},C.indicatorsCons||{})}:null}function W(){var F=document.getElementById("p_delete_zone");if(F){if(!b){F.innerHTML="";return}var O=!!(C&&E(C)),ae="";O&&(ae+='<button id="btnDelCons" class="ghost" style="border-color:#7d1731;color:#7d1731">Elimina Consuntivo</button> '),ae+='<button id="btnDelBP" class="ghost" style="border-color:#7d1731;color:#7d1731">Elimina BP</button>',F.innerHTML=ae;var Q=document.getElementById("btnDelBP");Q&&(Q.onclick=function(){if(confirm("Eliminare definitivamente questo BP?")){Q.disabled=!0;var we=C?JSON.parse(JSON.stringify(C)):null;j(b).then(function(){me("BP eliminato");try{document.dispatchEvent(new Event("bp:deleted"))}catch(Ee){}if(b=null,C=null,r(),c(),w(!1),d(),ue(),typeof showUndo=="function"&&we){var fe={type:we.type,startDate:A(we.startDate),endDate:A(we.endDate),indicatorsPrev:Object.assign({},we.indicatorsPrev||{}),indicatorsCons:Object.assign({},we.indicatorsCons||{})};showUndo("BP eliminato",function(){return $e("/api/periods",fe).then(function(){try{document.dispatchEvent(new Event("bp:saved"))}catch(Ee){}ue()})},5e3)}}).catch(function(){me("Endpoint delete non disponibile")}).finally(function(){Q.disabled=!1})}});var se=document.getElementById("btnDelCons");se&&(se.onclick=function(){if(confirm("Rimuovere solo il Consuntivo?")){se.disabled=!0;var we=C?JSON.parse(JSON.stringify(C.indicatorsCons||{})):null,fe=ne({});if(!fe){se.disabled=!1;return}var Ee=I();fe.indicatorsPrev=te(fe.indicatorsPrev,Ee),fe.indicatorsCons={},$e("/api/periods",fe).then(function(){me("Consuntivo eliminato");try{document.dispatchEvent(new Event("bp:saved"))}catch(Ne){}if(C&&(C.indicatorsCons={}),w(!0),ue(),W(),typeof showUndo=="function"&&we){var Se=ne(we);showUndo("Consuntivo eliminato",function(){return $e("/api/periods",Se).then(function(){try{document.dispatchEvent(new Event("bp:saved"))}catch(Ne){}C&&(C.indicatorsCons=we),ue(),W()})},5e3)}}).catch(function(){me("Errore eliminazione Consuntivo")}).finally(function(){se.disabled=!1})}})}}function Z(){var F=v.value,O=e.value,ae=i.value;if(!O||!ae){me("Seleziona il periodo");return}for(var Q={},se={},we=0;we<G.length;we++){var fe=G[we];Q[fe]=Number(document.getElementById("prev_"+fe).value||0),g&&(se[fe]=Number(document.getElementById("cons_"+fe).value||0))}var Ee=I();Q=te(Q,Ee),g&&(se=te(se,Ee));var Se={type:F,startDate:O,endDate:ae,indicatorsPrev:Q};g&&(Se.indicatorsCons=se),b&&(Se.id=b),$e("/api/periods",Se).then(function(Ne){me("BP salvato"),g?window.addXP(20):window.addXP(10),pt();try{document.dispatchEvent(new Event("bp:saved"))}catch(xe){}ue(),!b&&Ne&&Ne.id&&(b=Ne.id),b&&C&&(C.indicatorsPrev=Q,g&&(C.indicatorsCons=se)),W()}).catch(function(){me("Errore salvataggio BP")})}function ue(){Ie("/api/periods").then(function(F){var O=F.periods||[];O.sort(function(Se,Ne){return new Date(Ne.startDate)-new Date(Se.startDate)});for(var ae="",Q=0;Q<O.length;Q++){var se=O[Q],we=ut(se.type,se.startDate)+" · "+M(se.startDate)+" → "+M(se.endDate);ae+='<div class="card" style="flex:1 1 360px"><div><b>'+L(we)+'</b></div><div class="small">Prev VSS '+S((se.indicatorsPrev||{}).VSS||0)+" · Cons "+S((se.indicatorsCons||{}).VSS||0)+'</div><div class="right" style="margin-top:6px"><button class="ghost" data-edit="'+se.id+'">Modifica previs.</button><button data-cons="'+se.id+'">Consuntivo…</button></div></div>'}document.getElementById("p_list").innerHTML=ae||'<div class="muted">Nessun BP</div>',document.querySelectorAll("[data-edit]").forEach(function(Se){Se.addEventListener("click",function(){var Ne=Se.getAttribute("data-edit"),xe=(F.periods||[]).find(function(Fe){return Fe.id===Ne});xe&&ce(xe,!1)})}),document.querySelectorAll("[data-cons]").forEach(function(Se){Se.addEventListener("click",function(){var Ne=Se.getAttribute("data-cons"),xe=(F.periods||[]).find(function(Fe){return Fe.id===Ne});xe&&ce(xe,!0)})}),yt(O);var fe=mt("bp_open_period",null);if(fe){dt("bp_open_period");var Ee=O.find(function(Se){return Se.id===fe.id});Ee&&ce(Ee,fe.mode===!0)}})}function ce(F,O){C=F||null,v.value=F.type;var ae=new Date(F.startDate),Q=ae.getFullYear();if(h.value=String(Q),F.type==="settimanale")U.value=String(Ve(ae));else if(F.type==="mensile")k.value=String(ae.getMonth()+1);else if(F.type==="trimestrale"){var se=Math.floor(ae.getMonth()/3)+1;q.value=String(se)}else F.type==="semestrale"&&(le.value=ae.getMonth()<6?"1":"2");p(),r(),c(),f(F.indicatorsPrev||{}),N(F.indicatorsCons||{}),w(!!O),b=F.id||null,W(),me(O?"Compila il consuntivo":"Modifica previsionale"),window.scrollTo({top:0,behavior:"smooth"})}function ye(F,O){O=O||new Date;var ae=O.getFullYear();if(F==="settimanale"){var Q=ot(ae,Ve(O));return{start:Q.start,end:Q.end}}return F==="mensile"?{start:It(O),end:Ct(O)}:F==="trimestrale"?{start:gt(O),end:xt(O)}:F==="semestrale"?{start:ht(O),end:Et(O)}:{start:Tt(O),end:ft(O)}}function _e(F,O){return O=O||new Date,F==="settimanale"?$t(O):F==="mensile"?Wt(O):F==="trimestrale"?Jt(O):F==="semestrale"?Kt(O):Zt(O)}function Be(F){var O=ot(new Date().getFullYear(),Ve(new Date)),ae=O.start,Q=Math.floor((new Date(F)-ae)/(1e3*60*60*24));return Q<=13}function ke(F,O,ae,Q,se,we){var fe=ut(O,ae),Ee=y('<div class="card" style="position:relative"><div class="small muted">'+L(F)+"</div><div><b>"+L(fe)+'</b></div><div class="small muted">'+M(ae)+" → "+M(Q)+'</div><div class="right" style="margin-top:6px"><button class="ghost" type="button" data-sug="1">'+L(se)+"</button></div></div>");return Ee.querySelector("[data-sug]").addEventListener("click",we),Ee}function yt(F){var O=document.getElementById("bp_to_send"),ae=document.getElementById("bp_sent");O.innerHTML="",ae.innerHTML="";function Q(Ue,Ge,Re){return F.find(function(Qe){return Qe.type===Ue&&A(Qe.startDate)===A(Ge)&&A(Qe.endDate)===A(Re)})}var se=new Date,we=se.getDay(),fe=we===5||we===6||we===0,Ee=Ct(se),Se=xt(se),Ne=Et(se),xe=ft(se),Fe=fe&&Be(Ee),Ae=fe&&Be(Se),Le=fe&&Be(Ne),Me=fe&&Be(xe);["settimanale","mensile","trimestrale","semestrale","annuale"].forEach(function(Ue){var Ge=ye(Ue,se),Re=Q(Ue,Ge.start,Ge.end);if(Re){var Qe=y('<div class="card" style="flex:1 1 360px"><div><b>'+L(ut(Ue,Ge.start))+'</b></div><div class="small muted">'+M(Ge.start)+" → "+M(Ge.end)+'</div><div class="right" style="margin-top:6px"><button class="ghost" type="button" data-mid="'+Re.id+'">Modifica</button></div></div>');Qe.querySelector("[data-mid]").addEventListener("click",function(){ce(Re,!1)}),ae.appendChild(Qe)}});function Ye(Ue,Ge,Re){var Qe=Q(Ue,Re.start,Re.end),St=Q(Ue,Ge.start,Ge.end);Qe?O.appendChild(ke("Previsionale",Ue,Re.start,Re.end,"Modifica",function(){ce(Qe,!1)})):O.appendChild(ke("Previsionale",Ue,Re.start,Re.end,"Compila",function(){if(v.value=Ue,h.value=String(Re.start.getFullYear()),Ue==="settimanale")U.value=String(Ve(Re.start));else if(Ue==="mensile")k.value=String(Re.start.getMonth()+1);else if(Ue==="trimestrale"){var Lt=Math.floor(Re.start.getMonth()/3)+1;q.value=String(Lt)}else Ue==="semestrale"&&(le.value=Re.start.getMonth()<6?"1":"2");p()})),St&&!E(St)&&O.appendChild(ke("Consuntivo",Ue,Ge.start,Ge.end,"Consuntivo",function(){ce(St,!0)}))}if(fe){var Oe=ye("settimanale",se),bt=_e("settimanale",se);Ye("settimanale",Oe,bt)}if(Fe){var rt=ye("mensile",se),tt=_e("mensile",se);Ye("mensile",rt,tt)}if(Ae){var st=ye("trimestrale",se),lt=_e("trimestrale",se);Ye("trimestrale",st,lt)}if(Le){var at=ye("semestrale",se),_t=_e("semestrale",se);Ye("semestrale",at,_t)}if(Me){var Je=ye("annuale",se),it=_e("annuale",se);Ye("annuale",Je,it)}O.children.length||(O.innerHTML='<div class="muted">Nessun suggerimento attivo in questo momento</div>');var Nt=document.getElementById("bp_sent_head"),Mt=document.getElementById("bp_sent_chev");Nt.onclick=function(){var Ue=document.getElementById("bp_sent"),Ge=Ue.style.display!=="none";Ue.style.display=Ge?"none":"",Mt.textContent=Ge?"▸":"▾"}}Ie("/api/settings").then(function(F){G=F&&F.indicators||["VSS","VSDPersonale","VSDIndiretto","GI","Telefonate","AppFissati","AppFatti","CorsiLeadership","iProfile","MBS","NNCF"],u(G)}).catch(function(){G=["VSS","VSDPersonale","GI","NNCF"],u(G)}),v.onchange=p,h.oninput=d,U.oninput=d,k.onchange=d,q.onchange=d,le.onchange=d,s.onclick=R,document.getElementById("btnSaveP").onclick=Z,p(),ue()}function ge(){if(!Pe())return l();if(document.title="Battle Plan – Appuntamenti",!document.getElementById("appts_css")){const n=document.createElement("style");n.id="appts_css",n.textContent="\n      .appt-type .seg, #a_nncf.seg{\n        padding:8px 12px;border:1px solid #bcd7ff;border-radius:12px;\n        background:#eef5ff;color:#1463ff;cursor:pointer;user-select:none;\n        transition:.15s;\n      }\n      .appt-type .seg.active, #a_nncf.seg.active{\n        background:var(--accent);color:#fff;border-color:var(--accent);\n        box-shadow:0 0 0 2px rgba(20,99,255,.08) inset;\n      }\n      .appt-type > div{display:flex;flex-wrap:wrap;gap:8px;margin-top:4px}\n      .appt-row-end-dur{display:flex;gap:8px;align-items:flex-end}\n      #a_desc{width:100%;min-height:3.2em}\n      #a_list .grid3{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}\n    ",document.head.appendChild(n)}m.innerHTML=We()+'<div class="wrap"><div class="card"><b id="a_form_title">Nuovo appuntamento</b><div class="row" style="margin-top:8px;align-items:flex-end;gap:12px;flex-wrap:wrap"><div style="min-width:320px"><label>Cliente *</label><div style="display:flex;gap:8px;align-items:center"><input id="a_client" list="clientList" placeholder="Denominazione" style="flex:1"><datalist id="clientList"></datalist><button id="a_nncf" class="seg" data-active="0" aria-pressed="false">NNCF</button></div></div><div><label>Data/ora inizio</label><input id="a_start" type="datetime-local"></div><div class="appt-row-end-dur"><div><label>Ora fine</label><input id="a_end" type="time"></div><div><label>Durata (min)</label><input id="a_dur" type="number" placeholder="60" min="1" style="width:80px"></div></div></div><div style="margin-top:8px"><label>Descrizione appuntamento</label><textarea id="a_desc" rows="2" style="width:100%;min-height:3.2em"></textarea></div><div class="row" style="align-items:flex-end;gap:12px;flex-wrap:wrap"><div class="appt-type"><label>Tipo</label><div><button type="button" id="t_vendita" class="seg">Vendita</button><button type="button" id="t_mezza"   class="seg" data-vsd="1000">Mezza giornata</button><button type="button" id="t_full"    class="seg" data-vsd="2000">Giornata intera</button><button type="button" id="t_form"    class="seg">Formazione</button><button type="button" id="t_mbs"     class="seg">MBS</button><button type="button" id="t_sotto"   class="seg">Sottoprodotti</button></div><input id="a_type" type="hidden" value="vendita"></div><div id="row_vss"><label>VSS</label><input id="a_vss" type="number" step="1" placeholder="0"></div><div id="row_vsd_p"><label>VSD personale</label><input id="a_vsd" type="number" step="1" placeholder="0"></div><div id="row_vsd_i" style="display:none"><label>VSD indiretto</label><input id="a_vsd_i" type="number" step="1" placeholder="0"></div><div id="row_tel" style="display:none"><label>Telefonate</label><input id="a_tel" type="number" step="1" placeholder="0"></div><div id="row_app" style="display:none"><label>Appunt. fissati</label><input id="a_app" type="number" step="1" placeholder="0"></div></div><div class="row" style="margin-top:8px;gap:8px;align-items:center"><div><button id="btnSaveA">Salva</button></div><div><button id="btnSaveExportA" class="ghost">Salva ed esporta</button></div><div class="right" style="margin-left:auto"><button id="btnDeleteA" class="danger" style="display:none">Elimina</button></div></div></div><div class="card"><b>Elenco appuntamenti</b><div class="row" style="margin-top:8px;align-items:flex-end;gap:12px;flex-wrap:wrap"><div><label>Vista</label><select id="af_type"><option value="sett">Settimana</option><option value="mese">Mese</option></select></div><div id="af_week_wrap"><label>Settimana ISO</label><input id="af_week" type="number" min="1" max="53" value="'+Ve(new Date)+'"></div><div id="af_month_wrap" style="display:none"><label>Mese</label><select id="af_month"><option value="1">Gennaio</option><option value="2">Febbraio</option><option value="3">Marzo</option><option value="4">Aprile</option><option value="5">Maggio</option><option value="6">Giugno</option><option value="7">Luglio</option><option value="8">Agosto</option><option value="9">Settembre</option><option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option></select></div><div><label>Anno</label><input id="af_year" type="number" min="2000" max="2100" value="'+new Date().getFullYear()+'"></div><div class="right" style="margin-left:auto;display:flex;gap:8px"><button id="af_prev" class="ghost">◀</button><button id="af_next" class="ghost">▶</button></div></div><div id="a_list" style="margin-top:8px"></div></div></div>',qe();function g(n){return String(n).replace(/[&<>'"]/g,o=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[o])}function b(n){var o=Number(n)||0;return o.toLocaleString("it-IT")+"€"}function G(n){var o=new Date(n);return("0"+o.getDate()).slice(-2)+"/"+("0"+(o.getMonth()+1)).slice(-2)+"/"+o.getFullYear()}function C(n){if(!n)return"";const o=new Date(n);return isNaN(o)?"":o.toISOString()}function z(n){if(!n)return"";const o=new Date(n);return isNaN(o)?"":new Date(o.getTime()-o.getTimezoneOffset()*6e4).toISOString().slice(0,16)}function L(n){return n=String(n||"").toLowerCase(),n.indexOf("mezza")>-1?240:n.indexOf("giorn")>-1||n.indexOf("formaz")>-1||n.indexOf("mbs")>-1?570:n.indexOf("sottoprod")>-1?240:90}const A=document.getElementById("a_nncf");A.addEventListener("click",()=>{const n=A.getAttribute("data-active")!=="1";A.setAttribute("data-active",n?"1":"0"),A.setAttribute("aria-pressed",n?"true":"false"),A.classList.toggle("active",n),n&&h(document.getElementById("t_vendita"))});const M=document.getElementById("t_vendita"),S=document.getElementById("t_mezza"),y=document.getElementById("t_full"),E=document.getElementById("t_form"),$=document.getElementById("t_mbs"),I=document.getElementById("t_sotto"),v=[M,S,y,E,$,I];function h(n){v.forEach(_=>_.classList.toggle("active",_===n));const o=document.getElementById("a_type"),r=document.getElementById("a_client"),c=document.getElementById("row_vss"),f=document.getElementById("row_vsd_p"),N=document.getElementById("row_vsd_i"),R=document.getElementById("row_tel"),te=document.getElementById("row_app");document.getElementById("a_vss").value="",document.getElementById("a_vsd").value="",document.getElementById("a_vsd_i").value="",document.getElementById("a_tel").value="",document.getElementById("a_app").value="",c.style.display="",f.style.display="",N.style.display="none",R.style.display="none",te.style.display="none",r.disabled=!1,A.style.display="",A.setAttribute("data-active","0"),A.setAttribute("aria-pressed","false"),A.classList.remove("active"),(r.value==="Formazione"||r.value==="MBS"||r.value==="Sottoprodotti")&&(r.value=""),n===M?(o.value="vendita",P(90)):n===S?(o.value="mezza",P(240),document.getElementById("a_vsd").value="1000"):n===y?(o.value="giornata",P(570),document.getElementById("a_vsd").value="2000"):n===E?(o.value="formazione",P(570),r.value="Formazione",r.disabled=!0,c.style.display="none",f.style.display="none",A.style.display="none"):n===$?(o.value="MBS",P(570),r.value="MBS",r.disabled=!0,c.style.display="none",f.style.display="none",N.style.display="",document.getElementById("a_vsd_i").value="2000",A.style.display="none"):n===I&&(o.value="sottoprodotti",P(240),r.value="Sottoprodotti",r.disabled=!0,c.style.display="none",f.style.display="none",R.style.display="",te.style.display="",A.style.display="none")}function P(n){const o=document.getElementById("a_dur");o.value=String(n),T()}v.forEach(n=>n.addEventListener("click",o=>{o.preventDefault(),h(n)})),h(M);function T(){const n=document.getElementById("a_start").value,o=parseInt(document.getElementById("a_dur").value||"0",10);if(!n||!isFinite(o)||o<=0){document.getElementById("a_end").value="";return}const r=new Date(n),c=new Date(r.getTime()+o*6e4);document.getElementById("a_end").value=("0"+c.getHours()).slice(-2)+":"+("0"+c.getMinutes()).slice(-2)}function B(){const n=document.getElementById("a_start").value,o=document.getElementById("a_end").value;if(!n||!o)return;const r=new Date(n),c=o.split(":");if(c.length<2)return;const f=new Date(r);f.setHours(parseInt(c[0],10)||0,parseInt(c[1],10)||0,0,0),f<r&&f.setDate(f.getDate()+1);let N=Math.round((f-r)/6e4);document.getElementById("a_dur").value=String(Math.max(1,N))}document.getElementById("a_start").addEventListener("change",T),document.getElementById("a_dur").addEventListener("input",T),document.getElementById("a_end").addEventListener("change",B),Ie("/api/clients").then(n=>{const o=n&&n.clients||[],r=document.getElementById("clientList");r&&(r.innerHTML=o.map(c=>'<option value="'+g(c.name)+'"></option>').join(""))});let x=null;function U(){x=null,document.getElementById("a_form_title").textContent="Nuovo appuntamento",document.getElementById("a_client").value="",document.getElementById("a_start").value="",document.getElementById("a_end").value="",document.getElementById("a_dur").value="",document.getElementById("a_vss").value="",document.getElementById("a_vsd").value="",document.getElementById("a_vsd_i").value="",document.getElementById("a_tel").value="",document.getElementById("a_app").value="",document.getElementById("a_desc").value="",document.getElementById("a_client").disabled=!1,A.style.display="",A.setAttribute("data-active","0"),A.setAttribute("aria-pressed","false"),A.classList.remove("active"),h(M),document.getElementById("btnDeleteA").style.display="none"}function k(n){x=n.id,document.getElementById("a_form_title").textContent="Modifica appuntamento";var o=String(n.type||"vendita").toLowerCase();o.indexOf("mezza")>-1?h(S):o.indexOf("giorn")>-1?h(y):o.indexOf("formaz")>-1?h(E):o.indexOf("mbs")>-1?h($):o.indexOf("sottoprod")>-1?h(I):h(M),document.getElementById("a_client").value=n.client||"",document.getElementById("a_start").value=z(n.start);const r=new Date(n.start);let c=n.end?new Date(n.end):null,f=Number(n.durationMinutes);c instanceof Date&&!isNaN(c)&&c>=r?f=Math.max(1,Math.round((c-r)/6e4)):isFinite(f)&&f>0?c=new Date(r.getTime()+f*6e4):(f=L(n.type||"vendita"),c=new Date(r.getTime()+f*6e4)),document.getElementById("a_dur").value=String(f),document.getElementById("a_end").value=("0"+c.getHours()).slice(-2)+":"+("0"+c.getMinutes()).slice(-2),document.getElementById("a_vss").value=n.vss||"",document.getElementById("a_vsd").value=n.vsdPersonal||n.vsd||"",document.getElementById("a_vsd_i").value=n.vsdIndiretto||"",document.getElementById("a_tel").value=n.telefonate||"",document.getElementById("a_app").value=n.appFissati||"",document.getElementById("a_desc").value=n.notes||"";const N=!!n.nncf;A.setAttribute("data-active",N?"1":"0"),A.setAttribute("aria-pressed",N?"true":"false"),A.classList.toggle("active",N),document.getElementById("btnDeleteA").style.display=""}function q(){let n=(document.getElementById("a_client").value||"").trim();const o=document.getElementById("a_type").value;if(!n){const te=String(o||"").toLowerCase();if(te==="formazione"||te==="mbs"||te==="sottoprodotti")n=o;else return me("Cliente obbligatorio"),null}const r=document.getElementById("a_start").value;if(!r)return me("Data/ora obbligatorie"),null;let c=parseInt(document.getElementById("a_dur").value||"60",10);(!isFinite(c)||c<=0)&&(c=60);const f=document.getElementById("a_end").value;let N;if(f){const te=new Date(r),_=f.split(":"),j=new Date(te);j.setHours(parseInt(_[0],10)||0,parseInt(_[1],10)||0,0,0),j<te&&j.setDate(j.getDate()+1),N=j.toISOString(),c=Math.max(1,Math.round((j-te)/6e4)),document.getElementById("a_dur").value=String(c)}else N=new Date(new Date(r).getTime()+c*6e4).toISOString();const R=document.getElementById("a_desc").value||"";return{id:x||void 0,client:n,start:C(r),end:N,durationMinutes:c,type:o,vss:Number(document.getElementById("a_vss").value||0),vsdPersonal:Number(document.getElementById("a_vsd").value||0),vsdIndiretto:Number(document.getElementById("a_vsd_i").value||0),telefonate:Number(document.getElementById("a_tel").value||0),appFissati:Number(document.getElementById("a_app").value||0),notes:R,nncf:A.getAttribute("data-active")==="1"}}function le(n){const o=q();if(!o)return;const r=!x;$e("/api/appointments",o).then(()=>{if(me("Appuntamento salvato"),typeof haptics<"u"&&haptics.try("success"),document.dispatchEvent(new Event("appt:saved")),r)try{document.dispatchEvent(new Event("appt:created"))}catch(c){}if(n&&window.BP&&BP.ICS&&typeof BP.ICS.downloadIcsForAppointment=="function")if(BP.ICS.downloadIcsForAppointment(o)){typeof haptics<"u"&&haptics.try("medium");try{document.dispatchEvent(new Event("ics:exported"))}catch(f){}me(".ics esportato")}else me("Export .ics non disponibile");U(),u()}).catch(()=>me("Errore salvataggio"))}function a(){if(!x||!confirm("Eliminare l'appuntamento?"))return;const n=q();fetch("/api/appointments?id="+encodeURIComponent(x),{method:"DELETE",headers:{Authorization:"Bearer "+vt()}}).then(o=>{if(!o.ok)throw new Error("HTTP "+o.status);return o.json()}).then(()=>{me("Eliminato"),typeof showUndo=="function"&&n&&showUndo("Appuntamento eliminato",function(){return $e("/api/appointments",n)},5e3),U(),u()}).catch(()=>me("Errore eliminazione"))}document.getElementById("btnSaveA").onclick=()=>le(!1),document.getElementById("btnSaveExportA").onclick=()=>le(!0),document.getElementById("btnDeleteA").onclick=a;function e(){const n=document.getElementById("af_type").value,o=parseInt(document.getElementById("af_year").value,10);if(n==="sett"){const r=Math.max(1,Math.min(53,parseInt(document.getElementById("af_week").value||Ve(new Date),10))),c=ot(o,r);return{s:new Date(c.start),e:new Date(c.end)}}else{const r=parseInt(document.getElementById("af_month").value||new Date().getMonth()+1,10);return{s:new Date(o,r-1,1),e:new Date(o,r,0,23,59,59,999)}}}function i(n){const o=document.getElementById("af_type").value,r=parseInt(document.getElementById("af_year").value,10);if(o==="sett"){const c=parseInt(document.getElementById("af_week").value,10),f=new Date(ot(r,c).start);f.setDate(f.getDate()+7*n),document.getElementById("af_year").value=f.getFullYear(),document.getElementById("af_week").value=Ve(f)}else{const c=parseInt(document.getElementById("af_month").value,10),f=new Date(r,c-1,1);f.setMonth(f.getMonth()+n),document.getElementById("af_year").value=f.getFullYear(),document.getElementById("af_month").value=f.getMonth()+1}u()}document.getElementById("af_prev").onclick=()=>i(-1),document.getElementById("af_next").onclick=()=>i(1);const t=document.getElementById("af_type"),s=document.getElementById("af_week"),w=document.getElementById("af_month"),p=document.getElementById("af_year");t.onchange=function(){const n=t.value;document.getElementById("af_week_wrap").style.display=n==="sett"?"":"none",document.getElementById("af_month_wrap").style.display=n==="mese"?"":"none",u()},[s,w,p].forEach(n=>{n&&(n.onchange=u)});function d(n){const o=new Date(n.start);let r=n.end?new Date(n.end):null;if(!(r instanceof Date)||isNaN(r)||r<o){const R=isFinite(n.durationMinutes)?Number(n.durationMinutes):L(n.type||"vendita");r=new Date(o.getTime()+R*6e4)}const c=G(o)+" "+("0"+o.getHours()).slice(-2)+":"+("0"+o.getMinutes()).slice(-2)+"–"+("0"+r.getHours()).slice(-2)+":"+("0"+r.getMinutes()).slice(-2);var f,N=String(n.type||"").toLowerCase();return N.indexOf("mbs")>-1?f="VSD ind "+b(n.vsdIndiretto||0):N.indexOf("sottoprod")>-1?f="Tel "+je(n.telefonate||0)+" · AppFissati "+je(n.appFissati||0):N.indexOf("formaz")>-1?f="":f="VSS "+b(n.vss||0)+" · VSD "+b(n.vsdPersonal||0)+" · NNCF "+(n.nncf?"✅":"—"),'<div class="card" data-aid="'+g(String(n.id||""))+'" style="flex:1 1 320px;cursor:pointer"><div class="small muted">'+g(c)+" · "+g(n.type||"vendita")+'</div><div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><div><b>'+g(n.client||"")+'</b></div><button class="ghost btn-ics" title="Esporta" data-ics="'+g(String(n.id||""))+'">📅</button></div>'+(f?'<div class="small">'+f+"</div>":"")+"</div>"}function u(){Ie("/api/appointments").then(n=>{const o=n&&n.appointments||[],r=e(),c=r.s.getTime(),f=r.e.getTime(),N=o.filter(ue=>{const ce=new Date(ue.start).getTime();return ce>=c&&ce<=f}).sort((ue,ce)=>new Date(ue.start)-new Date(ce.start)),R=new Date,te=N.filter(ue=>new Date(ue.start)>=R),_=N.filter(ue=>new Date(ue.start)<R),j=document.getElementById("a_list");let ne="";ne+="<div><b>Prossimi</b></div>",ne+=te.length?'<div class="grid3">'+te.map(d).join("")+"</div>":'<div class="muted" style="margin:6px 0 12px">Nessun appuntamento futuro</div>';const W="past_"+Math.random().toString(36).slice(2,8);ne+='<div id="'+W+'_head" style="margin-top:12px;display:flex;align-items:center;justify-content:space-between;cursor:pointer"><b>Passati</b><span class="chev">▸</span></div><div id="'+W+'_box" style="display:none;margin-top:8px">'+(_.length?'<div class="grid3">'+_.map(d).join("")+"</div>":'<div class="muted">Nessun appuntamento passato</div>')+"</div>",j.innerHTML=ne,(function(){const ue=document.getElementById(W+"_head"),ce=document.getElementById(W+"_box"),ye=ue.querySelector(".chev");ue.onclick=function(){const _e=ce.style.display==="none";ce.style.display=_e?"":"none",ye.textContent=_e?"▾":"▸"}})();const Z=N;j.querySelectorAll("[data-ics]").forEach(ue=>{ue.addEventListener("click",ce=>{ce.stopPropagation();const ye=ue.getAttribute("data-ics"),_e=Z.find(Be=>String(Be.id)===String(ye));if(!_e){me("Appuntamento non trovato");return}if(window.BP&&BP.ICS&&typeof BP.ICS.downloadIcsForAppointment=="function")if(BP.ICS.downloadIcsForAppointment(_e)){typeof haptics<"u"&&haptics.try("medium");try{document.dispatchEvent(new Event("ics:exported"))}catch(ke){}me("Esportato")}else me("Export .ics non disponibile");else me("Export .ics non disponibile")})}),j.querySelectorAll(".card[data-aid]").forEach(ue=>{ue.addEventListener("click",()=>{const ce=ue.getAttribute("data-aid"),ye=Z.find(_e=>String(_e.id)===String(ce));ye&&(k(ye),window.scrollTo({top:0,behavior:"smooth"}))})})})}try{const n=mt("bp_prefill_slot",null);if(n&&n.start){const o=new Date(n.start),r=new Date(n.end||n.start),c=new Date(o.getTime()-o.getTimezoneOffset()*6e4).toISOString().slice(0,16);document.getElementById("a_start").value=c,document.getElementById("a_dur").value=String(Math.max(1,Math.round((r-o)/6e4))),T(),me("Slot precompilato negli appuntamenti")}dt("bp_prefill_slot")}catch(n){}try{const n=mt("bp_edit_aid",null);n&&Ie("/api/appointments").then(o=>{const c=(o&&o.appointments||[]).find(f=>String(f.id)===String(n));c&&(k(c),window.scrollTo({top:0,behavior:"smooth"}))}).finally(()=>{try{dt("bp_edit_aid")}catch(o){}})}catch(n){}document.getElementById("btnSaveA").onclick=()=>le(!1),document.getElementById("btnSaveExportA").onclick=()=>le(!0),document.getElementById("btnDeleteA").onclick=a,Ie("/api/clients").then(()=>{}),u()}function re(){if(!Pe())return l();document.title="Battle Plan – Classifiche",m.innerHTML=We()+('<div class="wrap"><div class="card"><div class="row"><div><label>Vista</label><select id="lb_tab"><option value="per_indicator">Per indicatore</option><option value="overall">Generale (score)</option></select></div><div><label>Modalità</label><select id="lb_mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div><div id="lb_ind_wrap"><label>Indicatore</label><select id="lb_indicator"><option value="VSS">VSS</option><option value="VSDPersonale">VSD</option><option value="GI">GI</option><option value="NNCF">NNCF</option></select></div></div>'+D("lb")+'</div><div class="card"><b id="lb_title">Classifica</b><div id="lb_podium" style="margin:10px 0"></div><div id="lb_table"></div></div></div>'),qe();function g(y){if(!y)return"";var E=new Date(y);return E.getFullYear()+"-"+("0"+(E.getMonth()+1)).slice(-2)+"-"+("0"+E.getDate()).slice(-2)}function b(y){return y==="ytd"||y==="ltm"?"mensile":y}document.getElementById("lb_tab").onchange=function(){var y=this.value;document.getElementById("lb_ind_wrap").style.display=y==="per_indicator"?"":"none",C()},H("lb",C),document.getElementById("lb_mode").onchange=C,document.getElementById("lb_indicator").onchange=C;function G(){var y=Y("lb"),E=g(y.start),$=g(y.end),I=b(y.type||"mensile");return"&from="+encodeURIComponent(E)+"&to="+encodeURIComponent($)+"&type="+encodeURIComponent(I)}function C(){var y=document.getElementById("lb_tab").value,E=G(),$=document.getElementById("lb_mode").value;if(y==="overall")Ie("/api/leaderboard_overall?mode="+encodeURIComponent($)+E).then(S);else{var I=document.getElementById("lb_indicator").value;Ie("/api/leaderboard?indicator="+encodeURIComponent(I)+"&mode="+encodeURIComponent($)+E).then(function(v){M(v,I)})}}function z(y){return y===0?"🥇":y===1?"🥈":y===2?"🥉":y+1+"."}function L(y){var E=document.getElementById("lb_podium");if(!y||!y.length){E.innerHTML="";return}for(var $=y.slice(0,3),I='<div class="row" style="align-items:flex-end">',v=0;v<$.length;v++){var h=80-v*15;I+='<div class="card" style="flex:1 1 120px;height:'+h+'px;display:flex;align-items:flex-end;justify-content:center"><div>'+Te(z(v)+" "+$[v].name)+"</div></div>"}I+="</div>",E.innerHTML=I}function A(y,E,$){var I=Math.min(100,Math.max(0,Math.round($)));return'<div class="card lb-card" style="flex:1 1 280px"><div class="big">'+Te(y)+'</div><div class="small muted">'+Te(E)+'</div><div class="lb-bar"><div style="width:'+I+'%"></div></div></div>'}function M(y,E){document.getElementById("lb_title").textContent="Classifica – "+E;var $=y.ranking||[];if(L($),!$.length){document.getElementById("lb_table").innerHTML='<div class="muted">Nessun dato</div>';return}for(var I='<div class="row">',v=$[0].total||1,h=0;h<$.length;h++){var P=$[h];I+=A(z(h)+" "+P.name,"Totale: "+je(P.total),P.total/v*100)}I+="</div>",document.getElementById("lb_table").innerHTML=I}function S(y){document.getElementById("lb_title").textContent="Classifica generale";var E=y.ranking||[];if(L(E),!E.length){document.getElementById("lb_table").innerHTML='<div class="muted">Nessun dato</div>';return}for(var $=E[0].score||0,I='<div class="row">',v=0;v<E.length;v++){var h=E[v];I+=A(z(v)+" "+h.name,"Score: "+je(h.score)+"/100",$?h.score/$*100:0)}I+="</div>",document.getElementById("lb_table").innerHTML=I}C()}(function(){function g(){var b=document.getElementById("bp-overlay");return b||(b=document.createElement("div"),b.id="bp-overlay",b.className="hidden",b.setAttribute("role","dialog"),b.setAttribute("aria-modal","true"),b.innerHTML='<div class="bp-overlay-backdrop" id="bp-overlay-backdrop"></div><div class="bp-overlay-panel" id="bp-overlay-panel"></div>',document.body.appendChild(b),document.getElementById("bp-overlay-backdrop").addEventListener("click",hideOverlay)),b}window.showOverlay=function(b){var G=g(),C=document.getElementById("bp-overlay-panel");C.innerHTML=b||"",G.classList.remove("hidden");var z=C.querySelector("input, textarea, select, button");z&&setTimeout(function(){try{z.focus()}catch(L){}},0)},window.hideOverlay=function(){var b=document.getElementById("bp-overlay");b&&b.classList.add("hidden")}})();function oe(){if(!Pe())return l();document.title="Battle Plan – Clienti",m.innerHTML=We()+'<div class="wrap"><div class="card"><b>Nuovo cliente</b><div class="row" style="margin-top:8px"><div><label>Ragione sociale</label><input id="cl_name" type="text" placeholder="Es. Rossi S.r.l."></div><div><label>Stato</label><select id="cl_new_state"><option value="potenziale">Potenziale</option><option value="lead non chiuso">Lead non chiuso</option><option value="attivo">Attivo</option></select></div><div><label>Consulente</label><select id="cl_new_owner"><option value="">—</option></select></div><div class="right"><button id="cl_add">Aggiungi</button></div></div></div><div class="card"><b>Filtri elenco</b><div class="row" style="margin-top:8px"><div><label>Stato</label><select id="cl_f_state"><option value="">Tutti</option><option value="attivo">Attivo</option><option value="lead non chiuso">Lead non chiuso</option><option value="potenziale">Potenziale</option></select></div><div><label>Consulente</label><select id="cl_f_cons"><option value="">Tutti</option></select></div><div><label>Ordina per</label><select id="cl_order"><option value="az">Ragione sociale (A→Z)</option><option value="last_desc">Ultimo appuntamento (recenti prima)</option></select></div><div class="right"><button class="ghost" id="cl_f_apply">Applica</button></div></div></div><div class="card"><b>Elenco clienti</b><div id="cl_list" class="row" style="margin-top:8px"></div></div></div>',qe();function g(){const C=(document.getElementById("cl_name").value||"").trim();if(!C){me("Nome obbligatorio");return}const z=document.getElementById("cl_new_state"),L=document.getElementById("cl_new_owner"),A={name:C};z&&(A.status=z.value),L&&L.value&&(A.consultantId=L.value),$e("/api/clients",A).then(function(){document.getElementById("cl_name").value="",G(),pt(),window.addXP(5)}).catch(function(M){logger.error(M),me("Errore creazione cliente")})}function b(){Ie("/api/usernames").then(function(C){const z=C&&C.users||[],L=document.getElementById("cl_f_cons"),A=document.getElementById("cl_new_owner");L&&(L.innerHTML='<option value="">Tutti</option>'+z.map(function(M){return'<option value="'+M.id+'">'+Te(M.name)+(M.grade?" ("+M.grade+")":"")+"</option>"}).join("")),A&&(A.innerHTML='<option value="">—</option>'+z.map(function(M){return'<option value="'+M.id+'">'+Te(M.name)+(M.grade?" ("+M.grade+")":"")+"</option>"}).join(""))}).catch(function(C){logger.error(C)})}function G(){Ie("/api/clients").then(function(C){const z=C&&C.clients||[],L=document.getElementById("cl_f_state").value,A=document.getElementById("cl_f_cons").value;function M(E){return String(E||"").trim().toLowerCase()}const y=z.filter(function(E){return!(L&&M(E.status)!==M(L)||A&&String(E.consultantId||"")!==String(A))}).map(function(E){const $=Te(E.name||""),I=Te(E.status||"potenziale"),v=E.consultantName?Te(E.consultantName):"unknown",h=String(E.id||"");return'<div class="card" data-clid="'+h+'" data-name-lower="'+$.toLowerCase()+'" data-status="'+I+'" data-consultant-id="'+Te(String(E.consultantId||""))+'" style="flex:1 1 380px"><div><b>'+$+'</b></div><div class="small">Stato: <b class="cl-status">'+I+'</b></div><div class="small">Consulente: <b class="cl-cons">'+v+'</b></div><div class="small muted">Ultimo appuntamento: <span class="last-appt">—</span></div><div class="right" style="margin-top:6px"><button class="ghost" data-del="'+h+'">Rimuovi</button></div></div>'}).join("");document.getElementById("cl_list").innerHTML=y||'<div class="muted">Nessun cliente</div>',document.querySelectorAll("[data-del]").forEach(function(E){E.addEventListener("click",function(){const $=E.getAttribute("data-del");confirm("Rimuovere il cliente?")&&fetch("/api/clients?id="+encodeURIComponent($),{method:"DELETE",headers:{Authorization:"Bearer "+vt()}}).then(function(I){if(!I.ok)throw new Error("HTTP "+I.status);return I.json()}).then(function(){me("Cliente rimosso"),G()}).catch(function(I){logger.error(I),me("Errore rimozione")})})}),window.BPFinal&&typeof BPFinal.ensureClientSection=="function"?BPFinal.ensureClientSection():setTimeout(function(){const E=document.getElementById("cl_list"),$=Array.from(E.children).filter(I=>I.classList.contains("card"));$.sort((I,v)=>String(I.getAttribute("data-name-lower")||"").localeCompare(String(v.getAttribute("data-name-lower")||"")));for(const I of $)E.appendChild(I)},0)})}document.getElementById("cl_add").onclick=g,document.getElementById("cl_f_apply").onclick=G,b(),G(),typeof kickFinal=="function"&&kickFinal("clients")}function pe(){if(!Pe())return l();document.title="Battle Plan – Squadra";var g=We()+'<div class="wrap">'+('<div class="card"><b>Vista Amministratore</b><div id="t_adminbar" class="row" style="margin-top:8px;display:flex;align-items:flex-end;gap:16px;flex-wrap:wrap"><div><label>Modalità</label><select id="t_mode" name="mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div><div id="t_unified_wrap">'+D("t")+'</div></div></div><div class="card"><b>Riepilogo per utente</b><div id="t_users" class="row" style="margin-top:8px"></div></div><div class="card"><b>Aggregato Squadra</b><div id="t_agg" class="row" style="margin-top:8px"></div><div class="row" style="margin-top:12px;align-items:flex-end;gap:16px;flex-wrap:wrap"><div><label>Indicatore grafico</label><select id="t_ind"><option value="VSS">VSS</option><option value="VSDPersonale">VSD Personale</option><option value="VSDIndiretto">VSD Indiretto</option><option value="VSDTotale">VSD Totale</option><option value="GI">GI</option><option value="NNCF">NNCF</option><option value="provv_gi">Provv GI</option><option value="provv_vsd">Provv VSD</option><option value="tot_provv" selected>Tot Provvigioni</option></select></div><div><label>Consulente</label><select id="t_cons"><option value="">Tutti</option></select></div></div><div style="margin-top:8px"><canvas id="t_chart" height="160"></canvas></div></div>')+"</div>";m.innerHTML=g,qe(),(function(){var U=document.getElementById("t_adminbar"),k=document.getElementById("t_unified_wrap");if(!(!U||!k)){var q=k.querySelector(".row");q&&(Array.from(q.children).forEach(function(le){le.classList.remove("right"),le.style.marginTop="0",U.appendChild(le)}),k.remove())}})();function b(x){return x=Number(x||0),isFinite(x)?x:0}function G(x){if(!x)return"";var U=new Date(x);return U.getFullYear()+"-"+("0"+(U.getMonth()+1)).slice(-2)+"-"+("0"+U.getDate()).slice(-2)}function C(x){return x=String(x||"mensile").toLowerCase(),x.indexOf("sett")===0?"settimanale":x.indexOf("mes")===0?"mensile":x.indexOf("tri")===0?"trimestrale":x.indexOf("sem")===0?"semestrale":x.indexOf("ann")===0?"annuale":"mensile"}function z(){var x=Y("t"),U=G(x.start),k=G(x.end),q=C(x.type);return"&from="+encodeURIComponent(U)+"&to="+encodeURIComponent(k)+"&type="+encodeURIComponent(q)}function L(x){switch(String(x)){case"provv_gi":return"ProvvGI";case"provv_vsd":return"ProvvVSD";case"tot_provv":return"TotProvvigioni";default:return x}}function A(x){var U=Number(x)||0;return U.toLocaleString("it-IT")+"€"}function M(x){var U=Number(x)||0;return String(Math.round(U))}function S(x){return String(x).replace(/[&<>'"]/g,U=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[U])}var y=null;function E(x,U){return U==="settimanale"?window.isoWeekNum?window.isoWeekNum(x):Math.ceil(x.getDate()/7):U==="mensile"||U==="ytd"||U==="ltm"?x.getMonth()+1:U==="trimestrale"?Math.floor(x.getMonth()/3)+1:U==="semestrale"?x.getMonth()<6?1:2:x.getFullYear()}function $(x,U){var k=document.getElementById("t_chart");if(k){var q=P(U),le=typeof V=="function"?V(U,q):x.map(function(p){return E(p.x,U)}),a=x.map(function(p){return p.y});if(typeof Chart>"u"){var t=k.getContext("2d");k.width=k.clientWidth||600,k.height=k.clientHeight||160,t.clearRect(0,0,k.width,k.height);var e=Math.max(1,...a),i=a.length>1?(k.width-8)/(a.length-1):0;t.beginPath(),t.lineWidth=2,t.strokeStyle="#2e6cff",a.forEach(function(d,u){var n=4+u*i,o=k.height-6-d/e*(k.height-12);u?t.lineTo(n,o):t.moveTo(n,o)}),t.stroke(),t.fillStyle="#2e6cff",a.forEach(function(d,u){var n=4+u*i,o=k.height-6-d/e*(k.height-12);t.beginPath(),t.arc(n,o,2,0,Math.PI*2),t.fill()});return}var t=k.getContext("2d"),s=typeof window.computeTickOptions=="function"?window.computeTickOptions(le,k.width||600):{autoSkip:!0,maxRotation:0,minRotation:0};if(y)y.data.labels=le,y.data.datasets[0].data=a,y.options.scales.x.ticks=s,y.update();else{var w=typeof Chart.getChart=="function"?Chart.getChart(k):null;w&&w.destroy(),y=new Chart(t,{type:"line",data:{labels:le,datasets:[{label:"",data:a,tension:.3,pointRadius:3,pointHoverRadius:5}]},options:{responsive:!1,maintainAspectRatio:!1,animation:!1,animations:!1,plugins:{legend:{display:!1}},scales:{x:{grid:{display:!1},ticks:s},y:{beginAtZero:!0}}}})}}}function I(x){return'<div class="card" style="flex:1 1 360px"><div style="display:flex;align-items:center;gap:8px"><div><b>'+S(x.name||"User #"+x.userId)+"</b></div>"+(x.grade?'<span class="chip small">'+S(x.grade)+"</span>":"")+'</div><div class="small" style="margin-top:6px">VSS '+A(x.vss||0)+'</div><div class="small">VSD Pers. '+A(x.vsdP||0)+'</div><div class="small">VSD Ind. '+A(x.vsdI||0)+'</div><div class="small">VSD Tot. '+A((x.vsdP||0)+(x.vsdI||0))+'</div><div class="small">GI '+A(x.gi||0)+'</div><div class="small">NNCF '+M(x.nncf||0)+'</div><div class="small muted" style="margin-top:6px">Provv GI '+A(x.provvGi||0)+'</div><div class="small muted">Provv VSD '+A(x.provvVsd||0)+'</div><div class="small"><b>Tot Provvigioni '+A(x.provvTot||0)+"</b></div></div>"}function v(x){return'<div class="card" style="flex:1 1 460px"><div class="neon" style="font-weight:900">Totali squadra</div><div class="small" style="margin-top:6px">VSS '+A(x.vss)+'</div><div class="small">VSD Pers. '+A(x.vsdP)+'</div><div class="small">VSD Ind. '+A(x.vsdI)+'</div><div class="small">VSD Tot. '+A(x.vsdP+x.vsdI)+'</div><div class="small">GI '+A(x.gi)+'</div><div class="small">NNCF '+M(x.nncf)+'</div><div class="small muted" style="margin-top:6px">Provv GI '+A(x.provvGi)+'</div><div class="small muted">Provv VSD '+A(x.provvVsd)+'</div><div class="small"><b>Tot Provvigioni '+A(x.provvTot)+"</b></div></div>"}function h(){var x=(document.getElementById("t_mode")||{}).value||"consuntivo",U=z();Promise.all([Ie("/api/usernames"),Ie("/api/leaderboard?indicator="+encodeURIComponent("VSS")+U+"&mode="+encodeURIComponent(x)),Ie("/api/leaderboard?indicator="+encodeURIComponent("VSDPersonale")+U+"&mode="+encodeURIComponent(x)),Ie("/api/leaderboard?indicator="+encodeURIComponent("VSDIndiretto")+U+"&mode="+encodeURIComponent(x)),Ie("/api/leaderboard?indicator="+encodeURIComponent("GI")+U+"&mode="+encodeURIComponent(x)),Ie("/api/leaderboard?indicator="+encodeURIComponent("NNCF")+U+"&mode="+encodeURIComponent(x)),Ie("/api/leaderboard?indicator="+encodeURIComponent("ProvvGI")+U+"&mode="+encodeURIComponent(x)),Ie("/api/leaderboard?indicator="+encodeURIComponent("ProvvVSD")+U+"&mode="+encodeURIComponent(x))]).then(function(k){var q=k[0]||{},le=k[1]&&(k[1].rows||k[1].ranking)||[],a=k[2]&&(k[2].rows||k[2].ranking)||[],e=k[3]&&(k[3].rows||k[3].ranking)||[],i=k[4]&&(k[4].rows||k[4].ranking)||[],t=k[5]&&(k[5].rows||k[5].ranking)||[],s=k[6]&&(k[6].rows||k[6].ranking)||[],w=k[7]&&(k[7].rows||k[7].ranking)||[],p=(q.users||[]).map(function(W){return{id:String(W.id),name:W.name||W.email||"User #"+W.id,grade:W.grade==="senior"?"senior":"junior"}}),d=document.getElementById("t_cons");d&&(d.innerHTML='<option value="">Tutti</option>'+p.map(function(W){return'<option value="'+W.id+'">'+S(W.name)+"</option>"}).join(""));function u(W){for(var Z={},ue=0;ue<W.length;ue++){var ce=W[ue],ye=String(ce.userId||ce.id||ce.uid||""),_e=b(ce.total||ce.value||ce.sum||0);ye&&(Z[ye]=_e)}return Z}var n=u(le),o=u(a),r=u(e),c=u(i),f=u(t),N=u(s),R=u(w),te=p.map(function(W){var Z=b(n[W.id]),ue=b(o[W.id]),ce=b(r[W.id]),ye=b(c[W.id]),_e=b(f[W.id]),Be=b(N[W.id]),ke=b(R[W.id]);return{userId:W.id,name:W.name,grade:W.grade,vss:Z,vsdP:ue,vsdI:ce,gi:ye,nncf:_e,provvGi:Be,provvVsd:ke,provvTot:Be+ke}}),_=document.getElementById("t_users");_&&(_.innerHTML=te.length?te.map(I).join(""):'<div class="muted">Nessun dato</div>');var j=te.reduce(function(W,Z){return W.vss+=Z.vss,W.vsdP+=Z.vsdP,W.vsdI+=Z.vsdI,W.gi+=Z.gi,W.nncf+=Z.nncf,W.provvGi+=Z.provvGi,W.provvVsd+=Z.provvVsd,W.provvTot+=Z.provvTot,W},{vss:0,vsdP:0,vsdI:0,gi:0,nncf:0,provvGi:0,provvVsd:0,provvTot:0}),ne=document.getElementById("t_agg");ne&&(ne.innerHTML=v(j)),B()}).catch(function(k){logger.error(k),me("Errore caricamento squadra")})}function P(x){return(typeof X=="function"?X(x,new Date):[]).map(function(U){return{s:U.s,e:U.e}})}function T(x,U,k,q){var le=q||Y("t"),a=String(le.type||"mensile").toLowerCase(),e=a==="ytd"||a==="ltm"?"mensile":a,i=P(a);function t(p,d){var u=new Date(d.startDate).getTime(),n=new Date(d.endDate).getTime();return u>=p.s&&n<=p.e}function s(p,d){if(!p)return 0;if(d==="VSDTotale")return Number(p.VSDPersonale||0)+Number(p.VSDIndiretto||0);if(d==="ProvvGI")return Number(p.ProvvGI||0);if(d==="ProvvVSD")return Number(p.ProvvVSD||0);if(d==="TotProvvigioni"){var u=p.TotProvvigioni;return Number(u!=null?u:Number(p.ProvvGI||0)+Number(p.ProvvVSD||0))}return Number(p[d]||0)}var w=(function(){var p=i.length?G(new Date(i[0].s)):G(new Date),d=i.length?G(new Date(i[i.length-1].e)):G(new Date),u="?global=1&type="+encodeURIComponent(e)+"&from="+encodeURIComponent(p)+"&to="+encodeURIComponent(d);return k&&(u+="&userId="+encodeURIComponent(k)),u})();return Ie("/api/periods"+w).catch(function(){return Ie("/api/periods"+w.replace("?global=1",""))}).then(function(p){var d=p&&p.periods||[],u=d.filter(function(o){return!(o.type!==e||k&&String(o.userId||o.uid||"")!==String(k))}),n=i.map(function(o){for(var r=0,c=0;c<u.length;c++){var f=u[c];if(t(o,f)){var N=U==="previsionale"?f.indicatorsPrev||{}:f.indicatorsCons||{};r+=s(N,L(x))}}return{x:new Date(o.s),y:Math.round(r*100)/100}});return n})}function B(){var x=document.getElementById("t_ind").value,U=document.getElementById("t_mode").value||"consuntivo",k=document.getElementById("t_cons").value||"",q=Y("t"),le=q.type,a=L(x);z()+(k?"&userId="+encodeURIComponent(k):"")+("&indicator="+encodeURIComponent(a))+("&mode="+encodeURIComponent(U));var e=T(a,U,k||null,q);e.then(function(i){$(i,le)}).catch(function(i){logger.error(i),$([],le)})}H("t",function(){typeof haptic=="function"&&haptic("light"),h()}),document.getElementById("t_mode").onchange=function(){typeof haptic=="function"&&haptic("light"),h()},document.getElementById("t_ind").onchange=function(){typeof haptic=="function"&&haptic("light"),B()},document.getElementById("t_cons").onchange=function(){typeof haptic=="function"&&haptic("light"),B()},h()}function de(){if(!Pe())return l();var g=Pe().role==="admin";document.title="Battle Plan – Provvigioni",m.innerHTML=We()+'<div class="wrap"><div class="card"><b>Calcolo provvigioni</b><div class="row" style="margin-top:8px; gap:12px; flex-wrap:wrap">'+(g?'<div><label>Utente</label><select id="comm_user"><option value="__all">Tutta la squadra</option></select></div>':"")+'<div><label>Modalità</label><select id="comm_mode" name="mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div></div>'+D("comm")+'</div><div class="card"><b>Indicatori periodo</b><div id="comm_total" style="margin-top:8px"></div></div><div class="card"><b>Provvigioni – ripartizione</b><div class="small muted">Confronto tra Provvigioni GI e Provvigioni VSD sul periodo selezionato</div><div class="row" style="margin-top:8px; align-items:center; gap:16px; flex-wrap:wrap"><canvas id="cm_pie_provv" width="260" height="260" style="max-width:260px; max-height:260px"></canvas><div id="cm_pie_legend" class="small"></div></div></div><div class="card"><b>Dettaglio</b><div id="comm_rows" class="row" style="margin-top:8px; gap:12px; flex-wrap:wrap"></div></div></div>',qe();function b(I){return document.getElementById(I)}function G(I){if(!I)return"";var v=new Date(I);return v.getFullYear()+"-"+("0"+(v.getMonth()+1)).slice(-2)+"-"+("0"+v.getDate()).slice(-2)}function C(I){var v=Number(I)||0;return v.toLocaleString("it-IT")+"€"}function z(I){return I=Number(I==null?"":I),isFinite(I)?I:0}function L(I){return I?I.TotProvvigioni!=null?z(I.TotProvvigioni):z(I.ProvvGI)+z(I.ProvvVSD):0}function A(I,v){return'<div class="card" style="flex:1 1 100px"><div class="small muted">'+Te(I)+'</div><div style="font-weight:700; font-size:20px; margin-top:4px">'+v+"</div></div>"}function M(I){return'<div class="row" style="gap:12px; flex-wrap:wrap">'+A("VSD personale",C(I.vsd||0))+A("GI",C(I.gi||0))+'</div><div class="row" style="gap:12px; flex-wrap:wrap; margin-top:8px">'+A("Provv. VSD",C(I.provv_vsd||0))+A("Provv. GI",C(I.provv_gi||0))+A("Totale Provvigioni",C(I.provv_total||0))+"</div>"}function S(I){return I.length?I.map(function(v){return'<div class="card" style="flex:1 1 320px"><div><b>'+Te(v.name)+'</b></div><div class="small" style="margin-top:4px">GI '+C(v.gi||0)+" · VSD "+C(v.vsd||0)+'</div><div class="small muted" style="margin-top:2px">Provv. GI '+C(v.provv_gi||0)+" · Provv. VSD "+C(v.provv_vsd||0)+'</div><div class="small" style="margin-top:6px"><b>Totale: '+C(v.provv_total||0)+"</b></div></div>"}).join(""):'<div class="muted">Nessun dato</div>'}function y(I,v,h){var P=document.getElementById("cm_pie_provv"),T=document.getElementById("cm_pie_legend");if(!P||!P.getContext){T&&(T.innerHTML="");return}var B=P.getContext("2d"),x=P.width,U=P.height,k=x/2,q=U/2,le=Math.min(x,U)/2-8;B.clearRect(0,0,x,U);var a=Math.max(0,I||0),e=Math.max(0,v||0),i=a+e,t=h>0?Math.round(i/h*100):null;if(i<=0){B.beginPath(),B.arc(k,q,le,0,Math.PI*2),B.strokeStyle="#ccd0d5",B.lineWidth=10,B.setLineDash([6,6]),B.stroke(),B.setLineDash([]),B.globalCompositeOperation="destination-out",B.beginPath(),B.arc(k,q,le*.55,0,Math.PI*2),B.fill(),B.globalCompositeOperation="source-over",B.fillStyle="#111",B.textAlign="center",B.textBaseline="middle",B.font="bold 20px system-ui, -apple-system, Segoe UI, Roboto, sans-serif",B.fillText(t==null?"—":t+"%",k,q),T&&(T.innerHTML='<div class="muted">Nessuna provvigione nel periodo</div>');return}var s=[{label:"Provv. GI",value:a,color:"#4F8EF7"},{label:"Provv. VSD",value:e,color:"#F79F4F"}],w=-Math.PI/2;s.forEach(function(u){var n=u.value/i*Math.PI*2;B.beginPath(),B.moveTo(k,q),B.arc(k,q,le,w,w+n),B.closePath(),B.fillStyle=u.color,B.fill(),w+=n}),B.globalCompositeOperation="destination-out",B.beginPath(),B.arc(k,q,le*.55,0,Math.PI*2),B.fill(),B.globalCompositeOperation="source-over",B.fillStyle="#111",B.textAlign="center",B.textBaseline="middle",B.font="bold 20px system-ui, -apple-system, Segoe UI, Roboto, sans-serif",B.fillText(t==null?"—":t+"%",k,q);var p=Math.round(a/i*100),d=Math.round(e/i*100);T&&(T.innerHTML='<div class="row" style="gap:16px; flex-wrap:wrap"><div class="row" style="gap:8px; align-items:center"><span style="display:inline-block;width:12px;height:12px;background:#4F8EF7;border-radius:3px"></span><span><b>Provv. GI</b> '+C(a)+" · "+p+'%</span></div><div class="row" style="gap:8px; align-items:center"><span style="display:inline-block;width:12px;height:12px;background:#F79F4F;border-radius:3px"></span><span><b>Provv. VSD</b> '+C(e)+" · "+d+"%</span></div></div>")}function E(){var I=Y("comm"),v=b("comm_mode").value||"consuntivo",h=g?b("comm_user").value||"__all":String(Pe().id),P=new Date(I.start).getTime(),T=new Date(I.end).getTime(),B=K(I.type||"mensile"),x=(function(){var U=G(new Date(P)),k=G(new Date(T)),q="?type="+encodeURIComponent(B)+"&from="+encodeURIComponent(U)+"&to="+encodeURIComponent(k);return g&&h&&h!=="__all"&&(q+="&userId="+encodeURIComponent(h)),q})();Ie("/api/periods"+x).then(function(U){var k=U&&U.periods||[],q=k.filter(function(e){if(e.type!==B)return!1;var i=new Date(e.startDate).getTime(),t=new Date(e.endDate).getTime();return!(i<P||t>T||g&&h!=="__all"&&String(e.userId||e.uid||"")!==String(h)||!g&&String(e.userId||e.uid||"")!==String(Pe().id))}),le={gi:0,vsd:0,provv_gi:0,provv_vsd:0,provv_total:0},a={};q.forEach(function(e){var i=v==="previsionale"?e.indicatorsPrev||{}:e.indicatorsCons||{},t=String(e.userId||e.uid||""),s=e.userName||e.name||"User "+t,w=z(i.GI),p=z(i.VSDPersonale),d=z(i.ProvvGI),u=z(i.ProvvVSD),n=L(i);le.gi+=w,le.vsd+=p,le.provv_gi+=d,le.provv_vsd+=u,le.provv_total+=n,a[t]||(a[t]={userId:t,name:s,gi:0,vsd:0,provv_gi:0,provv_vsd:0,provv_total:0}),a[t].gi+=w,a[t].vsd+=p,a[t].provv_gi+=d,a[t].provv_vsd+=u,a[t].provv_total+=n}),b("comm_total").innerHTML=M(le),b("comm_rows").innerHTML=S(Object.values(a).sort(function(e,i){return(i.provv_total||0)-(e.provv_total||0)})),y(le.provv_gi||0,le.provv_vsd||0,le.gi||0)}).catch(function(U){logger.error(U),me("Errore nel caricamento dati")})}function $(){g&&Ie("/api/usernames").then(function(I){var v=b("comm_user");if(v){for(var h='<option value="__all">Tutta la squadra</option>',P=I&&I.users||[],T=0;T<P.length;T++){var B=P[T];h+='<option value="'+B.id+'">'+Te(B.name||"User "+B.id)+"</option>"}v.innerHTML=h}})}H("comm",function(){E()}),b("comm_mode").onchange=function(){haptic("light"),E()},g&&(b("comm_user").onchange=function(){haptic("light"),E()}),$(),E()}function Ce(){if(!Pe())return l();document.title="Battle Plan – Vendite e Riordini",m.innerHTML=We()+'\n    <div class="wrap">\n\n      <div class="card">\n        <b>Filtro</b>\n        <div class="row" style="margin-top:6px;align-items:flex-end;gap:16px;flex-wrap:wrap">\n          <div>\n            <label>Consulente</label>\n            <select id="vr_cons"><option value="">Tutti</option></select>\n          </div>\n        </div>\n        '.concat(D("vr"),'\n      </div>\n\n      <div class="card">\n        <b>Vendite e Riordini</b>\n        <div class="table" style="overflow:auto">\n          <table class="simple" style="min-width:980px">\n            <thead>\n              <tr>\n                <th>Data</th>\n                <th>Cliente</th>\n                <th>Consulente</th>\n              </tr>\n            </thead>\n            <tbody id="vr_rows">\n              <tr><td colspan="3" class="muted">Nessun dato</td></tr>\n            </tbody>\n          </table>\n        </div>\n      </div>\n\n    </div>'),qe(),H("vr",()=>{})}function ve(){if(!Pe())return l();document.title="Battle Plan – GI & Scadenzario",m.innerHTML=We()+'\n  <div class="wrap">\n\n    <div class="card">\n      <b>Filtro</b>\n      <div class="row" style="margin-top:6px;align-items:flex-end;gap:16px;flex-wrap:wrap">\n        <div>\n          <label>Consulente</label>\n          <select id="gi_cons"><option value="">Tutti</option></select>\n        </div>\n      </div>\n      '.concat(D("gi"),'\n    </div>\n\n    <div class="card">\n      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">\n        <b>Vendite (GI)</b>\n        <button class="ghost" id="gi_add">Nuova vendita</button>\n      </div>\n      <div class="table" style="overflow:auto">\n        <table class="simple" style="min-width:980px">\n          <thead>\n            <tr>\n              <th>Data vendita</th>\n              <th>Cliente</th>\n              <th>Consulente</th>\n              <th>Servizi</th>\n              <th style="text-align:right">Tot. VSS</th>\n              <th>Piano pagamenti</th>\n              <th></th>\n            </tr>\n          </thead>\n          <tbody id="gi_rows"></tbody>\n        </table>\n      </div>\n    </div>\n\n  </div>'),qe();const g=v=>document.getElementById(v),b=v=>String(v||"").replace(/[&<>'"]/g,h=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[h]),G=v=>(Number(v)||0).toLocaleString("it-IT")+"€",C=v=>{const h=new Date(v);return h.getFullYear()+"-"+("0"+(h.getMonth()+1)).slice(-2)+"-"+("0"+h.getDate()).slice(-2)};function z(){const v=window.readUnifiedRange&&window.readUnifiedRange("gi")||{};if(!v||!v.start||!v.end){const h=new Date,P=new Date(h.getFullYear(),0,1),T=new Date(h.getFullYear(),11,31,23,59,59);return{from:C(P),to:C(T)}}return{from:C(v.start),to:C(v.end)}}let L=[];function A(){return Ie("/api/clients").then(v=>(L=v&&v.clients||[],Ie("/api/usernames"))).then(v=>{const h=v&&v.users||[],P=g("gi_cons");P&&(P.innerHTML='<option value="">Tutti</option>'+h.map(T=>'<option value="'+b(String(T.id))+'">'+b(T.name)+"</option>").join(""))})}function M(v){const h=Array.isArray(v.schedule)?v.schedule.slice():[];if(!h.length)return'<span class="muted">—</span>';const P=h.find(k=>k.kind==="deposit"||/acconto/i.test(k.note||"")),T=h.filter(k=>k!==P),B=P?"Acconto: "+G(P.amount):"";if(!T.length)return B||'<span class="muted">—</span>';const x=Math.round(T[0].amount||0),U=T.every(k=>Math.abs(Math.round(k.amount||0)-x)<=1);return(B?B+" + ":"")+(U?T.length+" rate da "+G(x):"piano personalizzato")}function S(v){return'<tr data-id="'+b(String(v.id))+'"><td>'+new Date(v.date||v.createdAt).toLocaleDateString("it-IT")+"</td><td>"+b(v.clientName||"")+"</td><td>"+b(v.consultantName||"")+"</td><td>"+b(v.services||"")+'</td><td style="text-align:right"><b>'+G(v.vssTotal||0)+"</b></td><td>"+M(v)+'</td><td class="right"><button class="ghost" data-edit="'+b(String(v.id))+'">Modifica</button></td></tr>'}function y(){const v=z(),h=(g("gi_cons")||{}).value||"",P="?from="+encodeURIComponent(v.from)+"&to="+encodeURIComponent(v.to)+(h?"&userId="+encodeURIComponent(h):"");Ie("/api/gi"+P).then(T=>{let B=T&&T.sales||[];B.sort((x,U)=>+new Date(U.date||U.createdAt||0)-+new Date(x.date||x.createdAt||0)),g("gi_rows").innerHTML=B.length?B.map(S).join(""):'<tr><td colspan="7" class="muted">Nessuna vendita</td></tr>',$()}).catch(T=>{logger.error(T),me("Errore caricamento GI")})}function E(v){const h=v.sale||{},P=Array.isArray(h.schedule)?h.schedule.slice():[],T=P.find(r=>r.kind==="deposit"||/acconto/i.test(r.note||"")),B=P.filter(r=>r!==T),x=B.length>0?B.every(r=>Math.abs((+r.amount||0)-(+B[0].amount||0))<=1):!0,U=B.length&&x?"rate":"manual",k=C(new Date),q='<div class="modal"><div class="card gi-modal"><style>.gi-modal{min-width:min(760px,96vw);max-width:980px;max-height:86vh;overflow:auto}@media (max-width:740px){ .gi-grid{display:block} .gi-col{width:100%} .gi-modal{min-width:96vw} }.gi-grid{display:flex; gap:12px; flex-wrap:wrap} .gi-col{flex:1; min-width:240px}.gi-section{border-top:1px solid var(--hair, rgba(0,0,0,.12)); padding-top:10px; margin-top:10px}.pilltabs{display:flex; gap:12px; align-items:center} .pilltabs label{display:flex; align-items:center; gap:6px; cursor:pointer}.mrow{display:flex; gap:8px; align-items:center; flex-wrap:wrap}.mini input[type=number]{width:120px}.gi-rlist{margin-top:6px; max-height:200px; overflow:auto; border:1px dashed rgba(0,0,0,.15); border-radius:8px; padding:6px}.gi-r{display:flex; gap:6px; align-items:center; padding:4px 0}.gi-foot{display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:12px}</style><div style="display:flex;justify-content:space-between;align-items:center"><b>'+(v.title||(h.id?"Modifica vendita":"Nuova vendita"))+'</b><button class="ghost" id="m_close">Chiudi</button></div><div class="gi-grid"><div class="gi-col"><label>Data</label><input id="m_date" type="date" value="'+b(C(h.date||k))+'"></div><div class="gi-col"><label>Cliente</label><select id="gi_client_select"><option value="">Caricamento…</option></select></div><div class="gi-col"><label>Totale VSS</label><input id="m_vss" type="number" step="1" value="'+b(Number(h.vssTotal||0))+'"></div></div><div class="gi-section"><label>Servizi</label><textarea id="m_srv" rows="2">'+b(h.services||"")+'</textarea></div><div class="gi-section"><b>Acconto</b><div class="mrow mini" style="margin-top:6px"><label><input id="acc_enable" type="checkbox" '+(T?"checked":"")+'> Abilita</label><label>Tipo</label><select id="acc_type"><option value="abs">Valore assoluto</option><option value="perc">Percentuale</option></select><label>Valore</label><input id="acc_value" type="number" step="1" value="'+(T?b(Number(T._fromPerc?T._rawPerc:T.amount)):"0")+'"><label>Scadenza</label><input id="acc_date" type="date" value="'+b(C(T?T.dueDate:h.date||k))+'"><label>Nota</label><input id="acc_note" placeholder="es. Acconto" value="'+b(T&&T.note||"Acconto")+'"></div></div><div class="gi-section"><b>Modalità pagamenti</b><div class="pilltabs" style="margin:6px 0 8px"><label><input type="radio" name="pmode" value="rate" '+(U==="rate"?"checked":"")+'> Rateale</label><label><input type="radio" name="pmode" value="manual" '+(U!=="rate"?"checked":"")+'> Scaglioni manuali</label></div><div id="p_rate" style="display:'+(U==="rate"?"block":"none")+'"><div class="mrow mini"><label>N° rate</label><input id="rt_n" type="number" value="'+b(B.length||12)+'"><label>Frequenza</label><select id="rt_freq"><option value="M">Mensile</option><option value="Q">Trimestrale</option><option value="W">Settimanale</option><option value="Y">Annuale</option></select><label>Prima scadenza</label><input id="rt_first" type="date" value="'+b(B[0]?C(B[0].dueDate):C(h.date||k))+'"><button class="ghost" id="rt_build">Ricalcola rate</button></div><div id="rt_preview" class="gi-rlist muted small">—</div></div><div id="p_manual" style="display:'+(U!=="rate"?"block":"none")+'"><div class="mrow mini"><button class="ghost" id="mn_add">Aggiungi scaglione</button></div><div id="mn_list" class="gi-rlist"></div></div></div><div class="gi-foot"><div><div id="tot_prog" class="small muted">Programmato: 0€</div><div id="tot_chk"  class="small muted">Totale VSS: 0€</div></div><div style="display:flex;gap:8px">'+(h.id?'<button class="ghost danger" id="m_del">Elimina</button>':"")+'<button id="m_save">Salva</button></div></div></div></div>';showOverlay(q);const le=document.documentElement.style.overflow;document.documentElement.style.overflow="hidden";function a(){document.documentElement.style.overflow=le,hideOverlay()}(function(){const c=g("gi_client_select");c.innerHTML='<option value="">— seleziona cliente —</option>'+L.map(N=>'<option value="'+b(N.id)+'">'+b(N.name)+"</option>").join("");const f=h.clientId||h.client_id||"";if(f&&(c.value=String(f)),!c.value&&h.clientName){const N=L.find(R=>String(R.name).trim().toLowerCase()===String(h.clientName).trim().toLowerCase());N&&(c.value=String(N.id))}})(),T&&T._fromPerc&&(g("acc_type").value="perc"),Array.from(document.querySelectorAll('input[name="pmode"]')).forEach(r=>{r.addEventListener("change",()=>{const c=document.querySelector('input[name="pmode"]:checked').value==="rate";g("p_rate").style.display=c?"block":"none",g("p_manual").style.display=c?"none":"block",o()})});function e(r,c){const f=new Date(r);return f.setMonth(f.getMonth()+c),f}function i(r,c){const f=new Date(r);return f.setDate(f.getDate()+c*7),f}function t(r,c){const f=new Date(r);return f.setMonth(f.getMonth()+c*3),f}function s(r,c){const f=new Date(r);return f.setFullYear(f.getFullYear()+c),f}function w(){const r=Math.max(1,Number(g("rt_n").value||0)),c=g("rt_freq").value,f=new Date(g("rt_first").value||k),N=Math.max(0,Number(g("m_vss").value||0)),R=u(),te=Math.max(0,N-R),_=Math.round(te/r),j=[];for(let ne=0;ne<r;ne++){let W;c==="M"?W=e(f,ne):c==="Q"?W=t(f,ne):c==="W"?W=i(f,ne):W=s(f,ne),j.push({dueDate:W.toISOString(),amount:_,note:"Rata "+(ne+1)+"/"+r,kind:"installment"})}return p(j),j}function p(r){g("rt_preview").innerHTML=r.map(c=>"<div>"+new Date(c.dueDate).toLocaleDateString("it-IT")+" · "+G(c.amount)+' <span class="muted">'+b(c.note||"")+"</span></div>").join(""),g("rt_preview")._data=r,o()}function d(r){const c=g("mn_list");c.innerHTML="",r.forEach((f,N)=>{const R=document.createElement("div");R.className="gi-r",R.innerHTML='<input type="date" data-k="dueDate" value="'+b(C(f.dueDate))+'"><input type="number" step="1" data-k="amount" value="'+b(Number(f.amount||0))+'" style="width:120px"><input type="text" data-k="note"   value="'+b(f.note||"")+'" placeholder="nota" style="flex:1"><button class="ghost" data-del="'+N+'">✕</button>',c.appendChild(R)}),c.querySelectorAll("[data-del]").forEach(f=>{f.onclick=()=>{const N=Number(f.getAttribute("data-del")),R=c._data||[];R.splice(N,1),d(R)}}),c.oninput=()=>{const f=c._data||[];Array.from(c.children).forEach((R,te)=>{const _=f[te];if(!_)return;const j=R.querySelector('[data-k="dueDate"]').value,ne=Number(R.querySelector('[data-k="amount"]').value||0),W=R.querySelector('[data-k="note"]').value;_.dueDate=new Date(j).toISOString(),_.amount=Math.round(ne),_.note=W}),o()},c._data=r,o()}if(g("m_date").value=b(C(h.date||k)),g("m_vss").value=b(Number(h.vssTotal||0)),g("m_srv").value=b(h.services||""),g("acc_type").value=T&&T._fromPerc?"perc":"abs",g("acc_value").value=T?T._fromPerc?T._rawPerc:T.amount:0,g("acc_date").value=b(C(T?T.dueDate:h.date||k)),g("acc_note").value=T?b(T.note||"Acconto"):"Acconto",U==="rate"){const r=B.length||12;g("rt_n").value=r,g("rt_first").value=B[0]?b(C(B[0].dueDate)):b(C(h.date||k)),p(B.length?B:w())}else d(B);g("rt_build").onclick=()=>p(w()),g("mn_add").onclick=()=>{const c=g("mn_list")._data||[];c.push({dueDate:new Date().toISOString(),amount:0,note:"",kind:"manual"}),d(c)},g("m_close").onclick=a;function u(){if(!g("acc_enable").checked)return 0;const r=Math.max(0,Number(g("m_vss").value||0)),c=g("acc_type").value,f=Number(g("acc_value").value||0);return Math.round(c==="perc"?r*(f/100):f)}function n(){const r=[];if(g("acc_enable").checked){const f=u();r.push({dueDate:new Date(g("acc_date").value||k).toISOString(),amount:f,note:g("acc_note").value||"Acconto",kind:"deposit",_fromPerc:g("acc_type").value==="perc",_rawPerc:Number(g("acc_value").value||0)})}if(document.querySelector('input[name="pmode"]:checked').value==="rate"){const f=(g("rt_preview")._data||[]).map(N=>Object.assign({},N));return r.concat(f)}else{const f=(g("mn_list")._data||[]).map(N=>Object.assign({kind:"manual"},N));return r.concat(f)}}function o(){const r=Math.max(0,Number(g("m_vss").value||0)),c=n(),f=Math.round(c.reduce((N,R)=>N+Number(R.amount||0),0));g("tot_prog").textContent="Programmato: "+G(f),g("tot_chk").textContent="Totale VSS: "+G(r)+(f===r?" OK":" (manca "+G(r-f)+")"),g("m_save").disabled=f!==r||!g("gi_client_select").value}if(["m_vss","acc_enable","acc_type","acc_value","acc_date","rt_n","rt_freq","rt_first"].forEach(r=>{const c=g(r);c&&c.addEventListener("input",o)}),g("gi_client_select").addEventListener("change",o),o(),g("m_save").onclick=()=>{const r=g("gi_client_select").value||"",c=L.find(N=>String(N.id)===String(r));if(!c){me("Seleziona un cliente");return}const f={id:h.id||void 0,date:new Date(g("m_date").value||k).toISOString(),clientId:c.id,clientName:c.name,vssTotal:Math.round(Number(g("m_vss").value||0)),services:g("m_srv").value||"",schedule:n()};Promise.resolve($e("/api/gi",f)).then(()=>{a(),haptic("light"),y()}).catch(N=>{logger.error(N),me("Errore salvataggio")})},h.id){const r=g("m_del");r&&(r.onclick=async()=>{if(!confirm("Eliminare definitivamente questa vendita?"))return;const c=h?JSON.parse(JSON.stringify(h)):null;try{if(await zt("/api/gi?id="+encodeURIComponent(h.id)).catch(()=>$e("/api/gi/delete",{id:h.id})),a(),me("Vendita eliminata"),y(),typeof showUndo=="function"&&c){const f={date:new Date(c.date||c.createdAt||new Date).toISOString(),clientId:c.clientId,clientName:c.clientName,vssTotal:Math.round(Number(c.vssTotal||0)),services:c.services||"",schedule:Array.isArray(c.schedule)?c.schedule:[]};showUndo("Vendita eliminata",function(){return $e("/api/gi",f).then(function(){y()})},5e3)}}catch(f){logger.error(f),me("Errore eliminazione")}})}}function $(){document.querySelectorAll("[data-edit]").forEach(v=>{v.addEventListener("click",()=>{const h=v.getAttribute("data-edit");I(h)})})}document.addEventListener("gi:edit",function(v){const h=v&&v.detail&&v.detail.id;h&&I(h)}),g("gi_add").onclick=()=>{E({title:"Nuova vendita"})};function I(v){Ie("/api/gi?from=1900-01-01&to=2999-12-31").then(h=>{const P=(h&&h.sales||[]).find(T=>String(T.id)===String(v));if(!P){me("Vendita non trovata");return}E({title:"Modifica vendita",sale:P})})}H("gi",()=>{haptic("light"),y()}),(g("gi_cons")||{}).onchange=()=>{haptic("light"),y()},A().then(y)}window.viewGI=window.viewGI||ve;function be(){if(!Pe())return l();document.title="Battle Plan – Report",m.innerHTML=We()+'<div class="wrap"><div class="card"><b>Sezioni da includere</b><div id="rep_toggles" class="row" style="margin-top:8px; gap:8px; flex-wrap:wrap"><button class="pill" data-type="mensile" id="tog_mese">Mese</button><button class="pill" data-type="trimestrale" id="tog_trimestre">Trimestre</button><button class="pill" data-type="semestrale" id="tog_semestre">Semestre</button><button class="pill" data-type="annuale" id="tog_anno">Anno</button></div></div><div class="card"><b>Report</b><div class="row" style="margin-top:8px"><div style="min-width:320px"><label>Oggetto email</label><input id="report_subject" placeholder="Report BP"></div></div><div class="row" style="margin-top:8px; flex-wrap:wrap"><div style="flex:1 1 100%; min-width:0"><label>Corpo email</label><textarea id="report_body" rows="12" placeholder="Testo del report…" style="width:100%; box-sizing:border-box; overflow:auto; resize:vertical; max-height:70vh; white-space:pre-wrap; word-break:break-word"></textarea></div></div><div class="row" id="report-actions" style="gap:8px;margin-top:8px;flex-wrap:wrap"><button class="ghost" id="rep_copy">Copia report</button><span style="flex:0 0 8px"></span><button class="ghost" id="rep_gmail_web">Gmail Web</button><button class="ghost" id="rep_gmail_app">Gmail App</button></div></div></div>',qe();var g=[],b={mensile:!1,trimestrale:!1,semestrale:!1,annuale:!1},G=[{k:"VSS",money:!0,label:"VSS"},{k:"VSDPersonale",money:!0,label:"VSDPersonale"},{k:"VSDIndiretto",money:!0,label:"VSDIndiretto"},{k:"GI",money:!0,label:"GI"},{k:"Telefonate",money:!1,label:"Telefonate"},{k:"AppFissati",money:!1,label:"AppFissati"},{k:"AppFatti",money:!1,label:"AppFatti"},{k:"CorsiLeadership",money:!1,label:"CorsiLeadership"},{k:"iProfile",money:!1,label:"iProfile"},{k:"MBS",money:!1,label:"MBS"},{k:"NNCF",money:!1,label:"NNCF"}];function C(_){return document.getElementById(_)}var z=C("report_body");function L(_,j){var ne=new Date(_.getTime());return ne.setDate(ne.getDate()+j),ne}function A(_){return ot(_.getFullYear(),Ve(_))}function M(_){var j=A(_);return A(L(j.start,7))}function S(_){var j=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];return j[_.getMonth()]}function y(_){return Math.floor(_.getMonth()/3)+1}function E(_){return _.getMonth()<6?1:2}function $(_){var j=_.getDay();return j===5||j===6||j===0}function I(_,j){return _==="mensile"?{start:It(j),end:Ct(j)}:_==="trimestrale"?{start:gt(j),end:xt(j)}:_==="semestrale"?{start:ht(j),end:Et(j)}:{start:Tt(j),end:ft(j)}}function v(_,j){return j>=L(_,-7)&&j<=L(_,5)}function h(_,j){var ne=I(_,j),W=I(_,L(ne.start,-1)),Z=I(_,L(ne.end,1)),ue=v(W.end,j),ce=v(ne.end,j);return ue&&!ce?{closing:W,next:ne}:{closing:ne,next:Z}}function P(_,j,ne){for(var W=0;W<g.length;W++){var Z=g[W];if(Z.type===_&&He(Z.startDate)===He(j)&&He(Z.endDate)===He(ne))return Z}return null}function T(_,j){var ne=_&&_[j];return Number(ne||0)}function B(_){return je(_)+"€"}function x(_,j){var ne=G.some(function(W){return W.k===_&&W.money});return ne?B(j):je(j)}function U(_,j){return _>j?"↑":_<j?"↓":"="}function k(_,j,ne,W){var Z=P(j,ne,W)||{},ue=Z.indicatorsPrev||{},ce=Z.indicatorsCons||{},ye=[_,""];return G.forEach(function(_e){var Be=T(ue,_e.k),ke=T(ce,_e.k);ye.push(_e.label+" "+x(_e.k,ke)+" vs "+x(_e.k,Be)+" di previsionali ("+U(ke,Be)+")")}),ye.push("Note:"),ye.join("\n")}function q(_,j,ne,W){var Z=P(j,ne,W)||{},ue=Z.indicatorsPrev||{},ce=[_,""];return G.forEach(function(ye){ce.push(ye.label+" "+x(ye.k,T(ue,ye.k)))}),ce.push("Possibili note:"),ce.join("\n")}function le(_){return"BP CONSUNTIVO SETT. "+Ve(_)+" "+_.getFullYear()}function a(_){return"BP PREVISIONALE SETT. "+Ve(_)+" "+_.getFullYear()}function e(_){return"BP CONSUNTIVO "+S(_)+" "+_.getFullYear()}function i(_){var j=S(_);return"BP PREVISIONALE "+j+" "+_.getFullYear()}function t(_){return"BP CONSUNTIVO T"+y(_)+" "+_.getFullYear()}function s(_){return"BP PREVISIONALE T"+y(_)+" "+_.getFullYear()}function w(_){return"BP CONSUNTIVO S"+E(_)+" "+_.getFullYear()}function p(_){return"BP PREVISIONALE S"+E(_)+" "+_.getFullYear()}function d(_){return"BP CONSUNTIVO "+_.getFullYear()}function u(_){return"BP PREVISIONALE "+_.getFullYear()}function n(){var _=new Date,j=[];if($(_)){var ne=A(_),W=M(_);j.push(k(le(ne.start),"settimanale",ne.start,ne.end)),j.push(q(a(W.start),"settimanale",W.start,W.end))}function Z(ue,ce,ye){var _e=h(ue,_);j.push(k(ce(_e.closing.start),ue,_e.closing.start,_e.closing.end)),j.push(q(ye(_e.next.start),ue,_e.next.start,_e.next.end))}b.mensile&&Z("mensile",e,i),b.trimestrale&&Z("trimestrale",t,s),b.semestrale&&Z("semestrale",w,p),b.annuale&&Z("annuale",d,u),z.value=j.join("\n\n")+(j.length?"\n":"")}function o(_,j){_.classList.toggle("active",!!j),_.style.opacity=j?"1":"0.65"}function r(){o(C("tog_mese"),b.mensile),o(C("tog_trimestre"),b.trimestrale),o(C("tog_semestre"),b.semestrale),o(C("tog_anno"),b.annuale)}function c(){var _=new Date;function j(ne){var W=I(ne,_),Z=I(ne,L(W.start,-1));return v(W.end,_)||v(Z.end,_)}b.mensile=j("mensile"),b.trimestrale=j("trimestrale"),b.semestrale=j("semestrale"),b.annuale=j("annuale"),r()}function f(){function _(j){var ne=j.currentTarget.getAttribute("data-type");b[ne]=!b[ne],r(),n()}C("tog_mese").onclick=_,C("tog_trimestre").onclick=_,C("tog_semestre").onclick=_,C("tog_anno").onclick=_}function N(_){return encodeURIComponent(String(_||""))}function R(){var _=C("rep_gmail_web"),j=C("rep_gmail_app"),ne=C("rep_copy");ne&&(ne.onclick=function(){try{navigator.clipboard.writeText(z.value||"");var W=ne.textContent;ne.textContent="Copiato!",setTimeout(function(){ne.textContent=W},1200)}catch(Z){}}),!(!_||!j)&&Ie("/api/users_emails").then(function(W){var Z=(W&&W.emails||(W&&W.users||[]).map(function(ye){return ye.email})).filter(Boolean).join(",");function ue(){return C("report_subject").value||"Report BP"}function ce(){return z.value||""}_.onclick=function(){try{navigator.clipboard.writeText(ce())}catch(_e){}var ye="https://mail.google.com/mail/?view=cm&fs=1&tf=1&su="+N(ue())+"&cc="+N(Z)+"&body="+N(ce());window.open(ye,"_blank"),document.dispatchEvent(new Event("report:composed"))},j.onclick=function(){try{navigator.clipboard.writeText(ce())}catch(_e){}var ye="googlegmail:///co?subject="+N(ue())+"&cc="+N(Z)+"&body="+N(ce());location.href=ye,document.dispatchEvent(new Event("report:composed")),setTimeout(function(){document.hidden||(location.href="mailto:?subject="+N(ue())+"&cc="+N(Z)+"&body="+N(ce()),document.dispatchEvent(new Event("report:composed")))},1200)}})}function te(){Ie("/api/periods").then(function(_){g=_&&_.periods||[],c(),f(),n(),R()})}te()}function ze(){var g=Pe();if(!g)return l();if(document.title="Battle Plan – Utenti",g.role!=="admin"){m.innerHTML=We()+'<div class="wrap"><div class="card"><b>Il mio profilo</b><div class="row" style="margin-top:8px"><div><label>Nome</label><input id="p_name" type="text" value="'+Te(g.name||"")+'"></div><div><label>Email</label><input id="p_email" type="email" value="'+Te(g.email||"")+'"></div></div><div class="row"><div><label>Nuova password</label><input id="p_pwd" type="password" placeholder="Lascia vuoto per non cambiare"></div><div class="right" style="align-self:flex-end"><button id="p_save">Aggiorna</button></div></div><div class="row"><div><label>Ruolo</label><input value="'+Te(g.role||"consultant")+'" disabled></div><div><label>Grade</label><input value="'+Te(g.grade||"junior")+'" disabled></div></div></div></div>',qe(),Ze("#p_save").onclick=function(){var C=Ze("#p_name").value.trim(),z=Ze("#p_email").value.trim(),L=Ze("#p_pwd").value,A={id:g.id,name:C,email:z};L&&(A.password=L),$e("/api/users",A).then(function(){me("Profilo aggiornato"),window.addXP(3);var M=Pe();M&&(M.name=C,M.email=z,localStorage.setItem("user",JSON.stringify(M)));try{document.dispatchEvent(new Event("user:profile-updated"))}catch(S){}}).catch(function(M){logger.error(M),me("Errore aggiornamento")})};return}m.innerHTML=We()+'<div class="wrap"><div class="card"><b>Gestione utenti</b><div id="users_list" class="row" style="margin-top:8px"></div></div></div>',qe();function b(C){var z=Te(C.name||C.email||"user_"+C.id),L=C.grade==="senior"?"senior":"junior",A=C.role==="admin"?"admin":"consultant";return'<div class="card" style="flex:1 1 380px"><div><b>'+z+'</b> <span class="small muted">('+Te(A)+')</span></div><div class="row" style="margin-top:6px"><div><label>Nome</label><input data-nfor="'+C.id+'" type="text" value="'+Te(C.name||"")+'"></div><div><label>Email</label><input data-efor="'+C.id+'" type="email" value="'+Te(C.email||"")+'"></div></div><div class="row"><div><label>Nuova password</label><input data-pfor="'+C.id+'" type="password" placeholder="(opzionale)"></div><div><label>Grade</label><select data-gfor="'+C.id+'"><option value="junior"'+(L==="junior"?" selected":"")+'>Junior</option><option value="senior"'+(L==="senior"?" selected":"")+'>Senior</option></select></div><div><label>Ruolo</label><select data-rfor="'+C.id+'"><option value="consultant"'+(A==="consultant"?" selected":"")+'>Consulente</option><option value="admin"'+(A==="admin"?" selected":"")+'>Admin</option></select></div><div class="right" style="align-self:flex-end"><button class="ghost" data-save="'+C.id+'">Aggiorna</button> <button class="danger" data-del="'+C.id+'" title="Elimina utente">Elimina</button></div></div></div>'}function G(){Ie("/api/users").then(function(C){var z=C&&C.users||[],L=Ze("#users_list");L&&(L.innerHTML=z.map(b).join(""),Dt("[data-save]").forEach(function(A){A.addEventListener("click",function(){var M=A.getAttribute("data-save"),S=(Ze('input[data-nfor="'+M+'"]')||{}).value||"",y=(Ze('input[data-efor="'+M+'"]')||{}).value||"",E=(Ze('select[data-gfor="'+M+'"]')||{}).value||"junior",$=(Ze('select[data-rfor="'+M+'"]')||{}).value||"consultant",I=Ze('input[data-pfor="'+M+'"]'),v=I?I.value:"",h={id:M,name:S,email:y,grade:E,role:$};v&&(h.password=v),$e("/api/users",h).then(function(){me("Aggiornato"),window.addXP(5),I&&(I.value="")}).catch(function(P){logger.error(P),me("Errore aggiornamento")})})}),Dt("[data-del]").forEach(function(A){A.addEventListener("click",function(){var M=A.getAttribute("data-del");if(confirm("Eliminare definitivamente questo utente?")){var S=(Array.isArray(z)?z:[]).find(function(y){return String(y.id)===String(M)});fetch("/api/users?id="+encodeURIComponent(M),{method:"DELETE",headers:{Authorization:"Bearer "+vt()}}).then(function(y){if(!y.ok)throw new Error("HTTP "+y.status);return y.json()}).then(function(){if(me("Utente eliminato"),G(),typeof showUndo=="function"&&S){var y={id:S.id,name:S.name,email:S.email,grade:S.grade,role:S.role};showUndo("Utente eliminato",function(){return $e("/api/users",y).then(function(){G()})},5e3)}}).catch(function(y){logger.error(y),me("Errore eliminazione")})}})}))})}G()}window.viewHome=ie,window.viewCalendar=ee,window.viewPeriods=he,window.viewAppointments=ge,window.viewLeaderboard=re,window.viewClients=oe,window.viewTeam=pe,window.viewCommissions=de,window.viewVendite=Ce,window.viewReport=be,window.viewUsers=ze,window.toggleDrawer=wt,window.logout=Rt,window.rerenderTopbarSoon=nn,document.addEventListener("DOMContentLoaded",function(){Pe()?(qe(),ie()):l()})})();export{an as __vite_legacy_guard};
