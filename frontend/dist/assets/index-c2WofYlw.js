var Ir=Object.defineProperty;var Mr=(n,t,e)=>t in n?Ir(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var mt=(n,t,e)=>Mr(n,typeof t!="symbol"?t+"":t,e);function ch(){import.meta.url,import("_").catch(()=>1),(async function*(){})().next()}(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function e(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(o){if(o.ep)return;o.ep=!0;const s=e(o);fetch(o.href,s)}})();/*!
 * @kurkle/color v0.3.4
 * https://github.com/kurkle/color#readme
 * (c) 2024 Jukka Kurkela
 * Released under the MIT License
 */function Jn(n){return n+.5|0}const Ye=(n,t,e)=>Math.max(Math.min(n,e),t);function Mn(n){return Ye(Jn(n*2.55),0,255)}function Xe(n){return Ye(Jn(n*255),0,255)}function Ne(n){return Ye(Jn(n/2.55)/100,0,1)}function qo(n){return Ye(Jn(n*100),0,100)}const ye={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,A:10,B:11,C:12,D:13,E:14,F:15,a:10,b:11,c:12,d:13,e:14,f:15},ho=[..."0123456789ABCDEF"],Er=n=>ho[n&15],Pr=n=>ho[(n&240)>>4]+ho[n&15],Qn=n=>(n&240)>>4===(n&15),Ar=n=>Qn(n.r)&&Qn(n.g)&&Qn(n.b)&&Qn(n.a);function Br(n){var t=n.length,e;return n[0]==="#"&&(t===4||t===5?e={r:255&ye[n[1]]*17,g:255&ye[n[2]]*17,b:255&ye[n[3]]*17,a:t===5?ye[n[4]]*17:255}:(t===7||t===9)&&(e={r:ye[n[1]]<<4|ye[n[2]],g:ye[n[3]]<<4|ye[n[4]],b:ye[n[5]]<<4|ye[n[6]],a:t===9?ye[n[7]]<<4|ye[n[8]]:255})),e}const Lr=(n,t)=>n<255?t(n):"";function Or(n){var t=Ar(n)?Er:Pr;return n?"#"+t(n.r)+t(n.g)+t(n.b)+Lr(n.a,t):void 0}const Fr=/^(hsla?|hwb|hsv)\(\s*([-+.e\d]+)(?:deg)?[\s,]+([-+.e\d]+)%[\s,]+([-+.e\d]+)%(?:[\s,]+([-+.e\d]+)(%)?)?\s*\)$/;function ba(n,t,e){const i=t*Math.min(e,1-e),o=(s,a=(s+n/30)%12)=>e-i*Math.max(Math.min(a-3,9-a,1),-1);return[o(0),o(8),o(4)]}function Nr(n,t,e){const i=(o,s=(o+n/60)%6)=>e-e*t*Math.max(Math.min(s,4-s,1),0);return[i(5),i(3),i(1)]}function Rr(n,t,e){const i=ba(n,1,.5);let o;for(t+e>1&&(o=1/(t+e),t*=o,e*=o),o=0;o<3;o++)i[o]*=1-t-e,i[o]+=t;return i}function zr(n,t,e,i,o){return n===o?(t-e)/i+(t<e?6:0):t===o?(e-n)/i+2:(n-t)/i+4}function Mo(n){const e=n.r/255,i=n.g/255,o=n.b/255,s=Math.max(e,i,o),a=Math.min(e,i,o),r=(s+a)/2;let l,c,d;return s!==a&&(d=s-a,c=r>.5?d/(2-s-a):d/(s+a),l=zr(e,i,o,d,s),l=l*60+.5),[l|0,c||0,r]}function Eo(n,t,e,i){return(Array.isArray(t)?n(t[0],t[1],t[2]):n(t,e,i)).map(Xe)}function Po(n,t,e){return Eo(ba,n,t,e)}function Vr(n,t,e){return Eo(Rr,n,t,e)}function Ur(n,t,e){return Eo(Nr,n,t,e)}function ya(n){return(n%360+360)%360}function Hr(n){const t=Fr.exec(n);let e=255,i;if(!t)return;t[5]!==i&&(e=t[6]?Mn(+t[5]):Xe(+t[5]));const o=ya(+t[2]),s=+t[3]/100,a=+t[4]/100;return t[1]==="hwb"?i=Vr(o,s,a):t[1]==="hsv"?i=Ur(o,s,a):i=Po(o,s,a),{r:i[0],g:i[1],b:i[2],a:e}}function jr(n,t){var e=Mo(n);e[0]=ya(e[0]+t),e=Po(e),n.r=e[0],n.g=e[1],n.b=e[2]}function Wr(n){if(!n)return;const t=Mo(n),e=t[0],i=qo(t[1]),o=qo(t[2]);return n.a<255?"hsla(".concat(e,", ").concat(i,"%, ").concat(o,"%, ").concat(Ne(n.a),")"):"hsl(".concat(e,", ").concat(i,"%, ").concat(o,"%)")}const Go={x:"dark",Z:"light",Y:"re",X:"blu",W:"gr",V:"medium",U:"slate",A:"ee",T:"ol",S:"or",B:"ra",C:"lateg",D:"ights",R:"in",Q:"turquois",E:"hi",P:"ro",O:"al",N:"le",M:"de",L:"yello",F:"en",K:"ch",G:"arks",H:"ea",I:"ightg",J:"wh"},Xo={OiceXe:"f0f8ff",antiquewEte:"faebd7",aqua:"ffff",aquamarRe:"7fffd4",azuY:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"0",blanKedOmond:"ffebcd",Xe:"ff",XeviTet:"8a2be2",bPwn:"a52a2a",burlywood:"deb887",caMtXe:"5f9ea0",KartYuse:"7fff00",KocTate:"d2691e",cSO:"ff7f50",cSnflowerXe:"6495ed",cSnsilk:"fff8dc",crimson:"dc143c",cyan:"ffff",xXe:"8b",xcyan:"8b8b",xgTMnPd:"b8860b",xWay:"a9a9a9",xgYF:"6400",xgYy:"a9a9a9",xkhaki:"bdb76b",xmagFta:"8b008b",xTivegYF:"556b2f",xSange:"ff8c00",xScEd:"9932cc",xYd:"8b0000",xsOmon:"e9967a",xsHgYF:"8fbc8f",xUXe:"483d8b",xUWay:"2f4f4f",xUgYy:"2f4f4f",xQe:"ced1",xviTet:"9400d3",dAppRk:"ff1493",dApskyXe:"bfff",dimWay:"696969",dimgYy:"696969",dodgerXe:"1e90ff",fiYbrick:"b22222",flSOwEte:"fffaf0",foYstWAn:"228b22",fuKsia:"ff00ff",gaRsbSo:"dcdcdc",ghostwEte:"f8f8ff",gTd:"ffd700",gTMnPd:"daa520",Way:"808080",gYF:"8000",gYFLw:"adff2f",gYy:"808080",honeyMw:"f0fff0",hotpRk:"ff69b4",RdianYd:"cd5c5c",Rdigo:"4b0082",ivSy:"fffff0",khaki:"f0e68c",lavFMr:"e6e6fa",lavFMrXsh:"fff0f5",lawngYF:"7cfc00",NmoncEffon:"fffacd",ZXe:"add8e6",ZcSO:"f08080",Zcyan:"e0ffff",ZgTMnPdLw:"fafad2",ZWay:"d3d3d3",ZgYF:"90ee90",ZgYy:"d3d3d3",ZpRk:"ffb6c1",ZsOmon:"ffa07a",ZsHgYF:"20b2aa",ZskyXe:"87cefa",ZUWay:"778899",ZUgYy:"778899",ZstAlXe:"b0c4de",ZLw:"ffffe0",lime:"ff00",limegYF:"32cd32",lRF:"faf0e6",magFta:"ff00ff",maPon:"800000",VaquamarRe:"66cdaa",VXe:"cd",VScEd:"ba55d3",VpurpN:"9370db",VsHgYF:"3cb371",VUXe:"7b68ee",VsprRggYF:"fa9a",VQe:"48d1cc",VviTetYd:"c71585",midnightXe:"191970",mRtcYam:"f5fffa",mistyPse:"ffe4e1",moccasR:"ffe4b5",navajowEte:"ffdead",navy:"80",Tdlace:"fdf5e6",Tive:"808000",TivedBb:"6b8e23",Sange:"ffa500",SangeYd:"ff4500",ScEd:"da70d6",pOegTMnPd:"eee8aa",pOegYF:"98fb98",pOeQe:"afeeee",pOeviTetYd:"db7093",papayawEp:"ffefd5",pHKpuff:"ffdab9",peru:"cd853f",pRk:"ffc0cb",plum:"dda0dd",powMrXe:"b0e0e6",purpN:"800080",YbeccapurpN:"663399",Yd:"ff0000",Psybrown:"bc8f8f",PyOXe:"4169e1",saddNbPwn:"8b4513",sOmon:"fa8072",sandybPwn:"f4a460",sHgYF:"2e8b57",sHshell:"fff5ee",siFna:"a0522d",silver:"c0c0c0",skyXe:"87ceeb",UXe:"6a5acd",UWay:"708090",UgYy:"708090",snow:"fffafa",sprRggYF:"ff7f",stAlXe:"4682b4",tan:"d2b48c",teO:"8080",tEstN:"d8bfd8",tomato:"ff6347",Qe:"40e0d0",viTet:"ee82ee",JHt:"f5deb3",wEte:"ffffff",wEtesmoke:"f5f5f5",Lw:"ffff00",LwgYF:"9acd32"};function Yr(){const n={},t=Object.keys(Xo),e=Object.keys(Go);let i,o,s,a,r;for(i=0;i<t.length;i++){for(a=r=t[i],o=0;o<e.length;o++)s=e[o],r=r.replace(s,Go[s]);s=parseInt(Xo[a],16),n[r]=[s>>16&255,s>>8&255,s&255]}return n}let ti;function $r(n){ti||(ti=Yr(),ti.transparent=[0,0,0,0]);const t=ti[n.toLowerCase()];return t&&{r:t[0],g:t[1],b:t[2],a:t.length===4?t[3]:255}}const qr=/^rgba?\(\s*([-+.\d]+)(%)?[\s,]+([-+.e\d]+)(%)?[\s,]+([-+.e\d]+)(%)?(?:[\s,/]+([-+.e\d]+)(%)?)?\s*\)$/;function Gr(n){const t=qr.exec(n);let e=255,i,o,s;if(t){if(t[7]!==i){const a=+t[7];e=t[8]?Mn(a):Ye(a*255,0,255)}return i=+t[1],o=+t[3],s=+t[5],i=255&(t[2]?Mn(i):Ye(i,0,255)),o=255&(t[4]?Mn(o):Ye(o,0,255)),s=255&(t[6]?Mn(s):Ye(s,0,255)),{r:i,g:o,b:s,a:e}}}function Xr(n){return n&&(n.a<255?"rgba(".concat(n.r,", ").concat(n.g,", ").concat(n.b,", ").concat(Ne(n.a),")"):"rgb(".concat(n.r,", ").concat(n.g,", ").concat(n.b,")"))}const Gi=n=>n<=.0031308?n*12.92:Math.pow(n,1/2.4)*1.055-.055,mn=n=>n<=.04045?n/12.92:Math.pow((n+.055)/1.055,2.4);function Kr(n,t,e){const i=mn(Ne(n.r)),o=mn(Ne(n.g)),s=mn(Ne(n.b));return{r:Xe(Gi(i+e*(mn(Ne(t.r))-i))),g:Xe(Gi(o+e*(mn(Ne(t.g))-o))),b:Xe(Gi(s+e*(mn(Ne(t.b))-s))),a:n.a+e*(t.a-n.a)}}function ei(n,t,e){if(n){let i=Mo(n);i[t]=Math.max(0,Math.min(i[t]+i[t]*e,t===0?360:1)),i=Po(i),n.r=i[0],n.g=i[1],n.b=i[2]}}function wa(n,t){return n&&Object.assign(t||{},n)}function Ko(n){var t={r:0,g:0,b:0,a:255};return Array.isArray(n)?n.length>=3&&(t={r:n[0],g:n[1],b:n[2],a:255},n.length>3&&(t.a=Xe(n[3]))):(t=wa(n,{r:0,g:0,b:0,a:1}),t.a=Xe(t.a)),t}function Jr(n){return n.charAt(0)==="r"?Gr(n):Hr(n)}class jn{constructor(t){if(t instanceof jn)return t;const e=typeof t;let i;e==="object"?i=Ko(t):e==="string"&&(i=Br(t)||$r(t)||Jr(t)),this._rgb=i,this._valid=!!i}get valid(){return this._valid}get rgb(){var t=wa(this._rgb);return t&&(t.a=Ne(t.a)),t}set rgb(t){this._rgb=Ko(t)}rgbString(){return this._valid?Xr(this._rgb):void 0}hexString(){return this._valid?Or(this._rgb):void 0}hslString(){return this._valid?Wr(this._rgb):void 0}mix(t,e){if(t){const i=this.rgb,o=t.rgb;let s;const a=e===s?.5:e,r=2*a-1,l=i.a-o.a,c=((r*l===-1?r:(r+l)/(1+r*l))+1)/2;s=1-c,i.r=255&c*i.r+s*o.r+.5,i.g=255&c*i.g+s*o.g+.5,i.b=255&c*i.b+s*o.b+.5,i.a=a*i.a+(1-a)*o.a,this.rgb=i}return this}interpolate(t,e){return t&&(this._rgb=Kr(this._rgb,t._rgb,e)),this}clone(){return new jn(this.rgb)}alpha(t){return this._rgb.a=Xe(t),this}clearer(t){const e=this._rgb;return e.a*=1-t,this}greyscale(){const t=this._rgb,e=Jn(t.r*.3+t.g*.59+t.b*.11);return t.r=t.g=t.b=e,this}opaquer(t){const e=this._rgb;return e.a*=1+t,this}negate(){const t=this._rgb;return t.r=255-t.r,t.g=255-t.g,t.b=255-t.b,this}lighten(t){return ei(this._rgb,2,t),this}darken(t){return ei(this._rgb,2,-t),this}saturate(t){return ei(this._rgb,1,t),this}desaturate(t){return ei(this._rgb,1,-t),this}rotate(t){return jr(this._rgb,t),this}}/*!
 * Chart.js v4.5.0
 * https://www.chartjs.org
 * (c) 2025 Chart.js Contributors
 * Released under the MIT License
 */function Ae(){}const Zr=(()=>{let n=0;return()=>n++})();function At(n){return n==null}function $t(n){if(Array.isArray&&Array.isArray(n))return!0;const t=Object.prototype.toString.call(n);return t.slice(0,7)==="[object"&&t.slice(-6)==="Array]"}function Bt(n){return n!==null&&Object.prototype.toString.call(n)==="[object Object]"}function Xt(n){return(typeof n=="number"||n instanceof Number)&&isFinite(+n)}function be(n,t){return Xt(n)?n:t}function Tt(n,t){return typeof n>"u"?t:n}const Qr=(n,t)=>typeof n=="string"&&n.endsWith("%")?parseFloat(n)/100:+n/t,_a=(n,t)=>typeof n=="string"&&n.endsWith("%")?parseFloat(n)/100*t:+n;function jt(n,t,e){if(n&&typeof n.call=="function")return n.apply(e,t)}function Ut(n,t,e,i){let o,s,a;if($t(n))for(s=n.length,o=0;o<s;o++)t.call(e,n[o],o);else if(Bt(n))for(a=Object.keys(n),s=a.length,o=0;o<s;o++)t.call(e,n[a[o]],a[o])}function Mi(n,t){let e,i,o,s;if(!n||!t||n.length!==t.length)return!1;for(e=0,i=n.length;e<i;++e)if(o=n[e],s=t[e],o.datasetIndex!==s.datasetIndex||o.index!==s.index)return!1;return!0}function Ei(n){if($t(n))return n.map(Ei);if(Bt(n)){const t=Object.create(null),e=Object.keys(n),i=e.length;let o=0;for(;o<i;++o)t[e[o]]=Ei(n[e[o]]);return t}return n}function xa(n){return["__proto__","prototype","constructor"].indexOf(n)===-1}function tl(n,t,e,i){if(!xa(n))return;const o=t[n],s=e[n];Bt(o)&&Bt(s)?Wn(o,s,i):t[n]=Ei(s)}function Wn(n,t,e){const i=$t(t)?t:[t],o=i.length;if(!Bt(n))return n;e=e||{};const s=e.merger||tl;let a;for(let r=0;r<o;++r){if(a=i[r],!Bt(a))continue;const l=Object.keys(a);for(let c=0,d=l.length;c<d;++c)s(l[c],n,a,e)}return n}function On(n,t){return Wn(n,t,{merger:el})}function el(n,t,e){if(!xa(n))return;const i=t[n],o=e[n];Bt(i)&&Bt(o)?On(i,o):Object.prototype.hasOwnProperty.call(t,n)||(t[n]=Ei(o))}const Jo={"":n=>n,x:n=>n.x,y:n=>n.y};function nl(n){const t=n.split("."),e=[];let i="";for(const o of t)i+=o,i.endsWith("\\")?i=i.slice(0,-1)+".":(e.push(i),i="");return e}function il(n){const t=nl(n);return e=>{for(const i of t){if(i==="")break;e=e&&e[i]}return e}}function Ke(n,t){return(Jo[t]||(Jo[t]=il(t)))(n)}function Ao(n){return n.charAt(0).toUpperCase()+n.slice(1)}const Yn=n=>typeof n<"u",Je=n=>typeof n=="function",Zo=(n,t)=>{if(n.size!==t.size)return!1;for(const e of n)if(!t.has(e))return!1;return!0};function ol(n){return n.type==="mouseup"||n.type==="click"||n.type==="contextmenu"}const Nt=Math.PI,Yt=2*Nt,sl=Yt+Nt,Pi=Number.POSITIVE_INFINITY,al=Nt/180,Jt=Nt/2,tn=Nt/4,Qo=Nt*2/3,$e=Math.log10,Ee=Math.sign;function Fn(n,t,e){return Math.abs(n-t)<e}function ts(n){const t=Math.round(n);n=Fn(n,t,n/1e3)?t:n;const e=Math.pow(10,Math.floor($e(n))),i=n/e;return(i<=1?1:i<=2?2:i<=5?5:10)*e}function rl(n){const t=[],e=Math.sqrt(n);let i;for(i=1;i<e;i++)n%i===0&&(t.push(i),t.push(n/i));return e===(e|0)&&t.push(e),t.sort((o,s)=>o-s).pop(),t}function ll(n){return typeof n=="symbol"||typeof n=="object"&&n!==null&&!(Symbol.toPrimitive in n||"toString"in n||"valueOf"in n)}function bn(n){return!ll(n)&&!isNaN(parseFloat(n))&&isFinite(n)}function cl(n,t){const e=Math.round(n);return e-t<=n&&e+t>=n}function Sa(n,t,e){let i,o,s;for(i=0,o=n.length;i<o;i++)s=n[i][e],isNaN(s)||(t.min=Math.min(t.min,s),t.max=Math.max(t.max,s))}function xe(n){return n*(Nt/180)}function Bo(n){return n*(180/Nt)}function es(n){if(!Xt(n))return;let t=1,e=0;for(;Math.round(n*t)/t!==n;)t*=10,e++;return e}function Ca(n,t){const e=t.x-n.x,i=t.y-n.y,o=Math.sqrt(e*e+i*i);let s=Math.atan2(i,e);return s<-.5*Nt&&(s+=Yt),{angle:s,distance:o}}function po(n,t){return Math.sqrt(Math.pow(t.x-n.x,2)+Math.pow(t.y-n.y,2))}function dl(n,t){return(n-t+sl)%Yt-Nt}function re(n){return(n%Yt+Yt)%Yt}function $n(n,t,e,i){const o=re(n),s=re(t),a=re(e),r=re(s-o),l=re(a-o),c=re(o-s),d=re(o-a);return o===s||o===a||i&&s===a||r>l&&c<d}function ne(n,t,e){return Math.max(t,Math.min(e,n))}function ul(n){return ne(n,-32768,32767)}function ze(n,t,e,i=1e-6){return n>=Math.min(t,e)-i&&n<=Math.max(t,e)+i}function Lo(n,t,e){e=e||(a=>n[a]<t);let i=n.length-1,o=0,s;for(;i-o>1;)s=o+i>>1,e(s)?o=s:i=s;return{lo:o,hi:i}}const Ve=(n,t,e,i)=>Lo(n,e,i?o=>{const s=n[o][t];return s<e||s===e&&n[o+1][t]===e}:o=>n[o][t]<e),fl=(n,t,e)=>Lo(n,e,i=>n[i][t]>=e);function hl(n,t,e){let i=0,o=n.length;for(;i<o&&n[i]<t;)i++;for(;o>i&&n[o-1]>e;)o--;return i>0||o<n.length?n.slice(i,o):n}const Da=["push","pop","shift","splice","unshift"];function pl(n,t){if(n._chartjs){n._chartjs.listeners.push(t);return}Object.defineProperty(n,"_chartjs",{configurable:!0,enumerable:!1,value:{listeners:[t]}}),Da.forEach(e=>{const i="_onData"+Ao(e),o=n[e];Object.defineProperty(n,e,{configurable:!0,enumerable:!1,value(...s){const a=o.apply(this,s);return n._chartjs.listeners.forEach(r=>{typeof r[i]=="function"&&r[i](...s)}),a}})})}function ns(n,t){const e=n._chartjs;if(!e)return;const i=e.listeners,o=i.indexOf(t);o!==-1&&i.splice(o,1),!(i.length>0)&&(Da.forEach(s=>{delete n[s]}),delete n._chartjs)}function ka(n){const t=new Set(n);return t.size===n.length?n:Array.from(t)}const Ta=(function(){return typeof window>"u"?function(n){return n()}:window.requestAnimationFrame})();function Ia(n,t){let e=[],i=!1;return function(...o){e=o,i||(i=!0,Ta.call(window,()=>{i=!1,n.apply(t,e)}))}}function ml(n,t){let e;return function(...i){return t?(clearTimeout(e),e=setTimeout(n,t,i)):n.apply(this,i),t}}const Oo=n=>n==="start"?"left":n==="end"?"right":"center",ae=(n,t,e)=>n==="start"?t:n==="end"?e:(t+e)/2,gl=(n,t,e,i)=>n===(i?"left":"right")?e:n==="center"?(t+e)/2:t;function Ma(n,t,e){const i=t.length;let o=0,s=i;if(n._sorted){const{iScale:a,vScale:r,_parsed:l}=n,c=n.dataset&&n.dataset.options?n.dataset.options.spanGaps:null,d=a.axis,{min:f,max:p,minDefined:m,maxDefined:_}=a.getUserBounds();if(m){if(o=Math.min(Ve(l,d,f).lo,e?i:Ve(t,d,a.getPixelForValue(f)).lo),c){const S=l.slice(0,o+1).reverse().findIndex(k=>!At(k[r.axis]));o-=Math.max(0,S)}o=ne(o,0,i-1)}if(_){let S=Math.max(Ve(l,a.axis,p,!0).hi+1,e?0:Ve(t,d,a.getPixelForValue(p),!0).hi+1);if(c){const k=l.slice(S-1).findIndex(O=>!At(O[r.axis]));S+=Math.max(0,k)}s=ne(S,o,i)-o}else s=i-o}return{start:o,count:s}}function Ea(n){const{xScale:t,yScale:e,_scaleRanges:i}=n,o={xmin:t.min,xmax:t.max,ymin:e.min,ymax:e.max};if(!i)return n._scaleRanges=o,!0;const s=i.xmin!==t.min||i.xmax!==t.max||i.ymin!==e.min||i.ymax!==e.max;return Object.assign(i,o),s}const ni=n=>n===0||n===1,is=(n,t,e)=>-(Math.pow(2,10*(n-=1))*Math.sin((n-t)*Yt/e)),os=(n,t,e)=>Math.pow(2,-10*n)*Math.sin((n-t)*Yt/e)+1,Nn={linear:n=>n,easeInQuad:n=>n*n,easeOutQuad:n=>-n*(n-2),easeInOutQuad:n=>(n/=.5)<1?.5*n*n:-.5*(--n*(n-2)-1),easeInCubic:n=>n*n*n,easeOutCubic:n=>(n-=1)*n*n+1,easeInOutCubic:n=>(n/=.5)<1?.5*n*n*n:.5*((n-=2)*n*n+2),easeInQuart:n=>n*n*n*n,easeOutQuart:n=>-((n-=1)*n*n*n-1),easeInOutQuart:n=>(n/=.5)<1?.5*n*n*n*n:-.5*((n-=2)*n*n*n-2),easeInQuint:n=>n*n*n*n*n,easeOutQuint:n=>(n-=1)*n*n*n*n+1,easeInOutQuint:n=>(n/=.5)<1?.5*n*n*n*n*n:.5*((n-=2)*n*n*n*n+2),easeInSine:n=>-Math.cos(n*Jt)+1,easeOutSine:n=>Math.sin(n*Jt),easeInOutSine:n=>-.5*(Math.cos(Nt*n)-1),easeInExpo:n=>n===0?0:Math.pow(2,10*(n-1)),easeOutExpo:n=>n===1?1:-Math.pow(2,-10*n)+1,easeInOutExpo:n=>ni(n)?n:n<.5?.5*Math.pow(2,10*(n*2-1)):.5*(-Math.pow(2,-10*(n*2-1))+2),easeInCirc:n=>n>=1?n:-(Math.sqrt(1-n*n)-1),easeOutCirc:n=>Math.sqrt(1-(n-=1)*n),easeInOutCirc:n=>(n/=.5)<1?-.5*(Math.sqrt(1-n*n)-1):.5*(Math.sqrt(1-(n-=2)*n)+1),easeInElastic:n=>ni(n)?n:is(n,.075,.3),easeOutElastic:n=>ni(n)?n:os(n,.075,.3),easeInOutElastic(n){return ni(n)?n:n<.5?.5*is(n*2,.1125,.45):.5+.5*os(n*2-1,.1125,.45)},easeInBack(n){return n*n*((1.70158+1)*n-1.70158)},easeOutBack(n){return(n-=1)*n*((1.70158+1)*n+1.70158)+1},easeInOutBack(n){let t=1.70158;return(n/=.5)<1?.5*(n*n*(((t*=1.525)+1)*n-t)):.5*((n-=2)*n*(((t*=1.525)+1)*n+t)+2)},easeInBounce:n=>1-Nn.easeOutBounce(1-n),easeOutBounce(n){return n<1/2.75?7.5625*n*n:n<2/2.75?7.5625*(n-=1.5/2.75)*n+.75:n<2.5/2.75?7.5625*(n-=2.25/2.75)*n+.9375:7.5625*(n-=2.625/2.75)*n+.984375},easeInOutBounce:n=>n<.5?Nn.easeInBounce(n*2)*.5:Nn.easeOutBounce(n*2-1)*.5+.5};function Fo(n){if(n&&typeof n=="object"){const t=n.toString();return t==="[object CanvasPattern]"||t==="[object CanvasGradient]"}return!1}function ss(n){return Fo(n)?n:new jn(n)}function Xi(n){return Fo(n)?n:new jn(n).saturate(.5).darken(.1).hexString()}const vl=["x","y","borderWidth","radius","tension"],bl=["color","borderColor","backgroundColor"];function yl(n){n.set("animation",{delay:void 0,duration:1e3,easing:"easeOutQuart",fn:void 0,from:void 0,loop:void 0,to:void 0,type:void 0}),n.describe("animation",{_fallback:!1,_indexable:!1,_scriptable:t=>t!=="onProgress"&&t!=="onComplete"&&t!=="fn"}),n.set("animations",{colors:{type:"color",properties:bl},numbers:{type:"number",properties:vl}}),n.describe("animations",{_fallback:"animation"}),n.set("transitions",{active:{animation:{duration:400}},resize:{animation:{duration:0}},show:{animations:{colors:{from:"transparent"},visible:{type:"boolean",duration:0}}},hide:{animations:{colors:{to:"transparent"},visible:{type:"boolean",easing:"linear",fn:t=>t|0}}}})}function wl(n){n.set("layout",{autoPadding:!0,padding:{top:0,right:0,bottom:0,left:0}})}const as=new Map;function _l(n,t){t=t||{};const e=n+JSON.stringify(t);let i=as.get(e);return i||(i=new Intl.NumberFormat(n,t),as.set(e,i)),i}function Zn(n,t,e){return _l(t,e).format(n)}const Pa={values(n){return $t(n)?n:""+n},numeric(n,t,e){if(n===0)return"0";const i=this.chart.options.locale;let o,s=n;if(e.length>1){const c=Math.max(Math.abs(e[0].value),Math.abs(e[e.length-1].value));(c<1e-4||c>1e15)&&(o="scientific"),s=xl(n,e)}const a=$e(Math.abs(s)),r=isNaN(a)?1:Math.max(Math.min(-1*Math.floor(a),20),0),l={notation:o,minimumFractionDigits:r,maximumFractionDigits:r};return Object.assign(l,this.options.ticks.format),Zn(n,i,l)},logarithmic(n,t,e){if(n===0)return"0";const i=e[t].significand||n/Math.pow(10,Math.floor($e(n)));return[1,2,3,5,10,15].includes(i)||t>.8*e.length?Pa.numeric.call(this,n,t,e):""}};function xl(n,t){let e=t.length>3?t[2].value-t[1].value:t[1].value-t[0].value;return Math.abs(e)>=1&&n!==Math.floor(n)&&(e=n-Math.floor(n)),e}var Ri={formatters:Pa};function Sl(n){n.set("scale",{display:!0,offset:!1,reverse:!1,beginAtZero:!1,bounds:"ticks",clip:!0,grace:0,grid:{display:!0,lineWidth:1,drawOnChartArea:!0,drawTicks:!0,tickLength:8,tickWidth:(t,e)=>e.lineWidth,tickColor:(t,e)=>e.color,offset:!1},border:{display:!0,dash:[],dashOffset:0,width:1},title:{display:!1,text:"",padding:{top:4,bottom:4}},ticks:{minRotation:0,maxRotation:50,mirror:!1,textStrokeWidth:0,textStrokeColor:"",padding:3,display:!0,autoSkip:!0,autoSkipPadding:3,labelOffset:0,callback:Ri.formatters.values,minor:{},major:{},align:"center",crossAlign:"near",showLabelBackdrop:!1,backdropColor:"rgba(255, 255, 255, 0.75)",backdropPadding:2}}),n.route("scale.ticks","color","","color"),n.route("scale.grid","color","","borderColor"),n.route("scale.border","color","","borderColor"),n.route("scale.title","color","","color"),n.describe("scale",{_fallback:!1,_scriptable:t=>!t.startsWith("before")&&!t.startsWith("after")&&t!=="callback"&&t!=="parser",_indexable:t=>t!=="borderDash"&&t!=="tickBorderDash"&&t!=="dash"}),n.describe("scales",{_fallback:"scale"}),n.describe("scale.ticks",{_scriptable:t=>t!=="backdropPadding"&&t!=="callback",_indexable:t=>t!=="backdropPadding"})}const un=Object.create(null),mo=Object.create(null);function Rn(n,t){if(!t)return n;const e=t.split(".");for(let i=0,o=e.length;i<o;++i){const s=e[i];n=n[s]||(n[s]=Object.create(null))}return n}function Ki(n,t,e){return typeof t=="string"?Wn(Rn(n,t),e):Wn(Rn(n,""),t)}class Cl{constructor(t,e){this.animation=void 0,this.backgroundColor="rgba(0,0,0,0.1)",this.borderColor="rgba(0,0,0,0.1)",this.color="#666",this.datasets={},this.devicePixelRatio=i=>i.chart.platform.getDevicePixelRatio(),this.elements={},this.events=["mousemove","mouseout","click","touchstart","touchmove"],this.font={family:"'Helvetica Neue', 'Helvetica', 'Arial', sans-serif",size:12,style:"normal",lineHeight:1.2,weight:null},this.hover={},this.hoverBackgroundColor=(i,o)=>Xi(o.backgroundColor),this.hoverBorderColor=(i,o)=>Xi(o.borderColor),this.hoverColor=(i,o)=>Xi(o.color),this.indexAxis="x",this.interaction={mode:"nearest",intersect:!0,includeInvisible:!1},this.maintainAspectRatio=!0,this.onHover=null,this.onClick=null,this.parsing=!0,this.plugins={},this.responsive=!0,this.scale=void 0,this.scales={},this.showLine=!0,this.drawActiveElementsOnTop=!0,this.describe(t),this.apply(e)}set(t,e){return Ki(this,t,e)}get(t){return Rn(this,t)}describe(t,e){return Ki(mo,t,e)}override(t,e){return Ki(un,t,e)}route(t,e,i,o){const s=Rn(this,t),a=Rn(this,i),r="_"+e;Object.defineProperties(s,{[r]:{value:s[e],writable:!0},[e]:{enumerable:!0,get(){const l=this[r],c=a[o];return Bt(l)?Object.assign({},c,l):Tt(l,c)},set(l){this[r]=l}}})}apply(t){t.forEach(e=>e(this))}}var qt=new Cl({_scriptable:n=>!n.startsWith("on"),_indexable:n=>n!=="events",hover:{_fallback:"interaction"},interaction:{_scriptable:!1,_indexable:!1}},[yl,wl,Sl]);function Dl(n){return!n||At(n.size)||At(n.family)?null:(n.style?n.style+" ":"")+(n.weight?n.weight+" ":"")+n.size+"px "+n.family}function Ai(n,t,e,i,o){let s=t[o];return s||(s=t[o]=n.measureText(o).width,e.push(o)),s>i&&(i=s),i}function kl(n,t,e,i){i=i||{};let o=i.data=i.data||{},s=i.garbageCollect=i.garbageCollect||[];i.font!==t&&(o=i.data={},s=i.garbageCollect=[],i.font=t),n.save(),n.font=t;let a=0;const r=e.length;let l,c,d,f,p;for(l=0;l<r;l++)if(f=e[l],f!=null&&!$t(f))a=Ai(n,o,s,a,f);else if($t(f))for(c=0,d=f.length;c<d;c++)p=f[c],p!=null&&!$t(p)&&(a=Ai(n,o,s,a,p));n.restore();const m=s.length/2;if(m>e.length){for(l=0;l<m;l++)delete o[s[l]];s.splice(0,m)}return a}function en(n,t,e){const i=n.currentDevicePixelRatio,o=e!==0?Math.max(e/2,.5):0;return Math.round((t-o)*i)/i+o}function rs(n,t){!t&&!n||(t=t||n.getContext("2d"),t.save(),t.resetTransform(),t.clearRect(0,0,n.width,n.height),t.restore())}function go(n,t,e,i){Aa(n,t,e,i,null)}function Aa(n,t,e,i,o){let s,a,r,l,c,d,f,p;const m=t.pointStyle,_=t.rotation,S=t.radius;let k=(_||0)*al;if(m&&typeof m=="object"&&(s=m.toString(),s==="[object HTMLImageElement]"||s==="[object HTMLCanvasElement]")){n.save(),n.translate(e,i),n.rotate(k),n.drawImage(m,-m.width/2,-m.height/2,m.width,m.height),n.restore();return}if(!(isNaN(S)||S<=0)){switch(n.beginPath(),m){default:o?n.ellipse(e,i,o/2,S,0,0,Yt):n.arc(e,i,S,0,Yt),n.closePath();break;case"triangle":d=o?o/2:S,n.moveTo(e+Math.sin(k)*d,i-Math.cos(k)*S),k+=Qo,n.lineTo(e+Math.sin(k)*d,i-Math.cos(k)*S),k+=Qo,n.lineTo(e+Math.sin(k)*d,i-Math.cos(k)*S),n.closePath();break;case"rectRounded":c=S*.516,l=S-c,a=Math.cos(k+tn)*l,f=Math.cos(k+tn)*(o?o/2-c:l),r=Math.sin(k+tn)*l,p=Math.sin(k+tn)*(o?o/2-c:l),n.arc(e-f,i-r,c,k-Nt,k-Jt),n.arc(e+p,i-a,c,k-Jt,k),n.arc(e+f,i+r,c,k,k+Jt),n.arc(e-p,i+a,c,k+Jt,k+Nt),n.closePath();break;case"rect":if(!_){l=Math.SQRT1_2*S,d=o?o/2:l,n.rect(e-d,i-l,2*d,2*l);break}k+=tn;case"rectRot":f=Math.cos(k)*(o?o/2:S),a=Math.cos(k)*S,r=Math.sin(k)*S,p=Math.sin(k)*(o?o/2:S),n.moveTo(e-f,i-r),n.lineTo(e+p,i-a),n.lineTo(e+f,i+r),n.lineTo(e-p,i+a),n.closePath();break;case"crossRot":k+=tn;case"cross":f=Math.cos(k)*(o?o/2:S),a=Math.cos(k)*S,r=Math.sin(k)*S,p=Math.sin(k)*(o?o/2:S),n.moveTo(e-f,i-r),n.lineTo(e+f,i+r),n.moveTo(e+p,i-a),n.lineTo(e-p,i+a);break;case"star":f=Math.cos(k)*(o?o/2:S),a=Math.cos(k)*S,r=Math.sin(k)*S,p=Math.sin(k)*(o?o/2:S),n.moveTo(e-f,i-r),n.lineTo(e+f,i+r),n.moveTo(e+p,i-a),n.lineTo(e-p,i+a),k+=tn,f=Math.cos(k)*(o?o/2:S),a=Math.cos(k)*S,r=Math.sin(k)*S,p=Math.sin(k)*(o?o/2:S),n.moveTo(e-f,i-r),n.lineTo(e+f,i+r),n.moveTo(e+p,i-a),n.lineTo(e-p,i+a);break;case"line":a=o?o/2:Math.cos(k)*S,r=Math.sin(k)*S,n.moveTo(e-a,i-r),n.lineTo(e+a,i+r);break;case"dash":n.moveTo(e,i),n.lineTo(e+Math.cos(k)*(o?o/2:S),i+Math.sin(k)*S);break;case!1:n.closePath();break}n.fill(),t.borderWidth>0&&n.stroke()}}function Ue(n,t,e){return e=e||.5,!t||n&&n.x>t.left-e&&n.x<t.right+e&&n.y>t.top-e&&n.y<t.bottom+e}function zi(n,t){n.save(),n.beginPath(),n.rect(t.left,t.top,t.right-t.left,t.bottom-t.top),n.clip()}function Vi(n){n.restore()}function Tl(n,t,e,i,o){if(!t)return n.lineTo(e.x,e.y);if(o==="middle"){const s=(t.x+e.x)/2;n.lineTo(s,t.y),n.lineTo(s,e.y)}else o==="after"!=!!i?n.lineTo(t.x,e.y):n.lineTo(e.x,t.y);n.lineTo(e.x,e.y)}function Il(n,t,e,i){if(!t)return n.lineTo(e.x,e.y);n.bezierCurveTo(i?t.cp1x:t.cp2x,i?t.cp1y:t.cp2y,i?e.cp2x:e.cp1x,i?e.cp2y:e.cp1y,e.x,e.y)}function Ml(n,t){t.translation&&n.translate(t.translation[0],t.translation[1]),At(t.rotation)||n.rotate(t.rotation),t.color&&(n.fillStyle=t.color),t.textAlign&&(n.textAlign=t.textAlign),t.textBaseline&&(n.textBaseline=t.textBaseline)}function El(n,t,e,i,o){if(o.strikethrough||o.underline){const s=n.measureText(i),a=t-s.actualBoundingBoxLeft,r=t+s.actualBoundingBoxRight,l=e-s.actualBoundingBoxAscent,c=e+s.actualBoundingBoxDescent,d=o.strikethrough?(l+c)/2:c;n.strokeStyle=n.fillStyle,n.beginPath(),n.lineWidth=o.decorationWidth||2,n.moveTo(a,d),n.lineTo(r,d),n.stroke()}}function Pl(n,t){const e=n.fillStyle;n.fillStyle=t.color,n.fillRect(t.left,t.top,t.width,t.height),n.fillStyle=e}function fn(n,t,e,i,o,s={}){const a=$t(t)?t:[t],r=s.strokeWidth>0&&s.strokeColor!=="";let l,c;for(n.save(),n.font=o.string,Ml(n,s),l=0;l<a.length;++l)c=a[l],s.backdrop&&Pl(n,s.backdrop),r&&(s.strokeColor&&(n.strokeStyle=s.strokeColor),At(s.strokeWidth)||(n.lineWidth=s.strokeWidth),n.strokeText(c,e,i,s.maxWidth)),n.fillText(c,e,i,s.maxWidth),El(n,e,i,c,s),i+=Number(o.lineHeight);n.restore()}function qn(n,t){const{x:e,y:i,w:o,h:s,radius:a}=t;n.arc(e+a.topLeft,i+a.topLeft,a.topLeft,1.5*Nt,Nt,!0),n.lineTo(e,i+s-a.bottomLeft),n.arc(e+a.bottomLeft,i+s-a.bottomLeft,a.bottomLeft,Nt,Jt,!0),n.lineTo(e+o-a.bottomRight,i+s),n.arc(e+o-a.bottomRight,i+s-a.bottomRight,a.bottomRight,Jt,0,!0),n.lineTo(e+o,i+a.topRight),n.arc(e+o-a.topRight,i+a.topRight,a.topRight,0,-Jt,!0),n.lineTo(e+a.topLeft,i)}const Al=/^(normal|(\d+(?:\.\d+)?)(px|em|%)?)$/,Bl=/^(normal|italic|initial|inherit|unset|(oblique( -?[0-9]?[0-9]deg)?))$/;function Ll(n,t){const e=(""+n).match(Al);if(!e||e[1]==="normal")return t*1.2;switch(n=+e[2],e[3]){case"px":return n;case"%":n/=100;break}return t*n}const Ol=n=>+n||0;function No(n,t){const e={},i=Bt(t),o=i?Object.keys(t):t,s=Bt(n)?i?a=>Tt(n[a],n[t[a]]):a=>n[a]:()=>n;for(const a of o)e[a]=Ol(s(a));return e}function Ba(n){return No(n,{top:"y",right:"x",bottom:"y",left:"x"})}function cn(n){return No(n,["topLeft","topRight","bottomLeft","bottomRight"])}function ce(n){const t=Ba(n);return t.width=t.left+t.right,t.height=t.top+t.bottom,t}function te(n,t){n=n||{},t=t||qt.font;let e=Tt(n.size,t.size);typeof e=="string"&&(e=parseInt(e,10));let i=Tt(n.style,t.style);i&&!(""+i).match(Bl)&&(console.warn('Invalid font style specified: "'+i+'"'),i=void 0);const o={family:Tt(n.family,t.family),lineHeight:Ll(Tt(n.lineHeight,t.lineHeight),e),size:e,style:i,weight:Tt(n.weight,t.weight),string:""};return o.string=Dl(o),o}function En(n,t,e,i){let o,s,a;for(o=0,s=n.length;o<s;++o)if(a=n[o],a!==void 0&&a!==void 0)return a}function Fl(n,t,e){const{min:i,max:o}=n,s=_a(t,(o-i)/2),a=(r,l)=>e&&r===0?0:r+l;return{min:a(i,-Math.abs(s)),max:a(o,s)}}function Ze(n,t){return Object.assign(Object.create(n),t)}function Ro(n,t=[""],e,i,o=()=>n[0]){const s=e||n;typeof i>"u"&&(i=Na("_fallback",n));const a={[Symbol.toStringTag]:"Object",_cacheable:!0,_scopes:n,_rootScopes:s,_fallback:i,_getTarget:o,override:r=>Ro([r,...n],t,s,i)};return new Proxy(a,{deleteProperty(r,l){return delete r[l],delete r._keys,delete n[0][l],!0},get(r,l){return Oa(r,l,()=>Wl(l,t,n,r))},getOwnPropertyDescriptor(r,l){return Reflect.getOwnPropertyDescriptor(r._scopes[0],l)},getPrototypeOf(){return Reflect.getPrototypeOf(n[0])},has(r,l){return cs(r).includes(l)},ownKeys(r){return cs(r)},set(r,l,c){const d=r._storage||(r._storage=o());return r[l]=d[l]=c,delete r._keys,!0}})}function yn(n,t,e,i){const o={_cacheable:!1,_proxy:n,_context:t,_subProxy:e,_stack:new Set,_descriptors:La(n,i),setContext:s=>yn(n,s,e,i),override:s=>yn(n.override(s),t,e,i)};return new Proxy(o,{deleteProperty(s,a){return delete s[a],delete n[a],!0},get(s,a,r){return Oa(s,a,()=>Rl(s,a,r))},getOwnPropertyDescriptor(s,a){return s._descriptors.allKeys?Reflect.has(n,a)?{enumerable:!0,configurable:!0}:void 0:Reflect.getOwnPropertyDescriptor(n,a)},getPrototypeOf(){return Reflect.getPrototypeOf(n)},has(s,a){return Reflect.has(n,a)},ownKeys(){return Reflect.ownKeys(n)},set(s,a,r){return n[a]=r,delete s[a],!0}})}function La(n,t={scriptable:!0,indexable:!0}){const{_scriptable:e=t.scriptable,_indexable:i=t.indexable,_allKeys:o=t.allKeys}=n;return{allKeys:o,scriptable:e,indexable:i,isScriptable:Je(e)?e:()=>e,isIndexable:Je(i)?i:()=>i}}const Nl=(n,t)=>n?n+Ao(t):t,zo=(n,t)=>Bt(t)&&n!=="adapters"&&(Object.getPrototypeOf(t)===null||t.constructor===Object);function Oa(n,t,e){if(Object.prototype.hasOwnProperty.call(n,t)||t==="constructor")return n[t];const i=e();return n[t]=i,i}function Rl(n,t,e){const{_proxy:i,_context:o,_subProxy:s,_descriptors:a}=n;let r=i[t];return Je(r)&&a.isScriptable(t)&&(r=zl(t,r,n,e)),$t(r)&&r.length&&(r=Vl(t,r,n,a.isIndexable)),zo(t,r)&&(r=yn(r,o,s&&s[t],a)),r}function zl(n,t,e,i){const{_proxy:o,_context:s,_subProxy:a,_stack:r}=e;if(r.has(n))throw new Error("Recursion detected: "+Array.from(r).join("->")+"->"+n);r.add(n);let l=t(s,a||i);return r.delete(n),zo(n,l)&&(l=Vo(o._scopes,o,n,l)),l}function Vl(n,t,e,i){const{_proxy:o,_context:s,_subProxy:a,_descriptors:r}=e;if(typeof s.index<"u"&&i(n))return t[s.index%t.length];if(Bt(t[0])){const l=t,c=o._scopes.filter(d=>d!==l);t=[];for(const d of l){const f=Vo(c,o,n,d);t.push(yn(f,s,a&&a[n],r))}}return t}function Fa(n,t,e){return Je(n)?n(t,e):n}const Ul=(n,t)=>n===!0?t:typeof n=="string"?Ke(t,n):void 0;function Hl(n,t,e,i,o){for(const s of t){const a=Ul(e,s);if(a){n.add(a);const r=Fa(a._fallback,e,o);if(typeof r<"u"&&r!==e&&r!==i)return r}else if(a===!1&&typeof i<"u"&&e!==i)return null}return!1}function Vo(n,t,e,i){const o=t._rootScopes,s=Fa(t._fallback,e,i),a=[...n,...o],r=new Set;r.add(i);let l=ls(r,a,e,s||e,i);return l===null||typeof s<"u"&&s!==e&&(l=ls(r,a,s,l,i),l===null)?!1:Ro(Array.from(r),[""],o,s,()=>jl(t,e,i))}function ls(n,t,e,i,o){for(;e;)e=Hl(n,t,e,i,o);return e}function jl(n,t,e){const i=n._getTarget();t in i||(i[t]={});const o=i[t];return $t(o)&&Bt(e)?e:o||{}}function Wl(n,t,e,i){let o;for(const s of t)if(o=Na(Nl(s,n),e),typeof o<"u")return zo(n,o)?Vo(e,i,n,o):o}function Na(n,t){for(const e of t){if(!e)continue;const i=e[n];if(typeof i<"u")return i}}function cs(n){let t=n._keys;return t||(t=n._keys=Yl(n._scopes)),t}function Yl(n){const t=new Set;for(const e of n)for(const i of Object.keys(e).filter(o=>!o.startsWith("_")))t.add(i);return Array.from(t)}function Ra(n,t,e,i){const{iScale:o}=n,{key:s="r"}=this._parsing,a=new Array(i);let r,l,c,d;for(r=0,l=i;r<l;++r)c=r+e,d=t[c],a[r]={r:o.parse(Ke(d,s),c)};return a}const $l=Number.EPSILON||1e-14,wn=(n,t)=>t<n.length&&!n[t].skip&&n[t],za=n=>n==="x"?"y":"x";function ql(n,t,e,i){const o=n.skip?t:n,s=t,a=e.skip?t:e,r=po(s,o),l=po(a,s);let c=r/(r+l),d=l/(r+l);c=isNaN(c)?0:c,d=isNaN(d)?0:d;const f=i*c,p=i*d;return{previous:{x:s.x-f*(a.x-o.x),y:s.y-f*(a.y-o.y)},next:{x:s.x+p*(a.x-o.x),y:s.y+p*(a.y-o.y)}}}function Gl(n,t,e){const i=n.length;let o,s,a,r,l,c=wn(n,0);for(let d=0;d<i-1;++d)if(l=c,c=wn(n,d+1),!(!l||!c)){if(Fn(t[d],0,$l)){e[d]=e[d+1]=0;continue}o=e[d]/t[d],s=e[d+1]/t[d],r=Math.pow(o,2)+Math.pow(s,2),!(r<=9)&&(a=3/Math.sqrt(r),e[d]=o*a*t[d],e[d+1]=s*a*t[d])}}function Xl(n,t,e="x"){const i=za(e),o=n.length;let s,a,r,l=wn(n,0);for(let c=0;c<o;++c){if(a=r,r=l,l=wn(n,c+1),!r)continue;const d=r[e],f=r[i];a&&(s=(d-a[e])/3,r["cp1".concat(e)]=d-s,r["cp1".concat(i)]=f-s*t[c]),l&&(s=(l[e]-d)/3,r["cp2".concat(e)]=d+s,r["cp2".concat(i)]=f+s*t[c])}}function Kl(n,t="x"){const e=za(t),i=n.length,o=Array(i).fill(0),s=Array(i);let a,r,l,c=wn(n,0);for(a=0;a<i;++a)if(r=l,l=c,c=wn(n,a+1),!!l){if(c){const d=c[t]-l[t];o[a]=d!==0?(c[e]-l[e])/d:0}s[a]=r?c?Ee(o[a-1])!==Ee(o[a])?0:(o[a-1]+o[a])/2:o[a-1]:o[a]}Gl(n,o,s),Xl(n,s,t)}function ii(n,t,e){return Math.max(Math.min(n,e),t)}function Jl(n,t){let e,i,o,s,a,r=Ue(n[0],t);for(e=0,i=n.length;e<i;++e)a=s,s=r,r=e<i-1&&Ue(n[e+1],t),s&&(o=n[e],a&&(o.cp1x=ii(o.cp1x,t.left,t.right),o.cp1y=ii(o.cp1y,t.top,t.bottom)),r&&(o.cp2x=ii(o.cp2x,t.left,t.right),o.cp2y=ii(o.cp2y,t.top,t.bottom)))}function Zl(n,t,e,i,o){let s,a,r,l;if(t.spanGaps&&(n=n.filter(c=>!c.skip)),t.cubicInterpolationMode==="monotone")Kl(n,o);else{let c=i?n[n.length-1]:n[0];for(s=0,a=n.length;s<a;++s)r=n[s],l=ql(c,r,n[Math.min(s+1,a-(i?0:1))%a],t.tension),r.cp1x=l.previous.x,r.cp1y=l.previous.y,r.cp2x=l.next.x,r.cp2y=l.next.y,c=r}t.capBezierPoints&&Jl(n,e)}function Uo(){return typeof window<"u"&&typeof document<"u"}function Ho(n){let t=n.parentNode;return t&&t.toString()==="[object ShadowRoot]"&&(t=t.host),t}function Bi(n,t,e){let i;return typeof n=="string"?(i=parseInt(n,10),n.indexOf("%")!==-1&&(i=i/100*t.parentNode[e])):i=n,i}const Ui=n=>n.ownerDocument.defaultView.getComputedStyle(n,null);function Ql(n,t){return Ui(n).getPropertyValue(t)}const tc=["top","right","bottom","left"];function dn(n,t,e){const i={};e=e?"-"+e:"";for(let o=0;o<4;o++){const s=tc[o];i[s]=parseFloat(n[t+"-"+s+e])||0}return i.width=i.left+i.right,i.height=i.top+i.bottom,i}const ec=(n,t,e)=>(n>0||t>0)&&(!e||!e.shadowRoot);function nc(n,t){const e=n.touches,i=e&&e.length?e[0]:n,{offsetX:o,offsetY:s}=i;let a=!1,r,l;if(ec(o,s,n.target))r=o,l=s;else{const c=t.getBoundingClientRect();r=i.clientX-c.left,l=i.clientY-c.top,a=!0}return{x:r,y:l,box:a}}function an(n,t){if("native"in n)return n;const{canvas:e,currentDevicePixelRatio:i}=t,o=Ui(e),s=o.boxSizing==="border-box",a=dn(o,"padding"),r=dn(o,"border","width"),{x:l,y:c,box:d}=nc(n,e),f=a.left+(d&&r.left),p=a.top+(d&&r.top);let{width:m,height:_}=t;return s&&(m-=a.width+r.width,_-=a.height+r.height),{x:Math.round((l-f)/m*e.width/i),y:Math.round((c-p)/_*e.height/i)}}function ic(n,t,e){let i,o;if(t===void 0||e===void 0){const s=n&&Ho(n);if(!s)t=n.clientWidth,e=n.clientHeight;else{const a=s.getBoundingClientRect(),r=Ui(s),l=dn(r,"border","width"),c=dn(r,"padding");t=a.width-c.width-l.width,e=a.height-c.height-l.height,i=Bi(r.maxWidth,s,"clientWidth"),o=Bi(r.maxHeight,s,"clientHeight")}}return{width:t,height:e,maxWidth:i||Pi,maxHeight:o||Pi}}const oi=n=>Math.round(n*10)/10;function oc(n,t,e,i){const o=Ui(n),s=dn(o,"margin"),a=Bi(o.maxWidth,n,"clientWidth")||Pi,r=Bi(o.maxHeight,n,"clientHeight")||Pi,l=ic(n,t,e);let{width:c,height:d}=l;if(o.boxSizing==="content-box"){const p=dn(o,"border","width"),m=dn(o,"padding");c-=m.width+p.width,d-=m.height+p.height}return c=Math.max(0,c-s.width),d=Math.max(0,i?c/i:d-s.height),c=oi(Math.min(c,a,l.maxWidth)),d=oi(Math.min(d,r,l.maxHeight)),c&&!d&&(d=oi(c/2)),(t!==void 0||e!==void 0)&&i&&l.height&&d>l.height&&(d=l.height,c=oi(Math.floor(d*i))),{width:c,height:d}}function ds(n,t,e){const i=t||1,o=Math.floor(n.height*i),s=Math.floor(n.width*i);n.height=Math.floor(n.height),n.width=Math.floor(n.width);const a=n.canvas;return a.style&&(e||!a.style.height&&!a.style.width)&&(a.style.height="".concat(n.height,"px"),a.style.width="".concat(n.width,"px")),n.currentDevicePixelRatio!==i||a.height!==o||a.width!==s?(n.currentDevicePixelRatio=i,a.height=o,a.width=s,n.ctx.setTransform(i,0,0,i,0,0),!0):!1}const sc=(function(){let n=!1;try{const t={get passive(){return n=!0,!1}};Uo()&&(window.addEventListener("test",null,t),window.removeEventListener("test",null,t))}catch(t){}return n})();function us(n,t){const e=Ql(n,t),i=e&&e.match(/^(\d+)(\.\d+)?px$/);return i?+i[1]:void 0}function rn(n,t,e,i){return{x:n.x+e*(t.x-n.x),y:n.y+e*(t.y-n.y)}}function ac(n,t,e,i){return{x:n.x+e*(t.x-n.x),y:i==="middle"?e<.5?n.y:t.y:i==="after"?e<1?n.y:t.y:e>0?t.y:n.y}}function rc(n,t,e,i){const o={x:n.cp2x,y:n.cp2y},s={x:t.cp1x,y:t.cp1y},a=rn(n,o,e),r=rn(o,s,e),l=rn(s,t,e),c=rn(a,r,e),d=rn(r,l,e);return rn(c,d,e)}const lc=function(n,t){return{x(e){return n+n+t-e},setWidth(e){t=e},textAlign(e){return e==="center"?e:e==="right"?"left":"right"},xPlus(e,i){return e-i},leftForLtr(e,i){return e-i}}},cc=function(){return{x(n){return n},setWidth(n){},textAlign(n){return n},xPlus(n,t){return n+t},leftForLtr(n,t){return n}}};function vn(n,t,e){return n?lc(t,e):cc()}function Va(n,t){let e,i;(t==="ltr"||t==="rtl")&&(e=n.canvas.style,i=[e.getPropertyValue("direction"),e.getPropertyPriority("direction")],e.setProperty("direction",t,"important"),n.prevTextDirection=i)}function Ua(n,t){t!==void 0&&(delete n.prevTextDirection,n.canvas.style.setProperty("direction",t[0],t[1]))}function Ha(n){return n==="angle"?{between:$n,compare:dl,normalize:re}:{between:ze,compare:(t,e)=>t-e,normalize:t=>t}}function fs({start:n,end:t,count:e,loop:i,style:o}){return{start:n%e,end:t%e,loop:i&&(t-n+1)%e===0,style:o}}function dc(n,t,e){const{property:i,start:o,end:s}=e,{between:a,normalize:r}=Ha(i),l=t.length;let{start:c,end:d,loop:f}=n,p,m;if(f){for(c+=l,d+=l,p=0,m=l;p<m&&a(r(t[c%l][i]),o,s);++p)c--,d--;c%=l,d%=l}return d<c&&(d+=l),{start:c,end:d,loop:f,style:n.style}}function ja(n,t,e){if(!e)return[n];const{property:i,start:o,end:s}=e,a=t.length,{compare:r,between:l,normalize:c}=Ha(i),{start:d,end:f,loop:p,style:m}=dc(n,t,e),_=[];let S=!1,k=null,O,F,X;const et=()=>l(o,X,O)&&r(o,X)!==0,T=()=>r(s,O)===0||l(s,X,O),D=()=>S||et(),E=()=>!S||T();for(let P=d,R=d;P<=f;++P)F=t[P%a],!F.skip&&(O=c(F[i]),O!==X&&(S=l(O,o,s),k===null&&D()&&(k=r(O,o)===0?P:R),k!==null&&E()&&(_.push(fs({start:k,end:P,loop:p,count:a,style:m})),k=null),R=P,X=O));return k!==null&&_.push(fs({start:k,end:f,loop:p,count:a,style:m})),_}function Wa(n,t){const e=[],i=n.segments;for(let o=0;o<i.length;o++){const s=ja(i[o],n.points,t);s.length&&e.push(...s)}return e}function uc(n,t,e,i){let o=0,s=t-1;if(e&&!i)for(;o<t&&!n[o].skip;)o++;for(;o<t&&n[o].skip;)o++;for(o%=t,e&&(s+=o);s>o&&n[s%t].skip;)s--;return s%=t,{start:o,end:s}}function fc(n,t,e,i){const o=n.length,s=[];let a=t,r=n[t],l;for(l=t+1;l<=e;++l){const c=n[l%o];c.skip||c.stop?r.skip||(i=!1,s.push({start:t%o,end:(l-1)%o,loop:i}),t=a=c.stop?l:null):(a=l,r.skip&&(t=l)),r=c}return a!==null&&s.push({start:t%o,end:a%o,loop:i}),s}function hc(n,t){const e=n.points,i=n.options.spanGaps,o=e.length;if(!o)return[];const s=!!n._loop,{start:a,end:r}=uc(e,o,s,i);if(i===!0)return hs(n,[{start:a,end:r,loop:s}],e,t);const l=r<a?r+o:r,c=!!n._fullLoop&&a===0&&r===o-1;return hs(n,fc(e,a,l,c),e,t)}function hs(n,t,e,i){return!i||!i.setContext||!e?t:pc(n,t,e,i)}function pc(n,t,e,i){const o=n._chart.getContext(),s=ps(n.options),{_datasetIndex:a,options:{spanGaps:r}}=n,l=e.length,c=[];let d=s,f=t[0].start,p=f;function m(_,S,k,O){const F=r?-1:1;if(_!==S){for(_+=l;e[_%l].skip;)_-=F;for(;e[S%l].skip;)S+=F;_%l!==S%l&&(c.push({start:_%l,end:S%l,loop:k,style:O}),d=O,f=S%l)}}for(const _ of t){f=r?f:_.start;let S=e[f%l],k;for(p=f+1;p<=_.end;p++){const O=e[p%l];k=ps(i.setContext(Ze(o,{type:"segment",p0:S,p1:O,p0DataIndex:(p-1)%l,p1DataIndex:p%l,datasetIndex:a}))),mc(k,d)&&m(f,p-1,_.loop,d),S=O,d=k}f<p-1&&m(f,p-1,_.loop,d)}return c}function ps(n){return{backgroundColor:n.backgroundColor,borderCapStyle:n.borderCapStyle,borderDash:n.borderDash,borderDashOffset:n.borderDashOffset,borderJoinStyle:n.borderJoinStyle,borderWidth:n.borderWidth,borderColor:n.borderColor}}function mc(n,t){if(!t)return!1;const e=[],i=function(o,s){return Fo(s)?(e.includes(s)||e.push(s),e.indexOf(s)):s};return JSON.stringify(n,i)!==JSON.stringify(t,i)}function si(n,t,e){return n.options.clip?n[e]:t[e]}function gc(n,t){const{xScale:e,yScale:i}=n;return e&&i?{left:si(e,t,"left"),right:si(e,t,"right"),top:si(i,t,"top"),bottom:si(i,t,"bottom")}:t}function Ya(n,t){const e=t._clip;if(e.disabled)return!1;const i=gc(t,n.chartArea);return{left:e.left===!1?0:i.left-(e.left===!0?0:e.left),right:e.right===!1?n.width:i.right+(e.right===!0?0:e.right),top:e.top===!1?0:i.top-(e.top===!0?0:e.top),bottom:e.bottom===!1?n.height:i.bottom+(e.bottom===!0?0:e.bottom)}}/*!
 * Chart.js v4.5.0
 * https://www.chartjs.org
 * (c) 2025 Chart.js Contributors
 * Released under the MIT License
 */class vc{constructor(){this._request=null,this._charts=new Map,this._running=!1,this._lastDate=void 0}_notify(t,e,i,o){const s=e.listeners[o],a=e.duration;s.forEach(r=>r({chart:t,initial:e.initial,numSteps:a,currentStep:Math.min(i-e.start,a)}))}_refresh(){this._request||(this._running=!0,this._request=Ta.call(window,()=>{this._update(),this._request=null,this._running&&this._refresh()}))}_update(t=Date.now()){let e=0;this._charts.forEach((i,o)=>{if(!i.running||!i.items.length)return;const s=i.items;let a=s.length-1,r=!1,l;for(;a>=0;--a)l=s[a],l._active?(l._total>i.duration&&(i.duration=l._total),l.tick(t),r=!0):(s[a]=s[s.length-1],s.pop());r&&(o.draw(),this._notify(o,i,t,"progress")),s.length||(i.running=!1,this._notify(o,i,t,"complete"),i.initial=!1),e+=s.length}),this._lastDate=t,e===0&&(this._running=!1)}_getAnims(t){const e=this._charts;let i=e.get(t);return i||(i={running:!1,initial:!0,items:[],listeners:{complete:[],progress:[]}},e.set(t,i)),i}listen(t,e,i){this._getAnims(t).listeners[e].push(i)}add(t,e){!e||!e.length||this._getAnims(t).items.push(...e)}has(t){return this._getAnims(t).items.length>0}start(t){const e=this._charts.get(t);e&&(e.running=!0,e.start=Date.now(),e.duration=e.items.reduce((i,o)=>Math.max(i,o._duration),0),this._refresh())}running(t){if(!this._running)return!1;const e=this._charts.get(t);return!(!e||!e.running||!e.items.length)}stop(t){const e=this._charts.get(t);if(!e||!e.items.length)return;const i=e.items;let o=i.length-1;for(;o>=0;--o)i[o].cancel();e.items=[],this._notify(t,e,Date.now(),"complete")}remove(t){return this._charts.delete(t)}}var Oe=new vc;const ms="transparent",bc={boolean(n,t,e){return e>.5?t:n},color(n,t,e){const i=ss(n||ms),o=i.valid&&ss(t||ms);return o&&o.valid?o.mix(i,e).hexString():t},number(n,t,e){return n+(t-n)*e}};class yc{constructor(t,e,i,o){const s=e[i];o=En([t.to,o,s,t.from]);const a=En([t.from,s,o]);this._active=!0,this._fn=t.fn||bc[t.type||typeof a],this._easing=Nn[t.easing]||Nn.linear,this._start=Math.floor(Date.now()+(t.delay||0)),this._duration=this._total=Math.floor(t.duration),this._loop=!!t.loop,this._target=e,this._prop=i,this._from=a,this._to=o,this._promises=void 0}active(){return this._active}update(t,e,i){if(this._active){this._notify(!1);const o=this._target[this._prop],s=i-this._start,a=this._duration-s;this._start=i,this._duration=Math.floor(Math.max(a,t.duration)),this._total+=s,this._loop=!!t.loop,this._to=En([t.to,e,o,t.from]),this._from=En([t.from,o,e])}}cancel(){this._active&&(this.tick(Date.now()),this._active=!1,this._notify(!1))}tick(t){const e=t-this._start,i=this._duration,o=this._prop,s=this._from,a=this._loop,r=this._to;let l;if(this._active=s!==r&&(a||e<i),!this._active){this._target[o]=r,this._notify(!0);return}if(e<0){this._target[o]=s;return}l=e/i%2,l=a&&l>1?2-l:l,l=this._easing(Math.min(1,Math.max(0,l))),this._target[o]=this._fn(s,r,l)}wait(){const t=this._promises||(this._promises=[]);return new Promise((e,i)=>{t.push({res:e,rej:i})})}_notify(t){const e=t?"res":"rej",i=this._promises||[];for(let o=0;o<i.length;o++)i[o][e]()}}class $a{constructor(t,e){this._chart=t,this._properties=new Map,this.configure(e)}configure(t){if(!Bt(t))return;const e=Object.keys(qt.animation),i=this._properties;Object.getOwnPropertyNames(t).forEach(o=>{const s=t[o];if(!Bt(s))return;const a={};for(const r of e)a[r]=s[r];($t(s.properties)&&s.properties||[o]).forEach(r=>{(r===o||!i.has(r))&&i.set(r,a)})})}_animateOptions(t,e){const i=e.options,o=_c(t,i);if(!o)return[];const s=this._createAnimations(o,i);return i.$shared&&wc(t.options.$animations,i).then(()=>{t.options=i},()=>{}),s}_createAnimations(t,e){const i=this._properties,o=[],s=t.$animations||(t.$animations={}),a=Object.keys(e),r=Date.now();let l;for(l=a.length-1;l>=0;--l){const c=a[l];if(c.charAt(0)==="$")continue;if(c==="options"){o.push(...this._animateOptions(t,e));continue}const d=e[c];let f=s[c];const p=i.get(c);if(f)if(p&&f.active()){f.update(p,d,r);continue}else f.cancel();if(!p||!p.duration){t[c]=d;continue}s[c]=f=new yc(p,t,c,d),o.push(f)}return o}update(t,e){if(this._properties.size===0){Object.assign(t,e);return}const i=this._createAnimations(t,e);if(i.length)return Oe.add(this._chart,i),!0}}function wc(n,t){const e=[],i=Object.keys(t);for(let o=0;o<i.length;o++){const s=n[i[o]];s&&s.active()&&e.push(s.wait())}return Promise.all(e)}function _c(n,t){if(!t)return;let e=n.options;if(!e){n.options=t;return}return e.$shared&&(n.options=e=Object.assign({},e,{$shared:!1,$animations:{}})),e}function gs(n,t){const e=n&&n.options||{},i=e.reverse,o=e.min===void 0?t:0,s=e.max===void 0?t:0;return{start:i?s:o,end:i?o:s}}function xc(n,t,e){if(e===!1)return!1;const i=gs(n,e),o=gs(t,e);return{top:o.end,right:i.end,bottom:o.start,left:i.start}}function Sc(n){let t,e,i,o;return Bt(n)?(t=n.top,e=n.right,i=n.bottom,o=n.left):t=e=i=o=n,{top:t,right:e,bottom:i,left:o,disabled:n===!1}}function qa(n,t){const e=[],i=n._getSortedDatasetMetas(t);let o,s;for(o=0,s=i.length;o<s;++o)e.push(i[o].index);return e}function vs(n,t,e,i={}){const o=n.keys,s=i.mode==="single";let a,r,l,c;if(t===null)return;let d=!1;for(a=0,r=o.length;a<r;++a){if(l=+o[a],l===e){if(d=!0,i.all)continue;break}c=n.values[l],Xt(c)&&(s||t===0||Ee(t)===Ee(c))&&(t+=c)}return!d&&!i.all?0:t}function Cc(n,t){const{iScale:e,vScale:i}=t,o=e.axis==="x"?"x":"y",s=i.axis==="x"?"x":"y",a=Object.keys(n),r=new Array(a.length);let l,c,d;for(l=0,c=a.length;l<c;++l)d=a[l],r[l]={[o]:d,[s]:n[d]};return r}function Ji(n,t){const e=n&&n.options.stacked;return e||e===void 0&&t.stack!==void 0}function Dc(n,t,e){return"".concat(n.id,".").concat(t.id,".").concat(e.stack||e.type)}function kc(n){const{min:t,max:e,minDefined:i,maxDefined:o}=n.getUserBounds();return{min:i?t:Number.NEGATIVE_INFINITY,max:o?e:Number.POSITIVE_INFINITY}}function Tc(n,t,e){const i=n[t]||(n[t]={});return i[e]||(i[e]={})}function bs(n,t,e,i){for(const o of t.getMatchingVisibleMetas(i).reverse()){const s=n[o.index];if(e&&s>0||!e&&s<0)return o.index}return null}function ys(n,t){const{chart:e,_cachedMeta:i}=n,o=e._stacks||(e._stacks={}),{iScale:s,vScale:a,index:r}=i,l=s.axis,c=a.axis,d=Dc(s,a,i),f=t.length;let p;for(let m=0;m<f;++m){const _=t[m],{[l]:S,[c]:k}=_,O=_._stacks||(_._stacks={});p=O[c]=Tc(o,d,S),p[r]=k,p._top=bs(p,a,!0,i.type),p._bottom=bs(p,a,!1,i.type);const F=p._visualValues||(p._visualValues={});F[r]=k}}function Zi(n,t){const e=n.scales;return Object.keys(e).filter(i=>e[i].axis===t).shift()}function Ic(n,t){return Ze(n,{active:!1,dataset:void 0,datasetIndex:t,index:t,mode:"default",type:"dataset"})}function Mc(n,t,e){return Ze(n,{active:!1,dataIndex:t,parsed:void 0,raw:void 0,element:e,index:t,mode:"default",type:"data"})}function Cn(n,t){const e=n.controller.index,i=n.vScale&&n.vScale.axis;if(i){t=t||n._parsed;for(const o of t){const s=o._stacks;if(!s||s[i]===void 0||s[i][e]===void 0)return;delete s[i][e],s[i]._visualValues!==void 0&&s[i]._visualValues[e]!==void 0&&delete s[i]._visualValues[e]}}}const Qi=n=>n==="reset"||n==="none",ws=(n,t)=>t?n:Object.assign({},n),Ec=(n,t,e)=>n&&!t.hidden&&t._stacked&&{keys:qa(e,!0),values:null};class Se{constructor(t,e){this.chart=t,this._ctx=t.ctx,this.index=e,this._cachedDataOpts={},this._cachedMeta=this.getMeta(),this._type=this._cachedMeta.type,this.options=void 0,this._parsing=!1,this._data=void 0,this._objectData=void 0,this._sharedOptions=void 0,this._drawStart=void 0,this._drawCount=void 0,this.enableOptionSharing=!1,this.supportsDecimation=!1,this.$context=void 0,this._syncList=[],this.datasetElementType=new.target.datasetElementType,this.dataElementType=new.target.dataElementType,this.initialize()}initialize(){const t=this._cachedMeta;this.configure(),this.linkScales(),t._stacked=Ji(t.vScale,t),this.addElements(),this.options.fill&&!this.chart.isPluginEnabled("filler")&&console.warn("Tried to use the 'fill' option without the 'Filler' plugin enabled. Please import and register the 'Filler' plugin and make sure it is not disabled in the options")}updateIndex(t){this.index!==t&&Cn(this._cachedMeta),this.index=t}linkScales(){const t=this.chart,e=this._cachedMeta,i=this.getDataset(),o=(f,p,m,_)=>f==="x"?p:f==="r"?_:m,s=e.xAxisID=Tt(i.xAxisID,Zi(t,"x")),a=e.yAxisID=Tt(i.yAxisID,Zi(t,"y")),r=e.rAxisID=Tt(i.rAxisID,Zi(t,"r")),l=e.indexAxis,c=e.iAxisID=o(l,s,a,r),d=e.vAxisID=o(l,a,s,r);e.xScale=this.getScaleForId(s),e.yScale=this.getScaleForId(a),e.rScale=this.getScaleForId(r),e.iScale=this.getScaleForId(c),e.vScale=this.getScaleForId(d)}getDataset(){return this.chart.data.datasets[this.index]}getMeta(){return this.chart.getDatasetMeta(this.index)}getScaleForId(t){return this.chart.scales[t]}_getOtherScale(t){const e=this._cachedMeta;return t===e.iScale?e.vScale:e.iScale}reset(){this._update("reset")}_destroy(){const t=this._cachedMeta;this._data&&ns(this._data,this),t._stacked&&Cn(t)}_dataCheck(){const t=this.getDataset(),e=t.data||(t.data=[]),i=this._data;if(Bt(e)){const o=this._cachedMeta;this._data=Cc(e,o)}else if(i!==e){if(i){ns(i,this);const o=this._cachedMeta;Cn(o),o._parsed=[]}e&&Object.isExtensible(e)&&pl(e,this),this._syncList=[],this._data=e}}addElements(){const t=this._cachedMeta;this._dataCheck(),this.datasetElementType&&(t.dataset=new this.datasetElementType)}buildOrUpdateElements(t){const e=this._cachedMeta,i=this.getDataset();let o=!1;this._dataCheck();const s=e._stacked;e._stacked=Ji(e.vScale,e),e.stack!==i.stack&&(o=!0,Cn(e),e.stack=i.stack),this._resyncElements(t),(o||s!==e._stacked)&&(ys(this,e._parsed),e._stacked=Ji(e.vScale,e))}configure(){const t=this.chart.config,e=t.datasetScopeKeys(this._type),i=t.getOptionScopes(this.getDataset(),e,!0);this.options=t.createResolver(i,this.getContext()),this._parsing=this.options.parsing,this._cachedDataOpts={}}parse(t,e){const{_cachedMeta:i,_data:o}=this,{iScale:s,_stacked:a}=i,r=s.axis;let l=t===0&&e===o.length?!0:i._sorted,c=t>0&&i._parsed[t-1],d,f,p;if(this._parsing===!1)i._parsed=o,i._sorted=!0,p=o;else{$t(o[t])?p=this.parseArrayData(i,o,t,e):Bt(o[t])?p=this.parseObjectData(i,o,t,e):p=this.parsePrimitiveData(i,o,t,e);const m=()=>f[r]===null||c&&f[r]<c[r];for(d=0;d<e;++d)i._parsed[d+t]=f=p[d],l&&(m()&&(l=!1),c=f);i._sorted=l}a&&ys(this,p)}parsePrimitiveData(t,e,i,o){const{iScale:s,vScale:a}=t,r=s.axis,l=a.axis,c=s.getLabels(),d=s===a,f=new Array(o);let p,m,_;for(p=0,m=o;p<m;++p)_=p+i,f[p]={[r]:d||s.parse(c[_],_),[l]:a.parse(e[_],_)};return f}parseArrayData(t,e,i,o){const{xScale:s,yScale:a}=t,r=new Array(o);let l,c,d,f;for(l=0,c=o;l<c;++l)d=l+i,f=e[d],r[l]={x:s.parse(f[0],d),y:a.parse(f[1],d)};return r}parseObjectData(t,e,i,o){const{xScale:s,yScale:a}=t,{xAxisKey:r="x",yAxisKey:l="y"}=this._parsing,c=new Array(o);let d,f,p,m;for(d=0,f=o;d<f;++d)p=d+i,m=e[p],c[d]={x:s.parse(Ke(m,r),p),y:a.parse(Ke(m,l),p)};return c}getParsed(t){return this._cachedMeta._parsed[t]}getDataElement(t){return this._cachedMeta.data[t]}applyStack(t,e,i){const o=this.chart,s=this._cachedMeta,a=e[t.axis],r={keys:qa(o,!0),values:e._stacks[t.axis]._visualValues};return vs(r,a,s.index,{mode:i})}updateRangeFromParsed(t,e,i,o){const s=i[e.axis];let a=s===null?NaN:s;const r=o&&i._stacks[e.axis];o&&r&&(o.values=r,a=vs(o,s,this._cachedMeta.index)),t.min=Math.min(t.min,a),t.max=Math.max(t.max,a)}getMinMax(t,e){const i=this._cachedMeta,o=i._parsed,s=i._sorted&&t===i.iScale,a=o.length,r=this._getOtherScale(t),l=Ec(e,i,this.chart),c={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY},{min:d,max:f}=kc(r);let p,m;function _(){m=o[p];const S=m[r.axis];return!Xt(m[t.axis])||d>S||f<S}for(p=0;p<a&&!(!_()&&(this.updateRangeFromParsed(c,t,m,l),s));++p);if(s){for(p=a-1;p>=0;--p)if(!_()){this.updateRangeFromParsed(c,t,m,l);break}}return c}getAllParsedValues(t){const e=this._cachedMeta._parsed,i=[];let o,s,a;for(o=0,s=e.length;o<s;++o)a=e[o][t.axis],Xt(a)&&i.push(a);return i}getMaxOverflow(){return!1}getLabelAndValue(t){const e=this._cachedMeta,i=e.iScale,o=e.vScale,s=this.getParsed(t);return{label:i?""+i.getLabelForValue(s[i.axis]):"",value:o?""+o.getLabelForValue(s[o.axis]):""}}_update(t){const e=this._cachedMeta;this.update(t||"default"),e._clip=Sc(Tt(this.options.clip,xc(e.xScale,e.yScale,this.getMaxOverflow())))}update(t){}draw(){const t=this._ctx,e=this.chart,i=this._cachedMeta,o=i.data||[],s=e.chartArea,a=[],r=this._drawStart||0,l=this._drawCount||o.length-r,c=this.options.drawActiveElementsOnTop;let d;for(i.dataset&&i.dataset.draw(t,s,r,l),d=r;d<r+l;++d){const f=o[d];f.hidden||(f.active&&c?a.push(f):f.draw(t,s))}for(d=0;d<a.length;++d)a[d].draw(t,s)}getStyle(t,e){const i=e?"active":"default";return t===void 0&&this._cachedMeta.dataset?this.resolveDatasetElementOptions(i):this.resolveDataElementOptions(t||0,i)}getContext(t,e,i){const o=this.getDataset();let s;if(t>=0&&t<this._cachedMeta.data.length){const a=this._cachedMeta.data[t];s=a.$context||(a.$context=Mc(this.getContext(),t,a)),s.parsed=this.getParsed(t),s.raw=o.data[t],s.index=s.dataIndex=t}else s=this.$context||(this.$context=Ic(this.chart.getContext(),this.index)),s.dataset=o,s.index=s.datasetIndex=this.index;return s.active=!!e,s.mode=i,s}resolveDatasetElementOptions(t){return this._resolveElementOptions(this.datasetElementType.id,t)}resolveDataElementOptions(t,e){return this._resolveElementOptions(this.dataElementType.id,e,t)}_resolveElementOptions(t,e="default",i){const o=e==="active",s=this._cachedDataOpts,a=t+"-"+e,r=s[a],l=this.enableOptionSharing&&Yn(i);if(r)return ws(r,l);const c=this.chart.config,d=c.datasetElementScopeKeys(this._type,t),f=o?["".concat(t,"Hover"),"hover",t,""]:[t,""],p=c.getOptionScopes(this.getDataset(),d),m=Object.keys(qt.elements[t]),_=()=>this.getContext(i,o,e),S=c.resolveNamedOptions(p,m,_,f);return S.$shared&&(S.$shared=l,s[a]=Object.freeze(ws(S,l))),S}_resolveAnimations(t,e,i){const o=this.chart,s=this._cachedDataOpts,a="animation-".concat(e),r=s[a];if(r)return r;let l;if(o.options.animation!==!1){const d=this.chart.config,f=d.datasetAnimationScopeKeys(this._type,e),p=d.getOptionScopes(this.getDataset(),f);l=d.createResolver(p,this.getContext(t,i,e))}const c=new $a(o,l&&l.animations);return l&&l._cacheable&&(s[a]=Object.freeze(c)),c}getSharedOptions(t){if(t.$shared)return this._sharedOptions||(this._sharedOptions=Object.assign({},t))}includeOptions(t,e){return!e||Qi(t)||this.chart._animationsDisabled}_getSharedOptions(t,e){const i=this.resolveDataElementOptions(t,e),o=this._sharedOptions,s=this.getSharedOptions(i),a=this.includeOptions(e,s)||s!==o;return this.updateSharedOptions(s,e,i),{sharedOptions:s,includeOptions:a}}updateElement(t,e,i,o){Qi(o)?Object.assign(t,i):this._resolveAnimations(e,o).update(t,i)}updateSharedOptions(t,e,i){t&&!Qi(e)&&this._resolveAnimations(void 0,e).update(t,i)}_setStyle(t,e,i,o){t.active=o;const s=this.getStyle(e,o);this._resolveAnimations(e,i,o).update(t,{options:!o&&this.getSharedOptions(s)||s})}removeHoverStyle(t,e,i){this._setStyle(t,i,"active",!1)}setHoverStyle(t,e,i){this._setStyle(t,i,"active",!0)}_removeDatasetHoverStyle(){const t=this._cachedMeta.dataset;t&&this._setStyle(t,void 0,"active",!1)}_setDatasetHoverStyle(){const t=this._cachedMeta.dataset;t&&this._setStyle(t,void 0,"active",!0)}_resyncElements(t){const e=this._data,i=this._cachedMeta.data;for(const[r,l,c]of this._syncList)this[r](l,c);this._syncList=[];const o=i.length,s=e.length,a=Math.min(s,o);a&&this.parse(0,a),s>o?this._insertElements(o,s-o,t):s<o&&this._removeElements(s,o-s)}_insertElements(t,e,i=!0){const o=this._cachedMeta,s=o.data,a=t+e;let r;const l=c=>{for(c.length+=e,r=c.length-1;r>=a;r--)c[r]=c[r-e]};for(l(s),r=t;r<a;++r)s[r]=new this.dataElementType;this._parsing&&l(o._parsed),this.parse(t,e),i&&this.updateElements(s,t,e,"reset")}updateElements(t,e,i,o){}_removeElements(t,e){const i=this._cachedMeta;if(this._parsing){const o=i._parsed.splice(t,e);i._stacked&&Cn(i,o)}i.data.splice(t,e)}_sync(t){if(this._parsing)this._syncList.push(t);else{const[e,i,o]=t;this[e](i,o)}this.chart._dataChanges.push([this.index,...t])}_onDataPush(){const t=arguments.length;this._sync(["_insertElements",this.getDataset().data.length-t,t])}_onDataPop(){this._sync(["_removeElements",this._cachedMeta.data.length-1,1])}_onDataShift(){this._sync(["_removeElements",0,1])}_onDataSplice(t,e){e&&this._sync(["_removeElements",t,e]);const i=arguments.length-2;i&&this._sync(["_insertElements",t,i])}_onDataUnshift(){this._sync(["_insertElements",0,arguments.length])}}mt(Se,"defaults",{}),mt(Se,"datasetElementType",null),mt(Se,"dataElementType",null);function Pc(n,t){if(!n._cache.$bar){const e=n.getMatchingVisibleMetas(t);let i=[];for(let o=0,s=e.length;o<s;o++)i=i.concat(e[o].controller.getAllParsedValues(n));n._cache.$bar=ka(i.sort((o,s)=>o-s))}return n._cache.$bar}function Ac(n){const t=n.iScale,e=Pc(t,n.type);let i=t._length,o,s,a,r;const l=()=>{a===32767||a===-32768||(Yn(r)&&(i=Math.min(i,Math.abs(a-r)||i)),r=a)};for(o=0,s=e.length;o<s;++o)a=t.getPixelForValue(e[o]),l();for(r=void 0,o=0,s=t.ticks.length;o<s;++o)a=t.getPixelForTick(o),l();return i}function Bc(n,t,e,i){const o=e.barThickness;let s,a;return At(o)?(s=t.min*e.categoryPercentage,a=e.barPercentage):(s=o*i,a=1),{chunk:s/i,ratio:a,start:t.pixels[n]-s/2}}function Lc(n,t,e,i){const o=t.pixels,s=o[n];let a=n>0?o[n-1]:null,r=n<o.length-1?o[n+1]:null;const l=e.categoryPercentage;a===null&&(a=s-(r===null?t.end-t.start:r-s)),r===null&&(r=s+s-a);const c=s-(s-Math.min(a,r))/2*l;return{chunk:Math.abs(r-a)/2*l/i,ratio:e.barPercentage,start:c}}function Oc(n,t,e,i){const o=e.parse(n[0],i),s=e.parse(n[1],i),a=Math.min(o,s),r=Math.max(o,s);let l=a,c=r;Math.abs(a)>Math.abs(r)&&(l=r,c=a),t[e.axis]=c,t._custom={barStart:l,barEnd:c,start:o,end:s,min:a,max:r}}function Ga(n,t,e,i){return $t(n)?Oc(n,t,e,i):t[e.axis]=e.parse(n,i),t}function _s(n,t,e,i){const o=n.iScale,s=n.vScale,a=o.getLabels(),r=o===s,l=[];let c,d,f,p;for(c=e,d=e+i;c<d;++c)p=t[c],f={},f[o.axis]=r||o.parse(a[c],c),l.push(Ga(p,f,s,c));return l}function to(n){return n&&n.barStart!==void 0&&n.barEnd!==void 0}function Fc(n,t,e){return n!==0?Ee(n):(t.isHorizontal()?1:-1)*(t.min>=e?1:-1)}function Nc(n){let t,e,i,o,s;return n.horizontal?(t=n.base>n.x,e="left",i="right"):(t=n.base<n.y,e="bottom",i="top"),t?(o="end",s="start"):(o="start",s="end"),{start:e,end:i,reverse:t,top:o,bottom:s}}function Rc(n,t,e,i){let o=t.borderSkipped;const s={};if(!o){n.borderSkipped=s;return}if(o===!0){n.borderSkipped={top:!0,right:!0,bottom:!0,left:!0};return}const{start:a,end:r,reverse:l,top:c,bottom:d}=Nc(n);o==="middle"&&e&&(n.enableBorderRadius=!0,(e._top||0)===i?o=c:(e._bottom||0)===i?o=d:(s[xs(d,a,r,l)]=!0,o=c)),s[xs(o,a,r,l)]=!0,n.borderSkipped=s}function xs(n,t,e,i){return i?(n=zc(n,t,e),n=Ss(n,e,t)):n=Ss(n,t,e),n}function zc(n,t,e){return n===t?e:n===e?t:n}function Ss(n,t,e){return n==="start"?t:n==="end"?e:n}function Vc(n,{inflateAmount:t},e){n.inflateAmount=t==="auto"?e===1?.33:0:t}class gi extends Se{parsePrimitiveData(t,e,i,o){return _s(t,e,i,o)}parseArrayData(t,e,i,o){return _s(t,e,i,o)}parseObjectData(t,e,i,o){const{iScale:s,vScale:a}=t,{xAxisKey:r="x",yAxisKey:l="y"}=this._parsing,c=s.axis==="x"?r:l,d=a.axis==="x"?r:l,f=[];let p,m,_,S;for(p=i,m=i+o;p<m;++p)S=e[p],_={},_[s.axis]=s.parse(Ke(S,c),p),f.push(Ga(Ke(S,d),_,a,p));return f}updateRangeFromParsed(t,e,i,o){super.updateRangeFromParsed(t,e,i,o);const s=i._custom;s&&e===this._cachedMeta.vScale&&(t.min=Math.min(t.min,s.min),t.max=Math.max(t.max,s.max))}getMaxOverflow(){return 0}getLabelAndValue(t){const e=this._cachedMeta,{iScale:i,vScale:o}=e,s=this.getParsed(t),a=s._custom,r=to(a)?"["+a.start+", "+a.end+"]":""+o.getLabelForValue(s[o.axis]);return{label:""+i.getLabelForValue(s[i.axis]),value:r}}initialize(){this.enableOptionSharing=!0,super.initialize();const t=this._cachedMeta;t.stack=this.getDataset().stack}update(t){const e=this._cachedMeta;this.updateElements(e.data,0,e.data.length,t)}updateElements(t,e,i,o){const s=o==="reset",{index:a,_cachedMeta:{vScale:r}}=this,l=r.getBasePixel(),c=r.isHorizontal(),d=this._getRuler(),{sharedOptions:f,includeOptions:p}=this._getSharedOptions(e,o);for(let m=e;m<e+i;m++){const _=this.getParsed(m),S=s||At(_[r.axis])?{base:l,head:l}:this._calculateBarValuePixels(m),k=this._calculateBarIndexPixels(m,d),O=(_._stacks||{})[r.axis],F={horizontal:c,base:S.base,enableBorderRadius:!O||to(_._custom)||a===O._top||a===O._bottom,x:c?S.head:k.center,y:c?k.center:S.head,height:c?k.size:Math.abs(S.size),width:c?Math.abs(S.size):k.size};p&&(F.options=f||this.resolveDataElementOptions(m,t[m].active?"active":o));const X=F.options||t[m].options;Rc(F,X,O,a),Vc(F,X,d.ratio),this.updateElement(t[m],m,F,o)}}_getStacks(t,e){const{iScale:i}=this._cachedMeta,o=i.getMatchingVisibleMetas(this._type).filter(d=>d.controller.options.grouped),s=i.options.stacked,a=[],r=this._cachedMeta.controller.getParsed(e),l=r&&r[i.axis],c=d=>{const f=d._parsed.find(m=>m[i.axis]===l),p=f&&f[d.vScale.axis];if(At(p)||isNaN(p))return!0};for(const d of o)if(!(e!==void 0&&c(d))&&((s===!1||a.indexOf(d.stack)===-1||s===void 0&&d.stack===void 0)&&a.push(d.stack),d.index===t))break;return a.length||a.push(void 0),a}_getStackCount(t){return this._getStacks(void 0,t).length}_getAxisCount(){return this._getAxis().length}getFirstScaleIdForIndexAxis(){const t=this.chart.scales,e=this.chart.options.indexAxis;return Object.keys(t).filter(i=>t[i].axis===e).shift()}_getAxis(){const t={},e=this.getFirstScaleIdForIndexAxis();for(const i of this.chart.data.datasets)t[Tt(this.chart.options.indexAxis==="x"?i.xAxisID:i.yAxisID,e)]=!0;return Object.keys(t)}_getStackIndex(t,e,i){const o=this._getStacks(t,i),s=e!==void 0?o.indexOf(e):-1;return s===-1?o.length-1:s}_getRuler(){const t=this.options,e=this._cachedMeta,i=e.iScale,o=[];let s,a;for(s=0,a=e.data.length;s<a;++s)o.push(i.getPixelForValue(this.getParsed(s)[i.axis],s));const r=t.barThickness;return{min:r||Ac(e),pixels:o,start:i._startPixel,end:i._endPixel,stackCount:this._getStackCount(),scale:i,grouped:t.grouped,ratio:r?1:t.categoryPercentage*t.barPercentage}}_calculateBarValuePixels(t){const{_cachedMeta:{vScale:e,_stacked:i,index:o},options:{base:s,minBarLength:a}}=this,r=s||0,l=this.getParsed(t),c=l._custom,d=to(c);let f=l[e.axis],p=0,m=i?this.applyStack(e,l,i):f,_,S;m!==f&&(p=m-f,m=f),d&&(f=c.barStart,m=c.barEnd-c.barStart,f!==0&&Ee(f)!==Ee(c.barEnd)&&(p=0),p+=f);const k=!At(s)&&!d?s:p;let O=e.getPixelForValue(k);if(this.chart.getDataVisibility(t)?_=e.getPixelForValue(p+m):_=O,S=_-O,Math.abs(S)<a){S=Fc(S,e,r)*a,f===r&&(O-=S/2);const F=e.getPixelForDecimal(0),X=e.getPixelForDecimal(1),et=Math.min(F,X),T=Math.max(F,X);O=Math.max(Math.min(O,T),et),_=O+S,i&&!d&&(l._stacks[e.axis]._visualValues[o]=e.getValueForPixel(_)-e.getValueForPixel(O))}if(O===e.getPixelForValue(r)){const F=Ee(S)*e.getLineWidthForValue(r)/2;O+=F,S-=F}return{size:S,base:O,head:_,center:_+S/2}}_calculateBarIndexPixels(t,e){const i=e.scale,o=this.options,s=o.skipNull,a=Tt(o.maxBarThickness,1/0);let r,l;const c=this._getAxisCount();if(e.grouped){const d=s?this._getStackCount(t):e.stackCount,f=o.barThickness==="flex"?Lc(t,e,o,d*c):Bc(t,e,o,d*c),p=this.chart.options.indexAxis==="x"?this.getDataset().xAxisID:this.getDataset().yAxisID,m=this._getAxis().indexOf(Tt(p,this.getFirstScaleIdForIndexAxis())),_=this._getStackIndex(this.index,this._cachedMeta.stack,s?t:void 0)+m;r=f.start+f.chunk*_+f.chunk/2,l=Math.min(a,f.chunk*f.ratio)}else r=i.getPixelForValue(this.getParsed(t)[i.axis],t),l=Math.min(a,e.min*e.ratio);return{base:r-l/2,head:r+l/2,center:r,size:l}}draw(){const t=this._cachedMeta,e=t.vScale,i=t.data,o=i.length;let s=0;for(;s<o;++s)this.getParsed(s)[e.axis]!==null&&!i[s].hidden&&i[s].draw(this._ctx)}}mt(gi,"id","bar"),mt(gi,"defaults",{datasetElementType:!1,dataElementType:"bar",categoryPercentage:.8,barPercentage:.9,grouped:!0,animations:{numbers:{type:"number",properties:["x","y","base","width","height"]}}}),mt(gi,"overrides",{scales:{_index_:{type:"category",offset:!0,grid:{offset:!0}},_value_:{type:"linear",beginAtZero:!0}}});class vi extends Se{initialize(){this.enableOptionSharing=!0,super.initialize()}parsePrimitiveData(t,e,i,o){const s=super.parsePrimitiveData(t,e,i,o);for(let a=0;a<s.length;a++)s[a]._custom=this.resolveDataElementOptions(a+i).radius;return s}parseArrayData(t,e,i,o){const s=super.parseArrayData(t,e,i,o);for(let a=0;a<s.length;a++){const r=e[i+a];s[a]._custom=Tt(r[2],this.resolveDataElementOptions(a+i).radius)}return s}parseObjectData(t,e,i,o){const s=super.parseObjectData(t,e,i,o);for(let a=0;a<s.length;a++){const r=e[i+a];s[a]._custom=Tt(r&&r.r&&+r.r,this.resolveDataElementOptions(a+i).radius)}return s}getMaxOverflow(){const t=this._cachedMeta.data;let e=0;for(let i=t.length-1;i>=0;--i)e=Math.max(e,t[i].size(this.resolveDataElementOptions(i))/2);return e>0&&e}getLabelAndValue(t){const e=this._cachedMeta,i=this.chart.data.labels||[],{xScale:o,yScale:s}=e,a=this.getParsed(t),r=o.getLabelForValue(a.x),l=s.getLabelForValue(a.y),c=a._custom;return{label:i[t]||"",value:"("+r+", "+l+(c?", "+c:"")+")"}}update(t){const e=this._cachedMeta.data;this.updateElements(e,0,e.length,t)}updateElements(t,e,i,o){const s=o==="reset",{iScale:a,vScale:r}=this._cachedMeta,{sharedOptions:l,includeOptions:c}=this._getSharedOptions(e,o),d=a.axis,f=r.axis;for(let p=e;p<e+i;p++){const m=t[p],_=!s&&this.getParsed(p),S={},k=S[d]=s?a.getPixelForDecimal(.5):a.getPixelForValue(_[d]),O=S[f]=s?r.getBasePixel():r.getPixelForValue(_[f]);S.skip=isNaN(k)||isNaN(O),c&&(S.options=l||this.resolveDataElementOptions(p,m.active?"active":o),s&&(S.options.radius=0)),this.updateElement(m,p,S,o)}}resolveDataElementOptions(t,e){const i=this.getParsed(t);let o=super.resolveDataElementOptions(t,e);o.$shared&&(o=Object.assign({},o,{$shared:!1}));const s=o.radius;return e!=="active"&&(o.radius=0),o.radius+=Tt(i&&i._custom,s),o}}mt(vi,"id","bubble"),mt(vi,"defaults",{datasetElementType:!1,dataElementType:"point",animations:{numbers:{type:"number",properties:["x","y","borderWidth","radius"]}}}),mt(vi,"overrides",{scales:{x:{type:"linear"},y:{type:"linear"}}});function Uc(n,t,e){let i=1,o=1,s=0,a=0;if(t<Yt){const r=n,l=r+t,c=Math.cos(r),d=Math.sin(r),f=Math.cos(l),p=Math.sin(l),m=(X,et,T)=>$n(X,r,l,!0)?1:Math.max(et,et*e,T,T*e),_=(X,et,T)=>$n(X,r,l,!0)?-1:Math.min(et,et*e,T,T*e),S=m(0,c,f),k=m(Jt,d,p),O=_(Nt,c,f),F=_(Nt+Jt,d,p);i=(S-O)/2,o=(k-F)/2,s=-(S+O)/2,a=-(k+F)/2}return{ratioX:i,ratioY:o,offsetX:s,offsetY:a}}class ln extends Se{constructor(t,e){super(t,e),this.enableOptionSharing=!0,this.innerRadius=void 0,this.outerRadius=void 0,this.offsetX=void 0,this.offsetY=void 0}linkScales(){}parse(t,e){const i=this.getDataset().data,o=this._cachedMeta;if(this._parsing===!1)o._parsed=i;else{let s=l=>+i[l];if(Bt(i[t])){const{key:l="value"}=this._parsing;s=c=>+Ke(i[c],l)}let a,r;for(a=t,r=t+e;a<r;++a)o._parsed[a]=s(a)}}_getRotation(){return xe(this.options.rotation-90)}_getCircumference(){return xe(this.options.circumference)}_getRotationExtents(){let t=Yt,e=-Yt;for(let i=0;i<this.chart.data.datasets.length;++i)if(this.chart.isDatasetVisible(i)&&this.chart.getDatasetMeta(i).type===this._type){const o=this.chart.getDatasetMeta(i).controller,s=o._getRotation(),a=o._getCircumference();t=Math.min(t,s),e=Math.max(e,s+a)}return{rotation:t,circumference:e-t}}update(t){const e=this.chart,{chartArea:i}=e,o=this._cachedMeta,s=o.data,a=this.getMaxBorderWidth()+this.getMaxOffset(s)+this.options.spacing,r=Math.max((Math.min(i.width,i.height)-a)/2,0),l=Math.min(Qr(this.options.cutout,r),1),c=this._getRingWeight(this.index),{circumference:d,rotation:f}=this._getRotationExtents(),{ratioX:p,ratioY:m,offsetX:_,offsetY:S}=Uc(f,d,l),k=(i.width-a)/p,O=(i.height-a)/m,F=Math.max(Math.min(k,O)/2,0),X=_a(this.options.radius,F),et=Math.max(X*l,0),T=(X-et)/this._getVisibleDatasetWeightTotal();this.offsetX=_*X,this.offsetY=S*X,o.total=this.calculateTotal(),this.outerRadius=X-T*this._getRingWeightOffset(this.index),this.innerRadius=Math.max(this.outerRadius-T*c,0),this.updateElements(s,0,s.length,t)}_circumference(t,e){const i=this.options,o=this._cachedMeta,s=this._getCircumference();return e&&i.animation.animateRotate||!this.chart.getDataVisibility(t)||o._parsed[t]===null||o.data[t].hidden?0:this.calculateCircumference(o._parsed[t]*s/Yt)}updateElements(t,e,i,o){const s=o==="reset",a=this.chart,r=a.chartArea,c=a.options.animation,d=(r.left+r.right)/2,f=(r.top+r.bottom)/2,p=s&&c.animateScale,m=p?0:this.innerRadius,_=p?0:this.outerRadius,{sharedOptions:S,includeOptions:k}=this._getSharedOptions(e,o);let O=this._getRotation(),F;for(F=0;F<e;++F)O+=this._circumference(F,s);for(F=e;F<e+i;++F){const X=this._circumference(F,s),et=t[F],T={x:d+this.offsetX,y:f+this.offsetY,startAngle:O,endAngle:O+X,circumference:X,outerRadius:_,innerRadius:m};k&&(T.options=S||this.resolveDataElementOptions(F,et.active?"active":o)),O+=X,this.updateElement(et,F,T,o)}}calculateTotal(){const t=this._cachedMeta,e=t.data;let i=0,o;for(o=0;o<e.length;o++){const s=t._parsed[o];s!==null&&!isNaN(s)&&this.chart.getDataVisibility(o)&&!e[o].hidden&&(i+=Math.abs(s))}return i}calculateCircumference(t){const e=this._cachedMeta.total;return e>0&&!isNaN(t)?Yt*(Math.abs(t)/e):0}getLabelAndValue(t){const e=this._cachedMeta,i=this.chart,o=i.data.labels||[],s=Zn(e._parsed[t],i.options.locale);return{label:o[t]||"",value:s}}getMaxBorderWidth(t){let e=0;const i=this.chart;let o,s,a,r,l;if(!t){for(o=0,s=i.data.datasets.length;o<s;++o)if(i.isDatasetVisible(o)){a=i.getDatasetMeta(o),t=a.data,r=a.controller;break}}if(!t)return 0;for(o=0,s=t.length;o<s;++o)l=r.resolveDataElementOptions(o),l.borderAlign!=="inner"&&(e=Math.max(e,l.borderWidth||0,l.hoverBorderWidth||0));return e}getMaxOffset(t){let e=0;for(let i=0,o=t.length;i<o;++i){const s=this.resolveDataElementOptions(i);e=Math.max(e,s.offset||0,s.hoverOffset||0)}return e}_getRingWeightOffset(t){let e=0;for(let i=0;i<t;++i)this.chart.isDatasetVisible(i)&&(e+=this._getRingWeight(i));return e}_getRingWeight(t){return Math.max(Tt(this.chart.data.datasets[t].weight,1),0)}_getVisibleDatasetWeightTotal(){return this._getRingWeightOffset(this.chart.data.datasets.length)||1}}mt(ln,"id","doughnut"),mt(ln,"defaults",{datasetElementType:!1,dataElementType:"arc",animation:{animateRotate:!0,animateScale:!1},animations:{numbers:{type:"number",properties:["circumference","endAngle","innerRadius","outerRadius","startAngle","x","y","offset","borderWidth","spacing"]}},cutout:"50%",rotation:0,circumference:360,radius:"100%",spacing:0,indexAxis:"r"}),mt(ln,"descriptors",{_scriptable:t=>t!=="spacing",_indexable:t=>t!=="spacing"&&!t.startsWith("borderDash")&&!t.startsWith("hoverBorderDash")}),mt(ln,"overrides",{aspectRatio:1,plugins:{legend:{labels:{generateLabels(t){const e=t.data;if(e.labels.length&&e.datasets.length){const{labels:{pointStyle:i,color:o}}=t.legend.options;return e.labels.map((s,a)=>{const l=t.getDatasetMeta(0).controller.getStyle(a);return{text:s,fillStyle:l.backgroundColor,strokeStyle:l.borderColor,fontColor:o,lineWidth:l.borderWidth,pointStyle:i,hidden:!t.getDataVisibility(a),index:a}})}return[]}},onClick(t,e,i){i.chart.toggleDataVisibility(e.index),i.chart.update()}}}});class bi extends Se{initialize(){this.enableOptionSharing=!0,this.supportsDecimation=!0,super.initialize()}update(t){const e=this._cachedMeta,{dataset:i,data:o=[],_dataset:s}=e,a=this.chart._animationsDisabled;let{start:r,count:l}=Ma(e,o,a);this._drawStart=r,this._drawCount=l,Ea(e)&&(r=0,l=o.length),i._chart=this.chart,i._datasetIndex=this.index,i._decimated=!!s._decimated,i.points=o;const c=this.resolveDatasetElementOptions(t);this.options.showLine||(c.borderWidth=0),c.segment=this.options.segment,this.updateElement(i,void 0,{animated:!a,options:c},t),this.updateElements(o,r,l,t)}updateElements(t,e,i,o){const s=o==="reset",{iScale:a,vScale:r,_stacked:l,_dataset:c}=this._cachedMeta,{sharedOptions:d,includeOptions:f}=this._getSharedOptions(e,o),p=a.axis,m=r.axis,{spanGaps:_,segment:S}=this.options,k=bn(_)?_:Number.POSITIVE_INFINITY,O=this.chart._animationsDisabled||s||o==="none",F=e+i,X=t.length;let et=e>0&&this.getParsed(e-1);for(let T=0;T<X;++T){const D=t[T],E=O?D:{};if(T<e||T>=F){E.skip=!0;continue}const P=this.getParsed(T),R=At(P[m]),N=E[p]=a.getPixelForValue(P[p],T),$=E[m]=s||R?r.getBasePixel():r.getPixelForValue(l?this.applyStack(r,P,l):P[m],T);E.skip=isNaN(N)||isNaN($)||R,E.stop=T>0&&Math.abs(P[p]-et[p])>k,S&&(E.parsed=P,E.raw=c.data[T]),f&&(E.options=d||this.resolveDataElementOptions(T,D.active?"active":o)),O||this.updateElement(D,T,E,o),et=P}}getMaxOverflow(){const t=this._cachedMeta,e=t.dataset,i=e.options&&e.options.borderWidth||0,o=t.data||[];if(!o.length)return i;const s=o[0].size(this.resolveDataElementOptions(0)),a=o[o.length-1].size(this.resolveDataElementOptions(o.length-1));return Math.max(i,s,a)/2}draw(){const t=this._cachedMeta;t.dataset.updateControlPoints(this.chart.chartArea,t.iScale.axis),super.draw()}}mt(bi,"id","line"),mt(bi,"defaults",{datasetElementType:"line",dataElementType:"point",showLine:!0,spanGaps:!1}),mt(bi,"overrides",{scales:{_index_:{type:"category"},_value_:{type:"linear"}}});class zn extends Se{constructor(t,e){super(t,e),this.innerRadius=void 0,this.outerRadius=void 0}getLabelAndValue(t){const e=this._cachedMeta,i=this.chart,o=i.data.labels||[],s=Zn(e._parsed[t].r,i.options.locale);return{label:o[t]||"",value:s}}parseObjectData(t,e,i,o){return Ra.bind(this)(t,e,i,o)}update(t){const e=this._cachedMeta.data;this._updateRadius(),this.updateElements(e,0,e.length,t)}getMinMax(){const t=this._cachedMeta,e={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};return t.data.forEach((i,o)=>{const s=this.getParsed(o).r;!isNaN(s)&&this.chart.getDataVisibility(o)&&(s<e.min&&(e.min=s),s>e.max&&(e.max=s))}),e}_updateRadius(){const t=this.chart,e=t.chartArea,i=t.options,o=Math.min(e.right-e.left,e.bottom-e.top),s=Math.max(o/2,0),a=Math.max(i.cutoutPercentage?s/100*i.cutoutPercentage:1,0),r=(s-a)/t.getVisibleDatasetCount();this.outerRadius=s-r*this.index,this.innerRadius=this.outerRadius-r}updateElements(t,e,i,o){const s=o==="reset",a=this.chart,l=a.options.animation,c=this._cachedMeta.rScale,d=c.xCenter,f=c.yCenter,p=c.getIndexAngle(0)-.5*Nt;let m=p,_;const S=360/this.countVisibleElements();for(_=0;_<e;++_)m+=this._computeAngle(_,o,S);for(_=e;_<e+i;_++){const k=t[_];let O=m,F=m+this._computeAngle(_,o,S),X=a.getDataVisibility(_)?c.getDistanceFromCenterForValue(this.getParsed(_).r):0;m=F,s&&(l.animateScale&&(X=0),l.animateRotate&&(O=F=p));const et={x:d,y:f,innerRadius:0,outerRadius:X,startAngle:O,endAngle:F,options:this.resolveDataElementOptions(_,k.active?"active":o)};this.updateElement(k,_,et,o)}}countVisibleElements(){const t=this._cachedMeta;let e=0;return t.data.forEach((i,o)=>{!isNaN(this.getParsed(o).r)&&this.chart.getDataVisibility(o)&&e++}),e}_computeAngle(t,e,i){return this.chart.getDataVisibility(t)?xe(this.resolveDataElementOptions(t,e).angle||i):0}}mt(zn,"id","polarArea"),mt(zn,"defaults",{dataElementType:"arc",animation:{animateRotate:!0,animateScale:!0},animations:{numbers:{type:"number",properties:["x","y","startAngle","endAngle","innerRadius","outerRadius"]}},indexAxis:"r",startAngle:0}),mt(zn,"overrides",{aspectRatio:1,plugins:{legend:{labels:{generateLabels(t){const e=t.data;if(e.labels.length&&e.datasets.length){const{labels:{pointStyle:i,color:o}}=t.legend.options;return e.labels.map((s,a)=>{const l=t.getDatasetMeta(0).controller.getStyle(a);return{text:s,fillStyle:l.backgroundColor,strokeStyle:l.borderColor,fontColor:o,lineWidth:l.borderWidth,pointStyle:i,hidden:!t.getDataVisibility(a),index:a}})}return[]}},onClick(t,e,i){i.chart.toggleDataVisibility(e.index),i.chart.update()}}},scales:{r:{type:"radialLinear",angleLines:{display:!1},beginAtZero:!0,grid:{circular:!0},pointLabels:{display:!1},startAngle:0}}});class vo extends ln{}mt(vo,"id","pie"),mt(vo,"defaults",{cutout:0,rotation:0,circumference:360,radius:"100%"});class yi extends Se{getLabelAndValue(t){const e=this._cachedMeta.vScale,i=this.getParsed(t);return{label:e.getLabels()[t],value:""+e.getLabelForValue(i[e.axis])}}parseObjectData(t,e,i,o){return Ra.bind(this)(t,e,i,o)}update(t){const e=this._cachedMeta,i=e.dataset,o=e.data||[],s=e.iScale.getLabels();if(i.points=o,t!=="resize"){const a=this.resolveDatasetElementOptions(t);this.options.showLine||(a.borderWidth=0);const r={_loop:!0,_fullLoop:s.length===o.length,options:a};this.updateElement(i,void 0,r,t)}this.updateElements(o,0,o.length,t)}updateElements(t,e,i,o){const s=this._cachedMeta.rScale,a=o==="reset";for(let r=e;r<e+i;r++){const l=t[r],c=this.resolveDataElementOptions(r,l.active?"active":o),d=s.getPointPositionForValue(r,this.getParsed(r).r),f=a?s.xCenter:d.x,p=a?s.yCenter:d.y,m={x:f,y:p,angle:d.angle,skip:isNaN(f)||isNaN(p),options:c};this.updateElement(l,r,m,o)}}}mt(yi,"id","radar"),mt(yi,"defaults",{datasetElementType:"line",dataElementType:"point",indexAxis:"r",showLine:!0,elements:{line:{fill:"start"}}}),mt(yi,"overrides",{aspectRatio:1,scales:{r:{type:"radialLinear"}}});class wi extends Se{getLabelAndValue(t){const e=this._cachedMeta,i=this.chart.data.labels||[],{xScale:o,yScale:s}=e,a=this.getParsed(t),r=o.getLabelForValue(a.x),l=s.getLabelForValue(a.y);return{label:i[t]||"",value:"("+r+", "+l+")"}}update(t){const e=this._cachedMeta,{data:i=[]}=e,o=this.chart._animationsDisabled;let{start:s,count:a}=Ma(e,i,o);if(this._drawStart=s,this._drawCount=a,Ea(e)&&(s=0,a=i.length),this.options.showLine){this.datasetElementType||this.addElements();const{dataset:r,_dataset:l}=e;r._chart=this.chart,r._datasetIndex=this.index,r._decimated=!!l._decimated,r.points=i;const c=this.resolveDatasetElementOptions(t);c.segment=this.options.segment,this.updateElement(r,void 0,{animated:!o,options:c},t)}else this.datasetElementType&&(delete e.dataset,this.datasetElementType=!1);this.updateElements(i,s,a,t)}addElements(){const{showLine:t}=this.options;!this.datasetElementType&&t&&(this.datasetElementType=this.chart.registry.getElement("line")),super.addElements()}updateElements(t,e,i,o){const s=o==="reset",{iScale:a,vScale:r,_stacked:l,_dataset:c}=this._cachedMeta,d=this.resolveDataElementOptions(e,o),f=this.getSharedOptions(d),p=this.includeOptions(o,f),m=a.axis,_=r.axis,{spanGaps:S,segment:k}=this.options,O=bn(S)?S:Number.POSITIVE_INFINITY,F=this.chart._animationsDisabled||s||o==="none";let X=e>0&&this.getParsed(e-1);for(let et=e;et<e+i;++et){const T=t[et],D=this.getParsed(et),E=F?T:{},P=At(D[_]),R=E[m]=a.getPixelForValue(D[m],et),N=E[_]=s||P?r.getBasePixel():r.getPixelForValue(l?this.applyStack(r,D,l):D[_],et);E.skip=isNaN(R)||isNaN(N)||P,E.stop=et>0&&Math.abs(D[m]-X[m])>O,k&&(E.parsed=D,E.raw=c.data[et]),p&&(E.options=f||this.resolveDataElementOptions(et,T.active?"active":o)),F||this.updateElement(T,et,E,o),X=D}this.updateSharedOptions(f,o,d)}getMaxOverflow(){const t=this._cachedMeta,e=t.data||[];if(!this.options.showLine){let r=0;for(let l=e.length-1;l>=0;--l)r=Math.max(r,e[l].size(this.resolveDataElementOptions(l))/2);return r>0&&r}const i=t.dataset,o=i.options&&i.options.borderWidth||0;if(!e.length)return o;const s=e[0].size(this.resolveDataElementOptions(0)),a=e[e.length-1].size(this.resolveDataElementOptions(e.length-1));return Math.max(o,s,a)/2}}mt(wi,"id","scatter"),mt(wi,"defaults",{datasetElementType:!1,dataElementType:"point",showLine:!1,fill:!1}),mt(wi,"overrides",{interaction:{mode:"point"},scales:{x:{type:"linear"},y:{type:"linear"}}});var Hc=Object.freeze({__proto__:null,BarController:gi,BubbleController:vi,DoughnutController:ln,LineController:bi,PieController:vo,PolarAreaController:zn,RadarController:yi,ScatterController:wi});function nn(){throw new Error("This method is not implemented: Check that a complete date adapter is provided.")}class jo{constructor(t){mt(this,"options");this.options=t||{}}static override(t){Object.assign(jo.prototype,t)}init(){}formats(){return nn()}parse(){return nn()}format(){return nn()}add(){return nn()}diff(){return nn()}startOf(){return nn()}endOf(){return nn()}}var jc={_date:jo};function Wc(n,t,e,i){const{controller:o,data:s,_sorted:a}=n,r=o._cachedMeta.iScale,l=n.dataset&&n.dataset.options?n.dataset.options.spanGaps:null;if(r&&t===r.axis&&t!=="r"&&a&&s.length){const c=r._reversePixels?fl:Ve;if(i){if(o._sharedOptions){const d=s[0],f=typeof d.getRange=="function"&&d.getRange(t);if(f){const p=c(s,t,e-f),m=c(s,t,e+f);return{lo:p.lo,hi:m.hi}}}}else{const d=c(s,t,e);if(l){const{vScale:f}=o._cachedMeta,{_parsed:p}=n,m=p.slice(0,d.lo+1).reverse().findIndex(S=>!At(S[f.axis]));d.lo-=Math.max(0,m);const _=p.slice(d.hi).findIndex(S=>!At(S[f.axis]));d.hi+=Math.max(0,_)}return d}}return{lo:0,hi:s.length-1}}function Hi(n,t,e,i,o){const s=n.getSortedVisibleDatasetMetas(),a=e[t];for(let r=0,l=s.length;r<l;++r){const{index:c,data:d}=s[r],{lo:f,hi:p}=Wc(s[r],t,a,o);for(let m=f;m<=p;++m){const _=d[m];_.skip||i(_,c,m)}}}function Yc(n){const t=n.indexOf("x")!==-1,e=n.indexOf("y")!==-1;return function(i,o){const s=t?Math.abs(i.x-o.x):0,a=e?Math.abs(i.y-o.y):0;return Math.sqrt(Math.pow(s,2)+Math.pow(a,2))}}function eo(n,t,e,i,o){const s=[];return!o&&!n.isPointInArea(t)||Hi(n,e,t,function(r,l,c){!o&&!Ue(r,n.chartArea,0)||r.inRange(t.x,t.y,i)&&s.push({element:r,datasetIndex:l,index:c})},!0),s}function $c(n,t,e,i){let o=[];function s(a,r,l){const{startAngle:c,endAngle:d}=a.getProps(["startAngle","endAngle"],i),{angle:f}=Ca(a,{x:t.x,y:t.y});$n(f,c,d)&&o.push({element:a,datasetIndex:r,index:l})}return Hi(n,e,t,s),o}function qc(n,t,e,i,o,s){let a=[];const r=Yc(e);let l=Number.POSITIVE_INFINITY;function c(d,f,p){const m=d.inRange(t.x,t.y,o);if(i&&!m)return;const _=d.getCenterPoint(o);if(!(!!s||n.isPointInArea(_))&&!m)return;const k=r(t,_);k<l?(a=[{element:d,datasetIndex:f,index:p}],l=k):k===l&&a.push({element:d,datasetIndex:f,index:p})}return Hi(n,e,t,c),a}function no(n,t,e,i,o,s){return!s&&!n.isPointInArea(t)?[]:e==="r"&&!i?$c(n,t,e,o):qc(n,t,e,i,o,s)}function Cs(n,t,e,i,o){const s=[],a=e==="x"?"inXRange":"inYRange";let r=!1;return Hi(n,e,t,(l,c,d)=>{l[a]&&l[a](t[e],o)&&(s.push({element:l,datasetIndex:c,index:d}),r=r||l.inRange(t.x,t.y,o))}),i&&!r?[]:s}var Gc={modes:{index(n,t,e,i){const o=an(t,n),s=e.axis||"x",a=e.includeInvisible||!1,r=e.intersect?eo(n,o,s,i,a):no(n,o,s,!1,i,a),l=[];return r.length?(n.getSortedVisibleDatasetMetas().forEach(c=>{const d=r[0].index,f=c.data[d];f&&!f.skip&&l.push({element:f,datasetIndex:c.index,index:d})}),l):[]},dataset(n,t,e,i){const o=an(t,n),s=e.axis||"xy",a=e.includeInvisible||!1;let r=e.intersect?eo(n,o,s,i,a):no(n,o,s,!1,i,a);if(r.length>0){const l=r[0].datasetIndex,c=n.getDatasetMeta(l).data;r=[];for(let d=0;d<c.length;++d)r.push({element:c[d],datasetIndex:l,index:d})}return r},point(n,t,e,i){const o=an(t,n),s=e.axis||"xy",a=e.includeInvisible||!1;return eo(n,o,s,i,a)},nearest(n,t,e,i){const o=an(t,n),s=e.axis||"xy",a=e.includeInvisible||!1;return no(n,o,s,e.intersect,i,a)},x(n,t,e,i){const o=an(t,n);return Cs(n,o,"x",e.intersect,i)},y(n,t,e,i){const o=an(t,n);return Cs(n,o,"y",e.intersect,i)}}};const Xa=["left","top","right","bottom"];function Dn(n,t){return n.filter(e=>e.pos===t)}function Ds(n,t){return n.filter(e=>Xa.indexOf(e.pos)===-1&&e.box.axis===t)}function kn(n,t){return n.sort((e,i)=>{const o=t?i:e,s=t?e:i;return o.weight===s.weight?o.index-s.index:o.weight-s.weight})}function Xc(n){const t=[];let e,i,o,s,a,r;for(e=0,i=(n||[]).length;e<i;++e)o=n[e],{position:s,options:{stack:a,stackWeight:r=1}}=o,t.push({index:e,box:o,pos:s,horizontal:o.isHorizontal(),weight:o.weight,stack:a&&s+a,stackWeight:r});return t}function Kc(n){const t={};for(const e of n){const{stack:i,pos:o,stackWeight:s}=e;if(!i||!Xa.includes(o))continue;const a=t[i]||(t[i]={count:0,placed:0,weight:0,size:0});a.count++,a.weight+=s}return t}function Jc(n,t){const e=Kc(n),{vBoxMaxWidth:i,hBoxMaxHeight:o}=t;let s,a,r;for(s=0,a=n.length;s<a;++s){r=n[s];const{fullSize:l}=r.box,c=e[r.stack],d=c&&r.stackWeight/c.weight;r.horizontal?(r.width=d?d*i:l&&t.availableWidth,r.height=o):(r.width=i,r.height=d?d*o:l&&t.availableHeight)}return e}function Zc(n){const t=Xc(n),e=kn(t.filter(c=>c.box.fullSize),!0),i=kn(Dn(t,"left"),!0),o=kn(Dn(t,"right")),s=kn(Dn(t,"top"),!0),a=kn(Dn(t,"bottom")),r=Ds(t,"x"),l=Ds(t,"y");return{fullSize:e,leftAndTop:i.concat(s),rightAndBottom:o.concat(l).concat(a).concat(r),chartArea:Dn(t,"chartArea"),vertical:i.concat(o).concat(l),horizontal:s.concat(a).concat(r)}}function ks(n,t,e,i){return Math.max(n[e],t[e])+Math.max(n[i],t[i])}function Ka(n,t){n.top=Math.max(n.top,t.top),n.left=Math.max(n.left,t.left),n.bottom=Math.max(n.bottom,t.bottom),n.right=Math.max(n.right,t.right)}function Qc(n,t,e,i){const{pos:o,box:s}=e,a=n.maxPadding;if(!Bt(o)){e.size&&(n[o]-=e.size);const f=i[e.stack]||{size:0,count:1};f.size=Math.max(f.size,e.horizontal?s.height:s.width),e.size=f.size/f.count,n[o]+=e.size}s.getPadding&&Ka(a,s.getPadding());const r=Math.max(0,t.outerWidth-ks(a,n,"left","right")),l=Math.max(0,t.outerHeight-ks(a,n,"top","bottom")),c=r!==n.w,d=l!==n.h;return n.w=r,n.h=l,e.horizontal?{same:c,other:d}:{same:d,other:c}}function td(n){const t=n.maxPadding;function e(i){const o=Math.max(t[i]-n[i],0);return n[i]+=o,o}n.y+=e("top"),n.x+=e("left"),e("right"),e("bottom")}function ed(n,t){const e=t.maxPadding;function i(o){const s={left:0,top:0,right:0,bottom:0};return o.forEach(a=>{s[a]=Math.max(t[a],e[a])}),s}return i(n?["left","right"]:["top","bottom"])}function Pn(n,t,e,i){const o=[];let s,a,r,l,c,d;for(s=0,a=n.length,c=0;s<a;++s){r=n[s],l=r.box,l.update(r.width||t.w,r.height||t.h,ed(r.horizontal,t));const{same:f,other:p}=Qc(t,e,r,i);c|=f&&o.length,d=d||p,l.fullSize||o.push(r)}return c&&Pn(o,t,e,i)||d}function ai(n,t,e,i,o){n.top=e,n.left=t,n.right=t+i,n.bottom=e+o,n.width=i,n.height=o}function Ts(n,t,e,i){const o=e.padding;let{x:s,y:a}=t;for(const r of n){const l=r.box,c=i[r.stack]||{placed:0,weight:1},d=r.stackWeight/c.weight||1;if(r.horizontal){const f=t.w*d,p=c.size||l.height;Yn(c.start)&&(a=c.start),l.fullSize?ai(l,o.left,a,e.outerWidth-o.right-o.left,p):ai(l,t.left+c.placed,a,f,p),c.start=a,c.placed+=f,a=l.bottom}else{const f=t.h*d,p=c.size||l.width;Yn(c.start)&&(s=c.start),l.fullSize?ai(l,s,o.top,p,e.outerHeight-o.bottom-o.top):ai(l,s,t.top+c.placed,p,f),c.start=s,c.placed+=f,s=l.right}}t.x=s,t.y=a}var le={addBox(n,t){n.boxes||(n.boxes=[]),t.fullSize=t.fullSize||!1,t.position=t.position||"top",t.weight=t.weight||0,t._layers=t._layers||function(){return[{z:0,draw(e){t.draw(e)}}]},n.boxes.push(t)},removeBox(n,t){const e=n.boxes?n.boxes.indexOf(t):-1;e!==-1&&n.boxes.splice(e,1)},configure(n,t,e){t.fullSize=e.fullSize,t.position=e.position,t.weight=e.weight},update(n,t,e,i){if(!n)return;const o=ce(n.options.layout.padding),s=Math.max(t-o.width,0),a=Math.max(e-o.height,0),r=Zc(n.boxes),l=r.vertical,c=r.horizontal;Ut(n.boxes,S=>{typeof S.beforeLayout=="function"&&S.beforeLayout()});const d=l.reduce((S,k)=>k.box.options&&k.box.options.display===!1?S:S+1,0)||1,f=Object.freeze({outerWidth:t,outerHeight:e,padding:o,availableWidth:s,availableHeight:a,vBoxMaxWidth:s/2/d,hBoxMaxHeight:a/2}),p=Object.assign({},o);Ka(p,ce(i));const m=Object.assign({maxPadding:p,w:s,h:a,x:o.left,y:o.top},o),_=Jc(l.concat(c),f);Pn(r.fullSize,m,f,_),Pn(l,m,f,_),Pn(c,m,f,_)&&Pn(l,m,f,_),td(m),Ts(r.leftAndTop,m,f,_),m.x+=m.w,m.y+=m.h,Ts(r.rightAndBottom,m,f,_),n.chartArea={left:m.left,top:m.top,right:m.left+m.w,bottom:m.top+m.h,height:m.h,width:m.w},Ut(r.chartArea,S=>{const k=S.box;Object.assign(k,n.chartArea),k.update(m.w,m.h,{left:0,top:0,right:0,bottom:0})})}};class Ja{acquireContext(t,e){}releaseContext(t){return!1}addEventListener(t,e,i){}removeEventListener(t,e,i){}getDevicePixelRatio(){return 1}getMaximumSize(t,e,i,o){return e=Math.max(0,e||t.width),i=i||t.height,{width:e,height:Math.max(0,o?Math.floor(e/o):i)}}isAttached(t){return!0}updateConfig(t){}}class nd extends Ja{acquireContext(t){return t&&t.getContext&&t.getContext("2d")||null}updateConfig(t){t.options.animation=!1}}const _i="$chartjs",id={touchstart:"mousedown",touchmove:"mousemove",touchend:"mouseup",pointerenter:"mouseenter",pointerdown:"mousedown",pointermove:"mousemove",pointerup:"mouseup",pointerleave:"mouseout",pointerout:"mouseout"},Is=n=>n===null||n==="";function od(n,t){const e=n.style,i=n.getAttribute("height"),o=n.getAttribute("width");if(n[_i]={initial:{height:i,width:o,style:{display:e.display,height:e.height,width:e.width}}},e.display=e.display||"block",e.boxSizing=e.boxSizing||"border-box",Is(o)){const s=us(n,"width");s!==void 0&&(n.width=s)}if(Is(i))if(n.style.height==="")n.height=n.width/(t||2);else{const s=us(n,"height");s!==void 0&&(n.height=s)}return n}const Za=sc?{passive:!0}:!1;function sd(n,t,e){n&&n.addEventListener(t,e,Za)}function ad(n,t,e){n&&n.canvas&&n.canvas.removeEventListener(t,e,Za)}function rd(n,t){const e=id[n.type]||n.type,{x:i,y:o}=an(n,t);return{type:e,chart:t,native:n,x:i!==void 0?i:null,y:o!==void 0?o:null}}function Li(n,t){for(const e of n)if(e===t||e.contains(t))return!0}function ld(n,t,e){const i=n.canvas,o=new MutationObserver(s=>{let a=!1;for(const r of s)a=a||Li(r.addedNodes,i),a=a&&!Li(r.removedNodes,i);a&&e()});return o.observe(document,{childList:!0,subtree:!0}),o}function cd(n,t,e){const i=n.canvas,o=new MutationObserver(s=>{let a=!1;for(const r of s)a=a||Li(r.removedNodes,i),a=a&&!Li(r.addedNodes,i);a&&e()});return o.observe(document,{childList:!0,subtree:!0}),o}const Gn=new Map;let Ms=0;function Qa(){const n=window.devicePixelRatio;n!==Ms&&(Ms=n,Gn.forEach((t,e)=>{e.currentDevicePixelRatio!==n&&t()}))}function dd(n,t){Gn.size||window.addEventListener("resize",Qa),Gn.set(n,t)}function ud(n){Gn.delete(n),Gn.size||window.removeEventListener("resize",Qa)}function fd(n,t,e){const i=n.canvas,o=i&&Ho(i);if(!o)return;const s=Ia((r,l)=>{const c=o.clientWidth;e(r,l),c<o.clientWidth&&e()},window),a=new ResizeObserver(r=>{const l=r[0],c=l.contentRect.width,d=l.contentRect.height;c===0&&d===0||s(c,d)});return a.observe(o),dd(n,s),a}function io(n,t,e){e&&e.disconnect(),t==="resize"&&ud(n)}function hd(n,t,e){const i=n.canvas,o=Ia(s=>{n.ctx!==null&&e(rd(s,n))},n);return sd(i,t,o),o}class pd extends Ja{acquireContext(t,e){const i=t&&t.getContext&&t.getContext("2d");return i&&i.canvas===t?(od(t,e),i):null}releaseContext(t){const e=t.canvas;if(!e[_i])return!1;const i=e[_i].initial;["height","width"].forEach(s=>{const a=i[s];At(a)?e.removeAttribute(s):e.setAttribute(s,a)});const o=i.style||{};return Object.keys(o).forEach(s=>{e.style[s]=o[s]}),e.width=e.width,delete e[_i],!0}addEventListener(t,e,i){this.removeEventListener(t,e);const o=t.$proxies||(t.$proxies={}),a={attach:ld,detach:cd,resize:fd}[e]||hd;o[e]=a(t,e,i)}removeEventListener(t,e){const i=t.$proxies||(t.$proxies={}),o=i[e];if(!o)return;({attach:io,detach:io,resize:io}[e]||ad)(t,e,o),i[e]=void 0}getDevicePixelRatio(){return window.devicePixelRatio}getMaximumSize(t,e,i,o){return oc(t,e,i,o)}isAttached(t){const e=t&&Ho(t);return!!(e&&e.isConnected)}}function md(n){return!Uo()||typeof OffscreenCanvas<"u"&&n instanceof OffscreenCanvas?nd:pd}class Ce{constructor(){mt(this,"x");mt(this,"y");mt(this,"active",!1);mt(this,"options");mt(this,"$animations")}tooltipPosition(t){const{x:e,y:i}=this.getProps(["x","y"],t);return{x:e,y:i}}hasValue(){return bn(this.x)&&bn(this.y)}getProps(t,e){const i=this.$animations;if(!e||!i)return this;const o={};return t.forEach(s=>{o[s]=i[s]&&i[s].active()?i[s]._to:this[s]}),o}}mt(Ce,"defaults",{}),mt(Ce,"defaultRoutes");function gd(n,t){const e=n.options.ticks,i=vd(n),o=Math.min(e.maxTicksLimit||i,i),s=e.major.enabled?yd(t):[],a=s.length,r=s[0],l=s[a-1],c=[];if(a>o)return wd(t,c,s,a/o),c;const d=bd(s,t,o);if(a>0){let f,p;const m=a>1?Math.round((l-r)/(a-1)):null;for(ri(t,c,d,At(m)?0:r-m,r),f=0,p=a-1;f<p;f++)ri(t,c,d,s[f],s[f+1]);return ri(t,c,d,l,At(m)?t.length:l+m),c}return ri(t,c,d),c}function vd(n){const t=n.options.offset,e=n._tickSize(),i=n._length/e+(t?0:1),o=n._maxLength/e;return Math.floor(Math.min(i,o))}function bd(n,t,e){const i=_d(n),o=t.length/e;if(!i)return Math.max(o,1);const s=rl(i);for(let a=0,r=s.length-1;a<r;a++){const l=s[a];if(l>o)return l}return Math.max(o,1)}function yd(n){const t=[];let e,i;for(e=0,i=n.length;e<i;e++)n[e].major&&t.push(e);return t}function wd(n,t,e,i){let o=0,s=e[0],a;for(i=Math.ceil(i),a=0;a<n.length;a++)a===s&&(t.push(n[a]),o++,s=e[o*i])}function ri(n,t,e,i,o){const s=Tt(i,0),a=Math.min(Tt(o,n.length),n.length);let r=0,l,c,d;for(e=Math.ceil(e),o&&(l=o-i,e=l/Math.floor(l/e)),d=s;d<0;)r++,d=Math.round(s+r*e);for(c=Math.max(s,0);c<a;c++)c===d&&(t.push(n[c]),r++,d=Math.round(s+r*e))}function _d(n){const t=n.length;let e,i;if(t<2)return!1;for(i=n[0],e=1;e<t;++e)if(n[e]-n[e-1]!==i)return!1;return i}const xd=n=>n==="left"?"right":n==="right"?"left":n,Es=(n,t,e)=>t==="top"||t==="left"?n[t]+e:n[t]-e,Ps=(n,t)=>Math.min(t||n,n);function As(n,t){const e=[],i=n.length/t,o=n.length;let s=0;for(;s<o;s+=i)e.push(n[Math.floor(s)]);return e}function Sd(n,t,e){const i=n.ticks.length,o=Math.min(t,i-1),s=n._startPixel,a=n._endPixel,r=1e-6;let l=n.getPixelForTick(o),c;if(!(e&&(i===1?c=Math.max(l-s,a-l):t===0?c=(n.getPixelForTick(1)-l)/2:c=(l-n.getPixelForTick(o-1))/2,l+=o<t?c:-c,l<s-r||l>a+r)))return l}function Cd(n,t){Ut(n,e=>{const i=e.gc,o=i.length/2;let s;if(o>t){for(s=0;s<o;++s)delete e.data[i[s]];i.splice(0,o)}})}function Tn(n){return n.drawTicks?n.tickLength:0}function Bs(n,t){if(!n.display)return 0;const e=te(n.font,t),i=ce(n.padding);return($t(n.text)?n.text.length:1)*e.lineHeight+i.height}function Dd(n,t){return Ze(n,{scale:t,type:"scale"})}function kd(n,t,e){return Ze(n,{tick:e,index:t,type:"tick"})}function Td(n,t,e){let i=Oo(n);return(e&&t!=="right"||!e&&t==="right")&&(i=xd(i)),i}function Id(n,t,e,i){const{top:o,left:s,bottom:a,right:r,chart:l}=n,{chartArea:c,scales:d}=l;let f=0,p,m,_;const S=a-o,k=r-s;if(n.isHorizontal()){if(m=ae(i,s,r),Bt(e)){const O=Object.keys(e)[0],F=e[O];_=d[O].getPixelForValue(F)+S-t}else e==="center"?_=(c.bottom+c.top)/2+S-t:_=Es(n,e,t);p=r-s}else{if(Bt(e)){const O=Object.keys(e)[0],F=e[O];m=d[O].getPixelForValue(F)-k+t}else e==="center"?m=(c.left+c.right)/2-k+t:m=Es(n,e,t);_=ae(i,a,o),f=e==="left"?-Jt:Jt}return{titleX:m,titleY:_,maxWidth:p,rotation:f}}class hn extends Ce{constructor(t){super(),this.id=t.id,this.type=t.type,this.options=void 0,this.ctx=t.ctx,this.chart=t.chart,this.top=void 0,this.bottom=void 0,this.left=void 0,this.right=void 0,this.width=void 0,this.height=void 0,this._margins={left:0,right:0,top:0,bottom:0},this.maxWidth=void 0,this.maxHeight=void 0,this.paddingTop=void 0,this.paddingBottom=void 0,this.paddingLeft=void 0,this.paddingRight=void 0,this.axis=void 0,this.labelRotation=void 0,this.min=void 0,this.max=void 0,this._range=void 0,this.ticks=[],this._gridLineItems=null,this._labelItems=null,this._labelSizes=null,this._length=0,this._maxLength=0,this._longestTextCache={},this._startPixel=void 0,this._endPixel=void 0,this._reversePixels=!1,this._userMax=void 0,this._userMin=void 0,this._suggestedMax=void 0,this._suggestedMin=void 0,this._ticksLength=0,this._borderValue=0,this._cache={},this._dataLimitsCached=!1,this.$context=void 0}init(t){this.options=t.setContext(this.getContext()),this.axis=t.axis,this._userMin=this.parse(t.min),this._userMax=this.parse(t.max),this._suggestedMin=this.parse(t.suggestedMin),this._suggestedMax=this.parse(t.suggestedMax)}parse(t,e){return t}getUserBounds(){let{_userMin:t,_userMax:e,_suggestedMin:i,_suggestedMax:o}=this;return t=be(t,Number.POSITIVE_INFINITY),e=be(e,Number.NEGATIVE_INFINITY),i=be(i,Number.POSITIVE_INFINITY),o=be(o,Number.NEGATIVE_INFINITY),{min:be(t,i),max:be(e,o),minDefined:Xt(t),maxDefined:Xt(e)}}getMinMax(t){let{min:e,max:i,minDefined:o,maxDefined:s}=this.getUserBounds(),a;if(o&&s)return{min:e,max:i};const r=this.getMatchingVisibleMetas();for(let l=0,c=r.length;l<c;++l)a=r[l].controller.getMinMax(this,t),o||(e=Math.min(e,a.min)),s||(i=Math.max(i,a.max));return e=s&&e>i?i:e,i=o&&e>i?e:i,{min:be(e,be(i,e)),max:be(i,be(e,i))}}getPadding(){return{left:this.paddingLeft||0,top:this.paddingTop||0,right:this.paddingRight||0,bottom:this.paddingBottom||0}}getTicks(){return this.ticks}getLabels(){const t=this.chart.data;return this.options.labels||(this.isHorizontal()?t.xLabels:t.yLabels)||t.labels||[]}getLabelItems(t=this.chart.chartArea){return this._labelItems||(this._labelItems=this._computeLabelItems(t))}beforeLayout(){this._cache={},this._dataLimitsCached=!1}beforeUpdate(){jt(this.options.beforeUpdate,[this])}update(t,e,i){const{beginAtZero:o,grace:s,ticks:a}=this.options,r=a.sampleSize;this.beforeUpdate(),this.maxWidth=t,this.maxHeight=e,this._margins=i=Object.assign({left:0,right:0,top:0,bottom:0},i),this.ticks=null,this._labelSizes=null,this._gridLineItems=null,this._labelItems=null,this.beforeSetDimensions(),this.setDimensions(),this.afterSetDimensions(),this._maxLength=this.isHorizontal()?this.width+i.left+i.right:this.height+i.top+i.bottom,this._dataLimitsCached||(this.beforeDataLimits(),this.determineDataLimits(),this.afterDataLimits(),this._range=Fl(this,s,o),this._dataLimitsCached=!0),this.beforeBuildTicks(),this.ticks=this.buildTicks()||[],this.afterBuildTicks();const l=r<this.ticks.length;this._convertTicksToLabels(l?As(this.ticks,r):this.ticks),this.configure(),this.beforeCalculateLabelRotation(),this.calculateLabelRotation(),this.afterCalculateLabelRotation(),a.display&&(a.autoSkip||a.source==="auto")&&(this.ticks=gd(this,this.ticks),this._labelSizes=null,this.afterAutoSkip()),l&&this._convertTicksToLabels(this.ticks),this.beforeFit(),this.fit(),this.afterFit(),this.afterUpdate()}configure(){let t=this.options.reverse,e,i;this.isHorizontal()?(e=this.left,i=this.right):(e=this.top,i=this.bottom,t=!t),this._startPixel=e,this._endPixel=i,this._reversePixels=t,this._length=i-e,this._alignToPixels=this.options.alignToPixels}afterUpdate(){jt(this.options.afterUpdate,[this])}beforeSetDimensions(){jt(this.options.beforeSetDimensions,[this])}setDimensions(){this.isHorizontal()?(this.width=this.maxWidth,this.left=0,this.right=this.width):(this.height=this.maxHeight,this.top=0,this.bottom=this.height),this.paddingLeft=0,this.paddingTop=0,this.paddingRight=0,this.paddingBottom=0}afterSetDimensions(){jt(this.options.afterSetDimensions,[this])}_callHooks(t){this.chart.notifyPlugins(t,this.getContext()),jt(this.options[t],[this])}beforeDataLimits(){this._callHooks("beforeDataLimits")}determineDataLimits(){}afterDataLimits(){this._callHooks("afterDataLimits")}beforeBuildTicks(){this._callHooks("beforeBuildTicks")}buildTicks(){return[]}afterBuildTicks(){this._callHooks("afterBuildTicks")}beforeTickToLabelConversion(){jt(this.options.beforeTickToLabelConversion,[this])}generateTickLabels(t){const e=this.options.ticks;let i,o,s;for(i=0,o=t.length;i<o;i++)s=t[i],s.label=jt(e.callback,[s.value,i,t],this)}afterTickToLabelConversion(){jt(this.options.afterTickToLabelConversion,[this])}beforeCalculateLabelRotation(){jt(this.options.beforeCalculateLabelRotation,[this])}calculateLabelRotation(){const t=this.options,e=t.ticks,i=Ps(this.ticks.length,t.ticks.maxTicksLimit),o=e.minRotation||0,s=e.maxRotation;let a=o,r,l,c;if(!this._isVisible()||!e.display||o>=s||i<=1||!this.isHorizontal()){this.labelRotation=o;return}const d=this._getLabelSizes(),f=d.widest.width,p=d.highest.height,m=ne(this.chart.width-f,0,this.maxWidth);r=t.offset?this.maxWidth/i:m/(i-1),f+6>r&&(r=m/(i-(t.offset?.5:1)),l=this.maxHeight-Tn(t.grid)-e.padding-Bs(t.title,this.chart.options.font),c=Math.sqrt(f*f+p*p),a=Bo(Math.min(Math.asin(ne((d.highest.height+6)/r,-1,1)),Math.asin(ne(l/c,-1,1))-Math.asin(ne(p/c,-1,1)))),a=Math.max(o,Math.min(s,a))),this.labelRotation=a}afterCalculateLabelRotation(){jt(this.options.afterCalculateLabelRotation,[this])}afterAutoSkip(){}beforeFit(){jt(this.options.beforeFit,[this])}fit(){const t={width:0,height:0},{chart:e,options:{ticks:i,title:o,grid:s}}=this,a=this._isVisible(),r=this.isHorizontal();if(a){const l=Bs(o,e.options.font);if(r?(t.width=this.maxWidth,t.height=Tn(s)+l):(t.height=this.maxHeight,t.width=Tn(s)+l),i.display&&this.ticks.length){const{first:c,last:d,widest:f,highest:p}=this._getLabelSizes(),m=i.padding*2,_=xe(this.labelRotation),S=Math.cos(_),k=Math.sin(_);if(r){const O=i.mirror?0:k*f.width+S*p.height;t.height=Math.min(this.maxHeight,t.height+O+m)}else{const O=i.mirror?0:S*f.width+k*p.height;t.width=Math.min(this.maxWidth,t.width+O+m)}this._calculatePadding(c,d,k,S)}}this._handleMargins(),r?(this.width=this._length=e.width-this._margins.left-this._margins.right,this.height=t.height):(this.width=t.width,this.height=this._length=e.height-this._margins.top-this._margins.bottom)}_calculatePadding(t,e,i,o){const{ticks:{align:s,padding:a},position:r}=this.options,l=this.labelRotation!==0,c=r!=="top"&&this.axis==="x";if(this.isHorizontal()){const d=this.getPixelForTick(0)-this.left,f=this.right-this.getPixelForTick(this.ticks.length-1);let p=0,m=0;l?c?(p=o*t.width,m=i*e.height):(p=i*t.height,m=o*e.width):s==="start"?m=e.width:s==="end"?p=t.width:s!=="inner"&&(p=t.width/2,m=e.width/2),this.paddingLeft=Math.max((p-d+a)*this.width/(this.width-d),0),this.paddingRight=Math.max((m-f+a)*this.width/(this.width-f),0)}else{let d=e.height/2,f=t.height/2;s==="start"?(d=0,f=t.height):s==="end"&&(d=e.height,f=0),this.paddingTop=d+a,this.paddingBottom=f+a}}_handleMargins(){this._margins&&(this._margins.left=Math.max(this.paddingLeft,this._margins.left),this._margins.top=Math.max(this.paddingTop,this._margins.top),this._margins.right=Math.max(this.paddingRight,this._margins.right),this._margins.bottom=Math.max(this.paddingBottom,this._margins.bottom))}afterFit(){jt(this.options.afterFit,[this])}isHorizontal(){const{axis:t,position:e}=this.options;return e==="top"||e==="bottom"||t==="x"}isFullSize(){return this.options.fullSize}_convertTicksToLabels(t){this.beforeTickToLabelConversion(),this.generateTickLabels(t);let e,i;for(e=0,i=t.length;e<i;e++)At(t[e].label)&&(t.splice(e,1),i--,e--);this.afterTickToLabelConversion()}_getLabelSizes(){let t=this._labelSizes;if(!t){const e=this.options.ticks.sampleSize;let i=this.ticks;e<i.length&&(i=As(i,e)),this._labelSizes=t=this._computeLabelSizes(i,i.length,this.options.ticks.maxTicksLimit)}return t}_computeLabelSizes(t,e,i){const{ctx:o,_longestTextCache:s}=this,a=[],r=[],l=Math.floor(e/Ps(e,i));let c=0,d=0,f,p,m,_,S,k,O,F,X,et,T;for(f=0;f<e;f+=l){if(_=t[f].label,S=this._resolveTickFontOptions(f),o.font=k=S.string,O=s[k]=s[k]||{data:{},gc:[]},F=S.lineHeight,X=et=0,!At(_)&&!$t(_))X=Ai(o,O.data,O.gc,X,_),et=F;else if($t(_))for(p=0,m=_.length;p<m;++p)T=_[p],!At(T)&&!$t(T)&&(X=Ai(o,O.data,O.gc,X,T),et+=F);a.push(X),r.push(et),c=Math.max(X,c),d=Math.max(et,d)}Cd(s,e);const D=a.indexOf(c),E=r.indexOf(d),P=R=>({width:a[R]||0,height:r[R]||0});return{first:P(0),last:P(e-1),widest:P(D),highest:P(E),widths:a,heights:r}}getLabelForValue(t){return t}getPixelForValue(t,e){return NaN}getValueForPixel(t){}getPixelForTick(t){const e=this.ticks;return t<0||t>e.length-1?null:this.getPixelForValue(e[t].value)}getPixelForDecimal(t){this._reversePixels&&(t=1-t);const e=this._startPixel+t*this._length;return ul(this._alignToPixels?en(this.chart,e,0):e)}getDecimalForPixel(t){const e=(t-this._startPixel)/this._length;return this._reversePixels?1-e:e}getBasePixel(){return this.getPixelForValue(this.getBaseValue())}getBaseValue(){const{min:t,max:e}=this;return t<0&&e<0?e:t>0&&e>0?t:0}getContext(t){const e=this.ticks||[];if(t>=0&&t<e.length){const i=e[t];return i.$context||(i.$context=kd(this.getContext(),t,i))}return this.$context||(this.$context=Dd(this.chart.getContext(),this))}_tickSize(){const t=this.options.ticks,e=xe(this.labelRotation),i=Math.abs(Math.cos(e)),o=Math.abs(Math.sin(e)),s=this._getLabelSizes(),a=t.autoSkipPadding||0,r=s?s.widest.width+a:0,l=s?s.highest.height+a:0;return this.isHorizontal()?l*i>r*o?r/i:l/o:l*o<r*i?l/i:r/o}_isVisible(){const t=this.options.display;return t!=="auto"?!!t:this.getMatchingVisibleMetas().length>0}_computeGridLineItems(t){const e=this.axis,i=this.chart,o=this.options,{grid:s,position:a,border:r}=o,l=s.offset,c=this.isHorizontal(),f=this.ticks.length+(l?1:0),p=Tn(s),m=[],_=r.setContext(this.getContext()),S=_.display?_.width:0,k=S/2,O=function(rt){return en(i,rt,S)};let F,X,et,T,D,E,P,R,N,$,H,nt;if(a==="top")F=O(this.bottom),E=this.bottom-p,R=F-k,$=O(t.top)+k,nt=t.bottom;else if(a==="bottom")F=O(this.top),$=t.top,nt=O(t.bottom)-k,E=F+k,R=this.top+p;else if(a==="left")F=O(this.right),D=this.right-p,P=F-k,N=O(t.left)+k,H=t.right;else if(a==="right")F=O(this.left),N=t.left,H=O(t.right)-k,D=F+k,P=this.left+p;else if(e==="x"){if(a==="center")F=O((t.top+t.bottom)/2+.5);else if(Bt(a)){const rt=Object.keys(a)[0],Y=a[rt];F=O(this.chart.scales[rt].getPixelForValue(Y))}$=t.top,nt=t.bottom,E=F+k,R=E+p}else if(e==="y"){if(a==="center")F=O((t.left+t.right)/2);else if(Bt(a)){const rt=Object.keys(a)[0],Y=a[rt];F=O(this.chart.scales[rt].getPixelForValue(Y))}D=F-k,P=D-p,N=t.left,H=t.right}const j=Tt(o.ticks.maxTicksLimit,f),K=Math.max(1,Math.ceil(f/j));for(X=0;X<f;X+=K){const rt=this.getContext(X),Y=s.setContext(rt),Q=r.setContext(rt),it=Y.lineWidth,tt=Y.color,J=Q.dash||[],W=Q.dashOffset,ut=Y.tickWidth,st=Y.tickColor,ht=Y.tickBorderDash||[],b=Y.tickBorderDashOffset;et=Sd(this,X,l),et!==void 0&&(T=en(i,et,it),c?D=P=N=H=T:E=R=$=nt=T,m.push({tx1:D,ty1:E,tx2:P,ty2:R,x1:N,y1:$,x2:H,y2:nt,width:it,color:tt,borderDash:J,borderDashOffset:W,tickWidth:ut,tickColor:st,tickBorderDash:ht,tickBorderDashOffset:b}))}return this._ticksLength=f,this._borderValue=F,m}_computeLabelItems(t){const e=this.axis,i=this.options,{position:o,ticks:s}=i,a=this.isHorizontal(),r=this.ticks,{align:l,crossAlign:c,padding:d,mirror:f}=s,p=Tn(i.grid),m=p+d,_=f?-d:m,S=-xe(this.labelRotation),k=[];let O,F,X,et,T,D,E,P,R,N,$,H,nt="middle";if(o==="top")D=this.bottom-_,E=this._getXAxisLabelAlignment();else if(o==="bottom")D=this.top+_,E=this._getXAxisLabelAlignment();else if(o==="left"){const K=this._getYAxisLabelAlignment(p);E=K.textAlign,T=K.x}else if(o==="right"){const K=this._getYAxisLabelAlignment(p);E=K.textAlign,T=K.x}else if(e==="x"){if(o==="center")D=(t.top+t.bottom)/2+m;else if(Bt(o)){const K=Object.keys(o)[0],rt=o[K];D=this.chart.scales[K].getPixelForValue(rt)+m}E=this._getXAxisLabelAlignment()}else if(e==="y"){if(o==="center")T=(t.left+t.right)/2-m;else if(Bt(o)){const K=Object.keys(o)[0],rt=o[K];T=this.chart.scales[K].getPixelForValue(rt)}E=this._getYAxisLabelAlignment(p).textAlign}e==="y"&&(l==="start"?nt="top":l==="end"&&(nt="bottom"));const j=this._getLabelSizes();for(O=0,F=r.length;O<F;++O){X=r[O],et=X.label;const K=s.setContext(this.getContext(O));P=this.getPixelForTick(O)+s.labelOffset,R=this._resolveTickFontOptions(O),N=R.lineHeight,$=$t(et)?et.length:1;const rt=$/2,Y=K.color,Q=K.textStrokeColor,it=K.textStrokeWidth;let tt=E;a?(T=P,E==="inner"&&(O===F-1?tt=this.options.reverse?"left":"right":O===0?tt=this.options.reverse?"right":"left":tt="center"),o==="top"?c==="near"||S!==0?H=-$*N+N/2:c==="center"?H=-j.highest.height/2-rt*N+N:H=-j.highest.height+N/2:c==="near"||S!==0?H=N/2:c==="center"?H=j.highest.height/2-rt*N:H=j.highest.height-$*N,f&&(H*=-1),S!==0&&!K.showLabelBackdrop&&(T+=N/2*Math.sin(S))):(D=P,H=(1-$)*N/2);let J;if(K.showLabelBackdrop){const W=ce(K.backdropPadding),ut=j.heights[O],st=j.widths[O];let ht=H-W.top,b=0-W.left;switch(nt){case"middle":ht-=ut/2;break;case"bottom":ht-=ut;break}switch(E){case"center":b-=st/2;break;case"right":b-=st;break;case"inner":O===F-1?b-=st:O>0&&(b-=st/2);break}J={left:b,top:ht,width:st+W.width,height:ut+W.height,color:K.backdropColor}}k.push({label:et,font:R,textOffset:H,options:{rotation:S,color:Y,strokeColor:Q,strokeWidth:it,textAlign:tt,textBaseline:nt,translation:[T,D],backdrop:J}})}return k}_getXAxisLabelAlignment(){const{position:t,ticks:e}=this.options;if(-xe(this.labelRotation))return t==="top"?"left":"right";let o="center";return e.align==="start"?o="left":e.align==="end"?o="right":e.align==="inner"&&(o="inner"),o}_getYAxisLabelAlignment(t){const{position:e,ticks:{crossAlign:i,mirror:o,padding:s}}=this.options,a=this._getLabelSizes(),r=t+s,l=a.widest.width;let c,d;return e==="left"?o?(d=this.right+s,i==="near"?c="left":i==="center"?(c="center",d+=l/2):(c="right",d+=l)):(d=this.right-r,i==="near"?c="right":i==="center"?(c="center",d-=l/2):(c="left",d=this.left)):e==="right"?o?(d=this.left+s,i==="near"?c="right":i==="center"?(c="center",d-=l/2):(c="left",d-=l)):(d=this.left+r,i==="near"?c="left":i==="center"?(c="center",d+=l/2):(c="right",d=this.right)):c="right",{textAlign:c,x:d}}_computeLabelArea(){if(this.options.ticks.mirror)return;const t=this.chart,e=this.options.position;if(e==="left"||e==="right")return{top:0,left:this.left,bottom:t.height,right:this.right};if(e==="top"||e==="bottom")return{top:this.top,left:0,bottom:this.bottom,right:t.width}}drawBackground(){const{ctx:t,options:{backgroundColor:e},left:i,top:o,width:s,height:a}=this;e&&(t.save(),t.fillStyle=e,t.fillRect(i,o,s,a),t.restore())}getLineWidthForValue(t){const e=this.options.grid;if(!this._isVisible()||!e.display)return 0;const o=this.ticks.findIndex(s=>s.value===t);return o>=0?e.setContext(this.getContext(o)).lineWidth:0}drawGrid(t){const e=this.options.grid,i=this.ctx,o=this._gridLineItems||(this._gridLineItems=this._computeGridLineItems(t));let s,a;const r=(l,c,d)=>{!d.width||!d.color||(i.save(),i.lineWidth=d.width,i.strokeStyle=d.color,i.setLineDash(d.borderDash||[]),i.lineDashOffset=d.borderDashOffset,i.beginPath(),i.moveTo(l.x,l.y),i.lineTo(c.x,c.y),i.stroke(),i.restore())};if(e.display)for(s=0,a=o.length;s<a;++s){const l=o[s];e.drawOnChartArea&&r({x:l.x1,y:l.y1},{x:l.x2,y:l.y2},l),e.drawTicks&&r({x:l.tx1,y:l.ty1},{x:l.tx2,y:l.ty2},{color:l.tickColor,width:l.tickWidth,borderDash:l.tickBorderDash,borderDashOffset:l.tickBorderDashOffset})}}drawBorder(){const{chart:t,ctx:e,options:{border:i,grid:o}}=this,s=i.setContext(this.getContext()),a=i.display?s.width:0;if(!a)return;const r=o.setContext(this.getContext(0)).lineWidth,l=this._borderValue;let c,d,f,p;this.isHorizontal()?(c=en(t,this.left,a)-a/2,d=en(t,this.right,r)+r/2,f=p=l):(f=en(t,this.top,a)-a/2,p=en(t,this.bottom,r)+r/2,c=d=l),e.save(),e.lineWidth=s.width,e.strokeStyle=s.color,e.beginPath(),e.moveTo(c,f),e.lineTo(d,p),e.stroke(),e.restore()}drawLabels(t){if(!this.options.ticks.display)return;const i=this.ctx,o=this._computeLabelArea();o&&zi(i,o);const s=this.getLabelItems(t);for(const a of s){const r=a.options,l=a.font,c=a.label,d=a.textOffset;fn(i,c,0,d,l,r)}o&&Vi(i)}drawTitle(){const{ctx:t,options:{position:e,title:i,reverse:o}}=this;if(!i.display)return;const s=te(i.font),a=ce(i.padding),r=i.align;let l=s.lineHeight/2;e==="bottom"||e==="center"||Bt(e)?(l+=a.bottom,$t(i.text)&&(l+=s.lineHeight*(i.text.length-1))):l+=a.top;const{titleX:c,titleY:d,maxWidth:f,rotation:p}=Id(this,l,e,r);fn(t,i.text,0,0,s,{color:i.color,maxWidth:f,rotation:p,textAlign:Td(r,e,o),textBaseline:"middle",translation:[c,d]})}draw(t){this._isVisible()&&(this.drawBackground(),this.drawGrid(t),this.drawBorder(),this.drawTitle(),this.drawLabels(t))}_layers(){const t=this.options,e=t.ticks&&t.ticks.z||0,i=Tt(t.grid&&t.grid.z,-1),o=Tt(t.border&&t.border.z,0);return!this._isVisible()||this.draw!==hn.prototype.draw?[{z:e,draw:s=>{this.draw(s)}}]:[{z:i,draw:s=>{this.drawBackground(),this.drawGrid(s),this.drawTitle()}},{z:o,draw:()=>{this.drawBorder()}},{z:e,draw:s=>{this.drawLabels(s)}}]}getMatchingVisibleMetas(t){const e=this.chart.getSortedVisibleDatasetMetas(),i=this.axis+"AxisID",o=[];let s,a;for(s=0,a=e.length;s<a;++s){const r=e[s];r[i]===this.id&&(!t||r.type===t)&&o.push(r)}return o}_resolveTickFontOptions(t){const e=this.options.ticks.setContext(this.getContext(t));return te(e.font)}_maxDigits(){const t=this._resolveTickFontOptions(0).lineHeight;return(this.isHorizontal()?this.width:this.height)/t}}class li{constructor(t,e,i){this.type=t,this.scope=e,this.override=i,this.items=Object.create(null)}isForType(t){return Object.prototype.isPrototypeOf.call(this.type.prototype,t.prototype)}register(t){const e=Object.getPrototypeOf(t);let i;Pd(e)&&(i=this.register(e));const o=this.items,s=t.id,a=this.scope+"."+s;if(!s)throw new Error("class does not have id: "+t);return s in o||(o[s]=t,Md(t,a,i),this.override&&qt.override(t.id,t.overrides)),a}get(t){return this.items[t]}unregister(t){const e=this.items,i=t.id,o=this.scope;i in e&&delete e[i],o&&i in qt[o]&&(delete qt[o][i],this.override&&delete un[i])}}function Md(n,t,e){const i=Wn(Object.create(null),[e?qt.get(e):{},qt.get(t),n.defaults]);qt.set(t,i),n.defaultRoutes&&Ed(t,n.defaultRoutes),n.descriptors&&qt.describe(t,n.descriptors)}function Ed(n,t){Object.keys(t).forEach(e=>{const i=e.split("."),o=i.pop(),s=[n].concat(i).join("."),a=t[e].split("."),r=a.pop(),l=a.join(".");qt.route(s,o,l,r)})}function Pd(n){return"id"in n&&"defaults"in n}class Ad{constructor(){this.controllers=new li(Se,"datasets",!0),this.elements=new li(Ce,"elements"),this.plugins=new li(Object,"plugins"),this.scales=new li(hn,"scales"),this._typedRegistries=[this.controllers,this.scales,this.elements]}add(...t){this._each("register",t)}remove(...t){this._each("unregister",t)}addControllers(...t){this._each("register",t,this.controllers)}addElements(...t){this._each("register",t,this.elements)}addPlugins(...t){this._each("register",t,this.plugins)}addScales(...t){this._each("register",t,this.scales)}getController(t){return this._get(t,this.controllers,"controller")}getElement(t){return this._get(t,this.elements,"element")}getPlugin(t){return this._get(t,this.plugins,"plugin")}getScale(t){return this._get(t,this.scales,"scale")}removeControllers(...t){this._each("unregister",t,this.controllers)}removeElements(...t){this._each("unregister",t,this.elements)}removePlugins(...t){this._each("unregister",t,this.plugins)}removeScales(...t){this._each("unregister",t,this.scales)}_each(t,e,i){[...e].forEach(o=>{const s=i||this._getRegistryForType(o);i||s.isForType(o)||s===this.plugins&&o.id?this._exec(t,s,o):Ut(o,a=>{const r=i||this._getRegistryForType(a);this._exec(t,r,a)})})}_exec(t,e,i){const o=Ao(t);jt(i["before"+o],[],i),e[t](i),jt(i["after"+o],[],i)}_getRegistryForType(t){for(let e=0;e<this._typedRegistries.length;e++){const i=this._typedRegistries[e];if(i.isForType(t))return i}return this.plugins}_get(t,e,i){const o=e.get(t);if(o===void 0)throw new Error('"'+t+'" is not a registered '+i+".");return o}}var Me=new Ad;class Bd{constructor(){this._init=[]}notify(t,e,i,o){e==="beforeInit"&&(this._init=this._createDescriptors(t,!0),this._notify(this._init,t,"install"));const s=o?this._descriptors(t).filter(o):this._descriptors(t),a=this._notify(s,t,e,i);return e==="afterDestroy"&&(this._notify(s,t,"stop"),this._notify(this._init,t,"uninstall")),a}_notify(t,e,i,o){o=o||{};for(const s of t){const a=s.plugin,r=a[i],l=[e,o,s.options];if(jt(r,l,a)===!1&&o.cancelable)return!1}return!0}invalidate(){At(this._cache)||(this._oldCache=this._cache,this._cache=void 0)}_descriptors(t){if(this._cache)return this._cache;const e=this._cache=this._createDescriptors(t);return this._notifyStateChanges(t),e}_createDescriptors(t,e){const i=t&&t.config,o=Tt(i.options&&i.options.plugins,{}),s=Ld(i);return o===!1&&!e?[]:Fd(t,s,o,e)}_notifyStateChanges(t){const e=this._oldCache||[],i=this._cache,o=(s,a)=>s.filter(r=>!a.some(l=>r.plugin.id===l.plugin.id));this._notify(o(e,i),t,"stop"),this._notify(o(i,e),t,"start")}}function Ld(n){const t={},e=[],i=Object.keys(Me.plugins.items);for(let s=0;s<i.length;s++)e.push(Me.getPlugin(i[s]));const o=n.plugins||[];for(let s=0;s<o.length;s++){const a=o[s];e.indexOf(a)===-1&&(e.push(a),t[a.id]=!0)}return{plugins:e,localIds:t}}function Od(n,t){return!t&&n===!1?null:n===!0?{}:n}function Fd(n,{plugins:t,localIds:e},i,o){const s=[],a=n.getContext();for(const r of t){const l=r.id,c=Od(i[l],o);c!==null&&s.push({plugin:r,options:Nd(n.config,{plugin:r,local:e[l]},c,a)})}return s}function Nd(n,{plugin:t,local:e},i,o){const s=n.pluginScopeKeys(t),a=n.getOptionScopes(i,s);return e&&t.defaults&&a.push(t.defaults),n.createResolver(a,o,[""],{scriptable:!1,indexable:!1,allKeys:!0})}function bo(n,t){const e=qt.datasets[n]||{};return((t.datasets||{})[n]||{}).indexAxis||t.indexAxis||e.indexAxis||"x"}function Rd(n,t){let e=n;return n==="_index_"?e=t:n==="_value_"&&(e=t==="x"?"y":"x"),e}function zd(n,t){return n===t?"_index_":"_value_"}function Ls(n){if(n==="x"||n==="y"||n==="r")return n}function Vd(n){if(n==="top"||n==="bottom")return"x";if(n==="left"||n==="right")return"y"}function yo(n,...t){if(Ls(n))return n;for(const e of t){const i=e.axis||Vd(e.position)||n.length>1&&Ls(n[0].toLowerCase());if(i)return i}throw new Error("Cannot determine type of '".concat(n,"' axis. Please provide 'axis' or 'position' option."))}function Os(n,t,e){if(e[t+"AxisID"]===n)return{axis:t}}function Ud(n,t){if(t.data&&t.data.datasets){const e=t.data.datasets.filter(i=>i.xAxisID===n||i.yAxisID===n);if(e.length)return Os(n,"x",e[0])||Os(n,"y",e[0])}return{}}function Hd(n,t){const e=un[n.type]||{scales:{}},i=t.scales||{},o=bo(n.type,t),s=Object.create(null);return Object.keys(i).forEach(a=>{const r=i[a];if(!Bt(r))return console.error("Invalid scale configuration for scale: ".concat(a));if(r._proxy)return console.warn("Ignoring resolver passed as options for scale: ".concat(a));const l=yo(a,r,Ud(a,n),qt.scales[r.type]),c=zd(l,o),d=e.scales||{};s[a]=On(Object.create(null),[{axis:l},r,d[l],d[c]])}),n.data.datasets.forEach(a=>{const r=a.type||n.type,l=a.indexAxis||bo(r,t),d=(un[r]||{}).scales||{};Object.keys(d).forEach(f=>{const p=Rd(f,l),m=a[p+"AxisID"]||p;s[m]=s[m]||Object.create(null),On(s[m],[{axis:p},i[m],d[f]])})}),Object.keys(s).forEach(a=>{const r=s[a];On(r,[qt.scales[r.type],qt.scale])}),s}function tr(n){const t=n.options||(n.options={});t.plugins=Tt(t.plugins,{}),t.scales=Hd(n,t)}function er(n){return n=n||{},n.datasets=n.datasets||[],n.labels=n.labels||[],n}function jd(n){return n=n||{},n.data=er(n.data),tr(n),n}const Fs=new Map,nr=new Set;function ci(n,t){let e=Fs.get(n);return e||(e=t(),Fs.set(n,e),nr.add(e)),e}const In=(n,t,e)=>{const i=Ke(t,e);i!==void 0&&n.add(i)};class Wd{constructor(t){this._config=jd(t),this._scopeCache=new Map,this._resolverCache=new Map}get platform(){return this._config.platform}get type(){return this._config.type}set type(t){this._config.type=t}get data(){return this._config.data}set data(t){this._config.data=er(t)}get options(){return this._config.options}set options(t){this._config.options=t}get plugins(){return this._config.plugins}update(){const t=this._config;this.clearCache(),tr(t)}clearCache(){this._scopeCache.clear(),this._resolverCache.clear()}datasetScopeKeys(t){return ci(t,()=>[["datasets.".concat(t),""]])}datasetAnimationScopeKeys(t,e){return ci("".concat(t,".transition.").concat(e),()=>[["datasets.".concat(t,".transitions.").concat(e),"transitions.".concat(e)],["datasets.".concat(t),""]])}datasetElementScopeKeys(t,e){return ci("".concat(t,"-").concat(e),()=>[["datasets.".concat(t,".elements.").concat(e),"datasets.".concat(t),"elements.".concat(e),""]])}pluginScopeKeys(t){const e=t.id,i=this.type;return ci("".concat(i,"-plugin-").concat(e),()=>[["plugins.".concat(e),...t.additionalOptionScopes||[]]])}_cachedScopes(t,e){const i=this._scopeCache;let o=i.get(t);return(!o||e)&&(o=new Map,i.set(t,o)),o}getOptionScopes(t,e,i){const{options:o,type:s}=this,a=this._cachedScopes(t,i),r=a.get(e);if(r)return r;const l=new Set;e.forEach(d=>{t&&(l.add(t),d.forEach(f=>In(l,t,f))),d.forEach(f=>In(l,o,f)),d.forEach(f=>In(l,un[s]||{},f)),d.forEach(f=>In(l,qt,f)),d.forEach(f=>In(l,mo,f))});const c=Array.from(l);return c.length===0&&c.push(Object.create(null)),nr.has(e)&&a.set(e,c),c}chartOptionScopes(){const{options:t,type:e}=this;return[t,un[e]||{},qt.datasets[e]||{},{type:e},qt,mo]}resolveNamedOptions(t,e,i,o=[""]){const s={$shared:!0},{resolver:a,subPrefixes:r}=Ns(this._resolverCache,t,o);let l=a;if($d(a,e)){s.$shared=!1,i=Je(i)?i():i;const c=this.createResolver(t,i,r);l=yn(a,i,c)}for(const c of e)s[c]=l[c];return s}createResolver(t,e,i=[""],o){const{resolver:s}=Ns(this._resolverCache,t,i);return Bt(e)?yn(s,e,void 0,o):s}}function Ns(n,t,e){let i=n.get(t);i||(i=new Map,n.set(t,i));const o=e.join();let s=i.get(o);return s||(s={resolver:Ro(t,e),subPrefixes:e.filter(r=>!r.toLowerCase().includes("hover"))},i.set(o,s)),s}const Yd=n=>Bt(n)&&Object.getOwnPropertyNames(n).some(t=>Je(n[t]));function $d(n,t){const{isScriptable:e,isIndexable:i}=La(n);for(const o of t){const s=e(o),a=i(o),r=(a||s)&&n[o];if(s&&(Je(r)||Yd(r))||a&&$t(r))return!0}return!1}var qd="4.5.0";const Gd=["top","bottom","left","right","chartArea"];function Rs(n,t){return n==="top"||n==="bottom"||Gd.indexOf(n)===-1&&t==="x"}function zs(n,t){return function(e,i){return e[n]===i[n]?e[t]-i[t]:e[n]-i[n]}}function Vs(n){const t=n.chart,e=t.options.animation;t.notifyPlugins("afterRender"),jt(e&&e.onComplete,[n],t)}function Xd(n){const t=n.chart,e=t.options.animation;jt(e&&e.onProgress,[n],t)}function ir(n){return Uo()&&typeof n=="string"?n=document.getElementById(n):n&&n.length&&(n=n[0]),n&&n.canvas&&(n=n.canvas),n}const xi={},Us=n=>{const t=ir(n);return Object.values(xi).filter(e=>e.canvas===t).pop()};function Kd(n,t,e){const i=Object.keys(n);for(const o of i){const s=+o;if(s>=t){const a=n[o];delete n[o],(e>0||s>t)&&(n[s+e]=a)}}}function Jd(n,t,e,i){return!e||n.type==="mouseout"?null:i?t:n}var je;let Re=(je=class{static register(...t){Me.add(...t),Hs()}static unregister(...t){Me.remove(...t),Hs()}constructor(t,e){const i=this.config=new Wd(e),o=ir(t),s=Us(o);if(s)throw new Error("Canvas is already in use. Chart with ID '"+s.id+"' must be destroyed before the canvas with ID '"+s.canvas.id+"' can be reused.");const a=i.createResolver(i.chartOptionScopes(),this.getContext());this.platform=new(i.platform||md(o)),this.platform.updateConfig(i);const r=this.platform.acquireContext(o,a.aspectRatio),l=r&&r.canvas,c=l&&l.height,d=l&&l.width;if(this.id=Zr(),this.ctx=r,this.canvas=l,this.width=d,this.height=c,this._options=a,this._aspectRatio=this.aspectRatio,this._layers=[],this._metasets=[],this._stacks=void 0,this.boxes=[],this.currentDevicePixelRatio=void 0,this.chartArea=void 0,this._active=[],this._lastEvent=void 0,this._listeners={},this._responsiveListeners=void 0,this._sortedMetasets=[],this.scales={},this._plugins=new Bd,this.$proxies={},this._hiddenIndices={},this.attached=!1,this._animationsDisabled=void 0,this.$context=void 0,this._doResize=ml(f=>this.update(f),a.resizeDelay||0),this._dataChanges=[],xi[this.id]=this,!r||!l){console.error("Failed to create chart: can't acquire context from the given item");return}Oe.listen(this,"complete",Vs),Oe.listen(this,"progress",Xd),this._initialize(),this.attached&&this.update()}get aspectRatio(){const{options:{aspectRatio:t,maintainAspectRatio:e},width:i,height:o,_aspectRatio:s}=this;return At(t)?e&&s?s:o?i/o:null:t}get data(){return this.config.data}set data(t){this.config.data=t}get options(){return this._options}set options(t){this.config.options=t}get registry(){return Me}_initialize(){return this.notifyPlugins("beforeInit"),this.options.responsive?this.resize():ds(this,this.options.devicePixelRatio),this.bindEvents(),this.notifyPlugins("afterInit"),this}clear(){return rs(this.canvas,this.ctx),this}stop(){return Oe.stop(this),this}resize(t,e){Oe.running(this)?this._resizeBeforeDraw={width:t,height:e}:this._resize(t,e)}_resize(t,e){const i=this.options,o=this.canvas,s=i.maintainAspectRatio&&this.aspectRatio,a=this.platform.getMaximumSize(o,t,e,s),r=i.devicePixelRatio||this.platform.getDevicePixelRatio(),l=this.width?"resize":"attach";this.width=a.width,this.height=a.height,this._aspectRatio=this.aspectRatio,ds(this,r,!0)&&(this.notifyPlugins("resize",{size:a}),jt(i.onResize,[this,a],this),this.attached&&this._doResize(l)&&this.render())}ensureScalesHaveIDs(){const e=this.options.scales||{};Ut(e,(i,o)=>{i.id=o})}buildOrUpdateScales(){const t=this.options,e=t.scales,i=this.scales,o=Object.keys(i).reduce((a,r)=>(a[r]=!1,a),{});let s=[];e&&(s=s.concat(Object.keys(e).map(a=>{const r=e[a],l=yo(a,r),c=l==="r",d=l==="x";return{options:r,dposition:c?"chartArea":d?"bottom":"left",dtype:c?"radialLinear":d?"category":"linear"}}))),Ut(s,a=>{const r=a.options,l=r.id,c=yo(l,r),d=Tt(r.type,a.dtype);(r.position===void 0||Rs(r.position,c)!==Rs(a.dposition))&&(r.position=a.dposition),o[l]=!0;let f=null;if(l in i&&i[l].type===d)f=i[l];else{const p=Me.getScale(d);f=new p({id:l,type:d,ctx:this.ctx,chart:this}),i[f.id]=f}f.init(r,t)}),Ut(o,(a,r)=>{a||delete i[r]}),Ut(i,a=>{le.configure(this,a,a.options),le.addBox(this,a)})}_updateMetasets(){const t=this._metasets,e=this.data.datasets.length,i=t.length;if(t.sort((o,s)=>o.index-s.index),i>e){for(let o=e;o<i;++o)this._destroyDatasetMeta(o);t.splice(e,i-e)}this._sortedMetasets=t.slice(0).sort(zs("order","index"))}_removeUnreferencedMetasets(){const{_metasets:t,data:{datasets:e}}=this;t.length>e.length&&delete this._stacks,t.forEach((i,o)=>{e.filter(s=>s===i._dataset).length===0&&this._destroyDatasetMeta(o)})}buildOrUpdateControllers(){const t=[],e=this.data.datasets;let i,o;for(this._removeUnreferencedMetasets(),i=0,o=e.length;i<o;i++){const s=e[i];let a=this.getDatasetMeta(i);const r=s.type||this.config.type;if(a.type&&a.type!==r&&(this._destroyDatasetMeta(i),a=this.getDatasetMeta(i)),a.type=r,a.indexAxis=s.indexAxis||bo(r,this.options),a.order=s.order||0,a.index=i,a.label=""+s.label,a.visible=this.isDatasetVisible(i),a.controller)a.controller.updateIndex(i),a.controller.linkScales();else{const l=Me.getController(r),{datasetElementType:c,dataElementType:d}=qt.datasets[r];Object.assign(l,{dataElementType:Me.getElement(d),datasetElementType:c&&Me.getElement(c)}),a.controller=new l(this,i),t.push(a.controller)}}return this._updateMetasets(),t}_resetElements(){Ut(this.data.datasets,(t,e)=>{this.getDatasetMeta(e).controller.reset()},this)}reset(){this._resetElements(),this.notifyPlugins("reset")}update(t){const e=this.config;e.update();const i=this._options=e.createResolver(e.chartOptionScopes(),this.getContext()),o=this._animationsDisabled=!i.animation;if(this._updateScales(),this._checkEventBindings(),this._updateHiddenIndices(),this._plugins.invalidate(),this.notifyPlugins("beforeUpdate",{mode:t,cancelable:!0})===!1)return;const s=this.buildOrUpdateControllers();this.notifyPlugins("beforeElementsUpdate");let a=0;for(let c=0,d=this.data.datasets.length;c<d;c++){const{controller:f}=this.getDatasetMeta(c),p=!o&&s.indexOf(f)===-1;f.buildOrUpdateElements(p),a=Math.max(+f.getMaxOverflow(),a)}a=this._minPadding=i.layout.autoPadding?a:0,this._updateLayout(a),o||Ut(s,c=>{c.reset()}),this._updateDatasets(t),this.notifyPlugins("afterUpdate",{mode:t}),this._layers.sort(zs("z","_idx"));const{_active:r,_lastEvent:l}=this;l?this._eventHandler(l,!0):r.length&&this._updateHoverStyles(r,r,!0),this.render()}_updateScales(){Ut(this.scales,t=>{le.removeBox(this,t)}),this.ensureScalesHaveIDs(),this.buildOrUpdateScales()}_checkEventBindings(){const t=this.options,e=new Set(Object.keys(this._listeners)),i=new Set(t.events);(!Zo(e,i)||!!this._responsiveListeners!==t.responsive)&&(this.unbindEvents(),this.bindEvents())}_updateHiddenIndices(){const{_hiddenIndices:t}=this,e=this._getUniformDataChanges()||[];for(const{method:i,start:o,count:s}of e){const a=i==="_removeElements"?-s:s;Kd(t,o,a)}}_getUniformDataChanges(){const t=this._dataChanges;if(!t||!t.length)return;this._dataChanges=[];const e=this.data.datasets.length,i=s=>new Set(t.filter(a=>a[0]===s).map((a,r)=>r+","+a.splice(1).join(","))),o=i(0);for(let s=1;s<e;s++)if(!Zo(o,i(s)))return;return Array.from(o).map(s=>s.split(",")).map(s=>({method:s[1],start:+s[2],count:+s[3]}))}_updateLayout(t){if(this.notifyPlugins("beforeLayout",{cancelable:!0})===!1)return;le.update(this,this.width,this.height,t);const e=this.chartArea,i=e.width<=0||e.height<=0;this._layers=[],Ut(this.boxes,o=>{i&&o.position==="chartArea"||(o.configure&&o.configure(),this._layers.push(...o._layers()))},this),this._layers.forEach((o,s)=>{o._idx=s}),this.notifyPlugins("afterLayout")}_updateDatasets(t){if(this.notifyPlugins("beforeDatasetsUpdate",{mode:t,cancelable:!0})!==!1){for(let e=0,i=this.data.datasets.length;e<i;++e)this.getDatasetMeta(e).controller.configure();for(let e=0,i=this.data.datasets.length;e<i;++e)this._updateDataset(e,Je(t)?t({datasetIndex:e}):t);this.notifyPlugins("afterDatasetsUpdate",{mode:t})}}_updateDataset(t,e){const i=this.getDatasetMeta(t),o={meta:i,index:t,mode:e,cancelable:!0};this.notifyPlugins("beforeDatasetUpdate",o)!==!1&&(i.controller._update(e),o.cancelable=!1,this.notifyPlugins("afterDatasetUpdate",o))}render(){this.notifyPlugins("beforeRender",{cancelable:!0})!==!1&&(Oe.has(this)?this.attached&&!Oe.running(this)&&Oe.start(this):(this.draw(),Vs({chart:this})))}draw(){let t;if(this._resizeBeforeDraw){const{width:i,height:o}=this._resizeBeforeDraw;this._resizeBeforeDraw=null,this._resize(i,o)}if(this.clear(),this.width<=0||this.height<=0||this.notifyPlugins("beforeDraw",{cancelable:!0})===!1)return;const e=this._layers;for(t=0;t<e.length&&e[t].z<=0;++t)e[t].draw(this.chartArea);for(this._drawDatasets();t<e.length;++t)e[t].draw(this.chartArea);this.notifyPlugins("afterDraw")}_getSortedDatasetMetas(t){const e=this._sortedMetasets,i=[];let o,s;for(o=0,s=e.length;o<s;++o){const a=e[o];(!t||a.visible)&&i.push(a)}return i}getSortedVisibleDatasetMetas(){return this._getSortedDatasetMetas(!0)}_drawDatasets(){if(this.notifyPlugins("beforeDatasetsDraw",{cancelable:!0})===!1)return;const t=this.getSortedVisibleDatasetMetas();for(let e=t.length-1;e>=0;--e)this._drawDataset(t[e]);this.notifyPlugins("afterDatasetsDraw")}_drawDataset(t){const e=this.ctx,i={meta:t,index:t.index,cancelable:!0},o=Ya(this,t);this.notifyPlugins("beforeDatasetDraw",i)!==!1&&(o&&zi(e,o),t.controller.draw(),o&&Vi(e),i.cancelable=!1,this.notifyPlugins("afterDatasetDraw",i))}isPointInArea(t){return Ue(t,this.chartArea,this._minPadding)}getElementsAtEventForMode(t,e,i,o){const s=Gc.modes[e];return typeof s=="function"?s(this,t,i,o):[]}getDatasetMeta(t){const e=this.data.datasets[t],i=this._metasets;let o=i.filter(s=>s&&s._dataset===e).pop();return o||(o={type:null,data:[],dataset:null,controller:null,hidden:null,xAxisID:null,yAxisID:null,order:e&&e.order||0,index:t,_dataset:e,_parsed:[],_sorted:!1},i.push(o)),o}getContext(){return this.$context||(this.$context=Ze(null,{chart:this,type:"chart"}))}getVisibleDatasetCount(){return this.getSortedVisibleDatasetMetas().length}isDatasetVisible(t){const e=this.data.datasets[t];if(!e)return!1;const i=this.getDatasetMeta(t);return typeof i.hidden=="boolean"?!i.hidden:!e.hidden}setDatasetVisibility(t,e){const i=this.getDatasetMeta(t);i.hidden=!e}toggleDataVisibility(t){this._hiddenIndices[t]=!this._hiddenIndices[t]}getDataVisibility(t){return!this._hiddenIndices[t]}_updateVisibility(t,e,i){const o=i?"show":"hide",s=this.getDatasetMeta(t),a=s.controller._resolveAnimations(void 0,o);Yn(e)?(s.data[e].hidden=!i,this.update()):(this.setDatasetVisibility(t,i),a.update(s,{visible:i}),this.update(r=>r.datasetIndex===t?o:void 0))}hide(t,e){this._updateVisibility(t,e,!1)}show(t,e){this._updateVisibility(t,e,!0)}_destroyDatasetMeta(t){const e=this._metasets[t];e&&e.controller&&e.controller._destroy(),delete this._metasets[t]}_stop(){let t,e;for(this.stop(),Oe.remove(this),t=0,e=this.data.datasets.length;t<e;++t)this._destroyDatasetMeta(t)}destroy(){this.notifyPlugins("beforeDestroy");const{canvas:t,ctx:e}=this;this._stop(),this.config.clearCache(),t&&(this.unbindEvents(),rs(t,e),this.platform.releaseContext(e),this.canvas=null,this.ctx=null),delete xi[this.id],this.notifyPlugins("afterDestroy")}toBase64Image(...t){return this.canvas.toDataURL(...t)}bindEvents(){this.bindUserEvents(),this.options.responsive?this.bindResponsiveEvents():this.attached=!0}bindUserEvents(){const t=this._listeners,e=this.platform,i=(s,a)=>{e.addEventListener(this,s,a),t[s]=a},o=(s,a,r)=>{s.offsetX=a,s.offsetY=r,this._eventHandler(s)};Ut(this.options.events,s=>i(s,o))}bindResponsiveEvents(){this._responsiveListeners||(this._responsiveListeners={});const t=this._responsiveListeners,e=this.platform,i=(l,c)=>{e.addEventListener(this,l,c),t[l]=c},o=(l,c)=>{t[l]&&(e.removeEventListener(this,l,c),delete t[l])},s=(l,c)=>{this.canvas&&this.resize(l,c)};let a;const r=()=>{o("attach",r),this.attached=!0,this.resize(),i("resize",s),i("detach",a)};a=()=>{this.attached=!1,o("resize",s),this._stop(),this._resize(0,0),i("attach",r)},e.isAttached(this.canvas)?r():a()}unbindEvents(){Ut(this._listeners,(t,e)=>{this.platform.removeEventListener(this,e,t)}),this._listeners={},Ut(this._responsiveListeners,(t,e)=>{this.platform.removeEventListener(this,e,t)}),this._responsiveListeners=void 0}updateHoverStyle(t,e,i){const o=i?"set":"remove";let s,a,r,l;for(e==="dataset"&&(s=this.getDatasetMeta(t[0].datasetIndex),s.controller["_"+o+"DatasetHoverStyle"]()),r=0,l=t.length;r<l;++r){a=t[r];const c=a&&this.getDatasetMeta(a.datasetIndex).controller;c&&c[o+"HoverStyle"](a.element,a.datasetIndex,a.index)}}getActiveElements(){return this._active||[]}setActiveElements(t){const e=this._active||[],i=t.map(({datasetIndex:s,index:a})=>{const r=this.getDatasetMeta(s);if(!r)throw new Error("No dataset found at index "+s);return{datasetIndex:s,element:r.data[a],index:a}});!Mi(i,e)&&(this._active=i,this._lastEvent=null,this._updateHoverStyles(i,e))}notifyPlugins(t,e,i){return this._plugins.notify(this,t,e,i)}isPluginEnabled(t){return this._plugins._cache.filter(e=>e.plugin.id===t).length===1}_updateHoverStyles(t,e,i){const o=this.options.hover,s=(l,c)=>l.filter(d=>!c.some(f=>d.datasetIndex===f.datasetIndex&&d.index===f.index)),a=s(e,t),r=i?t:s(t,e);a.length&&this.updateHoverStyle(a,o.mode,!1),r.length&&o.mode&&this.updateHoverStyle(r,o.mode,!0)}_eventHandler(t,e){const i={event:t,replay:e,cancelable:!0,inChartArea:this.isPointInArea(t)},o=a=>(a.options.events||this.options.events).includes(t.native.type);if(this.notifyPlugins("beforeEvent",i,o)===!1)return;const s=this._handleEvent(t,e,i.inChartArea);return i.cancelable=!1,this.notifyPlugins("afterEvent",i,o),(s||i.changed)&&this.render(),this}_handleEvent(t,e,i){const{_active:o=[],options:s}=this,a=e,r=this._getActiveElements(t,o,i,a),l=ol(t),c=Jd(t,this._lastEvent,i,l);i&&(this._lastEvent=null,jt(s.onHover,[t,r,this],this),l&&jt(s.onClick,[t,r,this],this));const d=!Mi(r,o);return(d||e)&&(this._active=r,this._updateHoverStyles(r,o,e)),this._lastEvent=c,d}_getActiveElements(t,e,i,o){if(t.type==="mouseout")return[];if(!i)return e;const s=this.options.hover;return this.getElementsAtEventForMode(t,s.mode,s,o)}},mt(je,"defaults",qt),mt(je,"instances",xi),mt(je,"overrides",un),mt(je,"registry",Me),mt(je,"version",qd),mt(je,"getChart",Us),je);function Hs(){return Ut(Re.instances,n=>n._plugins.invalidate())}function Zd(n,t,e){const{startAngle:i,x:o,y:s,outerRadius:a,innerRadius:r,options:l}=t,{borderWidth:c,borderJoinStyle:d}=l,f=Math.min(c/a,re(i-e));if(n.beginPath(),n.arc(o,s,a-c/2,i+f/2,e-f/2),r>0){const p=Math.min(c/r,re(i-e));n.arc(o,s,r+c/2,e-p/2,i+p/2,!0)}else{const p=Math.min(c/2,a*re(i-e));if(d==="round")n.arc(o,s,p,e-Nt/2,i+Nt/2,!0);else if(d==="bevel"){const m=2*p*p,_=-m*Math.cos(e+Nt/2)+o,S=-m*Math.sin(e+Nt/2)+s,k=m*Math.cos(i+Nt/2)+o,O=m*Math.sin(i+Nt/2)+s;n.lineTo(_,S),n.lineTo(k,O)}}n.closePath(),n.moveTo(0,0),n.rect(0,0,n.canvas.width,n.canvas.height),n.clip("evenodd")}function Qd(n,t,e){const{startAngle:i,pixelMargin:o,x:s,y:a,outerRadius:r,innerRadius:l}=t;let c=o/r;n.beginPath(),n.arc(s,a,r,i-c,e+c),l>o?(c=o/l,n.arc(s,a,l,e+c,i-c,!0)):n.arc(s,a,o,e+Jt,i-Jt),n.closePath(),n.clip()}function tu(n){return No(n,["outerStart","outerEnd","innerStart","innerEnd"])}function eu(n,t,e,i){const o=tu(n.options.borderRadius),s=(e-t)/2,a=Math.min(s,i*t/2),r=l=>{const c=(e-Math.min(s,l))*i/2;return ne(l,0,Math.min(s,c))};return{outerStart:r(o.outerStart),outerEnd:r(o.outerEnd),innerStart:ne(o.innerStart,0,a),innerEnd:ne(o.innerEnd,0,a)}}function gn(n,t,e,i){return{x:e+n*Math.cos(t),y:i+n*Math.sin(t)}}function Oi(n,t,e,i,o,s){const{x:a,y:r,startAngle:l,pixelMargin:c,innerRadius:d}=t,f=Math.max(t.outerRadius+i+e-c,0),p=d>0?d+i+e+c:0;let m=0;const _=o-l;if(i){const K=d>0?d-i:0,rt=f>0?f-i:0,Y=(K+rt)/2,Q=Y!==0?_*Y/(Y+i):_;m=(_-Q)/2}const S=Math.max(.001,_*f-e/Nt)/f,k=(_-S)/2,O=l+k+m,F=o-k-m,{outerStart:X,outerEnd:et,innerStart:T,innerEnd:D}=eu(t,p,f,F-O),E=f-X,P=f-et,R=O+X/E,N=F-et/P,$=p+T,H=p+D,nt=O+T/$,j=F-D/H;if(n.beginPath(),s){const K=(R+N)/2;if(n.arc(a,r,f,R,K),n.arc(a,r,f,K,N),et>0){const it=gn(P,N,a,r);n.arc(it.x,it.y,et,N,F+Jt)}const rt=gn(H,F,a,r);if(n.lineTo(rt.x,rt.y),D>0){const it=gn(H,j,a,r);n.arc(it.x,it.y,D,F+Jt,j+Math.PI)}const Y=(F-D/p+(O+T/p))/2;if(n.arc(a,r,p,F-D/p,Y,!0),n.arc(a,r,p,Y,O+T/p,!0),T>0){const it=gn($,nt,a,r);n.arc(it.x,it.y,T,nt+Math.PI,O-Jt)}const Q=gn(E,O,a,r);if(n.lineTo(Q.x,Q.y),X>0){const it=gn(E,R,a,r);n.arc(it.x,it.y,X,O-Jt,R)}}else{n.moveTo(a,r);const K=Math.cos(R)*f+a,rt=Math.sin(R)*f+r;n.lineTo(K,rt);const Y=Math.cos(N)*f+a,Q=Math.sin(N)*f+r;n.lineTo(Y,Q)}n.closePath()}function nu(n,t,e,i,o){const{fullCircles:s,startAngle:a,circumference:r}=t;let l=t.endAngle;if(s){Oi(n,t,e,i,l,o);for(let c=0;c<s;++c)n.fill();isNaN(r)||(l=a+(r%Yt||Yt))}return Oi(n,t,e,i,l,o),n.fill(),l}function iu(n,t,e,i,o){const{fullCircles:s,startAngle:a,circumference:r,options:l}=t,{borderWidth:c,borderJoinStyle:d,borderDash:f,borderDashOffset:p,borderRadius:m}=l,_=l.borderAlign==="inner";if(!c)return;n.setLineDash(f||[]),n.lineDashOffset=p,_?(n.lineWidth=c*2,n.lineJoin=d||"round"):(n.lineWidth=c,n.lineJoin=d||"bevel");let S=t.endAngle;if(s){Oi(n,t,e,i,S,o);for(let k=0;k<s;++k)n.stroke();isNaN(r)||(S=a+(r%Yt||Yt))}_&&Qd(n,t,S),l.selfJoin&&S-a>=Nt&&m===0&&d!=="miter"&&Zd(n,t,S),s||(Oi(n,t,e,i,S,o),n.stroke())}class An extends Ce{constructor(e){super();mt(this,"circumference");mt(this,"endAngle");mt(this,"fullCircles");mt(this,"innerRadius");mt(this,"outerRadius");mt(this,"pixelMargin");mt(this,"startAngle");this.options=void 0,this.circumference=void 0,this.startAngle=void 0,this.endAngle=void 0,this.innerRadius=void 0,this.outerRadius=void 0,this.pixelMargin=0,this.fullCircles=0,e&&Object.assign(this,e)}inRange(e,i,o){const s=this.getProps(["x","y"],o),{angle:a,distance:r}=Ca(s,{x:e,y:i}),{startAngle:l,endAngle:c,innerRadius:d,outerRadius:f,circumference:p}=this.getProps(["startAngle","endAngle","innerRadius","outerRadius","circumference"],o),m=(this.options.spacing+this.options.borderWidth)/2,_=Tt(p,c-l),S=$n(a,l,c)&&l!==c,k=_>=Yt||S,O=ze(r,d+m,f+m);return k&&O}getCenterPoint(e){const{x:i,y:o,startAngle:s,endAngle:a,innerRadius:r,outerRadius:l}=this.getProps(["x","y","startAngle","endAngle","innerRadius","outerRadius"],e),{offset:c,spacing:d}=this.options,f=(s+a)/2,p=(r+l+d+c)/2;return{x:i+Math.cos(f)*p,y:o+Math.sin(f)*p}}tooltipPosition(e){return this.getCenterPoint(e)}draw(e){const{options:i,circumference:o}=this,s=(i.offset||0)/4,a=(i.spacing||0)/2,r=i.circular;if(this.pixelMargin=i.borderAlign==="inner"?.33:0,this.fullCircles=o>Yt?Math.floor(o/Yt):0,o===0||this.innerRadius<0||this.outerRadius<0)return;e.save();const l=(this.startAngle+this.endAngle)/2;e.translate(Math.cos(l)*s,Math.sin(l)*s);const c=1-Math.sin(Math.min(Nt,o||0)),d=s*c;e.fillStyle=i.backgroundColor,e.strokeStyle=i.borderColor,nu(e,this,d,a,r),iu(e,this,d,a,r),e.restore()}}mt(An,"id","arc"),mt(An,"defaults",{borderAlign:"center",borderColor:"#fff",borderDash:[],borderDashOffset:0,borderJoinStyle:void 0,borderRadius:0,borderWidth:2,offset:0,spacing:0,angle:void 0,circular:!0,selfJoin:!1}),mt(An,"defaultRoutes",{backgroundColor:"backgroundColor"}),mt(An,"descriptors",{_scriptable:!0,_indexable:e=>e!=="borderDash"});function or(n,t,e=t){n.lineCap=Tt(e.borderCapStyle,t.borderCapStyle),n.setLineDash(Tt(e.borderDash,t.borderDash)),n.lineDashOffset=Tt(e.borderDashOffset,t.borderDashOffset),n.lineJoin=Tt(e.borderJoinStyle,t.borderJoinStyle),n.lineWidth=Tt(e.borderWidth,t.borderWidth),n.strokeStyle=Tt(e.borderColor,t.borderColor)}function ou(n,t,e){n.lineTo(e.x,e.y)}function su(n){return n.stepped?Tl:n.tension||n.cubicInterpolationMode==="monotone"?Il:ou}function sr(n,t,e={}){const i=n.length,{start:o=0,end:s=i-1}=e,{start:a,end:r}=t,l=Math.max(o,a),c=Math.min(s,r),d=o<a&&s<a||o>r&&s>r;return{count:i,start:l,loop:t.loop,ilen:c<l&&!d?i+c-l:c-l}}function au(n,t,e,i){const{points:o,options:s}=t,{count:a,start:r,loop:l,ilen:c}=sr(o,e,i),d=su(s);let{move:f=!0,reverse:p}=i||{},m,_,S;for(m=0;m<=c;++m)_=o[(r+(p?c-m:m))%a],!_.skip&&(f?(n.moveTo(_.x,_.y),f=!1):d(n,S,_,p,s.stepped),S=_);return l&&(_=o[(r+(p?c:0))%a],d(n,S,_,p,s.stepped)),!!l}function ru(n,t,e,i){const o=t.points,{count:s,start:a,ilen:r}=sr(o,e,i),{move:l=!0,reverse:c}=i||{};let d=0,f=0,p,m,_,S,k,O;const F=et=>(a+(c?r-et:et))%s,X=()=>{S!==k&&(n.lineTo(d,k),n.lineTo(d,S),n.lineTo(d,O))};for(l&&(m=o[F(0)],n.moveTo(m.x,m.y)),p=0;p<=r;++p){if(m=o[F(p)],m.skip)continue;const et=m.x,T=m.y,D=et|0;D===_?(T<S?S=T:T>k&&(k=T),d=(f*d+et)/++f):(X(),n.lineTo(et,T),_=D,f=0,S=k=T),O=T}X()}function wo(n){const t=n.options,e=t.borderDash&&t.borderDash.length;return!n._decimated&&!n._loop&&!t.tension&&t.cubicInterpolationMode!=="monotone"&&!t.stepped&&!e?ru:au}function lu(n){return n.stepped?ac:n.tension||n.cubicInterpolationMode==="monotone"?rc:rn}function cu(n,t,e,i){let o=t._path;o||(o=t._path=new Path2D,t.path(o,e,i)&&o.closePath()),or(n,t.options),n.stroke(o)}function du(n,t,e,i){const{segments:o,options:s}=t,a=wo(t);for(const r of o)or(n,s,r.style),n.beginPath(),a(n,t,r,{start:e,end:e+i-1})&&n.closePath(),n.stroke()}const uu=typeof Path2D=="function";function fu(n,t,e,i){uu&&!t.options.segment?cu(n,t,e,i):du(n,t,e,i)}class qe extends Ce{constructor(t){super(),this.animated=!0,this.options=void 0,this._chart=void 0,this._loop=void 0,this._fullLoop=void 0,this._path=void 0,this._points=void 0,this._segments=void 0,this._decimated=!1,this._pointsUpdated=!1,this._datasetIndex=void 0,t&&Object.assign(this,t)}updateControlPoints(t,e){const i=this.options;if((i.tension||i.cubicInterpolationMode==="monotone")&&!i.stepped&&!this._pointsUpdated){const o=i.spanGaps?this._loop:this._fullLoop;Zl(this._points,i,t,o,e),this._pointsUpdated=!0}}set points(t){this._points=t,delete this._segments,delete this._path,this._pointsUpdated=!1}get points(){return this._points}get segments(){return this._segments||(this._segments=hc(this,this.options.segment))}first(){const t=this.segments,e=this.points;return t.length&&e[t[0].start]}last(){const t=this.segments,e=this.points,i=t.length;return i&&e[t[i-1].end]}interpolate(t,e){const i=this.options,o=t[e],s=this.points,a=Wa(this,{property:e,start:o,end:o});if(!a.length)return;const r=[],l=lu(i);let c,d;for(c=0,d=a.length;c<d;++c){const{start:f,end:p}=a[c],m=s[f],_=s[p];if(m===_){r.push(m);continue}const S=Math.abs((o-m[e])/(_[e]-m[e])),k=l(m,_,S,i.stepped);k[e]=t[e],r.push(k)}return r.length===1?r[0]:r}pathSegment(t,e,i){return wo(this)(t,this,e,i)}path(t,e,i){const o=this.segments,s=wo(this);let a=this._loop;e=e||0,i=i||this.points.length-e;for(const r of o)a&=s(t,this,r,{start:e,end:e+i-1});return!!a}draw(t,e,i,o){const s=this.options||{};(this.points||[]).length&&s.borderWidth&&(t.save(),fu(t,this,i,o),t.restore()),this.animated&&(this._pointsUpdated=!1,this._path=void 0)}}mt(qe,"id","line"),mt(qe,"defaults",{borderCapStyle:"butt",borderDash:[],borderDashOffset:0,borderJoinStyle:"miter",borderWidth:3,capBezierPoints:!0,cubicInterpolationMode:"default",fill:!1,spanGaps:!1,stepped:!1,tension:0}),mt(qe,"defaultRoutes",{backgroundColor:"backgroundColor",borderColor:"borderColor"}),mt(qe,"descriptors",{_scriptable:!0,_indexable:t=>t!=="borderDash"&&t!=="fill"});function js(n,t,e,i){const o=n.options,{[e]:s}=n.getProps([e],i);return Math.abs(t-s)<o.radius+o.hitRadius}class Si extends Ce{constructor(e){super();mt(this,"parsed");mt(this,"skip");mt(this,"stop");this.options=void 0,this.parsed=void 0,this.skip=void 0,this.stop=void 0,e&&Object.assign(this,e)}inRange(e,i,o){const s=this.options,{x:a,y:r}=this.getProps(["x","y"],o);return Math.pow(e-a,2)+Math.pow(i-r,2)<Math.pow(s.hitRadius+s.radius,2)}inXRange(e,i){return js(this,e,"x",i)}inYRange(e,i){return js(this,e,"y",i)}getCenterPoint(e){const{x:i,y:o}=this.getProps(["x","y"],e);return{x:i,y:o}}size(e){e=e||this.options||{};let i=e.radius||0;i=Math.max(i,i&&e.hoverRadius||0);const o=i&&e.borderWidth||0;return(i+o)*2}draw(e,i){const o=this.options;this.skip||o.radius<.1||!Ue(this,i,this.size(o)/2)||(e.strokeStyle=o.borderColor,e.lineWidth=o.borderWidth,e.fillStyle=o.backgroundColor,go(e,o,this.x,this.y))}getRange(){const e=this.options||{};return e.radius+e.hitRadius}}mt(Si,"id","point"),mt(Si,"defaults",{borderWidth:1,hitRadius:1,hoverBorderWidth:1,hoverRadius:4,pointStyle:"circle",radius:3,rotation:0}),mt(Si,"defaultRoutes",{backgroundColor:"backgroundColor",borderColor:"borderColor"});function ar(n,t){const{x:e,y:i,base:o,width:s,height:a}=n.getProps(["x","y","base","width","height"],t);let r,l,c,d,f;return n.horizontal?(f=a/2,r=Math.min(e,o),l=Math.max(e,o),c=i-f,d=i+f):(f=s/2,r=e-f,l=e+f,c=Math.min(i,o),d=Math.max(i,o)),{left:r,top:c,right:l,bottom:d}}function Ge(n,t,e,i){return n?0:ne(t,e,i)}function hu(n,t,e){const i=n.options.borderWidth,o=n.borderSkipped,s=Ba(i);return{t:Ge(o.top,s.top,0,e),r:Ge(o.right,s.right,0,t),b:Ge(o.bottom,s.bottom,0,e),l:Ge(o.left,s.left,0,t)}}function pu(n,t,e){const{enableBorderRadius:i}=n.getProps(["enableBorderRadius"]),o=n.options.borderRadius,s=cn(o),a=Math.min(t,e),r=n.borderSkipped,l=i||Bt(o);return{topLeft:Ge(!l||r.top||r.left,s.topLeft,0,a),topRight:Ge(!l||r.top||r.right,s.topRight,0,a),bottomLeft:Ge(!l||r.bottom||r.left,s.bottomLeft,0,a),bottomRight:Ge(!l||r.bottom||r.right,s.bottomRight,0,a)}}function mu(n){const t=ar(n),e=t.right-t.left,i=t.bottom-t.top,o=hu(n,e/2,i/2),s=pu(n,e/2,i/2);return{outer:{x:t.left,y:t.top,w:e,h:i,radius:s},inner:{x:t.left+o.l,y:t.top+o.t,w:e-o.l-o.r,h:i-o.t-o.b,radius:{topLeft:Math.max(0,s.topLeft-Math.max(o.t,o.l)),topRight:Math.max(0,s.topRight-Math.max(o.t,o.r)),bottomLeft:Math.max(0,s.bottomLeft-Math.max(o.b,o.l)),bottomRight:Math.max(0,s.bottomRight-Math.max(o.b,o.r))}}}}function oo(n,t,e,i){const o=t===null,s=e===null,r=n&&!(o&&s)&&ar(n,i);return r&&(o||ze(t,r.left,r.right))&&(s||ze(e,r.top,r.bottom))}function gu(n){return n.topLeft||n.topRight||n.bottomLeft||n.bottomRight}function vu(n,t){n.rect(t.x,t.y,t.w,t.h)}function so(n,t,e={}){const i=n.x!==e.x?-t:0,o=n.y!==e.y?-t:0,s=(n.x+n.w!==e.x+e.w?t:0)-i,a=(n.y+n.h!==e.y+e.h?t:0)-o;return{x:n.x+i,y:n.y+o,w:n.w+s,h:n.h+a,radius:n.radius}}class Ci extends Ce{constructor(t){super(),this.options=void 0,this.horizontal=void 0,this.base=void 0,this.width=void 0,this.height=void 0,this.inflateAmount=void 0,t&&Object.assign(this,t)}draw(t){const{inflateAmount:e,options:{borderColor:i,backgroundColor:o}}=this,{inner:s,outer:a}=mu(this),r=gu(a.radius)?qn:vu;t.save(),(a.w!==s.w||a.h!==s.h)&&(t.beginPath(),r(t,so(a,e,s)),t.clip(),r(t,so(s,-e,a)),t.fillStyle=i,t.fill("evenodd")),t.beginPath(),r(t,so(s,e)),t.fillStyle=o,t.fill(),t.restore()}inRange(t,e,i){return oo(this,t,e,i)}inXRange(t,e){return oo(this,t,null,e)}inYRange(t,e){return oo(this,null,t,e)}getCenterPoint(t){const{x:e,y:i,base:o,horizontal:s}=this.getProps(["x","y","base","horizontal"],t);return{x:s?(e+o)/2:e,y:s?i:(i+o)/2}}getRange(t){return t==="x"?this.width/2:this.height/2}}mt(Ci,"id","bar"),mt(Ci,"defaults",{borderSkipped:"start",borderWidth:0,borderRadius:0,inflateAmount:"auto",pointStyle:void 0}),mt(Ci,"defaultRoutes",{backgroundColor:"backgroundColor",borderColor:"borderColor"});var bu=Object.freeze({__proto__:null,ArcElement:An,BarElement:Ci,LineElement:qe,PointElement:Si});const _o=["rgb(54, 162, 235)","rgb(255, 99, 132)","rgb(255, 159, 64)","rgb(255, 205, 86)","rgb(75, 192, 192)","rgb(153, 102, 255)","rgb(201, 203, 207)"],Ws=_o.map(n=>n.replace("rgb(","rgba(").replace(")",", 0.5)"));function rr(n){return _o[n%_o.length]}function lr(n){return Ws[n%Ws.length]}function yu(n,t){return n.borderColor=rr(t),n.backgroundColor=lr(t),++t}function wu(n,t){return n.backgroundColor=n.data.map(()=>rr(t++)),t}function _u(n,t){return n.backgroundColor=n.data.map(()=>lr(t++)),t}function xu(n){let t=0;return(e,i)=>{const o=n.getDatasetMeta(i).controller;o instanceof ln?t=wu(e,t):o instanceof zn?t=_u(e,t):o&&(t=yu(e,t))}}function Ys(n){let t;for(t in n)if(n[t].borderColor||n[t].backgroundColor)return!0;return!1}function Su(n){return n&&(n.borderColor||n.backgroundColor)}function Cu(){return qt.borderColor!=="rgba(0,0,0,0.1)"||qt.backgroundColor!=="rgba(0,0,0,0.1)"}var Du={id:"colors",defaults:{enabled:!0,forceOverride:!1},beforeLayout(n,t,e){if(!e.enabled)return;const{data:{datasets:i},options:o}=n.config,{elements:s}=o,a=Ys(i)||Su(o)||s&&Ys(s)||Cu();if(!e.forceOverride&&a)return;const r=xu(n);i.forEach(r)}};function ku(n,t,e,i,o){const s=o.samples||i;if(s>=e)return n.slice(t,t+e);const a=[],r=(e-2)/(s-2);let l=0;const c=t+e-1;let d=t,f,p,m,_,S;for(a[l++]=n[d],f=0;f<s-2;f++){let k=0,O=0,F;const X=Math.floor((f+1)*r)+1+t,et=Math.min(Math.floor((f+2)*r)+1,e)+t,T=et-X;for(F=X;F<et;F++)k+=n[F].x,O+=n[F].y;k/=T,O/=T;const D=Math.floor(f*r)+1+t,E=Math.min(Math.floor((f+1)*r)+1,e)+t,{x:P,y:R}=n[d];for(m=_=-1,F=D;F<E;F++)_=.5*Math.abs((P-k)*(n[F].y-R)-(P-n[F].x)*(O-R)),_>m&&(m=_,p=n[F],S=F);a[l++]=p,d=S}return a[l++]=n[c],a}function Tu(n,t,e,i){let o=0,s=0,a,r,l,c,d,f,p,m,_,S;const k=[],O=t+e-1,F=n[t].x,et=n[O].x-F;for(a=t;a<t+e;++a){r=n[a],l=(r.x-F)/et*i,c=r.y;const T=l|0;if(T===d)c<_?(_=c,f=a):c>S&&(S=c,p=a),o=(s*o+r.x)/++s;else{const D=a-1;if(!At(f)&&!At(p)){const E=Math.min(f,p),P=Math.max(f,p);E!==m&&E!==D&&k.push({...n[E],x:o}),P!==m&&P!==D&&k.push({...n[P],x:o})}a>0&&D!==m&&k.push(n[D]),k.push(r),d=T,s=0,_=S=c,f=p=m=a}}return k}function cr(n){if(n._decimated){const t=n._data;delete n._decimated,delete n._data,Object.defineProperty(n,"data",{configurable:!0,enumerable:!0,writable:!0,value:t})}}function $s(n){n.data.datasets.forEach(t=>{cr(t)})}function Iu(n,t){const e=t.length;let i=0,o;const{iScale:s}=n,{min:a,max:r,minDefined:l,maxDefined:c}=s.getUserBounds();return l&&(i=ne(Ve(t,s.axis,a).lo,0,e-1)),c?o=ne(Ve(t,s.axis,r).hi+1,i,e)-i:o=e-i,{start:i,count:o}}var Mu={id:"decimation",defaults:{algorithm:"min-max",enabled:!1},beforeElementsUpdate:(n,t,e)=>{if(!e.enabled){$s(n);return}const i=n.width;n.data.datasets.forEach((o,s)=>{const{_data:a,indexAxis:r}=o,l=n.getDatasetMeta(s),c=a||o.data;if(En([r,n.options.indexAxis])==="y"||!l.controller.supportsDecimation)return;const d=n.scales[l.xAxisID];if(d.type!=="linear"&&d.type!=="time"||n.options.parsing)return;let{start:f,count:p}=Iu(l,c);const m=e.threshold||4*i;if(p<=m){cr(o);return}At(a)&&(o._data=c,delete o.data,Object.defineProperty(o,"data",{configurable:!0,enumerable:!0,get:function(){return this._decimated},set:function(S){this._data=S}}));let _;switch(e.algorithm){case"lttb":_=ku(c,f,p,i,e);break;case"min-max":_=Tu(c,f,p,i);break;default:throw new Error("Unsupported decimation algorithm '".concat(e.algorithm,"'"))}o._decimated=_})},destroy(n){$s(n)}};function Eu(n,t,e){const i=n.segments,o=n.points,s=t.points,a=[];for(const r of i){let{start:l,end:c}=r;c=ji(l,c,o);const d=xo(e,o[l],o[c],r.loop);if(!t.segments){a.push({source:r,target:d,start:o[l],end:o[c]});continue}const f=Wa(t,d);for(const p of f){const m=xo(e,s[p.start],s[p.end],p.loop),_=ja(r,o,m);for(const S of _)a.push({source:S,target:p,start:{[e]:qs(d,m,"start",Math.max)},end:{[e]:qs(d,m,"end",Math.min)}})}}return a}function xo(n,t,e,i){if(i)return;let o=t[n],s=e[n];return n==="angle"&&(o=re(o),s=re(s)),{property:n,start:o,end:s}}function Pu(n,t){const{x:e=null,y:i=null}=n||{},o=t.points,s=[];return t.segments.forEach(({start:a,end:r})=>{r=ji(a,r,o);const l=o[a],c=o[r];i!==null?(s.push({x:l.x,y:i}),s.push({x:c.x,y:i})):e!==null&&(s.push({x:e,y:l.y}),s.push({x:e,y:c.y}))}),s}function ji(n,t,e){for(;t>n;t--){const i=e[t];if(!isNaN(i.x)&&!isNaN(i.y))break}return t}function qs(n,t,e,i){return n&&t?i(n[e],t[e]):n?n[e]:t?t[e]:0}function dr(n,t){let e=[],i=!1;return $t(n)?(i=!0,e=n):e=Pu(n,t),e.length?new qe({points:e,options:{tension:0},_loop:i,_fullLoop:i}):null}function Gs(n){return n&&n.fill!==!1}function Au(n,t,e){let o=n[t].fill;const s=[t];let a;if(!e)return o;for(;o!==!1&&s.indexOf(o)===-1;){if(!Xt(o))return o;if(a=n[o],!a)return!1;if(a.visible)return o;s.push(o),o=a.fill}return!1}function Bu(n,t,e){const i=Nu(n);if(Bt(i))return isNaN(i.value)?!1:i;let o=parseFloat(i);return Xt(o)&&Math.floor(o)===o?Lu(i[0],t,o,e):["origin","start","end","stack","shape"].indexOf(i)>=0&&i}function Lu(n,t,e,i){return(n==="-"||n==="+")&&(e=t+e),e===t||e<0||e>=i?!1:e}function Ou(n,t){let e=null;return n==="start"?e=t.bottom:n==="end"?e=t.top:Bt(n)?e=t.getPixelForValue(n.value):t.getBasePixel&&(e=t.getBasePixel()),e}function Fu(n,t,e){let i;return n==="start"?i=e:n==="end"?i=t.options.reverse?t.min:t.max:Bt(n)?i=n.value:i=t.getBaseValue(),i}function Nu(n){const t=n.options,e=t.fill;let i=Tt(e&&e.target,e);return i===void 0&&(i=!!t.backgroundColor),i===!1||i===null?!1:i===!0?"origin":i}function Ru(n){const{scale:t,index:e,line:i}=n,o=[],s=i.segments,a=i.points,r=zu(t,e);r.push(dr({x:null,y:t.bottom},i));for(let l=0;l<s.length;l++){const c=s[l];for(let d=c.start;d<=c.end;d++)Vu(o,a[d],r)}return new qe({points:o,options:{}})}function zu(n,t){const e=[],i=n.getMatchingVisibleMetas("line");for(let o=0;o<i.length;o++){const s=i[o];if(s.index===t)break;s.hidden||e.unshift(s.dataset)}return e}function Vu(n,t,e){const i=[];for(let o=0;o<e.length;o++){const s=e[o],{first:a,last:r,point:l}=Uu(s,t,"x");if(!(!l||a&&r)){if(a)i.unshift(l);else if(n.push(l),!r)break}}n.push(...i)}function Uu(n,t,e){const i=n.interpolate(t,e);if(!i)return{};const o=i[e],s=n.segments,a=n.points;let r=!1,l=!1;for(let c=0;c<s.length;c++){const d=s[c],f=a[d.start][e],p=a[d.end][e];if(ze(o,f,p)){r=o===f,l=o===p;break}}return{first:r,last:l,point:i}}class ur{constructor(t){this.x=t.x,this.y=t.y,this.radius=t.radius}pathSegment(t,e,i){const{x:o,y:s,radius:a}=this;return e=e||{start:0,end:Yt},t.arc(o,s,a,e.end,e.start,!0),!i.bounds}interpolate(t){const{x:e,y:i,radius:o}=this,s=t.angle;return{x:e+Math.cos(s)*o,y:i+Math.sin(s)*o,angle:s}}}function Hu(n){const{chart:t,fill:e,line:i}=n;if(Xt(e))return ju(t,e);if(e==="stack")return Ru(n);if(e==="shape")return!0;const o=Wu(n);return o instanceof ur?o:dr(o,i)}function ju(n,t){const e=n.getDatasetMeta(t);return e&&n.isDatasetVisible(t)?e.dataset:null}function Wu(n){return(n.scale||{}).getPointPositionForValue?$u(n):Yu(n)}function Yu(n){const{scale:t={},fill:e}=n,i=Ou(e,t);if(Xt(i)){const o=t.isHorizontal();return{x:o?i:null,y:o?null:i}}return null}function $u(n){const{scale:t,fill:e}=n,i=t.options,o=t.getLabels().length,s=i.reverse?t.max:t.min,a=Fu(e,t,s),r=[];if(i.grid.circular){const l=t.getPointPositionForValue(0,s);return new ur({x:l.x,y:l.y,radius:t.getDistanceFromCenterForValue(a)})}for(let l=0;l<o;++l)r.push(t.getPointPositionForValue(l,a));return r}function ao(n,t,e){const i=Hu(t),{chart:o,index:s,line:a,scale:r,axis:l}=t,c=a.options,d=c.fill,f=c.backgroundColor,{above:p=f,below:m=f}=d||{},_=o.getDatasetMeta(s),S=Ya(o,_);i&&a.points.length&&(zi(n,e),qu(n,{line:a,target:i,above:p,below:m,area:e,scale:r,axis:l,clip:S}),Vi(n))}function qu(n,t){const{line:e,target:i,above:o,below:s,area:a,scale:r,clip:l}=t,c=e._loop?"angle":t.axis;n.save();let d=s;s!==o&&(c==="x"?(Xs(n,i,a.top),ro(n,{line:e,target:i,color:o,scale:r,property:c,clip:l}),n.restore(),n.save(),Xs(n,i,a.bottom)):c==="y"&&(Ks(n,i,a.left),ro(n,{line:e,target:i,color:s,scale:r,property:c,clip:l}),n.restore(),n.save(),Ks(n,i,a.right),d=o)),ro(n,{line:e,target:i,color:d,scale:r,property:c,clip:l}),n.restore()}function Xs(n,t,e){const{segments:i,points:o}=t;let s=!0,a=!1;n.beginPath();for(const r of i){const{start:l,end:c}=r,d=o[l],f=o[ji(l,c,o)];s?(n.moveTo(d.x,d.y),s=!1):(n.lineTo(d.x,e),n.lineTo(d.x,d.y)),a=!!t.pathSegment(n,r,{move:a}),a?n.closePath():n.lineTo(f.x,e)}n.lineTo(t.first().x,e),n.closePath(),n.clip()}function Ks(n,t,e){const{segments:i,points:o}=t;let s=!0,a=!1;n.beginPath();for(const r of i){const{start:l,end:c}=r,d=o[l],f=o[ji(l,c,o)];s?(n.moveTo(d.x,d.y),s=!1):(n.lineTo(e,d.y),n.lineTo(d.x,d.y)),a=!!t.pathSegment(n,r,{move:a}),a?n.closePath():n.lineTo(e,f.y)}n.lineTo(e,t.first().y),n.closePath(),n.clip()}function ro(n,t){const{line:e,target:i,property:o,color:s,scale:a,clip:r}=t,l=Eu(e,i,o);for(const{source:c,target:d,start:f,end:p}of l){const{style:{backgroundColor:m=s}={}}=c,_=i!==!0;n.save(),n.fillStyle=m,Gu(n,a,r,_&&xo(o,f,p)),n.beginPath();const S=!!e.pathSegment(n,c);let k;if(_){S?n.closePath():Js(n,i,p,o);const O=!!i.pathSegment(n,d,{move:S,reverse:!0});k=S&&O,k||Js(n,i,f,o)}n.closePath(),n.fill(k?"evenodd":"nonzero"),n.restore()}}function Gu(n,t,e,i){const o=t.chart.chartArea,{property:s,start:a,end:r}=i||{};if(s==="x"||s==="y"){let l,c,d,f;s==="x"?(l=a,c=o.top,d=r,f=o.bottom):(l=o.left,c=a,d=o.right,f=r),n.beginPath(),e&&(l=Math.max(l,e.left),d=Math.min(d,e.right),c=Math.max(c,e.top),f=Math.min(f,e.bottom)),n.rect(l,c,d-l,f-c),n.clip()}}function Js(n,t,e,i){const o=t.interpolate(e,i);o&&n.lineTo(o.x,o.y)}var Xu={id:"filler",afterDatasetsUpdate(n,t,e){const i=(n.data.datasets||[]).length,o=[];let s,a,r,l;for(a=0;a<i;++a)s=n.getDatasetMeta(a),r=s.dataset,l=null,r&&r.options&&r instanceof qe&&(l={visible:n.isDatasetVisible(a),index:a,fill:Bu(r,a,i),chart:n,axis:s.controller.options.indexAxis,scale:s.vScale,line:r}),s.$filler=l,o.push(l);for(a=0;a<i;++a)l=o[a],!(!l||l.fill===!1)&&(l.fill=Au(o,a,e.propagate))},beforeDraw(n,t,e){const i=e.drawTime==="beforeDraw",o=n.getSortedVisibleDatasetMetas(),s=n.chartArea;for(let a=o.length-1;a>=0;--a){const r=o[a].$filler;r&&(r.line.updateControlPoints(s,r.axis),i&&r.fill&&ao(n.ctx,r,s))}},beforeDatasetsDraw(n,t,e){if(e.drawTime!=="beforeDatasetsDraw")return;const i=n.getSortedVisibleDatasetMetas();for(let o=i.length-1;o>=0;--o){const s=i[o].$filler;Gs(s)&&ao(n.ctx,s,n.chartArea)}},beforeDatasetDraw(n,t,e){const i=t.meta.$filler;!Gs(i)||e.drawTime!=="beforeDatasetDraw"||ao(n.ctx,i,n.chartArea)},defaults:{propagate:!0,drawTime:"beforeDatasetDraw"}};const Zs=(n,t)=>{let{boxHeight:e=t,boxWidth:i=t}=n;return n.usePointStyle&&(e=Math.min(e,t),i=n.pointStyleWidth||Math.min(i,t)),{boxWidth:i,boxHeight:e,itemHeight:Math.max(t,e)}},Ku=(n,t)=>n!==null&&t!==null&&n.datasetIndex===t.datasetIndex&&n.index===t.index;class Qs extends Ce{constructor(t){super(),this._added=!1,this.legendHitBoxes=[],this._hoveredItem=null,this.doughnutMode=!1,this.chart=t.chart,this.options=t.options,this.ctx=t.ctx,this.legendItems=void 0,this.columnSizes=void 0,this.lineWidths=void 0,this.maxHeight=void 0,this.maxWidth=void 0,this.top=void 0,this.bottom=void 0,this.left=void 0,this.right=void 0,this.height=void 0,this.width=void 0,this._margins=void 0,this.position=void 0,this.weight=void 0,this.fullSize=void 0}update(t,e,i){this.maxWidth=t,this.maxHeight=e,this._margins=i,this.setDimensions(),this.buildLabels(),this.fit()}setDimensions(){this.isHorizontal()?(this.width=this.maxWidth,this.left=this._margins.left,this.right=this.width):(this.height=this.maxHeight,this.top=this._margins.top,this.bottom=this.height)}buildLabels(){const t=this.options.labels||{};let e=jt(t.generateLabels,[this.chart],this)||[];t.filter&&(e=e.filter(i=>t.filter(i,this.chart.data))),t.sort&&(e=e.sort((i,o)=>t.sort(i,o,this.chart.data))),this.options.reverse&&e.reverse(),this.legendItems=e}fit(){const{options:t,ctx:e}=this;if(!t.display){this.width=this.height=0;return}const i=t.labels,o=te(i.font),s=o.size,a=this._computeTitleHeight(),{boxWidth:r,itemHeight:l}=Zs(i,s);let c,d;e.font=o.string,this.isHorizontal()?(c=this.maxWidth,d=this._fitRows(a,s,r,l)+10):(d=this.maxHeight,c=this._fitCols(a,o,r,l)+10),this.width=Math.min(c,t.maxWidth||this.maxWidth),this.height=Math.min(d,t.maxHeight||this.maxHeight)}_fitRows(t,e,i,o){const{ctx:s,maxWidth:a,options:{labels:{padding:r}}}=this,l=this.legendHitBoxes=[],c=this.lineWidths=[0],d=o+r;let f=t;s.textAlign="left",s.textBaseline="middle";let p=-1,m=-d;return this.legendItems.forEach((_,S)=>{const k=i+e/2+s.measureText(_.text).width;(S===0||c[c.length-1]+k+2*r>a)&&(f+=d,c[c.length-(S>0?0:1)]=0,m+=d,p++),l[S]={left:0,top:m,row:p,width:k,height:o},c[c.length-1]+=k+r}),f}_fitCols(t,e,i,o){const{ctx:s,maxHeight:a,options:{labels:{padding:r}}}=this,l=this.legendHitBoxes=[],c=this.columnSizes=[],d=a-t;let f=r,p=0,m=0,_=0,S=0;return this.legendItems.forEach((k,O)=>{const{itemWidth:F,itemHeight:X}=Ju(i,e,s,k,o);O>0&&m+X+2*r>d&&(f+=p+r,c.push({width:p,height:m}),_+=p+r,S++,p=m=0),l[O]={left:_,top:m,col:S,width:F,height:X},p=Math.max(p,F),m+=X+r}),f+=p,c.push({width:p,height:m}),f}adjustHitBoxes(){if(!this.options.display)return;const t=this._computeTitleHeight(),{legendHitBoxes:e,options:{align:i,labels:{padding:o},rtl:s}}=this,a=vn(s,this.left,this.width);if(this.isHorizontal()){let r=0,l=ae(i,this.left+o,this.right-this.lineWidths[r]);for(const c of e)r!==c.row&&(r=c.row,l=ae(i,this.left+o,this.right-this.lineWidths[r])),c.top+=this.top+t+o,c.left=a.leftForLtr(a.x(l),c.width),l+=c.width+o}else{let r=0,l=ae(i,this.top+t+o,this.bottom-this.columnSizes[r].height);for(const c of e)c.col!==r&&(r=c.col,l=ae(i,this.top+t+o,this.bottom-this.columnSizes[r].height)),c.top=l,c.left+=this.left+o,c.left=a.leftForLtr(a.x(c.left),c.width),l+=c.height+o}}isHorizontal(){return this.options.position==="top"||this.options.position==="bottom"}draw(){if(this.options.display){const t=this.ctx;zi(t,this),this._draw(),Vi(t)}}_draw(){const{options:t,columnSizes:e,lineWidths:i,ctx:o}=this,{align:s,labels:a}=t,r=qt.color,l=vn(t.rtl,this.left,this.width),c=te(a.font),{padding:d}=a,f=c.size,p=f/2;let m;this.drawTitle(),o.textAlign=l.textAlign("left"),o.textBaseline="middle",o.lineWidth=.5,o.font=c.string;const{boxWidth:_,boxHeight:S,itemHeight:k}=Zs(a,f),O=function(D,E,P){if(isNaN(_)||_<=0||isNaN(S)||S<0)return;o.save();const R=Tt(P.lineWidth,1);if(o.fillStyle=Tt(P.fillStyle,r),o.lineCap=Tt(P.lineCap,"butt"),o.lineDashOffset=Tt(P.lineDashOffset,0),o.lineJoin=Tt(P.lineJoin,"miter"),o.lineWidth=R,o.strokeStyle=Tt(P.strokeStyle,r),o.setLineDash(Tt(P.lineDash,[])),a.usePointStyle){const N={radius:S*Math.SQRT2/2,pointStyle:P.pointStyle,rotation:P.rotation,borderWidth:R},$=l.xPlus(D,_/2),H=E+p;Aa(o,N,$,H,a.pointStyleWidth&&_)}else{const N=E+Math.max((f-S)/2,0),$=l.leftForLtr(D,_),H=cn(P.borderRadius);o.beginPath(),Object.values(H).some(nt=>nt!==0)?qn(o,{x:$,y:N,w:_,h:S,radius:H}):o.rect($,N,_,S),o.fill(),R!==0&&o.stroke()}o.restore()},F=function(D,E,P){fn(o,P.text,D,E+k/2,c,{strikethrough:P.hidden,textAlign:l.textAlign(P.textAlign)})},X=this.isHorizontal(),et=this._computeTitleHeight();X?m={x:ae(s,this.left+d,this.right-i[0]),y:this.top+d+et,line:0}:m={x:this.left+d,y:ae(s,this.top+et+d,this.bottom-e[0].height),line:0},Va(this.ctx,t.textDirection);const T=k+d;this.legendItems.forEach((D,E)=>{o.strokeStyle=D.fontColor,o.fillStyle=D.fontColor;const P=o.measureText(D.text).width,R=l.textAlign(D.textAlign||(D.textAlign=a.textAlign)),N=_+p+P;let $=m.x,H=m.y;l.setWidth(this.width),X?E>0&&$+N+d>this.right&&(H=m.y+=T,m.line++,$=m.x=ae(s,this.left+d,this.right-i[m.line])):E>0&&H+T>this.bottom&&($=m.x=$+e[m.line].width+d,m.line++,H=m.y=ae(s,this.top+et+d,this.bottom-e[m.line].height));const nt=l.x($);if(O(nt,H,D),$=gl(R,$+_+p,X?$+N:this.right,t.rtl),F(l.x($),H,D),X)m.x+=N+d;else if(typeof D.text!="string"){const j=c.lineHeight;m.y+=fr(D,j)+d}else m.y+=T}),Ua(this.ctx,t.textDirection)}drawTitle(){const t=this.options,e=t.title,i=te(e.font),o=ce(e.padding);if(!e.display)return;const s=vn(t.rtl,this.left,this.width),a=this.ctx,r=e.position,l=i.size/2,c=o.top+l;let d,f=this.left,p=this.width;if(this.isHorizontal())p=Math.max(...this.lineWidths),d=this.top+c,f=ae(t.align,f,this.right-p);else{const _=this.columnSizes.reduce((S,k)=>Math.max(S,k.height),0);d=c+ae(t.align,this.top,this.bottom-_-t.labels.padding-this._computeTitleHeight())}const m=ae(r,f,f+p);a.textAlign=s.textAlign(Oo(r)),a.textBaseline="middle",a.strokeStyle=e.color,a.fillStyle=e.color,a.font=i.string,fn(a,e.text,m,d,i)}_computeTitleHeight(){const t=this.options.title,e=te(t.font),i=ce(t.padding);return t.display?e.lineHeight+i.height:0}_getLegendItemAt(t,e){let i,o,s;if(ze(t,this.left,this.right)&&ze(e,this.top,this.bottom)){for(s=this.legendHitBoxes,i=0;i<s.length;++i)if(o=s[i],ze(t,o.left,o.left+o.width)&&ze(e,o.top,o.top+o.height))return this.legendItems[i]}return null}handleEvent(t){const e=this.options;if(!tf(t.type,e))return;const i=this._getLegendItemAt(t.x,t.y);if(t.type==="mousemove"||t.type==="mouseout"){const o=this._hoveredItem,s=Ku(o,i);o&&!s&&jt(e.onLeave,[t,o,this],this),this._hoveredItem=i,i&&!s&&jt(e.onHover,[t,i,this],this)}else i&&jt(e.onClick,[t,i,this],this)}}function Ju(n,t,e,i,o){const s=Zu(i,n,t,e),a=Qu(o,i,t.lineHeight);return{itemWidth:s,itemHeight:a}}function Zu(n,t,e,i){let o=n.text;return o&&typeof o!="string"&&(o=o.reduce((s,a)=>s.length>a.length?s:a)),t+e.size/2+i.measureText(o).width}function Qu(n,t,e){let i=n;return typeof t.text!="string"&&(i=fr(t,e)),i}function fr(n,t){const e=n.text?n.text.length:0;return t*e}function tf(n,t){return!!((n==="mousemove"||n==="mouseout")&&(t.onHover||t.onLeave)||t.onClick&&(n==="click"||n==="mouseup"))}var ef={id:"legend",_element:Qs,start(n,t,e){const i=n.legend=new Qs({ctx:n.ctx,options:e,chart:n});le.configure(n,i,e),le.addBox(n,i)},stop(n){le.removeBox(n,n.legend),delete n.legend},beforeUpdate(n,t,e){const i=n.legend;le.configure(n,i,e),i.options=e},afterUpdate(n){const t=n.legend;t.buildLabels(),t.adjustHitBoxes()},afterEvent(n,t){t.replay||n.legend.handleEvent(t.event)},defaults:{display:!0,position:"top",align:"center",fullSize:!0,reverse:!1,weight:1e3,onClick(n,t,e){const i=t.datasetIndex,o=e.chart;o.isDatasetVisible(i)?(o.hide(i),t.hidden=!0):(o.show(i),t.hidden=!1)},onHover:null,onLeave:null,labels:{color:n=>n.chart.options.color,boxWidth:40,padding:10,generateLabels(n){const t=n.data.datasets,{labels:{usePointStyle:e,pointStyle:i,textAlign:o,color:s,useBorderRadius:a,borderRadius:r}}=n.legend.options;return n._getSortedDatasetMetas().map(l=>{const c=l.controller.getStyle(e?0:void 0),d=ce(c.borderWidth);return{text:t[l.index].label,fillStyle:c.backgroundColor,fontColor:s,hidden:!l.visible,lineCap:c.borderCapStyle,lineDash:c.borderDash,lineDashOffset:c.borderDashOffset,lineJoin:c.borderJoinStyle,lineWidth:(d.width+d.height)/4,strokeStyle:c.borderColor,pointStyle:i||c.pointStyle,rotation:c.rotation,textAlign:o||c.textAlign,borderRadius:a&&(r||c.borderRadius),datasetIndex:l.index}},this)}},title:{color:n=>n.chart.options.color,display:!1,position:"center",text:""}},descriptors:{_scriptable:n=>!n.startsWith("on"),labels:{_scriptable:n=>!["generateLabels","filter","sort"].includes(n)}}};class Wo extends Ce{constructor(t){super(),this.chart=t.chart,this.options=t.options,this.ctx=t.ctx,this._padding=void 0,this.top=void 0,this.bottom=void 0,this.left=void 0,this.right=void 0,this.width=void 0,this.height=void 0,this.position=void 0,this.weight=void 0,this.fullSize=void 0}update(t,e){const i=this.options;if(this.left=0,this.top=0,!i.display){this.width=this.height=this.right=this.bottom=0;return}this.width=this.right=t,this.height=this.bottom=e;const o=$t(i.text)?i.text.length:1;this._padding=ce(i.padding);const s=o*te(i.font).lineHeight+this._padding.height;this.isHorizontal()?this.height=s:this.width=s}isHorizontal(){const t=this.options.position;return t==="top"||t==="bottom"}_drawArgs(t){const{top:e,left:i,bottom:o,right:s,options:a}=this,r=a.align;let l=0,c,d,f;return this.isHorizontal()?(d=ae(r,i,s),f=e+t,c=s-i):(a.position==="left"?(d=i+t,f=ae(r,o,e),l=Nt*-.5):(d=s-t,f=ae(r,e,o),l=Nt*.5),c=o-e),{titleX:d,titleY:f,maxWidth:c,rotation:l}}draw(){const t=this.ctx,e=this.options;if(!e.display)return;const i=te(e.font),s=i.lineHeight/2+this._padding.top,{titleX:a,titleY:r,maxWidth:l,rotation:c}=this._drawArgs(s);fn(t,e.text,0,0,i,{color:e.color,maxWidth:l,rotation:c,textAlign:Oo(e.align),textBaseline:"middle",translation:[a,r]})}}function nf(n,t){const e=new Wo({ctx:n.ctx,options:t,chart:n});le.configure(n,e,t),le.addBox(n,e),n.titleBlock=e}var of={id:"title",_element:Wo,start(n,t,e){nf(n,e)},stop(n){const t=n.titleBlock;le.removeBox(n,t),delete n.titleBlock},beforeUpdate(n,t,e){const i=n.titleBlock;le.configure(n,i,e),i.options=e},defaults:{align:"center",display:!1,font:{weight:"bold"},fullSize:!0,padding:10,position:"top",text:"",weight:2e3},defaultRoutes:{color:"color"},descriptors:{_scriptable:!0,_indexable:!1}};const di=new WeakMap;var sf={id:"subtitle",start(n,t,e){const i=new Wo({ctx:n.ctx,options:e,chart:n});le.configure(n,i,e),le.addBox(n,i),di.set(n,i)},stop(n){le.removeBox(n,di.get(n)),di.delete(n)},beforeUpdate(n,t,e){const i=di.get(n);le.configure(n,i,e),i.options=e},defaults:{align:"center",display:!1,font:{weight:"normal"},fullSize:!0,padding:0,position:"top",text:"",weight:1500},defaultRoutes:{color:"color"},descriptors:{_scriptable:!0,_indexable:!1}};const Bn={average(n){if(!n.length)return!1;let t,e,i=new Set,o=0,s=0;for(t=0,e=n.length;t<e;++t){const r=n[t].element;if(r&&r.hasValue()){const l=r.tooltipPosition();i.add(l.x),o+=l.y,++s}}return s===0||i.size===0?!1:{x:[...i].reduce((r,l)=>r+l)/i.size,y:o/s}},nearest(n,t){if(!n.length)return!1;let e=t.x,i=t.y,o=Number.POSITIVE_INFINITY,s,a,r;for(s=0,a=n.length;s<a;++s){const l=n[s].element;if(l&&l.hasValue()){const c=l.getCenterPoint(),d=po(t,c);d<o&&(o=d,r=l)}}if(r){const l=r.tooltipPosition();e=l.x,i=l.y}return{x:e,y:i}}};function ke(n,t){return t&&($t(t)?Array.prototype.push.apply(n,t):n.push(t)),n}function Fe(n){return(typeof n=="string"||n instanceof String)&&n.indexOf("\n")>-1?n.split("\n"):n}function af(n,t){const{element:e,datasetIndex:i,index:o}=t,s=n.getDatasetMeta(i).controller,{label:a,value:r}=s.getLabelAndValue(o);return{chart:n,label:a,parsed:s.getParsed(o),raw:n.data.datasets[i].data[o],formattedValue:r,dataset:s.getDataset(),dataIndex:o,datasetIndex:i,element:e}}function ta(n,t){const e=n.chart.ctx,{body:i,footer:o,title:s}=n,{boxWidth:a,boxHeight:r}=t,l=te(t.bodyFont),c=te(t.titleFont),d=te(t.footerFont),f=s.length,p=o.length,m=i.length,_=ce(t.padding);let S=_.height,k=0,O=i.reduce((et,T)=>et+T.before.length+T.lines.length+T.after.length,0);if(O+=n.beforeBody.length+n.afterBody.length,f&&(S+=f*c.lineHeight+(f-1)*t.titleSpacing+t.titleMarginBottom),O){const et=t.displayColors?Math.max(r,l.lineHeight):l.lineHeight;S+=m*et+(O-m)*l.lineHeight+(O-1)*t.bodySpacing}p&&(S+=t.footerMarginTop+p*d.lineHeight+(p-1)*t.footerSpacing);let F=0;const X=function(et){k=Math.max(k,e.measureText(et).width+F)};return e.save(),e.font=c.string,Ut(n.title,X),e.font=l.string,Ut(n.beforeBody.concat(n.afterBody),X),F=t.displayColors?a+2+t.boxPadding:0,Ut(i,et=>{Ut(et.before,X),Ut(et.lines,X),Ut(et.after,X)}),F=0,e.font=d.string,Ut(n.footer,X),e.restore(),k+=_.width,{width:k,height:S}}function rf(n,t){const{y:e,height:i}=t;return e<i/2?"top":e>n.height-i/2?"bottom":"center"}function lf(n,t,e,i){const{x:o,width:s}=i,a=e.caretSize+e.caretPadding;if(n==="left"&&o+s+a>t.width||n==="right"&&o-s-a<0)return!0}function cf(n,t,e,i){const{x:o,width:s}=e,{width:a,chartArea:{left:r,right:l}}=n;let c="center";return i==="center"?c=o<=(r+l)/2?"left":"right":o<=s/2?c="left":o>=a-s/2&&(c="right"),lf(c,n,t,e)&&(c="center"),c}function ea(n,t,e){const i=e.yAlign||t.yAlign||rf(n,e);return{xAlign:e.xAlign||t.xAlign||cf(n,t,e,i),yAlign:i}}function df(n,t){let{x:e,width:i}=n;return t==="right"?e-=i:t==="center"&&(e-=i/2),e}function uf(n,t,e){let{y:i,height:o}=n;return t==="top"?i+=e:t==="bottom"?i-=o+e:i-=o/2,i}function na(n,t,e,i){const{caretSize:o,caretPadding:s,cornerRadius:a}=n,{xAlign:r,yAlign:l}=e,c=o+s,{topLeft:d,topRight:f,bottomLeft:p,bottomRight:m}=cn(a);let _=df(t,r);const S=uf(t,l,c);return l==="center"?r==="left"?_+=c:r==="right"&&(_-=c):r==="left"?_-=Math.max(d,p)+o:r==="right"&&(_+=Math.max(f,m)+o),{x:ne(_,0,i.width-t.width),y:ne(S,0,i.height-t.height)}}function ui(n,t,e){const i=ce(e.padding);return t==="center"?n.x+n.width/2:t==="right"?n.x+n.width-i.right:n.x+i.left}function ia(n){return ke([],Fe(n))}function ff(n,t,e){return Ze(n,{tooltip:t,tooltipItems:e,type:"tooltip"})}function oa(n,t){const e=t&&t.dataset&&t.dataset.tooltip&&t.dataset.tooltip.callbacks;return e?n.override(e):n}const hr={beforeTitle:Ae,title(n){if(n.length>0){const t=n[0],e=t.chart.data.labels,i=e?e.length:0;if(this&&this.options&&this.options.mode==="dataset")return t.dataset.label||"";if(t.label)return t.label;if(i>0&&t.dataIndex<i)return e[t.dataIndex]}return""},afterTitle:Ae,beforeBody:Ae,beforeLabel:Ae,label(n){if(this&&this.options&&this.options.mode==="dataset")return n.label+": "+n.formattedValue||n.formattedValue;let t=n.dataset.label||"";t&&(t+=": ");const e=n.formattedValue;return At(e)||(t+=e),t},labelColor(n){const e=n.chart.getDatasetMeta(n.datasetIndex).controller.getStyle(n.dataIndex);return{borderColor:e.borderColor,backgroundColor:e.backgroundColor,borderWidth:e.borderWidth,borderDash:e.borderDash,borderDashOffset:e.borderDashOffset,borderRadius:0}},labelTextColor(){return this.options.bodyColor},labelPointStyle(n){const e=n.chart.getDatasetMeta(n.datasetIndex).controller.getStyle(n.dataIndex);return{pointStyle:e.pointStyle,rotation:e.rotation}},afterLabel:Ae,afterBody:Ae,beforeFooter:Ae,footer:Ae,afterFooter:Ae};function pe(n,t,e,i){const o=n[t].call(e,i);return typeof o>"u"?hr[t].call(e,i):o}class So extends Ce{constructor(t){super(),this.opacity=0,this._active=[],this._eventPosition=void 0,this._size=void 0,this._cachedAnimations=void 0,this._tooltipItems=[],this.$animations=void 0,this.$context=void 0,this.chart=t.chart,this.options=t.options,this.dataPoints=void 0,this.title=void 0,this.beforeBody=void 0,this.body=void 0,this.afterBody=void 0,this.footer=void 0,this.xAlign=void 0,this.yAlign=void 0,this.x=void 0,this.y=void 0,this.height=void 0,this.width=void 0,this.caretX=void 0,this.caretY=void 0,this.labelColors=void 0,this.labelPointStyles=void 0,this.labelTextColors=void 0}initialize(t){this.options=t,this._cachedAnimations=void 0,this.$context=void 0}_resolveAnimations(){const t=this._cachedAnimations;if(t)return t;const e=this.chart,i=this.options.setContext(this.getContext()),o=i.enabled&&e.options.animation&&i.animations,s=new $a(this.chart,o);return o._cacheable&&(this._cachedAnimations=Object.freeze(s)),s}getContext(){return this.$context||(this.$context=ff(this.chart.getContext(),this,this._tooltipItems))}getTitle(t,e){const{callbacks:i}=e,o=pe(i,"beforeTitle",this,t),s=pe(i,"title",this,t),a=pe(i,"afterTitle",this,t);let r=[];return r=ke(r,Fe(o)),r=ke(r,Fe(s)),r=ke(r,Fe(a)),r}getBeforeBody(t,e){return ia(pe(e.callbacks,"beforeBody",this,t))}getBody(t,e){const{callbacks:i}=e,o=[];return Ut(t,s=>{const a={before:[],lines:[],after:[]},r=oa(i,s);ke(a.before,Fe(pe(r,"beforeLabel",this,s))),ke(a.lines,pe(r,"label",this,s)),ke(a.after,Fe(pe(r,"afterLabel",this,s))),o.push(a)}),o}getAfterBody(t,e){return ia(pe(e.callbacks,"afterBody",this,t))}getFooter(t,e){const{callbacks:i}=e,o=pe(i,"beforeFooter",this,t),s=pe(i,"footer",this,t),a=pe(i,"afterFooter",this,t);let r=[];return r=ke(r,Fe(o)),r=ke(r,Fe(s)),r=ke(r,Fe(a)),r}_createItems(t){const e=this._active,i=this.chart.data,o=[],s=[],a=[];let r=[],l,c;for(l=0,c=e.length;l<c;++l)r.push(af(this.chart,e[l]));return t.filter&&(r=r.filter((d,f,p)=>t.filter(d,f,p,i))),t.itemSort&&(r=r.sort((d,f)=>t.itemSort(d,f,i))),Ut(r,d=>{const f=oa(t.callbacks,d);o.push(pe(f,"labelColor",this,d)),s.push(pe(f,"labelPointStyle",this,d)),a.push(pe(f,"labelTextColor",this,d))}),this.labelColors=o,this.labelPointStyles=s,this.labelTextColors=a,this.dataPoints=r,r}update(t,e){const i=this.options.setContext(this.getContext()),o=this._active;let s,a=[];if(!o.length)this.opacity!==0&&(s={opacity:0});else{const r=Bn[i.position].call(this,o,this._eventPosition);a=this._createItems(i),this.title=this.getTitle(a,i),this.beforeBody=this.getBeforeBody(a,i),this.body=this.getBody(a,i),this.afterBody=this.getAfterBody(a,i),this.footer=this.getFooter(a,i);const l=this._size=ta(this,i),c=Object.assign({},r,l),d=ea(this.chart,i,c),f=na(i,c,d,this.chart);this.xAlign=d.xAlign,this.yAlign=d.yAlign,s={opacity:1,x:f.x,y:f.y,width:l.width,height:l.height,caretX:r.x,caretY:r.y}}this._tooltipItems=a,this.$context=void 0,s&&this._resolveAnimations().update(this,s),t&&i.external&&i.external.call(this,{chart:this.chart,tooltip:this,replay:e})}drawCaret(t,e,i,o){const s=this.getCaretPosition(t,i,o);e.lineTo(s.x1,s.y1),e.lineTo(s.x2,s.y2),e.lineTo(s.x3,s.y3)}getCaretPosition(t,e,i){const{xAlign:o,yAlign:s}=this,{caretSize:a,cornerRadius:r}=i,{topLeft:l,topRight:c,bottomLeft:d,bottomRight:f}=cn(r),{x:p,y:m}=t,{width:_,height:S}=e;let k,O,F,X,et,T;return s==="center"?(et=m+S/2,o==="left"?(k=p,O=k-a,X=et+a,T=et-a):(k=p+_,O=k+a,X=et-a,T=et+a),F=k):(o==="left"?O=p+Math.max(l,d)+a:o==="right"?O=p+_-Math.max(c,f)-a:O=this.caretX,s==="top"?(X=m,et=X-a,k=O-a,F=O+a):(X=m+S,et=X+a,k=O+a,F=O-a),T=X),{x1:k,x2:O,x3:F,y1:X,y2:et,y3:T}}drawTitle(t,e,i){const o=this.title,s=o.length;let a,r,l;if(s){const c=vn(i.rtl,this.x,this.width);for(t.x=ui(this,i.titleAlign,i),e.textAlign=c.textAlign(i.titleAlign),e.textBaseline="middle",a=te(i.titleFont),r=i.titleSpacing,e.fillStyle=i.titleColor,e.font=a.string,l=0;l<s;++l)e.fillText(o[l],c.x(t.x),t.y+a.lineHeight/2),t.y+=a.lineHeight+r,l+1===s&&(t.y+=i.titleMarginBottom-r)}}_drawColorBox(t,e,i,o,s){const a=this.labelColors[i],r=this.labelPointStyles[i],{boxHeight:l,boxWidth:c}=s,d=te(s.bodyFont),f=ui(this,"left",s),p=o.x(f),m=l<d.lineHeight?(d.lineHeight-l)/2:0,_=e.y+m;if(s.usePointStyle){const S={radius:Math.min(c,l)/2,pointStyle:r.pointStyle,rotation:r.rotation,borderWidth:1},k=o.leftForLtr(p,c)+c/2,O=_+l/2;t.strokeStyle=s.multiKeyBackground,t.fillStyle=s.multiKeyBackground,go(t,S,k,O),t.strokeStyle=a.borderColor,t.fillStyle=a.backgroundColor,go(t,S,k,O)}else{t.lineWidth=Bt(a.borderWidth)?Math.max(...Object.values(a.borderWidth)):a.borderWidth||1,t.strokeStyle=a.borderColor,t.setLineDash(a.borderDash||[]),t.lineDashOffset=a.borderDashOffset||0;const S=o.leftForLtr(p,c),k=o.leftForLtr(o.xPlus(p,1),c-2),O=cn(a.borderRadius);Object.values(O).some(F=>F!==0)?(t.beginPath(),t.fillStyle=s.multiKeyBackground,qn(t,{x:S,y:_,w:c,h:l,radius:O}),t.fill(),t.stroke(),t.fillStyle=a.backgroundColor,t.beginPath(),qn(t,{x:k,y:_+1,w:c-2,h:l-2,radius:O}),t.fill()):(t.fillStyle=s.multiKeyBackground,t.fillRect(S,_,c,l),t.strokeRect(S,_,c,l),t.fillStyle=a.backgroundColor,t.fillRect(k,_+1,c-2,l-2))}t.fillStyle=this.labelTextColors[i]}drawBody(t,e,i){const{body:o}=this,{bodySpacing:s,bodyAlign:a,displayColors:r,boxHeight:l,boxWidth:c,boxPadding:d}=i,f=te(i.bodyFont);let p=f.lineHeight,m=0;const _=vn(i.rtl,this.x,this.width),S=function(P){e.fillText(P,_.x(t.x+m),t.y+p/2),t.y+=p+s},k=_.textAlign(a);let O,F,X,et,T,D,E;for(e.textAlign=a,e.textBaseline="middle",e.font=f.string,t.x=ui(this,k,i),e.fillStyle=i.bodyColor,Ut(this.beforeBody,S),m=r&&k!=="right"?a==="center"?c/2+d:c+2+d:0,et=0,D=o.length;et<D;++et){for(O=o[et],F=this.labelTextColors[et],e.fillStyle=F,Ut(O.before,S),X=O.lines,r&&X.length&&(this._drawColorBox(e,t,et,_,i),p=Math.max(f.lineHeight,l)),T=0,E=X.length;T<E;++T)S(X[T]),p=f.lineHeight;Ut(O.after,S)}m=0,p=f.lineHeight,Ut(this.afterBody,S),t.y-=s}drawFooter(t,e,i){const o=this.footer,s=o.length;let a,r;if(s){const l=vn(i.rtl,this.x,this.width);for(t.x=ui(this,i.footerAlign,i),t.y+=i.footerMarginTop,e.textAlign=l.textAlign(i.footerAlign),e.textBaseline="middle",a=te(i.footerFont),e.fillStyle=i.footerColor,e.font=a.string,r=0;r<s;++r)e.fillText(o[r],l.x(t.x),t.y+a.lineHeight/2),t.y+=a.lineHeight+i.footerSpacing}}drawBackground(t,e,i,o){const{xAlign:s,yAlign:a}=this,{x:r,y:l}=t,{width:c,height:d}=i,{topLeft:f,topRight:p,bottomLeft:m,bottomRight:_}=cn(o.cornerRadius);e.fillStyle=o.backgroundColor,e.strokeStyle=o.borderColor,e.lineWidth=o.borderWidth,e.beginPath(),e.moveTo(r+f,l),a==="top"&&this.drawCaret(t,e,i,o),e.lineTo(r+c-p,l),e.quadraticCurveTo(r+c,l,r+c,l+p),a==="center"&&s==="right"&&this.drawCaret(t,e,i,o),e.lineTo(r+c,l+d-_),e.quadraticCurveTo(r+c,l+d,r+c-_,l+d),a==="bottom"&&this.drawCaret(t,e,i,o),e.lineTo(r+m,l+d),e.quadraticCurveTo(r,l+d,r,l+d-m),a==="center"&&s==="left"&&this.drawCaret(t,e,i,o),e.lineTo(r,l+f),e.quadraticCurveTo(r,l,r+f,l),e.closePath(),e.fill(),o.borderWidth>0&&e.stroke()}_updateAnimationTarget(t){const e=this.chart,i=this.$animations,o=i&&i.x,s=i&&i.y;if(o||s){const a=Bn[t.position].call(this,this._active,this._eventPosition);if(!a)return;const r=this._size=ta(this,t),l=Object.assign({},a,this._size),c=ea(e,t,l),d=na(t,l,c,e);(o._to!==d.x||s._to!==d.y)&&(this.xAlign=c.xAlign,this.yAlign=c.yAlign,this.width=r.width,this.height=r.height,this.caretX=a.x,this.caretY=a.y,this._resolveAnimations().update(this,d))}}_willRender(){return!!this.opacity}draw(t){const e=this.options.setContext(this.getContext());let i=this.opacity;if(!i)return;this._updateAnimationTarget(e);const o={width:this.width,height:this.height},s={x:this.x,y:this.y};i=Math.abs(i)<.001?0:i;const a=ce(e.padding),r=this.title.length||this.beforeBody.length||this.body.length||this.afterBody.length||this.footer.length;e.enabled&&r&&(t.save(),t.globalAlpha=i,this.drawBackground(s,t,o,e),Va(t,e.textDirection),s.y+=a.top,this.drawTitle(s,t,e),this.drawBody(s,t,e),this.drawFooter(s,t,e),Ua(t,e.textDirection),t.restore())}getActiveElements(){return this._active||[]}setActiveElements(t,e){const i=this._active,o=t.map(({datasetIndex:r,index:l})=>{const c=this.chart.getDatasetMeta(r);if(!c)throw new Error("Cannot find a dataset at index "+r);return{datasetIndex:r,element:c.data[l],index:l}}),s=!Mi(i,o),a=this._positionChanged(o,e);(s||a)&&(this._active=o,this._eventPosition=e,this._ignoreReplayEvents=!0,this.update(!0))}handleEvent(t,e,i=!0){if(e&&this._ignoreReplayEvents)return!1;this._ignoreReplayEvents=!1;const o=this.options,s=this._active||[],a=this._getActiveElements(t,s,e,i),r=this._positionChanged(a,t),l=e||!Mi(a,s)||r;return l&&(this._active=a,(o.enabled||o.external)&&(this._eventPosition={x:t.x,y:t.y},this.update(!0,e))),l}_getActiveElements(t,e,i,o){const s=this.options;if(t.type==="mouseout")return[];if(!o)return e.filter(r=>this.chart.data.datasets[r.datasetIndex]&&this.chart.getDatasetMeta(r.datasetIndex).controller.getParsed(r.index)!==void 0);const a=this.chart.getElementsAtEventForMode(t,s.mode,s,i);return s.reverse&&a.reverse(),a}_positionChanged(t,e){const{caretX:i,caretY:o,options:s}=this,a=Bn[s.position].call(this,t,e);return a!==!1&&(i!==a.x||o!==a.y)}}mt(So,"positioners",Bn);var hf={id:"tooltip",_element:So,positioners:Bn,afterInit(n,t,e){e&&(n.tooltip=new So({chart:n,options:e}))},beforeUpdate(n,t,e){n.tooltip&&n.tooltip.initialize(e)},reset(n,t,e){n.tooltip&&n.tooltip.initialize(e)},afterDraw(n){const t=n.tooltip;if(t&&t._willRender()){const e={tooltip:t};if(n.notifyPlugins("beforeTooltipDraw",{...e,cancelable:!0})===!1)return;t.draw(n.ctx),n.notifyPlugins("afterTooltipDraw",e)}},afterEvent(n,t){if(n.tooltip){const e=t.replay;n.tooltip.handleEvent(t.event,e,t.inChartArea)&&(t.changed=!0)}},defaults:{enabled:!0,external:null,position:"average",backgroundColor:"rgba(0,0,0,0.8)",titleColor:"#fff",titleFont:{weight:"bold"},titleSpacing:2,titleMarginBottom:6,titleAlign:"left",bodyColor:"#fff",bodySpacing:2,bodyFont:{},bodyAlign:"left",footerColor:"#fff",footerSpacing:2,footerMarginTop:6,footerFont:{weight:"bold"},footerAlign:"left",padding:6,caretPadding:2,caretSize:5,cornerRadius:6,boxHeight:(n,t)=>t.bodyFont.size,boxWidth:(n,t)=>t.bodyFont.size,multiKeyBackground:"#fff",displayColors:!0,boxPadding:0,borderColor:"rgba(0,0,0,0)",borderWidth:0,animation:{duration:400,easing:"easeOutQuart"},animations:{numbers:{type:"number",properties:["x","y","width","height","caretX","caretY"]},opacity:{easing:"linear",duration:200}},callbacks:hr},defaultRoutes:{bodyFont:"font",footerFont:"font",titleFont:"font"},descriptors:{_scriptable:n=>n!=="filter"&&n!=="itemSort"&&n!=="external",_indexable:!1,callbacks:{_scriptable:!1,_indexable:!1},animation:{_fallback:!1},animations:{_fallback:"animation"}},additionalOptionScopes:["interaction"]},pf=Object.freeze({__proto__:null,Colors:Du,Decimation:Mu,Filler:Xu,Legend:ef,SubTitle:sf,Title:of,Tooltip:hf});const mf=(n,t,e,i)=>(typeof t=="string"?(e=n.push(t)-1,i.unshift({index:e,label:t})):isNaN(t)&&(e=null),e);function gf(n,t,e,i){const o=n.indexOf(t);if(o===-1)return mf(n,t,e,i);const s=n.lastIndexOf(t);return o!==s?e:o}const vf=(n,t)=>n===null?null:ne(Math.round(n),0,t);function sa(n){const t=this.getLabels();return n>=0&&n<t.length?t[n]:n}class Co extends hn{constructor(t){super(t),this._startValue=void 0,this._valueRange=0,this._addedLabels=[]}init(t){const e=this._addedLabels;if(e.length){const i=this.getLabels();for(const{index:o,label:s}of e)i[o]===s&&i.splice(o,1);this._addedLabels=[]}super.init(t)}parse(t,e){if(At(t))return null;const i=this.getLabels();return e=isFinite(e)&&i[e]===t?e:gf(i,t,Tt(e,t),this._addedLabels),vf(e,i.length-1)}determineDataLimits(){const{minDefined:t,maxDefined:e}=this.getUserBounds();let{min:i,max:o}=this.getMinMax(!0);this.options.bounds==="ticks"&&(t||(i=0),e||(o=this.getLabels().length-1)),this.min=i,this.max=o}buildTicks(){const t=this.min,e=this.max,i=this.options.offset,o=[];let s=this.getLabels();s=t===0&&e===s.length-1?s:s.slice(t,e+1),this._valueRange=Math.max(s.length-(i?0:1),1),this._startValue=this.min-(i?.5:0);for(let a=t;a<=e;a++)o.push({value:a});return o}getLabelForValue(t){return sa.call(this,t)}configure(){super.configure(),this.isHorizontal()||(this._reversePixels=!this._reversePixels)}getPixelForValue(t){return typeof t!="number"&&(t=this.parse(t)),t===null?NaN:this.getPixelForDecimal((t-this._startValue)/this._valueRange)}getPixelForTick(t){const e=this.ticks;return t<0||t>e.length-1?null:this.getPixelForValue(e[t].value)}getValueForPixel(t){return Math.round(this._startValue+this.getDecimalForPixel(t)*this._valueRange)}getBasePixel(){return this.bottom}}mt(Co,"id","category"),mt(Co,"defaults",{ticks:{callback:sa}});function bf(n,t){const e=[],{bounds:o,step:s,min:a,max:r,precision:l,count:c,maxTicks:d,maxDigits:f,includeBounds:p}=n,m=s||1,_=d-1,{min:S,max:k}=t,O=!At(a),F=!At(r),X=!At(c),et=(k-S)/(f+1);let T=ts((k-S)/_/m)*m,D,E,P,R;if(T<1e-14&&!O&&!F)return[{value:S},{value:k}];R=Math.ceil(k/T)-Math.floor(S/T),R>_&&(T=ts(R*T/_/m)*m),At(l)||(D=Math.pow(10,l),T=Math.ceil(T*D)/D),o==="ticks"?(E=Math.floor(S/T)*T,P=Math.ceil(k/T)*T):(E=S,P=k),O&&F&&s&&cl((r-a)/s,T/1e3)?(R=Math.round(Math.min((r-a)/T,d)),T=(r-a)/R,E=a,P=r):X?(E=O?a:E,P=F?r:P,R=c-1,T=(P-E)/R):(R=(P-E)/T,Fn(R,Math.round(R),T/1e3)?R=Math.round(R):R=Math.ceil(R));const N=Math.max(es(T),es(E));D=Math.pow(10,At(l)?N:l),E=Math.round(E*D)/D,P=Math.round(P*D)/D;let $=0;for(O&&(p&&E!==a?(e.push({value:a}),E<a&&$++,Fn(Math.round((E+$*T)*D)/D,a,aa(a,et,n))&&$++):E<a&&$++);$<R;++$){const H=Math.round((E+$*T)*D)/D;if(F&&H>r)break;e.push({value:H})}return F&&p&&P!==r?e.length&&Fn(e[e.length-1].value,r,aa(r,et,n))?e[e.length-1].value=r:e.push({value:r}):(!F||P===r)&&e.push({value:P}),e}function aa(n,t,{horizontal:e,minRotation:i}){const o=xe(i),s=(e?Math.sin(o):Math.cos(o))||.001,a=.75*t*(""+n).length;return Math.min(t/s,a)}class Fi extends hn{constructor(t){super(t),this.start=void 0,this.end=void 0,this._startValue=void 0,this._endValue=void 0,this._valueRange=0}parse(t,e){return At(t)||(typeof t=="number"||t instanceof Number)&&!isFinite(+t)?null:+t}handleTickRangeOptions(){const{beginAtZero:t}=this.options,{minDefined:e,maxDefined:i}=this.getUserBounds();let{min:o,max:s}=this;const a=l=>o=e?o:l,r=l=>s=i?s:l;if(t){const l=Ee(o),c=Ee(s);l<0&&c<0?r(0):l>0&&c>0&&a(0)}if(o===s){let l=s===0?1:Math.abs(s*.05);r(s+l),t||a(o-l)}this.min=o,this.max=s}getTickLimit(){const t=this.options.ticks;let{maxTicksLimit:e,stepSize:i}=t,o;return i?(o=Math.ceil(this.max/i)-Math.floor(this.min/i)+1,o>1e3&&(console.warn("scales.".concat(this.id,".ticks.stepSize: ").concat(i," would result generating up to ").concat(o," ticks. Limiting to 1000.")),o=1e3)):(o=this.computeTickLimit(),e=e||11),e&&(o=Math.min(e,o)),o}computeTickLimit(){return Number.POSITIVE_INFINITY}buildTicks(){const t=this.options,e=t.ticks;let i=this.getTickLimit();i=Math.max(2,i);const o={maxTicks:i,bounds:t.bounds,min:t.min,max:t.max,precision:e.precision,step:e.stepSize,count:e.count,maxDigits:this._maxDigits(),horizontal:this.isHorizontal(),minRotation:e.minRotation||0,includeBounds:e.includeBounds!==!1},s=this._range||this,a=bf(o,s);return t.bounds==="ticks"&&Sa(a,this,"value"),t.reverse?(a.reverse(),this.start=this.max,this.end=this.min):(this.start=this.min,this.end=this.max),a}configure(){const t=this.ticks;let e=this.min,i=this.max;if(super.configure(),this.options.offset&&t.length){const o=(i-e)/Math.max(t.length-1,1)/2;e-=o,i+=o}this._startValue=e,this._endValue=i,this._valueRange=i-e}getLabelForValue(t){return Zn(t,this.chart.options.locale,this.options.ticks.format)}}class Do extends Fi{determineDataLimits(){const{min:t,max:e}=this.getMinMax(!0);this.min=Xt(t)?t:0,this.max=Xt(e)?e:1,this.handleTickRangeOptions()}computeTickLimit(){const t=this.isHorizontal(),e=t?this.width:this.height,i=xe(this.options.ticks.minRotation),o=(t?Math.sin(i):Math.cos(i))||.001,s=this._resolveTickFontOptions(0);return Math.ceil(e/Math.min(40,s.lineHeight/o))}getPixelForValue(t){return t===null?NaN:this.getPixelForDecimal((t-this._startValue)/this._valueRange)}getValueForPixel(t){return this._startValue+this.getDecimalForPixel(t)*this._valueRange}}mt(Do,"id","linear"),mt(Do,"defaults",{ticks:{callback:Ri.formatters.numeric}});const Xn=n=>Math.floor($e(n)),on=(n,t)=>Math.pow(10,Xn(n)+t);function ra(n){return n/Math.pow(10,Xn(n))===1}function la(n,t,e){const i=Math.pow(10,e),o=Math.floor(n/i);return Math.ceil(t/i)-o}function yf(n,t){const e=t-n;let i=Xn(e);for(;la(n,t,i)>10;)i++;for(;la(n,t,i)<10;)i--;return Math.min(i,Xn(n))}function wf(n,{min:t,max:e}){t=be(n.min,t);const i=[],o=Xn(t);let s=yf(t,e),a=s<0?Math.pow(10,Math.abs(s)):1;const r=Math.pow(10,s),l=o>s?Math.pow(10,o):0,c=Math.round((t-l)*a)/a,d=Math.floor((t-l)/r/10)*r*10;let f=Math.floor((c-d)/Math.pow(10,s)),p=be(n.min,Math.round((l+d+f*Math.pow(10,s))*a)/a);for(;p<e;)i.push({value:p,major:ra(p),significand:f}),f>=10?f=f<15?15:20:f++,f>=20&&(s++,f=2,a=s>=0?1:a),p=Math.round((l+d+f*Math.pow(10,s))*a)/a;const m=be(n.max,p);return i.push({value:m,major:ra(m),significand:f}),i}class ko extends hn{constructor(t){super(t),this.start=void 0,this.end=void 0,this._startValue=void 0,this._valueRange=0}parse(t,e){const i=Fi.prototype.parse.apply(this,[t,e]);if(i===0){this._zero=!0;return}return Xt(i)&&i>0?i:null}determineDataLimits(){const{min:t,max:e}=this.getMinMax(!0);this.min=Xt(t)?Math.max(0,t):null,this.max=Xt(e)?Math.max(0,e):null,this.options.beginAtZero&&(this._zero=!0),this._zero&&this.min!==this._suggestedMin&&!Xt(this._userMin)&&(this.min=t===on(this.min,0)?on(this.min,-1):on(this.min,0)),this.handleTickRangeOptions()}handleTickRangeOptions(){const{minDefined:t,maxDefined:e}=this.getUserBounds();let i=this.min,o=this.max;const s=r=>i=t?i:r,a=r=>o=e?o:r;i===o&&(i<=0?(s(1),a(10)):(s(on(i,-1)),a(on(o,1)))),i<=0&&s(on(o,-1)),o<=0&&a(on(i,1)),this.min=i,this.max=o}buildTicks(){const t=this.options,e={min:this._userMin,max:this._userMax},i=wf(e,this);return t.bounds==="ticks"&&Sa(i,this,"value"),t.reverse?(i.reverse(),this.start=this.max,this.end=this.min):(this.start=this.min,this.end=this.max),i}getLabelForValue(t){return t===void 0?"0":Zn(t,this.chart.options.locale,this.options.ticks.format)}configure(){const t=this.min;super.configure(),this._startValue=$e(t),this._valueRange=$e(this.max)-$e(t)}getPixelForValue(t){return(t===void 0||t===0)&&(t=this.min),t===null||isNaN(t)?NaN:this.getPixelForDecimal(t===this.min?0:($e(t)-this._startValue)/this._valueRange)}getValueForPixel(t){const e=this.getDecimalForPixel(t);return Math.pow(10,this._startValue+e*this._valueRange)}}mt(ko,"id","logarithmic"),mt(ko,"defaults",{ticks:{callback:Ri.formatters.logarithmic,major:{enabled:!0}}});function To(n){const t=n.ticks;if(t.display&&n.display){const e=ce(t.backdropPadding);return Tt(t.font&&t.font.size,qt.font.size)+e.height}return 0}function _f(n,t,e){return e=$t(e)?e:[e],{w:kl(n,t.string,e),h:e.length*t.lineHeight}}function ca(n,t,e,i,o){return n===i||n===o?{start:t-e/2,end:t+e/2}:n<i||n>o?{start:t-e,end:t}:{start:t,end:t+e}}function xf(n){const t={l:n.left+n._padding.left,r:n.right-n._padding.right,t:n.top+n._padding.top,b:n.bottom-n._padding.bottom},e=Object.assign({},t),i=[],o=[],s=n._pointLabels.length,a=n.options.pointLabels,r=a.centerPointLabels?Nt/s:0;for(let l=0;l<s;l++){const c=a.setContext(n.getPointLabelContext(l));o[l]=c.padding;const d=n.getPointPosition(l,n.drawingArea+o[l],r),f=te(c.font),p=_f(n.ctx,f,n._pointLabels[l]);i[l]=p;const m=re(n.getIndexAngle(l)+r),_=Math.round(Bo(m)),S=ca(_,d.x,p.w,0,180),k=ca(_,d.y,p.h,90,270);Sf(e,t,m,S,k)}n.setCenterPoint(t.l-e.l,e.r-t.r,t.t-e.t,e.b-t.b),n._pointLabelItems=kf(n,i,o)}function Sf(n,t,e,i,o){const s=Math.abs(Math.sin(e)),a=Math.abs(Math.cos(e));let r=0,l=0;i.start<t.l?(r=(t.l-i.start)/s,n.l=Math.min(n.l,t.l-r)):i.end>t.r&&(r=(i.end-t.r)/s,n.r=Math.max(n.r,t.r+r)),o.start<t.t?(l=(t.t-o.start)/a,n.t=Math.min(n.t,t.t-l)):o.end>t.b&&(l=(o.end-t.b)/a,n.b=Math.max(n.b,t.b+l))}function Cf(n,t,e){const i=n.drawingArea,{extra:o,additionalAngle:s,padding:a,size:r}=e,l=n.getPointPosition(t,i+o+a,s),c=Math.round(Bo(re(l.angle+Jt))),d=Mf(l.y,r.h,c),f=Tf(c),p=If(l.x,r.w,f);return{visible:!0,x:l.x,y:d,textAlign:f,left:p,top:d,right:p+r.w,bottom:d+r.h}}function Df(n,t){if(!t)return!0;const{left:e,top:i,right:o,bottom:s}=n;return!(Ue({x:e,y:i},t)||Ue({x:e,y:s},t)||Ue({x:o,y:i},t)||Ue({x:o,y:s},t))}function kf(n,t,e){const i=[],o=n._pointLabels.length,s=n.options,{centerPointLabels:a,display:r}=s.pointLabels,l={extra:To(s)/2,additionalAngle:a?Nt/o:0};let c;for(let d=0;d<o;d++){l.padding=e[d],l.size=t[d];const f=Cf(n,d,l);i.push(f),r==="auto"&&(f.visible=Df(f,c),f.visible&&(c=f))}return i}function Tf(n){return n===0||n===180?"center":n<180?"left":"right"}function If(n,t,e){return e==="right"?n-=t:e==="center"&&(n-=t/2),n}function Mf(n,t,e){return e===90||e===270?n-=t/2:(e>270||e<90)&&(n-=t),n}function Ef(n,t,e){const{left:i,top:o,right:s,bottom:a}=e,{backdropColor:r}=t;if(!At(r)){const l=cn(t.borderRadius),c=ce(t.backdropPadding);n.fillStyle=r;const d=i-c.left,f=o-c.top,p=s-i+c.width,m=a-o+c.height;Object.values(l).some(_=>_!==0)?(n.beginPath(),qn(n,{x:d,y:f,w:p,h:m,radius:l}),n.fill()):n.fillRect(d,f,p,m)}}function Pf(n,t){const{ctx:e,options:{pointLabels:i}}=n;for(let o=t-1;o>=0;o--){const s=n._pointLabelItems[o];if(!s.visible)continue;const a=i.setContext(n.getPointLabelContext(o));Ef(e,a,s);const r=te(a.font),{x:l,y:c,textAlign:d}=s;fn(e,n._pointLabels[o],l,c+r.lineHeight/2,r,{color:a.color,textAlign:d,textBaseline:"middle"})}}function pr(n,t,e,i){const{ctx:o}=n;if(e)o.arc(n.xCenter,n.yCenter,t,0,Yt);else{let s=n.getPointPosition(0,t);o.moveTo(s.x,s.y);for(let a=1;a<i;a++)s=n.getPointPosition(a,t),o.lineTo(s.x,s.y)}}function Af(n,t,e,i,o){const s=n.ctx,a=t.circular,{color:r,lineWidth:l}=t;!a&&!i||!r||!l||e<0||(s.save(),s.strokeStyle=r,s.lineWidth=l,s.setLineDash(o.dash||[]),s.lineDashOffset=o.dashOffset,s.beginPath(),pr(n,e,a,i),s.closePath(),s.stroke(),s.restore())}function Bf(n,t,e){return Ze(n,{label:e,index:t,type:"pointLabel"})}class Ln extends Fi{constructor(t){super(t),this.xCenter=void 0,this.yCenter=void 0,this.drawingArea=void 0,this._pointLabels=[],this._pointLabelItems=[]}setDimensions(){const t=this._padding=ce(To(this.options)/2),e=this.width=this.maxWidth-t.width,i=this.height=this.maxHeight-t.height;this.xCenter=Math.floor(this.left+e/2+t.left),this.yCenter=Math.floor(this.top+i/2+t.top),this.drawingArea=Math.floor(Math.min(e,i)/2)}determineDataLimits(){const{min:t,max:e}=this.getMinMax(!1);this.min=Xt(t)&&!isNaN(t)?t:0,this.max=Xt(e)&&!isNaN(e)?e:0,this.handleTickRangeOptions()}computeTickLimit(){return Math.ceil(this.drawingArea/To(this.options))}generateTickLabels(t){Fi.prototype.generateTickLabels.call(this,t),this._pointLabels=this.getLabels().map((e,i)=>{const o=jt(this.options.pointLabels.callback,[e,i],this);return o||o===0?o:""}).filter((e,i)=>this.chart.getDataVisibility(i))}fit(){const t=this.options;t.display&&t.pointLabels.display?xf(this):this.setCenterPoint(0,0,0,0)}setCenterPoint(t,e,i,o){this.xCenter+=Math.floor((t-e)/2),this.yCenter+=Math.floor((i-o)/2),this.drawingArea-=Math.min(this.drawingArea/2,Math.max(t,e,i,o))}getIndexAngle(t){const e=Yt/(this._pointLabels.length||1),i=this.options.startAngle||0;return re(t*e+xe(i))}getDistanceFromCenterForValue(t){if(At(t))return NaN;const e=this.drawingArea/(this.max-this.min);return this.options.reverse?(this.max-t)*e:(t-this.min)*e}getValueForDistanceFromCenter(t){if(At(t))return NaN;const e=t/(this.drawingArea/(this.max-this.min));return this.options.reverse?this.max-e:this.min+e}getPointLabelContext(t){const e=this._pointLabels||[];if(t>=0&&t<e.length){const i=e[t];return Bf(this.getContext(),t,i)}}getPointPosition(t,e,i=0){const o=this.getIndexAngle(t)-Jt+i;return{x:Math.cos(o)*e+this.xCenter,y:Math.sin(o)*e+this.yCenter,angle:o}}getPointPositionForValue(t,e){return this.getPointPosition(t,this.getDistanceFromCenterForValue(e))}getBasePosition(t){return this.getPointPositionForValue(t||0,this.getBaseValue())}getPointLabelPosition(t){const{left:e,top:i,right:o,bottom:s}=this._pointLabelItems[t];return{left:e,top:i,right:o,bottom:s}}drawBackground(){const{backgroundColor:t,grid:{circular:e}}=this.options;if(t){const i=this.ctx;i.save(),i.beginPath(),pr(this,this.getDistanceFromCenterForValue(this._endValue),e,this._pointLabels.length),i.closePath(),i.fillStyle=t,i.fill(),i.restore()}}drawGrid(){const t=this.ctx,e=this.options,{angleLines:i,grid:o,border:s}=e,a=this._pointLabels.length;let r,l,c;if(e.pointLabels.display&&Pf(this,a),o.display&&this.ticks.forEach((d,f)=>{if(f!==0||f===0&&this.min<0){l=this.getDistanceFromCenterForValue(d.value);const p=this.getContext(f),m=o.setContext(p),_=s.setContext(p);Af(this,m,l,a,_)}}),i.display){for(t.save(),r=a-1;r>=0;r--){const d=i.setContext(this.getPointLabelContext(r)),{color:f,lineWidth:p}=d;!p||!f||(t.lineWidth=p,t.strokeStyle=f,t.setLineDash(d.borderDash),t.lineDashOffset=d.borderDashOffset,l=this.getDistanceFromCenterForValue(e.reverse?this.min:this.max),c=this.getPointPosition(r,l),t.beginPath(),t.moveTo(this.xCenter,this.yCenter),t.lineTo(c.x,c.y),t.stroke())}t.restore()}}drawBorder(){}drawLabels(){const t=this.ctx,e=this.options,i=e.ticks;if(!i.display)return;const o=this.getIndexAngle(0);let s,a;t.save(),t.translate(this.xCenter,this.yCenter),t.rotate(o),t.textAlign="center",t.textBaseline="middle",this.ticks.forEach((r,l)=>{if(l===0&&this.min>=0&&!e.reverse)return;const c=i.setContext(this.getContext(l)),d=te(c.font);if(s=this.getDistanceFromCenterForValue(this.ticks[l].value),c.showLabelBackdrop){t.font=d.string,a=t.measureText(r.label).width,t.fillStyle=c.backdropColor;const f=ce(c.backdropPadding);t.fillRect(-a/2-f.left,-s-d.size/2-f.top,a+f.width,d.size+f.height)}fn(t,r.label,0,-s,d,{color:c.color,strokeColor:c.textStrokeColor,strokeWidth:c.textStrokeWidth})}),t.restore()}drawTitle(){}}mt(Ln,"id","radialLinear"),mt(Ln,"defaults",{display:!0,animate:!0,position:"chartArea",angleLines:{display:!0,lineWidth:1,borderDash:[],borderDashOffset:0},grid:{circular:!1},startAngle:0,ticks:{showLabelBackdrop:!0,callback:Ri.formatters.numeric},pointLabels:{backdropColor:void 0,backdropPadding:2,display:!0,font:{size:10},callback(t){return t},padding:5,centerPointLabels:!1}}),mt(Ln,"defaultRoutes",{"angleLines.color":"borderColor","pointLabels.color":"color","ticks.color":"color"}),mt(Ln,"descriptors",{angleLines:{_fallback:"grid"}});const Wi={millisecond:{common:!0,size:1,steps:1e3},second:{common:!0,size:1e3,steps:60},minute:{common:!0,size:6e4,steps:60},hour:{common:!0,size:36e5,steps:24},day:{common:!0,size:864e5,steps:30},week:{common:!1,size:6048e5,steps:4},month:{common:!0,size:2628e6,steps:12},quarter:{common:!1,size:7884e6,steps:4},year:{common:!0,size:3154e7}},ge=Object.keys(Wi);function da(n,t){return n-t}function ua(n,t){if(At(t))return null;const e=n._adapter,{parser:i,round:o,isoWeekday:s}=n._parseOpts;let a=t;return typeof i=="function"&&(a=i(a)),Xt(a)||(a=typeof i=="string"?e.parse(a,i):e.parse(a)),a===null?null:(o&&(a=o==="week"&&(bn(s)||s===!0)?e.startOf(a,"isoWeek",s):e.startOf(a,o)),+a)}function fa(n,t,e,i){const o=ge.length;for(let s=ge.indexOf(n);s<o-1;++s){const a=Wi[ge[s]],r=a.steps?a.steps:Number.MAX_SAFE_INTEGER;if(a.common&&Math.ceil((e-t)/(r*a.size))<=i)return ge[s]}return ge[o-1]}function Lf(n,t,e,i,o){for(let s=ge.length-1;s>=ge.indexOf(e);s--){const a=ge[s];if(Wi[a].common&&n._adapter.diff(o,i,a)>=t-1)return a}return ge[e?ge.indexOf(e):0]}function Of(n){for(let t=ge.indexOf(n)+1,e=ge.length;t<e;++t)if(Wi[ge[t]].common)return ge[t]}function ha(n,t,e){if(!e)n[t]=!0;else if(e.length){const{lo:i,hi:o}=Lo(e,t),s=e[i]>=t?e[i]:e[o];n[s]=!0}}function Ff(n,t,e,i){const o=n._adapter,s=+o.startOf(t[0].value,i),a=t[t.length-1].value;let r,l;for(r=s;r<=a;r=+o.add(r,1,i))l=e[r],l>=0&&(t[l].major=!0);return t}function pa(n,t,e){const i=[],o={},s=t.length;let a,r;for(a=0;a<s;++a)r=t[a],o[r]=a,i.push({value:r,major:!1});return s===0||!e?i:Ff(n,i,o,e)}class Kn extends hn{constructor(t){super(t),this._cache={data:[],labels:[],all:[]},this._unit="day",this._majorUnit=void 0,this._offsets={},this._normalized=!1,this._parseOpts=void 0}init(t,e={}){const i=t.time||(t.time={}),o=this._adapter=new jc._date(t.adapters.date);o.init(e),On(i.displayFormats,o.formats()),this._parseOpts={parser:i.parser,round:i.round,isoWeekday:i.isoWeekday},super.init(t),this._normalized=e.normalized}parse(t,e){return t===void 0?null:ua(this,t)}beforeLayout(){super.beforeLayout(),this._cache={data:[],labels:[],all:[]}}determineDataLimits(){const t=this.options,e=this._adapter,i=t.time.unit||"day";let{min:o,max:s,minDefined:a,maxDefined:r}=this.getUserBounds();function l(c){!a&&!isNaN(c.min)&&(o=Math.min(o,c.min)),!r&&!isNaN(c.max)&&(s=Math.max(s,c.max))}(!a||!r)&&(l(this._getLabelBounds()),(t.bounds!=="ticks"||t.ticks.source!=="labels")&&l(this.getMinMax(!1))),o=Xt(o)&&!isNaN(o)?o:+e.startOf(Date.now(),i),s=Xt(s)&&!isNaN(s)?s:+e.endOf(Date.now(),i)+1,this.min=Math.min(o,s-1),this.max=Math.max(o+1,s)}_getLabelBounds(){const t=this.getLabelTimestamps();let e=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY;return t.length&&(e=t[0],i=t[t.length-1]),{min:e,max:i}}buildTicks(){const t=this.options,e=t.time,i=t.ticks,o=i.source==="labels"?this.getLabelTimestamps():this._generate();t.bounds==="ticks"&&o.length&&(this.min=this._userMin||o[0],this.max=this._userMax||o[o.length-1]);const s=this.min,a=this.max,r=hl(o,s,a);return this._unit=e.unit||(i.autoSkip?fa(e.minUnit,this.min,this.max,this._getLabelCapacity(s)):Lf(this,r.length,e.minUnit,this.min,this.max)),this._majorUnit=!i.major.enabled||this._unit==="year"?void 0:Of(this._unit),this.initOffsets(o),t.reverse&&r.reverse(),pa(this,r,this._majorUnit)}afterAutoSkip(){this.options.offsetAfterAutoskip&&this.initOffsets(this.ticks.map(t=>+t.value))}initOffsets(t=[]){let e=0,i=0,o,s;this.options.offset&&t.length&&(o=this.getDecimalForValue(t[0]),t.length===1?e=1-o:e=(this.getDecimalForValue(t[1])-o)/2,s=this.getDecimalForValue(t[t.length-1]),t.length===1?i=s:i=(s-this.getDecimalForValue(t[t.length-2]))/2);const a=t.length<3?.5:.25;e=ne(e,0,a),i=ne(i,0,a),this._offsets={start:e,end:i,factor:1/(e+1+i)}}_generate(){const t=this._adapter,e=this.min,i=this.max,o=this.options,s=o.time,a=s.unit||fa(s.minUnit,e,i,this._getLabelCapacity(e)),r=Tt(o.ticks.stepSize,1),l=a==="week"?s.isoWeekday:!1,c=bn(l)||l===!0,d={};let f=e,p,m;if(c&&(f=+t.startOf(f,"isoWeek",l)),f=+t.startOf(f,c?"day":a),t.diff(i,e,a)>1e5*r)throw new Error(e+" and "+i+" are too far apart with stepSize of "+r+" "+a);const _=o.ticks.source==="data"&&this.getDataTimestamps();for(p=f,m=0;p<i;p=+t.add(p,r,a),m++)ha(d,p,_);return(p===i||o.bounds==="ticks"||m===1)&&ha(d,p,_),Object.keys(d).sort(da).map(S=>+S)}getLabelForValue(t){const e=this._adapter,i=this.options.time;return i.tooltipFormat?e.format(t,i.tooltipFormat):e.format(t,i.displayFormats.datetime)}format(t,e){const o=this.options.time.displayFormats,s=this._unit,a=e||o[s];return this._adapter.format(t,a)}_tickFormatFunction(t,e,i,o){const s=this.options,a=s.ticks.callback;if(a)return jt(a,[t,e,i],this);const r=s.time.displayFormats,l=this._unit,c=this._majorUnit,d=l&&r[l],f=c&&r[c],p=i[e],m=c&&f&&p&&p.major;return this._adapter.format(t,o||(m?f:d))}generateTickLabels(t){let e,i,o;for(e=0,i=t.length;e<i;++e)o=t[e],o.label=this._tickFormatFunction(o.value,e,t)}getDecimalForValue(t){return t===null?NaN:(t-this.min)/(this.max-this.min)}getPixelForValue(t){const e=this._offsets,i=this.getDecimalForValue(t);return this.getPixelForDecimal((e.start+i)*e.factor)}getValueForPixel(t){const e=this._offsets,i=this.getDecimalForPixel(t)/e.factor-e.end;return this.min+i*(this.max-this.min)}_getLabelSize(t){const e=this.options.ticks,i=this.ctx.measureText(t).width,o=xe(this.isHorizontal()?e.maxRotation:e.minRotation),s=Math.cos(o),a=Math.sin(o),r=this._resolveTickFontOptions(0).size;return{w:i*s+r*a,h:i*a+r*s}}_getLabelCapacity(t){const e=this.options.time,i=e.displayFormats,o=i[e.unit]||i.millisecond,s=this._tickFormatFunction(t,0,pa(this,[t],this._majorUnit),o),a=this._getLabelSize(s),r=Math.floor(this.isHorizontal()?this.width/a.w:this.height/a.h)-1;return r>0?r:1}getDataTimestamps(){let t=this._cache.data||[],e,i;if(t.length)return t;const o=this.getMatchingVisibleMetas();if(this._normalized&&o.length)return this._cache.data=o[0].controller.getAllParsedValues(this);for(e=0,i=o.length;e<i;++e)t=t.concat(o[e].controller.getAllParsedValues(this));return this._cache.data=this.normalize(t)}getLabelTimestamps(){const t=this._cache.labels||[];let e,i;if(t.length)return t;const o=this.getLabels();for(e=0,i=o.length;e<i;++e)t.push(ua(this,o[e]));return this._cache.labels=this._normalized?t:this.normalize(t)}normalize(t){return ka(t.sort(da))}}mt(Kn,"id","time"),mt(Kn,"defaults",{bounds:"data",adapters:{},time:{parser:!1,unit:!1,round:!1,isoWeekday:!1,minUnit:"millisecond",displayFormats:{}},ticks:{source:"auto",callback:!1,major:{enabled:!1}}});function fi(n,t,e){let i=0,o=n.length-1,s,a,r,l;e?(t>=n[i].pos&&t<=n[o].pos&&({lo:i,hi:o}=Ve(n,"pos",t)),{pos:s,time:r}=n[i],{pos:a,time:l}=n[o]):(t>=n[i].time&&t<=n[o].time&&({lo:i,hi:o}=Ve(n,"time",t)),{time:s,pos:r}=n[i],{time:a,pos:l}=n[o]);const c=a-s;return c?r+(l-r)*(t-s)/c:r}class Io extends Kn{constructor(t){super(t),this._table=[],this._minPos=void 0,this._tableRange=void 0}initOffsets(){const t=this._getTimestampsForTable(),e=this._table=this.buildLookupTable(t);this._minPos=fi(e,this.min),this._tableRange=fi(e,this.max)-this._minPos,super.initOffsets(t)}buildLookupTable(t){const{min:e,max:i}=this,o=[],s=[];let a,r,l,c,d;for(a=0,r=t.length;a<r;++a)c=t[a],c>=e&&c<=i&&o.push(c);if(o.length<2)return[{time:e,pos:0},{time:i,pos:1}];for(a=0,r=o.length;a<r;++a)d=o[a+1],l=o[a-1],c=o[a],Math.round((d+l)/2)!==c&&s.push({time:c,pos:a/(r-1)});return s}_generate(){const t=this.min,e=this.max;let i=super.getDataTimestamps();return(!i.includes(t)||!i.length)&&i.splice(0,0,t),(!i.includes(e)||i.length===1)&&i.push(e),i.sort((o,s)=>o-s)}_getTimestampsForTable(){let t=this._cache.all||[];if(t.length)return t;const e=this.getDataTimestamps(),i=this.getLabelTimestamps();return e.length&&i.length?t=this.normalize(e.concat(i)):t=e.length?e:i,t=this._cache.all=t,t}getDecimalForValue(t){return(fi(this._table,t)-this._minPos)/this._tableRange}getValueForPixel(t){const e=this._offsets,i=this.getDecimalForPixel(t)/e.factor-e.end;return fi(this._table,i*this._tableRange+this._minPos,!0)}}mt(Io,"id","timeseries"),mt(Io,"defaults",Kn.defaults);var Nf=Object.freeze({__proto__:null,CategoryScale:Co,LinearScale:Do,LogarithmicScale:ko,RadialLinearScale:Ln,TimeScale:Kn,TimeSeriesScale:Io});const Rf=[Hc,bu,pf,Nf];Re.register(...Rf);function zf(n){return n?(n=String(n).toLowerCase(),n==="ytd"||n==="ltm"?"mensile":n):""}function Vf(n){var t=new Date(Date.UTC(n.getFullYear(),n.getMonth(),n.getDate())),e=t.getUTCDay()||7;t.setUTCDate(t.getUTCDate()+4-e);var i=new Date(Date.UTC(t.getUTCFullYear(),0,1));return Math.ceil(((t-i)/864e5+1)/7)}typeof window<"u"&&(typeof window.effectivePeriodType!="function"&&(window.effectivePeriodType=zf),typeof window.isoWeekNum!="function"&&(window.isoWeekNum=Vf));(function(){const n=window.fetch.bind(window);function t(){try{const i=JSON.parse(localStorage.getItem("user")||"{}");if(i&&(i.token||i.jwt||i.accessToken))return i.token||i.jwt||i.accessToken}catch(i){}const e=["token","authToken","jwt","bp_token","accessToken","id_token"];for(const i of e){let o=localStorage.getItem(i)||sessionStorage.getItem(i);if(o){try{const s=JSON.parse(o);if(s&&(s.token||s.jwt||s.accessToken))return s.token||s.jwt||s.accessToken}catch(s){}if(o=String(o).replace(/^"+|"+$/g,""),/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+$/.test(o))return o}}return null}window.fetch=function(e,i){const o=typeof e=="string"?e:e&&e.url||"";if(!(typeof o=="string"&&(o.startsWith("/api/")||o.startsWith(location.origin+"/api/"))))return n(e,i);const a=t(),r=Object.assign({},i);return r.headers=new Headers(r&&r.headers||{}),a&&!r.headers.has("Authorization")&&r.headers.set("Authorization","Bearer "+a),n(e,r)}})();(function(){function n(){const o=r=>String(r).replace(/^"+|"+$/g,""),s=r=>/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+$/.test(r||""),a=["token","authToken","jwt","bp_token","accessToken","id_token"];for(const r of a){let l=localStorage.getItem(r)||sessionStorage.getItem(r);if(l){try{const c=JSON.parse(l);if(c&&(c.token||c.jwt||c.accessToken))return c.token||c.jwt||c.accessToken}catch(c){}if(l=o(l),s(l))return l}}try{const r=JSON.parse(localStorage.getItem("user")||"{}");if(r&&(r.token||r.jwt||r.accessToken))return r.token||r.jwt||r.accessToken}catch(r){}return null}typeof window.users>"u"&&(window.users=[]),(async function o(){try{if(window.GET){const r=await window.GET("/api/usernames");r&&Array.isArray(r.users)&&(window.users=r.users);return}const s=n(),a=await fetch("/api/usernames",{headers:{Accept:"application/json",...s?{Authorization:"Bearer "+s}:{}}});if(a.status===401){setTimeout(o,800);return}if(a.ok){const r=await a.json();r&&Array.isArray(r.users)&&(window.users=r.users)}}catch(s){setTimeout(o,1200)}})();function t(o,s,a){return new Date(Date.UTC(o,s,a))}function e(o){return new Date(o.getTime()+24*3600*1e3-1)}function i(o,s){return new Date(Date.UTC(o,s+1,0))}typeof window.buildBuckets!="function"&&(window.buildBuckets=function(o,s){var a=String(o||"mensile").toLowerCase(),r=effectivePeriodType(a),l=s?new Date(s):new Date,c=l.getUTCFullYear(),d=[];function f(J,W){d.push({s:J.getTime(),e:W.getTime()})}if(a==="ytd"){for(var p=0;p<=l.getUTCMonth();p++){var m=t(l.getUTCFullYear(),p,1),_=e(i(m.getUTCFullYear(),m.getUTCMonth()));f(m,_)}return d}if(a==="ltm"){for(var S=t(l.getUTCFullYear(),l.getUTCMonth(),1),k=11;k>=0;k--){var p=t(S.getUTCFullYear(),S.getUTCMonth()-k,1);f(p,e(i(p.getUTCFullYear(),p.getUTCMonth())))}return d}if(r==="settimanale"){var O=new Date(Date.UTC(l.getUTCFullYear(),l.getUTCMonth(),l.getUTCDate())),F=(O.getUTCDay()+6)%7;O.setUTCDate(O.getUTCDate()-F);for(var X=52;X>=0;X--){var et=new Date(O);et.setUTCDate(O.getUTCDate()-X*7);var T=new Date(et);T.setUTCDate(et.getUTCDate()+6),T.setUTCHours(23,59,59,999),f(et,T)}return d}if(r==="mensile"){for(var S=new Date(Date.UTC(l.getUTCFullYear(),l.getUTCMonth(),1)),k=23;k>=0;k--){var p=new Date(Date.UTC(S.getUTCFullYear(),S.getUTCMonth()-k,1));f(p,e(i(p.getUTCFullYear(),p.getUTCMonth())))}return d}if(r==="trimestrale"){for(var D=Math.floor(l.getUTCMonth()/3),E=11;E>=0;E--){var P=D-E,R=c+Math.floor(P/4),N=(P%4+4)%4,et=t(R,N*3,1),T=e(new Date(Date.UTC(R,N*3+3,0)));f(et,T)}return d}if(r==="semestrale"){for(var $=l.getUTCMonth()<6?0:1,H=5;H>=0;H--){var nt=$-H,j=c+Math.floor(nt/2),K=(nt%2+2)%2,rt=K===0?0:6,Y=t(j,rt,1),Q=e(new Date(Date.UTC(j,rt+6,0)));f(Y,Q)}return d}for(var it=2;it>=0;it--){var tt=c-it;f(t(tt,0,1),e(new Date(Date.UTC(tt,12,0))))}return d}),typeof window.labelsForBuckets!="function"&&(window.labelsForBuckets=function(o,s){var a=effectivePeriodType(o||"mensile");return(s||[]).map(function(r){var l=new Date(r.s);return a==="settimanale"?"W"+isoWeekNum(l)+" "+l.getUTCFullYear():a==="mensile"?String(l.getUTCMonth()+1).padStart(2,"0")+"/"+l.getUTCFullYear():a==="trimestrale"?"Q"+(Math.floor(l.getUTCMonth()/3)+1)+" "+l.getUTCFullYear():a==="semestrale"?(l.getUTCMonth()<6?"S1 ":"S2 ")+l.getUTCFullYear():String(l.getUTCFullYear())})}),typeof window.sumIndicator!="function"&&(window.sumIndicator=function(o,s,a){var c,d;var r=String(s).toLowerCase()==="previsionale"?o.indicatorsPrev||{}:o.indicatorsCons||{};if(a==="VSDTotale")return Number(r.VSDPersonale||0)+Number(r.VSDIndiretto||0);var l=Number((d=(c=r[a])!=null?c:r[a.toUpperCase()])!=null?d:0);return Number.isFinite(l)?l:0}),(function(){try{let a=function(r,l){try{if(this&&typeof this.getLabelForValue=="function")return String(this.getLabelForValue(r))}catch(p){}try{var c=typeof r=="number"?r:l,d=this&&this.chart&&this.chart.data&&this.chart.data.labels||[],f=Array.isArray(d)?d[c]:void 0;return String(f!=null?f:r)}catch(p){return String(r)}};if(typeof window.Chart>"u")return;try{Chart.defaults=Chart.defaults||{},Chart.defaults.scales=Chart.defaults.scales||{},Chart.defaults.scales.category=Chart.defaults.scales.category||{},Chart.defaults.scales.category.ticks=Object.assign({},Chart.defaults.scales.category.ticks||{},{callback:a})}catch(r){}var s={id:"bpAutoTicks",beforeUpdate:function(r){try{let m=function(_,S){try{var k=Array.isArray(_)?_.length:0;if(!k)return{autoSkip:!0,maxRotation:0,minRotation:0,callback:a};for(var O=0,F=0;F<_.length;F++){var X=""+(_[F]==null?"":_[F]);X.length>O&&(O=X.length)}var et=Math.max(28,Math.min(90,Math.round(O*7))),T=k*et;return T>(S||320)*1.2?{autoSkip:!0,maxRotation:45,minRotation:45,callback:a}:{autoSkip:!0,maxRotation:0,minRotation:0,callback:a}}catch(D){return{autoSkip:!0,maxRotation:0,minRotation:0,callback:a}}};if(!r||(r.config&&r.config.type)!=="line")return;var l=r.config&&r.config.data&&r.config.data.labels||[],c=r.canvas&&(r.canvas.clientWidth||r.canvas.width)||320,d=typeof window.computeTickOptions=="function"?window.computeTickOptions:m,f=d(l,c);r.options=r.options||{},r.options.scales=r.options.scales||{};var p=r.options.scales.x||(r.options.scales.x={display:!0});p.ticks=Object.assign({},p.ticks||{},f)}catch(m){}}};try{Chart.register?Chart.register(s):Chart.plugins&&Chart.plugins.register&&Chart.plugins.register(s)}catch(r){}}catch(a){}})()})();(function(n){const t=["localhost","127.0.0.1"].includes(n.location.hostname),e=n.pino?n.pino({level:t?"debug":"info"}):console,i={info:(...o)=>e.info?e.info(...o):console.log(...o),error:(...o)=>e.error?e.error(...o):console.error(...o),warn:(...o)=>e.warn?e.warn(...o):console.warn(...o),debug:(...o)=>e.debug?e.debug(...o):console.debug(...o)};n.logger=i})(window);window.BP_PHRASES=(function(){const n=["Ottimo, {name}! 🎯","Ben fatto, {name}! 🙌","Avanti così, {name}! 🚀","Perfetto, {name}! 🤩","Bel colpo, {name}! 💥","Ci siamo, {name}! 👌","Grande {name}! 🧱","Pezzo dopo pezzo, {name}! 🧩","Molto bene, {name}! 👍","Stai andando bene, {name}! ➡️"],t=["Che figata, {name}! 🔥","Ma cosa dico grande… grandissimo, {name}! 💪","Super, {name}! ✨","Non ti ferma nessuno, {name}!! 🏎️","Stai andando alla grande, {name}! 📈","Gran progressione, {name}! ⏩","Il ritmo è giusto, {name}! 🥁","Questa spinge, {name}! 🧨","Bello tosto, {name}! 🛡️","Gran focus, {name}! 🎯"],e=["BOOM! {name}, questo è livello PRO! 🏆","Risultato pazzesco, {name}! 🤯","Clamoroso {name}, così si fa! ⚡","È ufficiale: {name} ON FIRE! 🔥🔥","Top di gamma, {name}! 🥇","Mostruoso upgrade, {name}! 🚀","Record personale in vista, {name}! 🧠","Spacchi tutto, {name}! 💣","Da incorniciare, {name}! 🖼️","Questo alza l’asticella, {name}! 📏"],i={lite:n,mid:t,mega:e};return i.standard=n,i.rilevante=t,i.grande=e,i.pick=function(o,s){const a=i[o]||n,r=s||JSON.parse(localStorage.getItem("bp_user")||"{}").name||"campione";return(a[Math.floor(Math.random()*a.length)]||"Grande!").replace(/\{name\}/g,r)},i.random=function(o){const s=[n,t,e],a=s[Math.floor(Math.random()*s.length)];return i.pick(a===e?"mega":a===t?"rilevante":"standard",o)},i})();(function(){const n=window.BP=window.BP||{},t=n.Haptics=n.Haptics||{};function e(){const o=navigator.userAgent||navigator.vendor||"";return/android|iphone|ipad|ipod|mobile/i.test(o)}function i(o){if(e()&&"vibrate"in navigator)try{switch(o){case"light":navigator.vibrate(12);break;case"heavy":navigator.vibrate([10,30,10]);break;default:navigator.vibrate(18);break}}catch(s){}}t.impact=i})();(function(){const n=window.BP=window.BP||{},t=n.Undo=n.Undo||{},e=document.createElement("div");e.className="bp-undo-host",document.body.appendChild(e);const i="\n  .bp-undo-host{\n    position: fixed; left:50%; transform: translateX(-50%);\n    bottom: 20px; z-index: 1201; display:flex; flex-direction:column; gap:8px;\n  }\n  .bp-undo{\n    min-width: 280px; max-width: 540px;\n    background: rgba(15,19,28,.95);\n    border:1px solid rgba(255,255,255,.18);\n    border-radius: 12px; padding: 10px 12px;\n    box-shadow: 0 10px 24px rgba(0,0,0,.35);\n    display:flex; align-items:center; gap:10px;\n    animation: bpUndoPop .16s ease-out;\n  }\n  .bp-undo .lbl{ font-weight:700; }\n  .bp-undo .spacer{ flex:1; }\n  .bp-undo button{ white-space:nowrap; }\n  @keyframes bpUndoPop{ from{ transform: translate(-50%, 4px); opacity:0 } to{ transform: translate(-50%, 0); opacity:1 } }\n  ",o=document.createElement("style");o.textContent=i,document.head.appendChild(o);function s(a){const r=document.createElement("div");r.className="bp-undo",r.innerHTML='\n      <div class="lbl">'.concat(a&&a.label||"Operazione eseguita",'</div>\n      <div class="spacer"></div>\n      <button type="button" class="ghost" data-undo>Annulla</button>\n    '),e.appendChild(r);let l=!1;const c=setTimeout(()=>{l||(l=!0,r.remove())},a&&a.timeoutMs||5e3);r.querySelector("[data-undo]").addEventListener("click",()=>{if(!l){l=!0,clearTimeout(c);try{a&&a.onUndo&&a.onUndo()}catch(d){}r.remove()}})}t.push=s})();(function(){const n=window.BP=window.BP||{},t=n.ClientsHelpers=n.ClientsHelpers||{};function e(a){return String(a||"").trim().toLowerCase()}function i(a){const r={};return(a||[]).forEach(l=>{const c=e(l.client);if(!c)return;const d=l.start||l.end;if(!d)return;const f=r[c];(!f||new Date(d)>new Date(f))&&(r[c]=d)}),r}function o(a,r){const l=i(r);return(a||[]).map(c=>{const d=l[e(c.name)]||null;return{...c,lastAppointment:d}})}function s(a,{status:r,consultantId:l,consultantName:c}){const d=m=>String(m||"").trim().toLowerCase(),f=m=>{const _=d(m).replace(/\s+/g,"_").replace(/-/g,"_");return _==="lead_non_chiuso"||_==="lead_non-chiuso"?"lead_non_chiuso":_};let p=a||[];if(r&&r!=="tutti"&&(p=p.filter(m=>f(m.status)===f(r))),l)p=p.filter(m=>(m.consultantId||"")===String(l));else if(c){const m=d(c);p=p.filter(_=>d(_.consultantName)===m)}return p}t.withLastAppointment=o,t.filter=s})();(function(){const n=window.BP=window.BP||{},t=n.Targets=n.Targets||{},e=["VSS","VSDPersonale","VSDIndiretto","GI"],i=["NNCF","AppFatti","Telefonate"],o=e.concat(i),s={senior:{VSS:3e4,VSDPersonale:15e3,VSDIndiretto:5e3,GI:15e3,NNCF:1,AppFatti:4,Telefonate:0},junior:{VSS:15e3,VSDPersonale:5e3,VSDIndiretto:5e3,GI:1e4,NNCF:4,AppFatti:30,Telefonate:300}};function a(m,_){const S=Number(m||0),k=Number(_||0);return k?Math.ceil(S/k)*k:Math.ceil(S)}function r(m){switch(String(m||"mensile").toLowerCase()){case"settimanale":return 1/4;case"mensile":return 1;case"trimestrale":return 3;case"semestrale":return 6;case"annuale":return 12;default:return 1}}function l(m){return e.indexOf(m)>=0}function c(m){const _=String(m||"junior").toLowerCase()==="senior"?"senior":"junior";return{...s[_]}}function d(m,_){const S=r(_),k=c(m),O={};for(const F of o){const X=Number(k[F]||0)*S;l(F)?String(_).toLowerCase()==="settimanale"?O[F]=a(X,500):O[F]=a(X,5e3):O[F]=Math.ceil(X)}return O}function f(m,_){const S={};for(const k of o){const O=Number((m||{})[k]||0),F=Number((_||{})[k]||0),X=O-F,et=F>0?Math.round(O/F*100):O>0?100:0;S[k]={value:O,target:F,delta:X,pct:Math.max(0,et)}}return S}function p(m){const _=[];for(const k of o){const O=(m||{})[k];O&&O.target>0&&_.push(Number(O.pct||0))}if(!_.length)return 0;const S=_.reduce((k,O)=>k+O,0)/_.length;return Math.round(S)}t.MONEY_KEYS=e,t.COUNT_KEYS=i,t.ALL_KEYS=o,t.getMonthly=c,t.getForPeriod=d,t.compare=f,t.summarize=p})();(function(){const n=window.BP=window.BP||{},t=n.ICS=n.ICS||{};function e(i){try{logger.warn("[BP ICS bulk disabled] chiamata a:",i)}catch(o){}}t.createCalendarForRange=function(){return e("createCalendarForRange()"),null},t.downloadForRange=function(){return e("downloadForRange()"),!1}})();(function(){const n=window.BP=window.BP||{},t=n.ClientStatus=n.ClientStatus||{},e="bp_banner_seen";function i(){try{return JSON.parse(localStorage.getItem(e)||"{}")}catch(m){return{}}}function o(m){try{localStorage.setItem(e,JSON.stringify(m||{}))}catch(_){}}function s(m){return!!i()[m]}function a(m){const _=i();_[m]=!0,o(_)}async function r(m){const _=window.authToken||"",S=await fetch(m,{headers:_?{Authorization:"Bearer "+_}:{}});if(!S.ok)throw new Error("GET "+m+" failed");return S.json()}async function l(m,_){const S=window.authToken||"",k=await fetch(m,{method:"POST",headers:{"Content-Type":"application/json",...S?{Authorization:"Bearer "+S}:{}},body:JSON.stringify(_||{})});if(!k.ok)throw new Error("POST "+m+" failed");return k.json()}async function c({clientId:m,status:_}){if(!m)throw new Error("missing clientId");return l("/api/clients",{id:m,status:String(_||"")})}t.setClientStatusByName=d;async function d({clientName:m,status:_}){const S=String(m||"").trim();if(!S)throw new Error("missing clientName");const O=((await r("/api/clients")).clients||[]).find(et=>String(et.name||"").toLowerCase()===S.toLowerCase());if(O)return c({clientId:O.id,status:_});await l("/api/clients",{name:S});const X=((await r("/api/clients")).clients||[]).find(et=>String(et.name||"").toLowerCase()===S.toLowerCase());if(!X)throw new Error("client creation failed");return c({clientId:X.id,status:_})}function f({appointment:m,clientName:_},S){const k=m||{},O=_||k.client||"Cliente",F=document.createElement("div");return F.className="bp-banner-client",F.innerHTML='\n      <div class="bp-banner-inner">\n        <div class="bp-banner-title">È diventato cliente?</div>\n        <div class="bp-banner-sub">Appuntamento con <b>'.concat(p(O),'</b></div>\n        <div class="bp-banner-actions">\n          <button type="button" data-yes>Sì</button>\n          <button type="button" class="ghost" data-no>No</button>\n        </div>\n      </div>\n    '),F.querySelector("[data-yes]").addEventListener("click",()=>S&&S(!0,k)),F.querySelector("[data-no]").addEventListener("click",()=>S&&S(!1,k)),F}function p(m){return String(m).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}(function(){if(document.getElementById("bp-clientstatus-css"))return;const _="\n.bp-banner-client{\n  position: fixed; left:50%; transform:translateX(-50%);\n  top: 70px; z-index: 1200;\n  background: rgba(20,24,34,.95);\n  color: #fff;\n  border: 1px solid rgba(255,255,255,.18);\n  box-shadow: 0 10px 24px rgba(0,0,0,.35);\n  border-radius:14px; padding:10px; min-width:280px;\n  animation: bpBannerPop .18s ease-out;\n}\n.bp-banner-inner{ display:flex; flex-direction:column; gap:6px; }\n.bp-banner-title{ font-weight:800; }\n.bp-banner-sub{ font-size:12px; opacity:.92; }\n.bp-banner-actions{ display:flex; gap:8px; margin-top:6px; justify-content:flex-end; }\n@keyframes bpBannerPop{ from{ transform:translate(-50%, -6px); opacity:0 } to{ transform:translate(-50%, 0); opacity:1 } }\n",S=document.createElement("style");S.id="bp-clientstatus-css",S.textContent=_,document.head.appendChild(S)})(),t.hasSeen=s,t.markSeen=a,t.renderBecameClientBanner=f,t.setClientStatus=c,t.setClientStatusByName=d})();(function(){function n(t){try{fetch("/api/client_error",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:location.href,info:{ua:navigator.userAgent},...t})})}catch(e){}}window.addEventListener("error",function(t){try{n({message:t.message,stack:t.error&&t.error.stack||null})}catch(e){}}),window.addEventListener("unhandledrejection",function(t){try{n({message:"unhandledrejection",stack:t.reason&&t.reason.stack||String(t.reason)})}catch(e){}})})();(function(){function n(t){return String(t||"event").normalize("NFKD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9._-]+/g,"_").replace(/^_+|_+$/g,"").slice(0,80)||"event"}if(window.saveICS&&!window.__icsSanitized){const t=window.saveICS;window.saveICS=function(e,i){try{e=n(e)}catch(o){}return t(e,i)},window.__icsSanitized=!0}window.__icsSanitize=n})();(function(n){function t(e){try{if(n.__postSaleBannersInitialized)return;n.__postSaleBannersInitialized=!0,P("init")}catch(u){}const i=window.BANNERS_LOOKBACK_DAYS||7,o="nncf",s="sale",a=1,r=(u,v)=>"bp_snooze_".concat(v,"_").concat(u),l=(u,v)=>"bp_done_".concat(v,"_").concat(u),c=(u,v)=>{try{const y=localStorage.getItem(r(u,v));return y&&new Date(y).getTime()>Date.now()}catch(y){return!1}},d=(u,v)=>{try{const y=new Date;y.setDate(y.getDate()+1),localStorage.setItem(r(u,v),y.toISOString())}catch(y){}},f=(u,v)=>{try{return localStorage.getItem(l(u,v))==="1"}catch(y){return!1}},p=(u,v)=>{try{localStorage.setItem(l(u,v),"1")}catch(y){}},m=new Set,_=(u,v)=>"bp_pending_".concat(v,"_").concat(u),S=(u,v)=>{const y="".concat(v,":").concat(u);if(m.has(y))return!0;try{const C=localStorage.getItem(_(u,v));return C&&new Date(C).getTime()>Date.now()}catch(C){return!1}},k=(u,v,y=5)=>{const C="".concat(v,":").concat(u);m.add(C);try{const x=new Date;x.setMinutes(x.getMinutes()+Math.max(1,Number(y)||5)),localStorage.setItem(_(u,v),x.toISOString())}catch(x){}},O=(u,v)=>{const y="".concat(v,":").concat(u);m.delete(y);try{localStorage.removeItem(_(u,v))}catch(C){}},F=(u,v)=>"bp_push_".concat(v,"_").concat(u),X=(u,v)=>{try{return localStorage.getItem(F(u,v))==="1"}catch(y){return!1}},et=(u,v)=>{try{localStorage.setItem(F(u,v),"1")}catch(y){}},T=window.BPFinal&&BPFinal.GET||window.GET,D=window.BPFinal&&BPFinal.POST||window.POST,E=window.toast||(u=>alert(u));function P(){try{if(!window||window.DEBUG_BANNERS!==!0)return}catch(u){return}try{window.logger&&typeof window.logger.debug=="function"?window.logger.debug("[banners]",...arguments):console.debug("[banners]",...arguments)}catch(u){}}function R(u){return String(u||"").replace(/[&<>\"]/g,v=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"})[v])}async function N(u,v){try{if(!D||!v||!v.id||X(v.id,u))return;const y=new Date(v.end||v.start||Date.now()).toLocaleString("it-IT",{dateStyle:"short",timeStyle:"short"}),C="Battle Plan",x=u==="nncf"?"È diventato cliente? ".concat(String(v.client||""),". Appuntamento del ").concat(y):"Hai venduto a ".concat(String(v.client||"Cliente"),"? Appuntamento del ").concat(y);await D("/api/push/test",{payload:{title:C,body:x,tag:u==="nncf"?"bp-nncf":"bp-sale",url:"/"}}),et(v.id,u)}catch(y){}}function $(){if(document.getElementById("bp-banner-css"))return;const u="\n      #bp_banner_host{position:fixed;left:16px;right:16px;bottom:16px;z-index:9999;display:flex;justify-content:center;pointer-events:none}\n      .bp-banner-card{pointer-events:auto;width:100%;max-width:720px;background:var(--card,#fff);color:var(--text,#111);\n        border:1px solid rgba(0,0,0,.12);border-radius:14px;box-shadow:0 10px 28px rgba(0,0,0,.28);padding:12px;display:flex;gap:12px;align-items:center;opacity:0;transform:translateY(8px);transition:opacity .2s,transform .2s}\n      .bp-banner-card.show{opacity:1;transform:none}\n      .bp-banner-card .msg{flex:1}.bp-banner-card .row{display:flex;gap:8px;align-items:center}\n      .bp-banner-card .ghost{background:rgba(0,0,0,.06);border:1px solid rgba(0,0,0,.12)}\n      @media (prefers-color-scheme: dark){ .bp-banner-card{background:rgba(15,18,28,.96);color:#fff;border-color:rgba(255,255,255,.16)}\n        .bp-banner-card .ghost{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.18)}}\n    ",v=document.createElement("style");v.id="bp-banner-css",v.textContent=u,document.head.appendChild(v)}function H(){let u=document.getElementById("bp_banner_host");return u||(u=document.createElement("div"),u.id="bp_banner_host",document.body.appendChild(u)),u}let nt=[],j=!1;function K(u){nt.push(u),rt()}function rt(){if(j)return;const u=nt.shift();if(!u)return;j=!0,$();const v=H();v.innerHTML="";const y=u(C);v.appendChild(y),requestAnimationFrame(()=>y.classList.add("show"));function C(){v.innerHTML="",j=!1,setTimeout(rt,40)}}async function Y(u,v){if(!u)return;const y=await T("/api/clients"),x=(y&&y.clients||[]).find(I=>String(I.name||"").trim().toLowerCase()===String(u).trim().toLowerCase());x&&await D("/api/clients",{id:x.id,status:v})}async function Q(u){try{if(!u)return null;const v=await T("/api/clients"),y=v&&v.clients||[],C=String(u||"").trim().toLowerCase(),x=y.find(I=>String(I.name||"").trim().toLowerCase()===C);return x?x.id:null}catch(v){return null}}function it(u){if(u)try{if(typeof window.openPaymentBuilderById=="function"){window.openPaymentBuilderById(u);return}if(typeof window.gotoGIAndOpenBuilder=="function"){window.gotoGIAndOpenBuilder(u);return}if(document.querySelector("#gi_rows")){document.dispatchEvent(new CustomEvent("gi:edit",{detail:{id:u}}));return}if(typeof window.viewGI=="function"){try{window.viewGI()}catch(y){}let v=0;(function y(){if(document.getElementById("gi_rows")||v>40){try{document.dispatchEvent(new CustomEvent("gi:edit",{detail:{id:u}}))}catch(x){}return}v++,setTimeout(y,100)})();return}document.dispatchEvent(new CustomEvent("gi:edit",{detail:{id:u}}))}catch(v){}}function tt(u,v){const y=Number(u.vss||u.vsdPersonal||0)||0,C=u.client||"Cliente",x='\n      <div class="card" style="min-width:min(380px,96vw);max-width:480px">\n        <div style="display:flex;justify-content:space-between;align-items:center">\n          <b>VSS per '.concat(R(C),'</b>\n          <button class="ghost" id="vss_x">Chiudi</button>\n        </div>\n        <div class="row" style="margin-top:8px;gap:8px;align-items:flex-end;flex-wrap:wrap">\n          <div style="min-width:200px">\n            <label>Valore VSS</label>\n            <input id="vss_val" type="number" step="1" value="').concat(y,'">\n          </div>\n          <div class="muted small">Modifica consentita solo per VSS</div>\n        </div>\n        <div class="right" style="margin-top:12px">\n          <button id="vss_ok">Salva</button>\n        </div>\n      </div>');if(typeof window.showOverlay=="function"&&typeof window.hideOverlay=="function"){showOverlay(x);const B=document.getElementById("bp-overlay-panel")||document.body,L=A=>B.querySelector(A),w=()=>{try{hideOverlay()}catch(A){}};L("#vss_x").onclick=w,L("#vss_ok").onclick=async()=>{try{const A=Math.max(0,Number(L("#vss_val").value||0));if(await D("/api/appointments",{id:u.id,vss:A}),e("medium"),E("Appuntamento aggiornato"),w(),A>0)try{const V=await J(u,A);if(V&&(V.id||V._id)){const U=V.id||V._id;it(U)}}catch(V){logger.error(V)}v&&v.onSaved}catch(A){logger.error(A),E("Errore salvataggio VSS")}};return}const I=document.createElement("div");I.className="modal",I.innerHTML=x,document.body.appendChild(I);const M=()=>{try{I.remove()}catch(B){}};I.querySelector("#vss_x").onclick=M,I.querySelector("#vss_ok").onclick=async()=>{try{const B=Math.max(0,Number(I.querySelector("#vss_val").value||0));if(await D("/api/appointments",{id:u.id,vss:B}),e("medium"),E("Appuntamento aggiornato"),M(),B>0)try{const L=await J(u,B);if(L&&(L.id||L._id)){const w=L.id||L._id;it(w)}}catch(L){logger.error(L)}v&&v.onSaved}catch(B){logger.error(B),E("Errore salvataggio VSS")}}}async function J(u,v){let y=u.clientId||null;y||(y=await Q(u.client));const C={apptId:u.id,date:new Date(u.end||u.start||Date.now()).toISOString(),clientId:y||void 0,clientName:u.client||"Cliente",vssTotal:Math.round(Number(v||0)),services:u.services||u.note||"",consultantId:u.userId||u.ownerId||null},x=await D("/api/gi",C);return x&&(x.sale||x.gi||x.data)||x}async function W(u,v,y){try{await D("/api/appointments",{id:u,[v===o?"nncfPromptAnswered":"salePromptAnswered"]:!0}),P("Marked banner as answered",u,v,y)}catch(C){P("Error marking banner as answered",C)}}async function ut(u,v,y=24){try{const C=new Date;C.setHours(C.getHours()+y),await D("/api/appointments",{id:u,[v===o?"nncfPromptSnoozedUntil":"salePromptSnoozedUntil"]:C.toISOString()}),P("Snoozed banner",u,v,"until",C.toISOString())}catch(C){P("Error snoozing banner",C)}}function st(u,v){const C=u[v===o?"nncfPromptSnoozedUntil":"salePromptSnoozedUntil"];return C?new Date(C).getTime()>Date.now():!1}function ht(u,v){return!!u[v===o?"nncfPromptAnswered":"salePromptAnswered"]}function b(u){return function(v){const y=document.createElement("div");y.className="bp-banner-card",y.setAttribute("role","alertdialog"),y.setAttribute("aria-live","assertive");const C=new Date(u.end||u.start||Date.now()).toLocaleString("it-IT",{dateStyle:"short",timeStyle:"short"});return y.innerHTML='<div class="msg"><b>Allora, hai venduto a '.concat(R(u.client||"Cliente"),'?</b>\n           <div class="small muted">Appuntamento del ').concat(R(C),'</div></div>\n         <div class="row">\n           <button class="ghost" data-act="later">Posticipa</button>\n           <button class="ghost" data-act="no">No</button>\n           <button data-act="yes">Sì</button>\n         </div>'),y.querySelector('[data-act="yes"]').onclick=async function(){p(u.id,s),O(u.id,s),v(),await W(u.id,s,"yes"),tt(u)},y.querySelector('[data-act="no"]').onclick=async function(){p(u.id,s),O(u.id,s),v(),await W(u.id,s,"no");try{await D("/api/appointments",{id:u.id,vss:0}),E("Registrato: nessuna vendita")}catch(x){}},y.querySelector('[data-act="later"]').onclick=async function(){d(u.id,s),O(u.id,s),await ut(u.id,s,24),E("Te lo ripropongo domani"),v()},y}}function h(u){return function(v){const y=document.createElement("div");y.className="bp-banner-card",y.setAttribute("role","alertdialog"),y.setAttribute("aria-live","assertive");const C=new Date(u.end||u.start||Date.now()).toLocaleString("it-IT",{dateStyle:"short",timeStyle:"short"});return y.innerHTML='<div class="msg"><b>È diventato cliente?</b> '.concat(R(u.client||""),'\n           <div class="small muted">Appuntamento del ').concat(R(C),'</div></div>\n         <div class="row">\n           <button class="ghost" data-act="later">Posticipa</button>\n           <button class="ghost" data-act="no">No</button>\n           <button data-act="yes">Sì</button>\n         </div>'),y.querySelector('[data-act="yes"]').onclick=async function(){p(u.id,o),O(u.id,o),v(),await W(u.id,o,"yes");try{await Y(u.client,"attivo")}catch(x){}tt(u)},y.querySelector('[data-act="no"]').onclick=async function(){p(u.id,o),O(u.id,o),v(),await W(u.id,o,"no");try{await Y(u.client,"lead non chiuso"),await D("/api/appointments",{id:u.id,vss:0}),E("Aggiornato: Lead non chiuso, VSS=0")}catch(x){}},y.querySelector('[data-act="later"]').onclick=async function(){d(u.id,o),O(u.id,o),await ut(u.id,o,24),E("Te lo ripropongo domani"),v()},y}}async function g(){try{const u=await T("/api/appointments"),v=Date.now(),y=v-i*24*60*60*1e3,C=u&&u.appointments||[];C.sort((x,I)=>+new Date(I.end||I.start||0)-+new Date(x.end||x.start||0)),C.forEach(x=>{try{const I=+new Date(x.end||x.start||0);if(!I||I>v||I<y)return;const M=a*60*1e3;if(I>v-M||!(String(x.type||"").toLowerCase()==="vendita"))return;if(x.nncf){if(ht(x,o)||st(x,o))return;if(f(x.id,o)||c(x.id,o)||S(x.id,o)){P("skip pending NNCF",x&&x.id);return}N(o,x),k(x.id,o),P("mark pending NNCF",x&&x.id),K(h(x))}else{if(ht(x,s)||st(x,s))return;if(f(x.id,s)||c(x.id,s)||S(x.id,s)){P("skip pending SALE",x&&x.id);return}N(s,x),k(x.id,s),P("mark pending SALE",x&&x.id),K(b(x))}}catch(I){}})}catch(u){}}window.scanBanners=g,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",g,{once:!0}):g();try{document.addEventListener("appt:saved",function(){setTimeout(g,50)})}catch(u){}try{document.addEventListener("visibilitychange",function(){document.hidden||setTimeout(g,50)})}catch(u){}try{setInterval(function(){g()},60*1e3)}catch(u){}}typeof n<"u"&&(n.initPostSaleBanners=t)})(typeof window<"u"?window:void 0);const Ft=window.BP&&BP.Haptics&&BP.Haptics.impact?BP.Haptics.impact:()=>{};(function(){window.bpAuthToken||(window.bpAuthToken=function(){try{const h=localStorage.getItem("bp_user")||sessionStorage.getItem("bp_user");if(h)try{const g=JSON.parse(h);if(g&&(g.token||g.jwt||g.accessToken))return g.token||g.jwt||g.accessToken}catch(g){}}catch(h){}const b=["bp_token","authToken","token","jwt","accessToken","id_token","auth","authorization","session","user"];for(const h of b)try{const g=localStorage.getItem(h)||sessionStorage.getItem(h);if(!g)continue;try{const u=JSON.parse(g);if(u&&(u.token||u.jwt||u.accessToken))return u.token||u.jwt||u.accessToken}catch(u){}if(/^[A-Za-z0-9\-_]+\.[A-Za-z0-9\-_]+\.[A-Za-z0-9\-_]+$/.test(g))return g}catch(g){}try{for(let h=0;h<localStorage.length;h++){const g=localStorage.key(h),u=localStorage.getItem(g);if(u){try{const v=JSON.parse(u);if(v&&(v.token||v.jwt||v.accessToken))return v.token||v.jwt||v.accessToken}catch(v){}if(/^[A-Za-z0-9\-_]+\.[A-Za-z0-9\-_]+\.[A-Za-z0-9\-_]+$/.test(u))return u}}}catch(h){}try{const h=JSON.parse(localStorage.getItem("user")||"{}");if(h&&(h.token||h.jwt||h.accessToken))return h.token||h.jwt||h.accessToken}catch(h){}return null}),window.GET||(window.GET=async function(b){const h=window.bpAuthToken&&window.bpAuthToken()||null,g=await fetch(b,{headers:{Accept:"application/json",...h?{Authorization:"Bearer "+h}:{}}});return g.status===204?null:(g.headers.get("content-type")||"").includes("application/json")?g.json():{ok:g.ok,status:g.status,text:await g.text()}}),window.POST||(window.POST=async function(b,h){const g=window.bpAuthToken&&window.bpAuthToken()||null,u=await fetch(b,{method:"POST",headers:{"Content-Type":"application/json",...g?{Authorization:"Bearer "+g}:{}},body:JSON.stringify(h||{})});return u.status===204?null:(u.headers.get("content-type")||"").includes("application/json")?u.json():{ok:u.ok,status:u.status,text:await u.text()}}),typeof window<"u"&&typeof window.initPostSaleBanners=="function"&&window.initPostSaleBanners(Ft),(function(){if(document.getElementById("bp-qvss-css"))return;const h=document.createElement("style");h.id="bp-qvss-css",h.textContent='\n    #bp_overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);\n      display:flex;align-items:center;justify-content:center;z-index:9999;padding:16px}\n    .bp-modal{max-width:560px;width:clamp(300px,90vw,560px);background:var(--card,#fff);\n      color:var(--text,#111);border-radius:14px;border:1px solid rgba(0,0,0,.12);\n      box-shadow:0 12px 34px rgba(0,0,0,.35)}\n    .bp-modal .hd{display:flex;align-items:center;justify-content:space-between;padding:12px 14px}\n    .bp-modal .bd{padding:10px 14px 14px}\n    .bp-modal .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}\n    .bp-modal .right{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}\n    .bp-modal input[type="number"], .bp-modal input[type="date"], .bp-modal select, .bp-modal textarea{\n      width:100%;padding:8px;border:1px solid rgba(0,0,0,.18);border-radius:10px}\n    @media (prefers-color-scheme:dark){\n      .bp-modal{background:rgba(15,18,28,.98);color:#fff;border-color:rgba(255,255,255,.14)}\n      .bp-modal input, .bp-modal select, .bp-modal textarea{background:rgba(255,255,255,.04);color:#fff;border-color:rgba(255,255,255,.18)}\n    }\n  ',document.head.appendChild(h)})();function n(b){return String(b||"").replace(/[&<>'"]/g,h=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[h])}function t(b){if(window.showOverlay)window.showOverlay(b);else{const h=document.createElement("div");h.id="bp_overlay",h.innerHTML=b,document.body.appendChild(h)}}function e(){if(window.hideOverlay)window.hideOverlay();else{const b=document.getElementById("bp_overlay");b&&b.remove()}}async function i(b){try{const h=await F("/api/clients"),g=h&&h.clients||[],u=String(b||"").trim().toLowerCase(),v=g.find(y=>String(y.name||"").trim().toLowerCase()===u);return v?v.id:null}catch(h){return null}}async function o(b,h){if(!(Number(h)>0))return null;const g=new Date(b.end||b.start||Date.now()).toISOString();let u=b.clientId||null;u||(u=await i(b.client));const v={date:g,vssTotal:Number(h)||0,services:b.services||"",consultantId:b.userId||(JSON.parse(localStorage.getItem("user")||"{}")||{}).id,clientId:u||void 0,clientName:b.client||void 0},y=await X("/api/gi",v);return y&&(y.id||y.sale&&y.sale.id)||null}async function s(b){if(typeof viewGI=="function"&&document.querySelector("#gi_rows")){document.dispatchEvent(new CustomEvent("gi:edit",{detail:{id:b}}));return}if(typeof viewGI=="function"){try{viewGI()}catch(h){}setTimeout(()=>document.dispatchEvent(new CustomEvent("gi:edit",{detail:{id:b}})),350);return}try{let y=function(C){const x=v("pb_rates");if(!C||!C.length){x.textContent="Nessuna rata",x._data=[];return}x.innerHTML=C.map(I=>{const M=new Date(I.dueDate).toLocaleDateString("it-IT");return"<div>".concat(M," · ").concat(Number(I.amount||0).toLocaleString("it-IT"),'€ <span class="muted">').concat(n(I.note||""),"</span></div>")}).join(""),x._data=C};const h=await F("/api/gi?from=1900-01-01&to=2999-12-31"),g=(h&&h.sales||[]).find(C=>String(C.id)===String(b));if(!g){k("Vendita non trovata");return}const u=new Date().toISOString().slice(0,10);t('<div class="bp-modal"><div class="hd"><b>Builder pagamenti – '+n(g.clientName||"Cliente")+'</b><button class="ghost" id="pb_x">Chiudi</button></div><div class="bd"><div class="row"><div style="flex:1"><label>Totale VSS</label><input id="pb_vss" type="number" value="'+Number(g.vssTotal||0)+'"></div></div><div class="row" style="margin-top:8px;gap:12px"><div><label>Regola rapida</label><select id="pb_rule"><option value="0">Manuale</option><option value="50-25-25">50% + 25% / 30-60gg</option><option value="20+12">20% + 12 rate mensili</option></select></div><div><label>Prima scadenza</label><input id="pb_first" type="date" value="'+u+'"></div></div><div style="margin-top:8px"><label>Rate</label><div id="pb_rates" class="small muted">Nessuna rata</div></div><div class="right"><button class="ghost" id="pb_apply">Ricalcola</button><button id="pb_save">Salva</button></div></div></div>');const v=C=>document.getElementById(C);v("pb_apply").onclick=function(){const C=v("pb_rule").value||"0",x=Math.max(0,Number(v("pb_vss").value||0)),I=new Date(v("pb_first").value||new Date),M=[],B=(L,w,A)=>M.push({dueDate:new Date(L).toISOString(),amount:Math.round(w),note:A||""});if(C==="50-25-25"){B(I,x*.5,"Acconto 50%");const L=new Date(I);L.setDate(L.getDate()+30),B(L,x*.25,"Saldo 25% a 30gg");const w=new Date(I);w.setDate(w.getDate()+60),B(w,x*.25,"Saldo 25% a 60gg")}else if(C==="20+12"){B(I,x*.2,"Acconto 20%");const L=x*.8,w=12,A=L/w;for(let V=0;V<w;V++){const U=new Date(I);U.setMonth(U.getMonth()+V+1),B(U,A,"Rata "+(V+1)+"/"+w)}}y(M)},v("pb_save").onclick=async function(){const C=Math.max(0,Number(v("pb_vss").value||0)),x=v("pb_rates")._data||[];try{await X("/api/gi",{id:g.id,vssTotal:C,schedule:x});try{document.dispatchEvent(new CustomEvent("payments:defined",{detail:{id:g.id,vssTotal:C,schedule:x}}))}catch(I){}k("Piano pagamenti salvato"),e()}catch(I){logger.error(I),k("Errore salvataggio")}},v("pb_x").onclick=e}catch(h){logger.error(h)}}function a(b){const h=b.client||"Cliente",g=Number(b.vss||b.vsdPersonal||0)||0;t('<div class="bp-modal"><div class="hd"><b>VSS per '+n(h)+'</b><button class="ghost" id="qvss_x">Chiudi</button></div><div class="bd"><div><label>Valore VSS</label><input id="qvss_val" type="number" step="1" value="'+g+'"></div><div class="small muted" style="margin-top:6px">Modifica consentita solo per VSS</div><div class="right"><button id="qvss_ok">Salva</button></div></div></div>'),document.getElementById("qvss_x").onclick=e,document.getElementById("qvss_ok").onclick=async function(){try{const u=Math.max(0,Number(document.getElementById("qvss_val").value||0));await X("/api/appointments",{id:b.id,vss:u});const v=await o(b,u);e(),k("VSS salvato"),v&&s(v);try{v&&document.dispatchEvent(new CustomEvent("gi:created",{detail:{id:v}}))}catch(y){}document.dispatchEvent(new Event("bp:saved"))}catch(u){logger.error(u),k("Errore salvataggio VSS")}}}async function r(b){try{b.nncf&&(await(async function(){try{const g=await F("/api/clients"),u=g&&g.clients||[],v=String(b.client||"").trim().toLowerCase(),y=u.find(C=>String(C.name||"").trim().toLowerCase()===v);y&&await X("/api/clients",{id:y.id,status:"attivo"})}catch(g){}})(),document.dispatchEvent(new Event("client:converted"))),a(b)}catch(h){logger.error(h)}}async function l(b){try{if(b.nncf)try{const h=await F("/api/clients"),g=h&&h.clients||[],u=String(b.client||"").trim().toLowerCase(),v=g.find(y=>String(y.name||"").trim().toLowerCase()===u);v&&await X("/api/clients",{id:v.id,status:"lead non chiuso"})}catch(h){}await X("/api/appointments",{id:b.id,vss:0}),k("Ok, segnato come non venduto")}catch(h){logger.error(h),k("Errore aggiornamento")}}window.pipelineYes=r,window.pipelineNo=l,(function(){function b(){if(document.getElementById("bp-center-css"))return;const M="\n      #bp_overlay{display:flex;align-items:center;justify-content:center}\n      .bp-modal-card{min-width:min(480px,90vw);max-width:600px;max-height:86vh;overflow:auto}\n      @media (max-width:640px){ .bp-modal-card{min-width:90vw} }\n      .bp-modal-foot{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}\n    ",B=document.createElement("style");B.id="bp-center-css",B.textContent=M,document.head.appendChild(B)}function h(M){try{document.documentElement.style.overflow=M?"hidden":""}catch(B){}}async function g(M){if(!M)return null;try{const B=await F("/api/clients"),L=B&&B.clients||[],w=String(M).trim().toLowerCase(),A=L.find(V=>String(V.name||"").trim().toLowerCase()===w);return A?A.id:null}catch(B){return null}}async function u(M,B){const L=await g(M);if(L)try{await X("/api/clients",{id:L,status:B})}catch(w){}}async function v(M,B){return X("/api/appointments",{id:M,vss:Math.max(0,Number(B||0))})}async function y(M,B){const L=await g(M.client||""),w={date:new Date(M.end||M.start||Date.now()).toISOString(),clientId:L||void 0,clientName:M.client||"",vssTotal:Math.max(0,Number(B||0)),services:M.services||"",schedule:[]},A=await X("/api/gi",w);return A&&(A.id||A.sale&&A.sale.id||Array.isArray(A.sales)&&A.sales[0]&&A.sales[0].id)||null}async function C(M){if(!M)return;try{typeof window.viewGI=="function"&&window.viewGI()}catch(L){}let B=0;(function L(){if(document.getElementById("gi_rows")||B>40){try{const A=new CustomEvent("gi:edit",{detail:{id:M}});document.dispatchEvent(A)}catch(A){}return}B++,setTimeout(L,100)})()}function x(M,B){b(),h(!0);const L=Math.max(0,Number(M.vss||0)),w='<div class="modal"><div class="card bp-modal-card"><div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><b>VSS per '+(M.client?I(M.client):"appuntamento")+'</b><button class="ghost" id="qvss_x">Chiudi</button></div><div style="margin-top:8px"><label>Valore VSS</label><input id="qvss_val" type="number" step="1" value="'+L+'"><div class="small muted" style="margin-top:6px">Modifica consentita solo per VSS</div></div><div class="bp-modal-foot"><button id="qvss_ok">Salva</button></div></div></div>';showOverlay(w);function A(){h(!1),hideOverlay()}const V=document.getElementById("qvss_val");document.getElementById("qvss_x").onclick=A,document.getElementById("qvss_ok").onclick=async function(){try{const U=Math.max(0,Number(V.value||0));await v(M.id,U);const G=await y(M,U);if(A(),G)try{document.dispatchEvent(new CustomEvent("gi:created",{detail:{id:G}}))}catch(ct){}C(G)}catch(U){logger.error(U),k("Errore salvataggio VSS")}}}function I(M){return String(M||"").replace(/[&<>'"]/g,B=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[B])}window.pipelineYes=async function(M){try{M.nncf&&await u(M.client,"cliente"),x(M)}catch(B){logger.error(B)}},window.pipelineNo=async function(M){try{M.nncf&&await u(M.client,"lead non chiuso"),await v(M.id,0),Ft("light"),k("Segnato VSS 0")}catch(B){logger.error(B)}}})(),(function(){function b(C){return encodeURIComponent(String(C||""))}function h(){try{const B=document.getElementById("rep_label");if(B&&B.textContent)return B.textContent.trim()}catch(B){}const C=(document.getElementById("rep_type")||{}).value||"mensile",x=new Date,I=String(x.getMonth()+1).padStart(2,"0"),M=x.getFullYear();return C==="settimanale"?"Settimana ISO "+(isoWeekNum?isoWeekNum(x):"corrente")+" "+M:C==="trimestrale"?"Q"+(Math.floor(x.getMonth()/3)+1)+" "+M:C==="semestrale"?"Semestre "+(x.getMonth()<6?"1°":"2°")+" "+M:C==="annuale"?"Anno "+M:"Mese "+I+"/"+M}async function g(){try{const C=await F("/api/usernames");return(C&&C.users||[]).map(I=>I.email).filter(Boolean).join(",")}catch(C){return""}}function u(){const C=document.getElementById("report_subject");return C&&C.value&&C.value.trim()?C.value.trim():"Report BP – "+h()}function v(){const C=document.getElementById("report_body");return C&&C.value&&C.value.trim()?C.value:"Ciao,\n\ndi seguito il report del periodo "+h()+".\n\n– VSS\n– VSD\n– GI\n– NNCF\n\nA presto."}async function y(){const C=document.getElementById("rep_gmail_web"),x=document.getElementById("rep_gmail_app");if(!C&&!x)return;const I=await g(),M=u(),B=v();try{await navigator.clipboard.writeText(B)}catch(L){}C&&(C.onclick=function(){const L="https://mail.google.com/mail/?view=cm&fs=1&tf=1&su="+b(M)+"&cc="+b(I)+"&body="+b(B);window.open(L,"_blank");try{document.dispatchEvent(new Event("report:composed"))}catch(w){}}),x&&(x.onclick=function(){const L="googlegmail:///co?subject="+b(M)+"&cc="+b(I)+"&body="+b(B);location.href=L;try{document.dispatchEvent(new Event("report:composed"))}catch(w){}setTimeout(function(){if(!document.hidden){location.href="mailto:?subject="+b(M)+"&cc="+b(I)+"&body="+b(B);try{document.dispatchEvent(new Event("report:composed"))}catch(w){}}},1200)})}window.wireReportButtons=y})(),(function(){function b(x){var I=x instanceof Date?x:new Date(x||Date.now()),M=I.getFullYear(),B=("0"+(I.getMonth()+1)).slice(-2),L=("0"+I.getDate()).slice(-2);return M+"-"+B+"-"+L}function h(x){for(var I=window.BPTimezone&&window.BPTimezone.ymdUTC?window.BPTimezone.ymdUTC(new Date):b(new Date),M=x.querySelectorAll("[data-date], [data-day]"),B=0;B<M.length;B++){var L=M[B],w=L.getAttribute("data-date")||L.getAttribute("data-day")||"";if(w){var A=String(w).slice(0,10);A===I&&L.classList.add("today")}}}function g(x){if(typeof window.attachICSButtons=="function"){try{window.attachICSButtons(x)}catch(U){logger.error(U)}return}for(var I=x.querySelectorAll("[data-appt], [data-start][data-title], .appt, .calendar-appt"),M=0;M<I.length;M++){var B=I[M];if(!B.querySelector(".bp-ics")){var L=B.getAttribute("data-start")||"",w=B.getAttribute("data-end")||"",A=B.getAttribute("data-title")||B.getAttribute("data-client")||"Appuntamento";if(L){var V=document.createElement("a");V.href="#",V.className="bp-ics btn-ics",V.textContent="📅",V.style.marginLeft="6px",V.onclick=function(U){U.preventDefault();try{var G=U.currentTarget.parentElement||document.body,ct=G.getAttribute("data-start")||L,_t=G.getAttribute("data-end")||w||ct,wt=G.getAttribute("data-title")||G.getAttribute("data-client")||A,yt=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//BP//Calendar//IT","BEGIN:VEVENT","UID:"+Date.now()+"@bp","DTSTAMP:"+new Date().toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z"),"DTSTART:"+new Date(ct).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z"),"DTEND:"+new Date(_t).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z"),"SUMMARY:"+wt,"END:VEVENT","END:VCALENDAR"].join("\r\n"),at=new Blob([yt],{type:"text/calendar"}),dt=URL.createObjectURL(at),z=document.createElement("a");z.href=dt,z.download=(wt||"appuntamento")+".ics",document.body.appendChild(z),z.click(),setTimeout(function(){URL.revokeObjectURL(dt);try{z.remove()}catch(ot){}},0)}catch(ot){logger.error(ot)}},B.appendChild(V)}}}}function u(){var x=document.getElementById("calendar")||document.querySelector(".calendar")||document;h(x),g(x)}window.hookCalendar=u;function v(x){if(document.readyState==="complete"||document.readyState==="interactive")return x();document.addEventListener("DOMContentLoaded",x,{once:!0})}v(u);var y=document.getElementById("calendar")||document.querySelector(".calendar");if(y&&!y.__bpCalObs){y.__bpCalObs=!0;var C=new MutationObserver(function(){try{u()}catch(x){}});C.observe(y,{childList:!0,subtree:!0})}})(),(function(){var b=!1;function h(){if(!b){b=!0;var g='.today{outline:2px solid var(--accent, #5dd3ff); outline-offset:-2px; border-radius:8px; position:relative;}.today::after{content:"OGGI"; position:absolute; top:6px; right:8px; font-size:10px; font-weight:700; color:#fff; background:var(--accent, #5dd3ff); padding:2px 6px; border-radius:6px;}',u=document.createElement("style");u.setAttribute("data-bp-today","1"),u.textContent=g,document.head.appendChild(u)}}window.injectTodayCSS=h,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",h,{once:!0}):h()})(),(function(){function b(){try{return JSON.parse(localStorage.getItem("user")||"{}")}catch(M){return{}}}function h(){var M=b();return M&&M.role==="admin"}function g(M,B){return(B||document).querySelector(M)}function u(M,B){return Array.prototype.slice.call((B||document).querySelectorAll(M))}function v(M){var B=new Date(M);return!B||isNaN(B)?"—":("0"+B.getDate()).slice(-2)+"/"+("0"+(B.getMonth()+1)).slice(-2)+"/"+B.getFullYear()}async function y(){try{for(var M=await F("/api/appointments"),B=M&&M.appointments||[],L={},w=0;w<B.length;w++){var A=B[w],V=String(A.client||"").trim().toLowerCase();if(V){var U=new Date(A.start||A.end||0).getTime();(!L[V]||U>L[V])&&(L[V]=U)}}return L}catch(G){return logger.error(G),{}}}async function C(){var M=document.getElementById("cl_list");if(M){var B=await y();u(".card",M).forEach(function(L){var w=g("b",L);if(w){var A=(w.textContent||"").trim().toLowerCase();if(A){var V=B[A],U=g(".bp-lastapp",L),G="Ultimo appuntamento: "+(V?v(V):"—");if(U)U.textContent=G;else{var ct=document.createElement("div");ct.className="small muted bp-lastapp",ct.textContent=G,L.appendChild(ct)}}}})}}async function x(){if(!h())return;var M=document.getElementById("cl_list");if(!M)return;var[B,L]=await Promise.all([F("/api/clients"),F("/api/usernames")]),w=B&&B.clients||[],A=L&&L.users||[];function V(U){var G=g("b",U),ct=(G&&G.textContent||"").trim().toLowerCase();return w.find(function(_t){return String(_t.name||"").trim().toLowerCase()===ct})}M.__bpInlineReady||(M.__bpInlineReady=!0,u(".card",M).forEach(function(U){if(!U.__bpInline){U.__bpInline=!0;var G=V(U);if(G){var ct=document.createElement("div");ct.style.display="flex",ct.style.gap="8px",ct.style.marginTop="6px";var _t=document.createElement("button");_t.className="ghost",_t.textContent="Modifica",ct.appendChild(_t),U.appendChild(ct);var wt=document.createElement("div");wt.style.display="none",wt.style.marginTop="8px",wt.innerHTML='<div class="row" style="gap:8px"><div><label>Nome</label><input class="bp-ed-name" type="text" value="'+(G.name||"")+'"></div><div><label>Stato</label><select class="bp-ed-state"><option value="prospect" '+(G.status==="prospect"?"selected":"")+'>Prospect</option><option value="attivo" '+(G.status==="attivo"?"selected":"")+'>Attivo</option><option value="cliente" '+(G.status==="cliente"?"selected":"")+'>Cliente</option></select></div><div><label>Consulente</label><select class="bp-ed-consulente"></select></div><div style="align-self:flex-end"><button class="ghost bp-ed-save">Salva</button></div></div>',U.appendChild(wt);var yt=g(".bp-ed-consulente",wt);yt.innerHTML='<option value="">—</option>'+A.map(function(at){return'<option value="'+at.id+'" '+(String(G.consultantId||"")===String(at.id)?"selected":"")+">"+(at.name||"User "+at.id)+"</option>"}).join(""),_t.onclick=function(){wt.style.display=wt.style.display==="none"?"block":"none"},g(".bp-ed-save",wt).onclick=async function(at){at.preventDefault();try{var dt={id:G.id,name:g(".bp-ed-name",wt).value.trim(),status:g(".bp-ed-state",wt).value,consultantId:g(".bp-ed-consulente",wt).value||null};await X("/api/clients",dt);var z=g("b",U);z&&(z.textContent=dt.name);var ot=g(".small",U);ot&&/Stato:/.test(ot.textContent||"")&&(ot.innerHTML="Stato: <b>"+dt.status+"</b>");var ft=u(".small",U).find(function(bt){return/Consulente:/.test(bt.textContent||"")});if(ft){var lt=A.find(function(bt){return String(bt.id)===String(dt.consultantId||"")});ft.innerHTML="Consulente: <b>"+(lt?lt.name||"User "+lt.id:"—")+"</b>"}Ft("medium")}catch(bt){logger.error(bt),Ft("heavy")}}}}}))}window.applyClientsLastAppointment=C,window.ensureClientInlineEdit=x;function I(){var M=document.getElementById("cl_list");if(M&&(C(),x(),!M.__bpCliObs)){M.__bpCliObs=!0;var B=new MutationObserver(function(){C(),x()});B.observe(M,{childList:!0,subtree:!0})}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",I,{once:!0}):I()})();function c(b){const h=["#".concat(b,"_mode"),"#dash_mode","#comm_mode",'[data-scope="'.concat(b,'"] [name="mode"]'),"#".concat(b,' select[name="mode"]'),'#dashboard select[name="mode"]','select[name="mode"]'];for(const g of h){const u=document.querySelector(g);if(u&&u.value)return u.value}return"consuntivo"}if(window.__BP_FINAL_READY__)return;window.__BP_FINAL_READY__=!0;const d=(b,h)=>(h||document).querySelector(b),f=(b,h,g)=>b&&b.addEventListener(h,g,!1),p=b=>document.readyState!=="loading"?b():document.addEventListener("DOMContentLoaded",b),m=(b,h)=>{try{return JSON.parse(b)}catch(g){return h}},_=b=>b<10?"0"+b:""+b,S=()=>{const b=new Date;return"".concat(b.getFullYear(),"-").concat(_(b.getMonth()+1),"-").concat(_(b.getDate()))};function k(b){try{(window.showToast?window.showToast:alert)(b)}catch(h){alert(b)}}function O(){const b=g=>{if(!g)return null;g=String(g).replace(/^"+|"+$/g,"");try{const u=JSON.parse(g);if(u&&(u.token||u.jwt||u.accessToken))return u.token||u.jwt||u.accessToken}catch(u){}return/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+$/.test(g)?g:null};for(let g=0;g<localStorage.length;g++){const u=b(localStorage.getItem(localStorage.key(g)));if(u)return u}const h=["token","authToken","jwt","bp_token","accessToken","id_token","auth","authorization","bp.jwt","_token","session","user"];for(const g of h){const u=b(localStorage.getItem(g)||sessionStorage.getItem(g));if(u)return u}try{const g=m(localStorage.getItem("user")||"{}",{});if(g&&(g.token||g.jwt||g.accessToken))return g.token||g.jwt||g.accessToken}catch(g){}return null}async function F(b,h={}){if(typeof window.GET=="function"&&!h.forceFetch)try{return await window.GET(b)}catch(v){}const g=O(),u=await fetch(b,{headers:{Accept:"application/json",...g?{Authorization:"Bearer "+g}:{}}});return u.status===401&&window.GET?window.GET(b):u.status===204?null:u.json()}async function X(b,h,g={}){if(typeof window.POST=="function"&&!g.forceFetch)try{return await window.POST(b,h)}catch(y){}const u=O(),v=await fetch(b,{method:"POST",headers:{"Content-Type":"application/json",...u?{Authorization:"Bearer "+u}:{}},body:JSON.stringify(h||{})});return!v.ok&&v.status===401&&window.POST?window.POST(b,h):v.status===204?null:v.json()}function et(b,h,g){const u=document.getElementById(b);if(!u)return;const v=u.getContext("2d"),y=window.devicePixelRatio||1,C=Math.max(220,u.clientWidth||320),x=Math.max(80,u.clientHeight||80);u.style.width=C+"px",u.style.height=x+"px",u.width=C*y,u.height=x*y,v.scale(y,y),v.clearRect(0,0,C,x);const I=Array.isArray(g)?g.map(ct=>+ct||0):[];if(!I.length)return;const M=Math.max(...I),B=Math.min(...I),L=M-B===0?(M||1)*.2:(M-B)*.2,w=M+L,A=Math.max(0,B-L),V=I.length>1?(C-8)/(I.length-1):0,U=ct=>4+ct*V,G=ct=>{const _t=(ct-A)/(w-A||1);return x-6-_t*(x-12)};v.lineWidth=2,v.lineJoin=v.lineCap="round",v.strokeStyle="#2e6cff",v.beginPath(),v.moveTo(U(0),G(I[0]));for(let ct=1;ct<I.length;ct++)v.lineTo(U(ct),G(I[ct]));v.stroke(),v.fillStyle="#2e6cff";for(let ct=0;ct<I.length;ct++)v.beginPath(),v.arc(U(ct),G(I[ct]),2,0,Math.PI*2),v.fill()}(function(){const h=function(g,u,v){const y=document.getElementById(g);if(y){if(window.Chart)try{y.__chart&&typeof y.__chart.destroy=="function"&&y.__chart.destroy();const C=typeof window.computeTickOptions=="function"?window.computeTickOptions(u,y.clientWidth||320):void 0,x={type:"line",data:{labels:u,datasets:[{data:v,tension:.35,pointRadius:2,borderWidth:2}]},options:{responsive:!0,plugins:{legend:{display:!1}},scales:{x:Object.assign({display:!0},C?{ticks:C}:{}),y:{display:!0}}}};y.__chart=new Chart(y.getContext("2d"),x);return}catch(C){}et(g,u,v)}};(!window.drawFullLine||!window.drawFullLine.__patched)&&(window.drawFullLine=h,window.drawFullLine.__patched=!0)})();function T(b,h){try{if(typeof window.labelsForBuckets=="function")return window.labelsForBuckets(b,h)}catch(u){}const g=typeof effectivePeriodType=="function"?effectivePeriodType(String(b||"mensile").toLowerCase()):String(b||"mensile").toLowerCase();return(h||[]).map(u=>{const v=new Date(u.s);return g==="settimanale"?"W"+(typeof isoWeekNum=="function"?isoWeekNum(v):"")+" "+v.getUTCFullYear():g==="mensile"?String(v.getUTCMonth()+1).padStart(2,"0")+"/"+v.getUTCFullYear():g==="trimestrale"?"Q"+(Math.floor(v.getUTCMonth()/3)+1)+" "+v.getUTCFullYear():g==="semestrale"?(v.getUTCMonth()<6?"S1 ":"S2 ")+v.getUTCFullYear():String(v.getUTCFullYear())})}const D=typeof window<"u"?window.__periodsCache||(window.__periodsCache={}):{};function E(b){try{const h=new Date(b),g=h.getUTCFullYear(),u=String(h.getUTCMonth()+1).padStart(2,"0"),v=String(h.getUTCDate()).padStart(2,"0");return g+"-"+u+"-"+v}catch(h){return""}}function P(b){try{return typeof effectivePeriodType=="function"?effectivePeriodType(String(b||"mensile").toLowerCase()):String(b||"mensile").toLowerCase()}catch(h){return String(b||"mensile").toLowerCase()}}async function R(b){if(!b){if(Array.isArray(window.periods)&&window.periods.length)return window.periods;try{const I=await F("/api/periods?global=1");if(I&&Array.isArray(I.periods))return window.periods=I.periods,I.periods}catch(I){}return window.periods||[]}let h,g,u,v=null;if(typeof b=="string"){const I=window.readUnifiedRange&&window.readUnifiedRange(b)||{type:"mensile",end:new Date};h=I.type||"mensile";const M=window.buildBuckets?window.buildBuckets(h,I.end):[];if(M&&M.length)g=E(new Date(M[0].s)),u=E(new Date(M[M.length-1].e));else if(I.start&&I.end)g=E(new Date(I.start)),u=E(new Date(I.end));else{const B=new Date;g=E(B),u=E(B)}}else{const I=b||{};h=I.type||"mensile",g=I.from||E(new Date),u=I.to||E(new Date),v=I.userId||null}const y=P(h),C=[y,g,u,v||""].join("|");if(D[C])return D[C];const x=["?global=1","type="+encodeURIComponent(y),"from="+encodeURIComponent(g),"to="+encodeURIComponent(u)].concat(v?["userId="+encodeURIComponent(v)]:[]).join("&").replace("?&","?");try{const I=await F("/api/periods"+x).catch(function(){return F("/api/periods"+x.replace("?global=1","?").replace("??","?"))}),M=I&&Array.isArray(I.periods)?I.periods:[];return D[C]=M,M}catch(I){return[]}}function N(b,h,g){const u=String(h).toLowerCase()==="previsionale"?b.indicatorsPrev||{}:b.indicatorsCons||{},v=Number(u[g]||0);return Number.isFinite(v)?v:0}function $(b,h,g){if(typeof window.drawFullLine=="function")return window.drawFullLine(b,h,g);et(b,h,g)}async function H(){const b=window.readUnifiedRange&&window.readUnifiedRange("dash")||{type:"mensile",end:new Date},h=b.type||"mensile",g=c("dash"),u=window.buildBuckets?window.buildBuckets(h,b.end):[],v=await R("dash"),y=T(h,u);["VSS","VSDPersonale","GI","NNCF"].forEach(C=>{const x=u.map(I=>{let M=0;return v.forEach(B=>{if(B.type!==effectivePeriodType(h))return;const L=new Date(B.startDate).getTime(),w=new Date(B.endDate).getTime();L>=I.s&&w<=I.e&&(M+=N(B,g,C))}),Math.round(M)});$("d_mini_"+C.toLowerCase(),y,x)});try{if(window.BP&&BP.Targets&&typeof BP.Targets.getForPeriod=="function"){const C=JSON.parse(localStorage.getItem("user")||"{}")||{},x=String(C.grade||"junior").toLowerCase()==="senior"?"senior":"junior",I=BP.Targets.getForPeriod(x,effectivePeriodType(h))||{},M=["VSS","VSDPersonale","GI","NNCF"],B={};M.forEach(L=>{let w=0;const A=u[u.length-1];A&&(v.forEach(V=>{if(V.type!==effectivePeriodType(h))return;const U=new Date(V.startDate).getTime(),G=new Date(V.endDate).getTime();U>=A.s&&G<=A.e&&(w+=N(V,g,L))}),B[L]=Math.round(w))}),window.__bpCoachKpiFired=window.__bpCoachKpiFired||{},M.forEach(L=>{const w=Number(I[L]||0);if(w<=0)return;const A=Number(B[L]||0),V=Math.round(A/w*100),U=effectivePeriodType(h)+"_"+L;if(V>=100&&!window.__bpCoachKpiFired[U+"_100"]){window.__bpCoachKpiFired[U+"_100"]=!0;try{document.dispatchEvent(new CustomEvent("kpi:goal-reached",{detail:{key:L,value:A,target:w}}))}catch(G){}}else if(V>=80&&!window.__bpCoachKpiFired[U+"_80"]){window.__bpCoachKpiFired[U+"_80"]=!0;try{document.dispatchEvent(new CustomEvent("kpi:goal-80",{detail:{key:L,value:A,target:w}}))}catch(G){}}})}}catch(C){}}async function nt(){const b="comm",h=window.readUnifiedRange&&(window.readUnifiedRange(b)||window.readUnifiedRange("cm"))||{type:"mensile",end:new Date},g=h.type||"mensile",u=c&&c(b)||c&&c("cm")||"cons",v=window.buildBuckets?window.buildBuckets(g,h.end):[],y=await R("comm"),C=T(g,v),x=v.map(I=>{let M=0;return y.forEach(B=>{if(B.type!==effectivePeriodType(g))return;const L=new Date(B.startDate).getTime(),w=new Date(B.endDate).getTime();L>=I.s&&w<=I.e&&(M+=N(B,u,"VSDPersonale"))}),Math.round(M)});$("cm_mini_vsd",C,x)}async function j(){const b=window.readUnifiedRange&&(window.readUnifiedRange("t")||window.readUnifiedRange("tg"))||{type:"mensile",end:new Date},h=b.type||"mensile",g=c&&c("t")||c&&c("tg")||"cons",u=(d("#tg_user")||{}).value||"",v=(d("#tg_ind")||{}).value||"VSS",y=window.buildBuckets?window.buildBuckets(h,b.end):[];function C(w){try{const A=new Date(w),V=A.getUTCFullYear(),U=String(A.getUTCMonth()+1).padStart(2,"0"),G=String(A.getUTCDate()).padStart(2,"0");return V+"-"+U+"-"+G}catch(A){return""}}const x=y.length?C(new Date(y[0].s)):C(new Date),I=y.length?C(new Date(y[y.length-1].e)):C(new Date),M=await R({type:h,from:x,to:I,userId:u||null}),B=T(h,y),L=y.map(w=>{let A=0;return M.forEach(V=>{if(V.type!==effectivePeriodType(h)||u&&String(V.userId)!==String(u))return;const U=new Date(V.startDate).getTime(),G=new Date(V.endDate).getTime();U>=w.s&&G<=w.e&&(A+=N(V,g,v))}),Math.round(A)});$("tg_chart",B,L)}function K(){f(d("#dash_mode"),"change",()=>{Ft("light"),window.recomputeDashboard&&recomputeDashboard(),window.recomputeDashboardMini&&H()}),f(d("#d_mode"),"change",()=>{Ft("light"),window.recomputeDashboard&&recomputeDashboard(),window.recomputeDashboardMini&&H()}),f(d("#comm_mode"),"change",()=>{Ft("light"),window.recomputeCommsMini&&nt()}),f(d("#cm_mode"),"change",()=>{Ft("light"),window.recomputeCommsMini&&nt()});const b=d("#tg_user");b&&b.options.length<=1&&F("/api/usernames").then(u=>{(u&&u.users||[]).forEach(v=>{var y=document.createElement("option");y.value=v.id,y.textContent=(v.name||"User "+v.id)+(v.grade?" – "+v.grade:""),b.appendChild(y)})}).catch(u=>logger.error(u));const h=()=>{window.recomputeTeamChart&&j(),window.recomputeTeamAggChart&&recomputeTeamAggChart()};f(d("#t_mode"),"change",()=>{Ft("light"),h()}),["#t_y","#t_m","#t_q","#t_from","#t_to"].forEach(u=>{const v=d(u);v&&f(v,"change",h)}),b&&f(b,"change",()=>{Ft("light"),window.recomputeTeamChart&&j()});const g=d("#t_ind");g&&f(g,"change",()=>{Ft("light"),window.recomputeTeamAggChart&&recomputeTeamAggChart()}),d("#tg_chart")&&window.recomputeTeamChart&&j(),d("#t_chart")&&window.recomputeTeamAggChart&&recomputeTeamAggChart()}typeof window.todayKey!="function"&&(window.todayKey=function(){var h=new Date,g=h.getFullYear(),u=("0"+(h.getMonth()+1)).slice(-2),v=("0"+h.getDate()).slice(-2);return g+"-"+u+"-"+v});function rt(){try{var b=S(),h=document.querySelector('.calendar .day[data-day="'+b+'"], .calendar .day[data-date="'+b+'"]');if(!h)for(var g=parseInt(b.slice(8,10),10),u=document.querySelectorAll(".calendar .day"),v=0;v<u.length;v++){var y=u[v],C=parseInt((y.getAttribute("data-day")||y.getAttribute("data-date")||"").slice(8,10)||y.textContent.trim(),10);if(C===g){h=y;break}}h&&h.classList.add("today")}catch(x){}}function Y(){try{for(var b=S(),h=document.querySelectorAll(".calendar .day[data-day], .calendar .day[data-date]"),g=0;g<h.length;g++){var u=h[g],v=(u.getAttribute("data-day")||u.getAttribute("data-date")||"").slice(0,10);v&&v<b&&u.classList.remove("slot-free")}}catch(y){}}function Q(){try{var b=document.getElementById("cal_day_box");if(!b)return;for(var h=b.querySelectorAll(".cal-app"),g=0;g<h.length;g++){var u=h[g];if(!u.querySelector("[data-ics-inline]")){var v=u.getAttribute("data-start")||"",y=u.getAttribute("data-end")||"",C=u.getAttribute("data-title")||(u.querySelector("b")?u.querySelector("b").textContent.trim():"Appuntamento");if(!(!v||!y)&&window.BP&&BP.ICS&&typeof BP.ICS.downloadIcsForAppointment=="function"){var x=document.createElement("button");x.className="ghost btn-ics",x.textContent="📅",x.setAttribute("data-ics-inline","1"),x.style.marginTop="6px",x.addEventListener("click",function(I){I.stopPropagation();var M=I.currentTarget.parentElement,B=M.getAttribute("data-start"),L=M.getAttribute("data-end"),w=M.getAttribute("data-title")||(M.querySelector("b")?M.querySelector("b").textContent.trim():"Appuntamento"),A={client:w,start:B,end:L,type:"manuale",vss:0,vsdPersonal:0,nncf:!1};try{BP.ICS.downloadIcsForAppointment(A),Ft("medium")}catch(V){}}),u.appendChild(x)}}}}catch(I){}}window.markToday=window.markToday||rt,window.clampSlotCounters=window.clampSlotCounters||Y,window.wireICSInsideDayBox=window.wireICSInsideDayBox||Q,(function(){function b(C){return encodeURIComponent(String(C||""))}function h(){return F("/api/users_emails").then(function(C){return C&&Array.isArray(C.emails)?C.emails.filter(Boolean):C&&Array.isArray(C.users)?C.users.map(x=>x.email).filter(Boolean):[]}).catch(function(){return F("/api/usernames").then(function(C){var x=C&&C.users||[];return x.map(I=>I.email).filter(Boolean)}).catch(function(){return[]})})}function g(){var C=document.getElementById("report_subject");return C&&C.value.trim()||"Report BP"}function u(){var C=document.getElementById("report_body");return C&&C.value||""}function v(){var C=document.getElementById("rep_gmail_web"),x=document.getElementById("rep_gmail_app");!C&&!x||h().then(function(I){var M=(I||[]).join(",");function B(){return"https://mail.google.com/mail/?view=cm&fs=1&tf=1&su="+b(g())+"&cc="+b(M)+"&body="+b(u())}function L(){return"googlegmail:///co?subject="+b(g())+"&cc="+b(M)+"&body="+b(u())}C&&(C.onclick=function(){try{navigator.clipboard&&navigator.clipboard.writeText(u())}catch(w){}window.open(B(),"_blank")}),x&&(x.onclick=function(){try{navigator.clipboard&&navigator.clipboard.writeText(u())}catch(w){}location.href=L(),setTimeout(function(){if(!document.hidden){var w="mailto:?subject="+b(g())+"&cc="+b(M)+"&body="+b(u());location.href=w}},1200)})})}var y=window.BPFinal=window.BPFinal||{};y.wireReportButtons=v,window.wireReportButtons||(window.wireReportButtons=v)})(),(function(){let b={ts:0,map:null},h=null;function g(u){const v=Object.create(null);for(const y of u||[]){const C=String(y.client||"").toLowerCase();if(!C)continue;const x=+new Date(y.end||y.start||0);(!v[C]||x>v[C])&&(v[C]=x)}return v}window.BPFinal=window.BPFinal||{},BPFinal.getLastApptMap=function(){const v=Date.now();return b.map&&v-b.ts<15e3?Promise.resolve(b.map):h||(h=F("/api/appointments?global=1").then(y=>g(y&&y.appointments||[])).then(y=>(b={ts:Date.now(),map:y},y)).catch(()=>({})).finally(()=>{h=null}),h)}})();function it(b){var v;if(!b)return;let h=b.querySelector(".bp-appts");if(h&&h.style.display!=="none"){h.remove();return}h||(h=document.createElement("div"),h.className="bp-appts",h.style.marginTop="8px",b.appendChild(h)),h.innerHTML='<div class="muted">Caricamento…</div>',h.style.display="block";const g=b.getAttribute("data-clid")||"",u=(((v=b.querySelector("b"))==null?void 0:v.textContent)||"").trim();F("/api/appointments?global=1").then(y=>{const C=y&&y.appointments||[],x=u.toLowerCase(),I=C.filter(B=>String(B.clientId||"")===g||String(B.client||"").trim().toLowerCase()===x);I.sort((B,L)=>BPTimezone.parseUTCString(L.start)-BPTimezone.parseUTCString(B.start));const M=I.map(B=>{const L=BPTimezone.parseUTCString(B.start),w=("0"+L.getDate()).slice(-2)+"/"+("0"+(L.getMonth()+1)).slice(-2)+"/"+L.getFullYear(),A=[];return Number(B.vss)>0&&A.push("VSS "+Number(B.vss).toLocaleString("it-IT")+"€"),Number(B.vsdPersonal)>0&&A.push("VSD "+Number(B.vsdPersonal).toLocaleString("it-IT")+"€"),Number(B.vsdIndiretto)>0&&A.push("VSD ind "+Number(B.vsdIndiretto).toLocaleString("it-IT")+"€"),Number(B.telefonate)>0&&A.push("Tel "+Number(B.telefonate)),Number(B.appFissati)>0&&A.push("AppFiss "+Number(B.appFissati)),'<div class="small">'.concat(n(B.type||"")," – ").concat(w).concat(A.length?" – "+A.join(" · "):"","</div>")}).join("")||'<div class="muted">Nessun appuntamento</div>';h.innerHTML=M}).catch(y=>{logger.error(y),h.innerHTML='<div class="muted">Errore caricamento appuntamenti</div>'})}BPFinal.showClientAppointments=it,BPFinal.enrichClientCards=function(){const h=document.getElementById("cl_list");h&&BPFinal.getLastApptMap().then(g=>{const u=h.querySelectorAll(".card[data-clid], .card");for(const v of u){const y=v.querySelector("b"),C=(y?y.textContent:v.getAttribute("data-name")||"").trim().toLowerCase(),x=g[C]||0,I=v.querySelector(".last-appt, .client-last");if(I)if(x){const M=new Date(x),B=("0"+M.getDate()).slice(-2),L=("0"+(M.getMonth()+1)).slice(-2),w=M.getFullYear();I.textContent="".concat(B,"/").concat(L,"/").concat(w)}else I.textContent="—";v.setAttribute("data-last-ts",String(x||0)),!v.getAttribute("data-name-lower")&&C&&v.setAttribute("data-name-lower",C),v.__bp_appts||(v.__bp_appts=!0,v.addEventListener("click",M=>{M.target.closest("button,select,input,a")||it(v)}))}})},BPFinal.enableClientsInlineAdmin=function(){const h=document.getElementById("cl_list");if(!h||h.__bp_inline_admin_wired)return;h.__bp_inline_admin_wired=!0;let g=null;function u(){return g?Promise.resolve(g):F("/api/usernames").then(x=>g=x&&x.users||[]).catch(()=>[])}const v=["attivo","lead non chiuso","potenziale"];function y(x){if(!x||x.nodeType!==1||x.querySelector("[data-edit-client]"))return;x.style.position="relative";const I=document.createElement("button");I.className="ghost small",I.textContent="Modifica",I.title="Modifica cliente",I.setAttribute("data-edit-client","1"),I.style.position="absolute",I.style.right="8px",I.style.top="8px",I.style.zIndex="2",I.style.cursor="pointer",x.appendChild(I),I.addEventListener("click",function(){const M=x.getAttribute("data-clid")||x.dataset.clid||"",B=x.querySelector("b"),L=x.querySelector(".cl-status, .client-status"),w=x.querySelector(".cl-cons, .client-owner"),A={name:B?B.textContent.trim():"",status:String(L&&L.textContent||x.getAttribute("data-status")||"potenziale").toLowerCase(),consId:x.getAttribute("data-consultant-id")||"",consText:w?w.textContent:"—"},V=document.createElement("input");V.type="text",V.value=A.name,V.style.width="100%",B&&B.replaceWith(V);const U=document.createElement("select");U.innerHTML=v.map(G=>'<option value="'.concat(G,'">').concat(G.charAt(0).toUpperCase()+G.slice(1),"</option>")).join(""),U.value=v.includes(A.status)?A.status:"potenziale",L&&(L.textContent="",L.appendChild(U)),u().then(G=>{const ct=document.createElement("select");ct.innerHTML='<option value="">—</option>'+G.map(at=>'<option value="'.concat(at.id,'">').concat(at.name||"User "+at.id).concat(at.grade?" ("+at.grade+")":"","</option>")).join(""),A.consId&&(ct.value=String(A.consId)),w&&(w.textContent="",w.appendChild(ct));const _t=document.createElement("div");_t.className="row",_t.style.marginTop="8px";const wt=document.createElement("button");wt.textContent="Salva";const yt=document.createElement("button");yt.textContent="Annulla",yt.className="ghost",_t.appendChild(wt),_t.appendChild(yt),x.appendChild(_t),yt.addEventListener("click",function(){const at=document.createElement("b");at.textContent=A.name,V.replaceWith(at),L&&(L.textContent=A.status),w.textContent=A.consText||"—",_t.remove()}),wt.addEventListener("click",function(){const at={id:M,name:V.value.trim(),status:U.value},dt=ct.value?String(ct.value):"";dt&&(at.consultantId=dt),X("/api/clients",at).then(function(){k("Cliente aggiornato"),typeof addXP=="function"&&addXP(4);const z=document.createElement("b");z.textContent=at.name||A.name,V.replaceWith(z),L&&(L.textContent=at.status),dt?(w.textContent=ct.options[ct.selectedIndex].textContent||"#"+dt,x.setAttribute("data-consultant-id",dt)):(w.textContent="—",x.setAttribute("data-consultant-id","")),x.setAttribute("data-status",at.status),_t.remove()}).catch(function(z){logger.error(z),k("Errore aggiornamento cliente")})})})})}h.querySelectorAll(".card[data-clid], .card").forEach(y),new MutationObserver(x=>{for(const I of x)for(const M of I.addedNodes)M.nodeType===1&&M.matches(".card[data-clid], .card")&&y(M),M.nodeType===1&&M.querySelectorAll&&M.querySelectorAll(".card[data-clid], .card").forEach(y)}).observe(h,{childList:!0,subtree:!0})},BPFinal.applyClientSort=function(){const h=document.getElementById("cl_list");if(!h)return;const g=document.getElementById("cl_order"),u=g?g.value:"az",v=Array.from(h.children).filter(y=>y.classList.contains("card"));if(v.length){u==="last_desc"?v.sort((y,C)=>(+C.getAttribute("data-last-ts")||0)-(+y.getAttribute("data-last-ts")||0)):v.sort((y,C)=>String(y.getAttribute("data-name-lower")||"").localeCompare(String(C.getAttribute("data-name-lower")||"")));for(const y of v)h.appendChild(y)}},BPFinal.ensureClientFilters=function(){const h=document.getElementById("cl_f_apply");h&&!h.__bp_wired&&(h.__bp_wired=!0,h.addEventListener("click",()=>{setTimeout(()=>{BPFinal.enrichClientCards(),BPFinal.applyClientSort()},0)}));const g=document.getElementById("cl_order");g&&!g.__bp_wired&&(g.__bp_wired=!0,g.addEventListener("change",()=>BPFinal.applyClientSort()))},BPFinal.wireCreateClientExtras=function(){const h=document.getElementById("cl_add");!h||h.__bp_wired||(h.__bp_wired=!0,h.addEventListener("click",g=>{const u=document.getElementById("cl_name"),v=document.getElementById("cl_new_state"),y=document.getElementById("cl_new_owner");if(!u)return;const C=(u.value||"").trim();if(!C||!v&&!y)return;g.stopPropagation(),g.preventDefault();const x={name:C};v&&(x.status=v.value),y&&y.value&&(x.consultantId=y.value),X("/api/clients",x).then(()=>{k("Cliente aggiunto"),addXP&&addXP(5),u.value="",setTimeout(()=>{BPFinal.enrichClientCards(),BPFinal.applyClientSort()},150)}).catch(()=>k("Errore creazione cliente"))},!0))},BPFinal.ensureClientSection=function(){BPFinal.ensureClientFilters(),BPFinal.wireCreateClientExtras(),BPFinal.enrichClientCards(),BPFinal.enableClientsInlineAdmin(),BPFinal.applyClientSort()};async function tt(){const b=d("#tg_user");if(!b||b.options.length>1)return;const h=await F("/api/usernames").catch(()=>null);(h&&h.users||[]).forEach(g=>{const u=document.createElement("option");u.value=g.id,u.textContent=g.name+(g.grade?" ("+g.grade+")":""),b.appendChild(u)})}function J(){const b=d("#users, .users");if(!b||b.__userEditWired)return;b.__userEditWired=!0,b.addEventListener("click",g=>{var M,B;const u=g.target.closest("[data-edit-user]");if(!u)return;const v=u.closest("[data-user-id]"),y=v==null?void 0:v.getAttribute("data-user-id"),C=((M=v==null?void 0:v.querySelector(".u-name"))==null?void 0:M.textContent)||"",x=((B=v==null?void 0:v.querySelector(".u-email"))==null?void 0:B.textContent)||"",I=document.createElement("div");I.className="modal",I.innerHTML='<div class="card"><h3>Modifica utente</h3><label>Nome <input id="u_name" value="'+C+'"></label><label>Email <input id="u_email" value="'+x+'"></label><label>Password <input id="u_pass" type="password" placeholder="(lascia vuoto per non cambiare)"></label><div class="row right"><button id="u_ok" class="btn-ghost">Salva</button><button id="u_x" class="btn-ghost">Chiudi</button></div></div>',document.body.appendChild(I),d("#u_x",I).onclick=()=>I.remove(),d("#u_ok",I).onclick=async()=>{try{const L={id:y,name:d("#u_name",I).value,email:d("#u_email",I).value},w=d("#u_pass",I).value.trim();w&&(L.password=w),await X("/api/users",L),k("Utente aggiornato"),I.remove(),location.reload()}catch(L){k("Errore aggiornamento utente")}}});const h=d("#btnProfile")||d("[data-edit-self]");h&&!h.__wired&&(h.__wired=!0,h.onclick=()=>{const g=m(localStorage.getItem("user")||"{}",{}),u=document.createElement("div");u.className="modal",u.innerHTML='<div class="card"><h3>Profilo</h3><label>Nome <input id="me_name" value="'+(g.name||"")+'"></label><label>Email <input id="me_email" value="'+(g.email||"")+'"></label><label>Password <input id="me_pass" type="password" placeholder="(nuova password)"></label><div class="row right"><button id="me_ok" class="btn-ghost">Salva</button><button id="me_x" class="btn-ghost">Chiudi</button></div></div>',document.body.appendChild(u),d("#me_x",u).onclick=()=>u.remove(),d("#me_ok",u).onclick=async()=>{try{const v={id:g.id,name:d("#me_name",u).value,email:d("#me_email",u).value},y=d("#me_pass",u).value.trim();y&&(v.password=y),await X("/api/users",v),k("Profilo aggiornato"),u.remove(),location.reload()}catch(v){k("Errore aggiornamento profilo")}}})}const W=document.createElement("div");W.className="bp-coach-host",W.style.cssText="position:fixed;left:50%;transform:translateX(-50%);z-index:1200;display:flex;flex-direction:column;gap:6px;pointer-events:none;",document.documentElement.appendChild(W);const ut="\n    /* Desktop default */\n    .bp-coach-host{ top:14px; }\n    /* Mobile: place below header + safe-area */\n    @media (max-width:980px){\n      .bp-coach-host{ top: calc(env(safe-area-inset-top) + 56px + 12px); }\n    }\n    .bp-coach{background:rgba(20,24,34,.92);color:#fff;border:1px solid rgba(255,255,255,.16);\n      border-radius:12px;padding:8px 10px;font-weight:700;box-shadow:0 12px 24px rgba(0,0,0,.35);opacity:.98;transform:translateY(0);transition:all .18s;}\n    @keyframes bpCoachPop{from{transform:translateY(-6px);opacity:0}to{transform:translateY(0);opacity:1}}\n  ",st=document.createElement("style");st.textContent=ut,document.head.appendChild(st);try{window.BP=window.BP||{},window.BP.Coach=window.BP.Coach||{},window.BP.Coach.say=window.BP.Coach.say||function(b,h){try{const g=String(b||"").toLowerCase();let u=h&&h.intensity||(g==="low"||g==="medium"||g==="high"?g:void 0);u||(g==="bp_saved"||g==="client_converted"||g==="gi_created"?u="high":g==="appointment_created"||g==="payments_defined"||g==="report_composed"?u="medium":u="low"),coachSay(u)}catch(g){coachSay("medium")}}}catch(b){}(function(){var b="bp-nncf-banner",h="bp_seen_nncf_appt";function g(){if(!document.getElementById("bp-nncf-css")){var x="\n      #".concat(b,"{\n        position: fixed; left: 16px; right:16px; bottom: 16px; z-index: 9999;\n        background: var(--card, rgba(15,18,28,.96));\n        border: 1px solid var(--hair2, rgba(255,255,255,.12));\n        border-radius: 14px; box-shadow: 0 8px 28px rgba(0,0,0,.35);\n        padding: 12px; display:flex; align-items:center; gap:12px; backdrop-filter: blur(6px);\n      }\n      #").concat(b," .msg{ flex:1; }\n      #").concat(b," .row{ display:flex; gap:8px; align-items:center; }\n      #").concat(b," .ghost{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.18); }\n      @media (prefers-color-scheme: light){\n        #").concat(b,"{ background:#fff; border-color: rgba(0,0,0,.12); }\n        #").concat(b," .ghost{ background:rgba(0,0,0,.04); border-color: rgba(0,0,0,.12); }\n      }\n    "),I=document.createElement("style");I.id="bp-nncf-css",I.textContent=x,document.head.appendChild(I)}}function u(x,I){return x?(x=String(x).trim().toLowerCase(),F("/api/clients").then(function(M){var B=M&&M.clients||[],L=B.find(function(w){return String(w.name||"").trim().toLowerCase()===x});if(!L)throw new Error("Cliente non trovato: "+x);return X("/api/clients",{id:L.id,status:I})})):Promise.reject(new Error("Nome cliente mancante"))}function v(x){if(document.getElementById(b))return;g();var I=x.client||"Cliente",M=document.createElement("div");M.id=b,M.innerHTML='<div class="msg"><b>È diventato cliente?</b> '+n(I)+'</div><div class="row"><button class="ghost" id="bp_nncf_yes">Sì</button><button class="ghost" id="bp_nncf_notyet">Non ancora</button><button id="bp_nncf_close">Chiudi</button></div>',document.body.appendChild(M);function B(){try{localStorage.setItem(h,String(x.id||x.end||Date.now()))}catch(w){}}function L(){try{M.remove()}catch(w){}}document.getElementById("bp_nncf_yes").onclick=function(){u(I,"cliente").then(function(){k("Stato cliente aggiornato")}).catch(function(){k("Impossibile aggiornare lo stato")}).finally(function(){B(),L()})},document.getElementById("bp_nncf_notyet").onclick=function(){u(I,"prospect").catch(function(){}).finally(function(){B(),L()})},document.getElementById("bp_nncf_close").onclick=function(){B(),L()}}function y(){var x=localStorage.getItem(h)||"";return F("/api/appointments").then(function(I){var M=Date.now(),B=I&&I.appointments||[],L=B.filter(function(V){if(!V||!V.nncf)return!1;var U=+new Date(V.end||V.start||0);return U&&U<M-60*1e3}).sort(function(V,U){return+new Date(U.end||U.start||0)-+new Date(V.end||V.start||0)});if(L.length){var w=L[0],A=String(w.id||w.end||"");A&&x&&String(x)===A||v(w)}}).catch(function(I){})}var C=window.BPFinal=window.BPFinal||{};C.injectBannerCSS=g,C.updateClientStatusByName=u,C.scanNNCF=y,window.scanNNCF||(window.scanNNCF=y)})(),(function(){window.showUndo=window.showUndo||function(b,h,g){try{var u=document.getElementById("bp_undo_bar");u||(u=document.createElement("div"),u.id="bp_undo_bar",u.style.position="fixed",u.style.left="16px",u.style.bottom="16px",u.style.zIndex="9999",u.style.background="rgba(20,22,28,0.95)",u.style.color="#fff",u.style.padding="10px 12px",u.style.borderRadius="10px",u.style.boxShadow="0 8px 24px rgba(0,0,0,.25)",u.style.display="flex",u.style.alignItems="center",u.style.gap="12px",document.body.appendChild(u)),u.innerHTML="<span>"+b+'</span><button id="bp_undo_btn" class="ghost" style="background:#fff;color:#111;border-radius:8px;padding:6px 10px">Annulla</button>';var v=document.getElementById("bp_undo_btn"),y=setTimeout(function(){try{u.remove()}catch(C){}},g||5e3);v.onclick=function(){clearTimeout(y);try{u.remove()}catch(C){}typeof h=="function"&&Promise.resolve(h()).then(function(){Ft("medium");try{document.dispatchEvent(new Event("undo:performed"))}catch(C){}}).catch(function(){Ft("heavy")})},Ft("light")}catch(C){logger.error(C)}},window.pushUndo=window.pushUndo||function(b){if(!(!b||typeof b.undo!="function")){var h=b.label||"Annulla ultima operazione";window.showUndo(h,b.undo,b.ttl||5e3)}},window.wireCoachUndoHaptics=function(){function b(){try{window.__periodsCache&&Object.keys(window.__periodsCache).forEach(function(g){delete window.__periodsCache[g]}),delete window.periods}catch(g){}}document.addEventListener("bp:saved",function(){Ft("heavy"),b()}),document.addEventListener("bp:deleted",function(){Ft("medium"),b()}),document.addEventListener("appt:saved",function(){Ft("medium")}),document.addEventListener("ics:exported",function(){Ft("light")}),document.addEventListener("report:composed",function(){Ft("medium")}),document.addEventListener("client:converted",function(){Ft("heavy")}),document.addEventListener("gi:created",function(){Ft("heavy")}),document.addEventListener("payments:defined",function(){Ft("medium")}),document.addEventListener("user:profile-updated",function(){Ft("light")}),document.addEventListener("appt:created",function(){Ft("medium")}),document.addEventListener("undo:performed",function(){Ft("light")}),document.addEventListener("kpi:goal-80",function(){Ft("medium")}),document.addEventListener("kpi:goal-reached",function(){Ft("heavy")}),document.addEventListener("click",function(g){try{for(var u=g.target,v=0;v<3&&u;v++){if(u.matches&&(u.matches('[data-close], [aria-label*="Chiudi" i], [aria-label*="Close" i]')||(u.id||"").toLowerCase().includes("close")||(u.className||"").toLowerCase().includes("close")||/^\s*(chiudi|close)\s*$/i.test(u.textContent||""))){Ft("light");break}u=u.parentElement}}catch(y){}},!0);var h=document.getElementById("app")||document.body;h&&!h.__undoWired&&(h.__undoWired=!0,h.addEventListener("click",function(g){var u=g.target.closest("[data-delete], .btn-delete");if(u){var v=u.getAttribute("href"),y=u.getAttribute("data-id");(v||y)&&(g.preventDefault(),showUndo("Eliminato — Annulla",async function(){try{if(v){var C=v+(v.indexOf("?")>=0?"&":"?")+"undo=1";await F(C)}else y&&await X("/api/restore",{id:y});location.reload()}catch(x){logger.error(x)}}))}},!0))},window.wireHapticsUI=function(){var b=document.body;if(!b.__hapticsWired){b.__hapticsWired=!0,b.addEventListener("click",function(g){var u=g.target.closest('button, .button, .btn, .ghost, [role="button"], a.button, a.btn, [data-action]');if(u){var v="light";u.classList.contains("danger")||u.getAttribute("data-danger")==="1"?v="heavy":(u.classList.contains("primary")||u.getAttribute("data-primary")==="1")&&(v="medium"),Ft(v)}},!0),b.addEventListener("change",function(g){var u=g.target;u&&u.matches('select, input[type="checkbox"], input[type="radio"], input[type="range"]')&&Ft("light")},!0);var h=document.querySelector("[data-drawer-toggle], #menuToggle, .menu-toggle");h&&!h.__hW&&(h.__hW=!0,h.addEventListener("click",function(){Ft("light")},!0))}}})(),window.recomputeDashboardMini=typeof H=="function"?H:()=>{},window.recomputeCommsMini=typeof nt=="function"?nt:()=>{},window.recomputeTeamChart=typeof j=="function"?j:()=>{},window.ensureTeamUserSelect=typeof tt=="function"?tt:()=>{},window.attachICSButtons=typeof attachICSButtons=="function"?attachICSButtons:()=>{},window.addSaveAndExport=typeof addSaveAndExport=="function"?addSaveAndExport:()=>{},window.BPFinal=window.BPFinal||{},(function(b){function h(g,u){typeof u=="function"&&(b[g]=u,window[g]||(window[g]=u))}typeof H<"u"&&h("recomputeDashboardMini",H),typeof nt<"u"&&h("recomputeCommsMini",nt),typeof j<"u"&&h("recomputeTeamChart",j),typeof viewGI<"u"&&h("viewGI",viewGI),typeof tt<"u"&&h("ensureTeamUserSelect",tt),typeof attachICSButtons<"u"&&h("attachICSButtons",attachICSButtons),typeof addSaveAndExport<"u"&&h("addSaveAndExport",addSaveAndExport),typeof ensureClientFilters<"u"&&h("ensureClientFilters",ensureClientFilters),typeof enrichClientCards<"u"&&h("enrichClientCards",enrichClientCards),typeof it<"u"&&h("showClientAppointments",it),typeof wireReportButtons<"u"&&h("wireReportButtons",wireReportButtons),typeof scanNNCF<"u"&&h("scanNNCF",scanNNCF),typeof ensureNNCFChip<"u"&&h("ensureNNCFChip",ensureNNCFChip),typeof rt<"u"&&h("markToday",rt),typeof Y<"u"&&h("clampSlotCounters",Y),typeof filterPastAppointments<"u"&&h("filterPastAppointments",filterPastAppointments),typeof openWeb<"u"&&h("openWeb",openWeb),typeof openApp<"u"&&h("openApp",openApp),typeof notifyConversion<"u"&&h("notifyConversion",notifyConversion),typeof icsFromAppt<"u"&&h("icsFromAppt",icsFromAppt),typeof downloadICS<"u"&&h("downloadICS",downloadICS),typeof F<"u"&&h("GET",F),typeof X<"u"&&h("POST",X)})(window.BPFinal);const ht=new MutationObserver(()=>{typeof ensureNNCFChip=="function"&&ensureNNCFChip(),typeof addSaveAndExport=="function"&&addSaveAndExport(),typeof attachICSButtons=="function"&&attachICSButtons(),typeof wireReportButtons=="function"&&wireReportButtons(),typeof ensureClientFilters=="function"&&ensureClientFilters(),typeof enrichClientCards=="function"&&enrichClientCards(),typeof tt=="function"&&tt(),typeof J=="function"&&J(),typeof filterPastAppointments=="function"&&filterPastAppointments(document.body),typeof rt=="function"&&rt()});p(async()=>{typeof injectTodayCSS=="function"&&injectTodayCSS(),typeof rt=="function"&&rt(),typeof Y=="function"&&Y(),typeof K=="function"&&K(),typeof H=="function"&&await H(),typeof nt=="function"&&await nt(),typeof j=="function"&&await j(),typeof wireHapticsUI=="function"&&wireHapticsUI(),typeof wireCoachUndoHaptics=="function"&&wireCoachUndoHaptics();try{const b="bpCoachGreetedDate",h=new Date().toISOString().slice(0,10);(localStorage.getItem(b)||"")!==h&&typeof window.BP<"u"&&window.BP.Coach&&typeof window.BP.Coach.say=="function"&&(localStorage.setItem(b,h),window.BP.Coach.say("generic",{intensity:"low"}))}catch(b){}ht.observe(document.body,{childList:!0,subtree:!0}),window.onUnifiedRangeChange&&window.onUnifiedRangeChange(b=>{const h=b==="d"?"dash":b==="cm"?"comm":b==="tg"?"t":b;h==="dash"&&typeof H=="function"&&(H(),typeof renderDashboard=="function"&&renderDashboard()),h==="comm"&&typeof nt=="function"&&nt(),(h==="t"||h==="team")&&typeof j=="function"&&j()})})})();(function(){if(!window.GET)return;const n=window.GET;window.GET=function(t){try{if(typeof t=="string"&&t.indexOf("/api/leaderboard")===0){if(!(t.indexOf("/api/leaderboard_overall")===0)&&t.indexOf("indicator=")===-1)return Promise.resolve({ranking:[]});if(window.readUnifiedRange){var e=window.readUnifiedRange("lb")||{},i=e.type==="ytd"||e.type==="ltm"?"mensile":e.type;i&&(t+=(t.includes("?")?"&":"?")+"type="+encodeURIComponent(i))}var o=document.getElementById("lb_mode"),s=o?o.value:"consuntivo";t+=(t.includes("?")?"&":"?")+"mode="+encodeURIComponent(s)}}catch(a){}return n.apply(this,arguments)}})();(function(){if(!("serviceWorker"in navigator)||!("PushManager"in window))return;function n(){try{const s=JSON.parse(localStorage.getItem("bp_user")||"null")||{};if(s.token)return s.token}catch(s){}return localStorage.getItem("bp_token")||localStorage.getItem("authToken")||localStorage.getItem("token")||""}function t(s){const a="=".repeat((4-s.length%4)%4),r=(s+a).replace(/-/g,"+").replace(/_/g,"/"),l=atob(r),c=new Uint8Array(l.length);for(let d=0;d<l.length;d++)c[d]=l.charCodeAt(d);return c}async function e(s){const a=n();if(a)try{await fetch("/api/push/subscribe",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+a},body:JSON.stringify(s)})}catch(r){logger.warn("[BP] push subscribe error",r)}}async function i(){try{const s=await navigator.serviceWorker.ready;let a=await s.pushManager.getSubscription();if(!a){const l=await(await fetch("/api/push/publicKey")).json(),c=l.publicKey||l.key||"";if(!c)return;a=await s.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:t(c)})}await e(a.toJSON())}catch(s){logger.warn("[BP] push subscribe fail",s)}}async function o(){if(Notification.permission==="granted")return i();if(Notification.permission==="default")try{if(await Notification.requestPermission()==="granted")return i()}catch(s){}}window.BPPush={init:o,subscribe:i},window.addEventListener("load",o)})();function We(n,t){localStorage.setItem(n,typeof t=="string"?t:JSON.stringify(t))}function Di(n,t){const e=localStorage.getItem(n);if(e==null)return t;try{return JSON.parse(e)}catch(i){return e}}function Vn(n){localStorage.removeItem(n)}function Uf(n,t){t?We("bp_token",n):sessionStorage.setItem("bp_token",n)}function ki(){return localStorage.getItem("bp_token")||sessionStorage.getItem("bp_token")||""}function Hf(n){We("bp_user",n)}function Ct(){return Di("bp_user",null)||null}function jf(){Vn("bp_token"),sessionStorage.removeItem("bp_token"),Vn("bp_user"),location.href="/?v=13"}function Yo(n,t={}){t.method=t.method||"GET";const e={...t.headers||{}},i=ki();return i&&(e.Authorization="Bearer "+i),t.body!=null&&typeof t.body!="string"&&(e["Content-Type"]="application/json; charset=utf-8",t.body=JSON.stringify(t.body)),t.headers=e,fetch(n,t).then(Wf)}async function Wf(n){const t=await n.text();if(!n.ok)throw Yf(t,n);return $f(t,n)}function Yf(n,t){try{const e=JSON.parse(n).error||"";return new Error(e||t.statusText||"HTTP "+t.status)}catch(e){return new Error(t.statusText||"HTTP "+t.status)}}function $f(n,t){try{if((t.headers.get("content-type")||"").toLowerCase().indexOf("application/json")!==-1)return n?JSON.parse(n):{}}catch(e){}return n}function Mt(n,t){return Yo(n,Object.assign({method:"GET"},{}))}function he(n,t){return Yo(n,{method:"POST",body:t||{}})}function qf(n){return Yo(n,{method:"DELETE"})}function we(n){return(n<10?"0":"")+n}function hi(n){const t=new Date(n);return we(t.getDate())+"/"+we(t.getMonth()+1)+"/"+t.getFullYear()}function oe(n){const t=new Date(n);return t.getFullYear()+"-"+we(t.getMonth()+1)+"-"+we(t.getDate())}function ma(n){const t=new Date(n);return we(t.getHours())+":"+we(t.getMinutes())}function mr(n){const t=new Date(n);t.setHours(0,0,0,0);const e=(t.getDay()+6)%7;return t.setDate(t.getDate()-e),t}function pi(n){const t=new Date(n);return new Date(t.getFullYear(),t.getMonth(),1)}function lo(n){const t=new Date(n);return new Date(t.getFullYear(),t.getMonth()+1,0,23,59,59,999)}function Qt(n){const t=new Date(Date.UTC(n.getFullYear(),n.getMonth(),n.getDate())),e=t.getUTCDay()||7;t.setUTCDate(t.getUTCDate()+4-e);const i=new Date(Date.UTC(t.getUTCFullYear(),0,1));return Math.ceil(((t-i)/864e5+1)/7)}function Un(n){const t=new Date(n),e=Math.floor(t.getMonth()/3);return new Date(t.getFullYear(),e*3,1)}function co(n){const t=Un(n);return new Date(t.getFullYear(),t.getMonth()+3,0,23,59,59,999)}function Hn(n){const t=new Date(n),e=t.getMonth()<6?0:6;return new Date(t.getFullYear(),e,1)}function uo(n){const t=Hn(n);return new Date(t.getFullYear(),t.getMonth()+6,0,23,59,59,999)}function Ti(n){const t=new Date(n);return new Date(t.getFullYear(),0,1)}function Ii(n){const t=new Date(n);return new Date(t.getFullYear(),11,31,23,59,59,999)}function Gf(n,t){const e=new Date(n,0,1+(t-1)*7),i=e.getDay()||7,o=new Date(e);return o.setDate(e.getDate()-(i-1)),o.setHours(0,0,0,0),o}function sn(n,t){const e=Gf(n,t),i=new Date(e);return i.setDate(e.getDate()+6),i.setHours(23,59,59,999),{start:e,end:i}}function Xf(n){const t=mr(n);t.setDate(t.getDate()+7);const e=new Date(t);return e.setDate(t.getDate()+6),e.setHours(23,59,59,999),{start:t,end:e}}function Kf(n){const t=new Date(n.getFullYear(),n.getMonth()+1,1);return{start:t,end:new Date(t.getFullYear(),t.getMonth()+1,0,23,59,59,999)}}function Jf(n){const t=Un(new Date(n.getFullYear(),n.getMonth()+3,1));return{start:t,end:new Date(t.getFullYear(),t.getMonth()+3,0,23,59,59,999)}}function Zf(n){const t=Hn(new Date(n.getFullYear(),n.getMonth()+6,1));return{start:t,end:new Date(t.getFullYear(),t.getMonth()+6,0,23,59,59,999)}}function Qf(n){const t=Ti(new Date(n.getFullYear()+1,0,1));return{start:t,end:Ii(t)}}function Be(n,t){const e=new Date(t);return n==="settimanale"?"Sett. "+Qt(new Date(t))+" "+e.getFullYear():n==="mensile"?e.toLocaleString("it-IT",{month:"long",year:"numeric"}):n==="trimestrale"?"Trimestre "+(Math.floor(e.getMonth()/3)+1)+" "+e.getFullYear():n==="semestrale"?(e.getMonth()<6?"1°":"2°")+" semestre "+e.getFullYear():n==="annuale"?"Anno "+e.getFullYear():n==="ytd"?"YTD "+e.getFullYear():n==="ltm"?"Ultimi 12 mesi":n}let Te;function th(){return Te||(Te=document.getElementById("toast-container"),Te||(Te=document.createElement("div"),Te.id="toast-container",Te.setAttribute("role","status"),Te.setAttribute("aria-live","polite"),document.body.appendChild(Te))),Te}function xt(n){const t=th(),e=document.createElement("div");e.className="toast",e.setAttribute("role","alert"),e.textContent=n,t.appendChild(e),setTimeout(function(){try{e.remove(),t.children.length||(t.remove(),Te=null)}catch(i){}},2200)}function mi(){if(window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches)return;const n=document.createElement("div");n.className="confetti",document.body.appendChild(n);for(let t=0;t<26;t++){const e=document.createElement("span");e.style.position="absolute",e.style.left=2+t*4+"%",e.style.top="0",e.style.width="6px",e.style.height="10px",e.style.background="hsl("+t*14+",90%,60%)",e.style.opacity="0.95",n.appendChild(e),(function(i,o){setTimeout(function(){i.animate&&i.animate([{transform:"translateY(-20px) rotate(0deg)"},{transform:"translateY(110vh) rotate(540deg)"}],{duration:1200+Math.random()*800,easing:"cubic-bezier(.2,.6,.2,1)"})},o)})(e,t*35)}setTimeout(function(){try{n.remove()}catch(t){}},2500)}let Ie;function eh(){return Ie||(Ie=document.getElementById("toast-container"),Ie||(Ie=document.createElement("div"),Ie.id="toast-container",Ie.setAttribute("role","status"),Ie.setAttribute("aria-live","polite"),document.body.appendChild(Ie))),Ie}function nh(){if(sessionStorage.getItem("a2hs-dismissed")==="1")return;const n=navigator.userAgent||navigator.vendor||"",t=/android|iphone|ipad|ipod|mobile/i.test(n),e=window.matchMedia&&window.matchMedia("(display-mode: standalone)").matches;if(!t||e)return;const i=eh(),o=document.createElement("div");o.className="toast",o.style.display="flex",o.style.alignItems="center",o.style.gap="8px";const s=document.createElement("span");s.textContent="Aggiungi questa pagina alla schermata Home per avere la tua app";const a=document.createElement("span");a.textContent="×",a.setAttribute("role","button"),a.setAttribute("aria-label","Chiudi"),a.style.cursor="pointer",a.style.fontWeight="700",a.addEventListener("click",()=>{o.remove(),i.children.length||(i.remove(),Ie=null),sessionStorage.setItem("a2hs-dismissed","1")}),o.appendChild(s),o.appendChild(a),i.appendChild(o)}function zt(n){return String(n).replace(/[&<>'"]/g,function(t){return{"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"}[t]})}function Le(n){return(Number(n)||0).toLocaleString("it-IT")+"€"}function ie(n){const t=Number(n)||0;return String(Math.round(t))}function ih(){if(document.getElementById("bp-mobile-drawer-fix"))return;const n="\n  @media (max-width:980px){\n    .topbar{\n      background: rgba(20,24,34,.90) !important;\n      border-bottom: 1px solid rgba(255,255,255,.08) !important;\n    }\n    .drawer{\n      background: rgba(20,24,34,.96) !important;\n      box-shadow: 14px 0 28px rgba(0,0,0,.45) !important;\n      width: 86vw !important;\n      overflow-y: auto !important;\n    }\n    .drawer .row{ gap:10px !important; }\n    .drawer button{\n      background: rgba(255,255,255,.10) !important;\n      border: 1px solid rgba(255,255,255,.22) !important;\n      color: #fff !important;\n      padding: 12px 14px !important;\n      font-weight: 700 !important;\n      border-radius: 12px !important;\n      -webkit-tap-highlight-color: transparent;\n    }\n    .drawer button:hover{\n      background: rgba(255,255,255,.14) !important;\n      border-color: rgba(255,255,255,.30) !important;\n    }\n    .drawer button.ghost{\n      background: rgba(255,255,255,.10) !important;\n      box-shadow: none !important;\n    }\n  }",t=document.createElement("style");t.id="bp-mobile-drawer-fix",t.textContent=n,document.head.appendChild(t)}function oh(){if(document.getElementById("bp-mobile-light-fix"))return;const n="\n    @media (max-width:980px) and (prefers-color-scheme: light){\n      .topbar{\n        background:#fff !important;\n        border-bottom:1px solid rgba(0,0,0,.08) !important;\n        box-shadow:none !important;\n      }\n      .topbar .brand .logo{\n        color:#0f172a !important;\n        font-weight:900 !important;\n        letter-spacing:.4px;\n        text-shadow:none !important;\n        opacity:1 !important;\n      }\n      .topbar .hamb span{ background:#0f172a !important; }\n      .card{\n        background:#fff !important;\n        background-image:none !important;\n        box-shadow:none !important;\n      }\n      .drawer{\n        background:#fff !important;\n        box-shadow:14px 0 28px rgba(0,0,0,.10) !important;\n      }\n      .drawer button{\n        color:#0f172a !important;\n        background:rgba(0,0,0,.04) !important;\n        border:1px solid rgba(0,0,0,.12) !important;\n      }\n      .drawer button:hover{\n        background:rgba(0,0,0,.08) !important;\n      }\n    }\n  ",t=document.createElement("style");t.id="bp-mobile-light-fix",t.textContent=n,document.head.appendChild(t)}function sh(){if(document.getElementById("bp-badge-light-css"))return;const n="\n    @media (prefers-color-scheme: light){\n      .badge{\n        background: linear-gradient(180deg, #eef2ff, #f8fafc) !important;\n        border: 1px solid #c7d2fe !important;\n        color: #0f172a !important;\n        font-weight: 700 !important;\n        padding: 6px 10px !important;\n        border-radius: 9999px !important;\n        letter-spacing: .2px !important;\n        box-shadow: 0 1px 0 rgba(15,23,42,.05) inset !important;\n      }\n      .chip, .tag{\n        background: #ffffff !important;\n        border: 1px solid #cbd5e1 !important;\n        color: #0f172a !important;\n        font-weight: 600 !important;\n        border-radius: 9999px !important;\n      }\n      .card .badge{\n        background: #fff !important;\n      }\n    }\n  ",t=document.createElement("style");t.id="bp-badge-light-css",t.textContent=n,document.head.appendChild(t)}function ah(){if(document.getElementById("bp-summary-css"))return;const n="\n    summary{ cursor:pointer; padding:4px 0; }\n  ",t=document.createElement("style");t.id="bp-summary-css",t.textContent=n,document.head.appendChild(t)}function me(){const n=Ct();if(!n)return"";const t=n.role==="admin",e='<span class="badge">Lvl '+(window.level?window.level():"")+" · XP "+(window.getXP?window.getXP():"")+"</span>",i='<div id="drawer" class="drawer" role="dialog" aria-modal="true" aria-label="Menu"><div class="row"><button class="ghost" onclick="viewHome();toggleDrawer(false)">Dashboard</button><button class="ghost" onclick="viewCalendar();toggleDrawer(false)">Calendario</button><button class="ghost" onclick="viewPeriods();toggleDrawer(false)">BP</button><button class="ghost" onclick="viewAppointments();toggleDrawer(false)">Appuntamenti</button><button class="ghost" onclick="viewLeaderboard();toggleDrawer(false)">Classifiche</button><button class="ghost" onclick="viewCommissions();toggleDrawer(false)">Provvigioni</button><button class="ghost" onclick="viewVendite();toggleDrawer(false)">Vendite e Riordini</button><button class="ghost" onclick="viewGI();toggleDrawer(false)">GI &amp; Scadenzario</button><button class="ghost" onclick="viewReport();toggleDrawer(false)">Report</button><button class="ghost" onclick="viewClients();toggleDrawer(false)">Clienti</button><button class="ghost" onclick="viewTeam();toggleDrawer(false)">Squadra</button>'+(t?'<button class="ghost" onclick="viewUsers();toggleDrawer(false)">Utenti</button>':"")+'<button onclick="logout()">Logout</button></div></div>';return'<div class="topbar"><div class="brand"><button class="hamb" id="hamb" aria-label="Apri menu" aria-controls="drawer" aria-expanded="false"><span></span><span></span><span></span></button><div class="logo">BATTLE PLAN</div></div><div class="nav right">'+e+'<button class="ghost" onclick="viewHome()">Dashboard</button><button class="ghost" onclick="viewCalendar()">Calendario</button><button class="ghost" onclick="viewPeriods()">BP</button><button class="ghost" onclick="viewAppointments()">Appuntamenti</button><button class="ghost" onclick="viewLeaderboard()">Classifiche</button><button class="ghost" onclick="viewCommissions()">Provvigioni</button><button class="ghost" onclick="viewVendite()">Vendite e Riordini</button><button class="ghost" onclick="viewGI()">GI &amp; Scadenzario</button><button class="ghost" onclick="viewReport()">Report</button><button class="ghost" onclick="viewClients()">Clienti</button><button class="ghost" onclick="viewTeam()">Squadra</button>'+(t?'<button class="ghost" onclick="viewUsers()">Utenti</button>':"")+'<button onclick="logout()">Logout</button></div></div>'+i}function se(){if(!Ct())return;if(!document.getElementById("bp_nav_contrast_css")){const s="\n      @media (min-width: 1024px){\n        .topbar .nav .ghost{\n          background: rgba(255,255,255,.06);\n          border: 1px solid rgba(255,255,255,.18);\n        }\n        .topbar .nav .ghost:hover{\n          background: rgba(255,255,255,.12);\n        }\n      }\n    ",a=document.createElement("style");a.id="bp_nav_contrast_css",a.textContent=s,document.head.appendChild(a)}const n=document.getElementById("app"),t=document.querySelector(".topbar"),e=me();t?t.outerHTML=e:n&&n.insertAdjacentHTML("afterbegin",e);try{ih()}catch(s){}try{oh()}catch(s){}try{sh()}catch(s){}try{ah()}catch(s){}if(!document.getElementById("bp-unified-filters-css")){const s="\n      /* Nested inputs align in two columns inside unified filters */\n      .uf .row .row{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }\n\n      @media (max-width: 980px){\n        .uf input, .uf select{ min-width: 0; width: 100%; }\n        .uf .row > div{ flex: 1 1 180px; min-width: 0; }\n\n        /* Squadra admin bar: grid on small screens */\n        #t_adminbar{ display:grid !important; grid-template-columns: 1fr 1fr; align-items:end; gap:10px; }\n        #t_adminbar > div{ min-width: 0; }\n        #t_adminbar .row{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }\n      }\n\n      @media (max-width: 560px){\n        #t_adminbar{ grid-template-columns: 1fr; }\n      }\n    ",a=document.createElement("style");a.id="bp-unified-filters-css",a.textContent=s,document.head.appendChild(a)}const i=document.getElementById("hamb");i&&(i.onclick=function(){Ni()});const o=document.getElementById("drawer");o&&o.addEventListener("click",function(s){s.target.id==="drawer"&&Ni(!1)}),document.removeEventListener("keydown",ga,!1),document.addEventListener("keydown",ga,!1)}function ga(n){if(n&&n.key==="Escape"){const t=document.getElementById("drawer");t&&t.classList.contains("open")&&Ni(!1)}}function Ni(n){const t=document.getElementById("drawer");if(!t)return;const e=typeof n=="boolean"?n:!t.classList.contains("open");t.classList.toggle("open",e);const i=document.getElementById("hamb");i&&i.setAttribute("aria-expanded",String(e)),document.body.classList.toggle("no-scroll",e)}let va=null;function rh(){clearTimeout(va),va=setTimeout(se,60)}function _e(n){return document.querySelector(n)}function fo(n){return Array.from(document.querySelectorAll(n))}(function(){const n=window.BP=window.BP||{},t=n.ICS=n.ICS||{};function e(l){if(!l)return"";if(/[Zz]|[+\-]\d{2}:\d{2}$/.test(String(l)))return new Date(l).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z").slice(0,15)+"Z";const[c,d="00:00"]=String(l).split("T"),[f,p,m]=c.split("-").map(Number),[_,S]=d.split(":").map(Number);return new Date(f,p-1,m,_,S,0,0).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z").slice(0,15)+"Z"}function i(l){return(l||"").replace(/\\/g,"\\\\").replace(/;/g,"\\;").replace(/,/g,"\\,").replace(/\n/g,"\\n")}function o(l){if(l.length<=74)return[l];const d=[];let f=0;for(;f<l.length;){const p=l.slice(f,f+74);d.push(f===0?p:" "+p),f+=74}return d}function s(l){const c=(l&&l.id||"bp-"+Date.now())+"@bpapp",d=l&&l.client?"Appuntamento · "+l.client:"Appuntamento",f=e(l&&l.start),p=e(l&&l.end),m=e(new Date().toISOString().slice(0,16)),_=[];l&&l.type&&_.push("Tipo: "+l.type),l&&l.vss&&_.push("VSS: "+l.vss),l&&l.vsdPersonal&&_.push("VSD Personale: "+l.vsdPersonal),l&&l.notes&&_.push("Note: "+l.notes);const S=i(_.join("\n")),k=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//BPApp//Calendario//IT","CALSCALE:GREGORIAN","METHOD:PUBLISH","BEGIN:VEVENT","UID:"+c,"DTSTAMP:"+m,f?"DTSTART:"+f:"",p?"DTEND:"+p:"","SUMMARY:"+i(d),S?"DESCRIPTION:"+S:"","END:VEVENT","END:VCALENDAR"].filter(Boolean),O=[];return k.forEach(F=>O.push.apply(O,o(F))),O.join("\r\n")}function a(){try{const l=navigator.userAgent||navigator.vendor||"",c=/iP(ad|hone|od)/.test(l),d=/^((?!chrome|android|crios|fxios|edgi).)*safari/i.test(l);return c||d}catch(l){return!1}}function r(l){try{const c=s(l),d=l&&l.start?String(l.start).split("T")[0]:"evento",f=(l&&l.client||"appuntamento").trim().replace(/[^\w\-]+/g,"_").slice(0,40),p="bp_".concat(f,"_").concat(d,".ics");if(a())try{const S="data:text/calendar;charset=utf-8,"+encodeURIComponent(c),k=document.createElement("a");return k.href=S,k.setAttribute("target","_blank"),k.setAttribute("download",p),document.body.appendChild(k),k.click(),k.remove(),!0}catch(S){try{return window.location.assign("data:text/calendar;charset=utf-8,"+encodeURIComponent(c)),!0}catch(k){try{logger.error(k)}catch(O){}return!1}}const m=new Blob([c],{type:"text/calendar;charset=utf-8"}),_=document.createElement("a");return _.href=URL.createObjectURL(m),_.download=p,document.body.appendChild(_),_.click(),setTimeout(()=>{try{URL.revokeObjectURL(_.href)}catch(S){}_.remove()},50),!0}catch(c){try{logger.error(c)}catch(d){}return!1}}t.makeIcsForAppointment=s,t.downloadIcsForAppointment=r,window.icsFromAppt=window.icsFromAppt||function(l){return s(l)},window.downloadICS=window.downloadICS||function(l,c){try{var d=window.__icsSanitize?__icsSanitize(l):l||"evento";/\.ics$/i.test(d)||(d+=".ics");var f=new Blob([c],{type:"text/calendar;charset=utf-8"}),p=document.createElement("a");p.href=URL.createObjectURL(f),p.download=d,document.body.appendChild(p),p.click(),setTimeout(function(){URL.revokeObjectURL(p.href),p.remove()},50)}catch(m){logger.error(m)}}})();function $o(n){if(!n)return new Date(NaN);const t=new Date(n);return isNaN(t)?new Date(NaN):t}function gr(n){if(!(n instanceof Date)||isNaN(n))return"—";const t=r=>(r<10?"0":"")+r,e=t(n.getDate()),i=t(n.getMonth()+1),o=n.getFullYear(),s=t(n.getHours()),a=t(n.getMinutes());return"".concat(e,"/").concat(i,"/").concat(o," ").concat(s,":").concat(a)}function vr(n){if(!(n instanceof Date)||isNaN(n))return"";const t=r=>(r<10?"0":"")+r,e=n.getFullYear(),i=t(n.getMonth()+1),o=t(n.getDate()),s=t(n.getHours()),a=t(n.getMinutes());return"".concat(e,"-").concat(i,"-").concat(o,"T").concat(s,":").concat(a)}function br(n){if(!n)return new Date(NaN);const t=String(n).trim(),[e,i="00:00"]=t.split("T"),[o,s,a]=e.split("-").map(Number),[r,l]=i.split(":").map(Number);if(!o||!s||!a||r===void 0||l===void 0)return new Date(NaN);const c=new Date(o,s-1,a,r,l,0,0);return isNaN(c)?new Date(NaN):c}function yr(n){if(!(n instanceof Date)||isNaN(n))return"";const t=s=>(s<10?"0":"")+s,e=n.getFullYear(),i=t(n.getMonth()+1),o=t(n.getDate());return"".concat(e,"-").concat(i,"-").concat(o)}function wr(n){if(!(n instanceof Date)||isNaN(n))return"";const t=o=>(o<10?"0":"")+o,e=t(n.getHours()),i=t(n.getMinutes());return"".concat(e,":").concat(i)}function _r(n,t){return!(n instanceof Date)||!(t instanceof Date)||isNaN(n)||isNaN(t)?0:Math.max(0,Math.round((t.getTime()-n.getTime())/6e4))}function xr(n,t){return!(n instanceof Date)||isNaN(n)||!isFinite(t)?new Date(NaN):new Date(n.getTime()+t*6e4)}function Sr(n){if(!isFinite(n)||n<0)return"0m";const t=Math.floor(n/60),e=n%60;return t===0?"".concat(e,"m"):e===0?"".concat(t,"h"):"".concat(t,"h ").concat(e,"m")}function Cr(n){if(!(n instanceof Date)||isNaN(n))return"";const t=l=>(l<10?"0":"")+l,e=n.getUTCFullYear(),i=t(n.getUTCMonth()+1),o=t(n.getUTCDate()),s=t(n.getUTCHours()),a=t(n.getUTCMinutes()),r=t(n.getUTCSeconds());return"".concat(e).concat(i).concat(o,"T").concat(s).concat(a).concat(r,"Z")}function Dr(n){if(!(n instanceof Date)||isNaN(n))return"";const t=s=>(s<10?"0":"")+s,e=n.getUTCFullYear(),i=t(n.getUTCMonth()+1),o=t(n.getUTCDate());return"".concat(e,"-").concat(i,"-").concat(o)}function kr(n){const t=$o(n);return!isNaN(t)}typeof module<"u"&&module.exports&&(module.exports={parseUTCString:$o,toLocalDisplay:gr,toLocalInputValue:vr,fromLocalInputValue:br,ymdLocal:yr,ymdUTC:Dr,timeHMLocal:wr,minutesBetween:_r,addMinutes:xr,formatDuration:Sr,toICSUTC:Cr,isValidDateTime:kr});typeof window<"u"&&(window.BPTimezone={parseUTCString:$o,toLocalDisplay:gr,toLocalInputValue:vr,fromLocalInputValue:br,ymdLocal:yr,ymdUTC:Dr,timeHMLocal:wr,minutesBetween:_r,addMinutes:xr,formatDuration:Sr,toICSUTC:Cr,isValidDateTime:kr});window.Chart=Re;(function(){var n=document.getElementById("app");window.$1=window.$1||_e,window.$all=window.$all||fo,window.addXP=window.addXP||function(){},typeof window.logger!="object"&&(window.logger=["debug","info","log","warn","error"].reduce((T,D)=>(T[D]=(console[D]||console.log).bind(console),T),{})),typeof window.haptic!="function"&&(window.haptic=window.BP&&BP.Haptics&&BP.Haptics.impact?BP.Haptics.impact:function(){}),(function(){const T=window.__miniCharts=window.__miniCharts||{};function D($,H,nt){const j=$.getContext("2d"),K=window.devicePixelRatio||1,rt=$.clientWidth||320,Y=$.clientHeight||80;$.width=Math.round(rt*K),$.height=Math.round(Y*K),j.save(),j.scale(K,K),j.clearRect(0,0,rt,Y);const Q=Math.max(1,...nt),it=nt.length>1?(rt-8)/(nt.length-1):0;j.strokeStyle="#2e6cff",j.lineWidth=2,j.beginPath();for(let tt=0;tt<nt.length;tt++){const J=4+tt*it,W=Y-6-nt[tt]/Q*(Y-12);tt===0?j.moveTo(J,W):j.lineTo(J,W)}j.stroke(),j.fillStyle="#2e6cff";for(let tt=0;tt<nt.length;tt++){const J=4+tt*it,W=Y-6-nt[tt]/Q*(Y-12);j.beginPath(),j.arc(J,W,2,0,Math.PI*2),j.fill()}j.restore()}function E($,H){try{let j=function(Q,it){try{if(this&&typeof this.getLabelForValue=="function")return String(this.getLabelForValue(Q))}catch(W){}const tt=typeof Q=="number"?Q:it,J=Array.isArray($)?$[tt]:Q;return String(J!=null?J:Q)};const nt=Array.isArray($)?$.length:0;if(!nt)return{autoSkip:!0,maxRotation:0,minRotation:0};const K=Math.max(0,...$.map(Q=>String(Q||"").length)),rt=Math.max(28,Math.min(90,Math.round(K*7)));return nt*rt>(H||320)*1.2?{autoSkip:!0,maxRotation:45,minRotation:45,callback:j}:{autoSkip:!0,maxRotation:0,minRotation:0,callback:j}}catch(nt){return{autoSkip:!0,maxRotation:0,minRotation:0}}}window.computeTickOptions=E,window.drawFullLine=function($,H,nt){const j=document.getElementById($);if(!j)return;if(j.width=j.clientWidth||j.width||320,j.height=j.clientHeight||j.height||80,!Re){D(j,H,nt),T[String($)]={canvas:j,labels:H,data:nt,fallback:!0};return}const K=String($),rt=E(H,j.width||320);if(T[K]&&T[K].canvas!==j){try{T[K].destroy()}catch(Y){}delete T[K]}if(T[K]){const Y=T[K];Y.data.labels=H,Y.data.datasets[0].data=nt,Y.options.scales.x.ticks=E(H,j.width||320),Y.update()}else{const Y=j.getContext("2d");T[K]=new Re(Y,{type:"line",data:{labels:H,datasets:[{label:"",data:nt,borderColor:"#2e6cff",backgroundColor:"rgba(46,108,255,0.10)",borderWidth:2,tension:.3,pointRadius:3,pointHoverRadius:5,fill:!1}]},options:{responsive:!1,maintainAspectRatio:!1,animation:!1,animations:!1,plugins:{legend:{display:!1}},devicePixelRatio:window.devicePixelRatio||1,scales:{x:{grid:{display:!1},ticks:rt},y:{beginAtZero:!0}}}})}};let P=window.devicePixelRatio||1;function R(){Object.keys(T).forEach($=>{const H=T[$];if(H&&typeof H.resize=="function")try{H.resize()}catch(nt){}else if(H&&H.fallback)try{D(H.canvas,H.labels,H.data)}catch(nt){}})}function N(){const $=window.devicePixelRatio||1;$!==P&&(P=$,R())}window.addEventListener("pageshow",R),window.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&N()}),window.addEventListener("resize",N),window.addEventListener("orientationchange",()=>setTimeout(()=>{P=-1,N()},50))})();function t(){document.title="Battle Plan – Login";var T='<div class="hero" id="hero"><div class="layer glow"></div><div class="layer grid"></div><div class="title">Pianifica. Eroga. Vinci. <span class="small muted">BP – stile gaming</span></div></div><div class="wrap"><div class="grid"><div class="card"><h3>Accedi</h3><form id="loginForm" autocomplete="on"><div class="row"><div><label>Email</label><input id="li_email" name="email" type="email" autocomplete="username" required></div><div><label>Password</label><input id="li_password" name="password" type="password" autocomplete="current-password" required></div></div><div class="row"><label class="small"><input type="checkbox" id="li_remember" checked> Rimani collegato</label></div><div class="right" style="margin-top:8px"><button type="submit" id="btnLogin">Accedi</button></div></form></div><div class="card"><h3>Registrati</h3><form id="regForm" autocomplete="on"><div class="row"><div><label>Nome</label><input id="re_name" name="name" type="text" required></div><div><label>Email</label><input id="re_email" name="email" type="email" autocomplete="username" required></div><div><label>Password</label><input id="re_password" name="new-password" type="password" autocomplete="new-password" required></div></div><div class="right" style="margin-top:8px"><button type="submit" id="btnRegister">Registrati</button></div></form></div></div></div>';n.innerHTML=T;var D=document.getElementById("hero");D&&D.addEventListener("pointermove",function(R){var N=D.getBoundingClientRect();D.style.setProperty("--gx",(R.clientX-N.left)/N.width*100+"%"),D.style.setProperty("--gy",(R.clientY-N.top)/N.height*100+"%")});var E=document.getElementById("loginForm"),P=document.getElementById("regForm");E.addEventListener("submit",function(R){R.preventDefault();var N=document.getElementById("btnLogin");N.disabled=!0;var $=document.getElementById("li_email").value.trim().toLowerCase(),H=document.getElementById("li_password").value,nt=document.getElementById("li_remember").checked;he("/api/login",{email:$,password:H}).then(function(j){if(typeof j=="string")try{j=JSON.parse(j)}catch(K){}Uf(j.token,nt),Hf(j.user),xt("Bentornato "+j.user.name+"!"),window.addXP(10),c(),se(),window.BPPush&&window.BPPush.subscribe()},function(j){xt("Credenziali errate"),logger.error(j)}).catch(function(j){logger.error(j)}).finally(function(){N.disabled=!1})}),P.addEventListener("submit",function(R){R.preventDefault();var N=document.getElementById("btnRegister");N.disabled=!0;var $=document.getElementById("re_name").value.trim(),H=document.getElementById("re_email").value.trim().toLowerCase(),nt=document.getElementById("re_password").value;he("/api/register",{name:$,email:H,password:nt}).then(function(){xt("Registrazione ok. Ora accedi"),mi(),window.addXP(20),window.scrollTo({top:0,behavior:"smooth"})}).catch(function(j){xt("Email già registrata?"),logger.error(j)}).finally(function(){N.disabled=!1})})}function e(T){const D=new Date,E=D.getFullYear(),P=D.getMonth()+1,R=Qt(D),N=Math.floor((P-1)/3)+1,$=2e3,H=2100,nt=(function(){let Y="";for(let Q=$;Q<=H;Q++)Y+='<option value="'.concat(Q,'" ').concat(Q===E?"selected":"",">").concat(Q,"</option>");return Y})(),j=(function(){let Y="";for(let Q=1;Q<=12;Q++)Y+='<option value="'.concat(Q,'" ').concat(Q===P?"selected":"",">").concat(Q,"</option>");return Y})(),K=(function(){let Y="";for(let Q=1;Q<=53;Q++)Y+='<option value="'.concat(Q,'" ').concat(Q===R?"selected":"",">").concat(Q,"</option>");return Y})(),rt=(function(){let Y="";for(let Q=1;Q<=4;Q++)Y+='<option value="'.concat(Q,'" ').concat(Q===N?"selected":"",">Q").concat(Q,"</option>");return Y})();return'<div class="uf"><div class="row"><div><label>Granularità</label><select id="'+T+'_gran"><option value="settimanale">Settimanale</option><option value="mensile" selected>Mensile</option><option value="trimestrale">Trimestrale</option><option value="semestrale">Semestrale</option><option value="annuale">Annuale</option><option value="ytd">Anno corrente (YTD)</option><option value="ltm">Ultimi 12 mesi (LTM)</option></select></div><div id="'+T+'_wrap_week" style="display:none"><label>Settimana ISO</label><div class="row"><select id="'+T+'_week">'+K+'</select><select id="'+T+'_year_w">'+nt+'</select></div></div><div id="'+T+'_wrap_month"><label>Mese</label><div class="row"><select id="'+T+'_month">'+j+'</select><select id="'+T+'_year_m">'+nt+'</select></div></div><div id="'+T+'_wrap_quarter" style="display:none"><label>Trimestre</label><div class="row"><select id="'+T+'_quarter">'+rt+'</select><select id="'+T+'_year_q">'+nt+'</select></div></div><div id="'+T+'_wrap_sem" style="display:none"><label>Semestre</label><div class="row"><select id="'+T+'_sem"><option value="1">1°</option><option value="2">2°</option></select><select id="'+T+'_year_s">'+nt+'</select></div></div><div id="'+T+'_wrap_year" style="display:none"><label>Anno</label><select id="'+T+'_year">'+nt+'</select></div><div class="actions"><button id="'+T+'_refresh" class="ghost">Aggiorna</button></div></div></div>'}(function(){const T=[];window.onUnifiedRangeChange=function(D){typeof D=="function"&&T.push(D)},window.emitUnifiedRangeChange=function(D){for(const E of T)try{E(D)}catch(P){logger.error(P)}}})();function i(T){return T==="d"||T==="dash"?"dash":T==="cm"||T==="comm"?"comm":T==="tg"||T==="t"||T==="team"?"t":T}function o(T,D){function E(){const R=document.getElementById(T+"_gran").value;["week","month","quarter","sem","year"].forEach($=>{const H=document.getElementById(T+"_wrap_"+$);H&&(H.style.display="none")}),R==="settimanale"?document.getElementById(T+"_wrap_week").style.display="":R==="mensile"?document.getElementById(T+"_wrap_month").style.display="":R==="trimestrale"?document.getElementById(T+"_wrap_quarter").style.display="":R==="semestrale"?document.getElementById(T+"_wrap_sem").style.display="":R==="annuale"&&(document.getElementById(T+"_wrap_year").style.display="")}["gran","week","year_w","month","year_m","quarter","year_q","sem","year_s","year"].forEach(R=>{const N=document.getElementById(T+"_"+R);N&&(N.onchange=()=>{E(),D&&D(),window.emitUnifiedRangeChange(i(T))},N.oninput=()=>{E()})});const P=document.getElementById(T+"_refresh");P&&(P.onclick=()=>{D&&D(),window.emitUnifiedRangeChange(i(T))}),E()}function s(T){var D=new Date;function E(st,ht){var b=document.getElementById(T+"_"+st),h=b?parseInt(b.value,10):NaN;return isFinite(h)?h:ht}var P=document.getElementById(T+"_gran"),R=P?P.value:"mensile",N={type:R,start:null,end:null};if(R==="settimanale"){var $=E("year_w",D.getFullYear()),H=Math.max(1,Math.min(53,E("week",Qt(D)))),nt=sn($,H);return N.start=nt.start,N.end=nt.end,N}if(R==="mensile"){var j=E("year_m",D.getFullYear()),K=Math.max(1,Math.min(12,E("month",D.getMonth()+1)));return N.start=new Date(j,K-1,1),N.end=new Date(j,K,0,23,59,59,999),N}if(R==="trimestrale"){var rt=E("year_q",D.getFullYear()),Y=Math.max(1,Math.min(4,E("quarter",Math.floor(D.getMonth()/3)+1)));return N.start=new Date(rt,(Y-1)*3,1),N.end=new Date(rt,Y*3,0,23,59,59,999),N}if(R==="semestrale"){var Q=E("year_s",D.getFullYear()),it=E("sem",D.getMonth()<6?1:2);return N.start=new Date(Q,it===1?0:6,1),N.end=new Date(Q,it===1?6:12,0,23,59,59,999),N}if(R==="annuale"){var tt=E("year",D.getFullYear());return N.start=new Date(tt,0,1),N.end=new Date(tt,11,31,23,59,59,999),N}if(R==="ytd"){var J=new Date(D.getFullYear(),D.getMonth()+1,0,23,59,59,999);return N.start=new Date(D.getFullYear(),0,1),N.end=J,N}if(R==="ltm"){var W=new Date(D.getFullYear(),D.getMonth()+1,0,23,59,59,999),ut=new Date(W.getFullYear(),W.getMonth()-11,1);return N.start=ut,N.end=W,N}return N.type="mensile",N.start=new Date(D.getFullYear(),D.getMonth(),1),N.end=new Date(D.getFullYear(),D.getMonth()+1,0,23,59,59,999),N}function a(T){return T==="ytd"||T==="ltm"?"mensile":T}window.effectivePeriodType=a;function r(T,D){var E=String(T||"mensile").toLowerCase(),P=a(E||"mensile"),R=D?new Date(D):new Date,N=R.getUTCFullYear(),$=[];function H(ct,_t){$.push({s:ct.getTime(),e:_t.getTime()})}function nt(ct,_t,wt){return new Date(Date.UTC(ct,_t,wt))}function j(ct){return new Date(ct.getTime()+24*3600*1e3-1)}function K(ct,_t){return new Date(Date.UTC(ct,_t+1,0))}if(E==="ytd"){for(var rt=0;rt<=R.getUTCMonth();rt++){var Y=nt(R.getUTCFullYear(),rt,1),Q=j(K(Y.getUTCFullYear(),Y.getUTCMonth()));$.push({s:Y.getTime(),e:Q.getTime()})}return $}if(E==="ltm"){for(var it=nt(R.getUTCFullYear(),R.getUTCMonth(),1),tt=11;tt>=0;tt--){var J=nt(it.getUTCFullYear(),it.getUTCMonth()-tt,1),W=j(K(J.getUTCFullYear(),J.getUTCMonth()));$.push({s:J.getTime(),e:W.getTime()})}return $}if(P==="settimanale"){var ut=new Date(Date.UTC(R.getUTCFullYear(),R.getUTCMonth(),R.getUTCDate())),st=(ut.getUTCDay()+6)%7;ut.setUTCDate(ut.getUTCDate()-st);for(var ht=52;ht>=0;ht--){var b=new Date(ut);b.setUTCDate(ut.getUTCDate()-ht*7);var h=new Date(b);h.setUTCDate(b.getUTCDate()+6),h.setUTCHours(23,59,59,999),H(b,h)}return $}if(P==="mensile"){for(var it=new Date(Date.UTC(R.getUTCFullYear(),R.getUTCMonth(),1)),tt=23;tt>=0;tt--){var rt=new Date(Date.UTC(it.getUTCFullYear(),it.getUTCMonth()-tt,1));H(rt,j(K(rt.getUTCFullYear(),rt.getUTCMonth())))}return $}if(P==="trimestrale"){for(var g=Math.floor(R.getUTCMonth()/3),u=11;u>=0;u--){var v=g-u,y=N+Math.floor(v/4),C=(v%4+4)%4,b=nt(y,C*3,1),h=j(new Date(Date.UTC(y,C*3+3,0)));H(b,h)}return $}if(P==="semestrale"){for(var x=R.getUTCMonth()<6?0:1,I=5;I>=0;I--){var M=x-I,B=N+Math.floor(M/2),L=(M%2+2)%2,w=L===0?0:6,A=nt(B,w,1),V=j(new Date(Date.UTC(B,w+6,0)));H(A,V)}return $}for(var U=2;U>=0;U--){var G=N-U;H(nt(G,0,1),j(new Date(Date.UTC(G,12,0))))}return $}function l(T,D){var E=a(T||"mensile");return(D||[]).map(function(P){var R=new Date(P.s);return E==="settimanale"?"W"+Qt(R)+" "+R.getUTCFullYear():E==="mensile"?String(R.getUTCMonth()+1).padStart(2,"0")+"/"+R.getUTCFullYear():E==="trimestrale"?"Q"+(Math.floor(R.getUTCMonth()/3)+1)+" "+R.getUTCFullYear():E==="semestrale"?(R.getUTCMonth()<6?"S1 ":"S2 ")+R.getUTCFullYear():String(R.getUTCFullYear())})}function c(){if(!Ct())return t();document.title="Battle Plan – Dashboard";const T=Ct().role==="admin";var D=T?'<div><label>Consulente</label><select id="dash_cons"><option value="">Tutti</option></select></div>':"";n.innerHTML=me()+'<div class="wrap"><div class="card"><b>Filtro</b><div class="row uf-row" style="margin-top:6px;align-items:flex-end;gap:16px;flex-wrap:wrap"><div><label>Modalità</label><select id="dash_mode" name="mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div>'+D+"</div>"+e("dash")+'</div><div class="grid" id="kpiGrid"><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>VSS</b><span id="kpi_vss" class="big">—</span></div><canvas id="d_mini_vss" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>VSD personale</b><span id="kpi_vsd" class="big">—</span></div><canvas id="d_mini_vsdpersonale" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>VSD indiretto</b><span id="kpi_vsd_ind" class="big">—</span></div><canvas id="d_mini_vsdindiretto" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>GI</b><span id="kpi_gi" class="big">—</span></div><canvas id="d_mini_gi" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>NNCF</b><span id="kpi_nncf" class="big">—</span></div><canvas id="d_mini_nncf" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>Tot Provvigioni</b><span id="kpi_provv" class="big">—</span></div><canvas id="d_mini_provv" width="320" height="90"></canvas></div></div><div class="card"><b>Ultimi appuntamenti inseriti</b><div id="lastApps" class="row" style="margin-top:8px"></div></div><div class="card"><b>Ultimi BP inviati</b><div id="lastBPs" class="row" style="margin-top:8px"></div></div></div>',se(),(function(){try{var W=document.querySelector(".uf-row");if(!W)return;var ut=document.getElementById("cal_prev");ut&&(ut.textContent="◀");var st=document.getElementById("cal_next");st&&(st.textContent="▶");var ht=W.querySelector("#only_4h");ht&&ht.parentElement&&(ht.parentElement.innerHTML='<input type="checkbox" id="only_4h"> Solo slot ≥ 4h');var b=document.getElementById("cal_add"),h=W.querySelector(".right"),g=h?h.querySelector("#cal_refresh"):null;if(b&&g){var u=document.createElement("div");u.className="actions",h.parentNode.insertBefore(u,h),u.appendChild(b),u.appendChild(g),h.remove()}}catch(v){logger&&logger.warn&&logger.warn("cal header fix fail",v)}})();function E(J,W){var ut=document.getElementById(J);ut&&(ut.textContent=W)}function P(J){var W=Number(J)||0;return W.toLocaleString("it-IT")+"€"}function R(J){var W=Number(J)||0;return String(Math.round(W))}function N(J){return String(J).replace(/[&<>'"]/g,W=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[W])}T&&(function(){Mt("/api/usernames").then(function(W){var ut=W&&W.users||[],st=document.getElementById("dash_cons");st&&(st.innerHTML='<option value="">Tutti</option>'+ut.map(function(ht){return'<option value="'+N(String(ht.id))+'">'+N(ht.name||ht.email||"User #"+ht.id)+"</option>"}).join(""))}).catch(function(){})})();function $(J,W){return W==="settimanale"?window.isoWeekNum?window.isoWeekNum(J):Math.ceil(J.getDate()/7):W==="mensile"||W==="ytd"||W==="ltm"?J.getMonth()+1:W==="trimestrale"?Math.floor(J.getMonth()/3)+1:W==="semestrale"?J.getMonth()<6?1:2:J.getFullYear()}function H(J){if(typeof r=="function")return(r(J,new Date)||[]).map(function(at){return{s:at.s,e:at.e}});var W=new Date,ut=[];function st(at,dt){ut.push({s:at.getTime(),e:dt.getTime()})}function ht(at){var dt=new Date(at);return dt.setHours(23,59,59,999),dt}function b(at,dt){return new Date(at,dt+1,0,23,59,59,999)}var h=String(J||"mensile").toLowerCase();if(h==="settimanale"){var g=new Date(W),u=(g.getDay()+6)%7;g.setDate(g.getDate()-u),g.setHours(0,0,0,0);for(var v=52;v>=0;v--){var y=new Date(g);y.setDate(y.getDate()-v*7);var C=new Date(y);C.setDate(y.getDate()+6),C.setHours(23,59,59,999),st(y,C)}return ut}if(h==="mensile"||h==="ytd"||h==="ltm"){if(h==="ytd")for(var x=0;x<=W.getMonth();x++){var I=new Date(W.getFullYear(),x,1);st(I,b(W.getFullYear(),x))}else for(var M=h==="ltm"?12:24,B=new Date(W.getFullYear(),W.getMonth(),1),L=M-1;L>=0;L--){var y=new Date(B.getFullYear(),B.getMonth()-L,1);st(y,b(y.getFullYear(),y.getMonth()))}return ut}if(h==="trimestrale"){for(var w=Math.floor(W.getMonth()/3)*3,A=new Date(W.getFullYear(),w,1),V=11;V>=0;V--){var U=new Date(A.getFullYear(),A.getMonth()-V*3,1);st(U,ht(new Date(U.getFullYear(),U.getMonth()+3,0)))}return ut}if(h==="semestrale"){for(var G=W.getMonth()<6?0:6,ct=new Date(W.getFullYear(),G,1),y=5;y>=0;y--){var _t=new Date(ct.getFullYear(),ct.getMonth()-y*6,1);st(_t,ht(new Date(_t.getFullYear(),_t.getMonth()+6,0)))}return ut}for(var wt=2;wt>=0;wt--){var yt=new Date(W.getFullYear()-wt,0,1);st(yt,ht(new Date(yt.getFullYear(),12,0)))}return ut}function nt(J){switch(String(J)){case"provv_gi":return"ProvvGI";case"provv_vsd":return"ProvvVSD";case"tot_provv":return"TotProvvigioni";default:return J}}function j(J,W,ut,st){var ht=st||s("dash"),b=String(ht.type||"mensile").toLowerCase(),h=b==="ytd"||b==="ltm"?"mensile":b,g=H(b);function u(C,x){var I=new Date(x.startDate).getTime(),M=new Date(x.endDate).getTime();return I>=C.s&&M<=C.e}function v(C,x){if(!C)return 0;if(x==="VSDTotale")return Number(C.VSDPersonale||0)+Number(C.VSDIndiretto||0);if(x==="ProvvGI")return Number(C.ProvvGI||0);if(x==="ProvvVSD")return Number(C.ProvvVSD||0);if(x==="TotProvvigioni"){var I=C.TotProvvigioni;return Number(I!=null?I:Number(C.ProvvGI||0)+Number(C.ProvvVSD||0))}return Number(C[x]||0)}var y=(function(){var C=g.length?oe(new Date(g[0].s)):oe(new Date),x=g.length?oe(new Date(g[g.length-1].e)):oe(new Date),I="?global=1&type="+encodeURIComponent(h)+"&from="+encodeURIComponent(C)+"&to="+encodeURIComponent(x);return ut&&(I+="&userId="+encodeURIComponent(ut)),I})();return Mt("/api/periods"+y).catch(function(){return Mt("/api/periods"+y.replace("?global=1",""))}).then(function(C){var x=C&&C.periods||[],I=x.filter(function(L){return!(L.type!==h||ut&&String(L.userId||L.uid||"")!==String(ut))}),M=nt(J),B=g.map(function(L){for(var w=0,A=0;A<I.length;A++){var V=I[A];if(u(L,V)){var U=W==="previsionale"?V.indicatorsPrev||{}:V.indicatorsCons||{};w+=v(U,M)}}return{x:new Date(L.s),y:Math.round(w*100)/100}});return B})}function K(J,W,ut){var st=document.getElementById(J);if(st){if(typeof window.drawFullLine=="function"){window.drawFullLine(J,W,ut);return}var ht=st.getContext("2d");st.width=st.clientWidth||320,st.height=st.clientHeight||80,ht.clearRect(0,0,st.width,st.height);var b=Math.max(1,...ut),h=ut.length>1?(st.width-8)/(ut.length-1):0;ht.strokeStyle="#2e6cff",ht.lineWidth=2,ht.beginPath();for(var g=0;g<ut.length;g++){var u=4+g*h,v=st.height-6-ut[g]/b*(st.height-12);g===0?ht.moveTo(u,v):ht.lineTo(u,v)}ht.stroke()}}function rt(){var J=(document.getElementById("dash_mode")||{}).value||"consuntivo",W=s("dash"),ut=a(W.type||"mensile"),st=new Date(W.start).getTime(),ht=new Date(W.end).getTime(),b=document.getElementById("dash_cons"),h=b?b.value:Ct().id;function g(C){return C=Number(C==null?"":C),isFinite(C)?C:0}function u(C){if(!C)return 0;for(var x=["VSDIndiretto","vsdIndiretto","VSD_indiretto","VSDI"],I=0;I<x.length;I++)if(C[x[I]]!=null)return g(C[x[I]]);return C.VSDTotale!=null&&C.VSDPersonale!=null?g(C.VSDTotale)-g(C.VSDPersonale):0}function v(C){return C?C.TotProvvigioni!=null?g(C.TotProvvigioni):g(C.ProvvGI)+g(C.ProvvVSD):0}var y=(function(){var C=oe(new Date(st)),x=oe(new Date(ht)),I="?type="+encodeURIComponent(ut)+"&from="+encodeURIComponent(C)+"&to="+encodeURIComponent(x);return h&&(I+="&userId="+encodeURIComponent(h)),I})();return Mt("/api/periods"+y).then(function(C){for(var x=C&&C.periods||[],I={VSS:0,VSDPersonale:0,VSDIndiretto:0,GI:0,NNCF:0,PROVV:0},M=0;M<x.length;M++){var B=x[M];if(String(B.type)===String(ut)&&!(h&&String(B.userId||B.uid||"")!==String(h))){var L=new Date(B.startDate).getTime(),w=new Date(B.endDate).getTime();if(!(L<st||w>ht)){var A=J==="previsionale"?B.indicatorsPrev||{}:B.indicatorsCons||{};I.VSS+=g(A.VSS),I.VSDPersonale+=g(A.VSDPersonale),I.VSDIndiretto+=u(A),I.GI+=g(A.GI),I.NNCF+=g(A.NNCF),I.PROVV+=v(A)}}}E("kpi_vss",P(I.VSS)),E("kpi_vsd",P(I.VSDPersonale)),E("kpi_vsd_ind",P(I.VSDIndiretto)),E("kpi_gi",P(I.GI)),E("kpi_nncf",R(I.NNCF)),E("kpi_provv",P(I.PROVV))})}function Y(){var J=(document.getElementById("dash_mode")||{}).value||"consuntivo",W=document.getElementById("dash_cons"),ut=W?W.value:Ct().id,st=s("dash"),ht=String(st.type||"mensile").toLowerCase(),b=H(ht),h=typeof l=="function"?l(ht,b):b.map(function(u){return $(new Date(u.s),ht)});function g(u,v){var y=u.map(function(C){return C.y});K(v,h,y)}Promise.all([j("VSS",J,ut||null,st),j("VSDPersonale",J,ut||null,st),j("VSDIndiretto",J,ut||null,st),j("GI",J,ut||null,st),j("NNCF",J,ut||null,st),j("TotProvvigioni",J,ut||null,st)]).then(function(u){g(u[0],"d_mini_vss"),g(u[1],"d_mini_vsdpersonale"),g(u[2],"d_mini_vsdindiretto"),g(u[3],"d_mini_gi"),g(u[4],"d_mini_nncf"),g(u[5],"d_mini_provv")}).catch(function(u){logger.error(u)})}function Q(){var J=document.getElementById("dash_cons"),W=J?J.value:Ct().id,ut=(typeof s=="function"?s("dash"):{})||{},st=typeof a=="function"?a(ut.type||"mensile"):ut.type||"mensile";(function(){var C=document.getElementById("lastApps");if(C){var x=C.parentElement;if(!document.getElementById("nextApps")){var I=document.createElement("div");I.className="card",I.innerHTML='<b>Prossimi appuntamenti</b><div id="nextApps" style="margin-top:8px"></div>',x.parentElement.insertBefore(I,x)}}})();function ht(y){return'<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px">'+y+"</div>"}function b(y){return y=String(y||"").toLowerCase(),y.indexOf("mezza")>-1?240:y.indexOf("giorn")>-1||y.indexOf("formaz")>-1||y.indexOf("mbs")>-1?570:y.indexOf("sottoprod")>-1?240:y.indexOf("riunione")>-1||y.indexOf("impegni personali")>-1?60:(y.indexOf("vend")>-1,90)}function h(y){var C=new Date(y.start),x=new Date(y.end);(!(x instanceof Date)||isNaN(x)||x<C)&&(x=new Date(C.getTime()+b(y.type||"vendita")*6e4));var I=hi(C)+" "+ma(C)+"–"+(("0"+x.getHours()).slice(-2)+":"+("0"+x.getMinutes()).slice(-2)),M=y.nncf?" · NNCF ✅":"",B=String(y.type||"").toLowerCase(),L;return B.indexOf("mbs")>-1?L="VSD ind "+P(y.vsdIndiretto||0):B.indexOf("sottoprod")>-1?L="Tel "+R(y.telefonate||0)+" · AppFissati "+R(y.appFissati||0):B.indexOf("formaz")>-1?L="":L="VSS "+P(y.vss||0)+" · VSD "+P(y.vsdPersonal||0)+M,'<div class="card lastApp" data-aid="'+N(String(y.id||""))+'" style="cursor:pointer"><div class="small muted">'+N(I)+" · "+N(y.type||"manuale")+'</div><div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><div><b>'+N(y.client||"")+'</b></div><div class="row" style="gap:6px"><button class="ghost btn-ics" title="Esporta .ics" data-ics="'+N(String(y.id||""))+'">📅</button></div></div>'+(L?'<div class="small">'+L+"</div>":"")+"</div>"}function g(y){return y&&Object.keys(y).length>0}function u(y){return y=Number(y||0),isFinite(y)?y:0}var v=(function(){var y=oe(new Date(ut.start)),C=oe(new Date(ut.end)),x="?type="+encodeURIComponent(st)+"&from="+encodeURIComponent(y)+"&to="+encodeURIComponent(C);return W&&(x+="&userId="+encodeURIComponent(W)),x})();Promise.all([Mt("/api/appointments"+(Ct()&&Ct().role==="admin"?"?global=1":"")),Mt("/api/periods"+v)]).then(function(y){var C=y[0]&&y[0].appointments||[],x=y[1]&&y[1].periods||[];(function(){var M=document.getElementById("nextApps");if(M){var B=new Date,L=C.filter(function(w){var A=BPTimezone.parseUTCString(w.start).getTime(),V=A>=B.getTime(),U=W?String(w.userId||w.uid||"")===String(W):!0;return V&&U}).sort(function(w,A){return BPTimezone.parseUTCString(w.start)-BPTimezone.parseUTCString(A.start)}).slice(0,4);M.innerHTML=L.length?ht(L.map(h).join("")):'<div class="muted">Nessun prossimo appuntamento</div>',M.querySelectorAll(".lastApp[data-aid]").forEach(function(w){w.addEventListener("click",function(){try{We("bp_edit_aid",w.getAttribute("data-aid"))}catch(A){}p()})}),M.querySelectorAll("button[data-ics]").forEach(function(w){w.addEventListener("click",function(A){A.stopPropagation();var V=w.getAttribute("data-ics"),U=L.find(G=>String(G.id)===String(V))||C.find(G=>String(G.id)===String(V));if(!U){xt("Appuntamento non trovato");return}if(window.BP&&BP.ICS&&typeof BP.ICS.downloadIcsForAppointment=="function")if(BP.ICS.downloadIcsForAppointment(U)){typeof haptic=="function"&&haptic("medium");try{document.dispatchEvent(new Event("ics:exported"))}catch(ct){}xt(".ics esportato")}else xt("Export .ics non disponibile");else xt("Export .ics non disponibile")})})}})(),(function(){var M=document.getElementById("lastApps");if(M){var B=C.filter(function(L){return W?String(L.userId||L.uid||"")===String(W):!0}).sort(function(L,w){return new Date(w.updatedAt||w.createdAt||w.start)-new Date(L.updatedAt||L.createdAt||L.start)}).slice(0,4);M.innerHTML=B.length?ht(B.map(h).join("")):'<div class="muted">Nessun appuntamento</div>',M.querySelectorAll(".lastApp[data-aid]").forEach(function(L){L.addEventListener("click",function(){try{We("bp_edit_aid",L.getAttribute("data-aid"))}catch(w){}p()})}),M.querySelectorAll("button[data-ics]").forEach(function(L){L.addEventListener("click",function(w){w.stopPropagation();var A=L.getAttribute("data-ics"),V=B.find(U=>String(U.id)===String(A))||C.find(U=>String(U.id)===String(A));if(!V){xt("Appuntamento non trovato");return}if(window.BP&&BP.ICS&&typeof BP.ICS.downloadIcsForAppointment=="function")if(BP.ICS.downloadIcsForAppointment(V)){typeof haptic=="function"&&haptic("medium");try{document.dispatchEvent(new Event("ics:exported"))}catch(G){}xt(".ics esportato")}else xt("Export .ics non disponibile");else xt("Export .ics non disponibile")})})}})(),(function(){var M=document.getElementById("lastBPs");if(M){var B=x.filter(function(w){return!(String(w.type)!==String(st)||W&&String(w.userId||w.uid||"")!==String(W))}).sort(function(w,A){return new Date(A.endDate)-new Date(w.endDate)}).slice(0,3),L=B.map(function(w){var A=Be(w.type,w.startDate),V=w.indicatorsPrev||{},U=w.indicatorsCons||{},G=g(U),ct=G?U:V,_t=u(ct.VSS),wt=u(ct.VSDPersonale),yt=u(ct.VSDIndiretto),at=u(ct.GI),dt=u(ct.NNCF),z=wt+yt;return'<div class="card lastBP" data-pid="'+N(String(w.id||""))+'" style="cursor:pointer;flex:1 1 320px"><div style="display:flex;align-items:center;gap:8px"><div><b>'+N(A)+'</b></div><span class="chip small">'+(G?"Consuntivo":"Previsionale")+'</span></div><div class="row" style="margin-top:6px;gap:8px;flex-wrap:wrap"><span class="chip small">VSS <b>'+P(_t)+'</b></span><span class="chip small">VSD <b>'+P(z)+'</b> <span class="muted">(P '+P(wt)+" · I "+P(yt)+')</span></span><span class="chip small">GI <b>'+P(at)+'</b></span><span class="chip small">NNCF <b>'+R(dt)+"</b></span></div></div>"}).join("");M.innerHTML=L?ht(L):'<div class="muted">Nessun BP</div>',M.querySelectorAll(".lastBP[data-pid]").forEach(function(w){w.addEventListener("click",function(){try{We("bp_open_period",{id:w.getAttribute("data-pid"),mode:!1})}catch(A){}f()})})}})()}).catch(function(y){logger.error(y)})}o("dash",function(){typeof haptic=="function"&&haptic("light"),rt(),Y(),Q()});var it=document.getElementById("dash_mode");it&&(it.onchange=function(){typeof haptic=="function"&&haptic("light"),rt(),Y(),Q()});var tt=document.getElementById("dash_cons");tt&&(tt.onchange=function(){typeof haptic=="function"&&haptic("light"),rt(),Y(),Q()}),rt(),Y(),Q(),typeof kickFinal=="function"&&kickFinal("dashboard")}function d(){if(!Ct())return t();document.title="Battle Plan – Calendario";const T=Ct().role==="admin";function D(tt){return ma(tt)}if(!document.getElementById("cal_dynamic_css")){var E='\n      /* ============== CALENDAR ============== */\n      #cal_container{ overflow-x:auto; -webkit-overflow-scrolling:touch; }\n      #cal_container .calendar{ min-width: 860px; }\n\n      .calendar{ display:grid; grid-template-columns: 44px repeat(7, 1fr); gap:10px; }\n      .calendar .weekLabel{ color:var(--muted); font-size:12px; display:flex; align-items:center; justify-content:center; }\n\n      .calendar .day{\n        min-height:120px; background: var(--card);\n        border:2px solid var(--hair2); border-radius:14px; padding:8px;\n        display:flex; flex-direction:column; gap:3px; overflow:hidden;\n      }\n      .calendar .day.today{\n        outline: 2px solid var(--accent);\n        box-shadow: 0 0 0 2px rgba(0,0,0,.06) inset;\n      }\n      .calendar .day .dnum{ font-weight:800; }\n      .calendar .day .small{\n        font-size:12px; line-height:1.15;\n        white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:100%;\n      }\n      .calendar .day .tag{ padding:2px 6px; border-radius:999px; border:1px solid var(--hair2); font-size:11px; align-self:flex-start; }\n      .calendar .day.busy0{ border-color:#27ae60; background:rgba(39,174,96,.08); }\n      .calendar .day.busy1{ border-color:#ff9f1a; background:rgba(255,159,26,.10); }\n      .calendar .day.busy2{ border-color:#7d1731; background:rgba(125,23,49,.12); }\n      .calendar .day.dense .small{ font-size:11px; line-height:1.1; }\n      .calendar .day.dense .tag{ transform:scale(.9); transform-origin:left top; }\n\n      @media (max-width: 900px){\n        .calendar{ grid-template-columns: 36px repeat(7, 1fr); }\n        .calendar .weekLabel{ display:flex !important; font-size:11px; }\n        .calendar .day{ min-height:92px; padding:6px; }\n        .calendar .day .dnum{ font-size:16px; }\n        .calendar .day .small{ white-space: normal !important; overflow: visible !important; text-overflow: clip !important; }\n        .calendar .day.dense .small{ font-size:clamp(9px,2.4vw,11px); }\n        .calendar .day .tag{ font-size:10px; }\n      }\n\n      /* Header filters alignment (desktop + mobile) */\n      #cal_controls{\n        display:flex;\n        flex-direction:column;\n        gap:10px;\n      }\n      #cal_controls .cal-row{\n        display:flex;\n        gap:10px;\n        align-items:flex-end;\n      }\n      #cal_controls .cal-row > *{ flex:1 1 0; }\n      #cal_controls button{ flex:0 0 auto; }\n      .cal-filters{ display:flex; align-items:flex-end; gap:8px; flex-wrap:wrap; }\n      .cal-filters .chip{\n        display:inline-flex; align-items:center; gap:6px;\n        padding:6px 10px; border-radius:999px; border:1px solid var(--hair2);\n      }\n      .cal-filters .chip input[type=checkbox]{ width:16px; height:16px; }\n      @media (max-width: 600px){\n        #cal_controls{\n          display:grid;\n          grid-template-columns: 1fr 1fr 1fr;\n          grid-template-areas:\n            "consult consult consult"\n            "prev month next"\n            "add add add"\n            "free free free"\n            "fourh refresh refresh";\n          align-items:end;\n        }\n        #cal_controls .cal-row{ display:contents; }\n        #cal_consultant_wrap{ grid-area:consult; }\n        #cal_prev{ grid-area:prev; justify-self:start; }\n        #cal_month_wrap{ grid-area:month; }\n        #cal_next{ grid-area:next; }\n        #cal_add{ grid-area:add; justify-self:start; }\n        #only_free{ grid-area:free; }\n        #only_4h{ grid-area:fourh; }\n        #cal_refresh{ grid-area:refresh; justify-self:end; }\n        .cal-filters{ align-items:center; }\n\n        /* Force chips to occupy full width to avoid overlap */\n        #only_free, #only_4h{\n          display:flex !important;\n          width:100% !important;\n          min-width:0 !important;\n          align-items:center;\n        }\n        /* Ensure chips span all columns when areas fallback */\n        #only_free, #only_4h{ grid-column: 1 / -1; }\n        /* Allow buttons to shrink within grid cells */\n        #cal_prev, #cal_next, #cal_add, #cal_refresh{ min-width:0; }\n      }\n    ',P=document.createElement("style");P.id="cal_dynamic_css",P.textContent=E,document.head.appendChild(P)}var R=new Date,N=oe(pi(R)).slice(0,7),$=T?'<div id="cal_consultant_wrap"><label>Consulente</label><select id="cal_consultant"></select></div>':"";n.innerHTML=me()+'<div class="wrap"><div class="card"><div id="cal_controls"><div class="cal-row">'+$+'<button id="cal_prev" class="ghost" title="Mese precedente">◀</button><div id="cal_month_wrap"><label>Mese</label><input type="month" id="cal_month" value="'+N+'"></div><button id="cal_next" class="ghost" title="Mese successivo">▶</button></div><div class="cal-row cal-filters"><button id="cal_add" class="ghost">Aggiungi appuntamento</button><label id="only_free" class="chip small"><input type="checkbox" id="only_free_cb"> Solo giorni liberi</label> <label id="only_4h" class="chip small"><input type="checkbox" id="only_4h_cb"> Solo slot ≥ 4h</label><button id="cal_refresh" class="ghost">Aggiorna</button></div></div></div><div id="cal_container"></div><div id="cal_results" class="card" style="margin-top:8px;display:none"></div><div id="cal_day_box" class="card" style="margin-top:8px;display:none"></div><div class="card" id="cal_free_slots" style="margin-top:8px;display:none"></div></div>',se();var H=document.getElementById("cal_consultant");function nt(){if(H){var tt=Ct()||{};H.innerHTML='<option value="'+zt(tt.id||"")+'">'+zt(tt.name||"")+"</option>",Mt("/api/users").then(function(J){for(var W=J.users||[],ut='<option value="all">Tutti</option>',st=0;st<W.length;st++){var ht=W[st];ut+='<option value="'+zt(ht.id)+'">'+zt(ht.name||ht.email||ht.id)+"</option>"}H.innerHTML=ut,H.value=tt.id}).catch(function(){H.innerHTML='<option value="'+zt(tt.id||"")+'">'+zt(tt.name||"")+"</option>"})}}H&&nt();function j(tt,J,W,ut){var st="/api/appointments"+(Ct()&&Ct().role==="admin"?"?global=1":""),ht="/api/availability?from="+tt+"-"+we(J)+"-01&to="+tt+"-"+we(J)+"-"+we(new Date(tt,J,0).getDate());ut==="all"?(st+="?global=1",ht+="&global=1"):ut&&ut!==Ct().id&&(st+="?user="+ut,ht+="&user="+ut),Promise.all([Mt(st),Mt(ht)]).then(function(b){var h=b[0]&&b[0].appointments?b[0].appointments:[],g=b[1]||{slots:[]},u=g.slots||[],v=new Date(tt,J-1,1),y=new Date(tt,J,0,23,59,59,999);function C(Ot,ee){for(var Pt={vss:0,vsd:0,vsdI:0,telefonate:0,appFissati:0,nncf:0,count:0},Ht=0;Ht<h.length;Ht++){var Vt=h[Ht],ue=BPTimezone.parseUTCString(Vt.start);if(ue>=Ot&&ue<=ee){Pt.vss+=Number(Vt.vss||0),Pt.vsd+=Number(Vt.vsdPersonal||0),Pt.vsdI+=Number(Vt.vsdIndiretto||0),Pt.telefonate+=Number(Vt.telefonate||0),Pt.appFissati+=Number(Vt.appFissati||0),Pt.nncf+=Vt.nncf?1:0;var Gt=String(Vt.type||"").toLowerCase();(Gt.indexOf("vend")>-1||Gt.indexOf("mezza")>-1||Gt.indexOf("giorn")>-1)&&(Pt.count+=1)}}return Pt}function x(Ot,ee,Pt){var Ht=document.getElementById("cal_results");if(Ht){var Vt=Pt?'<div class="right"><button id="res_reset" class="ghost">Torna al mese</button></div>':"";if(Ht.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center"><b>Risultati · '+ee+"</b>"+Vt+'</div><div class="row" style="margin-top:8px;gap:8px;flex-wrap:wrap"><span class="chip small">VSS <b>'+Le(Ot.vss)+'</b></span><span class="chip small">VSD <b>'+Le(Ot.vsd)+'</b></span><span class="chip small">VSD ind <b>'+Le(Ot.vsdI)+'</b></span><span class="chip small">Tel <b>'+ie(Ot.telefonate)+'</b></span><span class="chip small">AppFiss <b>'+ie(Ot.appFissati)+'</b></span><span class="chip small">NNCF <b>'+ie(Ot.nncf)+'</b></span><span class="chip small">N. app <b>'+ie(Ot.count)+"</b></span></div>",Ht.style.display="block",Pt){var ue=document.getElementById("res_reset");ue&&(ue.onclick=function(){x(C(v,y),U,!1)})}}}for(var I={},M=0;M<h.length;M++){var B=h[M],L=BPTimezone.parseUTCString(B.start);if(!(L<v||L>y)){var w=window.BPTimezone&&window.BPTimezone.ymdUTC?window.BPTimezone.ymdUTC(L):oe(L);I[w]||(I[w]={vss:0,vsd:0,vsdI:0,telefonate:0,appFissati:0,nncf:0,mins:0,count:0,items:[]}),I[w].vss+=Number(B.vss||0),I[w].vsd+=Number(B.vsdPersonal||0),I[w].vsdI+=Number(B.vsdIndiretto||0),I[w].telefonate+=Number(B.telefonate||0),I[w].appFissati+=Number(B.appFissati||0),I[w].nncf+=B.nncf?1:0,I[w].mins+=Number(B.durationMinutes||0);var A=String(B.type||"").toLowerCase();(A.indexOf("vend")>-1||A.indexOf("mezza")>-1||A.indexOf("giorn")>-1)&&(I[w].count+=1),I[w].items.push(B)}}var V=["Lun","Mar","Mer","Gio","Ven","Sab","Dom"],U=new Date(tt,J-1,1).toLocaleString("it-IT",{month:"long",year:"numeric"}),G='<div class="card"><b class="neon">'+U+"</b></div>";G+='<div class="calendar">',G+='<div class="weekLabel">W</div>';for(var ct=0;ct<7;ct++)G+='<div class="weekLabel">'+V[ct]+"</div>";var _t=new Date(tt,J-1,1),wt=(_t.getDay()+6)%7,yt=new Date(_t);yt.setDate(_t.getDate()-wt);for(var at=0;at<6;at++){var dt=new Date(yt),z="W"+Qt(dt);G+='<div class="weekLabel" data-ws="'+oe(dt)+'" style="cursor:pointer">'+z+"</div>";for(var ot=0;ot<7;ot++){var ft=yt.getMonth()===J-1,w=window.BPTimezone&&window.BPTimezone.ymdUTC?window.BPTimezone.ymdUTC(yt):oe(yt),lt=I[w]||{vss:0,vsd:0,vsdI:0,telefonate:0,appFissati:0,nncf:0,mins:0,count:0,items:[]},bt=yt.getDay(),It=bt===0||bt===6,Dt=!It&&u.some(function(ee){return ee.date===w});if(ft&&W){if(W.only_free&&lt.count>0){G+="<div></div>",yt.setDate(yt.getDate()+1);continue}if(W.only_4h&&!Dt){G+="<div></div>",yt.setDate(yt.getDate()+1);continue}}if(!ft)G+="<div></div>";else{var Et="";It?lt.count>0&&(Et="busy2"):lt.count===0?Et="busy0":Dt?Et="busy1":Et="busy2";var q="",Z=0;It&&lt.count===0||(lt.vss>0&&(q+='<div class="small">VSS '+Le(lt.vss)+"</div>",Z++),lt.vsd>0&&(q+='<div class="small">VSD '+Le(lt.vsd)+"</div>",Z++),lt.vsdI>0&&(q+='<div class="small">VSD ind '+Le(lt.vsdI)+"</div>",Z++),lt.telefonate>0&&(q+='<div class="small">Tel '+ie(lt.telefonate)+"</div>",Z++),lt.appFissati>0&&(q+='<div class="small">AppFiss '+ie(lt.appFissati)+"</div>",Z++),lt.nncf>0&&(q+='<div class="small">NNCF '+ie(lt.nncf)+"</div>",Z++),lt.count>0&&(q+='<div class="small">App. '+ie(lt.count)+"</div>",Z++),Dt&&(q+='<div class="tag" style="margin-top:4px">slot ≥4h</div>',Z++));var pt=Z>=3?" dense":"",gt=Dt?" slot-free":"";G+='<div class="day '+Et+pt+gt+'" data-day="'+w+'" title="Settimana '+Qt(yt)+'"><div class="dnum">'+yt.getDate()+"</div>"+(q||"")+"</div>"}yt.setDate(yt.getDate()+1)}}G+="</div>",document.getElementById("cal_container").innerHTML=G,x(C(v,y),U,!1),document.querySelectorAll(".calendar .weekLabel[data-ws]").forEach(function(Ot){Ot.addEventListener("click",function(){var ee=Ot.getAttribute("data-ws"),Pt=new Date(ee),Ht=new Date(Pt);Ht.setDate(Ht.getDate()+6),Ht.setHours(23,59,59,999);var Vt="Settimana "+("W"+Qt(Pt))+" · "+hi(Pt)+"–"+hi(Ht);x(C(Pt,Ht),Vt,!0)})}),document.querySelectorAll(".day[data-day]").forEach(function(Ot){Ot.addEventListener("click",function(){var ee=Ot.getAttribute("data-day"),Pt=I[ee]&&I[ee].items?I[ee].items.slice():[];Pt.sort(function(ve,Wt){return BPTimezone.parseUTCString(ve.start)-BPTimezone.parseUTCString(Wt.start)});var Ht=document.getElementById("cal_day_box"),Vt="<b>Appuntamenti del "+ee.split("-").reverse().join("/")+"</b>";if(!Pt.length)Vt+='<div class="muted" style="margin-top:6px">Nessun appuntamento</div>';else{Vt+='<div class="row" style="margin-top:8px">';for(var ue=0;ue<Pt.length;ue++){var Gt=Pt[ue],Yi=' data-start="'+Gt.start+'" data-end="'+Gt.end+'" data-title="'+zt(Gt.client||"Appuntamento")+'" ',_n=String(Gt.type||"").toLowerCase(),He;_n.indexOf("mbs")>-1?He="VSD ind "+Le(Gt.vsdIndiretto||0):_n.indexOf("sottoprod")>-1?He="Tel "+ie(Gt.telefonate||0)+" · AppFissati "+ie(Gt.appFissati||0):_n.indexOf("formaz")>-1?He="":He="VSS "+Le(Gt.vss)+" · VSD "+Le(Gt.vsdPersonal)+" · NNCF "+(Gt.nncf?"✅":"—"),Vt+='<div class="card cal-app" data-aid="'+Gt.id+'" '+Yi+' style="flex:1 1 320px;cursor:pointer"><div class="small muted">'+D(Gt.start)+"–"+D(Gt.end)+" · "+zt(Gt.type||"")+"</div><div><b>"+zt(Gt.client||"")+"</b></div>"+(He?'<div class="small">'+He+"</div>":"")+(Gt.notes?'<div class="small muted">'+zt(Gt.notes)+"</div>":"")+"</div>"}Vt+="</div>"}var xn=(u||[]).filter(function(ve){return ve.date===ee});if(xn.length){Vt+='<div class="row" style="margin-top:8px">';for(var Sn=0;Sn<xn.length;Sn++){var Qe=xn[Sn],$i=Qe.part==="morning"?"mattina":"pomeriggio";Vt+='<div class="card slotBtn" data-start="'+Qe.start+'" data-end="'+Qe.end+'" style="flex:1 1 280px;cursor:pointer"><div class="small">'+$i+" · "+D(Qe.start)+"–"+D(Qe.end)+"</div></div>"}Vt+="</div>"}if(Ht.style.display="block",Ht.innerHTML=Vt,Ht.querySelectorAll(".cal-app").forEach(function(ve){ve.addEventListener("click",function(Wt){Wt.stopPropagation(),We("bp_edit_aid",ve.getAttribute("data-aid")),p()})}),Ht.querySelectorAll(".slotBtn").forEach(function(ve){ve.addEventListener("click",function(Wt){Wt.stopPropagation(),We("bp_prefill_slot",{start:ve.getAttribute("data-start"),end:ve.getAttribute("data-end")}),p(),xt("Slot precompilato negli appuntamenti")})}),window.scrollTo({top:Ht.getBoundingClientRect().top+window.scrollY-80,behavior:"smooth"}),typeof window.wireICSInsideDayBox=="function")try{window.wireICSInsideDayBox()}catch(ve){}})});var vt=document.getElementById("cal_free_slots"),kt=(function(){var Ot=new Date;return Ot.getFullYear()+"-"+we(Ot.getMonth()+1)+"-"+we(Ot.getDate())})(),St=(u||[]).filter(function(Ot){return String(Ot.date||"").slice(0,10)>=kt});if(ut==="all"){var Rt=g.details||[],Lt="<b>Slot liberi ≥ 4h per consulente (da oggi in poi)</b>";Lt+='<div class="row" style="margin-top:8px;gap:8px;flex-wrap:wrap">';for(var Kt=0;Kt<Rt.length;Kt++){var yt=Rt[Kt];Lt+='<span class="chip small">'+zt(yt.name||"")+" <b>"+ie(yt.total||0)+"</b></span>"}Lt+="</div>",vt.style.display="block",vt.innerHTML=Lt}else if(St.length){var de='<b>Slot liberi ≥ 4h (da oggi in poi)</b> · <span class="badge">Tot: '+St.length+"</span>";de+='<div class="row" style="margin-top:8px">';for(var Pe=0;Pe<St.length&&Pe<80;Pe++){var L=St[Pe],pn=L.part==="morning"?"mattina":"pomeriggio";de+='<div class="card slotBtn" data-start="'+L.start+'" data-end="'+L.end+'" style="flex:1 1 280px;cursor:pointer"><div class="small"><b>'+hi(L.start)+"</b> · "+pn+'</div><div class="small">'+D(L.start)+"–"+D(L.end)+"</div></div>"}de+="</div>",vt.style.display="block",vt.innerHTML=de,vt.querySelectorAll(".slotBtn").forEach(function(Ot){Ot.addEventListener("click",function(){We("bp_prefill_slot",{start:Ot.getAttribute("data-start"),end:Ot.getAttribute("data-end")}),p(),xt("Slot precompilato negli appuntamenti")})})}else vt.style.display="block",vt.innerHTML='<b>Slot liberi ≥ 4h (da oggi in poi)</b> · <span class="badge">Tot: 0</span><div class="muted" style="margin-top:6px">Nessuno slot libero disponibile.</div>';try{window.injectTodayCSS&&window.injectTodayCSS()}catch(Ot){}try{window.hookCalendar?window.hookCalendar():(window.markToday&&window.markToday(),window.clampSlotCounters&&window.clampSlotCounters())}catch(Ot){}}).catch(function(b){logger.error(b),xt("Errore calendario")})}function K(){var tt=document.getElementById("cal_month").value,J=parseInt(tt.split("-")[0],10),W=parseInt(tt.split("-")[1],10),ut={only_free:document.getElementById("only_free_cb").checked,only_4h:document.getElementById("only_4h_cb").checked},st=document.getElementById("cal_consultant"),ht=st?st.value:Ct().id;j(J,W,ut,ht)}document.getElementById("cal_refresh").onclick=K;var rt=document.getElementById("cal_add");rt&&(rt.onclick=function(){p()}),document.getElementById("cal_month").onchange=K;function Y(tt){var J=document.getElementById("cal_month");if(J){var W=J.value.split("-"),ut=+W[0],st=+W[1];st+=tt,st<=0?(st=12,ut--):st>12&&(st=1,ut++),J.value=ut+"-"+we(st),K()}}var Q=document.getElementById("cal_prev"),it=document.getElementById("cal_next");Q&&(Q.onclick=function(){Y(-1)}),it&&(it.onclick=function(){Y(1)}),document.getElementById("only_free_cb").onchange=K,document.getElementById("only_4h_cb").onchange=K,H&&(H.onchange=K),K()}function f(){if(!Ct())return t();document.title="Battle Plan – BP",n.innerHTML=me()+'<div class="wrap"><div class="card"><b>Da inviare</b><div id="bp_to_send" class="grid" style="margin-top:8px"></div></div><div class="card" id="bp_sent_box" style="margin-top:8px"><div id="bp_sent_head" style="display:flex;align-items:center;justify-content:space-between;cursor:pointer"><b>BP inviati (periodi in essere)</b><span id="bp_sent_chev" class="chev">▸</span></div><div id="bp_sent" class="row" style="margin-top:8px;display:none"></div></div><div class="card" style="margin-top:8px"><b>Crea/Aggiorna BP</b><div class="row" style="margin-top:8px"><div><label>Tipo</label><select id="p_type"><option value="settimanale">Settimanale (lun–dom)</option><option value="mensile">Mensile</option><option value="trimestrale">Trimestrale</option><option value="semestrale">Semestrale</option><option value="annuale">Annuale</option></select></div><div id="wrap_week" style="display:none"><label>Settimana ISO (1–53)</label><input type="number" id="p_week" min="1" max="53" value="'+Qt(new Date)+'"></div><div id="wrap_month" style="display:none"><label>Mese</label><select id="p_month"><option value="1">Gennaio</option><option value="2">Febbraio</option><option value="3">Marzo</option><option value="4">Aprile</option><option value="5">Maggio</option><option value="6">Giugno</option><option value="7">Luglio</option><option value="8">Agosto</option><option value="9">Settembre</option><option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option></select></div><div id="wrap_quarter" style="display:none"><label>Trimestre</label><select id="p_quarter"><option value="1">T1</option><option value="2">T2</option><option value="3">T3</option><option value="4">T4</option></select></div><div id="wrap_semester" style="display:none"><label>Semestre</label><select id="p_sem"><option value="1">1° semestre</option><option value="2">2° semestre</option></select></div><div><label>Anno</label><input type="number" id="p_year" min="2000" max="2100" value="'+new Date().getFullYear()+'"></div></div><div class="row"><div class="small muted">Modalità: <b id="p_mode_lbl">Previsionale</b> · <button class="ghost" id="btnImport" style="padding:4px 8px">Importa da agenda</button></div></div><div class="row" style="align-items:center"><div class="small"><b>Periodo selezionato:</b> <span id="p_label" class="neon">—</span></div><input type="hidden" id="p_start"><input type="hidden" id="p_end"></div><div class="row small" style="margin-top:6px;opacity:.9"><div><b>Previsionale</b></div><div><b>Consuntivo</b></div><div><b>Avanzamento</b></div></div><div class="row" id="p_rows" style="margin-top:4px"></div><div class="row" style="margin-top:8px;align-items:center;gap:8px;justify-content:space-between"><div id="p_delete_zone"></div><div class="right"><button id="btnSaveP">Salva BP</button></div></div></div><div class="card"><b>BP salvati</b><div id="p_list" class="row" style="margin-top:8px"></div></div></div>',se();var T=!1,D=null,E=[],P=null,R=Ct()||{};function N(q){return String(q).replace(/[&<>'"]/g,Z=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[Z])}function $(q){if(!q)return"";var Z=new Date(q);return Z.getFullYear()+"-"+("0"+(Z.getMonth()+1)).slice(-2)+"-"+("0"+Z.getDate()).slice(-2)}function H(q){var Z=new Date(q);return("0"+Z.getDate()).slice(-2)+"/"+("0"+(Z.getMonth()+1)).slice(-2)+"/"+Z.getFullYear()}function nt(q){var Z=Number(q)||0;return Z.toLocaleString("it-IT")+"€"}function j(q){var Z=document.createElement("div");return Z.innerHTML=q.trim(),Z.firstChild}function K(q){return!!(q&&q.indicatorsCons&&Object.keys(q.indicatorsCons).length>0)}function rt(){return R&&R.grade?Promise.resolve(R):Mt("/api/usernames").then(function(q){var Z=String((Ct()||{}).id||""),pt=(q&&q.users||[]).find(function(gt){return String(gt.id)===Z});return pt&&pt.grade&&(R.grade=pt.grade),R}).catch(function(){return R})}function Y(){var q=R&&R.grade||(Ct()||{}).grade;return q==="senior"?"senior":"junior"}rt();var Q=document.getElementById("p_type"),it=document.getElementById("p_year"),tt=document.getElementById("wrap_week"),J=document.getElementById("wrap_month"),W=document.getElementById("wrap_quarter"),ut=document.getElementById("wrap_semester"),st=document.getElementById("p_week"),ht=document.getElementById("p_month"),b=document.getElementById("p_quarter"),h=document.getElementById("p_sem"),g=document.getElementById("p_label"),u=document.getElementById("p_start"),v=document.getElementById("p_end"),y=document.getElementById("p_mode_lbl"),C=document.getElementById("btnImport");function x(q){T=!!q,y.textContent=T?"Consuntivo":"Previsionale";var Z=document.querySelectorAll("[data-row]");Z.forEach(function(pt){var gt=pt.querySelector("[data-prev]"),vt=pt.querySelector("[data-cons]"),kt=pt.querySelector("[data-bar]");if(T){if(gt){gt.removeAttribute("hidden");var St=gt.querySelector("input");St&&(St.setAttribute("readonly","readonly"),St.classList.add("disabled"))}if(vt){vt.removeAttribute("hidden");var Rt=vt.querySelector("input");Rt&&(Rt.removeAttribute("readonly"),Rt.classList.remove("disabled"))}kt&&kt.removeAttribute("hidden")}else{if(gt){gt.removeAttribute("hidden");var Lt=gt.querySelector("input");Lt&&(Lt.removeAttribute("readonly"),Lt.classList.remove("disabled"))}vt&&vt.setAttribute("hidden","hidden"),kt&&kt.setAttribute("hidden","hidden")}}),dt()}function I(){var q=Q.value;tt.style.display=q==="settimanale"?"":"none",J.style.display=q==="mensile"?"":"none",W.style.display=q==="trimestrale"?"":"none",ut.style.display=q==="semestrale"?"":"none",M()}function M(){var q=Q.value,Z=parseInt(it.value,10),pt,gt,vt;if(q==="settimanale"){var kt=Math.max(1,Math.min(53,parseInt(st.value||"1",10))),St=sn(Z,kt);pt=St.start,gt=St.end,vt="Sett. "+kt+" · "+H(pt)+" → "+H(gt)}else if(q==="mensile"){var Rt=parseInt(ht.value,10);pt=new Date(Z,Rt-1,1),gt=new Date(Z,Rt,0),vt=pt.toLocaleString("it-IT",{month:"long",year:"numeric"})+" · "+H(pt)+" → "+H(gt)}else if(q==="trimestrale"){var Lt=parseInt(b.value,10);pt=new Date(Z,(Lt-1)*3,1),gt=new Date(Z,Lt*3,0),vt="Trimestre "+Lt+" "+Z+" · "+H(pt)+" → "+H(gt)}else if(q==="semestrale"){var Kt=parseInt(h.value,10);pt=new Date(Z,Kt===1?0:6,1),gt=new Date(Z,Kt===1?6:12,0),vt=(Kt===1?"1°":"2°")+" semestre "+Z+" · "+H(pt)+" → "+H(gt)}else pt=new Date(Z,0,1),gt=new Date(Z,11,31),vt="Anno "+Z+" · "+H(pt)+" → "+H(gt);u.value=$(pt),v.value=$(gt),g.textContent=vt,x(!1),D=null,P=null,V(),dt()}function B(q){for(var Z="",pt=0;pt<q.length;pt++){var gt=q[pt],vt=/^(VSS|VSDPersonale|VSDIndiretto|GI)$/i.test(gt);Z+='<div class="row" data-row="'+gt+'"><div data-prev><label>'+gt+' (Prev)</label><input type="number" step="1" id="prev_'+gt+'" placeholder="'+(vt?"€":"n")+'"></div><div data-cons><label>'+gt+' (Cons)</label><input type="number" step="1" id="cons_'+gt+'" placeholder="'+(vt?"€":"n")+'"></div><div data-bar class="small"><div style="height:10px;background:rgba(255,255,255,.12);border-radius:999px;overflow:hidden"><div id="bar_'+gt+'" style="height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2));"></div></div><div id="pct_'+gt+'" class="small muted">0%</div></div></div>'}document.getElementById("p_rows").innerHTML=Z,x(!1),w(),L()}function L(){for(var q=0;q<E.length;q++){var Z=E[q],pt=document.getElementById("prev_"+Z),gt=document.getElementById("cons_"+Z);if(!(!pt||!gt)){var vt=Number(pt.value||0),kt=Number(gt.value||0),St=vt>0?Math.round(kt/vt*100):kt>0?100:0;St=Math.max(0,Math.min(200,St));var Rt=document.getElementById("bar_"+Z),Lt=document.getElementById("pct_"+Z);Rt&&(Rt.style.width=Math.min(St,100)+"%"),Lt&&(Lt.textContent=St+"%")}}}function w(){for(var q=0;q<E.length;q++)(function(Z){var pt=document.getElementById("prev_"+Z),gt=document.getElementById("cons_"+Z);pt&&(pt.oninput=L),gt&&(gt.oninput=L)})(E[q])}function A(){for(var q=0;q<E.length;q++){var Z=document.getElementById("prev_"+E[q]);Z&&(Z.value="")}L()}function V(){for(var q=0;q<E.length;q++){var Z=document.getElementById("cons_"+E[q]);Z&&(Z.value="")}L()}function U(q){for(var Z in q){var pt=document.getElementById("prev_"+Z);pt&&(pt.value=String(q[Z]||0))}L()}function G(q){for(var Z in q){var pt=document.getElementById("cons_"+Z);pt&&(pt.value=String(q[Z]||0))}L()}function ct(){var q=u.value,Z=v.value;if(!q||!Z){xt("Seleziona il periodo");return}Mt("/api/appointments"+(Ct()&&Ct().role==="admin"?"?global=1":"")).then(function(pt){for(var gt=pt.appointments||[],vt=new Date(q),kt=new Date(Z),St={VSS:0,VSDPersonale:0,VSDIndiretto:0,GI:0,Telefonate:0,AppFissati:0,AppFatti:0,CorsiLeadership:0,iProfile:0,MBS:0,NNCF:0},Rt=0;Rt<gt.length;Rt++){var Lt=gt[Rt],Kt=BPTimezone.parseUTCString(Lt.start);if(Kt>=vt&&Kt<=kt){St.VSS+=Number(Lt.vss||0),St.VSDPersonale+=Number(Lt.vsdPersonal||0),St.VSDIndiretto+=Number(Lt.vsdIndiretto||0),St.Telefonate+=Number(Lt.telefonate||0),St.AppFissati+=Number(Lt.appFissati||0);var de=String(Lt.type||"").toLowerCase();(de.indexOf("vend")>-1||de.indexOf("mezza")>-1||de.indexOf("giorn")>-1)&&(St.AppFatti+=1),Lt.nncf&&(St.NNCF+=1)}}T?(G(St),xt("Consuntivo compilato dalla tua agenda")):(U(St),xt("Previsionale compilato dalla tua agenda"),mi(),window.addXP(10))}).catch(function(){xt("Errore import agenda")})}function _t(q,Z){q=Object.assign({},q||{});var pt=Number(q.GI||0),gt=Number(q.VSDPersonale||0),vt=pt*.15,kt=gt*(String(Z)==="senior"?.25:.2);return q.ProvvGI=Math.round(vt*100)/100,q.ProvvVSD=Math.round(kt*100)/100,q.TotProvvigioni=Math.round((q.ProvvGI+q.ProvvVSD)*100)/100,q}function wt(q,Z,pt){return fetch(Z,{method:q,headers:pt?{"Content-Type":"application/json"}:void 0,body:pt?JSON.stringify(pt):void 0}).then(function(gt){return gt.ok?gt.json().catch(function(){return{}}):Promise.reject(new Error("HTTP "+gt.status))})}function yt(q){for(var Z=encodeURIComponent(q),pt=[function(){return wt("POST","/api/periods/delete",{id:q})},function(){return wt("POST","/api/periods",{id:q,_delete:!0})},function(){return wt("POST","/api/periods/"+Z,{_method:"DELETE"})},function(){return wt("DELETE","/api/periods/"+Z,null)},function(){return wt("DELETE","/api/periods?id="+Z,null)}],gt=Promise.reject(new Error("start")),vt=0;vt<pt.length;vt++)(function(kt){gt=gt.catch(kt)})(pt[vt]);return gt.catch(function(kt){throw logger.warn("Delete fallback: tutte le route fallite",kt),kt})}function at(q){return P?{id:D||P.id,type:P.type,startDate:$(P.startDate),endDate:$(P.endDate),indicatorsPrev:Object.assign({},P.indicatorsPrev||{}),indicatorsCons:q!=null?q:Object.assign({},P.indicatorsCons||{})}:null}function dt(){var q=document.getElementById("p_delete_zone");if(q){if(!D){q.innerHTML="";return}var Z=!!(P&&K(P)),pt="";Z&&(pt+='<button id="btnDelCons" class="ghost" style="border-color:#7d1731;color:#7d1731">Elimina Consuntivo</button> '),pt+='<button id="btnDelBP" class="ghost" style="border-color:#7d1731;color:#7d1731">Elimina BP</button>',q.innerHTML=pt;var gt=document.getElementById("btnDelBP");gt&&(gt.onclick=function(){if(confirm("Eliminare definitivamente questo BP?")){gt.disabled=!0;var kt=P?JSON.parse(JSON.stringify(P)):null;yt(D).then(function(){xt("BP eliminato");try{document.dispatchEvent(new Event("bp:deleted"))}catch(Rt){}if(D=null,P=null,A(),V(),x(!1),M(),ot(),typeof showUndo=="function"&&kt){var St={type:kt.type,startDate:$(kt.startDate),endDate:$(kt.endDate),indicatorsPrev:Object.assign({},kt.indicatorsPrev||{}),indicatorsCons:Object.assign({},kt.indicatorsCons||{})};showUndo("BP eliminato",function(){return he("/api/periods",St).then(function(){try{document.dispatchEvent(new Event("bp:saved"))}catch(Rt){}ot()})},5e3)}}).catch(function(){xt("Endpoint delete non disponibile")}).finally(function(){gt.disabled=!1})}});var vt=document.getElementById("btnDelCons");vt&&(vt.onclick=function(){if(confirm("Rimuovere solo il Consuntivo?")){vt.disabled=!0;var kt=P?JSON.parse(JSON.stringify(P.indicatorsCons||{})):null,St=at({});if(!St){vt.disabled=!1;return}var Rt=Y();St.indicatorsPrev=_t(St.indicatorsPrev,Rt),St.indicatorsCons={},he("/api/periods",St).then(function(){xt("Consuntivo eliminato");try{document.dispatchEvent(new Event("bp:saved"))}catch(Kt){}if(P&&(P.indicatorsCons={}),x(!0),ot(),dt(),typeof showUndo=="function"&&kt){var Lt=at(kt);showUndo("Consuntivo eliminato",function(){return he("/api/periods",Lt).then(function(){try{document.dispatchEvent(new Event("bp:saved"))}catch(Kt){}P&&(P.indicatorsCons=kt),ot(),dt()})},5e3)}}).catch(function(){xt("Errore eliminazione Consuntivo")}).finally(function(){vt.disabled=!1})}})}}function z(){var q=Q.value,Z=u.value,pt=v.value;if(!Z||!pt){xt("Seleziona il periodo");return}for(var gt={},vt={},kt=0;kt<E.length;kt++){var St=E[kt];gt[St]=Number(document.getElementById("prev_"+St).value||0),T&&(vt[St]=Number(document.getElementById("cons_"+St).value||0))}var Rt=Y();gt=_t(gt,Rt),T&&(vt=_t(vt,Rt));var Lt={type:q,startDate:Z,endDate:pt,indicatorsPrev:gt};T&&(Lt.indicatorsCons=vt),D&&(Lt.id=D),he("/api/periods",Lt).then(function(Kt){xt("BP salvato"),T?window.addXP(20):window.addXP(10),mi();try{document.dispatchEvent(new Event("bp:saved"))}catch(de){}ot(),!D&&Kt&&Kt.id&&(D=Kt.id),D&&P&&(P.indicatorsPrev=gt,T&&(P.indicatorsCons=vt)),dt()}).catch(function(){xt("Errore salvataggio BP")})}function ot(){Mt("/api/periods").then(function(q){var Z=q.periods||[];Z.sort(function(Pt,Ht){return new Date(Ht.startDate)-new Date(Pt.startDate)});for(var pt={settimanale:[],mensile:[],trimestrale:[],semestrale:[],annuale:[]},gt=0;gt<Z.length;gt++){var vt=Z[gt],kt=Be(vt.type,vt.startDate)+" · "+H(vt.startDate)+" → "+H(vt.endDate),St='<div class="card" style="flex:1 1 360px"><div><b>'+N(kt)+'</b></div><div class="small">Prev VSS '+nt((vt.indicatorsPrev||{}).VSS||0)+" · Cons "+nt((vt.indicatorsCons||{}).VSS||0)+'</div><div class="right" style="margin-top:6px"><button class="ghost" data-edit="'+vt.id+'">Modifica previs.</button><button data-cons="'+vt.id+'">Consuntivo…</button></div></div>';pt[vt.type]&&pt[vt.type].push(St)}for(var Rt=["settimanale","mensile","trimestrale","semestrale","annuale"],Lt={settimanale:"Settimanali",mensile:"Mensili",trimestrale:"Trimestrali",semestrale:"Semestrali",annuale:"Annuali"},Kt="",de=0;de<Rt.length;de++){var Pe=Rt[de],pn=pt[Pe].join("");pn&&(Kt+="<details><summary>"+Lt[Pe]+'</summary><div class="row">'+pn+"</div></details>")}document.getElementById("p_list").innerHTML=Kt||'<div class="muted">Nessun BP</div>',document.querySelectorAll("[data-edit]").forEach(function(Pt){Pt.addEventListener("click",function(){var Ht=Pt.getAttribute("data-edit"),Vt=(q.periods||[]).find(function(ue){return ue.id===Ht});Vt&&ft(Vt,!1)})}),document.querySelectorAll("[data-cons]").forEach(function(Pt){Pt.addEventListener("click",function(){var Ht=Pt.getAttribute("data-cons"),Vt=(q.periods||[]).find(function(ue){return ue.id===Ht});Vt&&ft(Vt,!0)})}),Et(Z);var Ot=Di("bp_open_period",null);if(Ot){Vn("bp_open_period");var ee=Z.find(function(Pt){return Pt.id===Ot.id});ee&&ft(ee,Ot.mode===!0)}})}function ft(q,Z){P=q||null,Q.value=q.type;var pt=new Date(q.startDate),gt=pt.getFullYear();if(it.value=String(gt),q.type==="settimanale")st.value=String(Qt(pt));else if(q.type==="mensile")ht.value=String(pt.getMonth()+1);else if(q.type==="trimestrale"){var vt=Math.floor(pt.getMonth()/3)+1;b.value=String(vt)}else q.type==="semestrale"&&(h.value=pt.getMonth()<6?"1":"2");I(),A(),V(),U(q.indicatorsPrev||{}),G(q.indicatorsCons||{}),x(!!Z),D=q.id||null,dt(),xt(Z?"Compila il consuntivo":"Modifica previsionale"),window.scrollTo({top:0,behavior:"smooth"})}function lt(q,Z){Z=Z||new Date;var pt=Z.getFullYear();if(q==="settimanale"){var gt=sn(pt,Qt(Z));return{start:gt.start,end:gt.end}}return q==="mensile"?{start:pi(Z),end:lo(Z)}:q==="trimestrale"?{start:Un(Z),end:co(Z)}:q==="semestrale"?{start:Hn(Z),end:uo(Z)}:{start:Ti(Z),end:Ii(Z)}}function bt(q,Z){return Z=Z||new Date,q==="settimanale"?Xf(Z):q==="mensile"?Kf(Z):q==="trimestrale"?Jf(Z):q==="semestrale"?Zf(Z):Qf(Z)}function It(q){var Z=sn(new Date().getFullYear(),Qt(new Date)),pt=Z.start,gt=Math.floor((new Date(q)-pt)/(1e3*60*60*24));return gt<=13}function Dt(q,Z,pt,gt,vt,kt){var St=Be(Z,pt),Rt=j('<div class="card" style="position:relative"><div class="small muted">'+N(q)+"</div><div><b>"+N(St)+'</b></div><div class="small muted">'+H(pt)+" → "+H(gt)+'</div><div class="right" style="margin-top:6px"><button class="ghost" type="button" data-sug="1">'+N(vt)+"</button></div></div>");return Rt.querySelector("[data-sug]").addEventListener("click",kt),Rt}function Et(q){var Z=document.getElementById("bp_to_send"),pt=document.getElementById("bp_sent");Z.innerHTML="",pt.innerHTML="";function gt(Wt,fe,Zt){return q.find(function(De){return De.type===Wt&&$(De.startDate)===$(fe)&&$(De.endDate)===$(Zt)})}var vt=new Date,kt=vt.getDay(),St=kt===5||kt===6||kt===0,Rt=lo(vt),Lt=co(vt),Kt=uo(vt),de=Ii(vt),Pe=St&&It(Rt),pn=St&&It(Lt),Ot=St&&It(Kt),ee=St&&It(de);["settimanale","mensile","trimestrale","semestrale","annuale"].forEach(function(Wt){var fe=lt(Wt,vt),Zt=gt(Wt,fe.start,fe.end);if(Zt){var De=j('<div class="card" style="flex:1 1 360px"><div><b>'+N(Be(Wt,fe.start))+'</b></div><div class="small muted">'+H(fe.start)+" → "+H(fe.end)+'</div><div class="right" style="margin-top:6px"><button class="ghost" type="button" data-edit="'+Zt.id+'">Modifica previs.</button><button type="button" data-cons="'+Zt.id+'">Consuntivo…</button></div></div>');De.querySelector("[data-edit]").addEventListener("click",function(){ft(Zt,!1)}),De.querySelector("[data-cons]").addEventListener("click",function(){ft(Zt,!0)}),pt.appendChild(De)}});function Pt(Wt,fe,Zt){var De=gt(Wt,Zt.start,Zt.end),qi=gt(Wt,fe.start,fe.end);De?Z.appendChild(Dt("Previsionale",Wt,Zt.start,Zt.end,"Modifica",function(){ft(De,!1)})):Z.appendChild(Dt("Previsionale",Wt,Zt.start,Zt.end,"Compila",function(){if(Q.value=Wt,it.value=String(Zt.start.getFullYear()),Wt==="settimanale")st.value=String(Qt(Zt.start));else if(Wt==="mensile")ht.value=String(Zt.start.getMonth()+1);else if(Wt==="trimestrale"){var Tr=Math.floor(Zt.start.getMonth()/3)+1;b.value=String(Tr)}else Wt==="semestrale"&&(h.value=Zt.start.getMonth()<6?"1":"2");I()})),qi&&!K(qi)&&Z.appendChild(Dt("Consuntivo",Wt,fe.start,fe.end,"Consuntivo",function(){ft(qi,!0)}))}if(St){var Ht=lt("settimanale",vt),Vt=bt("settimanale",vt);Pt("settimanale",Ht,Vt)}if(Pe){var ue=lt("mensile",vt),Gt=bt("mensile",vt);Pt("mensile",ue,Gt)}if(pn){var Yi=lt("trimestrale",vt),_n=bt("trimestrale",vt);Pt("trimestrale",Yi,_n)}if(Ot){var He=lt("semestrale",vt),xn=bt("semestrale",vt);Pt("semestrale",He,xn)}if(ee){var Sn=lt("annuale",vt),Qe=bt("annuale",vt);Pt("annuale",Sn,Qe)}Z.children.length||(Z.innerHTML='<div class="muted">Nessun suggerimento attivo in questo momento</div>');var $i=document.getElementById("bp_sent_head"),ve=document.getElementById("bp_sent_chev");$i.onclick=function(){var Wt=document.getElementById("bp_sent"),fe=Wt.style.display!=="none";Wt.style.display=fe?"none":"",ve.textContent=fe?"▸":"▾"}}Mt("/api/settings").then(function(q){E=q&&q.indicators||["VSS","VSDPersonale","VSDIndiretto","GI","Telefonate","AppFissati","AppFatti","CorsiLeadership","iProfile","MBS","NNCF"],B(E)}).catch(function(){E=["VSS","VSDPersonale","GI","NNCF"],B(E)}),Q.onchange=I,it.oninput=M,st.oninput=M,ht.onchange=M,b.onchange=M,h.onchange=M,C.onclick=ct,document.getElementById("btnSaveP").onclick=z,I(),ot()}function p(){if(!Ct())return t();if(document.title="Battle Plan – Appuntamenti",!document.getElementById("appts_css")){const w=document.createElement("style");w.id="appts_css",w.textContent="\n      .appt-type .seg, #a_nncf.seg{\n        padding:8px 12px;border:1px solid #bcd7ff;border-radius:12px;\n        background:#eef5ff;color:#1463ff;cursor:pointer;user-select:none;\n        transition:.15s;\n      }\n      .appt-type .seg.active, #a_nncf.seg.active{\n        background:var(--accent);color:#fff;border-color:var(--accent);\n        box-shadow:0 0 0 2px rgba(20,99,255,.08) inset;\n      }\n      .appt-type > div{display:flex;flex-wrap:wrap;gap:8px;margin-top:4px}\n      .appt-row-end-dur{display:flex;gap:8px;align-items:flex-end}\n      #a_desc{width:100%;min-height:3.2em}\n      #a_list .grid3{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}\n    ",document.head.appendChild(w)}n.innerHTML=me()+'<div class="wrap"><div class="card"><b id="a_form_title">Nuovo appuntamento</b><div class="row" style="margin-top:8px;align-items:flex-end;gap:12px;flex-wrap:wrap"><div style="min-width:320px"><label>Cliente *</label><div style="display:flex;gap:8px;align-items:center"><input id="a_client" list="clientList" placeholder="Denominazione" style="flex:1"><datalist id="clientList"></datalist><button id="a_nncf" class="seg" data-active="0" aria-pressed="false">NNCF</button></div></div><div><label>Data/ora inizio</label><input id="a_start" type="datetime-local"></div><div class="appt-row-end-dur"><div><label>Ora fine</label><input id="a_end" type="time"></div><div><label>Durata (min)</label><input id="a_dur" type="number" placeholder="60" min="1" style="width:80px"></div></div></div><div style="margin-top:8px"><label>Descrizione appuntamento</label><textarea id="a_desc" rows="2" style="width:100%;min-height:3.2em"></textarea></div><div class="row" style="align-items:flex-end;gap:12px;flex-wrap:wrap"><div class="appt-type"><label>Tipo</label><div><button type="button" id="t_vendita" class="seg">Vendita</button><button type="button" id="t_mezza"   class="seg" data-vsd="1000">Mezza giornata</button><button type="button" id="t_full"    class="seg" data-vsd="2000">Giornata intera</button><button type="button" id="t_form"    class="seg">Formazione</button><button type="button" id="t_mbs"     class="seg">MBS</button><button type="button" id="t_sotto"   class="seg">Sottoprodotti</button><button type="button" id="t_riunione" class="seg">Riunione</button><button type="button" id="t_impegni"  class="seg">Impegni personali</button></div><input id="a_type" type="hidden" value="vendita"></div><div id="row_vss"><label>VSS</label><input id="a_vss" type="number" step="1" placeholder="0"></div><div id="row_vsd_p"><label>VSD personale</label><input id="a_vsd" type="number" step="1" placeholder="0"></div><div id="row_vsd_i" style="display:none"><label>VSD indiretto</label><input id="a_vsd_i" type="number" step="1" placeholder="0"></div><div id="row_tel" style="display:none"><label>Telefonate</label><input id="a_tel" type="number" step="1" placeholder="0"></div><div id="row_app" style="display:none"><label>Appunt. fissati</label><input id="a_app" type="number" step="1" placeholder="0"></div></div><div class="row" style="margin-top:8px;gap:8px;align-items:center"><div><button id="btnSaveA">Salva</button></div><div><button id="btnSaveExportA" class="ghost">Salva ed esporta</button></div><div class="right" style="margin-left:auto"><button id="btnDeleteA" class="danger" style="display:none">Elimina</button></div></div></div><div class="card"><b>Elenco appuntamenti</b><div class="row" style="margin-top:8px;align-items:flex-end;gap:12px;flex-wrap:wrap"><div><label>Vista</label><select id="af_type"><option value="sett">Settimana</option><option value="tutti">Tutti</option><option value="mese">Mese</option></select></div><div id="af_week_wrap"><label>Settimana ISO</label><input id="af_week" type="number" min="1" max="53" value="'+Qt(new Date)+'"></div><div id="af_month_wrap" style="display:none"><label>Mese</label><select id="af_month"><option value="1">Gennaio</option><option value="2">Febbraio</option><option value="3">Marzo</option><option value="4">Aprile</option><option value="5">Maggio</option><option value="6">Giugno</option><option value="7">Luglio</option><option value="8">Agosto</option><option value="9">Settembre</option><option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option></select></div><div><label>Anno</label><input id="af_year" type="number" min="2000" max="2100" value="'+new Date().getFullYear()+'"></div><div class="right" style="margin-left:auto;display:flex;gap:8px"><button id="af_prev" class="ghost">◀</button><button id="af_next" class="ghost">▶</button></div></div><div id="a_list" style="margin-top:8px"></div></div></div>',se();function T(w){return String(w).replace(/[&<>'"]/g,A=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[A])}function D(w){var A=Number(w)||0;return A.toLocaleString("it-IT")+"€"}function E(w){if(!w)return"";const A=new Date(w);return isNaN(A)?"":A.toISOString()}function P(w){if(!w)return"";const A=BPTimezone.parseUTCString(w);return isNaN(A)?"":new Date(A.getTime()-A.getTimezoneOffset()*6e4).toISOString().slice(0,16)}function R(w){return w=String(w||"").toLowerCase(),w.indexOf("mezza")>-1?240:w.indexOf("giorn")>-1||w.indexOf("formaz")>-1||w.indexOf("mbs")>-1?570:w.indexOf("sottoprod")>-1?240:w.indexOf("riunione")>-1||w.indexOf("impegni personali")>-1?60:90}const N=document.getElementById("a_nncf");N.addEventListener("click",()=>{const w=N.getAttribute("data-active")!=="1";N.setAttribute("data-active",w?"1":"0"),N.setAttribute("aria-pressed",w?"true":"false"),N.classList.toggle("active",w),w&&tt(document.getElementById("t_vendita"),!0)});const $=document.getElementById("t_vendita"),H=document.getElementById("t_mezza"),nt=document.getElementById("t_full"),j=document.getElementById("t_form"),K=document.getElementById("t_mbs"),rt=document.getElementById("t_sotto"),Y=document.getElementById("t_riunione"),Q=document.getElementById("t_impegni"),it=[$,H,nt,j,K,rt,Y,Q];function tt(w,A=!1){it.forEach(at=>at.classList.toggle("active",at===w));const V=document.getElementById("a_type"),U=document.getElementById("a_client"),G=document.getElementById("row_vss"),ct=document.getElementById("row_vsd_p"),_t=document.getElementById("row_vsd_i"),wt=document.getElementById("row_tel"),yt=document.getElementById("row_app");document.getElementById("a_vss").value="",document.getElementById("a_vsd").value="",document.getElementById("a_vsd_i").value="",document.getElementById("a_tel").value="",document.getElementById("a_app").value="",G.style.display="",ct.style.display="",_t.style.display="none",wt.style.display="none",yt.style.display="none",U.disabled=!1,N.style.display="",A||(N.setAttribute("data-active","0"),N.setAttribute("aria-pressed","false"),N.classList.remove("active")),(U.value==="Formazione"||U.value==="MBS"||U.value==="Sottoprodotti"||U.value==="Riunione"||U.value==="Impegni personali")&&(U.value=""),w===$?(V.value="vendita",J(90)):w===H?(V.value="mezza",J(240),document.getElementById("a_vsd").value="1000"):w===nt?(V.value="giornata",J(570),document.getElementById("a_vsd").value="2000"):w===j?(V.value="formazione",J(570),U.value="Formazione",U.disabled=!0,G.style.display="none",ct.style.display="none",N.style.display="none"):w===K?(V.value="MBS",J(570),U.value="MBS",U.disabled=!0,G.style.display="none",ct.style.display="none",_t.style.display="",document.getElementById("a_vsd_i").value="2000",N.style.display="none"):w===rt?(V.value="sottoprodotti",J(240),U.value="Sottoprodotti",U.disabled=!0,G.style.display="none",ct.style.display="none",wt.style.display="",yt.style.display="",N.style.display="none"):w===Y?(V.value="riunione",J(60),U.value="Riunione",U.disabled=!0,G.style.display="none",ct.style.display="none",N.style.display="none"):w===Q&&(V.value="impegni personali",J(60),U.value="Impegni personali",U.disabled=!0,G.style.display="none",ct.style.display="none",N.style.display="none")}function J(w){const A=document.getElementById("a_dur");A.value=String(w),W()}it.forEach(w=>w.addEventListener("click",A=>{A.preventDefault(),tt(w)})),tt($);function W(){const w=document.getElementById("a_start").value,A=parseInt(document.getElementById("a_dur").value||"0",10);if(!w||!isFinite(A)||A<=0){document.getElementById("a_end").value="";return}const V=new Date(w),U=new Date(V.getTime()+A*6e4);document.getElementById("a_end").value=("0"+U.getHours()).slice(-2)+":"+("0"+U.getMinutes()).slice(-2)}function ut(){const w=document.getElementById("a_start").value,A=document.getElementById("a_end").value;if(!w||!A)return;const V=new Date(w),U=A.split(":");if(U.length<2)return;const G=new Date(V);G.setHours(parseInt(U[0],10)||0,parseInt(U[1],10)||0,0,0),G<V&&G.setDate(G.getDate()+1);let ct=Math.round((G-V)/6e4);document.getElementById("a_dur").value=String(Math.max(1,ct))}document.getElementById("a_start").addEventListener("change",W),document.getElementById("a_dur").addEventListener("input",W),document.getElementById("a_end").addEventListener("change",ut),Mt("/api/clients").then(w=>{const A=w&&w.clients||[],V=document.getElementById("clientList");V&&(V.innerHTML=A.map(U=>'<option value="'+T(U.name)+'"></option>').join(""))});let st=null;function ht(){st=null,document.getElementById("a_form_title").textContent="Nuovo appuntamento",document.getElementById("a_client").value="",document.getElementById("a_start").value="",document.getElementById("a_end").value="",document.getElementById("a_dur").value="",document.getElementById("a_vss").value="",document.getElementById("a_vsd").value="",document.getElementById("a_vsd_i").value="",document.getElementById("a_tel").value="",document.getElementById("a_app").value="",document.getElementById("a_desc").value="",document.getElementById("a_client").disabled=!1,N.style.display="",N.setAttribute("data-active","0"),N.setAttribute("aria-pressed","false"),N.classList.remove("active"),tt($),document.getElementById("btnDeleteA").style.display="none"}function b(w){st=w.id,document.getElementById("a_form_title").textContent="Modifica appuntamento";var A=String(w.type||"vendita").toLowerCase();A.indexOf("mezza")>-1?tt(H):A.indexOf("giorn")>-1?tt(nt):A.indexOf("formaz")>-1?tt(j):A.indexOf("mbs")>-1?tt(K):A.indexOf("sottoprod")>-1?tt(rt):A.indexOf("riunione")>-1?tt(Y):A.indexOf("impegni personali")>-1?tt(Q):tt($),document.getElementById("a_client").value=w.client||"",document.getElementById("a_start").value=P(w.start);const V=BPTimezone.parseUTCString(w.start);let U=w.end?BPTimezone.parseUTCString(w.end):null,G=Number(w.durationMinutes);U instanceof Date&&!isNaN(U)&&U>=V?G=Math.max(1,Math.round((U-V)/6e4)):isFinite(G)&&G>0?U=new Date(V.getTime()+G*6e4):(G=R(w.type||"vendita"),U=new Date(V.getTime()+G*6e4)),document.getElementById("a_dur").value=String(G),document.getElementById("a_end").value=("0"+U.getHours()).slice(-2)+":"+("0"+U.getMinutes()).slice(-2),document.getElementById("a_vss").value=w.vss||"",document.getElementById("a_vsd").value=w.vsdPersonal||w.vsd||"",document.getElementById("a_vsd_i").value=w.vsdIndiretto||"",document.getElementById("a_tel").value=w.telefonate||"",document.getElementById("a_app").value=w.appFissati||"",document.getElementById("a_desc").value=w.notes||"";const ct=!!w.nncf;N.setAttribute("data-active",ct?"1":"0"),N.setAttribute("aria-pressed",ct?"true":"false"),N.classList.toggle("active",ct),document.getElementById("btnDeleteA").style.display=""}function h(){let w=(document.getElementById("a_client").value||"").trim();const A=document.getElementById("a_type").value;if(!w){const wt=String(A||"").toLowerCase();if(wt==="formazione"||wt==="mbs"||wt==="sottoprodotti")w=A;else return xt("Cliente obbligatorio"),null}const V=document.getElementById("a_start").value;if(!V)return xt("Data/ora obbligatorie"),null;let U=parseInt(document.getElementById("a_dur").value||"60",10);(!isFinite(U)||U<=0)&&(U=60);const G=document.getElementById("a_end").value;let ct;if(G){const wt=new Date(V),yt=G.split(":"),at=new Date(wt);at.setHours(parseInt(yt[0],10)||0,parseInt(yt[1],10)||0,0,0),at<wt&&at.setDate(at.getDate()+1),ct=at.toISOString(),U=Math.max(1,Math.round((at-wt)/6e4)),document.getElementById("a_dur").value=String(U)}else ct=new Date(new Date(V).getTime()+U*6e4).toISOString();const _t=document.getElementById("a_desc").value||"";return{id:st||void 0,client:w,start:E(V),end:ct,durationMinutes:U,type:A,vss:Number(document.getElementById("a_vss").value||0),vsdPersonal:Number(document.getElementById("a_vsd").value||0),vsdIndiretto:Number(document.getElementById("a_vsd_i").value||0),telefonate:Number(document.getElementById("a_tel").value||0),appFissati:Number(document.getElementById("a_app").value||0),notes:_t,nncf:N.getAttribute("data-active")==="1"}}function g(w){const A=h();if(!A)return;const V=!st;he("/api/appointments",A).then(()=>{if(xt("Appuntamento salvato"),typeof haptics<"u"&&haptics.try("success"),document.dispatchEvent(new Event("appt:saved")),V)try{document.dispatchEvent(new Event("appt:created"))}catch(U){}if(w&&window.BP&&BP.ICS&&typeof BP.ICS.downloadIcsForAppointment=="function")if(BP.ICS.downloadIcsForAppointment(A)){typeof haptics<"u"&&haptics.try("medium");try{document.dispatchEvent(new Event("ics:exported"))}catch(G){}xt(".ics esportato")}else xt("Export .ics non disponibile");ht(),L()}).catch(()=>xt("Errore salvataggio"))}function u(){if(!st||!confirm("Eliminare l'appuntamento?"))return;const w=h();fetch("/api/appointments?id="+encodeURIComponent(st),{method:"DELETE",headers:{Authorization:"Bearer "+ki()}}).then(A=>{if(!A.ok)throw new Error("HTTP "+A.status);return A.json()}).then(()=>{xt("Eliminato"),typeof showUndo=="function"&&w&&showUndo("Appuntamento eliminato",function(){return he("/api/appointments",w)},5e3),ht(),L()}).catch(()=>xt("Errore eliminazione"))}document.getElementById("btnSaveA").onclick=()=>g(!1),document.getElementById("btnSaveExportA").onclick=()=>g(!0),document.getElementById("btnDeleteA").onclick=u;function v(){const w=document.getElementById("af_type").value;if(w==="tutti")return{s:new Date(2e3,0,1),e:new Date(2100,11,31,23,59,59,999)};const A=parseInt(document.getElementById("af_year").value,10);if(w==="sett"){const V=Math.max(1,Math.min(53,parseInt(document.getElementById("af_week").value||Qt(new Date),10))),U=sn(A,V);return{s:new Date(U.start),e:new Date(U.end)}}else{const V=parseInt(document.getElementById("af_month").value||new Date().getMonth()+1,10);return{s:new Date(A,V-1,1),e:new Date(A,V,0,23,59,59,999)}}}function y(w){const A=document.getElementById("af_type").value,V=parseInt(document.getElementById("af_year").value,10);if(A==="sett"){const U=parseInt(document.getElementById("af_week").value,10),G=new Date(sn(V,U).start);G.setDate(G.getDate()+7*w),document.getElementById("af_year").value=G.getFullYear(),document.getElementById("af_week").value=Qt(G)}else{const U=parseInt(document.getElementById("af_month").value,10),G=new Date(V,U-1,1);G.setMonth(G.getMonth()+w),document.getElementById("af_year").value=G.getFullYear(),document.getElementById("af_month").value=G.getMonth()+1}L()}document.getElementById("af_prev").onclick=()=>y(-1),document.getElementById("af_next").onclick=()=>y(1);const C=document.getElementById("af_type"),x=document.getElementById("af_week"),I=document.getElementById("af_month"),M=document.getElementById("af_year");C.onchange=function(){const w=C.value;document.getElementById("af_week_wrap").style.display=w==="sett"?"":"none",document.getElementById("af_month_wrap").style.display=w==="mese"?"":"none",L()},[x,I,M].forEach(w=>{w&&(w.onchange=L)});function B(w){const A=BPTimezone.parseUTCString(w.start);let V=w.end?BPTimezone.parseUTCString(w.end):null;if(!(V instanceof Date)||isNaN(V)||V<A){const _t=isFinite(w.durationMinutes)?Number(w.durationMinutes):R(w.type||"vendita");V=BPTimezone.addMinutes(A,_t)}const U=BPTimezone.toLocalDisplay(A).split(" ")[0]+" "+BPTimezone.timeHMLocal(A)+"–"+BPTimezone.timeHMLocal(V);var G,ct=String(w.type||"").toLowerCase();return ct.indexOf("mbs")>-1?G="VSD ind "+D(w.vsdIndiretto||0):ct.indexOf("sottoprod")>-1?G="Tel "+ie(w.telefonate||0)+" · AppFissati "+ie(w.appFissati||0):ct.indexOf("formaz")>-1||ct.indexOf("riunione")>-1||ct.indexOf("impegni personali")>-1?G="":G="VSS "+D(w.vss||0)+" · VSD "+D(w.vsdPersonal||0)+" · NNCF "+(w.nncf?"✅":"—"),'<div class="card" data-aid="'+T(String(w.id||""))+'" style="flex:1 1 320px;cursor:pointer"><div class="small muted">'+T(U)+" · "+T(w.type||"vendita")+'</div><div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><div><b>'+T(w.client||"")+'</b></div><button class="ghost btn-ics" title="Esporta" data-ics="'+T(String(w.id||""))+'">📅</button></div>'+(G?'<div class="small">'+G+"</div>":"")+"</div>"}function L(){Mt("/api/appointments"+(Ct()&&Ct().role==="admin"?"?global=1":"")).then(w=>{const A=w&&w.appointments||[],V=v(),U=V.s.getTime(),G=V.e.getTime(),ct=A.filter(ft=>{const lt=BPTimezone.parseUTCString(ft.start).getTime();return lt>=U&&lt<=G}).sort((ft,lt)=>BPTimezone.parseUTCString(ft.start)-BPTimezone.parseUTCString(lt.start)),_t=new Date,wt=ct.filter(ft=>BPTimezone.parseUTCString(ft.start)>=_t),yt=ct.filter(ft=>BPTimezone.parseUTCString(ft.start)<_t),at=document.getElementById("a_list");let dt="";dt+="<div><b>Prossimi</b></div>",dt+=wt.length?'<div class="grid3">'+wt.map(B).join("")+"</div>":'<div class="muted" style="margin:6px 0 12px">Nessun appuntamento futuro</div>';const z="past_"+Math.random().toString(36).slice(2,8);dt+='<div id="'+z+'_head" style="margin-top:12px;display:flex;align-items:center;justify-content:space-between;cursor:pointer"><b>Passati</b><span class="chev">▾</span></div><div id="'+z+'_box" style="margin-top:8px">'+(yt.length?'<div class="grid3">'+yt.map(B).join("")+"</div>":'<div class="muted">Nessun appuntamento passato</div>')+"</div>",at.innerHTML=dt,(function(){const ft=document.getElementById(z+"_head"),lt=document.getElementById(z+"_box"),bt=ft.querySelector(".chev");ft.onclick=function(){const It=lt.style.display==="none";lt.style.display=It?"":"none",bt.textContent=It?"▾":"▸"}})();const ot=ct;at.querySelectorAll("[data-ics]").forEach(ft=>{ft.addEventListener("click",lt=>{lt.stopPropagation();const bt=ft.getAttribute("data-ics"),It=ot.find(Dt=>String(Dt.id)===String(bt));if(!It){xt("Appuntamento non trovato");return}if(window.BP&&BP.ICS&&typeof BP.ICS.downloadIcsForAppointment=="function")if(BP.ICS.downloadIcsForAppointment(It)){typeof haptics<"u"&&haptics.try("medium");try{document.dispatchEvent(new Event("ics:exported"))}catch(Et){}xt("Esportato")}else xt("Export .ics non disponibile");else xt("Export .ics non disponibile")})}),at.querySelectorAll(".card[data-aid]").forEach(ft=>{ft.addEventListener("click",()=>{const lt=ft.getAttribute("data-aid"),bt=ot.find(It=>String(It.id)===String(lt));bt&&(b(bt),window.scrollTo({top:0,behavior:"smooth"}))})})})}try{const w=Di("bp_prefill_slot",null);if(w&&w.start){const A=new Date(w.start),V=new Date(w.end||w.start),U=new Date(A.getTime()-A.getTimezoneOffset()*6e4).toISOString().slice(0,16);document.getElementById("a_start").value=U,document.getElementById("a_dur").value=String(Math.max(1,Math.round((V-A)/6e4))),W(),xt("Slot precompilato negli appuntamenti")}Vn("bp_prefill_slot")}catch(w){}try{const w=Di("bp_edit_aid",null);w&&Mt("/api/appointments"+(Ct()&&Ct().role==="admin"?"?global=1":"")).then(A=>{const U=(A&&A.appointments||[]).find(G=>String(G.id)===String(w));U&&(b(U),window.scrollTo({top:0,behavior:"smooth"}))}).finally(()=>{try{Vn("bp_edit_aid")}catch(A){}})}catch(w){}document.getElementById("btnSaveA").onclick=()=>g(!1),document.getElementById("btnSaveExportA").onclick=()=>g(!0),document.getElementById("btnDeleteA").onclick=u,Mt("/api/clients").then(()=>{}),L()}function m(){if(!Ct())return t();document.title="Battle Plan – Classifiche",n.innerHTML=me()+('<div class="wrap"><div class="card"><div class="row"><div><label>Vista</label><select id="lb_tab"><option value="per_indicator">Per indicatore</option><option value="overall">Generale (score)</option></select></div><div><label>Modalità</label><select id="lb_mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div><div id="lb_ind_wrap"><label>Indicatore</label><select id="lb_indicator"><option value="VSS">VSS</option><option value="VSDPersonale">VSD</option><option value="GI">GI</option><option value="NNCF">NNCF</option></select></div></div>'+e("lb")+'</div><div class="card"><b id="lb_title">Classifica</b><div id="lb_podium" style="margin:10px 0"></div><div id="lb_table"></div></div></div>'),se();function T(j){if(!j)return"";var K=new Date(j);return K.getFullYear()+"-"+("0"+(K.getMonth()+1)).slice(-2)+"-"+("0"+K.getDate()).slice(-2)}function D(j){return j==="ytd"||j==="ltm"?"mensile":j}document.getElementById("lb_tab").onchange=function(){var j=this.value;document.getElementById("lb_ind_wrap").style.display=j==="per_indicator"?"":"none",P()},o("lb",P),document.getElementById("lb_mode").onchange=P,document.getElementById("lb_indicator").onchange=P;function E(){var j=s("lb"),K=T(j.start),rt=T(j.end),Y=D(j.type||"mensile");return"&from="+encodeURIComponent(K)+"&to="+encodeURIComponent(rt)+"&type="+encodeURIComponent(Y)}function P(){var j=document.getElementById("lb_tab").value,K=E(),rt=document.getElementById("lb_mode").value;if(j==="overall")Mt("/api/leaderboard_overall?mode="+encodeURIComponent(rt)+K).then(nt);else{var Y=document.getElementById("lb_indicator").value;Mt("/api/leaderboard?indicator="+encodeURIComponent(Y)+"&mode="+encodeURIComponent(rt)+K).then(function(Q){H(Q,Y)})}}function R(j){return j===0?"🥇":j===1?"🥈":j===2?"🥉":j+1+"."}function N(j){var K=document.getElementById("lb_podium");if(!j||!j.length){K.innerHTML="";return}for(var rt=j.slice(0,3),Y='<div class="row" style="align-items:flex-end">',Q=0;Q<rt.length;Q++){var it=80-Q*15;Y+='<div class="card" style="flex:1 1 120px;height:'+it+'px;display:flex;align-items:flex-end;justify-content:center"><div>'+zt(R(Q)+" "+rt[Q].name)+"</div></div>"}Y+="</div>",K.innerHTML=Y}function $(j,K,rt){var Y=Math.min(100,Math.max(0,Math.round(rt)));return'<div class="card lb-card" style="flex:1 1 280px"><div class="big">'+zt(j)+'</div><div class="small muted">'+zt(K)+'</div><div class="lb-bar"><div style="width:'+Y+'%"></div></div></div>'}function H(j,K){document.getElementById("lb_title").textContent="Classifica – "+K;var rt=j.ranking||[];if(N(rt),!rt.length){document.getElementById("lb_table").innerHTML='<div class="muted">Nessun dato</div>';return}for(var Y='<div class="row">',Q=rt[0].total||1,it=0;it<rt.length;it++){var tt=rt[it];Y+=$(R(it)+" "+tt.name,"Totale: "+ie(tt.total),tt.total/Q*100)}Y+="</div>",document.getElementById("lb_table").innerHTML=Y}function nt(j){document.getElementById("lb_title").textContent="Classifica generale";var K=j.ranking||[];if(N(K),!K.length){document.getElementById("lb_table").innerHTML='<div class="muted">Nessun dato</div>';return}for(var rt=K[0].score||0,Y='<div class="row">',Q=0;Q<K.length;Q++){var it=K[Q];Y+=$(R(Q)+" "+it.name,"Score: "+ie(it.score)+"/100",rt?it.score/rt*100:0)}Y+="</div>",document.getElementById("lb_table").innerHTML=Y}P()}(function(){function T(){var D=document.getElementById("bp-overlay");return D||(D=document.createElement("div"),D.id="bp-overlay",D.className="hidden",D.setAttribute("role","dialog"),D.setAttribute("aria-modal","true"),D.innerHTML='<div class="bp-overlay-backdrop" id="bp-overlay-backdrop"></div><div class="bp-overlay-panel" id="bp-overlay-panel"></div>',document.body.appendChild(D),document.getElementById("bp-overlay-backdrop").addEventListener("click",hideOverlay)),D}window.showOverlay=function(D){var E=T(),P=document.getElementById("bp-overlay-panel");P.innerHTML=D||"",E.classList.remove("hidden");var R=P.querySelector("input, textarea, select, button");R&&setTimeout(function(){try{R.focus()}catch(N){}},0)},window.hideOverlay=function(){var D=document.getElementById("bp-overlay");D&&D.classList.add("hidden")}})();function _(){if(!Ct())return t();document.title="Battle Plan – Clienti";const T=Ct().role==="admin",D=T?'<div><label>Consulente</label><select id="cl_new_owner"><option value="">—</option></select></div>':"",E=T?'<div><label>Consulente</label><select id="cl_f_cons"><option value="">Tutti</option></select></div>':"";n.innerHTML=me()+'<div class="wrap"><div class="card"><b>Nuovo cliente</b><div class="row" style="margin-top:8px"><div><label>Ragione sociale</label><input id="cl_name" type="text" placeholder="Es. Rossi S.r.l."></div><div><label>Stato</label><select id="cl_new_state"><option value="potenziale">Potenziale</option><option value="lead non chiuso">Lead non chiuso</option><option value="attivo">Attivo</option></select></div>'+D+'<div class="right"><button id="cl_add">Aggiungi</button></div></div></div><div class="card"><b>Filtri elenco</b><div class="row" style="margin-top:8px"><div><label>Stato</label><select id="cl_f_state"><option value="">Tutti</option><option value="attivo">Attivo</option><option value="lead non chiuso">Lead non chiuso</option><option value="potenziale">Potenziale</option></select></div>'+E+'<div><label>Ordina per</label><select id="cl_order"><option value="az">Ragione sociale (A→Z)</option><option value="last_desc">Ultimo appuntamento (recenti prima)</option></select></div><div class="right"><button class="ghost" id="cl_f_apply">Applica</button></div></div></div><div class="card"><b>Elenco clienti</b><div id="cl_list" class="row" style="margin-top:8px"></div></div></div>',se();function P(){const $=(document.getElementById("cl_name").value||"").trim();if(!$){xt("Nome obbligatorio");return}const H=document.getElementById("cl_new_state"),nt=document.getElementById("cl_new_owner"),j={name:$};H&&(j.status=H.value),nt&&nt.value?j.consultantId=nt.value:T||(j.consultantId=Ct().id),he("/api/clients",j).then(function(){document.getElementById("cl_name").value="",N(),mi(),window.addXP(5)}).catch(function(K){logger.error(K),xt("Errore creazione cliente")})}function R(){T&&Mt("/api/usernames").then(function($){const H=$&&$.users||[],nt=document.getElementById("cl_f_cons"),j=document.getElementById("cl_new_owner");nt&&(nt.innerHTML='<option value="">Tutti</option>'+H.map(function(K){return'<option value="'+K.id+'">'+zt(K.name)+(K.grade?" ("+K.grade+")":"")+"</option>"}).join("")),j&&(j.innerHTML='<option value="">—</option>'+H.map(function(K){return'<option value="'+K.id+'">'+zt(K.name)+(K.grade?" ("+K.grade+")":"")+"</option>"}).join(""))}).catch(function($){logger.error($)})}function N(){Mt("/api/clients").then(function($){const H=$&&$.clients||[],nt=document.getElementById("cl_f_state").value,j=document.getElementById("cl_f_cons"),K=j?j.value:String(Ct().id);function rt(it){return String(it||"").trim().toLowerCase()}const Q=H.filter(function(it){return!(nt&&rt(it.status)!==rt(nt)||K&&String(it.consultantId||"")!==String(K))}).map(function(it){const tt=zt(it.name||""),J=zt(it.status||"potenziale"),W=it.consultantName?zt(it.consultantName):"unknown",ut=String(it.id||"");return'<div class="card" data-clid="'+ut+'" data-name-lower="'+tt.toLowerCase()+'" data-status="'+J+'" data-consultant-id="'+zt(String(it.consultantId||""))+'" style="flex:1 1 380px"><div><b>'+tt+'</b></div><div class="small">Stato: <b class="cl-status">'+J+'</b></div><div class="small">Consulente: <b class="cl-cons">'+W+'</b></div><div class="small muted">Ultimo appuntamento: <span class="last-appt">—</span></div><div class="right" style="margin-top:6px"><button class="ghost" data-del="'+ut+'">Rimuovi</button></div></div>'}).join("");document.getElementById("cl_list").innerHTML=Q||'<div class="muted">Nessun cliente</div>',document.querySelectorAll("[data-del]").forEach(function(it){it.addEventListener("click",function(){const tt=it.getAttribute("data-del");confirm("Rimuovere il cliente?")&&fetch("/api/clients?id="+encodeURIComponent(tt),{method:"DELETE",headers:{Authorization:"Bearer "+ki()}}).then(function(J){if(!J.ok)throw new Error("HTTP "+J.status);return J.json()}).then(function(){xt("Cliente rimosso"),N()}).catch(function(J){logger.error(J),xt("Errore rimozione")})})}),window.BPFinal&&typeof BPFinal.ensureClientSection=="function"?BPFinal.ensureClientSection():setTimeout(function(){const it=document.getElementById("cl_list"),tt=Array.from(it.children).filter(J=>J.classList.contains("card"));tt.sort((J,W)=>String(J.getAttribute("data-name-lower")||"").localeCompare(String(W.getAttribute("data-name-lower")||"")));for(const J of tt)it.appendChild(J)},0)})}document.getElementById("cl_add").onclick=P,document.getElementById("cl_f_apply").onclick=N,T&&R(),N(),typeof kickFinal=="function"&&kickFinal("clients")}function S(){if(!Ct())return t();document.title="Battle Plan – Squadra";const T=Ct().role==="admin";var D=me()+'<div class="wrap">'+(T?'<div class="card"><b>Vista Amministratore</b><div id="t_adminbar" class="row" style="margin-top:8px;display:flex;align-items:flex-end;gap:16px;flex-wrap:wrap"><div><label>Modalità</label><select id="t_mode" name="mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div><div id="t_unified_wrap">'+e("t")+"</div></div></div>":"")+'<div class="card"><b>Grafico</b><div class="row" style="margin-top:8px;align-items:flex-end;gap:16px;flex-wrap:wrap"><div><label>Indicatore grafico</label><select id="t_ind"><option value="VSS">VSS</option><option value="VSDPersonale">VSD Personale</option><option value="VSDIndiretto">VSD Indiretto</option><option value="VSDTotale">VSD Totale</option><option value="GI">GI</option><option value="NNCF">NNCF</option><option value="provv_gi">Provv GI</option><option value="provv_vsd">Provv VSD</option><option value="tot_provv" selected>Tot Provvigioni</option></select></div><div><label>Consulente</label><select id="t_cons"><option value="">Tutti</option></select></div></div><div style="margin-top:8px"><canvas id="t_chart" height="160" style="width:100%"></canvas></div></div><div class="card"><b>Aggregato Squadra</b><div id="t_agg" class="row" style="margin-top:8px"></div></div>'+(T?'<div class="card"><b>Riepilogo per utente</b><div id="t_users" class="row" style="margin-top:8px"></div></div>':"")+"</div>";n.innerHTML=D,se(),(function(){var g=document.getElementById("t_adminbar"),u=document.getElementById("t_unified_wrap");if(!(!g||!u)){var v=u.querySelector(".row");v&&(Array.from(v.children).forEach(function(y){y.classList.remove("right"),y.style.marginTop="0",g.appendChild(y)}),u.remove())}})();function E(h){return h=Number(h||0),isFinite(h)?h:0}function P(h){if(!h)return"";var g=new Date(h);return g.getFullYear()+"-"+("0"+(g.getMonth()+1)).slice(-2)+"-"+("0"+g.getDate()).slice(-2)}function R(h){return h=String(h||"mensile").toLowerCase(),h.indexOf("sett")===0?"settimanale":h.indexOf("mes")===0?"mensile":h.indexOf("tri")===0?"trimestrale":h.indexOf("sem")===0?"semestrale":h.indexOf("ann")===0?"annuale":"mensile"}function N(){var h=s("t"),g=P(h.start),u=P(h.end),v=R(h.type);return"&from="+encodeURIComponent(g)+"&to="+encodeURIComponent(u)+"&type="+encodeURIComponent(v)}function $(h){switch(String(h)){case"provv_gi":return"ProvvGI";case"provv_vsd":return"ProvvVSD";case"tot_provv":return"TotProvvigioni";default:return h}}function H(h){var g=Number(h)||0;return g.toLocaleString("it-IT")+"€"}function nt(h){var g=Number(h)||0;return String(Math.round(g))}function j(h){return String(h).replace(/[&<>'"]/g,g=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[g])}var K=null;function rt(h,g){return g==="settimanale"?window.isoWeekNum?window.isoWeekNum(h):Math.ceil(h.getDate()/7):g==="mensile"||g==="ytd"||g==="ltm"?h.getMonth()+1:g==="trimestrale"?Math.floor(h.getMonth()/3)+1:g==="semestrale"?h.getMonth()<6?1:2:h.getFullYear()}function Y(h,g){var u=document.getElementById("t_chart");if(u){var v=J(g),y=typeof l=="function"?l(g,v):h.map(function(w){return rt(w.x,g)}),C=h.map(function(w){return w.y});if(!Re){var M=u.getContext("2d");u.width=u.clientWidth||600,u.height=u.clientHeight||160,M.clearRect(0,0,u.width,u.height);var x=Math.max(1,...C),I=C.length>1?(u.width-8)/(C.length-1):0;M.beginPath(),M.lineWidth=2,M.strokeStyle="#2e6cff",C.forEach(function(A,V){var U=4+V*I,G=u.height-6-A/x*(u.height-12);V?M.lineTo(U,G):M.moveTo(U,G)}),M.stroke(),M.fillStyle="#2e6cff",C.forEach(function(A,V){var U=4+V*I,G=u.height-6-A/x*(u.height-12);M.beginPath(),M.arc(U,G,2,0,Math.PI*2),M.fill()});return}u.style.width="100%",u.width=u.parentNode.clientWidth;var M=u.getContext("2d"),B=typeof window.computeTickOptions=="function"?window.computeTickOptions(y,u.width||600):{autoSkip:!0,maxRotation:0,minRotation:0};if(K)K.data.labels=y,K.data.datasets[0].data=C,K.options.scales.x.ticks=B,K.update();else{var L=typeof Re.getChart=="function"?Re.getChart(u):null;L&&L.destroy(),K=new Re(M,{type:"line",data:{labels:y,datasets:[{label:"",data:C,tension:.3,pointRadius:3,pointHoverRadius:5}]},options:{responsive:!0,maintainAspectRatio:!1,animation:!1,animations:!1,plugins:{legend:{display:!1}},scales:{x:{grid:{display:!1},ticks:B},y:{beginAtZero:!0}}}})}K.resize()}}function Q(h){return'<div class="card" style="flex:1 1 360px"><div style="display:flex;align-items:center;gap:8px"><div><b>'+j(h.name||"User #"+h.userId)+"</b></div>"+(h.grade?'<span class="chip small">'+j(h.grade)+"</span>":"")+'</div><div class="small" style="margin-top:6px">VSS '+H(h.vss||0)+'</div><div class="small">VSD Pers. '+H(h.vsdP||0)+'</div><div class="small">VSD Ind. '+H(h.vsdI||0)+'</div><div class="small">VSD Tot. '+H((h.vsdP||0)+(h.vsdI||0))+'</div><div class="small">GI '+H(h.gi||0)+'</div><div class="small">NNCF '+nt(h.nncf||0)+'</div><div class="small muted" style="margin-top:6px">Provv GI '+H(h.provvGi||0)+'</div><div class="small muted">Provv VSD '+H(h.provvVsd||0)+'</div><div class="small"><b>Tot Provvigioni '+H(h.provvTot||0)+"</b></div></div>"}function it(h){return'<div class="card" style="flex:1 1 460px"><div class="neon" style="font-weight:900">Totali squadra</div><div class="small" style="margin-top:6px">VSS '+H(h.vss)+'</div><div class="small">VSD Pers. '+H(h.vsdP)+'</div><div class="small">VSD Ind. '+H(h.vsdI)+'</div><div class="small">VSD Tot. '+H(h.vsdP+h.vsdI)+'</div><div class="small">GI '+H(h.gi)+'</div><div class="small">NNCF '+nt(h.nncf)+'</div><div class="small muted" style="margin-top:6px">Provv GI '+H(h.provvGi)+'</div><div class="small muted">Provv VSD '+H(h.provvVsd)+'</div><div class="small"><b>Tot Provvigioni '+H(h.provvTot)+"</b></div></div>"}function tt(){var h=(document.getElementById("t_mode")||{}).value||"consuntivo",g=N();Promise.all([Mt("/api/usernames"),Mt("/api/leaderboard?indicator="+encodeURIComponent("VSS")+g+"&mode="+encodeURIComponent(h)),Mt("/api/leaderboard?indicator="+encodeURIComponent("VSDPersonale")+g+"&mode="+encodeURIComponent(h)),Mt("/api/leaderboard?indicator="+encodeURIComponent("VSDIndiretto")+g+"&mode="+encodeURIComponent(h)),Mt("/api/leaderboard?indicator="+encodeURIComponent("GI")+g+"&mode="+encodeURIComponent(h)),Mt("/api/leaderboard?indicator="+encodeURIComponent("NNCF")+g+"&mode="+encodeURIComponent(h)),Mt("/api/leaderboard?indicator="+encodeURIComponent("ProvvGI")+g+"&mode="+encodeURIComponent(h)),Mt("/api/leaderboard?indicator="+encodeURIComponent("ProvvVSD")+g+"&mode="+encodeURIComponent(h))]).then(function(u){var v=u[0]||{},y=u[1]&&(u[1].rows||u[1].ranking)||[],C=u[2]&&(u[2].rows||u[2].ranking)||[],x=u[3]&&(u[3].rows||u[3].ranking)||[],I=u[4]&&(u[4].rows||u[4].ranking)||[],M=u[5]&&(u[5].rows||u[5].ranking)||[],B=u[6]&&(u[6].rows||u[6].ranking)||[],L=u[7]&&(u[7].rows||u[7].ranking)||[],w=(v.users||[]).map(function(lt){return{id:String(lt.id),name:lt.name||lt.email||"User #"+lt.id,grade:lt.grade==="senior"?"senior":"junior"}}),A=document.getElementById("t_cons");A&&(A.innerHTML='<option value="">Tutti</option>'+w.map(function(lt){return'<option value="'+lt.id+'">'+j(lt.name)+"</option>"}).join(""));function V(lt){for(var bt={},It=0;It<lt.length;It++){var Dt=lt[It],Et=String(Dt.userId||Dt.id||Dt.uid||""),q=E(Dt.total||Dt.value||Dt.sum||0);Et&&(bt[Et]=q)}return bt}var U=V(y),G=V(C),ct=V(x),_t=V(I),wt=V(M),yt=V(B),at=V(L),dt=w.map(function(lt){var bt=E(U[lt.id]),It=E(G[lt.id]),Dt=E(ct[lt.id]),Et=E(_t[lt.id]),q=E(wt[lt.id]),Z=E(yt[lt.id]),pt=E(at[lt.id]);return{userId:lt.id,name:lt.name,grade:lt.grade,vss:bt,vsdP:It,vsdI:Dt,gi:Et,nncf:q,provvGi:Z,provvVsd:pt,provvTot:Z+pt}}),z=document.getElementById("t_users");z&&(z.innerHTML=dt.length?dt.map(Q).join(""):'<div class="muted">Nessun dato</div>');var ot=dt.reduce(function(lt,bt){return lt.vss+=bt.vss,lt.vsdP+=bt.vsdP,lt.vsdI+=bt.vsdI,lt.gi+=bt.gi,lt.nncf+=bt.nncf,lt.provvGi+=bt.provvGi,lt.provvVsd+=bt.provvVsd,lt.provvTot+=bt.provvTot,lt},{vss:0,vsdP:0,vsdI:0,gi:0,nncf:0,provvGi:0,provvVsd:0,provvTot:0}),ft=document.getElementById("t_agg");ft&&(ft.innerHTML=it(ot)),ut()}).catch(function(u){logger.error(u),xt("Errore caricamento squadra")})}function J(h){return(typeof r=="function"?r(h,new Date):[]).map(function(g){return{s:g.s,e:g.e}})}function W(h,g,u,v){var y=v||s("t"),C=String(y.type||"mensile").toLowerCase(),x=C==="ytd"||C==="ltm"?"mensile":C,I=J(C);function M(w,A){var V=new Date(A.startDate).getTime(),U=new Date(A.endDate).getTime();return V>=w.s&&U<=w.e}function B(w,A){if(!w)return 0;if(A==="VSDTotale")return Number(w.VSDPersonale||0)+Number(w.VSDIndiretto||0);if(A==="ProvvGI")return Number(w.ProvvGI||0);if(A==="ProvvVSD")return Number(w.ProvvVSD||0);if(A==="TotProvvigioni"){var V=w.TotProvvigioni;return Number(V!=null?V:Number(w.ProvvGI||0)+Number(w.ProvvVSD||0))}return Number(w[A]||0)}var L=(function(){var w=I.length?P(new Date(I[0].s)):P(new Date),A=I.length?P(new Date(I[I.length-1].e)):P(new Date),V="?global=1&type="+encodeURIComponent(x)+"&from="+encodeURIComponent(w)+"&to="+encodeURIComponent(A);return u&&(V+="&userId="+encodeURIComponent(u)),V})();return Mt("/api/periods"+L).catch(function(){return Mt("/api/periods"+L.replace("?global=1",""))}).then(function(w){var A=w&&w.periods||[],V=A.filter(function(G){return!(G.type!==x||u&&String(G.userId||G.uid||"")!==String(u))}),U=I.map(function(G){for(var ct=0,_t=0;_t<V.length;_t++){var wt=V[_t];if(M(G,wt)){var yt=g==="previsionale"?wt.indicatorsPrev||{}:wt.indicatorsCons||{};ct+=B(yt,$(h))}}return{x:new Date(G.s),y:Math.round(ct*100)/100}});return U})}function ut(){var h=document.getElementById("t_ind"),g=h?h.value:"VSS",u=document.getElementById("t_mode"),v=u?u.value:"consuntivo",y=document.getElementById("t_cons"),C=y?y.value:Ct().id,x=s("t"),I=x.type,M=$(g);N()+(C?"&userId="+encodeURIComponent(C):"")+("&indicator="+encodeURIComponent(M))+("&mode="+encodeURIComponent(v));var B=W(M,v,C||null,x);B.then(function(L){Y(L,I)}).catch(function(L){logger.error(L),Y([],I)})}T&&o("t",function(){typeof haptic=="function"&&haptic("light"),tt()});var st=document.getElementById("t_mode");st&&(st.onchange=function(){typeof haptic=="function"&&haptic("light"),tt()});var ht=document.getElementById("t_ind");ht&&(ht.onchange=function(){typeof haptic=="function"&&haptic("light"),ut()});var b=document.getElementById("t_cons");b&&(b.onchange=function(){typeof haptic=="function"&&haptic("light"),ut()}),tt()}function k(){if(!Ct())return t();var T=Ct().role==="admin";document.title="Battle Plan – Provvigioni",n.innerHTML=me()+'<div class="wrap"><div class="card"><b>Calcolo provvigioni</b><div class="row" style="margin-top:8px; gap:12px; flex-wrap:wrap">'+(T?'<div><label>Utente</label><select id="comm_user"><option value="__all">Tutta la squadra</option></select></div>':"")+'<div><label>Modalità</label><select id="comm_mode" name="mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div></div>'+e("comm")+'</div><div class="card"><b>Indicatori periodo</b><div id="comm_total" style="margin-top:8px"></div></div><div class="card"><b>Provvigioni – ripartizione</b><div class="small muted">Confronto tra Provvigioni GI e Provvigioni VSD sul periodo selezionato</div><div class="row" style="margin-top:8px; align-items:center; gap:16px; flex-wrap:wrap"><canvas id="cm_pie_provv" width="260" height="260" style="max-width:260px; max-height:260px"></canvas><div id="cm_pie_legend" class="small"></div></div></div><div class="card"><b>Dettaglio</b><div id="comm_rows" class="row" style="margin-top:8px; gap:12px; flex-wrap:wrap"></div></div></div>',se();function D(Y){return document.getElementById(Y)}function E(Y){if(!Y)return"";var Q=new Date(Y);return Q.getFullYear()+"-"+("0"+(Q.getMonth()+1)).slice(-2)+"-"+("0"+Q.getDate()).slice(-2)}function P(Y){var Q=Number(Y)||0;return Q.toLocaleString("it-IT")+"€"}function R(Y){return Y=Number(Y==null?"":Y),isFinite(Y)?Y:0}function N(Y){return Y?Y.TotProvvigioni!=null?R(Y.TotProvvigioni):R(Y.ProvvGI)+R(Y.ProvvVSD):0}function $(Y,Q){return'<div class="card"><div class="small muted">'+zt(Y)+'</div><div style="font-weight:700; font-size:20px; margin-top:4px">'+Q+"</div></div>"}function H(Y){return'<div class="table" style="overflow:auto"><table class="simple" style="width:100%; border-collapse:separate; border-spacing:12px 8px"><tbody><tr><td>'+$("VSD personale",P(Y.vsd||0))+"</td><td>"+$("GI",P(Y.gi||0))+"</td></tr><tr><td>"+$("Provv. VSD",P(Y.provv_vsd||0))+"</td><td>"+$("Provv. GI",P(Y.provv_gi||0))+"</td><td>"+$("Totale Provvigioni",P(Y.provv_total||0))+"</td></tr></tbody></table></div>"}function nt(Y){return Y.length?Y.map(function(Q){return'<div class="card" style="flex:1 1 320px"><div><b>'+zt(Q.name)+'</b></div><div class="small" style="margin-top:4px">GI '+P(Q.gi||0)+" · VSD "+P(Q.vsd||0)+'</div><div class="small muted" style="margin-top:2px">Provv. GI '+P(Q.provv_gi||0)+" · Provv. VSD "+P(Q.provv_vsd||0)+'</div><div class="small" style="margin-top:6px"><b>Totale: '+P(Q.provv_total||0)+"</b></div></div>"}).join(""):'<div class="muted">Nessun dato</div>'}function j(Y,Q,it){var tt=document.getElementById("cm_pie_provv"),J=document.getElementById("cm_pie_legend");if(!tt||!tt.getContext){J&&(J.innerHTML="");return}var W=tt.getContext("2d"),ut=tt.width,st=tt.height,ht=ut/2,b=st/2,h=Math.min(ut,st)/2-8;W.clearRect(0,0,ut,st);var g=Math.max(0,Y||0),u=Math.max(0,Q||0),v=g+u,y=it>0?Math.round(v/it*100):null;if(v<=0){W.beginPath(),W.arc(ht,b,h,0,Math.PI*2),W.strokeStyle="#ccd0d5",W.lineWidth=10,W.setLineDash([6,6]),W.stroke(),W.setLineDash([]),W.globalCompositeOperation="destination-out",W.beginPath(),W.arc(ht,b,h*.55,0,Math.PI*2),W.fill(),W.globalCompositeOperation="source-over",W.fillStyle="#111",W.textAlign="center",W.textBaseline="middle",W.font="bold 20px system-ui, -apple-system, Segoe UI, Roboto, sans-serif",W.fillText(y==null?"—":y+"%",ht,b),J&&(J.innerHTML='<div class="muted">Nessuna provvigione nel periodo</div>');return}var C=[{label:"Provv. GI",value:g,color:"#4F8EF7"},{label:"Provv. VSD",value:u,color:"#F79F4F"}],x=-Math.PI/2;C.forEach(function(B){var L=B.value/v*Math.PI*2;W.beginPath(),W.moveTo(ht,b),W.arc(ht,b,h,x,x+L),W.closePath(),W.fillStyle=B.color,W.fill(),x+=L}),W.globalCompositeOperation="destination-out",W.beginPath(),W.arc(ht,b,h*.55,0,Math.PI*2),W.fill(),W.globalCompositeOperation="source-over",W.fillStyle="#111",W.textAlign="center",W.textBaseline="middle",W.font="bold 20px system-ui, -apple-system, Segoe UI, Roboto, sans-serif",W.fillText(y==null?"—":y+"%",ht,b);var I=Math.round(g/v*100),M=Math.round(u/v*100);J&&(J.innerHTML='<div class="row" style="gap:16px; flex-wrap:wrap"><div class="row" style="gap:8px; align-items:center"><span style="display:inline-block;width:12px;height:12px;background:#4F8EF7;border-radius:3px"></span><span><b>Provv. GI</b> '+P(g)+" · "+I+'%</span></div><div class="row" style="gap:8px; align-items:center"><span style="display:inline-block;width:12px;height:12px;background:#F79F4F;border-radius:3px"></span><span><b>Provv. VSD</b> '+P(u)+" · "+M+"%</span></div></div>")}function K(){var Y=s("comm"),Q=D("comm_mode").value||"consuntivo",it=T?D("comm_user").value||"__all":String(Ct().id),tt=new Date(Y.start).getTime(),J=new Date(Y.end).getTime(),W=a(Y.type||"mensile"),ut=(function(){var st=E(new Date(tt)),ht=E(new Date(J)),b="?type="+encodeURIComponent(W)+"&from="+encodeURIComponent(st)+"&to="+encodeURIComponent(ht);return T&&it&&it!=="__all"&&(b+="&userId="+encodeURIComponent(it)),b})();Mt("/api/periods"+ut).then(function(st){var ht=st&&st.periods||[],b=ht.filter(function(u){if(u.type!==W)return!1;var v=new Date(u.startDate).getTime(),y=new Date(u.endDate).getTime();return!(v<tt||y>J||T&&it!=="__all"&&String(u.userId||u.uid||"")!==String(it)||!T&&String(u.userId||u.uid||"")!==String(Ct().id))}),h={gi:0,vsd:0,provv_gi:0,provv_vsd:0,provv_total:0},g={};b.forEach(function(u){var v=Q==="previsionale"?u.indicatorsPrev||{}:u.indicatorsCons||{},y=String(u.userId||u.uid||""),C=u.userName||u.name||"User "+y,x=R(v.GI),I=R(v.VSDPersonale),M=R(v.ProvvGI),B=R(v.ProvvVSD),L=N(v);h.gi+=x,h.vsd+=I,h.provv_gi+=M,h.provv_vsd+=B,h.provv_total+=L,g[y]||(g[y]={userId:y,name:C,gi:0,vsd:0,provv_gi:0,provv_vsd:0,provv_total:0}),g[y].gi+=x,g[y].vsd+=I,g[y].provv_gi+=M,g[y].provv_vsd+=B,g[y].provv_total+=L}),D("comm_total").innerHTML=H(h),D("comm_rows").innerHTML=nt(Object.values(g).sort(function(u,v){return(v.provv_total||0)-(u.provv_total||0)})),j(h.provv_gi||0,h.provv_vsd||0,h.gi||0)}).catch(function(st){logger.error(st),xt("Errore nel caricamento dati")})}function rt(){T&&Mt("/api/usernames").then(function(Y){var Q=D("comm_user");if(Q){for(var it='<option value="__all">Tutta la squadra</option>',tt=Y&&Y.users||[],J=0;J<tt.length;J++){var W=tt[J];it+='<option value="'+W.id+'">'+zt(W.name||"User "+W.id)+"</option>"}Q.innerHTML=it}})}o("comm",function(){K()}),D("comm_mode").onchange=function(){haptic("light"),K()},T&&(D("comm_user").onchange=function(){haptic("light"),K()}),rt(),K()}function O(){if(!Ct())return t();document.title="Battle Plan – Vendite e Riordini";const T=Ct().role==="admin";n.innerHTML=me()+'\n    <div class="wrap">\n\n      <div class="card">\n        <b>Filtro</b>\n        <div class="row" style="margin-top:6px;align-items:flex-end;gap:16px;flex-wrap:wrap">\n          '.concat(T?'<div><label>Consulente</label><select id="vr_cons"><option value="">Tutti</option></select></div>':"","\n        </div>\n        ").concat(e("vr"),'\n      </div>\n\n      <div class="card">\n        <b>Vendite e Riordini</b>\n        <div class="table" style="overflow:auto">\n          <table class="simple" style="min-width:980px">\n            <thead>\n              <tr>\n                <th>Data</th>\n                <th>Cliente</th>\n                <th>Consulente</th>\n              </tr>\n            </thead>\n            <tbody id="vr_rows">\n              <tr><td colspan="3" class="muted">Nessun dato</td></tr>\n            </tbody>\n          </table>\n        </div>\n      </div>\n\n    </div>'),se(),o("vr",()=>{})}function F(){if(!Ct())return t();document.title="Battle Plan – GI & Scadenzario";const T=Ct().role==="admin";n.innerHTML=me()+'\n  <div class="wrap">\n\n    <div class="card">\n      <b>Filtro</b>\n      <div class="row" style="margin-top:6px;align-items:flex-end;gap:16px;flex-wrap:wrap">\n        '.concat(T?'<div><label>Consulente</label><select id="gi_cons"><option value="">Tutti</option></select></div>':"","\n      </div>\n      ").concat(e("gi"),'\n    </div>\n\n    <div class="card">\n      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">\n        <b>Vendite (GI)</b>\n        <button class="ghost" id="gi_add">Nuova vendita</button>\n      </div>\n      <div class="table" style="overflow:auto">\n        <table class="simple" style="min-width:980px">\n          <thead>\n            <tr>\n              <th>Data vendita</th>\n              <th>Cliente</th>\n              <th>Consulente</th>\n              <th>Servizi</th>\n              <th style="text-align:right">Tot. VSS</th>\n              <th>Piano pagamenti</th>\n              <th></th>\n            </tr>\n          </thead>\n          <tbody id="gi_rows"></tbody>\n        </table>\n      </div>\n    </div>\n\n    <div class="card">\n      <b>Forecast incassi</b>\n      <div class="row" style="margin-top:6px;align-items:flex-end;gap:16px;flex-wrap:wrap">\n        <div><label>Granularità</label><select id="gi-forecast-granularity">\n          <option value="settimanale">settimanale</option>\n          <option value="mensile" selected>mensile</option>\n          <option value="trimestrale">trimestrale</option>\n          <option value="semestrale">semestrale</option>\n          <option value="annuale">annuale</option>\n        </select></div>\n        ').concat(T?'<div><label>Consulente</label><select id="gi-forecast-consultant"><option value="">Tutti</option></select></div>':"",'\n      </div>\n      <div class="table" style="overflow:auto">\n        <table class="simple" style="min-width:580px">\n          <thead>\n            <tr><th>Periodo</th><th>Totale</th><th>Dettaglio</th></tr>\n          </thead>\n          <tbody id="gi-forecast-future"></tbody>\n        </table>\n      </div>\n      <details id="gi-forecast-past" style="margin-top:8px">\n        <summary>Incassi passati</summary>\n        <div class="table" style="overflow:auto">\n          <table class="simple" style="min-width:580px">\n            <tbody id="gi-forecast-past-body"></tbody>\n          </table>\n        </div>\n      </details>\n    </div>\n\n  </div>'),se();const D=b=>document.getElementById(b),E=b=>String(b||"").replace(/[&<>'"]/g,h=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[h]),P=b=>(Number(b)||0).toLocaleString("it-IT")+"€",R=b=>{const h=new Date(b);return h.getFullYear()+"-"+("0"+(h.getMonth()+1)).slice(-2)+"-"+("0"+h.getDate()).slice(-2)};function N(){const b=window.readUnifiedRange&&window.readUnifiedRange("gi")||{};if(!b||!b.start||!b.end){const h=new Date,g=new Date(h.getFullYear(),0,1),u=new Date(h.getFullYear(),11,31,23,59,59);return{from:R(g),to:R(u)}}return{from:R(b.start),to:R(b.end)}}let $=[],H=[];function nt(){return Mt("/api/clients").then(b=>{if($=b&&b.clients||[],!!T)return Mt("/api/usernames").then(h=>{const g=h&&h.users||[],u=D("gi_cons");u&&(u.innerHTML='<option value="">Tutti</option>'+g.map(v=>'<option value="'+E(String(v.id))+'">'+E(v.name)+"</option>").join(""))})})}function j(b){const h=Array.isArray(b.schedule)?b.schedule.slice():[];if(!h.length)return'<span class="muted">—</span>';const g=h.find(x=>x.kind==="deposit"||/acconto/i.test(x.note||"")),u=h.filter(x=>x!==g),v=g?"Acconto: "+P(g.amount):"";if(!u.length)return v||'<span class="muted">—</span>';const y=Math.round(u[0].amount||0),C=u.every(x=>Math.abs(Math.round(x.amount||0)-y)<=1);return(v?v+" + ":"")+(C?u.length+" rate da "+P(y):"piano personalizzato")}function K(b){return'<tr data-id="'+E(String(b.id))+'"><td>'+new Date(b.date||b.createdAt).toLocaleDateString("it-IT")+"</td><td>"+E(b.clientName||"")+"</td><td>"+E(b.consultantName||"")+"</td><td>"+E(b.services||"")+'</td><td style="text-align:right"><b>'+P(b.vssTotal||0)+"</b></td><td>"+j(b)+'</td><td class="right"><button class="ghost" data-edit="'+E(String(b.id))+'">Modifica</button></td></tr>'}function rt(b){if(!T)return;const h=D("gi-forecast-consultant");if(!h)return;const g=new Map;b.forEach(u=>{const v=String(u.consultantId||"");v&&(g.has(v)||g.set(v,u.consultantName||"User "+v))}),h.innerHTML='<option value="">Tutti</option>'+Array.from(g.entries()).map(([u,v])=>'<option value="'+E(u)+'">'+E(v)+"</option>").join("")}function Y(b,h){const g=b.getFullYear();if(h==="settimanale"){const u=Qt(b);return{key:g*100+u,label:Be("settimanale",mr(b))}}if(h==="mensile"){const u=b.getMonth()+1;return{key:g*100+u,label:Be("mensile",pi(b))}}if(h==="trimestrale"){const u=Math.floor(b.getMonth()/3)+1;return{key:g*10+u,label:Be("trimestrale",Un(b))}}if(h==="semestrale"){const u=b.getMonth()<6?1:2;return{key:g*10+u,label:Be("semestrale",Hn(b))}}return{key:g,label:Be("annuale",Ti(b))}}function Q(){const b=D("gi-forecast-granularity"),h=D("gi-forecast-consultant"),g=b?b.value:"mensile",u=h?h.value:"",v=H.filter(L=>!u||String(L.consultantId||"")===String(u)),y={};v.forEach(L=>{const w=L.clientName||"";(Array.isArray(L.schedule)?L.schedule:[]).forEach(A=>{const V=A&&A.dueDate?new Date(A.dueDate):null;if(!V||isNaN(V))return;const{key:U,label:G}=Y(V,g),ct=Number(A.amount||0);y[U]||(y[U]={label:G,total:0,details:[]}),y[U].total+=ct,y[U].details.push({cliente:w,amount:ct})})});const C=Y(new Date,g).key,x=[],I=[];Object.keys(y).sort((L,w)=>L-w).forEach(L=>{const w=y[L],A=w.details.map(U=>E(U.cliente)+" – "+P(U.amount)).join("<br>"),V="<tr><td>"+E(w.label)+'</td><td style="text-align:right"><b>'+P(w.total)+"</b></td><td>"+A+"</td></tr>";Number(L)<C?x.push(V):I.push(V)});const M=D("gi-forecast-future"),B=D("gi-forecast-past-body");M&&(M.innerHTML=I.join("")||'<tr><td colspan="3" class="muted">Nessun dato</td></tr>'),B&&(B.innerHTML=x.join("")||'<tr><td colspan="3" class="muted">Nessun dato</td></tr>')}function it(){const b=N(),h=D("gi_cons"),g=h?h.value:String(Ct().id),u="?from="+encodeURIComponent(b.from)+"&to="+encodeURIComponent(b.to)+(g?"&userId="+encodeURIComponent(g):"");Mt("/api/gi"+u).then(v=>{let y=v&&v.sales||[];y.sort((C,x)=>+new Date(x.date||x.createdAt||0)-+new Date(C.date||C.createdAt||0)),H=y,D("gi_rows").innerHTML=y.length?y.map(K).join(""):'<tr><td colspan="7" class="muted">Nessuna vendita</td></tr>',J(),rt(y),Q()}).catch(v=>{logger.error(v),xt("Errore caricamento GI")})}function tt(b){const h=b.sale||{},g=Array.isArray(h.schedule)?h.schedule.slice():[],u=g.find(at=>at.kind==="deposit"||/acconto/i.test(at.note||"")),v=g.filter(at=>at!==u),y=v.length>0?v.every(at=>Math.abs((+at.amount||0)-(+v[0].amount||0))<=1):!0,C=v.length&&y?"rate":"manual",x=R(new Date),I='<div class="modal"><div class="card gi-modal"><style>.gi-modal{min-width:min(760px,96vw);max-width:980px;max-height:86vh;overflow:auto}@media (max-width:740px){ .gi-grid{display:block} .gi-col{width:100%} .gi-modal{min-width:96vw} }.gi-grid{display:flex; gap:12px; flex-wrap:wrap} .gi-col{flex:1; min-width:240px}.gi-col input, .gi-col select, .gi-col textarea{width:100%; min-width:0}.gi-section{border-top:1px solid var(--hair, rgba(0,0,0,.12)); padding-top:10px; margin-top:10px}.pilltabs{display:flex; gap:12px; align-items:center} .pilltabs label{display:flex; align-items:center; gap:6px; cursor:pointer; padding:6px 10px; border:1px solid var(--hair, rgba(0,0,0,.15)); border-radius:999px}.mrow{display:flex; gap:8px; align-items:center; flex-wrap:wrap}.mrow label{min-width:96px}.mrow input[type=date], .mrow select{min-width:160px; max-width:100%}.mrow input[type=text]{flex:1; min-width:220px; max-width:100%}.mini input[type=number]{width:120px}.gi-rlist{margin-top:6px; max-height:200px; overflow:auto; border:1px dashed rgba(0,0,0,.15); border-radius:8px; padding:6px}.gi-r{display:flex; gap:6px; align-items:center; padding:4px 0}.gi-r input[type=date]{min-width:160px} .gi-r input[type=number]{width:120px} .gi-r input[type=text]{flex:1; min-width:220px; max-width:100%}.gi-foot{display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:12px}</style><div style="display:flex;justify-content:space-between;align-items:center"><b>'+(b.title||(h.id?"Modifica vendita":"Nuova vendita"))+'</b><button class="ghost" id="m_close">Chiudi</button></div><div class="gi-grid"><div class="gi-col"><label>Data</label><input id="m_date" type="date" value="'+E(R(h.date||x))+'"></div><div class="gi-col"><label>Cliente</label><select id="gi_client_select"><option value="">Caricamento…</option></select></div><div class="gi-col"><label>Totale VSS</label><input id="m_vss" type="number" step="1" value="'+E(Number(h.vssTotal||0))+'"></div></div><div class="gi-section"><label>Servizi</label><textarea id="m_srv" rows="2">'+E(h.services||"")+'</textarea></div><div class="gi-section"><b>Acconto</b><div class="mrow mini" style="margin-top:6px"><label><input id="acc_enable" type="checkbox" '+(u?"checked":"")+'> Abilita</label><label>Tipo</label><select id="acc_type"><option value="abs">Valore assoluto</option><option value="perc">Percentuale</option></select><label>Valore</label><input id="acc_value" type="number" step="1" value="'+(u?E(Number(u._fromPerc?u._rawPerc:u.amount)):"0")+'"><label>Scadenza</label><input id="acc_date" type="date" value="'+E(R(u?u.dueDate:h.date||x))+'"><label>Nota</label><input id="acc_note" placeholder="es. Acconto" value="'+E(u&&u.note||"Acconto")+'"></div></div><div class="gi-section"><b>Modalità pagamenti</b><div class="pilltabs" style="margin:6px 0 8px"><label><input type="radio" name="pmode" value="rate" '+(C==="rate"?"checked":"")+'> Rateale</label><label><input type="radio" name="pmode" value="manual" '+(C!=="rate"?"checked":"")+'> Scaglioni manuali</label></div><div id="p_rate" style="display:'+(C==="rate"?"block":"none")+'"><div class="mrow mini"><label>N° rate</label><input id="rt_n" type="number" value="'+E(v.length||12)+'"><label>Frequenza</label><select id="rt_freq"><option value="M">Mensile</option><option value="Q">Trimestrale</option><option value="W">Settimanale</option><option value="Y">Annuale</option></select><label>Prima scadenza</label><input id="rt_first" type="date" value="'+E(v[0]?R(v[0].dueDate):R(h.date||x))+'"><button class="ghost" id="rt_build">Ricalcola rate</button></div><div id="rt_preview" class="gi-rlist muted small">—</div></div><div id="p_manual" style="display:'+(C!=="rate"?"block":"none")+'"><div class="mrow mini"><button class="ghost" id="mn_add">Aggiungi scaglione</button></div><div id="mn_list" class="gi-rlist"></div></div></div><div class="gi-foot"><div><div id="tot_prog" class="small muted">Programmato: 0€</div><div id="tot_chk"  class="small muted">Totale VSS: 0€</div></div><div style="display:flex;gap:8px">'+(h.id?'<button class="ghost danger" id="m_del">Elimina</button>':"")+'<button id="m_save">Salva</button></div></div></div></div>';showOverlay(I);const M=document.documentElement.style.overflow;document.documentElement.style.overflow="hidden";function B(){document.documentElement.style.overflow=M,hideOverlay()}(function(){const dt=D("gi_client_select");dt.innerHTML='<option value="">— seleziona cliente —</option>'+$.map(ot=>'<option value="'+E(ot.id)+'">'+E(ot.name)+"</option>").join("");const z=h.clientId||h.client_id||"";if(z&&(dt.value=String(z)),!dt.value&&h.clientName){const ot=$.find(ft=>String(ft.name).trim().toLowerCase()===String(h.clientName).trim().toLowerCase());ot&&(dt.value=String(ot.id))}})(),u&&u._fromPerc&&(D("acc_type").value="perc"),Array.from(document.querySelectorAll('input[name="pmode"]')).forEach(at=>{at.addEventListener("change",()=>{const dt=document.querySelector('input[name="pmode"]:checked').value==="rate";D("p_rate").style.display=dt?"block":"none",D("p_manual").style.display=dt?"none":"block",yt()})});function L(at,dt){const z=new Date(at);return z.setMonth(z.getMonth()+dt),z}function w(at,dt){const z=new Date(at);return z.setDate(z.getDate()+dt*7),z}function A(at,dt){const z=new Date(at);return z.setMonth(z.getMonth()+dt*3),z}function V(at,dt){const z=new Date(at);return z.setFullYear(z.getFullYear()+dt),z}function U(){const at=Math.max(1,Number(D("rt_n").value||0)),dt=D("rt_freq").value,z=new Date(D("rt_first").value||x),ot=Math.max(0,Number(D("m_vss").value||0)),ft=_t(),lt=Math.max(0,ot-ft),bt=Math.round(lt/at),It=[];for(let Dt=0;Dt<at;Dt++){let Et;dt==="M"?Et=L(z,Dt):dt==="Q"?Et=A(z,Dt):dt==="W"?Et=w(z,Dt):Et=V(z,Dt),It.push({dueDate:Et.toISOString(),amount:bt,note:"Rata "+(Dt+1)+"/"+at,kind:"installment"})}return G(It),It}function G(at){D("rt_preview").innerHTML=at.map(dt=>"<div>"+new Date(dt.dueDate).toLocaleDateString("it-IT")+" · "+P(dt.amount)+' <span class="muted">'+E(dt.note||"")+"</span></div>").join(""),D("rt_preview")._data=at,yt()}function ct(at){const dt=D("mn_list");dt.innerHTML="",at.forEach((z,ot)=>{const ft=document.createElement("div");ft.className="gi-r",ft.innerHTML='<input type="date" data-k="dueDate" value="'+E(R(z.dueDate))+'"><input type="number" step="1" data-k="amount" value="'+E(Number(z.amount||0))+'" style="width:120px"><input type="text" data-k="note"   value="'+E(z.note||"")+'" placeholder="nota" style="flex:1"><button class="ghost" data-del="'+ot+'">✕</button>',dt.appendChild(ft)}),dt.querySelectorAll("[data-del]").forEach(z=>{z.onclick=()=>{const ot=Number(z.getAttribute("data-del")),ft=dt._data||[];ft.splice(ot,1),ct(ft)}}),dt.oninput=()=>{const z=dt._data||[];Array.from(dt.children).forEach((ft,lt)=>{const bt=z[lt];if(!bt)return;const It=ft.querySelector('[data-k="dueDate"]').value,Dt=Number(ft.querySelector('[data-k="amount"]').value||0),Et=ft.querySelector('[data-k="note"]').value;bt.dueDate=new Date(It).toISOString(),bt.amount=Math.round(Dt),bt.note=Et}),yt()},dt._data=at,yt()}if(D("m_date").value=E(R(h.date||x)),D("m_vss").value=E(Number(h.vssTotal||0)),D("m_srv").value=E(h.services||""),D("acc_type").value=u&&u._fromPerc?"perc":"abs",D("acc_value").value=u?u._fromPerc?u._rawPerc:u.amount:0,D("acc_date").value=E(R(u?u.dueDate:h.date||x)),D("acc_note").value=u?E(u.note||"Acconto"):"Acconto",C==="rate"){const at=v.length||12;D("rt_n").value=at,D("rt_first").value=v[0]?E(R(v[0].dueDate)):E(R(h.date||x)),G(v.length?v:U())}else ct(v);D("rt_build").onclick=()=>G(U()),D("mn_add").onclick=()=>{const dt=D("mn_list")._data||[];dt.push({dueDate:new Date().toISOString(),amount:0,note:"",kind:"manual"}),ct(dt)},D("m_close").onclick=B;function _t(){if(!D("acc_enable").checked)return 0;const at=Math.max(0,Number(D("m_vss").value||0)),dt=D("acc_type").value,z=Number(D("acc_value").value||0);return Math.round(dt==="perc"?at*(z/100):z)}function wt(){const at=[];if(D("acc_enable").checked){const z=_t();at.push({dueDate:new Date(D("acc_date").value||x).toISOString(),amount:z,note:D("acc_note").value||"Acconto",kind:"deposit",_fromPerc:D("acc_type").value==="perc",_rawPerc:Number(D("acc_value").value||0)})}if(document.querySelector('input[name="pmode"]:checked').value==="rate"){const z=(D("rt_preview")._data||[]).map(ot=>Object.assign({},ot));return at.concat(z)}else{const z=(D("mn_list")._data||[]).map(ot=>Object.assign({kind:"manual"},ot));return at.concat(z)}}function yt(){const at=Math.max(0,Number(D("m_vss").value||0)),dt=wt(),z=Math.round(dt.reduce((ot,ft)=>ot+Number(ft.amount||0),0));D("tot_prog").textContent="Programmato: "+P(z),D("tot_chk").textContent="Totale VSS: "+P(at)+(z===at?" OK":" (manca "+P(at-z)+")"),D("m_save").disabled=z!==at||!D("gi_client_select").value}if(["m_vss","acc_enable","acc_type","acc_value","acc_date","rt_n","rt_freq","rt_first"].forEach(at=>{const dt=D(at);dt&&dt.addEventListener("input",yt)}),D("gi_client_select").addEventListener("change",yt),yt(),D("m_save").onclick=()=>{const at=D("gi_client_select").value||"",dt=$.find(ot=>String(ot.id)===String(at));if(!dt){xt("Seleziona un cliente");return}const z={id:h.id||void 0,date:new Date(D("m_date").value||x).toISOString(),clientId:dt.id,clientName:dt.name,vssTotal:Math.round(Number(D("m_vss").value||0)),services:D("m_srv").value||"",schedule:wt()};Promise.resolve(he("/api/gi",z)).then(()=>{B(),haptic("light"),it()}).catch(ot=>{logger.error(ot),xt("Errore salvataggio")})},h.id){const at=D("m_del");at&&(at.onclick=async()=>{if(!confirm("Eliminare definitivamente questa vendita?"))return;const dt=h?JSON.parse(JSON.stringify(h)):null;try{if(await qf("/api/gi?id="+encodeURIComponent(h.id)).catch(()=>he("/api/gi/delete",{id:h.id})),B(),xt("Vendita eliminata"),it(),typeof showUndo=="function"&&dt){const z={date:new Date(dt.date||dt.createdAt||new Date).toISOString(),clientId:dt.clientId,clientName:dt.clientName,vssTotal:Math.round(Number(dt.vssTotal||0)),services:dt.services||"",schedule:Array.isArray(dt.schedule)?dt.schedule:[]};showUndo("Vendita eliminata",function(){return he("/api/gi",z).then(function(){it()})},5e3)}}catch(z){logger.error(z),xt("Errore eliminazione")}})}}function J(){document.querySelectorAll("[data-edit]").forEach(b=>{b.addEventListener("click",()=>{const h=b.getAttribute("data-edit");W(h)})})}document.addEventListener("gi:edit",function(b){const h=b&&b.detail&&b.detail.id;h&&W(h)}),D("gi_add").onclick=()=>{tt({title:"Nuova vendita"})};function W(b){Mt("/api/gi?from=1900-01-01&to=2999-12-31").then(h=>{const g=(h&&h.sales||[]).find(u=>String(u.id)===String(b));if(!g){xt("Vendita non trovata");return}tt({title:"Modifica vendita",sale:g})})}o("gi",()=>{haptic("light"),it()});var ut=D("gi_cons");ut&&(ut.onchange=()=>{haptic("light"),it()});const st=D("gi-forecast-granularity");st&&(st.onchange=()=>{haptic("light"),Q()});const ht=D("gi-forecast-consultant");ht&&(ht.onchange=()=>{haptic("light"),Q()}),nt().then(it)}window.viewGI=window.viewGI||F;function X(){if(!Ct())return t();document.title="Battle Plan – Report",n.innerHTML=me()+'<div class="wrap"><div class="card"><b>Sezioni da includere</b><div id="rep_toggles" class="row" style="margin-top:8px; gap:8px; flex-wrap:wrap"><button class="pill" data-type="mensile" id="tog_mese">Mese</button><button class="pill" data-type="trimestrale" id="tog_trimestre">Trimestre</button><button class="pill" data-type="semestrale" id="tog_semestre">Semestre</button><button class="pill" data-type="annuale" id="tog_anno">Anno</button></div></div><div class="card"><b>Indicatori aggiuntivi</b><div id="rep_indicators" class="row" style="margin-top:8px; gap:8px; flex-wrap:wrap"><button class="pill" data-key="Telefonate" id="ind_Telefonate">Telefonate</button><button class="pill" data-key="AppFissati" id="ind_AppFissati">AppFissati</button><button class="pill" data-key="AppFatti" id="ind_AppFatti">AppFatti</button><button class="pill" data-key="CorsiLeadership" id="ind_CorsiLeadership">CorsiLeadership</button><button class="pill" data-key="iProfile" id="ind_iProfile">iProfile</button><button class="pill" data-key="MBS" id="ind_MBS">MBS</button><button class="pill" data-key="Note" id="ind_Note">Note</button></div></div><div class="card"><b>Report</b><div class="row" style="margin-top:8px"><div style="min-width:320px"><label>Oggetto email</label><input id="report_subject" placeholder="Report BP"></div></div><div class="row" style="margin-top:8px; flex-wrap:wrap"><div style="flex:1 1 100%; min-width:0"><label>Corpo email</label><textarea id="report_body" rows="12" placeholder="Testo del report…" style="width:100%; box-sizing:border-box; overflow:auto; resize:vertical; max-height:70vh; white-space:pre-wrap; word-break:break-word"></textarea></div></div><div class="row" id="report-actions" style="gap:8px;margin-top:8px;flex-wrap:wrap"><button class="ghost" id="rep_copy">Copia report</button><span style="flex:0 0 8px"></span><button class="ghost" id="rep_gmail_web">Gmail Web</button><button class="ghost" id="rep_gmail_app">Gmail App</button></div></div></div>',se();var T=[],D={mensile:!1,trimestrale:!1,semestrale:!1,annuale:!1},E={Telefonate:!0,AppFissati:!0,AppFatti:!0,CorsiLeadership:!0,iProfile:!0,MBS:!0,Note:!0},P=[{k:"VSS",money:!0,label:"VSS"},{k:"VSDPersonale",money:!0,label:"VSDPersonale"},{k:"VSDIndiretto",money:!0,label:"VSDIndiretto"},{k:"GI",money:!0,label:"GI"},{k:"Telefonate",money:!1,label:"Telefonate"},{k:"AppFissati",money:!1,label:"AppFissati"},{k:"AppFatti",money:!1,label:"AppFatti"},{k:"CorsiLeadership",money:!1,label:"CorsiLeadership"},{k:"iProfile",money:!1,label:"iProfile"},{k:"MBS",money:!1,label:"MBS"},{k:"NNCF",money:!1,label:"NNCF"}];function R(z){return E[z]!==!1}function N(z){return document.getElementById(z)}var $=N("report_body");function H(z,ot){var ft=new Date(z.getTime());return ft.setDate(ft.getDate()+ot),ft}function nt(z){return sn(z.getFullYear(),Qt(z))}function j(z){var ot=nt(z);return nt(H(ot.start,7))}function K(z){var ot=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];return ot[z.getMonth()]}function rt(z){return Math.floor(z.getMonth()/3)+1}function Y(z){return z.getMonth()<6?1:2}function Q(z){var ot=z.getDay();return ot===5||ot===6||ot===0}function it(z,ot){return z==="mensile"?{start:pi(ot),end:lo(ot)}:z==="trimestrale"?{start:Un(ot),end:co(ot)}:z==="semestrale"?{start:Hn(ot),end:uo(ot)}:{start:Ti(ot),end:Ii(ot)}}function tt(z,ot){return ot>=H(z,-7)&&ot<=H(z,5)}function J(z,ot){var ft=it(z,ot),lt=it(z,H(ft.start,-1)),bt=it(z,H(ft.end,1)),It=tt(lt.end,ot),Dt=tt(ft.end,ot);return It&&!Dt?{closing:lt,next:ft}:{closing:ft,next:bt}}function W(z,ot,ft){for(var lt=0;lt<T.length;lt++){var bt=T[lt];if(bt.type===z&&oe(bt.startDate)===oe(ot)&&oe(bt.endDate)===oe(ft))return bt}return null}function ut(z,ot){var ft=z&&z[ot];return Number(ft||0)}function st(z){return ie(z)+"€"}function ht(z,ot){var ft=P.some(function(lt){return lt.k===z&&lt.money});return ft?st(ot):ie(ot)}function b(z,ot){return z>ot?"↑":z<ot?"↓":"="}function h(z,ot,ft,lt){var bt=W(ot,ft,lt)||{},It=bt.indicatorsPrev||{},Dt=bt.indicatorsCons||{},Et=[z,""];return P.forEach(function(q){if(R(q.k)){var Z=ut(It,q.k),pt=ut(Dt,q.k);Et.push(q.label+" "+ht(q.k,pt)+" vs "+ht(q.k,Z)+" di previsionali ("+b(pt,Z)+")")}}),E.Note&&Et.push("Note:"),Et.join("\n")}function g(z,ot,ft,lt){var bt=W(ot,ft,lt)||{},It=bt.indicatorsPrev||{},Dt=[z,""];return P.forEach(function(Et){R(Et.k)&&Dt.push(Et.label+" "+ht(Et.k,ut(It,Et.k)))}),E.Note&&Dt.push("Possibili note:"),Dt.join("\n")}function u(z){return"BP CONSUNTIVO SETT. "+Qt(z)+" "+z.getFullYear()}function v(z){return"BP PREVISIONALE SETT. "+Qt(z)+" "+z.getFullYear()}function y(z){return"BP CONSUNTIVO "+K(z)+" "+z.getFullYear()}function C(z){var ot=K(z);return"BP PREVISIONALE "+ot+" "+z.getFullYear()}function x(z){return"BP CONSUNTIVO T"+rt(z)+" "+z.getFullYear()}function I(z){return"BP PREVISIONALE T"+rt(z)+" "+z.getFullYear()}function M(z){return"BP CONSUNTIVO S"+Y(z)+" "+z.getFullYear()}function B(z){return"BP PREVISIONALE S"+Y(z)+" "+z.getFullYear()}function L(z){return"BP CONSUNTIVO "+z.getFullYear()}function w(z){return"BP PREVISIONALE "+z.getFullYear()}function A(){var z=new Date,ot=[];if(Q(z)){var ft=nt(z),lt=j(z);ot.push(h(u(ft.start),"settimanale",ft.start,ft.end)),ot.push(g(v(lt.start),"settimanale",lt.start,lt.end))}function bt(It,Dt,Et){var q=J(It,z);ot.push(h(Dt(q.closing.start),It,q.closing.start,q.closing.end)),ot.push(g(Et(q.next.start),It,q.next.start,q.next.end))}D.mensile&&bt("mensile",y,C),D.trimestrale&&bt("trimestrale",x,I),D.semestrale&&bt("semestrale",M,B),D.annuale&&bt("annuale",L,w),$.value=ot.join("\n\n")+(ot.length?"\n":"")}function V(z,ot){z.classList.toggle("active",!!ot),z.style.opacity=ot?"1":"0.65"}function U(){V(N("tog_mese"),D.mensile),V(N("tog_trimestre"),D.trimestrale),V(N("tog_semestre"),D.semestrale),V(N("tog_anno"),D.annuale)}function G(){Object.keys(E).forEach(function(z){var ot=N("ind_"+z);ot&&V(ot,E[z])})}function ct(){var z=new Date;function ot(ft){var lt=it(ft,z),bt=it(ft,H(lt.start,-1));return tt(lt.end,z)||tt(bt.end,z)}D.mensile=ot("mensile"),D.trimestrale=ot("trimestrale"),D.semestrale=ot("semestrale"),D.annuale=ot("annuale"),U()}function _t(){function z(ot){var ft=ot.currentTarget.getAttribute("data-type");D[ft]=!D[ft],U(),A()}N("tog_mese").onclick=z,N("tog_trimestre").onclick=z,N("tog_semestre").onclick=z,N("tog_anno").onclick=z}function wt(){function z(ot){var ft=ot.currentTarget.getAttribute("data-key");E[ft]=!E[ft],G(),A()}Object.keys(E).forEach(function(ot){var ft=N("ind_"+ot);ft&&(ft.onclick=z)})}function yt(z){return encodeURIComponent(String(z||""))}function at(){var z=N("rep_gmail_web"),ot=N("rep_gmail_app"),ft=N("rep_copy");ft&&(ft.onclick=function(){try{navigator.clipboard.writeText($.value||"");var lt=ft.textContent;ft.textContent="Copiato!",setTimeout(function(){ft.textContent=lt},1200)}catch(bt){}}),!(!z||!ot)&&Mt("/api/users_emails").then(function(lt){var bt=(lt&&lt.emails||(lt&&lt.users||[]).map(function(Et){return Et.email})).filter(Boolean).join(",");function It(){return N("report_subject").value||"Report BP"}function Dt(){return $.value||""}z.onclick=function(){try{navigator.clipboard.writeText(Dt())}catch(q){}var Et="https://mail.google.com/mail/?view=cm&fs=1&tf=1&su="+yt(It())+"&cc="+yt(bt)+"&body="+yt(Dt());window.open(Et,"_blank"),document.dispatchEvent(new Event("report:composed"))},ot.onclick=function(){try{navigator.clipboard.writeText(Dt())}catch(q){}var Et="googlegmail:///co?subject="+yt(It())+"&cc="+yt(bt)+"&body="+yt(Dt());location.href=Et,document.dispatchEvent(new Event("report:composed")),setTimeout(function(){document.hidden||(location.href="mailto:?subject="+yt(It())+"&cc="+yt(bt)+"&body="+yt(Dt()),document.dispatchEvent(new Event("report:composed")))},1200)}})}function dt(){Mt("/api/periods").then(function(z){T=z&&z.periods||[],ct(),G(),wt(),_t(),A(),at()})}dt()}function et(){var T=Ct();if(!T)return t();if(document.title="Battle Plan – Utenti",T.role==="admin"){let D=function(P){var R=zt(P.name||P.email||"user_"+P.id),N=P.grade==="senior"?"senior":"junior",$=P.role==="admin"?"admin":"consultant";return'<div class="card" style="flex:1 1 380px"><div><b>'+R+'</b> <span class="small muted">('+zt($)+')</span></div><div class="row" style="margin-top:6px"><div><label>Nome</label><input data-nfor="'+P.id+'" type="text" value="'+zt(P.name||"")+'"></div><div><label>Email</label><input data-efor="'+P.id+'" type="email" value="'+zt(P.email||"")+'"></div></div><div class="row"><div><label>Nuova password</label><input data-pfor="'+P.id+'" type="password" placeholder="(opzionale)"></div><div><label>Grade</label><select data-gfor="'+P.id+'"><option value="junior"'+(N==="junior"?" selected":"")+'>Junior</option><option value="senior"'+(N==="senior"?" selected":"")+'>Senior</option></select></div><div><label>Ruolo</label><select data-rfor="'+P.id+'"><option value="consultant"'+($==="consultant"?" selected":"")+'>Consulente</option><option value="admin"'+($==="admin"?" selected":"")+'>Admin</option></select></div><div class="right" style="align-self:flex-end"><button class="ghost" data-save="'+P.id+'">Aggiorna</button> <button class="danger" data-del="'+P.id+'" title="Elimina utente">Elimina</button></div></div></div>'},E=function(){Mt("/api/users").then(function(P){var R=P&&P.users||[],N=_e("#users_list");N&&(N.innerHTML=R.map(D).join(""),fo("[data-save]").forEach(function($){$.addEventListener("click",function(){var H=$.getAttribute("data-save"),nt=(_e('input[data-nfor="'+H+'"]')||{}).value||"",j=(_e('input[data-efor="'+H+'"]')||{}).value||"",K=(_e('select[data-gfor="'+H+'"]')||{}).value||"junior",rt=(_e('select[data-rfor="'+H+'"]')||{}).value||"consultant",Y=_e('input[data-pfor="'+H+'"]'),Q=Y?Y.value:"",it={id:H,name:nt,email:j,grade:K,role:rt};Q&&(it.password=Q),he("/api/users",it).then(function(){xt("Aggiornato"),window.addXP(5),Y&&(Y.value="")}).catch(function(tt){logger.error(tt),xt("Errore aggiornamento")})})}),fo("[data-del]").forEach(function($){$.addEventListener("click",function(){var H=$.getAttribute("data-del");if(confirm("Eliminare definitivamente questo utente?")){var nt=(Array.isArray(R)?R:[]).find(function(j){return String(j.id)===String(H)});fetch("/api/users?id="+encodeURIComponent(H),{method:"DELETE",headers:{Authorization:"Bearer "+ki()}}).then(function(j){if(!j.ok)throw new Error("HTTP "+j.status);return j.json()}).then(function(){if(xt("Utente eliminato"),E(),typeof showUndo=="function"&&nt){var j={id:nt.id,name:nt.name,email:nt.email,grade:nt.grade,role:nt.role};showUndo("Utente eliminato",function(){return he("/api/users",j).then(function(){E()})},5e3)}}).catch(function(j){logger.error(j),xt("Errore eliminazione")})}})}))})};n.innerHTML=me()+'<div class="wrap"><div class="card"><b>Gestione utenti</b><div id="users_list" class="row" style="margin-top:8px"></div></div></div>',se(),E()}else n.innerHTML=me()+'<div class="wrap"><div class="card"><b>Il mio profilo</b><div class="row" style="margin-top:8px"><div><label>Nome</label><input id="p_name" type="text" value="'+zt(T.name||"")+'"></div><div><label>Email</label><input id="p_email" type="email" value="'+zt(T.email||"")+'"></div></div><div class="row"><div><label>Nuova password</label><input id="p_pwd" type="password" placeholder="Lascia vuoto per non cambiare"></div><div class="right" style="align-self:flex-end"><button id="p_save">Aggiorna</button></div></div><div class="row"><div><label>Ruolo</label><input value="'+zt(T.role||"consultant")+'" disabled></div><div><label>Grade</label><input value="'+zt(T.grade||"junior")+'" disabled></div></div></div></div>',se(),_e("#p_save").onclick=function(){var D=_e("#p_name").value.trim(),E=_e("#p_email").value.trim(),P=_e("#p_pwd").value;if(!D||!E){xt("Nome ed email obbligatori");return}var R={id:T.id,name:D,email:E};P&&(R.password=P),he("/api/users/profile",R).then(function(){xt("Profilo aggiornato"),window.addXP(3);var N=Ct();N&&(N.name=D,N.email=E,localStorage.setItem("user",JSON.stringify(N)));try{document.dispatchEvent(new Event("user:profile-updated"))}catch($){}}).catch(function(N){logger.error(N),xt(N.message||"Errore aggiornamento")})}}window.viewHome=c,window.viewCalendar=d,window.viewPeriods=f,window.viewAppointments=p,window.viewLeaderboard=m,window.viewClients=_,window.viewTeam=S,window.viewCommissions=k,window.viewVendite=O,window.viewReport=X,window.viewUsers=et,window.toggleDrawer=Ni,window.logout=jf,window.rerenderTopbarSoon=rh,document.addEventListener("DOMContentLoaded",function(){nh(),Ct()?(se(),c()):t()})})();export{ch as __vite_legacy_guard};
