function Xt(){import.meta.url,import("_").catch(()=>1),(async function*(){})().next()}function ke(d,a){localStorage.setItem(d,typeof a=="string"?a:JSON.stringify(a))}function Ge(d,a){const j=localStorage.getItem(d);if(j==null)return a;try{return JSON.parse(j)}catch(de){return j}}function Oe(d){localStorage.removeItem(d)}function Mt(d,a){a?ke("bp_token",d):sessionStorage.setItem("bp_token",d)}function et(){return localStorage.getItem("bp_token")||sessionStorage.getItem("bp_token")||""}function kt(d){ke("bp_user",d)}function ue(){return Ge("bp_user",null)||null}function Nt(){Oe("bp_token"),sessionStorage.removeItem("bp_token"),Oe("bp_user"),location.href="/?v=13"}function rt(d,a={}){a.method=a.method||"GET";const j={...a.headers||{}},de=et();return de&&(j.Authorization="Bearer "+de),a.body!=null&&typeof a.body!="string"&&(j["Content-Type"]="application/json; charset=utf-8",a.body=JSON.stringify(a.body)),a.headers=j,fetch(d,a).then(At)}async function At(d){const a=await d.text();if(!d.ok)throw Lt(a,d);return Ft(a,d)}function Lt(d,a){try{const j=JSON.parse(d).error||"";return new Error(j||a.statusText||"HTTP "+a.status)}catch(j){return new Error(a.statusText||"HTTP "+a.status)}}function Ft(d,a){try{if((a.headers.get("content-type")||"").toLowerCase().indexOf("application/json")!==-1)return d?JSON.parse(d):{}}catch(j){}return d}function ne(d,a){return rt(d,Object.assign({method:"GET"},{}))}function Ie(d,a){return rt(d,{method:"POST",body:a||{}})}function xe(d){return(d<10?"0":"")+d}function Re(d){const a=new Date(d);return xe(a.getDate())+"/"+xe(a.getMonth()+1)+"/"+a.getFullYear()}function Pe(d){const a=new Date(d);return a.getFullYear()+"-"+xe(a.getMonth()+1)+"-"+xe(a.getDate())}function Vt(d){const a=new Date(d);return xe(a.getHours())+":"+xe(a.getMinutes())}function Ot(d){const a=new Date(d);a.setHours(0,0,0,0);const j=(a.getDay()+6)%7;return a.setDate(a.getDate()-j),a}function Je(d){const a=new Date(d);return new Date(a.getFullYear(),a.getMonth(),1)}function Ke(d){const a=new Date(d);return new Date(a.getFullYear(),a.getMonth()+1,0,23,59,59,999)}function ge(d){const a=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate())),j=a.getUTCDay()||7;a.setUTCDate(a.getUTCDate()+4-j);const de=new Date(Date.UTC(a.getUTCFullYear(),0,1));return Math.ceil(((a-de)/864e5+1)/7)}function ze(d){const a=new Date(d),j=Math.floor(a.getMonth()/3);return new Date(a.getFullYear(),j*3,1)}function Ze(d){const a=ze(d);return new Date(a.getFullYear(),a.getMonth()+3,0,23,59,59,999)}function je(d){const a=new Date(d),j=a.getMonth()<6?0:6;return new Date(a.getFullYear(),j,1)}function Qe(d){const a=je(d);return new Date(a.getFullYear(),a.getMonth()+6,0,23,59,59,999)}function tt(d){const a=new Date(d);return new Date(a.getFullYear(),0,1)}function qe(d){const a=new Date(d);return new Date(a.getFullYear(),11,31,23,59,59,999)}function Ut(d,a){const j=new Date(d,0,1+(a-1)*7),de=j.getDay()||7,ye=new Date(j);return ye.setDate(j.getDate()-(de-1)),ye.setHours(0,0,0,0),ye}function Me(d,a){const j=Ut(d,a),de=new Date(j);return de.setDate(j.getDate()+6),de.setHours(23,59,59,999),{start:j,end:de}}function Rt(d){const a=Ot(d);a.setDate(a.getDate()+7);const j=new Date(a);return j.setDate(a.getDate()+6),j.setHours(23,59,59,999),{start:a,end:j}}function Ht(d){const a=new Date(d.getFullYear(),d.getMonth()+1,1);return{start:a,end:new Date(a.getFullYear(),a.getMonth()+1,0,23,59,59,999)}}function Yt(d){const a=ze(new Date(d.getFullYear(),d.getMonth()+3,1));return{start:a,end:new Date(a.getFullYear(),a.getMonth()+3,0,23,59,59,999)}}function Gt(d){const a=je(new Date(d.getFullYear(),d.getMonth()+6,1));return{start:a,end:new Date(a.getFullYear(),a.getMonth()+6,0,23,59,59,999)}}function qt(d){const a=tt(new Date(d.getFullYear()+1,0,1));return{start:a,end:qe(a)}}function He(d,a){const j=new Date(a);return d==="settimanale"?"Sett. "+ge(new Date(a))+" "+j.getFullYear():d==="mensile"?j.toLocaleString("it-IT",{month:"long",year:"numeric"}):d==="trimestrale"?"Trimestre "+(Math.floor(j.getMonth()/3)+1)+" "+j.getFullYear():d==="semestrale"?(j.getMonth()<6?"1°":"2°")+" semestre "+j.getFullYear():d==="annuale"?"Anno "+j.getFullYear():d==="ytd"?"YTD "+j.getFullYear():d==="ltm"?"Ultimi 12 mesi":d}function K(d){const a=document.createElement("div");a.className="toast",a.textContent=d,document.body.appendChild(a),setTimeout(function(){try{a.remove()}catch(j){}},2200)}function Ye(){const d=document.createElement("div");d.className="confetti",document.body.appendChild(d);for(let a=0;a<26;a++){const j=document.createElement("span");j.style.position="absolute",j.style.left=2+a*4+"%",j.style.top="0",j.style.width="6px",j.style.height="10px",j.style.background="hsl("+a*14+",90%,60%)",j.style.opacity="0.95",d.appendChild(j),(function(de,ye){setTimeout(function(){de.animate&&de.animate([{transform:"translateY(-20px) rotate(0deg)"},{transform:"translateY(110vh) rotate(540deg)"}],{duration:1200+Math.random()*800,easing:"cubic-bezier(.2,.6,.2,1)"})},ye)})(j,a*35)}setTimeout(function(){try{d.remove()}catch(a){}},2500)}function ce(d){return String(d).replace(/[&<>'"]/g,function(a){return{"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"}[a]})}function Le(d){return(Number(d)||0).toLocaleString("it-IT")+"€"}function Ce(d){const a=Number(d)||0;return String(Math.round(a))}function zt(){if(document.getElementById("bp-mobile-drawer-fix"))return;const d="\n  @media (max-width:980px){\n    .topbar{\n      background: rgba(20,24,34,.90) !important;\n      border-bottom: 1px solid rgba(255,255,255,.08) !important;\n    }\n    .drawer{\n      background: rgba(20,24,34,.96) !important;\n      box-shadow: 14px 0 28px rgba(0,0,0,.45) !important;\n      width: 86vw !important;\n      overflow-y: auto !important;\n    }\n    .drawer .row{ gap:10px !important; }\n    .drawer button{\n      background: rgba(255,255,255,.10) !important;\n      border: 1px solid rgba(255,255,255,.22) !important;\n      color: #fff !important;\n      padding: 12px 14px !important;\n      font-weight: 700 !important;\n      border-radius: 12px !important;\n      -webkit-tap-highlight-color: transparent;\n    }\n    .drawer button:hover{\n      background: rgba(255,255,255,.14) !important;\n      border-color: rgba(255,255,255,.30) !important;\n    }\n    .drawer button.ghost{\n      background: rgba(255,255,255,.10) !important;\n      box-shadow: none !important;\n    }\n  }",a=document.createElement("style");a.id="bp-mobile-drawer-fix",a.textContent=d,document.head.appendChild(a)}function jt(){if(document.getElementById("bp-mobile-light-fix"))return;const d="\n    @media (max-width:980px) and (prefers-color-scheme: light){\n      .topbar{\n        background:#fff !important;\n        border-bottom:1px solid rgba(0,0,0,.08) !important;\n        box-shadow:none !important;\n      }\n      .topbar .brand .logo{\n        color:#0f172a !important;\n        font-weight:900 !important;\n        letter-spacing:.4px;\n        text-shadow:none !important;\n        opacity:1 !important;\n      }\n      .topbar .hamb span{ background:#0f172a !important; }\n      .card{\n        background:#fff !important;\n        background-image:none !important;\n        box-shadow:none !important;\n      }\n      .drawer{\n        background:#fff !important;\n        box-shadow:14px 0 28px rgba(0,0,0,.10) !important;\n      }\n      .drawer button{\n        color:#0f172a !important;\n        background:rgba(0,0,0,.04) !important;\n        border:1px solid rgba(0,0,0,.12) !important;\n      }\n      .drawer button:hover{\n        background:rgba(0,0,0,.08) !important;\n      }\n    }\n  ",a=document.createElement("style");a.id="bp-mobile-light-fix",a.textContent=d,document.head.appendChild(a)}function Wt(){if(document.getElementById("bp-badge-light-css"))return;const d="\n    @media (prefers-color-scheme: light){\n      .badge{\n        background: linear-gradient(180deg, #eef2ff, #f8fafc) !important;\n        border: 1px solid #c7d2fe !important;\n        color: #0f172a !important;\n        font-weight: 700 !important;\n        padding: 6px 10px !important;\n        border-radius: 9999px !important;\n        letter-spacing: .2px !important;\n        box-shadow: 0 1px 0 rgba(15,23,42,.05) inset !important;\n      }\n      .chip, .tag{\n        background: #ffffff !important;\n        border: 1px solid #cbd5e1 !important;\n        color: #0f172a !important;\n        font-weight: 600 !important;\n        border-radius: 9999px !important;\n      }\n      .card .badge{\n        background: #fff !important;\n      }\n    }\n  ",a=document.createElement("style");a.id="bp-badge-light-css",a.textContent=d,document.head.appendChild(a)}function De(){const d=ue();if(!d)return"";const a=d.role==="admin",j='<span class="badge">Lvl '+(window.level?window.level():"")+" · XP "+(window.getXP?window.getXP():"")+"</span>",de='<div id="drawer" class="drawer" role="dialog" aria-modal="true" aria-label="Menu"><div class="row"><button class="ghost" onclick="viewHome();toggleDrawer(false)">Dashboard</button><button class="ghost" onclick="viewCalendar();toggleDrawer(false)">Calendario</button><button class="ghost" onclick="viewPeriods();toggleDrawer(false)">BP</button><button class="ghost" onclick="viewAppointments();toggleDrawer(false)">Appuntamenti</button><button class="ghost" onclick="viewLeaderboard();toggleDrawer(false)">Classifiche</button><button class="ghost" onclick="viewCommissions();toggleDrawer(false)">Provvigioni</button><button class="ghost" onclick="viewGI();toggleDrawer(false)">GI &amp; Scadenzario</button><button class="ghost" onclick="viewReport();toggleDrawer(false)">Report</button><button class="ghost" onclick="viewClients();toggleDrawer(false)">Clienti</button><button class="ghost" onclick="viewTeam();toggleDrawer(false)">Squadra</button>'+(a?'<button class="ghost" onclick="viewUsers();toggleDrawer(false)">Utenti</button>':"")+'<button onclick="logout()">Logout</button></div></div>';return'<div class="topbar"><div class="brand"><button class="hamb" id="hamb" aria-label="Apri menu" aria-controls="drawer" aria-expanded="false"><span></span><span></span><span></span></button><div class="logo">BATTLE PLAN</div></div><div class="nav right">'+j+'<button class="ghost" onclick="viewHome()">Dashboard</button><button class="ghost" onclick="viewCalendar()">Calendario</button><button class="ghost" onclick="viewPeriods()">BP</button><button class="ghost" onclick="viewAppointments()">Appuntamenti</button><button class="ghost" onclick="viewLeaderboard()">Classifiche</button><button class="ghost" onclick="viewCommissions()">Provvigioni</button><button class="ghost" onclick="viewGI()">GI &amp; Scadenzario</button><button class="ghost" onclick="viewReport()">Report</button><button class="ghost" onclick="viewClients()">Clienti</button><button class="ghost" onclick="viewTeam()">Squadra</button>'+(a?'<button class="ghost" onclick="viewUsers()">Utenti</button>':"")+'<button onclick="logout()">Logout</button></div></div>'+de}function he(){if(!ue())return;if(!document.getElementById("bp_nav_contrast_css")){const fe="\n      @media (min-width: 1024px){\n        .topbar .nav .ghost{\n          background: rgba(255,255,255,.06);\n          border: 1px solid rgba(255,255,255,.18);\n        }\n        .topbar .nav .ghost:hover{\n          background: rgba(255,255,255,.12);\n        }\n      }\n    ",Ne=document.createElement("style");Ne.id="bp_nav_contrast_css",Ne.textContent=fe,document.head.appendChild(Ne)}const d=document.getElementById("app"),a=document.querySelector(".topbar"),j=De();a?a.outerHTML=j:d&&d.insertAdjacentHTML("afterbegin",j);try{zt()}catch(fe){}try{jt()}catch(fe){}try{Wt()}catch(fe){}const de=document.getElementById("hamb");de&&(de.onclick=function(){We()});const ye=document.getElementById("drawer");ye&&ye.addEventListener("click",function(fe){fe.target.id==="drawer"&&We(!1)}),document.removeEventListener("keydown",at,!1),document.addEventListener("keydown",at,!1)}function at(d){if(d&&d.key==="Escape"){const a=document.getElementById("drawer");a&&a.classList.contains("open")&&We(!1)}}function We(d){const a=document.getElementById("drawer");if(!a)return;const j=typeof d=="boolean"?d:!a.classList.contains("open");a.classList.toggle("open",j);const de=document.getElementById("hamb");de&&de.setAttribute("aria-expanded",String(j)),document.body.classList.toggle("no-scroll",j)}let it=null;function $t(){clearTimeout(it),it=setTimeout(he,60)}function Ee(d){return document.querySelector(d)}function ot(d){return Array.from(document.querySelectorAll(d))}(function(){var d=document.getElementById("app");window.$1=window.$1||Ee,window.$all=window.$all||ot,typeof window.haptic!="function"&&(window.haptic=function(){});function a(){document.title="Battle Plan – Login";var t='<div class="hero" id="hero"><div class="layer glow"></div><div class="layer grid"></div><div class="title">Pianifica. Eroga. Vinci. <span class="small muted">BP – stile gaming</span></div></div><div class="wrap"><div class="grid"><div class="card"><h3>Accedi</h3><form id="loginForm" autocomplete="on"><div class="row"><div><label>Email</label><input id="li_email" name="email" type="email" autocomplete="username" required></div><div><label>Password</label><input id="li_password" name="password" type="password" autocomplete="current-password" required></div></div><div class="row"><label class="small"><input type="checkbox" id="li_remember" checked> Rimani collegato</label></div><div class="right" style="margin-top:8px"><button type="submit" id="btnLogin">Accedi</button></div></form></div><div class="card"><h3>Registrati</h3><form id="regForm" autocomplete="on"><div class="row"><div><label>Nome</label><input id="re_name" name="name" type="text" required></div><div><label>Email</label><input id="re_email" name="email" type="email" autocomplete="username" required></div><div><label>Password</label><input id="re_password" name="new-password" type="password" autocomplete="new-password" required></div></div><div class="right" style="margin-top:8px"><button type="submit" id="btnRegister">Registrati</button></div></form></div></div></div>';d.innerHTML=t;var n=document.getElementById("hero");n&&n.addEventListener("pointermove",function(U){var w=n.getBoundingClientRect();n.style.setProperty("--gx",(U.clientX-w.left)/w.width*100+"%"),n.style.setProperty("--gy",(U.clientY-w.top)/w.height*100+"%")});var k=document.getElementById("loginForm"),l=document.getElementById("regForm");k.addEventListener("submit",function(U){U.preventDefault();var w=document.getElementById("btnLogin");w.disabled=!0;var P=document.getElementById("li_email").value.trim().toLowerCase(),x=document.getElementById("li_password").value,te=document.getElementById("li_remember").checked;Ie("/api/login",{email:P,password:x}).then(function(A){if(typeof A=="string")try{A=JSON.parse(A)}catch(R){}Mt(A.token,te),kt(A.user),K("Bentornato "+A.user.name+"!"),addXP(10),$e(),he(),window.BPPush&&window.BPPush.subscribe()}).catch(function(A){K("Credenziali errate"),logger.error(A)}).finally(function(){w.disabled=!1})}),l.addEventListener("submit",function(U){U.preventDefault();var w=document.getElementById("btnRegister");w.disabled=!0;var P=document.getElementById("re_name").value.trim(),x=document.getElementById("re_email").value.trim().toLowerCase(),te=document.getElementById("re_password").value;Ie("/api/register",{name:P,email:x,password:te}).then(function(){K("Registrazione ok. Ora accedi"),Ye(),addXP(20),window.scrollTo({top:0,behavior:"smooth"})}).catch(function(A){K("Email già registrata?"),logger.error(A)}).finally(function(){w.disabled=!1})})}function j(t){const n=new Date().getFullYear(),k=new Date().getMonth()+1,l=ge(new Date);return'<div class="row"><div><label>Granularità</label><select id="'+t+'_gran"><option value="settimanale">Settimanale</option><option value="mensile" selected>Mensile</option><option value="trimestrale">Trimestrale</option><option value="semestrale">Semestrale</option><option value="annuale">Annuale</option><option value="ytd">Anno corrente (YTD)</option><option value="ltm">Ultimi 12 mesi (LTM)</option></select></div><div id="'+t+'_wrap_week" style="display:none"><label>Settimana ISO</label><div class="row"><input type="number" id="'+t+'_week" min="1" max="53" value="'+l+'"><input type="number" id="'+t+'_year_w" min="2000" max="2100" value="'+n+'"></div></div><div id="'+t+'_wrap_month"><label>Mese</label><div class="row"><input type="number" id="'+t+'_month" min="1" max="12" value="'+k+'"><input type="number" id="'+t+'_year_m" min="2000" max="2100" value="'+n+'"></div></div><div id="'+t+'_wrap_quarter" style="display:none"><label>Trimestre</label><div class="row"><input type="number" id="'+t+'_quarter" min="1" max="4" value="'+Math.floor((k-1)/3)+1+'"><input type="number" id="'+t+'_year_q" min="2000" max="2100" value="'+n+'"></div></div><div id="'+t+'_wrap_sem" style="display:none"><label>Semestre</label><div class="row"><select id="'+t+'_sem"><option value="1">1°</option><option value="2">2°</option></select><input type="number" id="'+t+'_year_s" min="2000" max="2100" value="'+n+'"></div></div><div id="'+t+'_wrap_year" style="display:none"><label>Anno</label><input type="number" id="'+t+'_year" min="2000" max="2100" value="'+n+'"></div><div style="align-self:flex-end"><button id="'+t+'_refresh" class="ghost">Aggiorna</button></div></div>'}(function(){const t=[];window.onUnifiedRangeChange=function(n){typeof n=="function"&&t.push(n)},window.emitUnifiedRangeChange=function(n){for(const k of t)try{k(n)}catch(l){logger.error(l)}}})();function de(t){return t==="d"||t==="dash"?"dash":t==="cm"||t==="comm"?"comm":t==="tg"||t==="t"||t==="team"?"t":t}function ye(t,n){function k(){const U=document.getElementById(t+"_gran").value;["week","month","quarter","sem","year"].forEach(P=>{const x=document.getElementById(t+"_wrap_"+P);x&&(x.style.display="none")}),U==="settimanale"?document.getElementById(t+"_wrap_week").style.display="":U==="mensile"?document.getElementById(t+"_wrap_month").style.display="":U==="trimestrale"?document.getElementById(t+"_wrap_quarter").style.display="":U==="semestrale"?document.getElementById(t+"_wrap_sem").style.display="":U==="annuale"&&(document.getElementById(t+"_wrap_year").style.display="")}["gran","week","year_w","month","year_m","quarter","year_q","sem","year_s","year"].forEach(U=>{const w=document.getElementById(t+"_"+U);w&&(w.onchange=()=>{k(),n&&n(),window.emitUnifiedRangeChange(de(t))},w.oninput=()=>{k()})});const l=document.getElementById(t+"_refresh");l&&(l.onclick=()=>{n&&n(),window.emitUnifiedRangeChange(de(t))}),k()}function fe(t){var n=new Date;function k(c,o){var B=document.getElementById(t+"_"+c),y=B?parseInt(B.value,10):NaN;return isFinite(y)?y:o}var l=document.getElementById(t+"_gran"),U=l?l.value:"mensile",w={type:U,start:null,end:null};if(U==="settimanale"){var P=k("year_w",n.getFullYear()),x=Math.max(1,Math.min(53,k("week",ge(n)))),te=Me(P,x);return w.start=te.start,w.end=te.end,w}if(U==="mensile"){var A=k("year_m",n.getFullYear()),R=Math.max(1,Math.min(12,k("month",n.getMonth()+1)));return w.start=new Date(A,R-1,1),w.end=new Date(A,R,0,23,59,59,999),w}if(U==="trimestrale"){var h=k("year_q",n.getFullYear()),b=Math.max(1,Math.min(4,k("quarter",Math.floor(n.getMonth()/3)+1)));return w.start=new Date(h,(b-1)*3,1),w.end=new Date(h,b*3,0,23,59,59,999),w}if(U==="semestrale"){var p=k("year_s",n.getFullYear()),i=k("sem",n.getMonth()<6?1:2);return w.start=new Date(p,i===1?0:6,1),w.end=new Date(p,i===1?6:12,0,23,59,59,999),w}if(U==="annuale"){var g=k("year",n.getFullYear());return w.start=new Date(g,0,1),w.end=new Date(g,11,31,23,59,59,999),w}if(U==="ytd"){var s=new Date(n.getFullYear(),n.getMonth()+1,0,23,59,59,999);return w.start=new Date(n.getFullYear(),0,1),w.end=s,w}if(U==="ltm"){var F=new Date(n.getFullYear(),n.getMonth()+1,0,23,59,59,999),r=new Date(F.getFullYear(),F.getMonth()-11,1);return w.start=r,w.end=F,w}return w.type="mensile",w.start=new Date(n.getFullYear(),n.getMonth(),1),w.end=new Date(n.getFullYear(),n.getMonth()+1,0,23,59,59,999),w}function Ne(t){return t==="ytd"||t==="ltm"?"mensile":t}window.effectivePeriodType=Ne;function Ue(t,n){var k=Ne(t||"mensile"),l=n?new Date(n):new Date,U=l.getUTCFullYear(),w=[];function P(C,E){w.push({s:C.getTime(),e:E.getTime()})}function x(C,E,O){return new Date(Date.UTC(C,E,O))}function te(C){return new Date(C.getTime()+24*3600*1e3-1)}function A(C,E){return new Date(Date.UTC(C,E+1,0))}if(k==="settimanale"){var R=new Date(Date.UTC(l.getUTCFullYear(),l.getUTCMonth(),l.getUTCDate())),h=(R.getUTCDay()+6)%7;R.setUTCDate(R.getUTCDate()-h);for(var b=52;b>=0;b--){var p=new Date(R);p.setUTCDate(R.getUTCDate()-b*7);var i=new Date(p);i.setUTCDate(p.getUTCDate()+6),i.setUTCHours(23,59,59,999),P(p,i)}return w}if(k==="mensile"){for(var g=new Date(Date.UTC(l.getUTCFullYear(),l.getUTCMonth(),1)),s=23;s>=0;s--){var F=new Date(Date.UTC(g.getUTCFullYear(),g.getUTCMonth()-s,1));P(F,te(A(F.getUTCFullYear(),F.getUTCMonth())))}return w}if(k==="trimestrale"){for(var r=Math.floor(l.getUTCMonth()/3),c=11;c>=0;c--){var o=r-c,B=U+Math.floor(o/4),y=(o%4+4)%4,p=x(B,y*3,1),i=te(new Date(Date.UTC(B,y*3+3,0)));P(p,i)}return w}if(k==="semestrale"){for(var Y=l.getUTCMonth()<6?0:1,_=5;_>=0;_--){var L=Y-_,G=U+Math.floor(L/2),W=(L%2+2)%2,z=W===0?0:6,e=x(G,z,1),v=te(new Date(Date.UTC(G,z+6,0)));P(e,v)}return w}for(var S=2;S>=0;S--){var V=U-S;P(x(V,0,1),te(new Date(Date.UTC(V,12,0))))}return w}function $e(){if(!ue())return a();document.title="Battle Plan – Dashboard",d.innerHTML=De()+'<div class="wrap"><div class="card"><b>Filtro</b><div class="row" style="margin-top:6px;align-items:flex-end;gap:16px;flex-wrap:wrap"><div><label>Modalità</label><select id="dash_mode" name="mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div><div><label>Consulente</label><select id="dash_cons"><option value="">Tutti</option></select></div></div>'+j("dash")+'</div><div class="grid" id="kpiGrid"><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>VSS</b><span id="kpi_vss" class="big">—</span></div><canvas id="d_mini_vss" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>VSD personale</b><span id="kpi_vsd" class="big">—</span></div><canvas id="d_mini_vsdpersonale" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>VSD indiretto</b><span id="kpi_vsd_ind" class="big">—</span></div><canvas id="d_mini_vsdindiretto" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>GI</b><span id="kpi_gi" class="big">—</span></div><canvas id="d_mini_gi" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>NNCF</b><span id="kpi_nncf" class="big">—</span></div><canvas id="d_mini_nncf" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>Tot Provvigioni</b><span id="kpi_provv" class="big">—</span></div><canvas id="d_mini_provv" width="320" height="90"></canvas></div></div><div class="card"><b>Ultimi appuntamenti</b><div id="lastApps" class="row" style="margin-top:8px"></div></div><div class="card"><b>Ultimi BP inviati</b><div id="lastBPs" class="row" style="margin-top:8px"></div></div></div>',he();function t(i,g){var s=document.getElementById(i);s&&(s.textContent=g)}function n(i){var g=Number(i)||0;return g.toLocaleString("it-IT")+"€"}function k(i){var g=Number(i)||0;return String(Math.round(g))}function l(i){return String(i).replace(/[&<>'"]/g,g=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[g])}(function(){ne("/api/usernames").then(function(g){var s=g&&g.users||[],F=document.getElementById("dash_cons");F&&(F.innerHTML='<option value="">Tutti</option>'+s.map(function(r){return'<option value="'+l(String(r.id))+'">'+l(r.name||r.email||"User #"+r.id)+"</option>"}).join(""))}).catch(function(){})})();function U(i,g){return g==="settimanale"?window.isoWeekNum?window.isoWeekNum(i):Math.ceil(i.getDate()/7):g==="mensile"||g==="ytd"||g==="ltm"?i.getMonth()+1:g==="trimestrale"?Math.floor(i.getMonth()/3)+1:g==="semestrale"?i.getMonth()<6?1:2:i.getFullYear()}function w(i){if(typeof Ue=="function")return(Ue(i,new Date)||[]).map(function(u){return{s:u.s,e:u.e}});var g=new Date,s=[];function F(u,N){s.push({s:u.getTime(),e:N.getTime()})}function r(u){var N=new Date(u);return N.setHours(23,59,59,999),N}function c(u,N){return new Date(u,N+1,0,23,59,59,999)}var o=String(i||"mensile").toLowerCase();if(o==="settimanale"){var B=new Date(g),y=(B.getDay()+6)%7;B.setDate(B.getDate()-y),B.setHours(0,0,0,0);for(var Y=52;Y>=0;Y--){var _=new Date(B);_.setDate(_.getDate()-Y*7);var L=new Date(_);L.setDate(_.getDate()+6),L.setHours(23,59,59,999),F(_,L)}return s}if(o==="mensile"||o==="ytd"||o==="ltm"){if(o==="ytd")for(var G=0;G<=g.getMonth();G++){var W=new Date(g.getFullYear(),G,1);F(W,c(g.getFullYear(),G))}else for(var z=o==="ltm"?12:24,e=new Date(g.getFullYear(),g.getMonth(),1),v=z-1;v>=0;v--){var _=new Date(e.getFullYear(),e.getMonth()-v,1);F(_,c(_.getFullYear(),_.getMonth()))}return s}if(o==="trimestrale"){for(var S=Math.floor(g.getMonth()/3)*3,V=new Date(g.getFullYear(),S,1),C=11;C>=0;C--){var E=new Date(V.getFullYear(),V.getMonth()-C*3,1);F(E,r(new Date(E.getFullYear(),E.getMonth()+3,0)))}return s}if(o==="semestrale"){for(var O=g.getMonth()<6?0:6,H=new Date(g.getFullYear(),O,1),_=5;_>=0;_--){var Z=new Date(H.getFullYear(),H.getMonth()-_*6,1);F(Z,r(new Date(Z.getFullYear(),Z.getMonth()+6,0)))}return s}for(var oe=2;oe>=0;oe--){var ie=new Date(g.getFullYear()-oe,0,1);F(ie,r(new Date(ie.getFullYear(),12,0)))}return s}function P(i){switch(String(i)){case"provv_gi":return"ProvvGI";case"provv_vsd":return"ProvvVSD";case"tot_provv":return"TotProvvigioni";default:return i}}function x(i,g,s,F){var r=F||fe("dash"),c=String(r.type||"mensile").toLowerCase(),o=c==="ytd"||c==="ltm"?"mensile":c,B=w(c);function y(_,L){var G=new Date(L.startDate).getTime(),W=new Date(L.endDate).getTime();return G>=_.s&&W<=_.e}function Y(_,L){if(!_)return 0;if(L==="VSDTotale")return Number(_.VSDPersonale||0)+Number(_.VSDIndiretto||0);if(L==="ProvvGI")return Number(_.ProvvGI||0);if(L==="ProvvVSD")return Number(_.ProvvVSD||0);if(L==="TotProvvigioni"){var G=_.TotProvvigioni;return Number(G!=null?G:Number(_.ProvvGI||0)+Number(_.ProvvVSD||0))}return Number(_[L]||0)}return ne("/api/periods?global=1").catch(function(){return ne("/api/periods")}).then(function(_){var L=_&&_.periods||[],G=L.filter(function(e){return!(e.type!==o||s&&String(e.userId||e.uid||"")!==String(s))}),W=P(i),z=B.map(function(e){for(var v=0,S=0;S<G.length;S++){var V=G[S];if(y(e,V)){var C=g==="previsionale"?V.indicatorsPrev||{}:V.indicatorsCons||{};v+=Y(C,W)}}return{x:new Date(e.s),y:Math.round(v*100)/100}});return z})}function te(i,g,s){var F=document.getElementById(i);if(F){if(typeof window.drawFullLine=="function"){window.drawFullLine(i,g,s);return}var r=F.getContext("2d");F.width=F.clientWidth||320,F.height=F.clientHeight||80,r.clearRect(0,0,F.width,F.height);var c=Math.max(1,...s),o=s.length>1?(F.width-8)/(s.length-1):0;r.strokeStyle="#2e6cff",r.lineWidth=2,r.beginPath();for(var B=0;B<s.length;B++){var y=4+B*o,Y=F.height-6-s[B]/c*(F.height-12);B===0?r.moveTo(y,Y):r.lineTo(y,Y)}r.stroke()}}function A(){var i=(document.getElementById("dash_mode")||{}).value||"consuntivo",g=fe("dash"),s=new Date(g.start).getTime(),F=new Date(g.end).getTime(),r=(document.getElementById("dash_cons")||{}).value||"";function c(y){return y=Number(y==null?"":y),isFinite(y)?y:0}function o(y){if(!y)return 0;for(var Y=["VSDIndiretto","vsdIndiretto","VSD_indiretto","VSDI"],_=0;_<Y.length;_++)if(y[Y[_]]!=null)return c(y[Y[_]]);return y.VSDTotale!=null&&y.VSDPersonale!=null?c(y.VSDTotale)-c(y.VSDPersonale):0}function B(y){return y?y.TotProvvigioni!=null?c(y.TotProvvigioni):c(y.ProvvGI)+c(y.ProvvVSD):0}return ne("/api/periods").then(function(y){for(var Y=y&&y.periods||[],_={VSS:0,VSDPersonale:0,VSDIndiretto:0,GI:0,NNCF:0,PROVV:0},L=0;L<Y.length;L++){var G=Y[L];if(!(r&&String(G.userId||G.uid||"")!==String(r))){var W=new Date(G.startDate).getTime(),z=new Date(G.endDate).getTime();if(!(W<s||z>F)){var e=i==="previsionale"?G.indicatorsPrev||{}:G.indicatorsCons||{};_.VSS+=c(e.VSS),_.VSDPersonale+=c(e.VSDPersonale),_.VSDIndiretto+=o(e),_.GI+=c(e.GI),_.NNCF+=c(e.NNCF),_.PROVV+=B(e)}}}t("kpi_vss",n(_.VSS)),t("kpi_vsd",n(_.VSDPersonale)),t("kpi_vsd_ind",n(_.VSDIndiretto)),t("kpi_gi",n(_.GI)),t("kpi_nncf",k(_.NNCF)),t("kpi_provv",n(_.PROVV))})}function R(){var i=(document.getElementById("dash_mode")||{}).value||"consuntivo",g=(document.getElementById("dash_cons")||{}).value||"",s=fe("dash"),F=String(s.type||"mensile").toLowerCase();function r(c,o){var B=c.map(function(Y){return U(Y.x,F)}),y=c.map(function(Y){return Y.y});te(o,B,y)}Promise.all([x("VSS",i,g||null,s),x("VSDPersonale",i,g||null,s),x("VSDIndiretto",i,g||null,s),x("GI",i,g||null,s),x("NNCF",i,g||null,s),x("TotProvvigioni",i,g||null,s)]).then(function(c){r(c[0],"d_mini_vss"),r(c[1],"d_mini_vsdpersonale"),r(c[2],"d_mini_vsdindiretto"),r(c[3],"d_mini_gi"),r(c[4],"d_mini_nncf"),r(c[5],"d_mini_provv")}).catch(function(c){logger.error(c)})}function h(){var i=(document.getElementById("dash_cons")||{}).value||"";(function(){var B=document.getElementById("lastApps");if(B){var y=B.parentElement;if(!document.getElementById("nextApps")){var Y=document.createElement("div");Y.className="card",Y.innerHTML='<b>Prossimi appuntamenti (oggi + domani)</b><div id="nextApps" style="margin-top:8px"></div>',y.parentElement.insertBefore(Y,y)}}})();function g(o){return'<div style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px">'+o+"</div>"}function s(o){return o=String(o||"").toLowerCase(),o.indexOf("mezza")>-1?240:o.indexOf("giorn")>-1?570:(o.indexOf("vend")>-1,90)}function F(o){var B=new Date(o.start),y=new Date(o.end);(!(y instanceof Date)||isNaN(y)||y<B)&&(y=new Date(B.getTime()+s(o.type||"vendita")*6e4));var Y=Re(B)+" "+Vt(B)+"–"+(("0"+y.getHours()).slice(-2)+":"+("0"+y.getMinutes()).slice(-2)),_=o.nncf?" · NNCF ✅":"";return'<div class="card lastApp" data-aid="'+l(String(o.id||""))+'" style="cursor:pointer"><div class="small muted">'+l(Y)+" · "+l(o.type||"manuale")+'</div><div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><div><b>'+l(o.client||"")+'</b></div><div class="row" style="gap:6px"><button class="ghost" title="Esporta .ics" data-ics="'+l(String(o.id||""))+'">.ics</button></div></div><div class="small">VSS '+n(o.vss||0)+" · VSD "+n(o.vsdPersonal||0)+_+"</div></div>"}function r(o){return o&&Object.keys(o).length>0}function c(o){return o=Number(o||0),isFinite(o)?o:0}Promise.all([ne("/api/appointments"),ne("/api/periods")]).then(function(o){var B=o[0]&&o[0].appointments||[],y=o[1]&&o[1].periods||[];(function(){var _=document.getElementById("nextApps");if(_){var L=new Date,G=new Date(L.getFullYear(),L.getMonth(),L.getDate(),0,0,0,0),W=new Date(L.getFullYear(),L.getMonth(),L.getDate()+2,0,0,0,0),z=B.filter(function(e){var v=new Date(e.start).getTime(),S=v>=G.getTime()&&v<W.getTime(),V=i?String(e.userId||e.uid||"")===String(i):!0;return S&&V}).sort(function(e,v){return new Date(e.start)-new Date(v.start)});_.innerHTML=z.length?g(z.map(F).join("")):'<div class="muted">Nessun appuntamento tra oggi e domani</div>',_.querySelectorAll(".lastApp[data-aid]").forEach(function(e){e.addEventListener("click",function(){try{ke("bp_edit_aid",e.getAttribute("data-aid"))}catch(v){}Fe()})}),_.querySelectorAll("button[data-ics]").forEach(function(e){e.addEventListener("click",function(v){v.stopPropagation();var S=e.getAttribute("data-ics"),V=z.find(C=>String(C.id)===String(S))||B.find(C=>String(C.id)===String(S));if(!V){K("Appuntamento non trovato");return}typeof icsFromAppt=="function"&&typeof downloadICS=="function"?(downloadICS("bp_".concat((V.client||"app").replace(/\s+/g,"_"),"_").concat((V.start||"").slice(0,10)),icsFromAppt(V)),typeof haptic=="function"&&haptic("medium"),K(".ics esportato")):K("Export .ics non disponibile")})})}})(),(function(){var _=document.getElementById("lastApps");if(_){var L=B.filter(function(G){return i?String(G.userId||G.uid||"")===String(i):!0}).sort(function(G,W){return new Date(W.start)-new Date(G.start)}).slice(0,6);_.innerHTML=L.length?g(L.map(F).join("")):'<div class="muted">Nessun appuntamento</div>',_.querySelectorAll(".lastApp[data-aid]").forEach(function(G){G.addEventListener("click",function(){try{ke("bp_edit_aid",G.getAttribute("data-aid"))}catch(W){}Fe()})}),_.querySelectorAll("button[data-ics]").forEach(function(G){G.addEventListener("click",function(W){W.stopPropagation();var z=G.getAttribute("data-ics"),e=L.find(v=>String(v.id)===String(z))||B.find(v=>String(v.id)===String(z));if(!e){K("Appuntamento non trovato");return}typeof icsFromAppt=="function"&&typeof downloadICS=="function"?(downloadICS("bp_".concat((e.client||"app").replace(/\s+/g,"_"),"_").concat((e.start||"").slice(0,10)),icsFromAppt(e)),typeof haptic=="function"&&haptic("medium"),K(".ics esportato")):K("Export .ics non disponibile")})})}})(),(function(){var _=document.getElementById("lastBPs");if(_){var L=y.filter(function(W){return!(i&&String(W.userId||W.uid||"")!==String(i))}).sort(function(W,z){return new Date(z.endDate)-new Date(W.endDate)}).slice(0,3),G=L.map(function(W){var z=He(W.type,W.startDate),e=W.userName||W.userId||"",v=W.indicatorsPrev||{},S=W.indicatorsCons||{},V=r(S),C=V?S:v,E=c(C.VSS),O=c(C.VSDPersonale),H=c(C.VSDIndiretto),Z=c(C.GI),oe=c(C.NNCF),ie=O+H;return'<div class="card lastBP" data-pid="'+l(String(W.id||""))+'" style="cursor:pointer;flex:1 1 320px"><div style="display:flex;align-items:center;gap:8px"><div><b>'+l(z)+'</b></div><span class="chip small">'+(V?"Consuntivo":"Previsionale")+'</span></div><div class="small muted">'+l(e)+'</div><div class="row" style="margin-top:6px;gap:8px;flex-wrap:wrap"><span class="chip small">VSS <b>'+n(E)+'</b></span><span class="chip small">VSD <b>'+n(ie)+'</b> <span class="muted">(P '+n(O)+" · I "+n(H)+')</span></span><span class="chip small">GI <b>'+n(Z)+'</b></span><span class="chip small">NNCF <b>'+k(oe)+"</b></span></div></div>"}).join("");_.innerHTML=G?'<div style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px">'+G+"</div>":'<div class="muted">Nessun BP</div>',_.querySelectorAll(".lastBP[data-pid]").forEach(function(W){W.addEventListener("click",function(){try{ke("bp_open_period",{id:W.getAttribute("data-pid"),mode:!1})}catch(z){}nt()})})}})()}).catch(function(o){logger.error(o)})}ye("dash",function(){typeof haptic=="function"&&haptic("light"),A(),R(),h()});var b=document.getElementById("dash_mode");b&&(b.onchange=function(){typeof haptic=="function"&&haptic("light"),A(),R(),h()});var p=document.getElementById("dash_cons");p&&(p.onchange=function(){typeof haptic=="function"&&haptic("light"),A(),R(),h()}),A(),R(),h(),typeof kickFinal=="function"&&kickFinal("dashboard")}function lt(){if(!ue())return a();document.title="Battle Plan – Calendario";function t(h){if(!h)return new Date(NaN);if(typeof h=="string"){var b=h.match(/^(\d{4})-(\d{2})-(\d{2})[T ](\d{2}):(\d{2})/);if(b)return new Date(+b[1],+b[2]-1,+b[3],+b[4],+b[5])}return new Date(h)}function n(h){var b=t(h),p=isFinite(b)?("0"+b.getHours()).slice(-2):"--",i=isFinite(b)?("0"+b.getMinutes()).slice(-2):"--";return p+":"+i}if(!document.getElementById("cal_dynamic_css")){var k="\n      /* ============== CALENDAR ============== */\n      #cal_container{ overflow-x:auto; -webkit-overflow-scrolling:touch; }\n      #cal_container .calendar{ min-width: 860px; }\n\n      .calendar{ display:grid; grid-template-columns: 44px repeat(7, 1fr); gap:10px; }\n      .calendar .weekLabel{ color:var(--muted); font-size:12px; display:flex; align-items:center; justify-content:center; }\n\n      .calendar .day{\n        min-height:120px; background: var(--card);\n        border:2px solid var(--hair2); border-radius:14px; padding:8px;\n        display:flex; flex-direction:column; gap:3px; overflow:hidden;\n      }\n      .calendar .day.today{\n        outline: 2px solid var(--accent);\n        box-shadow: 0 0 0 2px rgba(0,0,0,.06) inset;\n      }\n      .calendar .day .dnum{ font-weight:800; }\n      .calendar .day .small{\n        font-size:12px; line-height:1.15;\n        white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:100%;\n      }\n      .calendar .day .tag{ padding:2px 6px; border-radius:999px; border:1px solid var(--hair2); font-size:11px; align-self:flex-start; }\n      .calendar .day.busy0{ border-color:#27ae60; background:rgba(39,174,96,.08); }\n      .calendar .day.busy1{ border-color:#ff9f1a; background:rgba(255,159,26,.10); }\n      .calendar .day.busy2{ border-color:#7d1731; background:rgba(125,23,49,.12); }\n      .calendar .day.dense .small{ font-size:11px; line-height:1.1; }\n      .calendar .day.dense .tag{ transform:scale(.9); transform-origin:left top; }\n\n      @media (max-width: 900px){\n        .calendar{ grid-template-columns: 36px repeat(7, 1fr); }\n        .calendar .weekLabel{ display:flex !important; font-size:11px; }\n        .calendar .day{ min-height:92px; padding:6px; }\n        .calendar .day .dnum{ font-size:16px; }\n        .calendar .day .small{ white-space: normal !important; overflow: visible !important; text-overflow: clip !important; }\n        .calendar .day.dense .small{ font-size:clamp(9px,2.4vw,11px); }\n        .calendar .day .tag{ font-size:10px; }\n      }\n\n      .cal-filters .chip{\n        display:inline-flex; align-items:center; gap:6px;\n        padding:6px 10px; border-radius:999px; border:1px solid var(--hair2);\n      }\n    ",l=document.createElement("style");l.id="cal_dynamic_css",l.textContent=k,document.head.appendChild(l)}var U=new Date,w=Pe(Je(U)).slice(0,7);d.innerHTML=De()+'<div class="wrap"><div class="card"><div class="row" style="align-items:flex-end;gap:12px;flex-wrap:wrap"><div class="row" style="align-items:flex-end;gap:8px"><button id="cal_prev" class="ghost" title="Mese precedente">◀</button><div><label>Mese</label><input type="month" id="cal_month" value="'+w+'"></div><button id="cal_next" class="ghost" title="Mese successivo">▶</button></div><div class="cal-filters"><label class="chip small"><input type="checkbox" id="only_free"> Solo giorni liberi</label> <label class="chip small"><input type="checkbox" id="only_4h"> Solo slot ≥ 4h</label></div><div class="right" style="margin-left:auto"><button id="cal_refresh" class="ghost">Aggiorna</button></div></div></div><div id="cal_container"></div><div id="cal_results" class="card" style="margin-top:8px;display:none"></div><div id="cal_day_box" class="card" style="margin-top:8px;display:none"></div><div class="card" id="cal_free_slots" style="margin-top:8px;display:none"></div></div>',he();function P(h,b,p){Promise.all([ne("/api/appointments"),ne("/api/availability?from="+h+"-"+xe(b)+"-01&to="+h+"-"+xe(b)+"-"+xe(new Date(h,b,0).getDate()))]).then(function(i){var g=i[0]&&i[0].appointments?i[0].appointments:[],s=i[1]||{slots:[]},F=s.slots||[],r=new Date(h,b-1,1),c=new Date(h,b,0,23,59,59,999);function o(D,T){for(var M={vss:0,vsd:0,nncf:0,count:0},$=0;$<g.length;$++){var J=g[$],re=new Date(J.start);re>=D&&re<=T&&(M.vss+=Number(J.vss||0),M.vsd+=Number(J.vsdPersonal||0),M.nncf+=J.nncf?1:0,M.count+=1)}return M}function B(D,T,M){var $=document.getElementById("cal_results");if($){var J=M?'<div class="right"><button id="res_reset" class="ghost">Torna al mese</button></div>':"";if($.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center"><b>Risultati · '+T+"</b>"+J+'</div><div class="row" style="margin-top:8px;gap:8px;flex-wrap:wrap"><span class="chip small">VSS <b>'+Le(D.vss)+'</b></span><span class="chip small">VSD <b>'+Le(D.vsd)+'</b></span><span class="chip small">NNCF <b>'+Ce(D.nncf)+'</b></span><span class="chip small">N. app <b>'+Ce(D.count)+"</b></span></div>",$.style.display="block",M){var re=document.getElementById("res_reset");re&&(re.onclick=function(){B(o(r,c),z,!1)})}}}for(var y={},Y=0;Y<g.length;Y++){var _=g[Y],L=new Date(_.start);if(!(L<r||L>c)){var G=Pe(L);y[G]||(y[G]={vss:0,vsd:0,nncf:0,mins:0,count:0,items:[]}),y[G].vss+=Number(_.vss||0),y[G].vsd+=Number(_.vsdPersonal||0),y[G].nncf+=_.nncf?1:0,y[G].mins+=Number(_.durationMinutes||0),y[G].count+=1,y[G].items.push(_)}}var W=["Lun","Mar","Mer","Gio","Ven","Sab","Dom"],z=new Date(h,b-1,1).toLocaleString("it-IT",{month:"long",year:"numeric"}),e='<div class="card"><b class="neon">'+z+"</b></div>";e+='<div class="calendar">',e+='<div class="weekLabel">W</div>';for(var v=0;v<7;v++)e+='<div class="weekLabel">'+W[v]+"</div>";var S=new Date(h,b-1,1),V=(S.getDay()+6)%7,C=new Date(S);C.setDate(S.getDate()-V);for(var E=0;E<6;E++){var O=new Date(C),H="W"+ge(O);e+='<div class="weekLabel" data-ws="'+Pe(O)+'" style="cursor:pointer">'+H+"</div>";for(var Z=0;Z<7;Z++){var oe=C.getMonth()===b-1,G=Pe(C),ie=y[G]||{vss:0,vsd:0,nncf:0,mins:0,count:0,items:[]},u=C.getDay(),N=u===0||u===6,q=!N&&F.some(function(T){return T.date===G});if(oe&&p){if(p.only_free&&ie.count>0){e+="<div></div>",C.setDate(C.getDate()+1);continue}if(p.only_4h&&!q){e+="<div></div>",C.setDate(C.getDate()+1);continue}}if(!oe)e+="<div></div>";else{var I="";N?ie.count>0&&(I="busy2"):ie.count===0?I="busy0":q?I="busy1":I="busy2";var X="",ee=0;N&&ie.count===0||(ie.vss>0&&(X+='<div class="small">VSS '+Le(ie.vss)+"</div>",ee++),ie.vsd>0&&(X+='<div class="small">VSD '+Le(ie.vsd)+"</div>",ee++),ie.nncf>0&&(X+='<div class="small">NNCF '+Ce(ie.nncf)+"</div>",ee++),ie.count>0&&(X+='<div class="small">App. '+Ce(ie.count)+"</div>",ee++),q&&(X+='<div class="tag" style="margin-top:4px">slot ≥4h</div>',ee++));var ae=ee>=3?" dense":"",se=q?" slot-free":"";e+='<div class="day '+I+ae+se+'" data-day="'+G+'" title="Settimana '+ge(C)+'"><div class="dnum">'+C.getDate()+"</div>"+(X||"")+"</div>"}C.setDate(C.getDate()+1)}}e+="</div>",document.getElementById("cal_container").innerHTML=e,B(o(r,c),z,!1),document.querySelectorAll(".calendar .weekLabel[data-ws]").forEach(function(D){D.addEventListener("click",function(){var T=D.getAttribute("data-ws"),M=new Date(T),$=new Date(M);$.setDate($.getDate()+6),$.setHours(23,59,59,999);var J="Settimana "+("W"+ge(M))+" · "+Re(M)+"–"+Re($);B(o(M,$),J,!0)})}),document.querySelectorAll(".day[data-day]").forEach(function(D){D.addEventListener("click",function(){var T=D.getAttribute("data-day"),M=y[T]&&y[T].items?y[T].items.slice():[];M.sort(function(_e,Te){return new Date(_e.start)-new Date(Te.start)});var $=document.getElementById("cal_day_box"),J="<b>Appuntamenti del "+T.split("-").reverse().join("/")+"</b>";if(!M.length)J+='<div class="muted" style="margin-top:6px">Nessun appuntamento</div>';else{J+='<div class="row" style="margin-top:8px">';for(var re=0;re<M.length;re++){var Q=M[re],ve=' data-start="'+Q.start+'" data-end="'+Q.end+'" data-title="'+ce(Q.client||"Appuntamento")+'" ';J+='<div class="card cal-app" data-aid="'+Q.id+'" '+ve+' style="flex:1 1 320px;cursor:pointer"><div class="small muted">'+n(Q.start)+"–"+n(Q.end)+" · "+ce(Q.type||"")+"</div><div><b>"+ce(Q.client||"")+'</b></div><div class="small">VSS '+Le(Q.vss)+" · VSD "+Le(Q.vsdPersonal)+" · NNCF "+(Q.nncf?"✅":"—")+"</div>"+(Q.notes?'<div class="small muted">'+ce(Q.notes)+"</div>":"")+"</div>"}J+="</div>"}if($.style.display="block",$.innerHTML=J,$.querySelectorAll(".cal-app").forEach(function(_e){_e.addEventListener("click",function(Te){Te.stopPropagation(),ke("bp_edit_aid",_e.getAttribute("data-aid")),Fe()})}),window.scrollTo({top:$.getBoundingClientRect().top+window.scrollY-80,behavior:"smooth"}),typeof window.wireICSInsideDayBox=="function")try{window.wireICSInsideDayBox()}catch(_e){}})});var le=document.getElementById("cal_free_slots"),Se=(function(){var D=new Date;return D.getFullYear()+"-"+xe(D.getMonth()+1)+"-"+xe(D.getDate())})(),we=(F||[]).filter(function(D){return String(D.date||"").slice(0,10)>=Se});if(we.length){var Ae='<b>Slot liberi ≥ 4h (da oggi in poi)</b> · <span class="badge">Tot: '+we.length+"</span>";Ae+='<div class="row" style="margin-top:8px">';for(var m=0;m<we.length&&m<80;m++){var L=we[m],f=L.part==="morning"?"mattina":"pomeriggio";Ae+='<div class="card slotBtn" data-start="'+L.start+'" data-end="'+L.end+'" style="flex:1 1 280px;cursor:pointer"><div class="small"><b>'+Re(L.start)+"</b> · "+f+'</div><div class="small">'+n(L.start)+"–"+n(L.end)+"</div></div>"}Ae+="</div>",le.style.display="block",le.innerHTML=Ae,le.querySelectorAll(".slotBtn").forEach(function(D){D.addEventListener("click",function(){ke("bp_prefill_slot",{start:D.getAttribute("data-start"),end:D.getAttribute("data-end")}),Fe(),K("Slot precompilato negli appuntamenti")})})}else le.style.display="block",le.innerHTML='<b>Slot liberi ≥ 4h (da oggi in poi)</b> · <span class="badge">Tot: 0</span><div class="muted" style="margin-top:6px">Nessuno slot libero disponibile.</div>';try{window.injectTodayCSS&&window.injectTodayCSS()}catch(D){}try{window.hookCalendar?window.hookCalendar():(window.markToday&&window.markToday(),window.clampSlotCounters&&window.clampSlotCounters())}catch(D){}}).catch(function(i){logger.error(i),K("Errore calendario")})}function x(){var h=document.getElementById("cal_month").value,b=parseInt(h.split("-")[0],10),p=parseInt(h.split("-")[1],10),i={only_free:document.getElementById("only_free").checked,only_4h:document.getElementById("only_4h").checked};P(b,p,i)}document.getElementById("cal_refresh").onclick=x,document.getElementById("cal_month").onchange=x;function te(h){var b=document.getElementById("cal_month");if(b){var p=b.value.split("-"),i=+p[0],g=+p[1];g+=h,g<=0?(g=12,i--):g>12&&(g=1,i++),b.value=i+"-"+xe(g),x()}}var A=document.getElementById("cal_prev"),R=document.getElementById("cal_next");A&&(A.onclick=function(){te(-1)}),R&&(R.onclick=function(){te(1)}),document.getElementById("only_free").onchange=x,document.getElementById("only_4h").onchange=x,x()}function nt(){if(!ue())return a();document.title="Battle Plan – BP",d.innerHTML=De()+'<div class="wrap"><div class="card"><b>Da inviare</b><div id="bp_to_send" class="grid" style="margin-top:8px"></div></div><div class="card" id="bp_sent_box" style="margin-top:8px"><div id="bp_sent_head" style="display:flex;align-items:center;justify-content:space-between;cursor:pointer"><b>BP inviati (periodi in essere)</b><span id="bp_sent_chev" class="chev">▸</span></div><div id="bp_sent" class="row" style="margin-top:8px;display:none"></div></div><div class="card" style="margin-top:8px"><b>Crea/Aggiorna BP</b><div class="row" style="margin-top:8px"><div><label>Tipo</label><select id="p_type"><option value="settimanale">Settimanale (lun–dom)</option><option value="mensile">Mensile</option><option value="trimestrale">Trimestrale</option><option value="semestrale">Semestrale</option><option value="annuale">Annuale</option></select></div><div id="wrap_week" style="display:none"><label>Settimana ISO (1–53)</label><input type="number" id="p_week" min="1" max="53" value="'+ge(new Date)+'"></div><div id="wrap_month" style="display:none"><label>Mese</label><select id="p_month"><option value="1">Gennaio</option><option value="2">Febbraio</option><option value="3">Marzo</option><option value="4">Aprile</option><option value="5">Maggio</option><option value="6">Giugno</option><option value="7">Luglio</option><option value="8">Agosto</option><option value="9">Settembre</option><option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option></select></div><div id="wrap_quarter" style="display:none"><label>Trimestre</label><select id="p_quarter"><option value="1">T1</option><option value="2">T2</option><option value="3">T3</option><option value="4">T4</option></select></div><div id="wrap_semester" style="display:none"><label>Semestre</label><select id="p_sem"><option value="1">1° semestre</option><option value="2">2° semestre</option></select></div><div><label>Anno</label><input type="number" id="p_year" min="2000" max="2100" value="'+new Date().getFullYear()+'"></div></div><div class="row"><div class="small muted">Modalità: <b id="p_mode_lbl">Previsionale</b> · <button class="ghost" id="btnImport" style="padding:4px 8px">Importa da agenda</button></div></div><div class="row" style="align-items:center"><div class="small"><b>Periodo selezionato:</b> <span id="p_label" class="neon">—</span></div><input type="hidden" id="p_start"><input type="hidden" id="p_end"></div><div class="row small" style="margin-top:6px;opacity:.9"><div><b>Previsionale</b></div><div><b>Consuntivo</b></div><div><b>Avanzamento</b></div></div><div class="row" id="p_rows" style="margin-top:4px"></div><div class="row" style="margin-top:8px;align-items:center;gap:8px;justify-content:space-between"><div id="p_delete_zone"></div><div class="right"><button id="btnSaveP">Salva BP</button></div></div></div><div class="card"><b>BP salvati</b><div id="p_list" class="row" style="margin-top:8px"></div></div></div>',he();var t=!1,n=null,k=[],l=null,U=ue()||{};function w(m){return String(m).replace(/[&<>'"]/g,f=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[f])}function P(m){if(!m)return"";var f=new Date(m);return f.getFullYear()+"-"+("0"+(f.getMonth()+1)).slice(-2)+"-"+("0"+f.getDate()).slice(-2)}function x(m){var f=new Date(m);return("0"+f.getDate()).slice(-2)+"/"+("0"+(f.getMonth()+1)).slice(-2)+"/"+f.getFullYear()}function te(m){var f=Number(m)||0;return f.toLocaleString("it-IT")+"€"}function A(m){var f=document.createElement("div");return f.innerHTML=m.trim(),f.firstChild}function R(m){return!!(m&&m.indicatorsCons&&Object.keys(m.indicatorsCons).length>0)}function h(){return U&&U.grade?Promise.resolve(U):ne("/api/usernames").then(function(m){var f=String((ue()||{}).id||""),D=(m&&m.users||[]).find(function(T){return String(T.id)===f});return D&&D.grade&&(U.grade=D.grade),U}).catch(function(){return U})}function b(){var m=U&&U.grade||(ue()||{}).grade;return m==="senior"?"senior":"junior"}h();var p=document.getElementById("p_type"),i=document.getElementById("p_year"),g=document.getElementById("wrap_week"),s=document.getElementById("wrap_month"),F=document.getElementById("wrap_quarter"),r=document.getElementById("wrap_semester"),c=document.getElementById("p_week"),o=document.getElementById("p_month"),B=document.getElementById("p_quarter"),y=document.getElementById("p_sem"),Y=document.getElementById("p_label"),_=document.getElementById("p_start"),L=document.getElementById("p_end"),G=document.getElementById("p_mode_lbl"),W=document.getElementById("btnImport");function z(m){t=!!m,G.textContent=t?"Consuntivo":"Previsionale",W.style.display=t?"none":"";var f=document.querySelectorAll("[data-row]");f.forEach(function(D){var T=D.querySelector("[data-prev]"),M=D.querySelector("[data-cons]"),$=D.querySelector("[data-bar]");if(t){if(T){T.removeAttribute("hidden");var J=T.querySelector("input");J&&(J.setAttribute("readonly","readonly"),J.classList.add("disabled"))}if(M){M.removeAttribute("hidden");var re=M.querySelector("input");re&&(re.removeAttribute("readonly"),re.classList.remove("disabled"))}$&&$.removeAttribute("hidden")}else{if(T){T.removeAttribute("hidden");var Q=T.querySelector("input");Q&&(Q.removeAttribute("readonly"),Q.classList.remove("disabled"))}M&&M.setAttribute("hidden","hidden"),$&&$.setAttribute("hidden","hidden")}}),I()}function e(){var m=p.value;g.style.display=m==="settimanale"?"":"none",s.style.display=m==="mensile"?"":"none",F.style.display=m==="trimestrale"?"":"none",r.style.display=m==="semestrale"?"":"none",v()}function v(){var m=p.value,f=parseInt(i.value,10),D,T,M;if(m==="settimanale"){var $=Math.max(1,Math.min(53,parseInt(c.value||"1",10))),J=Me(f,$);D=J.start,T=J.end,M="Sett. "+$+" · "+x(D)+" → "+x(T)}else if(m==="mensile"){var re=parseInt(o.value,10);D=new Date(f,re-1,1),T=new Date(f,re,0),M=D.toLocaleString("it-IT",{month:"long",year:"numeric"})+" · "+x(D)+" → "+x(T)}else if(m==="trimestrale"){var Q=parseInt(B.value,10);D=new Date(f,(Q-1)*3,1),T=new Date(f,Q*3,0),M="Trimestre "+Q+" "+f+" · "+x(D)+" → "+x(T)}else if(m==="semestrale"){var ve=parseInt(y.value,10);D=new Date(f,ve===1?0:6,1),T=new Date(f,ve===1?6:12,0),M=(ve===1?"1°":"2°")+" semestre "+f+" · "+x(D)+" → "+x(T)}else D=new Date(f,0,1),T=new Date(f,11,31),M="Anno "+f+" · "+x(D)+" → "+x(T);_.value=P(D),L.value=P(T),Y.textContent=M,z(!1),n=null,l=null,O(),I()}function S(m){for(var f="",D=0;D<m.length;D++){var T=m[D],M=/^(VSS|VSDPersonale|VSDIndiretto|GI)$/i.test(T);f+='<div class="row" data-row="'+T+'"><div data-prev><label>'+T+' (Prev)</label><input type="number" step="1" id="prev_'+T+'" placeholder="'+(M?"€":"n")+'"></div><div data-cons><label>'+T+' (Cons)</label><input type="number" step="1" id="cons_'+T+'" placeholder="'+(M?"€":"n")+'"></div><div data-bar class="small"><div style="height:10px;background:rgba(255,255,255,.12);border-radius:999px;overflow:hidden"><div id="bar_'+T+'" style="height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2));"></div></div><div id="pct_'+T+'" class="small muted">0%</div></div></div>'}document.getElementById("p_rows").innerHTML=f,z(!1),C(),V()}function V(){for(var m=0;m<k.length;m++){var f=k[m],D=document.getElementById("prev_"+f),T=document.getElementById("cons_"+f);if(!(!D||!T)){var M=Number(D.value||0),$=Number(T.value||0),J=M>0?Math.round($/M*100):$>0?100:0;J=Math.max(0,Math.min(200,J));var re=document.getElementById("bar_"+f),Q=document.getElementById("pct_"+f);re&&(re.style.width=Math.min(J,100)+"%"),Q&&(Q.textContent=J+"%")}}}function C(){for(var m=0;m<k.length;m++)(function(f){var D=document.getElementById("prev_"+f),T=document.getElementById("cons_"+f);D&&(D.oninput=V),T&&(T.oninput=V)})(k[m])}function E(){for(var m=0;m<k.length;m++){var f=document.getElementById("prev_"+k[m]);f&&(f.value="")}V()}function O(){for(var m=0;m<k.length;m++){var f=document.getElementById("cons_"+k[m]);f&&(f.value="")}V()}function H(m){for(var f in m){var D=document.getElementById("prev_"+f);D&&(D.value=String(m[f]||0))}V()}function Z(m){for(var f in m){var D=document.getElementById("cons_"+f);D&&(D.value=String(m[f]||0))}V()}function oe(){if(!t){var m=_.value,f=L.value;if(!m||!f){K("Seleziona il periodo");return}ne("/api/appointments").then(function(D){for(var T=D.appointments||[],M=new Date(m),$=new Date(f),J={VSS:0,VSDPersonale:0,VSDIndiretto:0,GI:0,Telefonate:0,AppFissati:0,AppFatti:0,CorsiLeadership:0,iProfile:0,MBS:0,NNCF:0},re=0;re<T.length;re++){var Q=T[re],ve=new Date(Q.start);ve>=M&&ve<=$&&(J.VSS+=Number(Q.vss||0),J.VSDPersonale+=Number(Q.vsdPersonal||0),Q.nncf&&(J.NNCF+=1))}H(J),K("Previsionale compilato dalla tua agenda"),Ye(),addXP(10)}).catch(function(){K("Errore import agenda")})}}function ie(m,f){m=Object.assign({},m||{});var D=Number(m.GI||0),T=Number(m.VSDPersonale||0),M=D*.15,$=T*(String(f)==="senior"?.25:.2);return m.ProvvGI=Math.round(M*100)/100,m.ProvvVSD=Math.round($*100)/100,m.TotProvvigioni=Math.round((m.ProvvGI+m.ProvvVSD)*100)/100,m}function u(m,f,D){return fetch(f,{method:m,headers:D?{"Content-Type":"application/json"}:void 0,body:D?JSON.stringify(D):void 0}).then(function(T){return T.ok?T.json().catch(function(){return{}}):Promise.reject(new Error("HTTP "+T.status))})}function N(m){for(var f=encodeURIComponent(m),D=[function(){return u("POST","/api/periods/delete",{id:m})},function(){return u("POST","/api/periods",{id:m,_delete:!0})},function(){return u("POST","/api/periods/"+f,{_method:"DELETE"})},function(){return u("DELETE","/api/periods/"+f,null)},function(){return u("DELETE","/api/periods?id="+f,null)}],T=Promise.reject(new Error("start")),M=0;M<D.length;M++)(function($){T=T.catch($)})(D[M]);return T.catch(function($){throw logger.warn("Delete fallback: tutte le route fallite",$),$})}function q(m){return l?{id:n||l.id,type:l.type,startDate:P(l.startDate),endDate:P(l.endDate),indicatorsPrev:Object.assign({},l.indicatorsPrev||{}),indicatorsCons:m!=null?m:Object.assign({},l.indicatorsCons||{})}:null}function I(){var m=document.getElementById("p_delete_zone");if(m){if(!n){m.innerHTML="";return}var f=!!(t&&l&&R(l)),D="";f&&(D+='<button id="btnDelCons" class="ghost" style="border-color:#7d1731;color:#7d1731">Elimina Consuntivo</button> '),D+='<button id="btnDelBP" class="ghost" style="border-color:#7d1731;color:#7d1731">Elimina BP</button>',m.innerHTML=D;var T=document.getElementById("btnDelBP");T&&(T.onclick=function(){confirm("Eliminare definitivamente questo BP?")&&(T.disabled=!0,N(n).then(function(){K("BP eliminato"),n=null,l=null,E(),O(),z(!1),v(),ee()}).catch(function(){K("Endpoint delete non disponibile")}).finally(function(){T.disabled=!1}))});var M=document.getElementById("btnDelCons");M&&(M.onclick=function(){if(confirm("Rimuovere solo il Consuntivo?")){M.disabled=!0;var $=q({});if(!$){M.disabled=!1;return}var J=b();$.indicatorsPrev=ie($.indicatorsPrev,J),$.indicatorsCons={},Ie("/api/periods",$).then(function(){K("Consuntivo eliminato"),l&&(l.indicatorsCons={}),z(!0),ee(),I()}).catch(function(){K("Errore eliminazione Consuntivo")}).finally(function(){M.disabled=!1})}})}}function X(){var m=p.value,f=_.value,D=L.value;if(!f||!D){K("Seleziona il periodo");return}for(var T={},M={},$=0;$<k.length;$++){var J=k[$];T[J]=Number(document.getElementById("prev_"+J).value||0),t&&(M[J]=Number(document.getElementById("cons_"+J).value||0))}var re=b();T=ie(T,re),t&&(M=ie(M,re));var Q={type:m,startDate:f,endDate:D,indicatorsPrev:T};t&&(Q.indicatorsCons=M),n&&(Q.id=n),Ie("/api/periods",Q).then(function(ve){K("BP salvato"),t?addXP(20):addXP(10),Ye(),ee(),!n&&ve&&ve.id&&(n=ve.id),n&&l&&(l.indicatorsPrev=T,t&&(l.indicatorsCons=M)),I()}).catch(function(){K("Errore salvataggio BP")})}function ee(){ne("/api/periods").then(function(m){var f=m.periods||[];f.sort(function(Q,ve){return new Date(ve.startDate)-new Date(Q.startDate)});for(var D="",T=0;T<f.length;T++){var M=f[T],$=He(M.type,M.startDate)+" · "+x(M.startDate)+" → "+x(M.endDate);D+='<div class="card" style="flex:1 1 360px"><div><b>'+w($)+'</b></div><div class="small">Prev VSS '+te((M.indicatorsPrev||{}).VSS||0)+" · Cons "+te((M.indicatorsCons||{}).VSS||0)+'</div><div class="right" style="margin-top:6px"><button class="ghost" data-edit="'+M.id+'">Modifica previs.</button><button data-cons="'+M.id+'">Consuntivo…</button></div></div>'}document.getElementById("p_list").innerHTML=D||'<div class="muted">Nessun BP</div>',document.querySelectorAll("[data-edit]").forEach(function(Q){Q.addEventListener("click",function(){var ve=Q.getAttribute("data-edit"),_e=(m.periods||[]).find(function(Te){return Te.id===ve});_e&&ae(_e,!1)})}),document.querySelectorAll("[data-cons]").forEach(function(Q){Q.addEventListener("click",function(){var ve=Q.getAttribute("data-cons"),_e=(m.periods||[]).find(function(Te){return Te.id===ve});_e&&ae(_e,!0)})}),Ae(f);var J=Ge("bp_open_period",null);if(J){Oe("bp_open_period");var re=f.find(function(Q){return Q.id===J.id});re&&ae(re,J.mode===!0)}})}function ae(m,f){l=m||null,p.value=m.type;var D=new Date(m.startDate),T=D.getFullYear();if(i.value=String(T),m.type==="settimanale")c.value=String(ge(D));else if(m.type==="mensile")o.value=String(D.getMonth()+1);else if(m.type==="trimestrale"){var M=Math.floor(D.getMonth()/3)+1;B.value=String(M)}else m.type==="semestrale"&&(y.value=D.getMonth()<6?"1":"2");e(),E(),O(),H(m.indicatorsPrev||{}),Z(m.indicatorsCons||{}),z(!!f),n=m.id||null,I(),K(f?"Compila il consuntivo":"Modifica previsionale"),window.scrollTo({top:0,behavior:"smooth"})}function se(m,f){f=f||new Date;var D=f.getFullYear();if(m==="settimanale"){var T=Me(D,ge(f));return{start:T.start,end:T.end}}return m==="mensile"?{start:Je(f),end:Ke(f)}:m==="trimestrale"?{start:ze(f),end:Ze(f)}:m==="semestrale"?{start:je(f),end:Qe(f)}:{start:tt(f),end:qe(f)}}function le(m,f){return f=f||new Date,m==="settimanale"?Rt(f):m==="mensile"?Ht(f):m==="trimestrale"?Yt(f):m==="semestrale"?Gt(f):qt(f)}function Se(m){var f=Me(new Date().getFullYear(),ge(new Date)),D=f.start,T=Math.floor((new Date(m)-D)/(1e3*60*60*24));return T<=13}function we(m,f,D,T,M,$){var J=He(f,D),re=A('<div class="card" style="position:relative"><div class="small muted">'+w(m)+"</div><div><b>"+w(J)+'</b></div><div class="small muted">'+x(D)+" → "+x(T)+'</div><div class="right" style="margin-top:6px"><button class="ghost" type="button" data-sug="1">'+w(M)+"</button></div></div>");return re.querySelector("[data-sug]").addEventListener("click",$),re}function Ae(m){var f=document.getElementById("bp_to_send"),D=document.getElementById("bp_sent");f.innerHTML="",D.innerHTML="";function T(me,be,pe){return m.find(function(Be){return Be.type===me&&P(Be.startDate)===P(be)&&P(Be.endDate)===P(pe)})}var M=new Date,$=M.getDay(),J=$===5||$===6||$===0,re=Ke(M),Q=Ze(M),ve=Qe(M),_e=qe(M),Te=J&&Se(re),gt=J&&Se(Q),ft=J&&Se(ve),bt=J&&Se(_e);["settimanale","mensile","trimestrale","semestrale","annuale"].forEach(function(me){var be=se(me,M),pe=T(me,be.start,be.end);if(pe){var Be=A('<div class="card" style="flex:1 1 360px"><div><b>'+w(He(me,be.start))+'</b></div><div class="small muted">'+x(be.start)+" → "+x(be.end)+'</div><div class="right" style="margin-top:6px"><button class="ghost" type="button" data-mid="'+pe.id+'">Modifica</button></div></div>');Be.querySelector("[data-mid]").addEventListener("click",function(){ae(pe,!1)}),D.appendChild(Be)}});function Ve(me,be,pe){var Be=T(me,pe.start,pe.end),Xe=T(me,be.start,be.end);Be?f.appendChild(we("Previsionale",me,pe.start,pe.end,"Modifica",function(){ae(Be,!1)})):f.appendChild(we("Previsionale",me,pe.start,pe.end,"Compila",function(){if(p.value=me,i.value=String(pe.start.getFullYear()),me==="settimanale")c.value=String(ge(pe.start));else if(me==="mensile")o.value=String(pe.start.getMonth()+1);else if(me==="trimestrale"){var Ct=Math.floor(pe.start.getMonth()/3)+1;B.value=String(Ct)}else me==="semestrale"&&(y.value=pe.start.getMonth()<6?"1":"2");e()})),Xe&&!R(Xe)&&f.appendChild(we("Consuntivo",me,be.start,be.end,"Consuntivo",function(){ae(Xe,!0)}))}if(J){var ht=se("settimanale",M),yt=le("settimanale",M);Ve("settimanale",ht,yt)}if(Te){var wt=se("mensile",M),_t=le("mensile",M);Ve("mensile",wt,_t)}if(gt){var Dt=se("trimestrale",M),St=le("trimestrale",M);Ve("trimestrale",Dt,St)}if(ft){var It=se("semestrale",M),xt=le("semestrale",M);Ve("semestrale",It,xt)}if(bt){var Et=se("annuale",M),Tt=le("annuale",M);Ve("annuale",Et,Tt)}f.children.length||(f.innerHTML='<div class="muted">Nessun suggerimento attivo in questo momento</div>');var Bt=document.getElementById("bp_sent_head"),Pt=document.getElementById("bp_sent_chev");Bt.onclick=function(){var me=document.getElementById("bp_sent"),be=me.style.display!=="none";me.style.display=be?"none":"",Pt.textContent=be?"▸":"▾"}}ne("/api/settings").then(function(m){k=m&&m.indicators||["VSS","VSDPersonale","VSDIndiretto","GI","Telefonate","AppFissati","AppFatti","CorsiLeadership","iProfile","MBS","NNCF"],S(k)}).catch(function(){k=["VSS","VSDPersonale","GI","NNCF"],S(k)}),p.onchange=e,i.oninput=v,c.oninput=v,o.onchange=v,B.onchange=v,y.onchange=v,W.onclick=oe,document.getElementById("btnSaveP").onclick=X,e(),ee()}function Fe(){if(!ue())return a();if(document.title="Battle Plan – Appuntamenti",!document.getElementById("appts_css")){const e=document.createElement("style");e.id="appts_css",e.textContent="\n      .appt-type .seg, #a_nncf.seg{\n        padding:8px 12px;border:1px solid #bcd7ff;border-radius:12px;\n        background:#eef5ff;color:#1463ff;cursor:pointer;user-select:none;\n        transition:.15s;\n      }\n      .appt-type .seg.active, #a_nncf.seg.active{\n        background:var(--accent);color:#fff;border-color:var(--accent);\n        box-shadow:0 0 0 2px rgba(20,99,255,.08) inset;\n      }\n      #a_list .grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}\n    ",document.head.appendChild(e)}d.innerHTML=De()+'<div class="wrap"><div class="card"><b id="a_form_title">Nuovo appuntamento</b><div class="row" style="margin-top:8px;align-items:flex-end;gap:12px;flex-wrap:wrap"><div style="min-width:320px"><label>Cliente *</label><div style="display:flex;gap:8px;align-items:center"><input id="a_client" list="clientList" placeholder="Denominazione" style="flex:1"><datalist id="clientList"></datalist><button id="a_nncf" class="seg" data-active="0" aria-pressed="false">NNCF</button></div></div><div><label>Data/ora inizio</label><input id="a_start" type="datetime-local"></div><div><label>Ora fine</label><input id="a_end" type="time"></div><div><label>Durata (min)</label><input id="a_dur" type="number" placeholder="60" min="1"></div></div><div class="row" style="align-items:flex-end;gap:12px;flex-wrap:wrap"><div class="appt-type"><label>Tipo</label><div><button type="button" id="t_vendita" class="seg">Vendita</button><button type="button" id="t_mezza"   class="seg" data-vsd="1000">Mezza giornata</button><button type="button" id="t_full"    class="seg" data-vsd="2000">Giornata intera</button></div><input id="a_type" type="hidden" value="vendita"></div><div><label>VSS</label><input id="a_vss" type="number" step="1" placeholder="0"></div><div><label>VSD personale</label><input id="a_vsd" type="number" step="1" placeholder="0"></div></div><div class="row" style="margin-top:8px;gap:8px;align-items:center"><div><button id="btnSaveA">Salva</button></div><div><button id="btnSaveExportA" class="ghost">Salva ed esporta</button></div><div class="right" style="margin-left:auto"><button id="btnDeleteA" class="danger" style="display:none">Elimina</button></div></div></div><div class="card"><b>Elenco appuntamenti</b><div class="row" style="margin-top:8px;align-items:flex-end;gap:12px;flex-wrap:wrap"><div><label>Vista</label><select id="af_type"><option value="sett">Settimana</option><option value="mese">Mese</option></select></div><div id="af_week_wrap"><label>Settimana ISO</label><input id="af_week" type="number" min="1" max="53" value="'+ge(new Date)+'"></div><div id="af_month_wrap" style="display:none"><label>Mese</label><select id="af_month"><option value="1">Gennaio</option><option value="2">Febbraio</option><option value="3">Marzo</option><option value="4">Aprile</option><option value="5">Maggio</option><option value="6">Giugno</option><option value="7">Luglio</option><option value="8">Agosto</option><option value="9">Settembre</option><option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option></select></div><div><label>Anno</label><input id="af_year" type="number" min="2000" max="2100" value="'+new Date().getFullYear()+'"></div><div class="right" style="margin-left:auto;display:flex;gap:8px"><button id="af_prev" class="ghost">◀</button><button id="af_next" class="ghost">▶</button></div></div><div id="a_list" style="margin-top:8px"></div></div></div>',he();function t(e){return String(e).replace(/[&<>'"]/g,v=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[v])}function n(e){var v=Number(e)||0;return v.toLocaleString("it-IT")+"€"}function k(e){var v=new Date(e);return("0"+v.getDate()).slice(-2)+"/"+("0"+(v.getMonth()+1)).slice(-2)+"/"+v.getFullYear()}function l(e){if(!e)return"";const v=new Date(e);return isNaN(v)?"":v.toISOString()}function U(e){if(!e)return"";const v=new Date(e);return isNaN(v)?"":new Date(v.getTime()-v.getTimezoneOffset()*6e4).toISOString().slice(0,16)}function w(e){return e=String(e||"").toLowerCase(),e.indexOf("mezza")>-1?240:e.indexOf("giorn")>-1?570:90}const P=document.getElementById("a_nncf");P.addEventListener("click",()=>{const e=P.getAttribute("data-active")!=="1";P.setAttribute("data-active",e?"1":"0"),P.setAttribute("aria-pressed",e?"true":"false"),P.classList.toggle("active",e),e&&h(document.getElementById("t_vendita"))});const x=document.getElementById("t_vendita"),te=document.getElementById("t_mezza"),A=document.getElementById("t_full"),R=[x,te,A];function h(e){R.forEach(S=>S.classList.toggle("active",S===e));const v=document.getElementById("a_type");e===x&&(v.value="vendita",b(90)),e===te&&(v.value="mezza",b(240),document.getElementById("a_vsd").value="1000"),e===A&&(v.value="giornata",b(570),document.getElementById("a_vsd").value="2000")}function b(e){const v=document.getElementById("a_dur");v.value=String(e),p()}R.forEach(e=>e.addEventListener("click",v=>{v.preventDefault(),h(e)})),h(x);function p(){const e=document.getElementById("a_start").value,v=parseInt(document.getElementById("a_dur").value||"0",10);if(!e||!isFinite(v)||v<=0){document.getElementById("a_end").value="";return}const S=new Date(e),V=new Date(S.getTime()+v*6e4);document.getElementById("a_end").value=("0"+V.getHours()).slice(-2)+":"+("0"+V.getMinutes()).slice(-2)}function i(){const e=document.getElementById("a_start").value,v=document.getElementById("a_end").value;if(!e||!v)return;const S=new Date(e),V=v.split(":");if(V.length<2)return;const C=new Date(S);C.setHours(parseInt(V[0],10)||0,parseInt(V[1],10)||0,0,0),C<S&&C.setDate(C.getDate()+1);let E=Math.round((C-S)/6e4);document.getElementById("a_dur").value=String(Math.max(1,E))}document.getElementById("a_start").addEventListener("change",p),document.getElementById("a_dur").addEventListener("input",p),document.getElementById("a_end").addEventListener("change",i),ne("/api/clients").then(e=>{const v=e&&e.clients||[],S=document.getElementById("clientList");S&&(S.innerHTML=v.map(V=>'<option value="'+t(V.name)+'"></option>').join(""))});let g=null;function s(){g=null,document.getElementById("a_form_title").textContent="Nuovo appuntamento",document.getElementById("a_client").value="",document.getElementById("a_start").value="",document.getElementById("a_end").value="",document.getElementById("a_dur").value="",document.getElementById("a_vss").value="",document.getElementById("a_vsd").value="",P.setAttribute("data-active","0"),P.setAttribute("aria-pressed","false"),P.classList.remove("active"),h(x),document.getElementById("btnDeleteA").style.display="none"}function F(e){g=e.id,document.getElementById("a_form_title").textContent="Modifica appuntamento",document.getElementById("a_client").value=e.client||"",document.getElementById("a_start").value=U(e.start);const v=new Date(e.start);let S=new Date(e.end),V=Math.max(1,Math.round((S-v)/6e4));if(!(S instanceof Date)||isNaN(S)||S<v){const E=w(e.type||"vendita");S=new Date(v.getTime()+E*6e4),V=E}document.getElementById("a_dur").value=String(V),document.getElementById("a_end").value=("0"+S.getHours()).slice(-2)+":"+("0"+S.getMinutes()).slice(-2),document.getElementById("a_vss").value=e.vss||"",document.getElementById("a_vsd").value=e.vsdPersonal||e.vsd||"";const C=!!e.nncf;P.setAttribute("data-active",C?"1":"0"),P.setAttribute("aria-pressed",C?"true":"false"),P.classList.toggle("active",C),h(V===240?te:V===570?A:x),document.getElementById("btnDeleteA").style.display=""}function r(){const e=(document.getElementById("a_client").value||"").trim();if(!e)return K("Cliente obbligatorio"),null;const v=document.getElementById("a_start").value;if(!v)return K("Data/ora obbligatorie"),null;let S=parseInt(document.getElementById("a_dur").value||"60",10);(!isFinite(S)||S<=0)&&(S=60);const V=document.getElementById("a_end").value;let C;if(V){const E=new Date(v),O=V.split(":"),H=new Date(E);H.setHours(parseInt(O[0],10)||0,parseInt(O[1],10)||0,0,0),H<E&&H.setDate(H.getDate()+1),C=H.toISOString(),S=Math.max(1,Math.round((H-E)/6e4)),document.getElementById("a_dur").value=String(S)}else C=new Date(new Date(v).getTime()+S*6e4).toISOString();return{id:g||void 0,client:e,start:l(v),end:C,type:document.getElementById("a_type").value,vss:Number(document.getElementById("a_vss").value||0),vsdPersonal:Number(document.getElementById("a_vsd").value||0),nncf:P.getAttribute("data-active")==="1"}}function c(e){const v=r();v&&Ie("/api/appointments",v).then(()=>{K("Appuntamento salvato"),typeof haptics<"u"&&haptics.try("success"),document.dispatchEvent(new Event("appt:saved")),e&&window.BP&&BP.ICS&&typeof BP.ICS.downloadIcsForAppointment=="function"&&(BP.ICS.downloadIcsForAppointment(v),typeof haptics<"u"&&haptics.try("medium"),document.dispatchEvent(new Event("ics:exported"))),s(),z()}).catch(()=>K("Errore salvataggio"))}function o(){if(!g||!confirm("Eliminare l'appuntamento?"))return;const e=r();fetch("/api/appointments?id="+encodeURIComponent(g),{method:"DELETE",headers:{Authorization:"Bearer "+et()}}).then(v=>{if(!v.ok)throw new Error("HTTP "+v.status);return v.json()}).then(()=>{K("Eliminato"),typeof showUndo=="function"&&e&&showUndo("Appuntamento eliminato",function(){return Ie("/api/appointments",e)},5e3),s(),z()}).catch(()=>K("Errore eliminazione"))}document.getElementById("btnSaveA").onclick=()=>c(!1),document.getElementById("btnSaveExportA").onclick=()=>c(!0),document.getElementById("btnDeleteA").onclick=o;function B(){const e=document.getElementById("af_type").value,v=parseInt(document.getElementById("af_year").value,10);if(e==="sett"){const S=Math.max(1,Math.min(53,parseInt(document.getElementById("af_week").value||ge(new Date),10))),V=Me(v,S);return{s:new Date(V.start),e:new Date(V.end)}}else{const S=parseInt(document.getElementById("af_month").value||new Date().getMonth()+1,10);return{s:new Date(v,S-1,1),e:new Date(v,S,0,23,59,59,999)}}}function y(e){const v=document.getElementById("af_type").value,S=parseInt(document.getElementById("af_year").value,10);if(v==="sett"){const V=parseInt(document.getElementById("af_week").value,10),C=new Date(Me(S,V).start);C.setDate(C.getDate()+7*e),document.getElementById("af_year").value=C.getFullYear(),document.getElementById("af_week").value=ge(C)}else{const V=parseInt(document.getElementById("af_month").value,10),C=new Date(S,V-1,1);C.setMonth(C.getMonth()+e),document.getElementById("af_year").value=C.getFullYear(),document.getElementById("af_month").value=C.getMonth()+1}z()}document.getElementById("af_prev").onclick=()=>y(-1),document.getElementById("af_next").onclick=()=>y(1);const Y=document.getElementById("af_type"),_=document.getElementById("af_week"),L=document.getElementById("af_month"),G=document.getElementById("af_year");Y.onchange=function(){const e=Y.value;document.getElementById("af_week_wrap").style.display=e==="sett"?"":"none",document.getElementById("af_month_wrap").style.display=e==="mese"?"":"none",z()},[_,L,G].forEach(e=>{e&&(e.onchange=z)});function W(e){const v=new Date(e.start);let S=new Date(e.end);(!(S instanceof Date)||isNaN(S)||S<v)&&(S=new Date(v.getTime()+w(e.type||"vendita")*6e4));const V=k(v)+" "+("0"+v.getHours()).slice(-2)+":"+("0"+v.getMinutes()).slice(-2)+"–"+("0"+S.getHours()).slice(-2)+":"+("0"+S.getMinutes()).slice(-2),C="VSS "+n(e.vss||0)+" · VSD "+n(e.vsdPersonal||0)+" · NNCF "+(e.nncf?"✅":"—");return'<div class="card" data-aid="'+t(String(e.id||""))+'" style="flex:1 1 320px"><div class="small muted">'+t(V)+" · "+t(e.type||"vendita")+'</div><div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><div><b>'+t(e.client||"")+'</b></div><div class="row" style="gap:6px"><button class="ghost" title="Esporta" data-ics="'+t(String(e.id||""))+'">Esporta</button><button class="ghost" title="Modifica" data-edit="'+t(String(e.id||""))+'">✏️</button></div></div><div class="small">'+C+"</div></div>"}function z(){ne("/api/appointments").then(e=>{const v=e&&e.appointments||[],S=B(),V=S.s.getTime(),C=S.e.getTime(),E=v.filter(q=>{const I=new Date(q.start).getTime();return I>=V&&I<=C}).sort((q,I)=>new Date(q.start)-new Date(I.start)),O=new Date,H=E.filter(q=>new Date(q.start)>=O),Z=E.filter(q=>new Date(q.start)<O),oe=document.getElementById("a_list");let ie="";ie+="<div><b>Prossimi</b></div>",ie+=H.length?'<div class="grid3">'+H.map(W).join("")+"</div>":'<div class="muted" style="margin:6px 0 12px">Nessun appuntamento futuro</div>';const u="past_"+Math.random().toString(36).slice(2,8);ie+='<div id="'+u+'_head" style="margin-top:12px;display:flex;align-items:center;justify-content:space-between;cursor:pointer"><b>Passati</b><span class="chev">▸</span></div><div id="'+u+'_box" style="display:none;margin-top:8px">'+(Z.length?'<div class="grid3">'+Z.map(W).join("")+"</div>":'<div class="muted">Nessun appuntamento passato</div>')+"</div>",oe.innerHTML=ie,(function(){const q=document.getElementById(u+"_head"),I=document.getElementById(u+"_box"),X=q.querySelector(".chev");q.onclick=function(){const ee=I.style.display==="none";I.style.display=ee?"":"none",X.textContent=ee?"▾":"▸"}})();const N=E;oe.querySelectorAll("[data-ics]").forEach(q=>{q.addEventListener("click",I=>{I.stopPropagation();const X=q.getAttribute("data-ics"),ee=N.find(ae=>String(ae.id)===String(X));if(!ee){K("Appuntamento non trovato");return}window.BP&&BP.ICS&&typeof BP.ICS.downloadIcsForAppointment=="function"?(BP.ICS.downloadIcsForAppointment(ee),typeof haptics<"u"&&haptics.try("medium"),document.dispatchEvent(new Event("ics:exported")),K("Esportato")):K("Export .ics non disponibile")})}),oe.querySelectorAll("[data-edit]").forEach(q=>{q.addEventListener("click",I=>{I.stopPropagation();const X=q.getAttribute("data-edit"),ee=N.find(ae=>String(ae.id)===String(X));ee&&(F(ee),window.scrollTo({top:0,behavior:"smooth"}))})})})}try{const e=Ge("bp_prefill_slot",null);if(e&&e.start){const v=new Date(e.start),S=new Date(e.end||e.start),V=new Date(v.getTime()-v.getTimezoneOffset()*6e4).toISOString().slice(0,16);document.getElementById("a_start").value=V,document.getElementById("a_dur").value=String(Math.max(1,Math.round((S-v)/6e4))),p(),K("Slot precompilato negli appuntamenti")}Oe("bp_prefill_slot")}catch(e){}try{const e=Ge("bp_edit_aid",null);e&&ne("/api/appointments").then(v=>{const V=(v&&v.appointments||[]).find(C=>String(C.id)===String(e));V&&(F(V),window.scrollTo({top:0,behavior:"smooth"}))}).finally(()=>{try{Oe("bp_edit_aid")}catch(v){}})}catch(e){}document.getElementById("btnSaveA").onclick=()=>c(!1),document.getElementById("btnSaveExportA").onclick=()=>c(!0),document.getElementById("btnDeleteA").onclick=o,ne("/api/clients").then(()=>{}),z()}function st(){if(!ue())return a();document.title="Battle Plan – Classifiche",d.innerHTML=De()+('<div class="wrap"><div class="card"><div class="row"><div><label>Vista</label><select id="lb_tab"><option value="per_indicator">Per indicatore</option><option value="overall">Generale (score)</option></select></div><div><label>Modalità</label><select id="lb_mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div><div id="lb_ind_wrap"><label>Indicatore</label><select id="lb_indicator"><option value="VSS">VSS</option><option value="VSDPersonale">VSD</option><option value="GI">GI</option><option value="NNCF">NNCF</option></select></div></div>'+j("lb")+'</div><div class="card"><b id="lb_title">Classifica</b><div id="lb_podium" style="margin:10px 0"></div><div id="lb_table"></div></div></div>'),he();function t(A){if(!A)return"";var R=new Date(A);return R.getFullYear()+"-"+("0"+(R.getMonth()+1)).slice(-2)+"-"+("0"+R.getDate()).slice(-2)}function n(A){return A==="ytd"||A==="ltm"?"mensile":A}document.getElementById("lb_tab").onchange=function(){var A=this.value;document.getElementById("lb_ind_wrap").style.display=A==="per_indicator"?"":"none",l()},ye("lb",l),document.getElementById("lb_mode").onchange=l,document.getElementById("lb_indicator").onchange=l;function k(){var A=fe("lb"),R=t(A.start),h=t(A.end),b=n(A.type||"mensile");return"&from="+encodeURIComponent(R)+"&to="+encodeURIComponent(h)+"&type="+encodeURIComponent(b)}function l(){var A=document.getElementById("lb_tab").value,R=k(),h=document.getElementById("lb_mode").value;if(A==="overall")ne("/api/leaderboard_overall?mode="+encodeURIComponent(h)+R).then(te);else{var b=document.getElementById("lb_indicator").value;ne("/api/leaderboard?indicator="+encodeURIComponent(b)+"&mode="+encodeURIComponent(h)+R).then(function(p){x(p,b)})}}function U(A){return A===0?"🥇":A===1?"🥈":A===2?"🥉":A+1+"."}function w(A){var R=document.getElementById("lb_podium");if(!A||!A.length){R.innerHTML="";return}for(var h=A.slice(0,3),b='<div class="row" style="align-items:flex-end">',p=0;p<h.length;p++){var i=80-p*15;b+='<div class="card" style="flex:1 1 120px;height:'+i+'px;display:flex;align-items:flex-end;justify-content:center"><div>'+ce(U(p)+" "+h[p].name)+"</div></div>"}b+="</div>",R.innerHTML=b}function P(A,R,h){var b=Math.min(100,Math.max(0,Math.round(h)));return'<div class="card" style="flex:1 1 280px"><div><b>'+ce(A)+'</b></div><div class="small muted">'+ce(R)+'</div><div style="height:10px;background:rgba(255,255,255,0.1);border-radius:6px;overflow:hidden;margin-top:6px"><div style="height:10px;width:'+b+'%;background:linear-gradient(90deg,var(--accent),var(--accent2));"></div></div></div>'}function x(A,R){document.getElementById("lb_title").textContent="Classifica – "+R;var h=A.ranking||[];if(w(h),!h.length){document.getElementById("lb_table").innerHTML='<div class="muted">Nessun dato</div>';return}for(var b='<div class="row">',p=h[0].total||1,i=0;i<h.length;i++){var g=h[i];b+=P(U(i)+" "+g.name,"Totale: "+Ce(g.total),g.total/p*100)}b+="</div>",document.getElementById("lb_table").innerHTML=b}function te(A){document.getElementById("lb_title").textContent="Classifica generale";var R=A.ranking||[];if(w(R),!R.length){document.getElementById("lb_table").innerHTML='<div class="muted">Nessun dato</div>';return}for(var h=R[0].score||0,b='<div class="row">',p=0;p<R.length;p++){var i=R[p];b+=P(U(p)+" "+i.name,"Score: "+Ce(i.score)+"/100",h?i.score/h*100:0)}b+="</div>",document.getElementById("lb_table").innerHTML=b}l()}(function(){function t(){var n=document.getElementById("bp-overlay");return n||(n=document.createElement("div"),n.id="bp-overlay",n.className="hidden",n.setAttribute("role","dialog"),n.setAttribute("aria-modal","true"),n.innerHTML='<div class="bp-overlay-backdrop" id="bp-overlay-backdrop"></div><div class="bp-overlay-panel" id="bp-overlay-panel"></div>',document.body.appendChild(n),document.getElementById("bp-overlay-backdrop").addEventListener("click",hideOverlay)),n}window.showOverlay=function(n){var k=t(),l=document.getElementById("bp-overlay-panel");l.innerHTML=n||"",k.classList.remove("hidden");var U=l.querySelector("input, textarea, select, button");U&&setTimeout(function(){try{U.focus()}catch(w){}},0)},window.hideOverlay=function(){var n=document.getElementById("bp-overlay");n&&n.classList.add("hidden")}})();function dt(){if(!ue())return a();document.title="Battle Plan – Clienti",d.innerHTML=De()+'<div class="wrap"><div class="card"><b>Nuovo cliente</b><div class="row" style="margin-top:8px"><div><label>Ragione sociale</label><input id="cl_name" type="text" placeholder="Es. Rossi S.r.l."></div><div><label>Stato</label><select id="cl_new_state"><option value="potenziale">Potenziale</option><option value="lead non chiuso">Lead non chiuso</option><option value="attivo">Attivo</option></select></div><div><label>Consulente</label><select id="cl_new_owner"><option value="">—</option></select></div><div class="right"><button id="cl_add">Aggiungi</button></div></div></div><div class="card"><b>Filtri elenco</b><div class="row" style="margin-top:8px"><div><label>Stato</label><select id="cl_f_state"><option value="">Tutti</option><option value="attivo">Attivo</option><option value="lead non chiuso">Lead non chiuso</option><option value="potenziale">Potenziale</option></select></div><div><label>Consulente</label><select id="cl_f_cons"><option value="">Tutti</option></select></div><div><label>Ordina per</label><select id="cl_order"><option value="az">Ragione sociale (A→Z)</option><option value="last_desc">Ultimo appuntamento (recenti prima)</option></select></div><div class="right"><button class="ghost" id="cl_f_apply">Applica</button></div></div></div><div class="card"><b>Elenco clienti</b><div id="cl_list" class="row" style="margin-top:8px"></div></div></div>',he();function t(){const l=(document.getElementById("cl_name").value||"").trim();if(!l){K("Nome obbligatorio");return}const U=document.getElementById("cl_new_state"),w=document.getElementById("cl_new_owner"),P={name:l};U&&(P.status=U.value),w&&w.value&&(P.consultantId=w.value),Ie("/api/clients",P).then(function(){document.getElementById("cl_name").value="",k(),Ye(),addXP(5)}).catch(function(x){logger.error(x),K("Errore creazione cliente")})}function n(){ne("/api/usernames").then(function(l){const U=l&&l.users||[],w=document.getElementById("cl_f_cons"),P=document.getElementById("cl_new_owner");w&&(w.innerHTML='<option value="">Tutti</option>'+U.map(function(x){return'<option value="'+x.id+'">'+ce(x.name)+(x.grade?" ("+x.grade+")":"")+"</option>"}).join("")),P&&(P.innerHTML='<option value="">—</option>'+U.map(function(x){return'<option value="'+x.id+'">'+ce(x.name)+(x.grade?" ("+x.grade+")":"")+"</option>"}).join(""))}).catch(function(l){logger.error(l)})}function k(){ne("/api/clients").then(function(l){const U=l&&l.clients||[],w=document.getElementById("cl_f_state").value,P=document.getElementById("cl_f_cons").value;function x(R){return String(R||"").trim().toLowerCase()}const A=U.filter(function(R){return!(w&&x(R.status)!==x(w)||P&&String(R.consultantId||"")!==String(P))}).map(function(R){const h=ce(R.name||""),b=ce(R.status||"potenziale"),p=R.consultantName?ce(R.consultantName):"unknown",i=String(R.id||"");return'<div class="card" data-clid="'+i+'" data-name-lower="'+h.toLowerCase()+'" data-status="'+b+'" data-consultant-id="'+ce(String(R.consultantId||""))+'" style="flex:1 1 380px"><div><b>'+h+'</b></div><div class="small">Stato: <b class="cl-status">'+b+'</b></div><div class="small">Consulente: <b class="cl-cons">'+p+'</b></div><div class="small muted">Ultimo appuntamento: <span class="last-appt">—</span></div><div class="right" style="margin-top:6px"><button class="ghost" data-del="'+i+'">Rimuovi</button></div></div>'}).join("");document.getElementById("cl_list").innerHTML=A||'<div class="muted">Nessun cliente</div>',document.querySelectorAll("[data-del]").forEach(function(R){R.addEventListener("click",function(){const h=R.getAttribute("data-del");confirm("Rimuovere il cliente?")&&fetch("/api/clients?id="+encodeURIComponent(h),{method:"DELETE",headers:{Authorization:"Bearer "+et()}}).then(function(b){if(!b.ok)throw new Error("HTTP "+b.status);return b.json()}).then(function(){K("Cliente rimosso"),k()}).catch(function(b){logger.error(b),K("Errore rimozione")})})}),window.BPFinal&&typeof BPFinal.ensureClientSection=="function"?BPFinal.ensureClientSection():setTimeout(function(){const R=document.getElementById("cl_list"),h=Array.from(R.children).filter(b=>b.classList.contains("card"));h.sort((b,p)=>String(b.getAttribute("data-name-lower")||"").localeCompare(String(p.getAttribute("data-name-lower")||"")));for(const b of h)R.appendChild(b)},0)})}document.getElementById("cl_add").onclick=t,document.getElementById("cl_f_apply").onclick=k,n(),k()}function ct(){if(!ue())return a();document.title="Battle Plan – Squadra";var t=De()+'<div class="wrap">'+('<div class="card"><b>Vista Amministratore</b><div id="t_adminbar" class="row" style="margin-top:8px;display:flex;align-items:flex-end;gap:16px;flex-wrap:nowrap"><div><label>Modalità</label><select id="t_mode" name="mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div><div id="t_unified_wrap">'+j("t")+'</div></div></div><div class="card"><b>Riepilogo per utente</b><div id="t_users" class="row" style="margin-top:8px"></div></div><div class="card"><b>Aggregato Squadra</b><div id="t_agg" class="row" style="margin-top:8px"></div><div class="row" style="margin-top:12px;align-items:flex-end;gap:16px;flex-wrap:nowrap"><div><label>Indicatore grafico</label><select id="t_ind"><option value="VSS">VSS</option><option value="VSDPersonale">VSD Personale</option><option value="VSDIndiretto">VSD Indiretto</option><option value="VSDTotale">VSD Totale</option><option value="GI">GI</option><option value="NNCF">NNCF</option><option value="provv_gi">Provv GI</option><option value="provv_vsd">Provv VSD</option><option value="tot_provv" selected>Tot Provvigioni</option></select></div><div><label>Consulente</label><select id="t_cons"><option value="">Tutti</option></select></div></div><div style="margin-top:8px"><canvas id="t_chart" height="160"></canvas></div></div>')+"</div>";d.innerHTML=t,he(),(function(){var c=document.getElementById("t_adminbar"),o=document.getElementById("t_unified_wrap");if(!(!c||!o)){var B=o.querySelector(".row");B&&(Array.from(B.children).forEach(function(y){y.classList.remove("right"),y.style.marginTop="0",c.appendChild(y)}),o.remove())}})();function n(r){return r=Number(r||0),isFinite(r)?r:0}function k(r){if(!r)return"";var c=new Date(r);return c.getFullYear()+"-"+("0"+(c.getMonth()+1)).slice(-2)+"-"+("0"+c.getDate()).slice(-2)}function l(r){return r=String(r||"mensile").toLowerCase(),r.indexOf("sett")===0?"settimanale":r.indexOf("mes")===0?"mensile":r.indexOf("tri")===0?"trimestrale":r.indexOf("sem")===0?"semestrale":r.indexOf("ann")===0?"annuale":"mensile"}function U(){var r=fe("t"),c=k(r.start),o=k(r.end),B=l(r.type);return"&from="+encodeURIComponent(c)+"&to="+encodeURIComponent(o)+"&type="+encodeURIComponent(B)}function w(r){switch(String(r)){case"provv_gi":return"ProvvGI";case"provv_vsd":return"ProvvVSD";case"tot_provv":return"TotProvvigioni";default:return r}}function P(r){var c=Number(r)||0;return c.toLocaleString("it-IT")+"€"}function x(r){var c=Number(r)||0;return String(Math.round(c))}function te(r){return String(r).replace(/[&<>'"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[c])}var A=null;function R(r,c){return c==="settimanale"?window.isoWeekNum?window.isoWeekNum(r):Math.ceil(r.getDate()/7):c==="mensile"||c==="ytd"||c==="ltm"?r.getMonth()+1:c==="trimestrale"?Math.floor(r.getMonth()/3)+1:c==="semestrale"?r.getMonth()<6?1:2:r.getFullYear()}function h(r,c){var o=document.getElementById("t_chart");if(o){var B=r.map(function(G){return R(G.x,c)}),y=r.map(function(G){return G.y});if(typeof Chart>"u"){var L=o.getContext("2d");o.width=o.clientWidth||600,o.height=o.clientHeight||160,L.clearRect(0,0,o.width,o.height);var Y=Math.max(1,...y),_=y.length>1?(o.width-8)/(y.length-1):0;L.beginPath(),L.lineWidth=2,L.strokeStyle="#2e6cff",y.forEach(function(W,z){var e=4+z*_,v=o.height-6-W/Y*(o.height-12);z?L.lineTo(e,v):L.moveTo(e,v)}),L.stroke();return}var L=o.getContext("2d");A?(A.data.labels=B,A.data.datasets[0].data=y,A.update()):A=new Chart(L,{type:"line",data:{labels:B,datasets:[{label:"",data:y,tension:.3,pointRadius:3}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{x:{grid:{display:!1},ticks:{autoSkip:!1,maxRotation:0,minRotation:0}},y:{beginAtZero:!0}}}})}}function b(r){return'<div class="card" style="flex:1 1 360px"><div style="display:flex;align-items:center;gap:8px"><div><b>'+te(r.name||"User #"+r.userId)+"</b></div>"+(r.grade?'<span class="chip small">'+te(r.grade)+"</span>":"")+'</div><div class="small" style="margin-top:6px">VSS '+P(r.vss||0)+'</div><div class="small">VSD Pers. '+P(r.vsdP||0)+'</div><div class="small">VSD Ind. '+P(r.vsdI||0)+'</div><div class="small">VSD Tot. '+P((r.vsdP||0)+(r.vsdI||0))+'</div><div class="small">GI '+P(r.gi||0)+'</div><div class="small">NNCF '+x(r.nncf||0)+'</div><div class="small muted" style="margin-top:6px">Provv GI '+P(r.provvGi||0)+'</div><div class="small muted">Provv VSD '+P(r.provvVsd||0)+'</div><div class="small"><b>Tot Provvigioni '+P(r.provvTot||0)+"</b></div></div>"}function p(r){return'<div class="card" style="flex:1 1 460px"><div class="neon" style="font-weight:900">Totali squadra</div><div class="small" style="margin-top:6px">VSS '+P(r.vss)+'</div><div class="small">VSD Pers. '+P(r.vsdP)+'</div><div class="small">VSD Ind. '+P(r.vsdI)+'</div><div class="small">VSD Tot. '+P(r.vsdP+r.vsdI)+'</div><div class="small">GI '+P(r.gi)+'</div><div class="small">NNCF '+x(r.nncf)+'</div><div class="small muted" style="margin-top:6px">Provv GI '+P(r.provvGi)+'</div><div class="small muted">Provv VSD '+P(r.provvVsd)+'</div><div class="small"><b>Tot Provvigioni '+P(r.provvTot)+"</b></div></div>"}function i(){var r=(document.getElementById("t_mode")||{}).value||"consuntivo",c=U();Promise.all([ne("/api/usernames"),ne("/api/leaderboard?indicator="+encodeURIComponent("VSS")+c+"&mode="+encodeURIComponent(r)),ne("/api/leaderboard?indicator="+encodeURIComponent("VSDPersonale")+c+"&mode="+encodeURIComponent(r)),ne("/api/leaderboard?indicator="+encodeURIComponent("VSDIndiretto")+c+"&mode="+encodeURIComponent(r)),ne("/api/leaderboard?indicator="+encodeURIComponent("GI")+c+"&mode="+encodeURIComponent(r)),ne("/api/leaderboard?indicator="+encodeURIComponent("NNCF")+c+"&mode="+encodeURIComponent(r)),ne("/api/leaderboard?indicator="+encodeURIComponent("ProvvGI")+c+"&mode="+encodeURIComponent(r)),ne("/api/leaderboard?indicator="+encodeURIComponent("ProvvVSD")+c+"&mode="+encodeURIComponent(r))]).then(function(o){var B=o[0]||{},y=o[1]&&(o[1].rows||o[1].ranking)||[],Y=o[2]&&(o[2].rows||o[2].ranking)||[],_=o[3]&&(o[3].rows||o[3].ranking)||[],L=o[4]&&(o[4].rows||o[4].ranking)||[],G=o[5]&&(o[5].rows||o[5].ranking)||[],W=o[6]&&(o[6].rows||o[6].ranking)||[],z=o[7]&&(o[7].rows||o[7].ranking)||[],e=(B.users||[]).map(function(I){return{id:String(I.id),name:I.name||I.email||"User #"+I.id,grade:I.grade==="senior"?"senior":"junior"}}),v=document.getElementById("t_cons");v&&(v.innerHTML='<option value="">Tutti</option>'+e.map(function(I){return'<option value="'+I.id+'">'+te(I.name)+"</option>"}).join(""));function S(I){for(var X={},ee=0;ee<I.length;ee++){var ae=I[ee],se=String(ae.userId||ae.id||ae.uid||""),le=n(ae.total||ae.value||ae.sum||0);se&&(X[se]=le)}return X}var V=S(y),C=S(Y),E=S(_),O=S(L),H=S(G),Z=S(W),oe=S(z),ie=e.map(function(I){var X=n(V[I.id]),ee=n(C[I.id]),ae=n(E[I.id]),se=n(O[I.id]),le=n(H[I.id]),Se=n(Z[I.id]),we=n(oe[I.id]);return{userId:I.id,name:I.name,grade:I.grade,vss:X,vsdP:ee,vsdI:ae,gi:se,nncf:le,provvGi:Se,provvVsd:we,provvTot:Se+we}}),u=document.getElementById("t_users");u&&(u.innerHTML=ie.length?ie.map(b).join(""):'<div class="muted">Nessun dato</div>');var N=ie.reduce(function(I,X){return I.vss+=X.vss,I.vsdP+=X.vsdP,I.vsdI+=X.vsdI,I.gi+=X.gi,I.nncf+=X.nncf,I.provvGi+=X.provvGi,I.provvVsd+=X.provvVsd,I.provvTot+=X.provvTot,I},{vss:0,vsdP:0,vsdI:0,gi:0,nncf:0,provvGi:0,provvVsd:0,provvTot:0}),q=document.getElementById("t_agg");q&&(q.innerHTML=p(N)),F()}).catch(function(o){logger.error(o),K("Errore caricamento squadra")})}function g(r){return(typeof Ue=="function"?Ue(r,new Date):[]).map(function(c){return{s:c.s,e:c.e}})}function s(r,c,o,B){var y=B||fe("t"),Y=String(y.type||"mensile").toLowerCase(),_=Y==="ytd"||Y==="ltm"?"mensile":Y,L=g(Y);function G(z,e){var v=new Date(e.startDate).getTime(),S=new Date(e.endDate).getTime();return v>=z.s&&S<=z.e}function W(z,e){if(!z)return 0;if(e==="VSDTotale")return Number(z.VSDPersonale||0)+Number(z.VSDIndiretto||0);if(e==="ProvvGI")return Number(z.ProvvGI||0);if(e==="ProvvVSD")return Number(z.ProvvVSD||0);if(e==="TotProvvigioni"){var v=z.TotProvvigioni;return Number(v!=null?v:Number(z.ProvvGI||0)+Number(z.ProvvVSD||0))}return Number(z[e]||0)}return ne("/api/periods?global=1").catch(function(){return ne("/api/periods")}).then(function(z){var e=z&&z.periods||[],v=e.filter(function(V){return!(V.type!==_||o&&String(V.userId||V.uid||"")!==String(o))}),S=L.map(function(V){for(var C=0,E=0;E<v.length;E++){var O=v[E];if(G(V,O)){var H=c==="previsionale"?O.indicatorsPrev||{}:O.indicatorsCons||{};C+=W(H,w(r))}}return{x:new Date(V.s),y:Math.round(C*100)/100}});return S})}function F(){var r=document.getElementById("t_ind").value,c=document.getElementById("t_mode").value||"consuntivo",o=document.getElementById("t_cons").value||"",B=fe("t"),y=B.type,Y=w(r);U()+(o?"&userId="+encodeURIComponent(o):"")+("&indicator="+encodeURIComponent(Y))+("&mode="+encodeURIComponent(c));var _=s(Y,c,o||null,B);_.then(function(L){h(L,y)}).catch(function(L){logger.error(L),h([],y)})}ye("t",function(){typeof haptic=="function"&&haptic("light"),i()}),document.getElementById("t_mode").onchange=function(){typeof haptic=="function"&&haptic("light"),i()},document.getElementById("t_ind").onchange=function(){typeof haptic=="function"&&haptic("light"),F()},document.getElementById("t_cons").onchange=function(){typeof haptic=="function"&&haptic("light"),F()},i()}function ut(){if(!ue())return a();var t=ue().role==="admin";document.title="Battle Plan – Provvigioni",d.innerHTML=De()+'<div class="wrap"><div class="card"><b>Calcolo provvigioni</b><div class="row" style="margin-top:8px; gap:12px; flex-wrap:wrap">'+(t?'<div><label>Utente</label><select id="comm_user"><option value="__all">Tutta la squadra</option></select></div>':"")+'<div><label>Modalità</label><select id="comm_mode" name="mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div></div>'+j("comm")+'</div><div class="card"><b>Indicatori periodo</b><div id="comm_total" class="row" style="margin-top:8px; gap:12px; flex-wrap:wrap"></div></div><div class="card"><b>Provvigioni – ripartizione</b><div class="small muted">Confronto tra Provvigioni GI e Provvigioni VSD sul periodo selezionato</div><div class="row" style="margin-top:8px; align-items:center; gap:16px; flex-wrap:wrap"><canvas id="cm_pie_provv" width="260" height="260" style="max-width:260px; max-height:260px"></canvas><div id="cm_pie_legend" class="small"></div></div></div><div class="card"><b>Dettaglio</b><div id="comm_rows" class="row" style="margin-top:8px; gap:12px; flex-wrap:wrap"></div></div></div>',he();function n(h){return document.getElementById(h)}function k(h){var b=Number(h)||0;return b.toLocaleString("it-IT")+"€"}function l(h){return h=Number(h==null?"":h),isFinite(h)?h:0}function U(h){return h?h.TotProvvigioni!=null?l(h.TotProvvigioni):l(h.ProvvGI)+l(h.ProvvVSD):0}function w(h,b){return'<div class="card" style="flex:1 1 180px"><div class="small muted">'+ce(h)+'</div><div style="font-weight:700; font-size:20px; margin-top:4px">'+b+"</div></div>"}function P(h){return""+w("VSD personale",k(h.vsd||0))+w("GI",k(h.gi||0))+w("Provv. VSD",k(h.provv_vsd||0))+w("Provv. GI",k(h.provv_gi||0))+w("Totale Provvigioni",k(h.provv_total||0))}function x(h){return h.length?h.map(function(b){return'<div class="card" style="flex:1 1 320px"><div><b>'+ce(b.name)+'</b></div><div class="small" style="margin-top:4px">GI '+k(b.gi||0)+" · VSD "+k(b.vsd||0)+'</div><div class="small muted" style="margin-top:2px">Provv. GI '+k(b.provv_gi||0)+" · Provv. VSD "+k(b.provv_vsd||0)+'</div><div class="small" style="margin-top:6px"><b>Totale: '+k(b.provv_total||0)+"</b></div></div>"}).join(""):'<div class="muted">Nessun dato</div>'}function te(h,b,p){var i=document.getElementById("cm_pie_provv"),g=document.getElementById("cm_pie_legend");if(!i||!i.getContext){g&&(g.innerHTML="");return}var s=i.getContext("2d"),F=i.width,r=i.height,c=F/2,o=r/2,B=Math.min(F,r)/2-8;s.clearRect(0,0,F,r);var y=Math.max(0,h||0),Y=Math.max(0,b||0),_=y+Y,L=p>0?Math.round(_/p*100):null;if(_<=0){s.beginPath(),s.arc(c,o,B,0,Math.PI*2),s.strokeStyle="#ccd0d5",s.lineWidth=10,s.setLineDash([6,6]),s.stroke(),s.setLineDash([]),s.globalCompositeOperation="destination-out",s.beginPath(),s.arc(c,o,B*.55,0,Math.PI*2),s.fill(),s.globalCompositeOperation="source-over",s.fillStyle="#111",s.textAlign="center",s.textBaseline="middle",s.font="bold 20px system-ui, -apple-system, Segoe UI, Roboto, sans-serif",s.fillText(L==null?"—":L+"%",c,o),g&&(g.innerHTML='<div class="muted">Nessuna provvigione nel periodo</div>');return}var G=[{label:"Provv. GI",value:y,color:"#4F8EF7"},{label:"Provv. VSD",value:Y,color:"#F79F4F"}],W=-Math.PI/2;G.forEach(function(v){var S=v.value/_*Math.PI*2;s.beginPath(),s.moveTo(c,o),s.arc(c,o,B,W,W+S),s.closePath(),s.fillStyle=v.color,s.fill(),W+=S}),s.globalCompositeOperation="destination-out",s.beginPath(),s.arc(c,o,B*.55,0,Math.PI*2),s.fill(),s.globalCompositeOperation="source-over",s.fillStyle="#111",s.textAlign="center",s.textBaseline="middle",s.font="bold 20px system-ui, -apple-system, Segoe UI, Roboto, sans-serif",s.fillText(L==null?"—":L+"%",c,o);var z=Math.round(y/_*100),e=Math.round(Y/_*100);g&&(g.innerHTML='<div class="row" style="gap:16px; flex-wrap:wrap"><div class="row" style="gap:8px; align-items:center"><span style="display:inline-block;width:12px;height:12px;background:#4F8EF7;border-radius:3px"></span><span><b>Provv. GI</b> '+k(y)+" · "+z+'%</span></div><div class="row" style="gap:8px; align-items:center"><span style="display:inline-block;width:12px;height:12px;background:#F79F4F;border-radius:3px"></span><span><b>Provv. VSD</b> '+k(Y)+" · "+e+"%</span></div></div>")}function A(){var h=fe("comm"),b=n("comm_mode").value||"consuntivo",p=t?n("comm_user").value||"__all":String(ue().id),i=new Date(h.start).getTime(),g=new Date(h.end).getTime();ne("/api/periods").then(function(s){var F=s&&s.periods||[],r=F.filter(function(B){var y=new Date(B.startDate).getTime(),Y=new Date(B.endDate).getTime();return!(y<i||Y>g||t&&p!=="__all"&&String(B.userId||B.uid||"")!==String(p)||!t&&String(B.userId||B.uid||"")!==String(ue().id))}),c={gi:0,vsd:0,provv_gi:0,provv_vsd:0,provv_total:0},o={};r.forEach(function(B){var y=b==="previsionale"?B.indicatorsPrev||{}:B.indicatorsCons||{},Y=String(B.userId||B.uid||""),_=B.userName||B.name||"User "+Y,L=l(y.GI),G=l(y.VSDPersonale),W=l(y.ProvvGI),z=l(y.ProvvVSD),e=U(y);c.gi+=L,c.vsd+=G,c.provv_gi+=W,c.provv_vsd+=z,c.provv_total+=e,o[Y]||(o[Y]={userId:Y,name:_,gi:0,vsd:0,provv_gi:0,provv_vsd:0,provv_total:0}),o[Y].gi+=L,o[Y].vsd+=G,o[Y].provv_gi+=W,o[Y].provv_vsd+=z,o[Y].provv_total+=e}),n("comm_total").innerHTML=P(c),n("comm_rows").innerHTML=x(Object.values(o).sort(function(B,y){return(y.provv_total||0)-(B.provv_total||0)})),te(c.provv_gi||0,c.provv_vsd||0,c.gi||0)}).catch(function(s){logger.error(s),K("Errore nel caricamento dati")})}function R(){t&&ne("/api/usernames").then(function(h){var b=n("comm_user");if(b){for(var p='<option value="__all">Tutta la squadra</option>',i=h&&h.users||[],g=0;g<i.length;g++){var s=i[g];p+='<option value="'+s.id+'">'+ce(s.name||"User "+s.id)+"</option>"}b.innerHTML=p}})}ye("comm",function(){A()}),n("comm_mode").onchange=function(){haptic("light"),A()},t&&(n("comm_user").onchange=function(){haptic("light"),A()}),R(),A()}function vt(){if(!ue())return a();document.title="Battle Plan – GI & Scadenzario",d.innerHTML=De()+'\n  <div class="wrap">\n\n    <div class="card">\n      <b>Filtro</b>\n      <div class="row" style="margin-top:6px;align-items:flex-end;gap:16px;flex-wrap:wrap">\n        <div>\n          <label>Consulente</label>\n          <select id="gi_cons"><option value="">Tutti</option></select>\n        </div>\n      </div>\n      '.concat(j("gi"),'\n    </div>\n\n    <div class="card">\n      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">\n        <b>Vendite (GI)</b>\n        <button class="ghost" id="gi_add">Nuova vendita</button>\n      </div>\n      <div class="table" style="overflow:auto">\n        <table class="simple" style="min-width:980px">\n          <thead>\n            <tr>\n              <th>Data vendita</th>\n              <th>Cliente</th>\n              <th>Consulente</th>\n              <th>Servizi</th>\n              <th style="text-align:right">Tot. VSS</th>\n              <th>Piano pagamenti</th>\n              <th></th>\n            </tr>\n          </thead>\n          <tbody id="gi_rows"></tbody>\n        </table>\n      </div>\n    </div>\n\n  </div>'),he();const t=p=>document.getElementById(p),n=p=>String(p||"").replace(/[&<>'"]/g,i=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[i]),k=p=>(Number(p)||0).toLocaleString("it-IT")+"€",l=p=>{const i=new Date(p);return i.getFullYear()+"-"+("0"+(i.getMonth()+1)).slice(-2)+"-"+("0"+i.getDate()).slice(-2)};function U(){const p=window.readUnifiedRange&&window.readUnifiedRange("gi")||{};if(!p||!p.start||!p.end){const i=new Date,g=new Date(i.getFullYear(),0,1),s=new Date(i.getFullYear(),11,31,23,59,59);return{from:l(g),to:l(s)}}return{from:l(p.start),to:l(p.end)}}let w=[];function P(){return ne("/api/clients").then(p=>(w=p&&p.clients||[],ne("/api/usernames"))).then(p=>{const i=p&&p.users||[],g=t("gi_cons");g&&(g.innerHTML='<option value="">Tutti</option>'+i.map(s=>'<option value="'+n(String(s.id))+'">'+n(s.name)+"</option>").join(""))})}function x(p){const i=Array.isArray(p.schedule)?p.schedule.slice():[];if(!i.length)return'<span class="muted">—</span>';const g=i.find(o=>o.kind==="deposit"||/acconto/i.test(o.note||"")),s=i.filter(o=>o!==g),F=g?"Acconto: "+k(g.amount):"";if(!s.length)return F||'<span class="muted">—</span>';const r=Math.round(s[0].amount||0),c=s.every(o=>Math.abs(Math.round(o.amount||0)-r)<=1);return(F?F+" + ":"")+(c?s.length+" rate da "+k(r):"piano personalizzato")}function te(p){return'<tr data-id="'+n(String(p.id))+'"><td>'+new Date(p.date||p.createdAt).toLocaleDateString("it-IT")+"</td><td>"+n(p.clientName||"")+"</td><td>"+n(p.consultantName||"")+"</td><td>"+n(p.services||"")+'</td><td style="text-align:right"><b>'+k(p.vssTotal||0)+"</b></td><td>"+x(p)+'</td><td class="right"><button class="ghost" data-edit="'+n(String(p.id))+'">Modifica</button></td></tr>'}function A(){const p=U(),i=(t("gi_cons")||{}).value||"",g="?from="+encodeURIComponent(p.from)+"&to="+encodeURIComponent(p.to)+(i?"&userId="+encodeURIComponent(i):"");ne("/api/gi"+g).then(s=>{let F=s&&s.sales||[];F.sort((r,c)=>+new Date(c.date||c.createdAt||0)-+new Date(r.date||r.createdAt||0)),t("gi_rows").innerHTML=F.length?F.map(te).join(""):'<tr><td colspan="7" class="muted">Nessuna vendita</td></tr>',h()}).catch(s=>{logger.error(s),K("Errore caricamento GI")})}function R(p){const i=p.sale||{},g=Array.isArray(i.schedule)?i.schedule.slice():[],s=g.find(E=>E.kind==="deposit"||/acconto/i.test(E.note||"")),F=g.filter(E=>E!==s),r=F.length>0?F.every(E=>Math.abs((+E.amount||0)-(+F[0].amount||0))<=1):!0,c=F.length&&r?"rate":"manual",o=l(new Date),B='<div class="modal"><div class="card gi-modal"><style>.gi-modal{min-width:min(760px,96vw);max-width:980px;max-height:86vh;overflow:auto}@media (max-width:740px){ .gi-grid{display:block} .gi-col{width:100%} .gi-modal{min-width:96vw} }.gi-grid{display:flex; gap:12px; flex-wrap:wrap} .gi-col{flex:1; min-width:240px}.gi-section{border-top:1px solid var(--hair, rgba(0,0,0,.12)); padding-top:10px; margin-top:10px}.pilltabs{display:flex; gap:12px; align-items:center} .pilltabs label{display:flex; align-items:center; gap:6px; cursor:pointer}.mrow{display:flex; gap:8px; align-items:center; flex-wrap:wrap}.mini input[type=number]{width:120px}.gi-rlist{margin-top:6px; max-height:200px; overflow:auto; border:1px dashed rgba(0,0,0,.15); border-radius:8px; padding:6px}.gi-r{display:flex; gap:6px; align-items:center; padding:4px 0}.gi-foot{display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:12px}</style><div style="display:flex;justify-content:space-between;align-items:center"><b>'+(p.title||(i.id?"Modifica vendita":"Nuova vendita"))+'</b><button class="ghost" id="m_close">Chiudi</button></div><div class="gi-grid"><div class="gi-col"><label>Data</label><input id="m_date" type="date" value="'+n(l(i.date||o))+'"></div><div class="gi-col"><label>Cliente</label><select id="gi_client_select"><option value="">Caricamento…</option></select></div><div class="gi-col"><label>Totale VSS</label><input id="m_vss" type="number" step="1" value="'+n(Number(i.vssTotal||0))+'"></div></div><div class="gi-section"><label>Servizi</label><textarea id="m_srv" rows="2">'+n(i.services||"")+'</textarea></div><div class="gi-section"><b>Acconto</b><div class="mrow mini" style="margin-top:6px"><label><input id="acc_enable" type="checkbox" '+(s?"checked":"")+'> Abilita</label><label>Tipo</label><select id="acc_type"><option value="abs">Valore assoluto</option><option value="perc">Percentuale</option></select><label>Valore</label><input id="acc_value" type="number" step="1" value="'+(s?n(Number(s._fromPerc?s._rawPerc:s.amount)):"0")+'"><label>Scadenza</label><input id="acc_date" type="date" value="'+n(l(s?s.dueDate:i.date||o))+'"><label>Nota</label><input id="acc_note" placeholder="es. Acconto" value="'+n(s&&s.note||"Acconto")+'"></div></div><div class="gi-section"><b>Modalità pagamenti</b><div class="pilltabs" style="margin:6px 0 8px"><label><input type="radio" name="pmode" value="rate" '+(c==="rate"?"checked":"")+'> Rateale</label><label><input type="radio" name="pmode" value="manual" '+(c!=="rate"?"checked":"")+'> Scaglioni manuali</label></div><div id="p_rate" style="display:'+(c==="rate"?"block":"none")+'"><div class="mrow mini"><label>N° rate</label><input id="rt_n" type="number" value="'+n(F.length||12)+'"><label>Frequenza</label><select id="rt_freq"><option value="M">Mensile</option><option value="Q">Trimestrale</option><option value="W">Settimanale</option><option value="Y">Annuale</option></select><label>Prima scadenza</label><input id="rt_first" type="date" value="'+n(F[0]?l(F[0].dueDate):l(i.date||o))+'"><button class="ghost" id="rt_build">Ricalcola rate</button></div><div id="rt_preview" class="gi-rlist muted small">—</div></div><div id="p_manual" style="display:'+(c!=="rate"?"block":"none")+'"><div class="mrow mini"><button class="ghost" id="mn_add">Aggiungi scaglione</button></div><div id="mn_list" class="gi-rlist"></div></div></div><div class="gi-foot"><div><div id="tot_prog" class="small muted">Programmato: 0€</div><div id="tot_chk"  class="small muted">Totale VSS: 0€</div></div><div style="display:flex;gap:8px">'+(i.id?'<button class="ghost danger" id="m_del">Elimina</button>':"")+'<button id="m_save">Salva</button></div></div></div></div>';showOverlay(B);const y=document.documentElement.style.overflow;document.documentElement.style.overflow="hidden";function Y(){document.documentElement.style.overflow=y,hideOverlay()}(function(){const O=t("gi_client_select");O.innerHTML='<option value="">— seleziona cliente —</option>'+w.map(Z=>'<option value="'+n(Z.id)+'">'+n(Z.name)+"</option>").join("");const H=i.clientId||i.client_id||"";if(H&&(O.value=String(H)),!O.value&&i.clientName){const Z=w.find(oe=>String(oe.name).trim().toLowerCase()===String(i.clientName).trim().toLowerCase());Z&&(O.value=String(Z.id))}})(),s&&s._fromPerc&&(t("acc_type").value="perc"),Array.from(document.querySelectorAll('input[name="pmode"]')).forEach(E=>{E.addEventListener("change",()=>{const O=document.querySelector('input[name="pmode"]:checked').value==="rate";t("p_rate").style.display=O?"block":"none",t("p_manual").style.display=O?"none":"block",C()})});function _(E,O){const H=new Date(E);return H.setMonth(H.getMonth()+O),H}function L(E,O){const H=new Date(E);return H.setDate(H.getDate()+O*7),H}function G(E,O){const H=new Date(E);return H.setMonth(H.getMonth()+O*3),H}function W(E,O){const H=new Date(E);return H.setFullYear(H.getFullYear()+O),H}function z(){const E=Math.max(1,Number(t("rt_n").value||0)),O=t("rt_freq").value,H=new Date(t("rt_first").value||o),Z=Math.max(0,Number(t("m_vss").value||0)),oe=S(),ie=Math.max(0,Z-oe),u=Math.round(ie/E),N=[];for(let q=0;q<E;q++){let I;O==="M"?I=_(H,q):O==="Q"?I=G(H,q):O==="W"?I=L(H,q):I=W(H,q),N.push({dueDate:I.toISOString(),amount:u,note:"Rata "+(q+1)+"/"+E,kind:"installment"})}return e(N),N}function e(E){t("rt_preview").innerHTML=E.map(O=>"<div>"+new Date(O.dueDate).toLocaleDateString("it-IT")+" · "+k(O.amount)+' <span class="muted">'+n(O.note||"")+"</span></div>").join(""),t("rt_preview")._data=E,C()}function v(E){const O=t("mn_list");O.innerHTML="",E.forEach((H,Z)=>{const oe=document.createElement("div");oe.className="gi-r",oe.innerHTML='<input type="date" data-k="dueDate" value="'+n(l(H.dueDate))+'"><input type="number" step="1" data-k="amount" value="'+n(Number(H.amount||0))+'" style="width:120px"><input type="text" data-k="note"   value="'+n(H.note||"")+'" placeholder="nota" style="flex:1"><button class="ghost" data-del="'+Z+'">✕</button>',O.appendChild(oe)}),O.querySelectorAll("[data-del]").forEach(H=>{H.onclick=()=>{const Z=Number(H.getAttribute("data-del")),oe=O._data||[];oe.splice(Z,1),v(oe)}}),O.oninput=()=>{const H=O._data||[];Array.from(O.children).forEach((oe,ie)=>{const u=H[ie];if(!u)return;const N=oe.querySelector('[data-k="dueDate"]').value,q=Number(oe.querySelector('[data-k="amount"]').value||0),I=oe.querySelector('[data-k="note"]').value;u.dueDate=new Date(N).toISOString(),u.amount=Math.round(q),u.note=I}),C()},O._data=E,C()}if(t("m_date").value=n(l(i.date||o)),t("m_vss").value=n(Number(i.vssTotal||0)),t("m_srv").value=n(i.services||""),t("acc_type").value=s&&s._fromPerc?"perc":"abs",t("acc_value").value=s?s._fromPerc?s._rawPerc:s.amount:0,t("acc_date").value=n(l(s?s.dueDate:i.date||o)),t("acc_note").value=s?n(s.note||"Acconto"):"Acconto",c==="rate"){const E=F.length||12;t("rt_n").value=E,t("rt_first").value=F[0]?n(l(F[0].dueDate)):n(l(i.date||o)),e(F.length?F:z())}else v(F);t("rt_build").onclick=()=>e(z()),t("mn_add").onclick=()=>{const O=t("mn_list")._data||[];O.push({dueDate:new Date().toISOString(),amount:0,note:"",kind:"manual"}),v(O)},t("m_close").onclick=Y;function S(){if(!t("acc_enable").checked)return 0;const E=Math.max(0,Number(t("m_vss").value||0)),O=t("acc_type").value,H=Number(t("acc_value").value||0);return Math.round(O==="perc"?E*(H/100):H)}function V(){const E=[];if(t("acc_enable").checked){const H=S();E.push({dueDate:new Date(t("acc_date").value||o).toISOString(),amount:H,note:t("acc_note").value||"Acconto",kind:"deposit",_fromPerc:t("acc_type").value==="perc",_rawPerc:Number(t("acc_value").value||0)})}if(document.querySelector('input[name="pmode"]:checked').value==="rate"){const H=(t("rt_preview")._data||[]).map(Z=>Object.assign({},Z));return E.concat(H)}else{const H=(t("mn_list")._data||[]).map(Z=>Object.assign({kind:"manual"},Z));return E.concat(H)}}function C(){const E=Math.max(0,Number(t("m_vss").value||0)),O=V(),H=Math.round(O.reduce((Z,oe)=>Z+Number(oe.amount||0),0));t("tot_prog").textContent="Programmato: "+k(H),t("tot_chk").textContent="Totale VSS: "+k(E)+(H===E?" OK":" (manca "+k(E-H)+")"),t("m_save").disabled=H!==E||!t("gi_client_select").value}if(["m_vss","acc_enable","acc_type","acc_value","acc_date","rt_n","rt_freq","rt_first"].forEach(E=>{const O=t(E);O&&O.addEventListener("input",C)}),t("gi_client_select").addEventListener("change",C),C(),t("m_save").onclick=()=>{const E=t("gi_client_select").value||"",O=w.find(Z=>String(Z.id)===String(E));if(!O){K("Seleziona un cliente");return}const H={id:i.id||void 0,date:new Date(t("m_date").value||o).toISOString(),clientId:O.id,clientName:O.name,vssTotal:Math.round(Number(t("m_vss").value||0)),services:t("m_srv").value||"",schedule:V()};Promise.resolve(Ie("/api/gi",H)).then(()=>{Y(),haptic("light"),A()}).catch(Z=>{logger.error(Z),K("Errore salvataggio")})},i.id){const E=t("m_del");E&&(E.onclick=async()=>{if(confirm("Eliminare definitivamente questa vendita?"))try{await Ie("/api/gi/delete",{id:i.id}).catch(()=>Ie("/api/gi",{id:i.id,_delete:1})),Y(),K("Vendita eliminata"),A()}catch(O){logger.error(O),K("Errore eliminazione")}})}}function h(){document.querySelectorAll("[data-edit]").forEach(p=>{p.addEventListener("click",()=>{const i=p.getAttribute("data-edit");b(i)})})}document.addEventListener("gi:edit",function(p){const i=p&&p.detail&&p.detail.id;i&&b(i)}),t("gi_add").onclick=()=>{R({title:"Nuova vendita"})};function b(p){ne("/api/gi?from=1900-01-01&to=2999-12-31").then(i=>{const g=(i&&i.sales||[]).find(s=>String(s.id)===String(p));if(!g){K("Vendita non trovata");return}R({title:"Modifica vendita",sale:g})})}ye("gi",()=>{haptic("light"),A()}),(t("gi_cons")||{}).onchange=()=>{haptic("light"),A()},P().then(A)}window.viewGI=window.viewGI||vt;function mt(){if(!ue())return a();document.title="Battle Plan – Report",d.innerHTML=De()+'<div class="wrap"><div class="card"><b>Sezioni da includere</b><div id="rep_toggles" class="row" style="margin-top:8px; gap:8px; flex-wrap:wrap"><button class="pill" data-type="mensile" id="tog_mese">Mese</button><button class="pill" data-type="trimestrale" id="tog_trimestre">Trimestre</button><button class="pill" data-type="semestrale" id="tog_semestre">Semestre</button><button class="pill" data-type="annuale" id="tog_anno">Anno</button></div></div><div class="card"><b>Report</b><div class="row" style="margin-top:8px"><div style="min-width:320px"><label>Oggetto email</label><input id="report_subject" placeholder="Report BP"></div></div><div class="row" style="margin-top:8px; flex-wrap:wrap"><div style="flex:1 1 100%; min-width:0"><label>Corpo email</label><textarea id="report_body" rows="12" placeholder="Testo del report…" style="width:100%; box-sizing:border-box; overflow:auto; resize:vertical; max-height:70vh; white-space:pre-wrap; word-break:break-word"></textarea></div></div><div class="row" id="report-actions" style="gap:8px;margin-top:8px;flex-wrap:wrap"><button class="ghost" id="rep_copy">Copia report</button><span style="flex:0 0 8px"></span><button class="ghost" id="rep_gmail_web">Gmail Web</button><button class="ghost" id="rep_gmail_app">Gmail App</button></div></div></div>',he();var t=[],n={mensile:!1,trimestrale:!1,semestrale:!1,annuale:!1},k=[{k:"VSS",money:!0,label:"VSS"},{k:"VSDPersonale",money:!0,label:"VSDPersonale"},{k:"VSDIndiretto",money:!0,label:"VSDIndiretto"},{k:"GI",money:!0,label:"GI"},{k:"Telefonate",money:!1,label:"Telefonate"},{k:"AppFissati",money:!1,label:"AppFissati"},{k:"AppFatti",money:!1,label:"AppFatti"},{k:"CorsiLeadership",money:!1,label:"CorsiLeadership"},{k:"iProfile",money:!1,label:"iProfile"},{k:"MBS",money:!1,label:"MBS"},{k:"NNCF",money:!1,label:"NNCF"}];function l(u){return document.getElementById(u)}var U=l("report_body");function w(u,N){var q=new Date(u.getTime());return q.setDate(q.getDate()+N),q}function P(u){return Me(u.getFullYear(),ge(u))}function x(u){var N=P(u);return P(w(N.start,7))}function te(u){var N=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];return N[u.getMonth()]}function A(u){return Math.floor(u.getMonth()/3)+1}function R(u){return u.getMonth()<6?1:2}function h(u){var N=u.getDay();return N===5||N===6||N===0}function b(u,N){return u==="mensile"?{start:Je(N),end:Ke(N)}:u==="trimestrale"?{start:ze(N),end:Ze(N)}:u==="semestrale"?{start:je(N),end:Qe(N)}:{start:tt(N),end:qe(N)}}function p(u,N){return N>=w(u,-7)&&N<=w(u,5)}function i(u,N){var q=b(u,N),I=b(u,w(q.start,-1)),X=b(u,w(q.end,1)),ee=p(I.end,N),ae=p(q.end,N);return ee&&!ae?{closing:I,next:q}:{closing:q,next:X}}function g(u,N,q){for(var I=0;I<t.length;I++){var X=t[I];if(X.type===u&&Pe(X.startDate)===Pe(N)&&Pe(X.endDate)===Pe(q))return X}return null}function s(u,N){var q=u&&u[N];return Number(q||0)}function F(u){return Ce(u)+"€"}function r(u,N){var q=k.some(function(I){return I.k===u&&I.money});return q?F(N):Ce(N)}function c(u,N){return u>N?"↑":u<N?"↓":"="}function o(u,N,q,I){var X=g(N,q,I)||{},ee=X.indicatorsPrev||{},ae=X.indicatorsCons||{},se=[u,""];return k.forEach(function(le){var Se=s(ee,le.k),we=s(ae,le.k);se.push(le.label+" "+r(le.k,we)+" vs "+r(le.k,Se)+" di previsionali ("+c(we,Se)+")")}),se.push("Note:"),se.join("\n")}function B(u,N,q,I){var X=g(N,q,I)||{},ee=X.indicatorsPrev||{},ae=[u,""];return k.forEach(function(se){ae.push(se.label+" "+r(se.k,s(ee,se.k)))}),ae.push("Possibili note:"),ae.join("\n")}function y(u){return"BP CONSUNTIVO SETT. "+ge(u)+" "+u.getFullYear()}function Y(u){return"BP PREVISIONALE SETT. "+ge(u)+" "+u.getFullYear()}function _(u){return"BP CONSUNTIVO "+te(u)+" "+u.getFullYear()}function L(u){var N=te(u);return"BP PREVISIONALE "+N+" "+u.getFullYear()}function G(u){return"BP CONSUNTIVO T"+A(u)+" "+u.getFullYear()}function W(u){return"BP PREVISIONALE T"+A(u)+" "+u.getFullYear()}function z(u){return"BP CONSUNTIVO S"+R(u)+" "+u.getFullYear()}function e(u){return"BP PREVISIONALE S"+R(u)+" "+u.getFullYear()}function v(u){return"BP CONSUNTIVO "+u.getFullYear()}function S(u){return"BP PREVISIONALE "+u.getFullYear()}function V(){var u=new Date,N=[];if(h(u)){var q=P(u),I=x(u);N.push(o(y(q.start),"settimanale",q.start,q.end)),N.push(B(Y(I.start),"settimanale",I.start,I.end))}function X(ee,ae,se){var le=i(ee,u);N.push(o(ae(le.closing.start),ee,le.closing.start,le.closing.end)),N.push(B(se(le.next.start),ee,le.next.start,le.next.end))}n.mensile&&X("mensile",_,L),n.trimestrale&&X("trimestrale",G,W),n.semestrale&&X("semestrale",z,e),n.annuale&&X("annuale",v,S),U.value=N.join("\n\n")+(N.length?"\n":"")}function C(u,N){u.classList.toggle("active",!!N),u.style.opacity=N?"1":"0.65"}function E(){C(l("tog_mese"),n.mensile),C(l("tog_trimestre"),n.trimestrale),C(l("tog_semestre"),n.semestrale),C(l("tog_anno"),n.annuale)}function O(){var u=new Date;function N(q){var I=b(q,u),X=b(q,w(I.start,-1));return p(I.end,u)||p(X.end,u)}n.mensile=N("mensile"),n.trimestrale=N("trimestrale"),n.semestrale=N("semestrale"),n.annuale=N("annuale"),E()}function H(){function u(N){var q=N.currentTarget.getAttribute("data-type");n[q]=!n[q],E(),V()}l("tog_mese").onclick=u,l("tog_trimestre").onclick=u,l("tog_semestre").onclick=u,l("tog_anno").onclick=u}function Z(u){return encodeURIComponent(String(u||""))}function oe(){var u=l("rep_gmail_web"),N=l("rep_gmail_app"),q=l("rep_copy");q&&(q.onclick=function(){try{navigator.clipboard.writeText(U.value||"");var I=q.textContent;q.textContent="Copiato!",setTimeout(function(){q.textContent=I},1200)}catch(X){}}),!(!u||!N)&&ne("/api/users_emails").then(function(I){var X=(I&&I.emails||(I&&I.users||[]).map(function(se){return se.email})).filter(Boolean).join(",");function ee(){return l("report_subject").value||"Report BP"}function ae(){return U.value||""}u.onclick=function(){try{navigator.clipboard.writeText(ae())}catch(le){}var se="https://mail.google.com/mail/?view=cm&fs=1&tf=1&su="+Z(ee())+"&cc="+Z(X)+"&body="+Z(ae());window.open(se,"_blank"),document.dispatchEvent(new Event("report:composed"))},N.onclick=function(){try{navigator.clipboard.writeText(ae())}catch(le){}var se="googlegmail:///co?subject="+Z(ee())+"&cc="+Z(X)+"&body="+Z(ae());location.href=se,document.dispatchEvent(new Event("report:composed")),setTimeout(function(){document.hidden||(location.href="mailto:?subject="+Z(ee())+"&cc="+Z(X)+"&body="+Z(ae()),document.dispatchEvent(new Event("report:composed")))},1200)}})}function ie(){ne("/api/periods").then(function(u){t=u&&u.periods||[],O(),H(),V(),oe()})}ie()}function pt(){var t=ue();if(!t)return a();if(document.title="Battle Plan – Utenti",t.role!=="admin"){d.innerHTML=De()+'<div class="wrap"><div class="card"><b>Il mio profilo</b><div class="row" style="margin-top:8px"><div><label>Nome</label><input id="p_name" type="text" value="'+ce(t.name||"")+'"></div><div><label>Email</label><input id="p_email" type="email" value="'+ce(t.email||"")+'"></div></div><div class="row"><div><label>Nuova password</label><input id="p_pwd" type="password" placeholder="Lascia vuoto per non cambiare"></div><div class="right" style="align-self:flex-end"><button id="p_save">Aggiorna</button></div></div><div class="row"><div><label>Ruolo</label><input value="'+ce(t.role||"consultant")+'" disabled></div><div><label>Grade</label><input value="'+ce(t.grade||"junior")+'" disabled></div></div></div></div>',he(),Ee("#p_save").onclick=function(){var l=Ee("#p_name").value.trim(),U=Ee("#p_email").value.trim(),w=Ee("#p_pwd").value,P={id:t.id,name:l,email:U};w&&(P.password=w),Ie("/api/users",P).then(function(){K("Profilo aggiornato"),addXP(3);var x=ue();x&&(x.name=l,x.email=U,localStorage.setItem("user",JSON.stringify(x)))}).catch(function(x){logger.error(x),K("Errore aggiornamento")})};return}d.innerHTML=De()+'<div class="wrap"><div class="card"><b>Gestione utenti</b><div id="users_list" class="row" style="margin-top:8px"></div></div></div>',he();function n(l){var U=ce(l.name||l.email||"user_"+l.id),w=l.grade==="senior"?"senior":"junior",P=l.role==="admin"?"admin":"consultant";return'<div class="card" style="flex:1 1 380px"><div><b>'+U+'</b> <span class="small muted">('+ce(P)+')</span></div><div class="row" style="margin-top:6px"><div><label>Nome</label><input data-nfor="'+l.id+'" type="text" value="'+ce(l.name||"")+'"></div><div><label>Email</label><input data-efor="'+l.id+'" type="email" value="'+ce(l.email||"")+'"></div></div><div class="row"><div><label>Nuova password</label><input data-pfor="'+l.id+'" type="password" placeholder="(opzionale)"></div><div><label>Grade</label><select data-gfor="'+l.id+'"><option value="junior"'+(w==="junior"?" selected":"")+'>Junior</option><option value="senior"'+(w==="senior"?" selected":"")+'>Senior</option></select></div><div><label>Ruolo</label><select data-rfor="'+l.id+'"><option value="consultant"'+(P==="consultant"?" selected":"")+'>Consulente</option><option value="admin"'+(P==="admin"?" selected":"")+'>Admin</option></select></div><div class="right" style="align-self:flex-end"><button class="ghost" data-save="'+l.id+'">Aggiorna</button></div></div></div>'}function k(){ne("/api/users").then(function(l){var U=l&&l.users||[],w=Ee("#users_list");w&&(w.innerHTML=U.map(n).join(""),ot("[data-save]").forEach(function(P){P.addEventListener("click",function(){var x=P.getAttribute("data-save"),te=(Ee('input[data-nfor="'+x+'"]')||{}).value||"",A=(Ee('input[data-efor="'+x+'"]')||{}).value||"",R=(Ee('select[data-gfor="'+x+'"]')||{}).value||"junior",h=(Ee('select[data-rfor="'+x+'"]')||{}).value||"consultant",b=Ee('input[data-pfor="'+x+'"]'),p=b?b.value:"",i={id:x,name:te,email:A,grade:R,role:h};p&&(i.password=p),Ie("/api/users",i).then(function(){K("Aggiornato"),addXP(5),b&&(b.value="")}).catch(function(g){logger.error(g),K("Errore aggiornamento")})})}))})}k()}window.viewHome=$e,window.viewCalendar=lt,window.viewPeriods=nt,window.viewAppointments=Fe,window.viewLeaderboard=st,window.viewClients=dt,window.viewTeam=ct,window.viewCommissions=ut,window.viewReport=mt,window.viewUsers=pt,window.toggleDrawer=We,window.logout=Nt,window.rerenderTopbarSoon=$t,document.addEventListener("DOMContentLoaded",function(){ue()?(he(),$e()):a()})})();export{Xt as __vite_legacy_guard};
