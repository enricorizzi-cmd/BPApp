function nn(){import.meta.url,import("_").catch(()=>1),(async function*(){})().next()}(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const j of document.querySelectorAll('link[rel="modulepreload"]'))Z(j);new MutationObserver(j=>{for(const W of j)if(W.type==="childList")for(const ee of W.addedNodes)ee.tagName==="LINK"&&ee.rel==="modulepreload"&&Z(ee)}).observe(document,{childList:!0,subtree:!0});function D(j){const W={};return j.integrity&&(W.integrity=j.integrity),j.referrerPolicy&&(W.referrerPolicy=j.referrerPolicy),j.crossOrigin==="use-credentials"?W.credentials="include":j.crossOrigin==="anonymous"?W.credentials="omit":W.credentials="same-origin",W}function Z(j){if(j.ep)return;j.ep=!0;const W=D(j);fetch(j.href,W)}})();function Ft(p){return p?(p=String(p).toLowerCase(),p==="ytd"||p==="ltm"?"mensile":p):""}function Ut(p){var s=new Date(Date.UTC(p.getFullYear(),p.getMonth(),p.getDate())),D=s.getUTCDay()||7;s.setUTCDate(s.getUTCDate()+4-D);var Z=new Date(Date.UTC(s.getUTCFullYear(),0,1));return Math.ceil(((s-Z)/864e5+1)/7)}typeof window<"u"&&(typeof window.effectivePeriodType!="function"&&(window.effectivePeriodType=Ft),typeof window.isoWeekNum!="function"&&(window.isoWeekNum=Ut));(function(){const p=window.fetch.bind(window);function s(){try{const Z=JSON.parse(localStorage.getItem("user")||"{}");if(Z&&(Z.token||Z.jwt||Z.accessToken))return Z.token||Z.jwt||Z.accessToken}catch(Z){}const D=["token","authToken","jwt","bp_token","accessToken","id_token"];for(const Z of D){let j=localStorage.getItem(Z)||sessionStorage.getItem(Z);if(j){try{const W=JSON.parse(j);if(W&&(W.token||W.jwt||W.accessToken))return W.token||W.jwt||W.accessToken}catch(W){}if(j=String(j).replace(/^"+|"+$/g,""),/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+$/.test(j))return j}}return null}window.fetch=function(D,Z){const j=typeof D=="string"?D:D&&D.url||"";if(!(typeof j=="string"&&(j.startsWith("/api/")||j.startsWith(location.origin+"/api/"))))return p(D,Z);const ee=s(),te=Object.assign({},Z);return te.headers=new Headers(te&&te.headers||{}),ee&&!te.headers.has("Authorization")&&te.headers.set("Authorization","Bearer "+ee),p(D,te)}})();(function(){function p(){const j=te=>String(te).replace(/^"+|"+$/g,""),W=te=>/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+$/.test(te||""),ee=["token","authToken","jwt","bp_token","accessToken","id_token"];for(const te of ee){let F=localStorage.getItem(te)||sessionStorage.getItem(te);if(F){try{const ie=JSON.parse(F);if(ie&&(ie.token||ie.jwt||ie.accessToken))return ie.token||ie.jwt||ie.accessToken}catch(ie){}if(F=j(F),W(F))return F}}try{const te=JSON.parse(localStorage.getItem("user")||"{}");if(te&&(te.token||te.jwt||te.accessToken))return te.token||te.jwt||te.accessToken}catch(te){}return null}typeof window.users>"u"&&(window.users=[]),(async function j(){try{if(window.GET){const te=await window.GET("/api/usernames");te&&Array.isArray(te.users)&&(window.users=te.users);return}const W=p(),ee=await fetch("/api/usernames",{headers:{Accept:"application/json",...W?{Authorization:"Bearer "+W}:{}}});if(ee.status===401){setTimeout(j,800);return}if(ee.ok){const te=await ee.json();te&&Array.isArray(te.users)&&(window.users=te.users)}}catch(W){setTimeout(j,1200)}})();function s(j,W,ee){return new Date(Date.UTC(j,W,ee))}function D(j){return new Date(j.getTime()+24*3600*1e3-1)}function Z(j,W){return new Date(Date.UTC(j,W+1,0))}typeof window.buildBuckets!="function"&&(window.buildBuckets=function(j,W){var ee=String(j||"mensile").toLowerCase(),te=effectivePeriodType(ee),F=W?new Date(W):new Date,ie=F.getUTCFullYear(),ne=[];function ye(w,M){ne.push({s:w.getTime(),e:M.getTime()})}if(te==="settimanale"){var we=new Date(Date.UTC(F.getUTCFullYear(),F.getUTCMonth(),F.getUTCDate())),re=(we.getUTCDay()+6)%7;we.setUTCDate(we.getUTCDate()-re);for(var oe=52;oe>=0;oe--){var ve=new Date(we);ve.setUTCDate(we.getUTCDate()-oe*7);var de=new Date(ve);de.setUTCDate(ve.getUTCDate()+6),de.setUTCHours(23,59,59,999),ye(ve,de)}return ne}if(te==="mensile"){for(var Ce=new Date(Date.UTC(F.getUTCFullYear(),F.getUTCMonth(),1)),fe=23;fe>=0;fe--){var _e=new Date(Date.UTC(Ce.getUTCFullYear(),Ce.getUTCMonth()-fe,1));ye(_e,D(Z(_e.getUTCFullYear(),_e.getUTCMonth())))}return ne}if(te==="trimestrale"){for(var Ue=Math.floor(F.getUTCMonth()/3),f=11;f>=0;f--){var h=Ue-f,$=ie+Math.floor(h/4),_=(h%4+4)%4,ve=s($,_*3,1),de=D(new Date(Date.UTC($,_*3+3,0)));ye(ve,de)}return ne}if(te==="semestrale"){for(var z=F.getUTCMonth()<6?0:1,P=5;P>=0;P--){var C=z-P,g=ie+Math.floor(C/2),G=(C%2+2)%2,I=G===0?0:6,R=s(g,I,1),q=D(new Date(Date.UTC(g,I+6,0)));ye(R,q)}return ne}for(var B=2;B>=0;B--){var E=ie-B;ye(s(E,0,1),D(new Date(Date.UTC(E,12,0))))}return ne}),typeof window.labelsForBuckets!="function"&&(window.labelsForBuckets=function(j,W){var ee=effectivePeriodType(j||"mensile");return(W||[]).map(function(te){var F=new Date(te.s);return ee==="settimanale"?"W"+isoWeekNum(F):ee==="mensile"?String(F.getUTCMonth()+1).padStart(2,"0")+"/"+F.getUTCFullYear():ee==="trimestrale"?"Q"+(Math.floor(F.getUTCMonth()/3)+1)+" "+F.getUTCFullYear():ee==="semestrale"?(F.getUTCMonth()<6?"S1 ":"S2 ")+F.getUTCFullYear():String(F.getUTCFullYear())})}),typeof window.sumIndicator!="function"&&(window.sumIndicator=function(j,W,ee){var ie,ne;var te=String(W).toLowerCase()==="previsionale"?j.indicatorsPrev||{}:j.indicatorsCons||{};if(ee==="VSDTotale")return Number(te.VSDPersonale||0)+Number(te.VSDIndiretto||0);var F=Number((ne=(ie=te[ee])!=null?ie:te[ee.toUpperCase()])!=null?ne:0);return Number.isFinite(F)?F:0})})();(function(p){const s=["localhost","127.0.0.1"].includes(p.location.hostname),D=p.pino?p.pino({level:s?"debug":"info"}):console,Z={info:(...j)=>D.info?D.info(...j):console.log(...j),error:(...j)=>D.error?D.error(...j):console.error(...j),warn:(...j)=>D.warn?D.warn(...j):console.warn(...j),debug:(...j)=>D.debug?D.debug(...j):console.debug(...j)};p.logger=Z})(window);window.BP_PHRASES=(function(){const p=["Ottimo, {name}! 🎯","Ben fatto, {name}! 🙌","Avanti così, {name}! 🚀","Perfetto, {name}! 🤩","Bel colpo, {name}! 💥","Ci siamo, {name}! 👌","Grande {name}! 🧱","Pezzo dopo pezzo, {name}! 🧩","Molto bene, {name}! 👍","Stai andando bene, {name}! ➡️"],s=["Che figata, {name}! 🔥","Ma cosa dico grande… grandissimo, {name}! 💪","Super, {name}! ✨","Non ti ferma nessuno, {name}!! 🏎️","Stai andando alla grande, {name}! 📈","Gran progressione, {name}! ⏩","Il ritmo è giusto, {name}! 🥁","Questa spinge, {name}! 🧨","Bello tosto, {name}! 🛡️","Gran focus, {name}! 🎯"],D=["BOOM! {name}, questo è livello PRO! 🏆","Risultato pazzesco, {name}! 🤯","Clamoroso {name}, così si fa! ⚡","È ufficiale: {name} ON FIRE! 🔥🔥","Top di gamma, {name}! 🥇","Mostruoso upgrade, {name}! 🚀","Record personale in vista, {name}! 🧠","Spacchi tutto, {name}! 💣","Da incorniciare, {name}! 🖼️","Questo alza l’asticella, {name}! 📏"],Z={lite:p,mid:s,mega:D};return Z.standard=p,Z.rilevante=s,Z.grande=D,Z.pick=function(j,W){const ee=Z[j]||p,te=W||JSON.parse(localStorage.getItem("bp_user")||"{}").name||"campione";return(ee[Math.floor(Math.random()*ee.length)]||"Grande!").replace(/\{name\}/g,te)},Z.random=function(j){const W=[p,s,D],ee=W[Math.floor(Math.random()*W.length)];return Z.pick(ee===D?"mega":ee===s?"rilevante":"standard",j)},Z})();(function(){const p=window.BP=window.BP||{},s=p.Haptics=p.Haptics||{};function D(){const j=navigator.userAgent||navigator.vendor||"";return/android|iphone|ipad|ipod|mobile/i.test(j)}function Z(j){if(D()&&"vibrate"in navigator)try{switch(j){case"light":navigator.vibrate(12);break;case"heavy":navigator.vibrate([10,30,10]);break;default:navigator.vibrate(18);break}}catch(W){}}s.impact=Z})();(function(){const p=window.BP=window.BP||{},s=p.Undo=p.Undo||{},D=document.createElement("div");D.className="bp-undo-host",document.body.appendChild(D);const Z="\n  .bp-undo-host{\n    position: fixed; left:50%; transform: translateX(-50%);\n    bottom: 20px; z-index: 1201; display:flex; flex-direction:column; gap:8px;\n  }\n  .bp-undo{\n    min-width: 280px; max-width: 540px;\n    background: rgba(15,19,28,.95);\n    border:1px solid rgba(255,255,255,.18);\n    border-radius: 12px; padding: 10px 12px;\n    box-shadow: 0 10px 24px rgba(0,0,0,.35);\n    display:flex; align-items:center; gap:10px;\n    animation: bpUndoPop .16s ease-out;\n  }\n  .bp-undo .lbl{ font-weight:700; }\n  .bp-undo .spacer{ flex:1; }\n  .bp-undo button{ white-space:nowrap; }\n  @keyframes bpUndoPop{ from{ transform: translate(-50%, 4px); opacity:0 } to{ transform: translate(-50%, 0); opacity:1 } }\n  ",j=document.createElement("style");j.textContent=Z,document.head.appendChild(j);function W(ee){const te=document.createElement("div");te.className="bp-undo",te.innerHTML='\n      <div class="lbl">'.concat(ee&&ee.label||"Operazione eseguita",'</div>\n      <div class="spacer"></div>\n      <button type="button" class="ghost" data-undo>Annulla</button>\n    '),D.appendChild(te);let F=!1;const ie=setTimeout(()=>{F||(F=!0,te.remove())},ee&&ee.timeoutMs||5e3);te.querySelector("[data-undo]").addEventListener("click",()=>{if(!F){F=!0,clearTimeout(ie);try{ee&&ee.onUndo&&ee.onUndo()}catch(ne){}te.remove()}})}s.push=W})();(function(){const p=window.BP=window.BP||{},s=p.ClientsHelpers=p.ClientsHelpers||{};function D(ee){return String(ee||"").trim().toLowerCase()}function Z(ee){const te={};return(ee||[]).forEach(F=>{const ie=D(F.client);if(!ie)return;const ne=F.start||F.end;if(!ne)return;const ye=te[ie];(!ye||new Date(ne)>new Date(ye))&&(te[ie]=ne)}),te}function j(ee,te){const F=Z(te);return(ee||[]).map(ie=>{const ne=F[D(ie.name)]||null;return{...ie,lastAppointment:ne}})}function W(ee,{status:te,consultantId:F,consultantName:ie}){const ne=re=>String(re||"").trim().toLowerCase(),ye=re=>{const oe=ne(re).replace(/\s+/g,"_").replace(/-/g,"_");return oe==="lead_non_chiuso"||oe==="lead_non-chiuso"?"lead_non_chiuso":oe};let we=ee||[];if(te&&te!=="tutti"&&(we=we.filter(re=>ye(re.status)===ye(te))),F)we=we.filter(re=>(re.consultantId||"")===String(F));else if(ie){const re=ne(ie);we=we.filter(oe=>ne(oe.consultantName)===re)}return we}s.withLastAppointment=j,s.filter=W})();(function(){const p=window.BP=window.BP||{},s=p.Targets=p.Targets||{},D=["VSS","VSDPersonale","VSDIndiretto","GI"],Z=["NNCF","AppFatti","Telefonate"],j=D.concat(Z),W={senior:{VSS:3e4,VSDPersonale:15e3,VSDIndiretto:5e3,GI:15e3,NNCF:1,AppFatti:4,Telefonate:0},junior:{VSS:15e3,VSDPersonale:5e3,VSDIndiretto:5e3,GI:1e4,NNCF:4,AppFatti:30,Telefonate:300}};function ee(re,oe){const ve=Number(re||0),de=Number(oe||0);return de?Math.ceil(ve/de)*de:Math.ceil(ve)}function te(re){switch(String(re||"mensile").toLowerCase()){case"settimanale":return 1/4;case"mensile":return 1;case"trimestrale":return 3;case"semestrale":return 6;case"annuale":return 12;default:return 1}}function F(re){return D.indexOf(re)>=0}function ie(re){const oe=String(re||"junior").toLowerCase()==="senior"?"senior":"junior";return{...W[oe]}}function ne(re,oe){const ve=te(oe),de=ie(re),Ce={};for(const fe of j){const _e=Number(de[fe]||0)*ve;F(fe)?String(oe).toLowerCase()==="settimanale"?Ce[fe]=ee(_e,500):Ce[fe]=ee(_e,5e3):Ce[fe]=Math.ceil(_e)}return Ce}function ye(re,oe){const ve={};for(const de of j){const Ce=Number((re||{})[de]||0),fe=Number((oe||{})[de]||0),_e=Ce-fe,Ue=fe>0?Math.round(Ce/fe*100):Ce>0?100:0;ve[de]={value:Ce,target:fe,delta:_e,pct:Math.max(0,Ue)}}return ve}function we(re){const oe=[];for(const de of j){const Ce=(re||{})[de];Ce&&Ce.target>0&&oe.push(Number(Ce.pct||0))}if(!oe.length)return 0;const ve=oe.reduce((de,Ce)=>de+Ce,0)/oe.length;return Math.round(ve)}s.MONEY_KEYS=D,s.COUNT_KEYS=Z,s.ALL_KEYS=j,s.getMonthly=ie,s.getForPeriod=ne,s.compare=ye,s.summarize=we})();(function(){const p=window.BP=window.BP||{},s=p.ICS=p.ICS||{};function D(Z){try{logger.warn("[BP ICS bulk disabled] chiamata a:",Z)}catch(j){}}s.createCalendarForRange=function(){return D("createCalendarForRange()"),null},s.downloadForRange=function(){return D("downloadForRange()"),!1}})();(function(){const p=window.BP=window.BP||{},s=p.ClientStatus=p.ClientStatus||{},D="bp_banner_seen";function Z(){try{return JSON.parse(localStorage.getItem(D)||"{}")}catch(re){return{}}}function j(re){try{localStorage.setItem(D,JSON.stringify(re||{}))}catch(oe){}}function W(re){return!!Z()[re]}function ee(re){const oe=Z();oe[re]=!0,j(oe)}async function te(re){const oe=window.authToken||"",ve=await fetch(re,{headers:oe?{Authorization:"Bearer "+oe}:{}});if(!ve.ok)throw new Error("GET "+re+" failed");return ve.json()}async function F(re,oe){const ve=window.authToken||"",de=await fetch(re,{method:"POST",headers:{"Content-Type":"application/json",...ve?{Authorization:"Bearer "+ve}:{}},body:JSON.stringify(oe||{})});if(!de.ok)throw new Error("POST "+re+" failed");return de.json()}async function ie({clientId:re,status:oe}){if(!re)throw new Error("missing clientId");return F("/api/clients",{id:re,status:String(oe||"")})}s.setClientStatusByName=ne;async function ne({clientName:re,status:oe}){const ve=String(re||"").trim();if(!ve)throw new Error("missing clientName");const Ce=((await te("/api/clients")).clients||[]).find(Ue=>String(Ue.name||"").toLowerCase()===ve.toLowerCase());if(Ce)return ie({clientId:Ce.id,status:oe});await F("/api/clients",{name:ve});const _e=((await te("/api/clients")).clients||[]).find(Ue=>String(Ue.name||"").toLowerCase()===ve.toLowerCase());if(!_e)throw new Error("client creation failed");return ie({clientId:_e.id,status:oe})}function ye({appointment:re,clientName:oe},ve){const de=re||{},Ce=oe||de.client||"Cliente",fe=document.createElement("div");return fe.className="bp-banner-client",fe.innerHTML='\n      <div class="bp-banner-inner">\n        <div class="bp-banner-title">È diventato cliente?</div>\n        <div class="bp-banner-sub">Appuntamento con <b>'.concat(we(Ce),'</b></div>\n        <div class="bp-banner-actions">\n          <button type="button" data-yes>Sì</button>\n          <button type="button" class="ghost" data-no>No</button>\n        </div>\n      </div>\n    '),fe.querySelector("[data-yes]").addEventListener("click",()=>ve&&ve(!0,de)),fe.querySelector("[data-no]").addEventListener("click",()=>ve&&ve(!1,de)),fe}function we(re){return String(re).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}(function(){if(document.getElementById("bp-clientstatus-css"))return;const oe="\n.bp-banner-client{\n  position: fixed; left:50%; transform:translateX(-50%);\n  top: 70px; z-index: 1200;\n  background: rgba(20,24,34,.95);\n  color: #fff;\n  border: 1px solid rgba(255,255,255,.18);\n  box-shadow: 0 10px 24px rgba(0,0,0,.35);\n  border-radius:14px; padding:10px; min-width:280px;\n  animation: bpBannerPop .18s ease-out;\n}\n.bp-banner-inner{ display:flex; flex-direction:column; gap:6px; }\n.bp-banner-title{ font-weight:800; }\n.bp-banner-sub{ font-size:12px; opacity:.92; }\n.bp-banner-actions{ display:flex; gap:8px; margin-top:6px; justify-content:flex-end; }\n@keyframes bpBannerPop{ from{ transform:translate(-50%, -6px); opacity:0 } to{ transform:translate(-50%, 0); opacity:1 } }\n",ve=document.createElement("style");ve.id="bp-clientstatus-css",ve.textContent=oe,document.head.appendChild(ve)})(),s.hasSeen=W,s.markSeen=ee,s.renderBecameClientBanner=ye,s.setClientStatus=ie,s.setClientStatusByName=ne})();(function(){function p(s){try{fetch("/api/client_error",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:location.href,info:{ua:navigator.userAgent},...s})})}catch(D){}}window.addEventListener("error",function(s){try{p({message:s.message,stack:s.error&&s.error.stack||null})}catch(D){}}),window.addEventListener("unhandledrejection",function(s){try{p({message:"unhandledrejection",stack:s.reason&&s.reason.stack||String(s.reason)})}catch(D){}})})();(function(){function p(s){return String(s||"event").normalize("NFKD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9._-]+/g,"_").replace(/^_+|_+$/g,"").slice(0,80)||"event"}if(window.saveICS&&!window.__icsSanitized){const s=window.saveICS;window.saveICS=function(D,Z){try{D=p(D)}catch(j){}return s(D,Z)},window.__icsSanitized=!0}window.__icsSanitize=p})();const Ee=window.BP&&BP.Haptics&&BP.Haptics.impact?BP.Haptics.impact:()=>{};(function(){window.bpAuthToken||(window.bpAuthToken=function(){try{const n=localStorage.getItem("bp_user")||sessionStorage.getItem("bp_user");if(n)try{const t=JSON.parse(n);if(t&&(t.token||t.jwt||t.accessToken))return t.token||t.jwt||t.accessToken}catch(t){}}catch(n){}const a=["bp_token","authToken","token","jwt","accessToken","id_token","auth","authorization","session","user"];for(const n of a)try{const t=localStorage.getItem(n)||sessionStorage.getItem(n);if(!t)continue;try{const e=JSON.parse(t);if(e&&(e.token||e.jwt||e.accessToken))return e.token||e.jwt||e.accessToken}catch(e){}if(/^[A-Za-z0-9\-_]+\.[A-Za-z0-9\-_]+\.[A-Za-z0-9\-_]+$/.test(t))return t}catch(t){}try{for(let n=0;n<localStorage.length;n++){const t=localStorage.key(n),e=localStorage.getItem(t);if(e){try{const o=JSON.parse(e);if(o&&(o.token||o.jwt||o.accessToken))return o.token||o.jwt||o.accessToken}catch(o){}if(/^[A-Za-z0-9\-_]+\.[A-Za-z0-9\-_]+\.[A-Za-z0-9\-_]+$/.test(e))return e}}}catch(n){}try{const n=JSON.parse(localStorage.getItem("user")||"{}");if(n&&(n.token||n.jwt||n.accessToken))return n.token||n.jwt||n.accessToken}catch(n){}return null}),window.GET||(window.GET=async function(a){const n=window.bpAuthToken&&window.bpAuthToken()||null,t=await fetch(a,{headers:{Accept:"application/json",...n?{Authorization:"Bearer "+n}:{}}});return t.status===204?null:(t.headers.get("content-type")||"").includes("application/json")?t.json():{ok:t.ok,status:t.status,text:await t.text()}}),window.POST||(window.POST=async function(a,n){const t=window.bpAuthToken&&window.bpAuthToken()||null,e=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json",...t?{Authorization:"Bearer "+t}:{}},body:JSON.stringify(n||{})});return e.status===204?null:(e.headers.get("content-type")||"").includes("application/json")?e.json():{ok:e.ok,status:e.status,text:await e.text()}}),typeof window<"u"&&typeof window.initPostSaleBanners=="function"&&window.initPostSaleBanners(Ee),(function(){if(document.getElementById("bp-qvss-css"))return;const n=document.createElement("style");n.id="bp-qvss-css",n.textContent='\n    #bp_overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);\n      display:flex;align-items:center;justify-content:center;z-index:9999;padding:16px}\n    .bp-modal{max-width:620px;width:clamp(300px,92vw,620px);background:var(--card,#fff);\n      color:var(--text,#111);border-radius:14px;border:1px solid rgba(0,0,0,.12);\n      box-shadow:0 12px 34px rgba(0,0,0,.35)}\n    .bp-modal .hd{display:flex;align-items:center;justify-content:space-between;padding:12px 14px}\n    .bp-modal .bd{padding:10px 14px 14px}\n    .bp-modal .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}\n    .bp-modal .right{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}\n    .bp-modal input[type="number"], .bp-modal input[type="date"], .bp-modal select, .bp-modal textarea{\n      width:100%;padding:8px;border:1px solid rgba(0,0,0,.18);border-radius:10px}\n    @media (prefers-color-scheme:dark){\n      .bp-modal{background:rgba(15,18,28,.98);color:#fff;border-color:rgba(255,255,255,.14)}\n      .bp-modal input, .bp-modal select, .bp-modal textarea{background:rgba(255,255,255,.04);color:#fff;border-color:rgba(255,255,255,.18)}\n    }\n  ',document.head.appendChild(n)})();function p(a){return String(a||"").replace(/[&<>'"]/g,n=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[n])}function s(a){if(window.showOverlay)window.showOverlay(a);else{const n=document.createElement("div");n.id="bp_overlay",n.innerHTML=a,document.body.appendChild(n)}}function D(){if(window.hideOverlay)window.hideOverlay();else{const a=document.getElementById("bp_overlay");a&&a.remove()}}async function Z(a){try{const n=await fe("/api/clients"),t=n&&n.clients||[],e=String(a||"").trim().toLowerCase(),o=t.find(b=>String(b.name||"").trim().toLowerCase()===e);return o?o.id:null}catch(n){return null}}async function j(a,n){if(!(Number(n)>0))return null;const t=new Date(a.end||a.start||Date.now()).toISOString();let e=a.clientId||null;e||(e=await Z(a.client));const o={date:t,vssTotal:Number(n)||0,services:a.services||"",consultantId:a.userId||(JSON.parse(localStorage.getItem("user")||"{}")||{}).id,clientId:e||void 0,clientName:a.client||void 0},b=await _e("/api/gi",o);return b&&(b.id||b.sale&&b.sale.id)||null}async function W(a){if(typeof viewGI=="function"&&document.querySelector("#gi_rows")){document.dispatchEvent(new CustomEvent("gi:edit",{detail:{id:a}}));return}if(typeof viewGI=="function"){try{viewGI()}catch(n){}setTimeout(()=>document.dispatchEvent(new CustomEvent("gi:edit",{detail:{id:a}})),350);return}try{let b=function(v){const c=o("pb_rates");if(!v||!v.length){c.textContent="Nessuna rata",c._data=[];return}c.innerHTML=v.map(u=>{const l=new Date(u.dueDate).toLocaleDateString("it-IT");return"<div>".concat(l," · ").concat(Number(u.amount||0).toLocaleString("it-IT"),'€ <span class="muted">').concat(p(u.note||""),"</span></div>")}).join(""),c._data=v};const n=await fe("/api/gi?from=1900-01-01&to=2999-12-31"),t=(n&&n.sales||[]).find(v=>String(v.id)===String(a));if(!t){de("Vendita non trovata");return}const e=new Date().toISOString().slice(0,10);s('<div class="bp-modal"><div class="hd"><b>Builder pagamenti – '+p(t.clientName||"Cliente")+'</b><button class="ghost" id="pb_x">Chiudi</button></div><div class="bd"><div class="row"><div style="flex:1"><label>Totale VSS</label><input id="pb_vss" type="number" value="'+Number(t.vssTotal||0)+'"></div></div><div class="row" style="margin-top:8px;gap:12px"><div><label>Regola rapida</label><select id="pb_rule"><option value="0">Manuale</option><option value="50-25-25">50% + 25% / 30-60gg</option><option value="20+12">20% + 12 rate mensili</option></select></div><div><label>Prima scadenza</label><input id="pb_first" type="date" value="'+e+'"></div></div><div style="margin-top:8px"><label>Rate</label><div id="pb_rates" class="small muted">Nessuna rata</div></div><div class="right"><button class="ghost" id="pb_apply">Ricalcola</button><button id="pb_save">Salva</button></div></div></div>');const o=v=>document.getElementById(v);o("pb_apply").onclick=function(){const v=o("pb_rule").value||"0",c=Math.max(0,Number(o("pb_vss").value||0)),u=new Date(o("pb_first").value||new Date),l=[],i=(r,d,m)=>l.push({dueDate:new Date(r).toISOString(),amount:Math.round(d),note:m||""});if(v==="50-25-25"){i(u,c*.5,"Acconto 50%");const r=new Date(u);r.setDate(r.getDate()+30),i(r,c*.25,"Saldo 25% a 30gg");const d=new Date(u);d.setDate(d.getDate()+60),i(d,c*.25,"Saldo 25% a 60gg")}else if(v==="20+12"){i(u,c*.2,"Acconto 20%");const r=c*.8,d=12,m=r/d;for(let y=0;y<d;y++){const A=new Date(u);A.setMonth(A.getMonth()+y+1),i(A,m,"Rata "+(y+1)+"/"+d)}}b(l)},o("pb_save").onclick=async function(){const v=Math.max(0,Number(o("pb_vss").value||0)),c=o("pb_rates")._data||[];try{await _e("/api/gi",{id:t.id,vssTotal:v,schedule:c});try{document.dispatchEvent(new CustomEvent("payments:defined",{detail:{id:t.id,vssTotal:v,schedule:c}}))}catch(u){}de("Piano pagamenti salvato"),D()}catch(u){logger.error(u),de("Errore salvataggio")}},o("pb_x").onclick=D}catch(n){logger.error(n)}}function ee(a){const n=a.client||"Cliente",t=Number(a.vss||a.vsdPersonal||0)||0;s('<div class="bp-modal"><div class="hd"><b>VSS per '+p(n)+'</b><button class="ghost" id="qvss_x">Chiudi</button></div><div class="bd"><div><label>Valore VSS</label><input id="qvss_val" type="number" step="1" value="'+t+'"></div><div class="small muted" style="margin-top:6px">Modifica consentita solo per VSS</div><div class="right"><button id="qvss_ok">Salva</button></div></div></div>'),document.getElementById("qvss_x").onclick=D,document.getElementById("qvss_ok").onclick=async function(){try{const e=Math.max(0,Number(document.getElementById("qvss_val").value||0));await _e("/api/appointments",{id:a.id,vss:e});const o=await j(a,e);D(),de("VSS salvato"),o&&W(o);try{o&&document.dispatchEvent(new CustomEvent("gi:created",{detail:{id:o}}))}catch(b){}document.dispatchEvent(new Event("bp:saved"))}catch(e){logger.error(e),de("Errore salvataggio VSS")}}}async function te(a){try{a.nncf&&(await(async function(){try{const t=await fe("/api/clients"),e=t&&t.clients||[],o=String(a.client||"").trim().toLowerCase(),b=e.find(v=>String(v.name||"").trim().toLowerCase()===o);b&&await _e("/api/clients",{id:b.id,status:"attivo"})}catch(t){}})(),document.dispatchEvent(new Event("client:converted"))),ee(a)}catch(n){logger.error(n)}}async function F(a){try{if(a.nncf)try{const n=await fe("/api/clients"),t=n&&n.clients||[],e=String(a.client||"").trim().toLowerCase(),o=t.find(b=>String(b.name||"").trim().toLowerCase()===e);o&&await _e("/api/clients",{id:o.id,status:"lead non chiuso"})}catch(n){}await _e("/api/appointments",{id:a.id,vss:0}),de("Ok, segnato come non venduto")}catch(n){logger.error(n),de("Errore aggiornamento")}}window.pipelineYes=te,window.pipelineNo=F,(function(){function a(){if(document.getElementById("bp-center-css"))return;const l="\n      #bp_overlay{display:flex;align-items:center;justify-content:center}\n      .bp-modal-card{min-width:min(560px,96vw);max-width:680px;max-height:86vh;overflow:auto}\n      @media (max-width:640px){ .bp-modal-card{min-width:96vw} }\n      .bp-modal-foot{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}\n    ",i=document.createElement("style");i.id="bp-center-css",i.textContent=l,document.head.appendChild(i)}function n(l){try{document.documentElement.style.overflow=l?"hidden":""}catch(i){}}async function t(l){if(!l)return null;try{const i=await fe("/api/clients"),r=i&&i.clients||[],d=String(l).trim().toLowerCase(),m=r.find(y=>String(y.name||"").trim().toLowerCase()===d);return m?m.id:null}catch(i){return null}}async function e(l,i){const r=await t(l);if(r)try{await _e("/api/clients",{id:r,status:i})}catch(d){}}async function o(l,i){return _e("/api/appointments",{id:l,vss:Math.max(0,Number(i||0))})}async function b(l,i){const r=await t(l.client||""),d={date:new Date(l.end||l.start||Date.now()).toISOString(),clientId:r||void 0,clientName:l.client||"",vssTotal:Math.max(0,Number(i||0)),services:l.services||"",schedule:[]},m=await _e("/api/gi",d);return m&&(m.id||m.sale&&m.sale.id||Array.isArray(m.sales)&&m.sales[0]&&m.sales[0].id)||null}async function v(l){if(!l)return;try{typeof window.viewGI=="function"&&window.viewGI()}catch(r){}let i=0;(function r(){if(document.getElementById("gi_rows")||i>40){try{const m=new CustomEvent("gi:edit",{detail:{id:l}});document.dispatchEvent(m)}catch(m){}return}i++,setTimeout(r,100)})()}function c(l,i){a(),n(!0);const r=Math.max(0,Number(l.vss||0)),d='<div class="modal"><div class="card bp-modal-card"><div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><b>VSS per '+(l.client?u(l.client):"appuntamento")+'</b><button class="ghost" id="qvss_x">Chiudi</button></div><div style="margin-top:8px"><label>Valore VSS</label><input id="qvss_val" type="number" step="1" value="'+r+'"><div class="small muted" style="margin-top:6px">Modifica consentita solo per VSS</div></div><div class="bp-modal-foot"><button id="qvss_ok">Salva</button></div></div></div>';showOverlay(d);function m(){n(!1),hideOverlay()}const y=document.getElementById("qvss_val");document.getElementById("qvss_x").onclick=m,document.getElementById("qvss_ok").onclick=async function(){try{const A=Math.max(0,Number(y.value||0));await o(l.id,A);const J=await b(l,A);if(m(),J)try{document.dispatchEvent(new CustomEvent("gi:created",{detail:{id:J}}))}catch(ae){}typeof window.coachSay=="function"&&S("medium"),v(J)}catch(A){logger.error(A),de("Errore salvataggio VSS")}}}function u(l){return String(l||"").replace(/[&<>'"]/g,i=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[i])}window.pipelineYes=async function(l){try{l.nncf&&await e(l.client,"cliente"),c(l)}catch(i){logger.error(i)}},window.pipelineNo=async function(l){try{l.nncf&&await e(l.client,"lead non chiuso"),await o(l.id,0),Ee("light"),de("Segnato VSS 0")}catch(i){logger.error(i)}}})(),(function(){function a(v){return encodeURIComponent(String(v||""))}function n(){try{const i=document.getElementById("rep_label");if(i&&i.textContent)return i.textContent.trim()}catch(i){}const v=(document.getElementById("rep_type")||{}).value||"mensile",c=new Date,u=String(c.getMonth()+1).padStart(2,"0"),l=c.getFullYear();return v==="settimanale"?"Settimana ISO "+(isoWeekNum?isoWeekNum(c):"corrente")+" "+l:v==="trimestrale"?"Q"+(Math.floor(c.getMonth()/3)+1)+" "+l:v==="semestrale"?"Semestre "+(c.getMonth()<6?"1°":"2°")+" "+l:v==="annuale"?"Anno "+l:"Mese "+u+"/"+l}async function t(){try{const v=await fe("/api/usernames");return(v&&v.users||[]).map(u=>u.email).filter(Boolean).join(",")}catch(v){return""}}function e(){const v=document.getElementById("report_subject");return v&&v.value&&v.value.trim()?v.value.trim():"Report BP – "+n()}function o(){const v=document.getElementById("report_body");return v&&v.value&&v.value.trim()?v.value:"Ciao,\n\ndi seguito il report del periodo "+n()+".\n\n– VSS\n– VSD\n– GI\n– NNCF\n\nA presto."}async function b(){const v=document.getElementById("rep_gmail_web"),c=document.getElementById("rep_gmail_app");if(!v&&!c)return;const u=await t(),l=e(),i=o();try{await navigator.clipboard.writeText(i)}catch(r){}v&&(v.onclick=function(){const r="https://mail.google.com/mail/?view=cm&fs=1&tf=1&su="+a(l)+"&cc="+a(u)+"&body="+a(i);window.open(r,"_blank");try{document.dispatchEvent(new Event("report:composed"))}catch(d){}}),c&&(c.onclick=function(){const r="googlegmail:///co?subject="+a(l)+"&cc="+a(u)+"&body="+a(i);location.href=r;try{document.dispatchEvent(new Event("report:composed"))}catch(d){}setTimeout(function(){if(!document.hidden){location.href="mailto:?subject="+a(l)+"&cc="+a(u)+"&body="+a(i);try{document.dispatchEvent(new Event("report:composed"))}catch(d){}}},1200)})}window.wireReportButtons=b})(),(function(){function a(c){var u=c instanceof Date?c:new Date(c||Date.now()),l=u.getFullYear(),i=("0"+(u.getMonth()+1)).slice(-2),r=("0"+u.getDate()).slice(-2);return l+"-"+i+"-"+r}function n(c){for(var u=a(new Date),l=c.querySelectorAll("[data-date], [data-day]"),i=0;i<l.length;i++){var r=l[i],d=r.getAttribute("data-date")||r.getAttribute("data-day")||"";if(d){var m=String(d).slice(0,10);m===u&&r.classList.add("today")}}}function t(c){if(typeof window.attachICSButtons=="function"){try{window.attachICSButtons(c)}catch(A){logger.error(A)}return}for(var u=c.querySelectorAll("[data-appt], [data-start][data-title], .appt, .calendar-appt"),l=0;l<u.length;l++){var i=u[l];if(!i.querySelector(".bp-ics")){var r=i.getAttribute("data-start")||"",d=i.getAttribute("data-end")||"",m=i.getAttribute("data-title")||i.getAttribute("data-client")||"Appuntamento";if(r){var y=document.createElement("a");y.href="#",y.className="bp-ics btn-ics",y.textContent="📅",y.style.marginLeft="6px",y.onclick=function(A){A.preventDefault();try{var J=A.currentTarget.parentElement||document.body,ae=J.getAttribute("data-start")||r,x=J.getAttribute("data-end")||d||ae,U=J.getAttribute("data-title")||J.getAttribute("data-client")||m,se=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//BP//Calendar//IT","BEGIN:VEVENT","UID:"+Date.now()+"@bp","DTSTAMP:"+new Date().toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z"),"DTSTART:"+new Date(ae).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z"),"DTEND:"+new Date(x).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z"),"SUMMARY:"+U,"END:VEVENT","END:VCALENDAR"].join("\r\n"),Y=new Blob([se],{type:"text/calendar"}),le=URL.createObjectURL(Y),ce=document.createElement("a");ce.href=le,ce.download=(U||"appuntamento")+".ics",document.body.appendChild(ce),ce.click(),setTimeout(function(){URL.revokeObjectURL(le);try{ce.remove()}catch(ge){}},0)}catch(ge){logger.error(ge)}},i.appendChild(y)}}}}function e(){var c=document.getElementById("calendar")||document.querySelector(".calendar")||document;n(c),t(c)}window.hookCalendar=e;function o(c){if(document.readyState==="complete"||document.readyState==="interactive")return c();document.addEventListener("DOMContentLoaded",c,{once:!0})}o(e);var b=document.getElementById("calendar")||document.querySelector(".calendar");if(b&&!b.__bpCalObs){b.__bpCalObs=!0;var v=new MutationObserver(function(){try{e()}catch(c){}});v.observe(b,{childList:!0,subtree:!0})}})(),(function(){var a=!1;function n(){if(!a){a=!0;var t='.today{outline:2px solid var(--accent, #5dd3ff); outline-offset:-2px; border-radius:8px; position:relative;}.today::after{content:"OGGI"; position:absolute; top:6px; right:8px; font-size:10px; font-weight:700; color:#fff; background:var(--accent, #5dd3ff); padding:2px 6px; border-radius:6px;}',e=document.createElement("style");e.setAttribute("data-bp-today","1"),e.textContent=t,document.head.appendChild(e)}}window.injectTodayCSS=n,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",n,{once:!0}):n()})(),(function(){function a(){try{return JSON.parse(localStorage.getItem("user")||"{}")}catch(l){return{}}}function n(){var l=a();return l&&l.role==="admin"}function t(l,i){return(i||document).querySelector(l)}function e(l,i){return Array.prototype.slice.call((i||document).querySelectorAll(l))}function o(l){var i=new Date(l);return!i||isNaN(i)?"—":("0"+i.getDate()).slice(-2)+"/"+("0"+(i.getMonth()+1)).slice(-2)+"/"+i.getFullYear()}async function b(){try{for(var l=await fe("/api/appointments"),i=l&&l.appointments||[],r={},d=0;d<i.length;d++){var m=i[d],y=String(m.client||"").trim().toLowerCase();if(y){var A=new Date(m.start||m.end||0).getTime();(!r[y]||A>r[y])&&(r[y]=A)}}return r}catch(J){return logger.error(J),{}}}async function v(){var l=document.getElementById("cl_list");if(l){var i=await b();e(".card",l).forEach(function(r){var d=t("b",r);if(d){var m=(d.textContent||"").trim().toLowerCase();if(m){var y=i[m],A=t(".bp-lastapp",r),J="Ultimo appuntamento: "+(y?o(y):"—");if(A)A.textContent=J;else{var ae=document.createElement("div");ae.className="small muted bp-lastapp",ae.textContent=J,r.appendChild(ae)}}}})}}async function c(){if(!n())return;var l=document.getElementById("cl_list");if(!l)return;var[i,r]=await Promise.all([fe("/api/clients"),fe("/api/usernames")]),d=i&&i.clients||[],m=r&&r.users||[];function y(A){var J=t("b",A),ae=(J&&J.textContent||"").trim().toLowerCase();return d.find(function(x){return String(x.name||"").trim().toLowerCase()===ae})}l.__bpInlineReady||(l.__bpInlineReady=!0,e(".card",l).forEach(function(A){if(!A.__bpInline){A.__bpInline=!0;var J=y(A);if(J){var ae=document.createElement("div");ae.style.display="flex",ae.style.gap="8px",ae.style.marginTop="6px";var x=document.createElement("button");x.className="ghost",x.textContent="Modifica",ae.appendChild(x),A.appendChild(ae);var U=document.createElement("div");U.style.display="none",U.style.marginTop="8px",U.innerHTML='<div class="row" style="gap:8px"><div><label>Nome</label><input class="bp-ed-name" type="text" value="'+(J.name||"")+'"></div><div><label>Stato</label><select class="bp-ed-state"><option value="prospect" '+(J.status==="prospect"?"selected":"")+'>Prospect</option><option value="attivo" '+(J.status==="attivo"?"selected":"")+'>Attivo</option><option value="cliente" '+(J.status==="cliente"?"selected":"")+'>Cliente</option></select></div><div><label>Consulente</label><select class="bp-ed-consulente"></select></div><div style="align-self:flex-end"><button class="ghost bp-ed-save">Salva</button></div></div>',A.appendChild(U);var se=t(".bp-ed-consulente",U);se.innerHTML='<option value="">—</option>'+m.map(function(Y){return'<option value="'+Y.id+'" '+(String(J.consultantId||"")===String(Y.id)?"selected":"")+">"+(Y.name||"User "+Y.id)+"</option>"}).join(""),x.onclick=function(){U.style.display=U.style.display==="none"?"block":"none"},t(".bp-ed-save",U).onclick=async function(Y){Y.preventDefault();try{var le={id:J.id,name:t(".bp-ed-name",U).value.trim(),status:t(".bp-ed-state",U).value,consultantId:t(".bp-ed-consulente",U).value||null};await _e("/api/clients",le);var ce=t("b",A);ce&&(ce.textContent=le.name);var ge=t(".small",A);ge&&/Stato:/.test(ge.textContent||"")&&(ge.innerHTML="Stato: <b>"+le.status+"</b>");var Se=e(".small",A).find(function(Be){return/Consulente:/.test(Be.textContent||"")});if(Se){var be=m.find(function(Be){return String(Be.id)===String(le.consultantId||"")});Se.innerHTML="Consulente: <b>"+(be?be.name||"User "+be.id:"—")+"</b>"}Ee("medium")}catch(Be){logger.error(Be),Ee("heavy")}}}}}))}window.applyClientsLastAppointment=v,window.ensureClientInlineEdit=c;function u(){var l=document.getElementById("cl_list");if(l&&(v(),c(),!l.__bpCliObs)){l.__bpCliObs=!0;var i=new MutationObserver(function(){v(),c()});i.observe(l,{childList:!0,subtree:!0})}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",u,{once:!0}):u()})();function ie(a){const n=["#".concat(a,"_mode"),"#dash_mode","#comm_mode",'[data-scope="'.concat(a,'"] [name="mode"]'),"#".concat(a,' select[name="mode"]'),'#dashboard select[name="mode"]','select[name="mode"]'];for(const t of n){const e=document.querySelector(t);if(e&&e.value)return e.value}return"consuntivo"}if(window.__BP_FINAL_READY__)return;window.__BP_FINAL_READY__=!0;const ne=(a,n)=>(n||document).querySelector(a),ye=(a,n,t)=>a&&a.addEventListener(n,t,!1),we=a=>document.readyState!=="loading"?a():document.addEventListener("DOMContentLoaded",a),re=(a,n)=>{try{return JSON.parse(a)}catch(t){return n}},oe=a=>a<10?"0"+a:""+a,ve=()=>{const a=new Date;return"".concat(a.getFullYear(),"-").concat(oe(a.getMonth()+1),"-").concat(oe(a.getDate()))};function de(a){try{(window.showToast?window.showToast:alert)(a)}catch(n){alert(a)}}function Ce(){const a=t=>{if(!t)return null;t=String(t).replace(/^"+|"+$/g,"");try{const e=JSON.parse(t);if(e&&(e.token||e.jwt||e.accessToken))return e.token||e.jwt||e.accessToken}catch(e){}return/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+$/.test(t)?t:null};for(let t=0;t<localStorage.length;t++){const e=a(localStorage.getItem(localStorage.key(t)));if(e)return e}const n=["token","authToken","jwt","bp_token","accessToken","id_token","auth","authorization","bp.jwt","_token","session","user"];for(const t of n){const e=a(localStorage.getItem(t)||sessionStorage.getItem(t));if(e)return e}try{const t=re(localStorage.getItem("user")||"{}",{});if(t&&(t.token||t.jwt||t.accessToken))return t.token||t.jwt||t.accessToken}catch(t){}return null}async function fe(a,n={}){if(typeof window.GET=="function"&&!n.forceFetch)try{return await window.GET(a)}catch(o){}const t=Ce(),e=await fetch(a,{headers:{Accept:"application/json",...t?{Authorization:"Bearer "+t}:{}}});return e.status===401&&window.GET?window.GET(a):e.status===204?null:e.json()}async function _e(a,n,t={}){if(typeof window.POST=="function"&&!t.forceFetch)try{return await window.POST(a,n)}catch(b){}const e=Ce(),o=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json",...e?{Authorization:"Bearer "+e}:{}},body:JSON.stringify(n||{})});return!o.ok&&o.status===401&&window.POST?window.POST(a,n):o.status===204?null:o.json()}function Ue(a,n,t){const e=document.getElementById(a);if(!e)return;const o=e.getContext("2d"),b=e.width=Math.max(220,e.clientWidth||320),v=e.height=Math.max(80,e.clientHeight||80);o.clearRect(0,0,b,v);const c=Array.isArray(t)?t.map(J=>+J||0):[];if(!c.length)return;const u=Math.max(...c),l=Math.min(...c),i=u-l===0?(u||1)*.2:(u-l)*.2,r=u+i,d=Math.max(0,l-i),m=c.length>1?(b-8)/(c.length-1):0,y=J=>4+J*m,A=J=>{const ae=(J-d)/(r-d||1);return v-6-ae*(v-12)};o.lineWidth=2,o.strokeStyle="#2e6cff",o.beginPath(),o.moveTo(y(0),A(c[0]));for(let J=1;J<c.length;J++)o.lineTo(y(J),A(c[J]));o.stroke(),o.fillStyle="#2e6cff";for(let J=0;J<c.length;J++)o.beginPath(),o.arc(y(J),A(c[J]),2,0,Math.PI*2),o.fill()}(function(){const n=function(t,e,o){const b=document.getElementById(t);if(b){if(window.Chart)try{b.__chart&&typeof b.__chart.destroy=="function"&&b.__chart.destroy();const v={type:"line",data:{labels:e,datasets:[{data:o,tension:.35,pointRadius:2,borderWidth:2}]},options:{responsive:!0,plugins:{legend:{display:!1}},scales:{x:{display:!0},y:{display:!0}}}};b.__chart=new Chart(b.getContext("2d"),v);return}catch(v){}Ue(t,e,o)}};(!window.drawFullLine||!window.drawFullLine.__patched)&&(window.drawFullLine=n,window.drawFullLine.__patched=!0)})();const f=typeof window<"u"?window.__periodsCache||(window.__periodsCache={}):{};function h(a){try{const n=new Date(a),t=n.getUTCFullYear(),e=String(n.getUTCMonth()+1).padStart(2,"0"),o=String(n.getUTCDate()).padStart(2,"0");return t+"-"+e+"-"+o}catch(n){return""}}function $(a){try{return typeof effectivePeriodType=="function"?effectivePeriodType(String(a||"mensile").toLowerCase()):String(a||"mensile").toLowerCase()}catch(n){return String(a||"mensile").toLowerCase()}}async function _(a){if(!a){if(Array.isArray(window.periods)&&window.periods.length)return window.periods;try{const u=await fe("/api/periods?global=1");if(u&&Array.isArray(u.periods))return window.periods=u.periods,u.periods}catch(u){}return window.periods||[]}let n,t,e,o=null;if(typeof a=="string"){const u=window.readUnifiedRange&&window.readUnifiedRange(a)||{type:"mensile",end:new Date};n=u.type||"mensile";const l=window.buildBuckets?window.buildBuckets(n,u.end):[];if(l&&l.length)t=h(new Date(l[0].s)),e=h(new Date(l[l.length-1].e));else if(u.start&&u.end)t=h(new Date(u.start)),e=h(new Date(u.end));else{const i=new Date;t=h(i),e=h(i)}}else{const u=a||{};n=u.type||"mensile",t=u.from||h(new Date),e=u.to||h(new Date),o=u.userId||null}const b=$(n),v=[b,t,e,o||""].join("|");if(f[v])return f[v];const c=["?global=1","type="+encodeURIComponent(b),"from="+encodeURIComponent(t),"to="+encodeURIComponent(e)].concat(o?["userId="+encodeURIComponent(o)]:[]).join("&").replace("?&","?");try{const u=await fe("/api/periods"+c).catch(function(){return fe("/api/periods"+c.replace("?global=1","?").replace("??","?"))}),l=u&&Array.isArray(u.periods)?u.periods:[];return f[v]=l,l}catch(u){return[]}}function z(a,n,t){const e=String(n).toLowerCase()==="previsionale"?a.indicatorsPrev||{}:a.indicatorsCons||{},o=Number(e[t]||0);return Number.isFinite(o)?o:0}function P(a,n,t){if(typeof window.drawFullLine=="function")return window.drawFullLine(a,n,t);Ue(a,n,t)}async function C(){const a=window.readUnifiedRange&&window.readUnifiedRange("dash")||{type:"mensile",end:new Date},n=a.type||"mensile",t=ie("dash"),e=window.buildBuckets?window.buildBuckets(n,a.end):[],o=await _("dash"),b=window.labelsFor?window.labelsFor(n,e):e.map((v,c)=>String(c+1));["VSS","VSDPersonale","GI","NNCF"].forEach(v=>{const c=e.map(u=>{let l=0;return o.forEach(i=>{if(i.type!==effectivePeriodType(n))return;const r=new Date(i.startDate).getTime(),d=new Date(i.endDate).getTime();r>=u.s&&d<=u.e&&(l+=z(i,t,v))}),Math.round(l)});P("d_mini_"+v.toLowerCase(),b,c)});try{if(window.BP&&BP.Targets&&typeof BP.Targets.getForPeriod=="function"){const v=JSON.parse(localStorage.getItem("user")||"{}")||{},c=String(v.grade||"junior").toLowerCase()==="senior"?"senior":"junior",u=BP.Targets.getForPeriod(c,effectivePeriodType(n))||{},l=["VSS","VSDPersonale","GI","NNCF"],i={};l.forEach(r=>{let d=0;const m=e[e.length-1];m&&(o.forEach(y=>{if(y.type!==effectivePeriodType(n))return;const A=new Date(y.startDate).getTime(),J=new Date(y.endDate).getTime();A>=m.s&&J<=m.e&&(d+=z(y,t,r))}),i[r]=Math.round(d))}),window.__bpCoachKpiFired=window.__bpCoachKpiFired||{},l.forEach(r=>{const d=Number(u[r]||0);if(d<=0)return;const m=Number(i[r]||0),y=Math.round(m/d*100),A=effectivePeriodType(n)+"_"+r;if(y>=100&&!window.__bpCoachKpiFired[A+"_100"]){window.__bpCoachKpiFired[A+"_100"]=!0;try{document.dispatchEvent(new CustomEvent("kpi:goal-reached",{detail:{key:r,value:m,target:d}}))}catch(J){}}else if(y>=80&&!window.__bpCoachKpiFired[A+"_80"]){window.__bpCoachKpiFired[A+"_80"]=!0;try{document.dispatchEvent(new CustomEvent("kpi:goal-80",{detail:{key:r,value:m,target:d}}))}catch(J){}}})}}catch(v){}}async function g(){const a="comm",n=window.readUnifiedRange&&(window.readUnifiedRange(a)||window.readUnifiedRange("cm"))||{type:"mensile",end:new Date},t=n.type||"mensile",e=ie&&ie(a)||ie&&ie("cm")||"cons",o=window.buildBuckets?window.buildBuckets(t,n.end):[],b=await _("comm"),v=window.labelsFor?window.labelsFor(t,o):o.map((u,l)=>String(l+1)),c=o.map(u=>{let l=0;return b.forEach(i=>{if(i.type!==effectivePeriodType(t))return;const r=new Date(i.startDate).getTime(),d=new Date(i.endDate).getTime();r>=u.s&&d<=u.e&&(l+=z(i,e,"VSDPersonale"))}),Math.round(l)});P("cm_mini_vsd",v,c)}async function G(){const a=window.readUnifiedRange&&(window.readUnifiedRange("t")||window.readUnifiedRange("tg"))||{type:"mensile",end:new Date},n=a.type||"mensile",t=ie&&ie("t")||ie&&ie("tg")||"cons",e=(ne("#tg_user")||{}).value||"",o=(ne("#tg_ind")||{}).value||"VSS",b=window.buildBuckets?window.buildBuckets(n,a.end):[];function v(d){try{const m=new Date(d),y=m.getUTCFullYear(),A=String(m.getUTCMonth()+1).padStart(2,"0"),J=String(m.getUTCDate()).padStart(2,"0");return y+"-"+A+"-"+J}catch(m){return""}}const c=b.length?v(new Date(b[0].s)):v(new Date),u=b.length?v(new Date(b[b.length-1].e)):v(new Date),l=await _({type:n,from:c,to:u,userId:e||null}),i=window.labelsFor?window.labelsFor(n,b):b.map((d,m)=>String(m+1)),r=b.map(d=>{let m=0;return l.forEach(y=>{if(y.type!==effectivePeriodType(n)||e&&String(y.userId)!==String(e))return;const A=new Date(y.startDate).getTime(),J=new Date(y.endDate).getTime();A>=d.s&&J<=d.e&&(m+=z(y,t,o))}),Math.round(m)});P("tg_chart",i,r)}function I(){ye(ne("#dash_mode"),"change",()=>{Ee("light"),window.recomputeDashboard&&recomputeDashboard(),window.recomputeDashboardMini&&C()}),ye(ne("#d_mode"),"change",()=>{Ee("light"),window.recomputeDashboard&&recomputeDashboard(),window.recomputeDashboardMini&&C()}),ye(ne("#comm_mode"),"change",()=>{Ee("light"),window.recomputeCommsMini&&g()}),ye(ne("#cm_mode"),"change",()=>{Ee("light"),window.recomputeCommsMini&&g()});const a=ne("#tg_user");a&&a.options.length<=1&&fe("/api/usernames").then(e=>{(e&&e.users||[]).forEach(o=>{var b=document.createElement("option");b.value=o.id,b.textContent=(o.name||"User "+o.id)+(o.grade?" – "+o.grade:""),a.appendChild(b)})}).catch(e=>logger.error(e));const n=()=>{window.recomputeTeamChart&&G(),window.recomputeTeamAggChart&&recomputeTeamAggChart()};ye(ne("#t_mode"),"change",()=>{Ee("light"),n()}),["#t_y","#t_m","#t_q","#t_from","#t_to"].forEach(e=>{const o=ne(e);o&&ye(o,"change",n)}),a&&ye(a,"change",()=>{Ee("light"),window.recomputeTeamChart&&G()});const t=ne("#t_ind");t&&ye(t,"change",()=>{Ee("light"),window.recomputeTeamAggChart&&recomputeTeamAggChart()}),ne("#tg_chart")&&window.recomputeTeamChart&&G(),ne("#t_chart")&&window.recomputeTeamAggChart&&recomputeTeamAggChart()}typeof window.todayKey!="function"&&(window.todayKey=function(){var n=new Date,t=n.getFullYear(),e=("0"+(n.getMonth()+1)).slice(-2),o=("0"+n.getDate()).slice(-2);return t+"-"+e+"-"+o});function R(){try{var a=ve(),n=document.querySelector('.calendar .day[data-day="'+a+'"], .calendar .day[data-date="'+a+'"]');if(!n)for(var t=parseInt(a.slice(8,10),10),e=document.querySelectorAll(".calendar .day"),o=0;o<e.length;o++){var b=e[o],v=parseInt((b.getAttribute("data-day")||b.getAttribute("data-date")||"").slice(8,10)||b.textContent.trim(),10);if(v===t){n=b;break}}n&&n.classList.add("today")}catch(c){}}function q(){try{for(var a=ve(),n=document.querySelectorAll(".calendar .day[data-day], .calendar .day[data-date]"),t=0;t<n.length;t++){var e=n[t],o=(e.getAttribute("data-day")||e.getAttribute("data-date")||"").slice(0,10);o&&o<a&&e.classList.remove("slot-free")}}catch(b){}}function B(){try{var a=document.getElementById("cal_day_box");if(!a)return;for(var n=a.querySelectorAll(".cal-app"),t=0;t<n.length;t++){var e=n[t];if(!e.querySelector("[data-ics-inline]")){var o=e.getAttribute("data-start")||"",b=e.getAttribute("data-end")||"",v=e.getAttribute("data-title")||(e.querySelector("b")?e.querySelector("b").textContent.trim():"Appuntamento");if(!(!o||!b)&&window.BP&&BP.ICS&&typeof BP.ICS.downloadIcsForAppointment=="function"){var c=document.createElement("button");c.className="ghost btn-ics",c.textContent="📅",c.setAttribute("data-ics-inline","1"),c.style.marginTop="6px",c.addEventListener("click",function(u){u.stopPropagation();var l=u.currentTarget.parentElement,i=l.getAttribute("data-start"),r=l.getAttribute("data-end"),d=l.getAttribute("data-title")||(l.querySelector("b")?l.querySelector("b").textContent.trim():"Appuntamento"),m={client:d,start:i,end:r,type:"manuale",vss:0,vsdPersonal:0,nncf:!1};try{BP.ICS.downloadIcsForAppointment(m),Ee("medium")}catch(y){}}),e.appendChild(c)}}}}catch(u){}}window.markToday=window.markToday||R,window.clampSlotCounters=window.clampSlotCounters||q,window.wireICSInsideDayBox=window.wireICSInsideDayBox||B,(function(){function a(v){return encodeURIComponent(String(v||""))}function n(){return fe("/api/users_emails").then(function(v){return v&&Array.isArray(v.emails)?v.emails.filter(Boolean):v&&Array.isArray(v.users)?v.users.map(c=>c.email).filter(Boolean):[]}).catch(function(){return fe("/api/usernames").then(function(v){var c=v&&v.users||[];return c.map(u=>u.email).filter(Boolean)}).catch(function(){return[]})})}function t(){var v=document.getElementById("report_subject");return v&&v.value.trim()||"Report BP"}function e(){var v=document.getElementById("report_body");return v&&v.value||""}function o(){var v=document.getElementById("rep_gmail_web"),c=document.getElementById("rep_gmail_app");!v&&!c||n().then(function(u){var l=(u||[]).join(",");function i(){return"https://mail.google.com/mail/?view=cm&fs=1&tf=1&su="+a(t())+"&cc="+a(l)+"&body="+a(e())}function r(){return"googlegmail:///co?subject="+a(t())+"&cc="+a(l)+"&body="+a(e())}v&&(v.onclick=function(){try{navigator.clipboard&&navigator.clipboard.writeText(e())}catch(d){}window.open(i(),"_blank")}),c&&(c.onclick=function(){try{navigator.clipboard&&navigator.clipboard.writeText(e())}catch(d){}location.href=r(),setTimeout(function(){if(!document.hidden){var d="mailto:?subject="+a(t())+"&cc="+a(l)+"&body="+a(e());location.href=d}},1200)})})}var b=window.BPFinal=window.BPFinal||{};b.wireReportButtons=o,window.wireReportButtons||(window.wireReportButtons=o)})(),(function(){let a={ts:0,map:null},n=null;function t(e){const o=Object.create(null);for(const b of e||[]){const v=String(b.client||"").toLowerCase();if(!v)continue;const c=+new Date(b.end||b.start||0);(!o[v]||c>o[v])&&(o[v]=c)}return o}window.BPFinal=window.BPFinal||{},BPFinal.getLastApptMap=function(){const o=Date.now();return a.map&&o-a.ts<15e3?Promise.resolve(a.map):n||(n=fe("/api/appointments?global=1").then(b=>t(b&&b.appointments||[])).then(b=>(a={ts:Date.now(),map:b},b)).catch(()=>({})).finally(()=>{n=null}),n)}})(),BPFinal.enrichClientCards=function(){const n=document.getElementById("cl_list");n&&BPFinal.getLastApptMap().then(t=>{const e=n.querySelectorAll(".card[data-clid], .card");for(const o of e){const b=o.querySelector("b"),v=(b?b.textContent:o.getAttribute("data-name")||"").trim().toLowerCase(),c=t[v]||0,u=o.querySelector(".last-appt, .client-last");if(u)if(c){const l=new Date(c),i=("0"+l.getDate()).slice(-2),r=("0"+(l.getMonth()+1)).slice(-2),d=l.getFullYear();u.textContent="".concat(i,"/").concat(r,"/").concat(d)}else u.textContent="—";o.setAttribute("data-last-ts",String(c||0)),!o.getAttribute("data-name-lower")&&v&&o.setAttribute("data-name-lower",v)}})},BPFinal.enableClientsInlineAdmin=function(){const n=document.getElementById("cl_list");if(!n||n.__bp_inline_admin_wired)return;n.__bp_inline_admin_wired=!0;let t=null;function e(){return t?Promise.resolve(t):fe("/api/usernames").then(c=>t=c&&c.users||[]).catch(()=>[])}const o=["attivo","lead non chiuso","potenziale"];function b(c){if(!c||c.nodeType!==1||c.querySelector("[data-edit-client]"))return;c.style.position="relative";const u=document.createElement("button");u.className="ghost small",u.textContent="Modifica",u.title="Modifica cliente",u.setAttribute("data-edit-client","1"),u.style.position="absolute",u.style.right="8px",u.style.top="8px",u.style.zIndex="2",u.style.cursor="pointer",c.appendChild(u),u.addEventListener("click",function(){const l=c.getAttribute("data-clid")||c.dataset.clid||"",i=c.querySelector("b"),r=c.querySelector(".cl-status, .client-status"),d=c.querySelector(".cl-cons, .client-owner"),m={name:i?i.textContent.trim():"",status:String(r&&r.textContent||c.getAttribute("data-status")||"potenziale").toLowerCase(),consId:c.getAttribute("data-consultant-id")||"",consText:d?d.textContent:"—"},y=document.createElement("input");y.type="text",y.value=m.name,y.style.width="100%",i&&i.replaceWith(y);const A=document.createElement("select");A.innerHTML=o.map(J=>'<option value="'.concat(J,'">').concat(J.charAt(0).toUpperCase()+J.slice(1),"</option>")).join(""),A.value=o.includes(m.status)?m.status:"potenziale",r&&(r.textContent="",r.appendChild(A)),e().then(J=>{const ae=document.createElement("select");ae.innerHTML='<option value="">—</option>'+J.map(Y=>'<option value="'.concat(Y.id,'">').concat(Y.name||"User "+Y.id).concat(Y.grade?" ("+Y.grade+")":"","</option>")).join(""),m.consId&&(ae.value=String(m.consId)),d&&(d.textContent="",d.appendChild(ae));const x=document.createElement("div");x.className="row",x.style.marginTop="8px";const U=document.createElement("button");U.textContent="Salva";const se=document.createElement("button");se.textContent="Annulla",se.className="ghost",x.appendChild(U),x.appendChild(se),c.appendChild(x),se.addEventListener("click",function(){const Y=document.createElement("b");Y.textContent=m.name,y.replaceWith(Y),r&&(r.textContent=m.status),d.textContent=m.consText||"—",x.remove()}),U.addEventListener("click",function(){const Y={id:l,name:y.value.trim(),status:A.value},le=ae.value?String(ae.value):"";le&&(Y.consultantId=le),_e("/api/clients",Y).then(function(){de("Cliente aggiornato"),typeof addXP=="function"&&addXP(4);const ce=document.createElement("b");ce.textContent=Y.name||m.name,y.replaceWith(ce),r&&(r.textContent=Y.status),le?(d.textContent=ae.options[ae.selectedIndex].textContent||"#"+le,c.setAttribute("data-consultant-id",le)):(d.textContent="—",c.setAttribute("data-consultant-id","")),c.setAttribute("data-status",Y.status),x.remove()}).catch(function(ce){logger.error(ce),de("Errore aggiornamento cliente")})})})})}n.querySelectorAll(".card[data-clid], .card").forEach(b),new MutationObserver(c=>{for(const u of c)for(const l of u.addedNodes)l.nodeType===1&&l.matches(".card[data-clid], .card")&&b(l),l.nodeType===1&&l.querySelectorAll&&l.querySelectorAll(".card[data-clid], .card").forEach(b)}).observe(n,{childList:!0,subtree:!0})},BPFinal.applyClientSort=function(){const n=document.getElementById("cl_list");if(!n)return;const t=document.getElementById("cl_order"),e=t?t.value:"az",o=Array.from(n.children).filter(b=>b.classList.contains("card"));if(o.length){e==="last_desc"?o.sort((b,v)=>(+v.getAttribute("data-last-ts")||0)-(+b.getAttribute("data-last-ts")||0)):o.sort((b,v)=>String(b.getAttribute("data-name-lower")||"").localeCompare(String(v.getAttribute("data-name-lower")||"")));for(const b of o)n.appendChild(b)}},BPFinal.ensureClientFilters=function(){const n=document.getElementById("cl_f_apply");n&&!n.__bp_wired&&(n.__bp_wired=!0,n.addEventListener("click",()=>{setTimeout(()=>{BPFinal.enrichClientCards(),BPFinal.applyClientSort()},0)}));const t=document.getElementById("cl_order");t&&!t.__bp_wired&&(t.__bp_wired=!0,t.addEventListener("change",()=>BPFinal.applyClientSort()))},BPFinal.wireCreateClientExtras=function(){const n=document.getElementById("cl_add");!n||n.__bp_wired||(n.__bp_wired=!0,n.addEventListener("click",t=>{const e=document.getElementById("cl_name"),o=document.getElementById("cl_new_state"),b=document.getElementById("cl_new_owner");if(!e)return;const v=(e.value||"").trim();if(!v||!o&&!b)return;t.stopPropagation(),t.preventDefault();const c={name:v};o&&(c.status=o.value),b&&b.value&&(c.consultantId=b.value),_e("/api/clients",c).then(()=>{de("Cliente aggiunto"),addXP&&addXP(5),e.value="",setTimeout(()=>{BPFinal.enrichClientCards(),BPFinal.applyClientSort()},150)}).catch(()=>de("Errore creazione cliente"))},!0))},BPFinal.ensureClientSection=function(){BPFinal.ensureClientFilters(),BPFinal.wireCreateClientExtras(),BPFinal.enrichClientCards(),BPFinal.enableClientsInlineAdmin(),BPFinal.applyClientSort()};async function E(){const a=ne("#tg_user");if(!a||a.options.length>1)return;const n=await fe("/api/usernames").catch(()=>null);(n&&n.users||[]).forEach(t=>{const e=document.createElement("option");e.value=t.id,e.textContent=t.name+(t.grade?" ("+t.grade+")":""),a.appendChild(e)})}function w(){const a=ne("#users, .users");if(!a||a.__userEditWired)return;a.__userEditWired=!0,a.addEventListener("click",t=>{var l,i;const e=t.target.closest("[data-edit-user]");if(!e)return;const o=e.closest("[data-user-id]"),b=o==null?void 0:o.getAttribute("data-user-id"),v=((l=o==null?void 0:o.querySelector(".u-name"))==null?void 0:l.textContent)||"",c=((i=o==null?void 0:o.querySelector(".u-email"))==null?void 0:i.textContent)||"",u=document.createElement("div");u.className="modal",u.innerHTML='<div class="card"><h3>Modifica utente</h3><label>Nome <input id="u_name" value="'+v+'"></label><label>Email <input id="u_email" value="'+c+'"></label><label>Password <input id="u_pass" type="password" placeholder="(lascia vuoto per non cambiare)"></label><div class="row right"><button id="u_ok" class="btn-ghost">Salva</button><button id="u_x" class="btn-ghost">Chiudi</button></div></div>',document.body.appendChild(u),ne("#u_x",u).onclick=()=>u.remove(),ne("#u_ok",u).onclick=async()=>{try{const r={id:b,name:ne("#u_name",u).value,email:ne("#u_email",u).value},d=ne("#u_pass",u).value.trim();d&&(r.password=d),await _e("/api/users",r),de("Utente aggiornato"),u.remove(),location.reload()}catch(r){de("Errore aggiornamento utente")}}});const n=ne("#btnProfile")||ne("[data-edit-self]");n&&!n.__wired&&(n.__wired=!0,n.onclick=()=>{const t=re(localStorage.getItem("user")||"{}",{}),e=document.createElement("div");e.className="modal",e.innerHTML='<div class="card"><h3>Profilo</h3><label>Nome <input id="me_name" value="'+(t.name||"")+'"></label><label>Email <input id="me_email" value="'+(t.email||"")+'"></label><label>Password <input id="me_pass" type="password" placeholder="(nuova password)"></label><div class="row right"><button id="me_ok" class="btn-ghost">Salva</button><button id="me_x" class="btn-ghost">Chiudi</button></div></div>',document.body.appendChild(e),ne("#me_x",e).onclick=()=>e.remove(),ne("#me_ok",e).onclick=async()=>{try{const o={id:t.id,name:ne("#me_name",e).value,email:ne("#me_email",e).value},b=ne("#me_pass",e).value.trim();b&&(o.password=b),await _e("/api/users",o),de("Profilo aggiornato"),e.remove(),location.reload()}catch(o){de("Errore aggiornamento profilo")}}})}const M=document.createElement("div");M.style.cssText="position:fixed;top:14px;left:50%;transform:translateX(-50%);z-index:1200;display:flex;flex-direction:column;gap:6px;pointer-events:none;",document.documentElement.appendChild(M);const O="\n    .bp-coach{background:rgba(20,24,34,.92);color:#fff;border:1px solid rgba(255,255,255,.16);\n      border-radius:12px;padding:8px 10px;font-weight:700;box-shadow:0 12px 24px rgba(0,0,0,.35);opacity:.98;transform:translateY(0);transition:all .18s;}\n    @keyframes bpCoachPop{from{transform:translateY(-6px);opacity:0}to{transform:translateY(0);opacity:1}}\n  ",L=document.createElement("style");L.textContent=O,document.head.appendChild(L);function T(){return re(localStorage.getItem("user")||"{}",{})}function H(a){const n=T().name||"campione",t=window.BP&&window.BP.Phrases?window.BP.Phrases:null;let e=[];return t?e=a==="high"?t.high||t.standard||[]:a==="low"?t.low||t.standard||[]:t.medium||t.standard||[]:e=["Grande {{name}}!","Che figata, {{name}}!","Super!","Non ti ferma nessuno!!","Grandissimo!"],e.length||(e=["Grande {{name}}!"]),e[Math.floor(Math.random()*e.length)].replace(/{{\s*name\s*}}/gi,n)}function S(a){const n=document.createElement("div");n.className="bp-coach",n.textContent=H(a||"medium"),M.appendChild(n),setTimeout(()=>{n.style.opacity="0",n.style.transform="translateY(-4px)"},2200),setTimeout(()=>{n.remove()},2420)}window.coachSay=window.coachSay||S;try{window.BP=window.BP||{},window.BP.Coach=window.BP.Coach||{},window.BP.Coach.say=window.BP.Coach.say||function(a,n){try{const t=String(a||"").toLowerCase();let e=n&&n.intensity||(t==="low"||t==="medium"||t==="high"?t:void 0);e||(t==="bp_saved"||t==="client_converted"||t==="gi_created"?e="high":t==="appointment_created"||t==="payments_defined"||t==="report_composed"?e="medium":e="low"),S(e)}catch(t){S("medium")}}}catch(a){}(function(){var a="bp-nncf-banner",n="bp_seen_nncf_appt";function t(){if(!document.getElementById("bp-nncf-css")){var c="\n      #".concat(a,"{\n        position: fixed; left: 16px; right:16px; bottom: 16px; z-index: 9999;\n        background: var(--card, rgba(15,18,28,.96));\n        border: 1px solid var(--hair2, rgba(255,255,255,.12));\n        border-radius: 14px; box-shadow: 0 8px 28px rgba(0,0,0,.35);\n        padding: 12px; display:flex; align-items:center; gap:12px; backdrop-filter: blur(6px);\n      }\n      #").concat(a," .msg{ flex:1; }\n      #").concat(a," .row{ display:flex; gap:8px; align-items:center; }\n      #").concat(a," .ghost{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.18); }\n      @media (prefers-color-scheme: light){\n        #").concat(a,"{ background:#fff; border-color: rgba(0,0,0,.12); }\n        #").concat(a," .ghost{ background:rgba(0,0,0,.04); border-color: rgba(0,0,0,.12); }\n      }\n    "),u=document.createElement("style");u.id="bp-nncf-css",u.textContent=c,document.head.appendChild(u)}}function e(c,u){return c?(c=String(c).trim().toLowerCase(),fe("/api/clients").then(function(l){var i=l&&l.clients||[],r=i.find(function(d){return String(d.name||"").trim().toLowerCase()===c});if(!r)throw new Error("Cliente non trovato: "+c);return _e("/api/clients",{id:r.id,status:u})})):Promise.reject(new Error("Nome cliente mancante"))}function o(c){if(document.getElementById(a))return;t();var u=c.client||"Cliente",l=document.createElement("div");l.id=a,l.innerHTML='<div class="msg"><b>È diventato cliente?</b> '+p(u)+'</div><div class="row"><button class="ghost" id="bp_nncf_yes">Sì</button><button class="ghost" id="bp_nncf_notyet">Non ancora</button><button id="bp_nncf_close">Chiudi</button></div>',document.body.appendChild(l);function i(){try{localStorage.setItem(n,String(c.id||c.end||Date.now()))}catch(d){}}function r(){try{l.remove()}catch(d){}}document.getElementById("bp_nncf_yes").onclick=function(){e(u,"cliente").then(function(){de("Stato cliente aggiornato")}).catch(function(){de("Impossibile aggiornare lo stato")}).finally(function(){i(),r()})},document.getElementById("bp_nncf_notyet").onclick=function(){e(u,"prospect").catch(function(){}).finally(function(){i(),r()})},document.getElementById("bp_nncf_close").onclick=function(){i(),r()}}function b(){var c=localStorage.getItem(n)||"";return fe("/api/appointments").then(function(u){var l=Date.now(),i=u&&u.appointments||[],r=i.filter(function(y){if(!y||!y.nncf)return!1;var A=+new Date(y.end||y.start||0);return A&&A<l-60*1e3}).sort(function(y,A){return+new Date(A.end||A.start||0)-+new Date(y.end||y.start||0)});if(r.length){var d=r[0],m=String(d.id||d.end||"");m&&c&&String(c)===m||o(d)}}).catch(function(u){})}var v=window.BPFinal=window.BPFinal||{};v.injectBannerCSS=t,v.updateClientStatusByName=e,v.scanNNCF=b,window.scanNNCF||(window.scanNNCF=b)})(),(function(){window.showUndo=window.showUndo||function(a,n,t){try{var e=document.getElementById("bp_undo_bar");e||(e=document.createElement("div"),e.id="bp_undo_bar",e.style.position="fixed",e.style.left="16px",e.style.bottom="16px",e.style.zIndex="9999",e.style.background="rgba(20,22,28,0.95)",e.style.color="#fff",e.style.padding="10px 12px",e.style.borderRadius="10px",e.style.boxShadow="0 8px 24px rgba(0,0,0,.25)",e.style.display="flex",e.style.alignItems="center",e.style.gap="12px",document.body.appendChild(e)),e.innerHTML="<span>"+a+'</span><button id="bp_undo_btn" class="ghost" style="background:#fff;color:#111;border-radius:8px;padding:6px 10px">Annulla</button>';var o=document.getElementById("bp_undo_btn"),b=setTimeout(function(){try{e.remove()}catch(v){}},t||5e3);o.onclick=function(){clearTimeout(b);try{e.remove()}catch(v){}typeof n=="function"&&Promise.resolve(n()).then(function(){Ee("medium");try{document.dispatchEvent(new Event("undo:performed"))}catch(v){}}).catch(function(){Ee("heavy")})},Ee("light")}catch(v){logger.error(v)}},window.pushUndo=window.pushUndo||function(a){if(!(!a||typeof a.undo!="function")){var n=a.label||"Annulla ultima operazione";window.showUndo(n,a.undo,a.ttl||5e3)}},window.wireCoachUndoHaptics=function(){function a(){try{window.__periodsCache&&Object.keys(window.__periodsCache).forEach(function(t){delete window.__periodsCache[t]}),delete window.periods}catch(t){}}document.addEventListener("bp:saved",function(){window.coachSay&&S("high"),Ee("heavy"),a()}),document.addEventListener("bp:deleted",function(){window.coachSay&&S("medium"),Ee("medium"),a()}),document.addEventListener("appt:saved",function(){window.coachSay&&S("medium"),Ee("medium")}),document.addEventListener("ics:exported",function(){window.coachSay&&S("low"),Ee("light")}),document.addEventListener("report:composed",function(){window.coachSay&&S("medium"),Ee("medium")}),document.addEventListener("client:converted",function(){window.coachSay&&S("high"),Ee("heavy")}),document.addEventListener("gi:created",function(){window.coachSay&&S("high"),Ee("heavy")}),document.addEventListener("payments:defined",function(){window.coachSay&&S("medium"),Ee("medium")}),document.addEventListener("user:profile-updated",function(){window.coachSay&&S("low"),Ee("light")}),document.addEventListener("appt:created",function(){window.coachSay&&S("medium"),Ee("medium")}),document.addEventListener("undo:performed",function(){window.coachSay&&S("low"),Ee("light")}),document.addEventListener("kpi:goal-80",function(){window.coachSay&&S("medium"),Ee("medium")}),document.addEventListener("kpi:goal-reached",function(){window.coachSay&&S("high"),Ee("heavy")}),document.addEventListener("click",function(t){try{for(var e=t.target,o=0;o<3&&e;o++){if(e.matches&&(e.matches('[data-close], [aria-label*="Chiudi" i], [aria-label*="Close" i]')||(e.id||"").toLowerCase().includes("close")||(e.className||"").toLowerCase().includes("close")||/^\s*(chiudi|close)\s*$/i.test(e.textContent||""))){window.coachSay&&S("low"),Ee("light");break}e=e.parentElement}}catch(b){}},!0);var n=document.getElementById("app")||document.body;n&&!n.__undoWired&&(n.__undoWired=!0,n.addEventListener("click",function(t){var e=t.target.closest("[data-delete], .btn-delete");if(e){var o=e.getAttribute("href"),b=e.getAttribute("data-id");(o||b)&&(t.preventDefault(),showUndo("Eliminato — Annulla",async function(){try{if(o){var v=o+(o.indexOf("?")>=0?"&":"?")+"undo=1";await fe(v)}else b&&await _e("/api/restore",{id:b});location.reload()}catch(c){logger.error(c)}}))}},!0))},window.wireHapticsUI=function(){var a=document.body;if(!a.__hapticsWired){a.__hapticsWired=!0,a.addEventListener("click",function(t){var e=t.target.closest('button, .button, .btn, .ghost, [role="button"], a.button, a.btn, [data-action]');if(e){var o="light";e.classList.contains("danger")||e.getAttribute("data-danger")==="1"?o="heavy":(e.classList.contains("primary")||e.getAttribute("data-primary")==="1")&&(o="medium"),Ee(o)}},!0),a.addEventListener("change",function(t){var e=t.target;e&&e.matches('select, input[type="checkbox"], input[type="radio"], input[type="range"]')&&Ee("light")},!0);var n=document.querySelector("[data-drawer-toggle], #menuToggle, .menu-toggle");n&&!n.__hW&&(n.__hW=!0,n.addEventListener("click",function(){Ee("light")},!0))}}})(),window.recomputeDashboardMini=typeof C=="function"?C:()=>{},window.recomputeCommsMini=typeof g=="function"?g:()=>{},window.recomputeTeamChart=typeof G=="function"?G:()=>{},window.ensureTeamUserSelect=typeof E=="function"?E:()=>{},window.attachICSButtons=typeof attachICSButtons=="function"?attachICSButtons:()=>{},window.addSaveAndExport=typeof addSaveAndExport=="function"?addSaveAndExport:()=>{},window.BPFinal=window.BPFinal||{},(function(a){function n(t,e){typeof e=="function"&&(a[t]=e,window[t]||(window[t]=e))}typeof C<"u"&&n("recomputeDashboardMini",C),typeof g<"u"&&n("recomputeCommsMini",g),typeof G<"u"&&n("recomputeTeamChart",G),typeof viewGI<"u"&&n("viewGI",viewGI),typeof E<"u"&&n("ensureTeamUserSelect",E),typeof attachICSButtons<"u"&&n("attachICSButtons",attachICSButtons),typeof addSaveAndExport<"u"&&n("addSaveAndExport",addSaveAndExport),typeof S<"u"&&n("coachSay",S),typeof ensureClientFilters<"u"&&n("ensureClientFilters",ensureClientFilters),typeof enrichClientCards<"u"&&n("enrichClientCards",enrichClientCards),typeof wireReportButtons<"u"&&n("wireReportButtons",wireReportButtons),typeof scanNNCF<"u"&&n("scanNNCF",scanNNCF),typeof ensureNNCFChip<"u"&&n("ensureNNCFChip",ensureNNCFChip),typeof R<"u"&&n("markToday",R),typeof q<"u"&&n("clampSlotCounters",q),typeof filterPastAppointments<"u"&&n("filterPastAppointments",filterPastAppointments),typeof openWeb<"u"&&n("openWeb",openWeb),typeof openApp<"u"&&n("openApp",openApp),typeof notifyConversion<"u"&&n("notifyConversion",notifyConversion),typeof icsFromAppt<"u"&&n("icsFromAppt",icsFromAppt),typeof downloadICS<"u"&&n("downloadICS",downloadICS),typeof fe<"u"&&n("GET",fe),typeof _e<"u"&&n("POST",_e)})(window.BPFinal);const k=new MutationObserver(()=>{typeof ensureNNCFChip=="function"&&ensureNNCFChip(),typeof addSaveAndExport=="function"&&addSaveAndExport(),typeof attachICSButtons=="function"&&attachICSButtons(),typeof wireReportButtons=="function"&&wireReportButtons(),typeof ensureClientFilters=="function"&&ensureClientFilters(),typeof enrichClientCards=="function"&&enrichClientCards(),typeof E=="function"&&E(),typeof w=="function"&&w(),typeof filterPastAppointments=="function"&&filterPastAppointments(document.body),typeof R=="function"&&R()});we(async()=>{typeof injectTodayCSS=="function"&&injectTodayCSS(),typeof R=="function"&&R(),typeof q=="function"&&q(),typeof I=="function"&&I(),typeof C=="function"&&await C(),typeof g=="function"&&await g(),typeof G=="function"&&await G(),typeof wireHapticsUI=="function"&&wireHapticsUI(),typeof wireCoachUndoHaptics=="function"&&wireCoachUndoHaptics(),typeof scanNNCF=="function"&&scanNNCF();try{const a="bpCoachGreetedDate",n=new Date().toISOString().slice(0,10);(localStorage.getItem(a)||"")!==n&&typeof window.coachSay=="function"&&(localStorage.setItem(a,n),S("low"))}catch(a){}k.observe(document.body,{childList:!0,subtree:!0}),window.onUnifiedRangeChange&&window.onUnifiedRangeChange(a=>{const n=a==="d"?"dash":a==="cm"?"comm":a==="tg"?"t":a;n==="dash"&&typeof C=="function"&&(C(),typeof renderDashboard=="function"&&renderDashboard()),n==="comm"&&typeof g=="function"&&g(),(n==="t"||n==="team")&&typeof G=="function"&&G()})})})();(function(){if(!window.GET)return;const p=window.GET;window.GET=function(s){try{if(typeof s=="string"&&s.indexOf("/api/leaderboard")===0){if(!(s.indexOf("/api/leaderboard_overall")===0)&&s.indexOf("indicator=")===-1)return Promise.resolve({ranking:[]});if(window.readUnifiedRange){var D=window.readUnifiedRange("lb")||{},Z=D.type==="ytd"||D.type==="ltm"?"mensile":D.type;Z&&(s+=(s.includes("?")?"&":"?")+"type="+encodeURIComponent(Z))}var j=document.getElementById("lb_mode"),W=j?j.value:"consuntivo";s+=(s.includes("?")?"&":"?")+"mode="+encodeURIComponent(W)}}catch(ee){}return p.apply(this,arguments)}})();(function(p){function s(D){const Z=window.BANNERS_LOOKBACK_DAYS||7,j="nncf",W="sale",ee=(g,G)=>"bp_snooze_".concat(G,"_").concat(g),te=(g,G)=>"bp_done_".concat(G,"_").concat(g),F=(g,G)=>{try{const I=localStorage.getItem(ee(g,G));return I&&new Date(I).getTime()>Date.now()}catch(I){return!1}},ie=(g,G)=>{try{const I=new Date;I.setDate(I.getDate()+1),localStorage.setItem(ee(g,G),I.toISOString())}catch(I){}},ne=(g,G)=>{try{return localStorage.getItem(te(g,G))==="1"}catch(I){return!1}},ye=(g,G)=>{try{localStorage.setItem(te(g,G),"1")}catch(I){}},we=window.BPFinal&&BPFinal.GET||window.GET,re=window.BPFinal&&BPFinal.POST||window.POST,oe=window.toast||(g=>alert(g));function ve(g){return String(g||"").replace(/[&<>\"]/g,G=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"})[G])}function de(){if(document.getElementById("bp-banner-css"))return;const g="\n      #bp_banner_host{position:fixed;left:16px;right:16px;bottom:16px;z-index:9999;display:flex;justify-content:center;pointer-events:none}\n      .bp-banner-card{pointer-events:auto;width:100%;max-width:720px;background:var(--card,#fff);color:var(--text,#111);\n        border:1px solid rgba(0,0,0,.12);border-radius:14px;box-shadow:0 10px 28px rgba(0,0,0,.28);padding:12px;display:flex;gap:12px;align-items:center;opacity:0;transform:translateY(8px);transition:opacity .2s,transform .2s}\n      .bp-banner-card.show{opacity:1;transform:none}\n      .bp-banner-card .msg{flex:1}.bp-banner-card .row{display:flex;gap:8px;align-items:center}\n      .bp-banner-card .ghost{background:rgba(0,0,0,.06);border:1px solid rgba(0,0,0,.12)}\n      @media (prefers-color-scheme: dark){ .bp-banner-card{background:rgba(15,18,28,.96);color:#fff;border-color:rgba(255,255,255,.16)}\n        .bp-banner-card .ghost{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.18)}}\n    ",G=document.createElement("style");G.id="bp-banner-css",G.textContent=g,document.head.appendChild(G)}function Ce(){let g=document.getElementById("bp_banner_host");return g||(g=document.createElement("div"),g.id="bp_banner_host",document.body.appendChild(g)),g}let fe=[],_e=!1;function Ue(g){fe.push(g),f()}function f(){if(_e)return;const g=fe.shift();if(!g)return;_e=!0,de();const G=Ce();G.innerHTML="";const I=g(R);G.appendChild(I),requestAnimationFrame(()=>I.classList.add("show"));function R(){G.innerHTML="",_e=!1,setTimeout(f,40)}}async function h(g,G){if(!g)return;const I=await we("/api/clients"),q=(I&&I.clients||[]).find(B=>String(B.name||"").trim().toLowerCase()===String(g).trim().toLowerCase());q&&await re("/api/clients",{id:q.id,status:G})}function $(g,G){const I=Number(g.vss||g.vsdPersonal||0)||0,R=g.client||"Cliente",q=document.createElement("div");q.className="modal",q.innerHTML='\n      <div class="card" style="min-width:min(380px,96vw);max-width:480px">\n        <div style="display:flex;justify-content:space-between;align-items:center">\n          <b>VSS per '.concat(ve(R),'</b>\n          <button class="ghost" id="vss_x">Chiudi</button>\n        </div>\n        <div class="row" style="margin-top:8px;gap:8px;align-items:flex-end;flex-wrap:wrap">\n          <div style="min-width:200px">\n            <label>Valore VSS</label>\n            <input id="vss_val" type="number" step="1" value="').concat(I,'">\n          </div>\n          <div class="muted small">Modifica consentita solo per VSS</div>\n        </div>\n        <div class="right" style="margin-top:12px">\n          <button id="vss_ok">Salva</button>\n        </div>\n      </div>'),document.body.appendChild(q);const B=()=>{try{q.remove()}catch(E){}};q.querySelector("#vss_x").onclick=B,q.querySelector("#vss_ok").onclick=async()=>{try{const E=Math.max(0,Number(q.querySelector("#vss_val").value||0));if(await re("/api/appointments",{id:g.id,vss:E}),D("medium"),oe("Appuntamento aggiornato"),B(),E>0)try{const w=await _(g,E);if(w&&(w.id||w._id)){const M=w.id||w._id;document.dispatchEvent(new CustomEvent("gi:edit",{detail:{id:M}}))}}catch(w){logger.error(w)}G&&typeof G.onSaved=="function"&&G.onSaved(E)}catch(E){logger.error(E),oe("Errore salvataggio VSS")}}}async function _(g,G){const I={apptId:g.id,date:new Date(g.end||g.start||Date.now()).toISOString(),clientName:g.client||"Cliente",vssTotal:Math.round(Number(G||0)),services:g.services||g.note||"",consultantId:g.userId||g.ownerId||null},R=await re("/api/gi",I);return R&&(R.sale||R.gi||R.data)||R}function z(g){return function(G){const I=document.createElement("div");return I.className="bp-banner-card",I.setAttribute("role","alertdialog"),I.setAttribute("aria-live","assertive"),I.innerHTML='<div class="msg"><b>Allora, hai venduto a '.concat(ve(g.client||"Cliente"),'?</b>\n           <div class="small muted">Appuntamento di vendita concluso</div></div>\n         <div class="row">\n           <button class="ghost" data-act="later">Posticipa</button>\n           <button class="ghost" data-act="no">No</button>\n           <button data-act="yes">Sì</button>\n         </div>'),I.querySelector('[data-act="yes"]').onclick=function(){G(),$(g,{onSaved:()=>ye(g.id,W)})},I.querySelector('[data-act="no"]').onclick=async function(){G();try{await re("/api/appointments",{id:g.id,vss:0}),ye(g.id,W),oe("Registrato: nessuna vendita")}catch(R){}},I.querySelector('[data-act="later"]').onclick=function(){ie(g.id,W),oe("Te lo ripropongo domani"),G()},I}}function P(g){return function(G){const I=document.createElement("div");return I.className="bp-banner-card",I.setAttribute("role","alertdialog"),I.setAttribute("aria-live","assertive"),I.innerHTML='<div class="msg"><b>È diventato cliente?</b> '.concat(ve(g.client||""),'</div>\n         <div class="row">\n           <button class="ghost" data-act="later">Posticipa</button>\n           <button class="ghost" data-act="no">No</button>\n           <button data-act="yes">Sì</button>\n         </div>'),I.querySelector('[data-act="yes"]').onclick=async function(){G();try{await h(g.client,"attivo")}catch(R){}$(g,{onSaved:()=>ye(g.id,j)})},I.querySelector('[data-act="no"]').onclick=async function(){G();try{await h(g.client,"lead non chiuso"),await re("/api/appointments",{id:g.id,vss:0}),ye(g.id,j),oe("Aggiornato: Lead non chiuso, VSS=0")}catch(R){}},I.querySelector('[data-act="later"]').onclick=function(){ie(g.id,j),oe("Te lo ripropongo domani"),G()},I}}async function C(){try{const g=await we("/api/appointments"),G=Date.now(),I=G-Z*24*60*60*1e3,R=g&&g.appointments||[];R.sort((q,B)=>+new Date(B.end||B.start||0)-+new Date(q.end||q.start||0)),R.forEach(q=>{try{const B=+new Date(q.end||q.start||0);if(!B||B>G||B<I)return;const E=String(q.type||"").toLowerCase()==="vendita"||Number(q.vss||0)>0||Number(q.vsdPersonal||0)>0;if(q.nncf){if(ne(q.id,j)||F(q.id,j))return;Ue(P(q))}else if(E){if(ne(q.id,W)||F(q.id,W))return;Ue(z(q))}}catch(B){}})}catch(g){}}window.scanBanners=C,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",C,{once:!0}):C();try{document.addEventListener("appt:saved",function(){setTimeout(C,50)})}catch(g){}try{document.addEventListener("visibilitychange",function(){document.hidden||setTimeout(C,50)})}catch(g){}try{setInterval(function(){C()},60*1e3)}catch(g){}}typeof p<"u"&&(p.initPostSaleBanners=s)})(typeof window<"u"?window:void 0);(function(){if(!("serviceWorker"in navigator)||!("PushManager"in window))return;function p(){try{const W=JSON.parse(localStorage.getItem("bp_user")||"null")||{};if(W.token)return W.token}catch(W){}return localStorage.getItem("bp_token")||localStorage.getItem("authToken")||localStorage.getItem("token")||""}function s(W){const ee="=".repeat((4-W.length%4)%4),te=(W+ee).replace(/-/g,"+").replace(/_/g,"/"),F=atob(te),ie=new Uint8Array(F.length);for(let ne=0;ne<F.length;ne++)ie[ne]=F.charCodeAt(ne);return ie}async function D(W){const ee=p();if(ee)try{await fetch("/api/push/subscribe",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+ee},body:JSON.stringify(W)})}catch(te){logger.warn("[BP] push subscribe error",te)}}async function Z(){try{const W=await navigator.serviceWorker.ready;let ee=await W.pushManager.getSubscription();if(!ee){const F=await(await fetch("/api/push/publicKey")).json(),ie=F.publicKey||F.key||"";if(!ie)return;ee=await W.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:s(ie)})}await D(ee.toJSON())}catch(W){logger.warn("[BP] push subscribe fail",W)}}async function j(){if(Notification.permission==="granted")return Z();if(Notification.permission==="default")try{if(await Notification.requestPermission()==="granted")return Z()}catch(W){}}window.BPPush={init:j,subscribe:Z},window.addEventListener("load",j)})();function Je(p,s){localStorage.setItem(p,typeof s=="string"?s:JSON.stringify(s))}function lt(p,s){const D=localStorage.getItem(p);if(D==null)return s;try{return JSON.parse(D)}catch(Z){return D}}function it(p){localStorage.removeItem(p)}function Ot(p,s){s?Je("bp_token",p):sessionStorage.setItem("bp_token",p)}function dt(){return localStorage.getItem("bp_token")||sessionStorage.getItem("bp_token")||""}function Vt(p){Je("bp_user",p)}function Te(){return lt("bp_user",null)||null}function Rt(){it("bp_token"),sessionStorage.removeItem("bp_token"),it("bp_user"),location.href="/?v=13"}function Ct(p,s={}){s.method=s.method||"GET";const D={...s.headers||{}},Z=dt();return Z&&(D.Authorization="Bearer "+Z),s.body!=null&&typeof s.body!="string"&&(D["Content-Type"]="application/json; charset=utf-8",s.body=JSON.stringify(s.body)),s.headers=D,fetch(p,s).then(jt)}async function jt(p){const s=await p.text();if(!p.ok)throw zt(s,p);return Yt(s,p)}function zt(p,s){try{const D=JSON.parse(p).error||"";return new Error(D||s.statusText||"HTTP "+s.status)}catch(D){return new Error(s.statusText||"HTTP "+s.status)}}function Yt(p,s){try{if((s.headers.get("content-type")||"").toLowerCase().indexOf("application/json")!==-1)return p?JSON.parse(p):{}}catch(D){}return p}function Ie(p,s){return Ct(p,Object.assign({method:"GET"},{}))}function qe(p,s){return Ct(p,{method:"POST",body:s||{}})}function He(p){return(p<10?"0":"")+p}function ot(p){const s=new Date(p);return He(s.getDate())+"/"+He(s.getMonth()+1)+"/"+s.getFullYear()}function Ne(p){const s=new Date(p);return s.getFullYear()+"-"+He(s.getMonth()+1)+"-"+He(s.getDate())}function _t(p){const s=new Date(p);return He(s.getHours())+":"+He(s.getMinutes())}function qt(p){const s=new Date(p);s.setHours(0,0,0,0);const D=(s.getDay()+6)%7;return s.setDate(s.getDate()-D),s}function ft(p){const s=new Date(p);return new Date(s.getFullYear(),s.getMonth(),1)}function gt(p){const s=new Date(p);return new Date(s.getFullYear(),s.getMonth()+1,0,23,59,59,999)}function Ae(p){const s=new Date(Date.UTC(p.getFullYear(),p.getMonth(),p.getDate())),D=s.getUTCDay()||7;s.setUTCDate(s.getUTCDate()+4-D);const Z=new Date(Date.UTC(s.getUTCFullYear(),0,1));return Math.ceil(((s-Z)/864e5+1)/7)}function ut(p){const s=new Date(p),D=Math.floor(s.getMonth()/3);return new Date(s.getFullYear(),D*3,1)}function ht(p){const s=ut(p);return new Date(s.getFullYear(),s.getMonth()+3,0,23,59,59,999)}function pt(p){const s=new Date(p),D=s.getMonth()<6?0:6;return new Date(s.getFullYear(),D,1)}function wt(p){const s=pt(p);return new Date(s.getFullYear(),s.getMonth()+6,0,23,59,59,999)}function bt(p){const s=new Date(p);return new Date(s.getFullYear(),0,1)}function ct(p){const s=new Date(p);return new Date(s.getFullYear(),11,31,23,59,59,999)}function Ht(p,s){const D=new Date(p,0,1+(s-1)*7),Z=D.getDay()||7,j=new Date(D);return j.setDate(D.getDate()-(Z-1)),j.setHours(0,0,0,0),j}function et(p,s){const D=Ht(p,s),Z=new Date(D);return Z.setDate(D.getDate()+6),Z.setHours(23,59,59,999),{start:D,end:Z}}function Gt(p){const s=qt(p);s.setDate(s.getDate()+7);const D=new Date(s);return D.setDate(s.getDate()+6),D.setHours(23,59,59,999),{start:s,end:D}}function Wt(p){const s=new Date(p.getFullYear(),p.getMonth()+1,1);return{start:s,end:new Date(s.getFullYear(),s.getMonth()+1,0,23,59,59,999)}}function $t(p){const s=ut(new Date(p.getFullYear(),p.getMonth()+3,1));return{start:s,end:new Date(s.getFullYear(),s.getMonth()+3,0,23,59,59,999)}}function Kt(p){const s=pt(new Date(p.getFullYear(),p.getMonth()+6,1));return{start:s,end:new Date(s.getFullYear(),s.getMonth()+6,0,23,59,59,999)}}function Jt(p){const s=bt(new Date(p.getFullYear()+1,0,1));return{start:s,end:ct(s)}}function rt(p,s){const D=new Date(s);return p==="settimanale"?"Sett. "+Ae(new Date(s))+" "+D.getFullYear():p==="mensile"?D.toLocaleString("it-IT",{month:"long",year:"numeric"}):p==="trimestrale"?"Trimestre "+(Math.floor(D.getMonth()/3)+1)+" "+D.getFullYear():p==="semestrale"?(D.getMonth()<6?"1°":"2°")+" semestre "+D.getFullYear():p==="annuale"?"Anno "+D.getFullYear():p==="ytd"?"YTD "+D.getFullYear():p==="ltm"?"Ultimi 12 mesi":p}let We;function Zt(){return We||(We=document.getElementById("toast-container"),We||(We=document.createElement("div"),We.id="toast-container",We.setAttribute("role","status"),We.setAttribute("aria-live","polite"),document.body.appendChild(We))),We}function me(p){const s=Zt(),D=document.createElement("div");D.className="toast",D.setAttribute("role","alert"),D.textContent=p,s.appendChild(D),setTimeout(function(){try{D.remove(),s.children.length||(s.remove(),We=null)}catch(Z){}},2200)}function st(){if(window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches)return;const p=document.createElement("div");p.className="confetti",document.body.appendChild(p);for(let s=0;s<26;s++){const D=document.createElement("span");D.style.position="absolute",D.style.left=2+s*4+"%",D.style.top="0",D.style.width="6px",D.style.height="10px",D.style.background="hsl("+s*14+",90%,60%)",D.style.opacity="0.95",p.appendChild(D),(function(Z,j){setTimeout(function(){Z.animate&&Z.animate([{transform:"translateY(-20px) rotate(0deg)"},{transform:"translateY(110vh) rotate(540deg)"}],{duration:1200+Math.random()*800,easing:"cubic-bezier(.2,.6,.2,1)"})},j)})(D,s*35)}setTimeout(function(){try{p.remove()}catch(s){}},2500)}function De(p){return String(p).replace(/[&<>'"]/g,function(s){return{"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"}[s]})}function Ke(p){return(Number(p)||0).toLocaleString("it-IT")+"€"}function Le(p){const s=Number(p)||0;return String(Math.round(s))}function Xt(){if(document.getElementById("bp-mobile-drawer-fix"))return;const p="\n  @media (max-width:980px){\n    .topbar{\n      background: rgba(20,24,34,.90) !important;\n      border-bottom: 1px solid rgba(255,255,255,.08) !important;\n    }\n    .drawer{\n      background: rgba(20,24,34,.96) !important;\n      box-shadow: 14px 0 28px rgba(0,0,0,.45) !important;\n      width: 86vw !important;\n      overflow-y: auto !important;\n    }\n    .drawer .row{ gap:10px !important; }\n    .drawer button{\n      background: rgba(255,255,255,.10) !important;\n      border: 1px solid rgba(255,255,255,.22) !important;\n      color: #fff !important;\n      padding: 12px 14px !important;\n      font-weight: 700 !important;\n      border-radius: 12px !important;\n      -webkit-tap-highlight-color: transparent;\n    }\n    .drawer button:hover{\n      background: rgba(255,255,255,.14) !important;\n      border-color: rgba(255,255,255,.30) !important;\n    }\n    .drawer button.ghost{\n      background: rgba(255,255,255,.10) !important;\n      box-shadow: none !important;\n    }\n  }",s=document.createElement("style");s.id="bp-mobile-drawer-fix",s.textContent=p,document.head.appendChild(s)}function Qt(){if(document.getElementById("bp-mobile-light-fix"))return;const p="\n    @media (max-width:980px) and (prefers-color-scheme: light){\n      .topbar{\n        background:#fff !important;\n        border-bottom:1px solid rgba(0,0,0,.08) !important;\n        box-shadow:none !important;\n      }\n      .topbar .brand .logo{\n        color:#0f172a !important;\n        font-weight:900 !important;\n        letter-spacing:.4px;\n        text-shadow:none !important;\n        opacity:1 !important;\n      }\n      .topbar .hamb span{ background:#0f172a !important; }\n      .card{\n        background:#fff !important;\n        background-image:none !important;\n        box-shadow:none !important;\n      }\n      .drawer{\n        background:#fff !important;\n        box-shadow:14px 0 28px rgba(0,0,0,.10) !important;\n      }\n      .drawer button{\n        color:#0f172a !important;\n        background:rgba(0,0,0,.04) !important;\n        border:1px solid rgba(0,0,0,.12) !important;\n      }\n      .drawer button:hover{\n        background:rgba(0,0,0,.08) !important;\n      }\n    }\n  ",s=document.createElement("style");s.id="bp-mobile-light-fix",s.textContent=p,document.head.appendChild(s)}function en(){if(document.getElementById("bp-badge-light-css"))return;const p="\n    @media (prefers-color-scheme: light){\n      .badge{\n        background: linear-gradient(180deg, #eef2ff, #f8fafc) !important;\n        border: 1px solid #c7d2fe !important;\n        color: #0f172a !important;\n        font-weight: 700 !important;\n        padding: 6px 10px !important;\n        border-radius: 9999px !important;\n        letter-spacing: .2px !important;\n        box-shadow: 0 1px 0 rgba(15,23,42,.05) inset !important;\n      }\n      .chip, .tag{\n        background: #ffffff !important;\n        border: 1px solid #cbd5e1 !important;\n        color: #0f172a !important;\n        font-weight: 600 !important;\n        border-radius: 9999px !important;\n      }\n      .card .badge{\n        background: #fff !important;\n      }\n    }\n  ",s=document.createElement("style");s.id="bp-badge-light-css",s.textContent=p,document.head.appendChild(s)}function Re(){const p=Te();if(!p)return"";const s=p.role==="admin",D='<span class="badge">Lvl '+(window.level?window.level():"")+" · XP "+(window.getXP?window.getXP():"")+"</span>",Z='<div id="drawer" class="drawer" role="dialog" aria-modal="true" aria-label="Menu"><div class="row"><button class="ghost" onclick="viewHome();toggleDrawer(false)">Dashboard</button><button class="ghost" onclick="viewCalendar();toggleDrawer(false)">Calendario</button><button class="ghost" onclick="viewPeriods();toggleDrawer(false)">BP</button><button class="ghost" onclick="viewAppointments();toggleDrawer(false)">Appuntamenti</button><button class="ghost" onclick="viewLeaderboard();toggleDrawer(false)">Classifiche</button><button class="ghost" onclick="viewCommissions();toggleDrawer(false)">Provvigioni</button><button class="ghost" onclick="viewVendite();toggleDrawer(false)">Vendite e Riordini</button><button class="ghost" onclick="viewGI();toggleDrawer(false)">GI &amp; Scadenzario</button><button class="ghost" onclick="viewReport();toggleDrawer(false)">Report</button><button class="ghost" onclick="viewClients();toggleDrawer(false)">Clienti</button><button class="ghost" onclick="viewTeam();toggleDrawer(false)">Squadra</button>'+(s?'<button class="ghost" onclick="viewUsers();toggleDrawer(false)">Utenti</button>':"")+'<button onclick="logout()">Logout</button></div></div>';return'<div class="topbar"><div class="brand"><button class="hamb" id="hamb" aria-label="Apri menu" aria-controls="drawer" aria-expanded="false"><span></span><span></span><span></span></button><div class="logo">BATTLE PLAN</div></div><div class="nav right">'+D+'<button class="ghost" onclick="viewHome()">Dashboard</button><button class="ghost" onclick="viewCalendar()">Calendario</button><button class="ghost" onclick="viewPeriods()">BP</button><button class="ghost" onclick="viewAppointments()">Appuntamenti</button><button class="ghost" onclick="viewLeaderboard()">Classifiche</button><button class="ghost" onclick="viewCommissions()">Provvigioni</button><button class="ghost" onclick="viewVendite()">Vendite e Riordini</button><button class="ghost" onclick="viewGI()">GI &amp; Scadenzario</button><button class="ghost" onclick="viewReport()">Report</button><button class="ghost" onclick="viewClients()">Clienti</button><button class="ghost" onclick="viewTeam()">Squadra</button>'+(s?'<button class="ghost" onclick="viewUsers()">Utenti</button>':"")+'<button onclick="logout()">Logout</button></div></div>'+Z}function Fe(){if(!Te())return;if(!document.getElementById("bp_nav_contrast_css")){const W="\n      @media (min-width: 1024px){\n        .topbar .nav .ghost{\n          background: rgba(255,255,255,.06);\n          border: 1px solid rgba(255,255,255,.18);\n        }\n        .topbar .nav .ghost:hover{\n          background: rgba(255,255,255,.12);\n        }\n      }\n    ",ee=document.createElement("style");ee.id="bp_nav_contrast_css",ee.textContent=W,document.head.appendChild(ee)}const p=document.getElementById("app"),s=document.querySelector(".topbar"),D=Re();s?s.outerHTML=D:p&&p.insertAdjacentHTML("afterbegin",D);try{Xt()}catch(W){}try{Qt()}catch(W){}try{en()}catch(W){}if(!document.getElementById("bp-unified-filters-css")){const W="\n      /* Nested inputs align in two columns inside unified filters */\n      .uf .row .row{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }\n\n      @media (max-width: 980px){\n        .uf input, .uf select{ min-width: 0; width: 100%; }\n        .uf .row > div{ flex: 1 1 180px; min-width: 0; }\n\n        /* Squadra admin bar: grid on small screens */\n        #t_adminbar{ display:grid !important; grid-template-columns: 1fr 1fr; align-items:end; gap:10px; }\n        #t_adminbar > div{ min-width: 0; }\n        #t_adminbar .row{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }\n      }\n\n      @media (max-width: 560px){\n        #t_adminbar{ grid-template-columns: 1fr; }\n      }\n    ",ee=document.createElement("style");ee.id="bp-unified-filters-css",ee.textContent=W,document.head.appendChild(ee)}const Z=document.getElementById("hamb");Z&&(Z.onclick=function(){mt()});const j=document.getElementById("drawer");j&&j.addEventListener("click",function(W){W.target.id==="drawer"&&mt(!1)}),document.removeEventListener("keydown",St,!1),document.addEventListener("keydown",St,!1)}function St(p){if(p&&p.key==="Escape"){const s=document.getElementById("drawer");s&&s.classList.contains("open")&&mt(!1)}}function mt(p){const s=document.getElementById("drawer");if(!s)return;const D=typeof p=="boolean"?p:!s.classList.contains("open");s.classList.toggle("open",D);const Z=document.getElementById("hamb");Z&&Z.setAttribute("aria-expanded",String(D)),document.body.classList.toggle("no-scroll",D)}let It=null;function tn(){clearTimeout(It),It=setTimeout(Fe,60)}function Ge(p){return document.querySelector(p)}function yt(p){return Array.from(document.querySelectorAll(p))}(function(){const p=window.BP=window.BP||{},s=p.ICS=p.ICS||{};function D(F){if(!F)return"";if(/[Zz]|[+\-]\d{2}:\d{2}$/.test(String(F)))return new Date(F).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z").slice(0,15)+"Z";const[ie,ne="00:00"]=String(F).split("T"),[ye,we,re]=ie.split("-").map(Number),[oe,ve]=ne.split(":").map(Number);return new Date(ye,we-1,re,oe,ve,0,0).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z").slice(0,15)+"Z"}function Z(F){return(F||"").replace(/\\/g,"\\\\").replace(/;/g,"\\;").replace(/,/g,"\\,").replace(/\n/g,"\\n")}function j(F){if(F.length<=74)return[F];const ne=[];let ye=0;for(;ye<F.length;){const we=F.slice(ye,ye+74);ne.push(ye===0?we:" "+we),ye+=74}return ne}function W(F){const ie=(F&&F.id||"bp-"+Date.now())+"@bpapp",ne=F&&F.client?"Appuntamento · "+F.client:"Appuntamento",ye=D(F&&F.start),we=D(F&&F.end),re=D(new Date().toISOString().slice(0,16)),oe=[];F&&F.type&&oe.push("Tipo: "+F.type),F&&F.vss&&oe.push("VSS: "+F.vss),F&&F.vsdPersonal&&oe.push("VSD Personale: "+F.vsdPersonal),F&&F.notes&&oe.push("Note: "+F.notes);const ve=Z(oe.join("\n")),de=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//BPApp//Calendario//IT","CALSCALE:GREGORIAN","METHOD:PUBLISH","BEGIN:VEVENT","UID:"+ie,"DTSTAMP:"+re,ye?"DTSTART:"+ye:"",we?"DTEND:"+we:"","SUMMARY:"+Z(ne),ve?"DESCRIPTION:"+ve:"","END:VEVENT","END:VCALENDAR"].filter(Boolean),Ce=[];return de.forEach(fe=>Ce.push.apply(Ce,j(fe))),Ce.join("\r\n")}function ee(){try{const F=navigator.userAgent||navigator.vendor||"",ie=/iP(ad|hone|od)/.test(F),ne=/^((?!chrome|android|crios|fxios|edgi).)*safari/i.test(F);return ie||ne}catch(F){return!1}}function te(F){try{const ie=W(F),ne=F&&F.start?String(F.start).split("T")[0]:"evento",ye=(F&&F.client||"appuntamento").trim().replace(/[^\w\-]+/g,"_").slice(0,40),we="bp_".concat(ye,"_").concat(ne,".ics");if(ee())try{const ve="data:text/calendar;charset=utf-8,"+encodeURIComponent(ie),de=document.createElement("a");return de.href=ve,de.setAttribute("target","_blank"),de.setAttribute("download",we),document.body.appendChild(de),de.click(),de.remove(),!0}catch(ve){try{return window.location.assign("data:text/calendar;charset=utf-8,"+encodeURIComponent(ie)),!0}catch(de){try{logger.error(de)}catch(Ce){}return!1}}const re=new Blob([ie],{type:"text/calendar;charset=utf-8"}),oe=document.createElement("a");return oe.href=URL.createObjectURL(re),oe.download=we,document.body.appendChild(oe),oe.click(),setTimeout(()=>{try{URL.revokeObjectURL(oe.href)}catch(ve){}oe.remove()},50),!0}catch(ie){try{logger.error(ie)}catch(ne){}return!1}}s.makeIcsForAppointment=W,s.downloadIcsForAppointment=te,window.icsFromAppt=window.icsFromAppt||function(F){return W(F)},window.downloadICS=window.downloadICS||function(F,ie){try{var ne=window.__icsSanitize?__icsSanitize(F):F||"evento";/\.ics$/i.test(ne)||(ne+=".ics");var ye=new Blob([ie],{type:"text/calendar;charset=utf-8"}),we=document.createElement("a");we.href=URL.createObjectURL(ye),we.download=ne,document.body.appendChild(we),we.click(),setTimeout(function(){URL.revokeObjectURL(we.href),we.remove()},50)}catch(re){logger.error(re)}}})();(function(){var p=document.getElementById("app");window.$1=window.$1||Ge,window.$all=window.$all||yt,window.addXP=window.addXP||function(){},typeof window.logger!="object"&&(window.logger=["debug","info","log","warn","error"].reduce((f,h)=>(f[h]=(console[h]||console.log).bind(console),f),{})),typeof window.haptic!="function"&&(window.haptic=function(){}),(function(){const f=window.__miniCharts=window.__miniCharts||{};function h(_,z,P){const C=_.getContext("2d");_.width=_.clientWidth||320,_.height=_.clientHeight||80,C.clearRect(0,0,_.width,_.height);const g=Math.max(1,...P),G=P.length>1?(_.width-8)/(P.length-1):0;C.strokeStyle="#2e6cff",C.lineWidth=2,C.beginPath();for(let I=0;I<P.length;I++){const R=4+I*G,q=_.height-6-P[I]/g*(_.height-12);I===0?C.moveTo(R,q):C.lineTo(R,q)}C.stroke(),C.fillStyle="#2e6cff";for(let I=0;I<P.length;I++){const R=4+I*G,q=_.height-6-P[I]/g*(_.height-12);C.beginPath(),C.arc(R,q,2,0,Math.PI*2),C.fill()}}function $(_,z){try{const P=Array.isArray(_)?_.length:0;if(!P)return{autoSkip:!0,maxRotation:0,minRotation:0};const C=Math.max(0,..._.map(I=>String(I||"").length)),g=Math.max(28,Math.min(90,Math.round(C*7)));return P*g>(z||320)*1.2?{autoSkip:!0,maxRotation:45,minRotation:45,callback:I=>String(I||"")}:{autoSkip:!0,maxRotation:0,minRotation:0,callback:I=>String(I||"")}}catch(P){return{autoSkip:!0,maxRotation:0,minRotation:0}}}window.computeTickOptions=$,window.drawFullLine=function(_,z,P){const C=document.getElementById(_);if(!C)return;if(C.width=C.clientWidth||C.width||320,C.height=C.clientHeight||C.height||80,typeof Chart>"u"){h(C,z,P);return}const g=String(_),G=$(z,C.width||320);if(f[g]&&f[g].canvas!==C){try{f[g].destroy()}catch(I){}delete f[g]}if(f[g]){const I=f[g];I.data.labels=z,I.data.datasets[0].data=P,I.options.scales.x.ticks=$(z,C.width||320),I.update()}else{const I=C.getContext("2d");f[g]=new Chart(I,{type:"line",data:{labels:z,datasets:[{label:"",data:P,borderColor:"#2e6cff",backgroundColor:"rgba(46,108,255,0.10)",borderWidth:2,tension:.3,pointRadius:3,pointHoverRadius:5,fill:!1}]},options:{responsive:!1,maintainAspectRatio:!1,animation:!1,animations:!1,plugins:{legend:{display:!1}},scales:{x:{grid:{display:!1},ticks:G},y:{beginAtZero:!0}}}})}}})();function s(){document.title="Battle Plan – Login";var f='<div class="hero" id="hero"><div class="layer glow"></div><div class="layer grid"></div><div class="title">Pianifica. Eroga. Vinci. <span class="small muted">BP – stile gaming</span></div></div><div class="wrap"><div class="grid"><div class="card"><h3>Accedi</h3><form id="loginForm" autocomplete="on"><div class="row"><div><label>Email</label><input id="li_email" name="email" type="email" autocomplete="username" required></div><div><label>Password</label><input id="li_password" name="password" type="password" autocomplete="current-password" required></div></div><div class="row"><label class="small"><input type="checkbox" id="li_remember" checked> Rimani collegato</label></div><div class="right" style="margin-top:8px"><button type="submit" id="btnLogin">Accedi</button></div></form></div><div class="card"><h3>Registrati</h3><form id="regForm" autocomplete="on"><div class="row"><div><label>Nome</label><input id="re_name" name="name" type="text" required></div><div><label>Email</label><input id="re_email" name="email" type="email" autocomplete="username" required></div><div><label>Password</label><input id="re_password" name="new-password" type="password" autocomplete="new-password" required></div></div><div class="right" style="margin-top:8px"><button type="submit" id="btnRegister">Registrati</button></div></form></div></div></div>';p.innerHTML=f;var h=document.getElementById("hero");h&&h.addEventListener("pointermove",function(z){var P=h.getBoundingClientRect();h.style.setProperty("--gx",(z.clientX-P.left)/P.width*100+"%"),h.style.setProperty("--gy",(z.clientY-P.top)/P.height*100+"%")});var $=document.getElementById("loginForm"),_=document.getElementById("regForm");$.addEventListener("submit",function(z){z.preventDefault();var P=document.getElementById("btnLogin");P.disabled=!0;var C=document.getElementById("li_email").value.trim().toLowerCase(),g=document.getElementById("li_password").value,G=document.getElementById("li_remember").checked;qe("/api/login",{email:C,password:g}).then(function(I){if(typeof I=="string")try{I=JSON.parse(I)}catch(R){}Ot(I.token,G),Vt(I.user),me("Bentornato "+I.user.name+"!"),window.addXP(10),ie(),Fe(),window.BPPush&&window.BPPush.subscribe()},function(I){me("Credenziali errate"),logger.error(I)}).catch(function(I){logger.error(I)}).finally(function(){P.disabled=!1})}),_.addEventListener("submit",function(z){z.preventDefault();var P=document.getElementById("btnRegister");P.disabled=!0;var C=document.getElementById("re_name").value.trim(),g=document.getElementById("re_email").value.trim().toLowerCase(),G=document.getElementById("re_password").value;qe("/api/register",{name:C,email:g,password:G}).then(function(){me("Registrazione ok. Ora accedi"),st(),window.addXP(20),window.scrollTo({top:0,behavior:"smooth"})}).catch(function(I){me("Email già registrata?"),logger.error(I)}).finally(function(){P.disabled=!1})})}function D(f){const h=new Date().getFullYear(),$=new Date().getMonth()+1,_=Ae(new Date);return'<div class="uf"><div class="row"><div><label>Granularità</label><select id="'+f+'_gran"><option value="settimanale">Settimanale</option><option value="mensile" selected>Mensile</option><option value="trimestrale">Trimestrale</option><option value="semestrale">Semestrale</option><option value="annuale">Annuale</option><option value="ytd">Anno corrente (YTD)</option><option value="ltm">Ultimi 12 mesi (LTM)</option></select></div><div id="'+f+'_wrap_week" style="display:none"><label>Settimana ISO</label><div class="row"><input type="number" id="'+f+'_week" min="1" max="53" value="'+_+'"><input type="number" id="'+f+'_year_w" min="2000" max="2100" value="'+h+'"></div></div><div id="'+f+'_wrap_month"><label>Mese</label><div class="row"><input type="number" id="'+f+'_month" min="1" max="12" value="'+$+'"><input type="number" id="'+f+'_year_m" min="2000" max="2100" value="'+h+'"></div></div><div id="'+f+'_wrap_quarter" style="display:none"><label>Trimestre</label><div class="row"><input type="number" id="'+f+'_quarter" min="1" max="4" value="'+Math.floor(($-1)/3)+1+'"><input type="number" id="'+f+'_year_q" min="2000" max="2100" value="'+h+'"></div></div><div id="'+f+'_wrap_sem" style="display:none"><label>Semestre</label><div class="row"><select id="'+f+'_sem"><option value="1">1°</option><option value="2">2°</option></select><input type="number" id="'+f+'_year_s" min="2000" max="2100" value="'+h+'"></div></div><div id="'+f+'_wrap_year" style="display:none"><label>Anno</label><input type="number" id="'+f+'_year" min="2000" max="2100" value="'+h+'"></div><div style="align-self:flex-end"><button id="'+f+'_refresh" class="ghost">Aggiorna</button></div></div></div>'}(function(){const f=[];window.onUnifiedRangeChange=function(h){typeof h=="function"&&f.push(h)},window.emitUnifiedRangeChange=function(h){for(const $ of f)try{$(h)}catch(_){logger.error(_)}}})();function Z(f){return f==="d"||f==="dash"?"dash":f==="cm"||f==="comm"?"comm":f==="tg"||f==="t"||f==="team"?"t":f}function j(f,h){function $(){const z=document.getElementById(f+"_gran").value;["week","month","quarter","sem","year"].forEach(C=>{const g=document.getElementById(f+"_wrap_"+C);g&&(g.style.display="none")}),z==="settimanale"?document.getElementById(f+"_wrap_week").style.display="":z==="mensile"?document.getElementById(f+"_wrap_month").style.display="":z==="trimestrale"?document.getElementById(f+"_wrap_quarter").style.display="":z==="semestrale"?document.getElementById(f+"_wrap_sem").style.display="":z==="annuale"&&(document.getElementById(f+"_wrap_year").style.display="")}["gran","week","year_w","month","year_m","quarter","year_q","sem","year_s","year"].forEach(z=>{const P=document.getElementById(f+"_"+z);P&&(P.onchange=()=>{$(),h&&h(),window.emitUnifiedRangeChange(Z(f))},P.oninput=()=>{$()})});const _=document.getElementById(f+"_refresh");_&&(_.onclick=()=>{h&&h(),window.emitUnifiedRangeChange(Z(f))}),$()}function W(f){var h=new Date;function $(H,S){var k=document.getElementById(f+"_"+H),a=k?parseInt(k.value,10):NaN;return isFinite(a)?a:S}var _=document.getElementById(f+"_gran"),z=_?_.value:"mensile",P={type:z,start:null,end:null};if(z==="settimanale"){var C=$("year_w",h.getFullYear()),g=Math.max(1,Math.min(53,$("week",Ae(h)))),G=et(C,g);return P.start=G.start,P.end=G.end,P}if(z==="mensile"){var I=$("year_m",h.getFullYear()),R=Math.max(1,Math.min(12,$("month",h.getMonth()+1)));return P.start=new Date(I,R-1,1),P.end=new Date(I,R,0,23,59,59,999),P}if(z==="trimestrale"){var q=$("year_q",h.getFullYear()),B=Math.max(1,Math.min(4,$("quarter",Math.floor(h.getMonth()/3)+1)));return P.start=new Date(q,(B-1)*3,1),P.end=new Date(q,B*3,0,23,59,59,999),P}if(z==="semestrale"){var E=$("year_s",h.getFullYear()),w=$("sem",h.getMonth()<6?1:2);return P.start=new Date(E,w===1?0:6,1),P.end=new Date(E,w===1?6:12,0,23,59,59,999),P}if(z==="annuale"){var M=$("year",h.getFullYear());return P.start=new Date(M,0,1),P.end=new Date(M,11,31,23,59,59,999),P}if(z==="ytd"){var O=new Date(h.getFullYear(),h.getMonth()+1,0,23,59,59,999);return P.start=new Date(h.getFullYear(),0,1),P.end=O,P}if(z==="ltm"){var L=new Date(h.getFullYear(),h.getMonth()+1,0,23,59,59,999),T=new Date(L.getFullYear(),L.getMonth()-11,1);return P.start=T,P.end=L,P}return P.type="mensile",P.start=new Date(h.getFullYear(),h.getMonth(),1),P.end=new Date(h.getFullYear(),h.getMonth()+1,0,23,59,59,999),P}function ee(f){return f==="ytd"||f==="ltm"?"mensile":f}window.effectivePeriodType=ee;function te(f,h){var $=ee(f||"mensile"),_=h?new Date(h):new Date,z=_.getUTCFullYear(),P=[];function C(r,d){P.push({s:r.getTime(),e:d.getTime()})}function g(r,d,m){return new Date(Date.UTC(r,d,m))}function G(r){return new Date(r.getTime()+24*3600*1e3-1)}function I(r,d){return new Date(Date.UTC(r,d+1,0))}if($==="settimanale"){var R=new Date(Date.UTC(_.getUTCFullYear(),_.getUTCMonth(),_.getUTCDate())),q=(R.getUTCDay()+6)%7;R.setUTCDate(R.getUTCDate()-q);for(var B=52;B>=0;B--){var E=new Date(R);E.setUTCDate(R.getUTCDate()-B*7);var w=new Date(E);w.setUTCDate(E.getUTCDate()+6),w.setUTCHours(23,59,59,999),C(E,w)}return P}if($==="mensile"){for(var M=new Date(Date.UTC(_.getUTCFullYear(),_.getUTCMonth(),1)),O=23;O>=0;O--){var L=new Date(Date.UTC(M.getUTCFullYear(),M.getUTCMonth()-O,1));C(L,G(I(L.getUTCFullYear(),L.getUTCMonth())))}return P}if($==="trimestrale"){for(var T=Math.floor(_.getUTCMonth()/3),H=11;H>=0;H--){var S=T-H,k=z+Math.floor(S/4),a=(S%4+4)%4,E=g(k,a*3,1),w=G(new Date(Date.UTC(k,a*3+3,0)));C(E,w)}return P}if($==="semestrale"){for(var n=_.getUTCMonth()<6?0:1,t=5;t>=0;t--){var e=n-t,o=z+Math.floor(e/2),b=(e%2+2)%2,v=b===0?0:6,c=g(o,v,1),u=G(new Date(Date.UTC(o,v+6,0)));C(c,u)}return P}for(var l=2;l>=0;l--){var i=z-l;C(g(i,0,1),G(new Date(Date.UTC(i,12,0))))}return P}function F(f,h){var $=ee(f||"mensile");return(h||[]).map(function(_){var z=new Date(_.s);return $==="settimanale"?"W"+Ae(z)+" "+z.getUTCFullYear():$==="mensile"?String(z.getUTCMonth()+1).padStart(2,"0")+"/"+z.getUTCFullYear():$==="trimestrale"?"Q"+(Math.floor(z.getUTCMonth()/3)+1)+" "+z.getUTCFullYear():$==="semestrale"?(z.getUTCMonth()<6?"S1 ":"S2 ")+z.getUTCFullYear():String(z.getUTCFullYear())})}function ie(){if(!Te())return s();document.title="Battle Plan – Dashboard",p.innerHTML=Re()+'<div class="wrap"><div class="card"><b>Filtro</b><div class="row" style="margin-top:6px;align-items:flex-end;gap:16px;flex-wrap:wrap"><div><label>Modalità</label><select id="dash_mode" name="mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div><div><label>Consulente</label><select id="dash_cons"><option value="">Tutti</option></select></div></div>'+D("dash")+'</div><div class="grid" id="kpiGrid"><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>VSS</b><span id="kpi_vss" class="big">—</span></div><canvas id="d_mini_vss" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>VSD personale</b><span id="kpi_vsd" class="big">—</span></div><canvas id="d_mini_vsdpersonale" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>VSD indiretto</b><span id="kpi_vsd_ind" class="big">—</span></div><canvas id="d_mini_vsdindiretto" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>GI</b><span id="kpi_gi" class="big">—</span></div><canvas id="d_mini_gi" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>NNCF</b><span id="kpi_nncf" class="big">—</span></div><canvas id="d_mini_nncf" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>Tot Provvigioni</b><span id="kpi_provv" class="big">—</span></div><canvas id="d_mini_provv" width="320" height="90"></canvas></div></div><div class="card"><b>Ultimi appuntamenti</b><div id="lastApps" class="row" style="margin-top:8px"></div></div><div class="card"><b>Ultimi BP inviati</b><div id="lastBPs" class="row" style="margin-top:8px"></div></div></div>',Fe();function f(w,M){var O=document.getElementById(w);O&&(O.textContent=M)}function h(w){var M=Number(w)||0;return M.toLocaleString("it-IT")+"€"}function $(w){var M=Number(w)||0;return String(Math.round(M))}function _(w){return String(w).replace(/[&<>'"]/g,M=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[M])}(function(){Ie("/api/usernames").then(function(M){var O=M&&M.users||[],L=document.getElementById("dash_cons");L&&(L.innerHTML='<option value="">Tutti</option>'+O.map(function(T){return'<option value="'+_(String(T.id))+'">'+_(T.name||T.email||"User #"+T.id)+"</option>"}).join(""))}).catch(function(){})})();function z(w,M){return M==="settimanale"?window.isoWeekNum?window.isoWeekNum(w):Math.ceil(w.getDate()/7):M==="mensile"||M==="ytd"||M==="ltm"?w.getMonth()+1:M==="trimestrale"?Math.floor(w.getMonth()/3)+1:M==="semestrale"?w.getMonth()<6?1:2:w.getFullYear()}function P(w){if(typeof te=="function")return(te(w,new Date)||[]).map(function(x){return{s:x.s,e:x.e}});var M=new Date,O=[];function L(x,U){O.push({s:x.getTime(),e:U.getTime()})}function T(x){var U=new Date(x);return U.setHours(23,59,59,999),U}function H(x,U){return new Date(x,U+1,0,23,59,59,999)}var S=String(w||"mensile").toLowerCase();if(S==="settimanale"){var k=new Date(M),a=(k.getDay()+6)%7;k.setDate(k.getDate()-a),k.setHours(0,0,0,0);for(var n=52;n>=0;n--){var t=new Date(k);t.setDate(t.getDate()-n*7);var e=new Date(t);e.setDate(t.getDate()+6),e.setHours(23,59,59,999),L(t,e)}return O}if(S==="mensile"||S==="ytd"||S==="ltm"){if(S==="ytd")for(var o=0;o<=M.getMonth();o++){var b=new Date(M.getFullYear(),o,1);L(b,H(M.getFullYear(),o))}else for(var v=S==="ltm"?12:24,c=new Date(M.getFullYear(),M.getMonth(),1),u=v-1;u>=0;u--){var t=new Date(c.getFullYear(),c.getMonth()-u,1);L(t,H(t.getFullYear(),t.getMonth()))}return O}if(S==="trimestrale"){for(var l=Math.floor(M.getMonth()/3)*3,i=new Date(M.getFullYear(),l,1),r=11;r>=0;r--){var d=new Date(i.getFullYear(),i.getMonth()-r*3,1);L(d,T(new Date(d.getFullYear(),d.getMonth()+3,0)))}return O}if(S==="semestrale"){for(var m=M.getMonth()<6?0:6,y=new Date(M.getFullYear(),m,1),t=5;t>=0;t--){var A=new Date(y.getFullYear(),y.getMonth()-t*6,1);L(A,T(new Date(A.getFullYear(),A.getMonth()+6,0)))}return O}for(var J=2;J>=0;J--){var ae=new Date(M.getFullYear()-J,0,1);L(ae,T(new Date(ae.getFullYear(),12,0)))}return O}function C(w){switch(String(w)){case"provv_gi":return"ProvvGI";case"provv_vsd":return"ProvvVSD";case"tot_provv":return"TotProvvigioni";default:return w}}function g(w,M,O,L){var T=L||W("dash"),H=String(T.type||"mensile").toLowerCase(),S=H==="ytd"||H==="ltm"?"mensile":H,k=P(H);function a(e,o){var b=new Date(o.startDate).getTime(),v=new Date(o.endDate).getTime();return b>=e.s&&v<=e.e}function n(e,o){if(!e)return 0;if(o==="VSDTotale")return Number(e.VSDPersonale||0)+Number(e.VSDIndiretto||0);if(o==="ProvvGI")return Number(e.ProvvGI||0);if(o==="ProvvVSD")return Number(e.ProvvVSD||0);if(o==="TotProvvigioni"){var b=e.TotProvvigioni;return Number(b!=null?b:Number(e.ProvvGI||0)+Number(e.ProvvVSD||0))}return Number(e[o]||0)}var t=(function(){var e=k.length?Ne(new Date(k[0].s)):Ne(new Date),o=k.length?Ne(new Date(k[k.length-1].e)):Ne(new Date),b="?global=1&type="+encodeURIComponent(S)+"&from="+encodeURIComponent(e)+"&to="+encodeURIComponent(o);return O&&(b+="&userId="+encodeURIComponent(O)),b})();return Ie("/api/periods"+t).catch(function(){return Ie("/api/periods"+t.replace("?global=1",""))}).then(function(e){var o=e&&e.periods||[],b=o.filter(function(u){return!(u.type!==S||O&&String(u.userId||u.uid||"")!==String(O))}),v=C(w),c=k.map(function(u){for(var l=0,i=0;i<b.length;i++){var r=b[i];if(a(u,r)){var d=M==="previsionale"?r.indicatorsPrev||{}:r.indicatorsCons||{};l+=n(d,v)}}return{x:new Date(u.s),y:Math.round(l*100)/100}});return c})}function G(w,M,O){var L=document.getElementById(w);if(L){if(typeof window.drawFullLine=="function"){window.drawFullLine(w,M,O);return}var T=L.getContext("2d");L.width=L.clientWidth||320,L.height=L.clientHeight||80,T.clearRect(0,0,L.width,L.height);var H=Math.max(1,...O),S=O.length>1?(L.width-8)/(O.length-1):0;T.strokeStyle="#2e6cff",T.lineWidth=2,T.beginPath();for(var k=0;k<O.length;k++){var a=4+k*S,n=L.height-6-O[k]/H*(L.height-12);k===0?T.moveTo(a,n):T.lineTo(a,n)}T.stroke()}}function I(){var w=(document.getElementById("dash_mode")||{}).value||"consuntivo",M=W("dash"),O=ee(M.type||"mensile"),L=new Date(M.start).getTime(),T=new Date(M.end).getTime(),H=(document.getElementById("dash_cons")||{}).value||"";function S(t){return t=Number(t==null?"":t),isFinite(t)?t:0}function k(t){if(!t)return 0;for(var e=["VSDIndiretto","vsdIndiretto","VSD_indiretto","VSDI"],o=0;o<e.length;o++)if(t[e[o]]!=null)return S(t[e[o]]);return t.VSDTotale!=null&&t.VSDPersonale!=null?S(t.VSDTotale)-S(t.VSDPersonale):0}function a(t){return t?t.TotProvvigioni!=null?S(t.TotProvvigioni):S(t.ProvvGI)+S(t.ProvvVSD):0}var n=(function(){var t=Ne(new Date(L)),e=Ne(new Date(T)),o="?type="+encodeURIComponent(O)+"&from="+encodeURIComponent(t)+"&to="+encodeURIComponent(e);return H&&(o+="&userId="+encodeURIComponent(H)),o})();return Ie("/api/periods"+n).then(function(t){for(var e=t&&t.periods||[],o={VSS:0,VSDPersonale:0,VSDIndiretto:0,GI:0,NNCF:0,PROVV:0},b=0;b<e.length;b++){var v=e[b];if(String(v.type)===String(O)&&!(H&&String(v.userId||v.uid||"")!==String(H))){var c=new Date(v.startDate).getTime(),u=new Date(v.endDate).getTime();if(!(c<L||u>T)){var l=w==="previsionale"?v.indicatorsPrev||{}:v.indicatorsCons||{};o.VSS+=S(l.VSS),o.VSDPersonale+=S(l.VSDPersonale),o.VSDIndiretto+=k(l),o.GI+=S(l.GI),o.NNCF+=S(l.NNCF),o.PROVV+=a(l)}}}f("kpi_vss",h(o.VSS)),f("kpi_vsd",h(o.VSDPersonale)),f("kpi_vsd_ind",h(o.VSDIndiretto)),f("kpi_gi",h(o.GI)),f("kpi_nncf",$(o.NNCF)),f("kpi_provv",h(o.PROVV))})}function R(){var w=(document.getElementById("dash_mode")||{}).value||"consuntivo",M=(document.getElementById("dash_cons")||{}).value||"",O=W("dash"),L=String(O.type||"mensile").toLowerCase(),T=P(L),H=typeof F=="function"?F(L,T):T.map(function(k){return z(new Date(k.s),L)});function S(k,a){var n=k.map(function(t){return t.y});G(a,H,n)}Promise.all([g("VSS",w,M||null,O),g("VSDPersonale",w,M||null,O),g("VSDIndiretto",w,M||null,O),g("GI",w,M||null,O),g("NNCF",w,M||null,O),g("TotProvvigioni",w,M||null,O)]).then(function(k){S(k[0],"d_mini_vss"),S(k[1],"d_mini_vsdpersonale"),S(k[2],"d_mini_vsdindiretto"),S(k[3],"d_mini_gi"),S(k[4],"d_mini_nncf"),S(k[5],"d_mini_provv")}).catch(function(k){logger.error(k)})}function q(){var w=(document.getElementById("dash_cons")||{}).value||"";(function(){var a=document.getElementById("lastApps");if(a){var n=a.parentElement;if(!document.getElementById("nextApps")){var t=document.createElement("div");t.className="card",t.innerHTML='<b>Prossimi appuntamenti (oggi + domani)</b><div id="nextApps" style="margin-top:8px"></div>',n.parentElement.insertBefore(t,n)}}})();function M(k){return'<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px">'+k+"</div>"}function O(k){return k=String(k||"").toLowerCase(),k.indexOf("mezza")>-1?240:k.indexOf("giorn")>-1||k.indexOf("formaz")>-1||k.indexOf("mbs")>-1?570:k.indexOf("sottoprod")>-1?240:(k.indexOf("vend")>-1,90)}function L(k){var a=new Date(k.start),n=new Date(k.end);(!(n instanceof Date)||isNaN(n)||n<a)&&(n=new Date(a.getTime()+O(k.type||"vendita")*6e4));var t=ot(a)+" "+_t(a)+"–"+(("0"+n.getHours()).slice(-2)+":"+("0"+n.getMinutes()).slice(-2)),e=k.nncf?" · NNCF ✅":"",o=String(k.type||"").toLowerCase(),b;return o.indexOf("mbs")>-1?b="VSD ind "+h(k.vsdIndiretto||0):o.indexOf("sottoprod")>-1?b="Tel "+$(k.telefonate||0)+" · AppFissati "+$(k.appFissati||0):o.indexOf("formaz")>-1?b="":b="VSS "+h(k.vss||0)+" · VSD "+h(k.vsdPersonal||0)+e,'<div class="card lastApp" data-aid="'+_(String(k.id||""))+'" style="cursor:pointer"><div class="small muted">'+_(t)+" · "+_(k.type||"manuale")+'</div><div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><div><b>'+_(k.client||"")+'</b></div><div class="row" style="gap:6px"><button class="ghost btn-ics" title="Esporta .ics" data-ics="'+_(String(k.id||""))+'">📅</button></div></div>'+(b?'<div class="small">'+b+"</div>":"")+"</div>"}function T(k){return k&&Object.keys(k).length>0}function H(k){return k=Number(k||0),isFinite(k)?k:0}var S=(function(){var k=Ne(new Date(rDash.start)),a=Ne(new Date(rDash.end)),n="?type="+encodeURIComponent(typeDash)+"&from="+encodeURIComponent(k)+"&to="+encodeURIComponent(a);return w&&(n+="&userId="+encodeURIComponent(w)),n})();Promise.all([Ie("/api/appointments"),Ie("/api/periods"+S)]).then(function(k){var a=k[0]&&k[0].appointments||[],n=k[1]&&k[1].periods||[],t=(typeof W=="function"?W("dash"):{})||{},e=typeof ee=="function"?ee(t.type||"mensile"):t.type||"mensile";(function(){var b=document.getElementById("nextApps");if(b){var v=new Date,c=new Date(v.getFullYear(),v.getMonth(),v.getDate(),0,0,0,0),u=new Date(v.getFullYear(),v.getMonth(),v.getDate()+2,0,0,0,0),l=a.filter(function(i){var r=new Date(i.start).getTime(),d=r>=c.getTime()&&r<u.getTime(),m=w?String(i.userId||i.uid||"")===String(w):!0;return d&&m}).sort(function(i,r){return new Date(i.start)-new Date(r.start)});b.innerHTML=l.length?M(l.map(L).join("")):'<div class="muted">Nessun appuntamento tra oggi e domani</div>',b.querySelectorAll(".lastApp[data-aid]").forEach(function(i){i.addEventListener("click",function(){try{Je("bp_edit_aid",i.getAttribute("data-aid"))}catch(r){}we()})}),b.querySelectorAll("button[data-ics]").forEach(function(i){i.addEventListener("click",function(r){r.stopPropagation();var d=i.getAttribute("data-ics"),m=l.find(y=>String(y.id)===String(d))||a.find(y=>String(y.id)===String(d));if(!m){me("Appuntamento non trovato");return}if(window.BP&&BP.ICS&&typeof BP.ICS.downloadIcsForAppointment=="function")if(BP.ICS.downloadIcsForAppointment(m)){typeof haptic=="function"&&haptic("medium");try{document.dispatchEvent(new Event("ics:exported"))}catch(A){}me(".ics esportato")}else me("Export .ics non disponibile");else me("Export .ics non disponibile")})})}})(),(function(){var b=document.getElementById("lastApps");if(b){var v=a.filter(function(c){return w?String(c.userId||c.uid||"")===String(w):!0}).sort(function(c,u){return new Date(u.start)-new Date(c.start)}).slice(0,6);b.innerHTML=v.length?M(v.map(L).join("")):'<div class="muted">Nessun appuntamento</div>',b.querySelectorAll(".lastApp[data-aid]").forEach(function(c){c.addEventListener("click",function(){try{Je("bp_edit_aid",c.getAttribute("data-aid"))}catch(u){}we()})}),b.querySelectorAll("button[data-ics]").forEach(function(c){c.addEventListener("click",function(u){u.stopPropagation();var l=c.getAttribute("data-ics"),i=v.find(r=>String(r.id)===String(l))||a.find(r=>String(r.id)===String(l));if(!i){me("Appuntamento non trovato");return}if(window.BP&&BP.ICS&&typeof BP.ICS.downloadIcsForAppointment=="function")if(BP.ICS.downloadIcsForAppointment(i)){typeof haptic=="function"&&haptic("medium");try{document.dispatchEvent(new Event("ics:exported"))}catch(d){}me(".ics esportato")}else me("Export .ics non disponibile");else me("Export .ics non disponibile")})})}})(),(function(){var b=document.getElementById("lastBPs");if(b){var v=n.filter(function(u){return!(String(u.type)!==String(e)||w&&String(u.userId||u.uid||"")!==String(w))}).sort(function(u,l){return new Date(l.endDate)-new Date(u.endDate)}).slice(0,3),c=v.map(function(u){var l=rt(u.type,u.startDate),i=u.indicatorsPrev||{},r=u.indicatorsCons||{},d=T(r),m=d?r:i,y=H(m.VSS),A=H(m.VSDPersonale),J=H(m.VSDIndiretto),ae=H(m.GI),x=H(m.NNCF),U=A+J;return'<div class="card lastBP" data-pid="'+_(String(u.id||""))+'" style="cursor:pointer;flex:1 1 320px"><div style="display:flex;align-items:center;gap:8px"><div><b>'+_(l)+'</b></div><span class="chip small">'+(d?"Consuntivo":"Previsionale")+'</span></div><div class="row" style="margin-top:6px;gap:8px;flex-wrap:wrap"><span class="chip small">VSS <b>'+h(y)+'</b></span><span class="chip small">VSD <b>'+h(U)+'</b> <span class="muted">(P '+h(A)+" · I "+h(J)+')</span></span><span class="chip small">GI <b>'+h(ae)+'</b></span><span class="chip small">NNCF <b>'+$(x)+"</b></span></div></div>"}).join("");b.innerHTML=c?M(c):'<div class="muted">Nessun BP</div>',b.querySelectorAll(".lastBP[data-pid]").forEach(function(u){u.addEventListener("click",function(){try{Je("bp_open_period",{id:u.getAttribute("data-pid"),mode:!1})}catch(l){}ye()})})}})()}).catch(function(k){logger.error(k)})}j("dash",function(){typeof haptic=="function"&&haptic("light"),I(),R(),q()});var B=document.getElementById("dash_mode");B&&(B.onchange=function(){typeof haptic=="function"&&haptic("light"),I(),R(),q()});var E=document.getElementById("dash_cons");E&&(E.onchange=function(){typeof haptic=="function"&&haptic("light"),I(),R(),q()}),I(),R(),q(),typeof kickFinal=="function"&&kickFinal("dashboard")}function ne(){if(!Te())return s();document.title="Battle Plan – Calendario";function f(q){return _t(q)}if(!document.getElementById("cal_dynamic_css")){var h="\n      /* ============== CALENDAR ============== */\n      #cal_container{ overflow-x:auto; -webkit-overflow-scrolling:touch; }\n      #cal_container .calendar{ min-width: 860px; }\n\n      .calendar{ display:grid; grid-template-columns: 44px repeat(7, 1fr); gap:10px; }\n      .calendar .weekLabel{ color:var(--muted); font-size:12px; display:flex; align-items:center; justify-content:center; }\n\n      .calendar .day{\n        min-height:120px; background: var(--card);\n        border:2px solid var(--hair2); border-radius:14px; padding:8px;\n        display:flex; flex-direction:column; gap:3px; overflow:hidden;\n      }\n      .calendar .day.today{\n        outline: 2px solid var(--accent);\n        box-shadow: 0 0 0 2px rgba(0,0,0,.06) inset;\n      }\n      .calendar .day .dnum{ font-weight:800; }\n      .calendar .day .small{\n        font-size:12px; line-height:1.15;\n        white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:100%;\n      }\n      .calendar .day .tag{ padding:2px 6px; border-radius:999px; border:1px solid var(--hair2); font-size:11px; align-self:flex-start; }\n      .calendar .day.busy0{ border-color:#27ae60; background:rgba(39,174,96,.08); }\n      .calendar .day.busy1{ border-color:#ff9f1a; background:rgba(255,159,26,.10); }\n      .calendar .day.busy2{ border-color:#7d1731; background:rgba(125,23,49,.12); }\n      .calendar .day.dense .small{ font-size:11px; line-height:1.1; }\n      .calendar .day.dense .tag{ transform:scale(.9); transform-origin:left top; }\n\n      @media (max-width: 900px){\n        .calendar{ grid-template-columns: 36px repeat(7, 1fr); }\n        .calendar .weekLabel{ display:flex !important; font-size:11px; }\n        .calendar .day{ min-height:92px; padding:6px; }\n        .calendar .day .dnum{ font-size:16px; }\n        .calendar .day .small{ white-space: normal !important; overflow: visible !important; text-overflow: clip !important; }\n        .calendar .day.dense .small{ font-size:clamp(9px,2.4vw,11px); }\n        .calendar .day .tag{ font-size:10px; }\n      }\n\n      .cal-filters .chip{\n        display:inline-flex; align-items:center; gap:6px;\n        padding:6px 10px; border-radius:999px; border:1px solid var(--hair2);\n      }\n    ",$=document.createElement("style");$.id="cal_dynamic_css",$.textContent=h,document.head.appendChild($)}var _=new Date,z=Ne(ft(_)).slice(0,7);p.innerHTML=Re()+'<div class="wrap"><div class="card"><div class="row" style="align-items:flex-end;gap:12px;flex-wrap:wrap"><div class="row" style="align-items:flex-end;gap:8px"><button id="cal_prev" class="ghost" title="Mese precedente">◀</button><div><label>Mese</label><input type="month" id="cal_month" value="'+z+'"></div><button id="cal_next" class="ghost" title="Mese successivo">▶</button></div><div class="cal-filters"><label class="chip small"><input type="checkbox" id="only_free"> Solo giorni liberi</label> <label class="chip small"><input type="checkbox" id="only_4h"> Solo slot ≥ 4h</label></div><button id="cal_add" class="ghost">Aggiungi appuntamento</button><div class="right" style="margin-left:auto"><button id="cal_refresh" class="ghost">Aggiorna</button></div></div></div><div id="cal_container"></div><div id="cal_results" class="card" style="margin-top:8px;display:none"></div><div id="cal_day_box" class="card" style="margin-top:8px;display:none"></div><div class="card" id="cal_free_slots" style="margin-top:8px;display:none"></div></div>',Fe();function P(q,B,E){Promise.all([Ie("/api/appointments"),Ie("/api/availability?from="+q+"-"+He(B)+"-01&to="+q+"-"+He(B)+"-"+He(new Date(q,B,0).getDate()))]).then(function(w){var M=w[0]&&w[0].appointments?w[0].appointments:[],O=w[1]||{slots:[]},L=O.slots||[],T=new Date(q,B-1,1),H=new Date(q,B,0,23,59,59,999);function S(K,X){for(var Q={vss:0,vsd:0,vsdI:0,telefonate:0,appFissati:0,nncf:0,count:0},pe=0;pe<M.length;pe++){var ue=M[pe],xe=new Date(ue.start);xe>=K&&xe<=X&&(Q.vss+=Number(ue.vss||0),Q.vsd+=Number(ue.vsdPersonal||0),Q.vsdI+=Number(ue.vsdIndiretto||0),Q.telefonate+=Number(ue.telefonate||0),Q.appFissati+=Number(ue.appFissati||0),Q.nncf+=ue.nncf?1:0,Q.count+=1)}return Q}function k(K,X,Q){var pe=document.getElementById("cal_results");if(pe){var ue=Q?'<div class="right"><button id="res_reset" class="ghost">Torna al mese</button></div>':"";if(pe.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center"><b>Risultati · '+X+"</b>"+ue+'</div><div class="row" style="margin-top:8px;gap:8px;flex-wrap:wrap"><span class="chip small">VSS <b>'+Ke(K.vss)+'</b></span><span class="chip small">VSD <b>'+Ke(K.vsd)+'</b></span><span class="chip small">VSD ind <b>'+Ke(K.vsdI)+'</b></span><span class="chip small">Tel <b>'+Le(K.telefonate)+'</b></span><span class="chip small">AppFiss <b>'+Le(K.appFissati)+'</b></span><span class="chip small">NNCF <b>'+Le(K.nncf)+'</b></span><span class="chip small">N. app <b>'+Le(K.count)+"</b></span></div>",pe.style.display="block",Q){var xe=document.getElementById("res_reset");xe&&(xe.onclick=function(){k(S(T,H),v,!1)})}}}for(var a={},n=0;n<M.length;n++){var t=M[n],e=new Date(t.start);if(!(e<T||e>H)){var o=Ne(e);a[o]||(a[o]={vss:0,vsd:0,vsdI:0,telefonate:0,appFissati:0,nncf:0,mins:0,count:0,items:[]}),a[o].vss+=Number(t.vss||0),a[o].vsd+=Number(t.vsdPersonal||0),a[o].vsdI+=Number(t.vsdIndiretto||0),a[o].telefonate+=Number(t.telefonate||0),a[o].appFissati+=Number(t.appFissati||0),a[o].nncf+=t.nncf?1:0,a[o].mins+=Number(t.durationMinutes||0),a[o].count+=1,a[o].items.push(t)}}var b=["Lun","Mar","Mer","Gio","Ven","Sab","Dom"],v=new Date(q,B-1,1).toLocaleString("it-IT",{month:"long",year:"numeric"}),c='<div class="card"><b class="neon">'+v+"</b></div>";c+='<div class="calendar">',c+='<div class="weekLabel">W</div>';for(var u=0;u<7;u++)c+='<div class="weekLabel">'+b[u]+"</div>";var l=new Date(q,B-1,1),i=(l.getDay()+6)%7,r=new Date(l);r.setDate(l.getDate()-i);for(var d=0;d<6;d++){var m=new Date(r),y="W"+Ae(m);c+='<div class="weekLabel" data-ws="'+Ne(m)+'" style="cursor:pointer">'+y+"</div>";for(var A=0;A<7;A++){var J=r.getMonth()===B-1,o=Ne(r),ae=a[o]||{vss:0,vsd:0,vsdI:0,telefonate:0,appFissati:0,nncf:0,mins:0,count:0,items:[]},x=r.getDay(),U=x===0||x===6,se=!U&&L.some(function(X){return X.date===o});if(J&&E){if(E.only_free&&ae.count>0){c+="<div></div>",r.setDate(r.getDate()+1);continue}if(E.only_4h&&!se){c+="<div></div>",r.setDate(r.getDate()+1);continue}}if(!J)c+="<div></div>";else{var Y="";U?ae.count>0&&(Y="busy2"):ae.count===0?Y="busy0":se?Y="busy1":Y="busy2";var le="",ce=0;U&&ae.count===0||(ae.vss>0&&(le+='<div class="small">VSS '+Ke(ae.vss)+"</div>",ce++),ae.vsd>0&&(le+='<div class="small">VSD '+Ke(ae.vsd)+"</div>",ce++),ae.vsdI>0&&(le+='<div class="small">VSD ind '+Ke(ae.vsdI)+"</div>",ce++),ae.telefonate>0&&(le+='<div class="small">Tel '+Le(ae.telefonate)+"</div>",ce++),ae.appFissati>0&&(le+='<div class="small">AppFiss '+Le(ae.appFissati)+"</div>",ce++),ae.nncf>0&&(le+='<div class="small">NNCF '+Le(ae.nncf)+"</div>",ce++),ae.count>0&&(le+='<div class="small">App. '+Le(ae.count)+"</div>",ce++),se&&(le+='<div class="tag" style="margin-top:4px">slot ≥4h</div>',ce++));var ge=ce>=3?" dense":"",Se=se?" slot-free":"";c+='<div class="day '+Y+ge+Se+'" data-day="'+o+'" title="Settimana '+Ae(r)+'"><div class="dnum">'+r.getDate()+"</div>"+(le||"")+"</div>"}r.setDate(r.getDate()+1)}}c+="</div>",document.getElementById("cal_container").innerHTML=c,k(S(T,H),v,!1),document.querySelectorAll(".calendar .weekLabel[data-ws]").forEach(function(K){K.addEventListener("click",function(){var X=K.getAttribute("data-ws"),Q=new Date(X),pe=new Date(Q);pe.setDate(pe.getDate()+6),pe.setHours(23,59,59,999);var ue="Settimana "+("W"+Ae(Q))+" · "+ot(Q)+"–"+ot(pe);k(S(Q,pe),ue,!0)})}),document.querySelectorAll(".day[data-day]").forEach(function(K){K.addEventListener("click",function(){var X=K.getAttribute("data-day"),Q=a[X]&&a[X].items?a[X].items.slice():[];Q.sort(function(je,Qe){return new Date(je.start)-new Date(Qe.start)});var pe=document.getElementById("cal_day_box"),ue="<b>Appuntamenti del "+X.split("-").reverse().join("/")+"</b>";if(!Q.length)ue+='<div class="muted" style="margin-top:6px">Nessun appuntamento</div>';else{ue+='<div class="row" style="margin-top:8px">';for(var xe=0;xe<Q.length;xe++){var he=Q[xe],ke=' data-start="'+he.start+'" data-end="'+he.end+'" data-title="'+De(he.client||"Appuntamento")+'" ',ze=String(he.type||"").toLowerCase(),Ye;ze.indexOf("mbs")>-1?Ye="VSD ind "+Ke(he.vsdIndiretto||0):ze.indexOf("sottoprod")>-1?Ye="Tel "+Le(he.telefonate||0)+" · AppFissati "+Le(he.appFissati||0):ze.indexOf("formaz")>-1?Ye="":Ye="VSS "+Ke(he.vss)+" · VSD "+Ke(he.vsdPersonal)+" · NNCF "+(he.nncf?"✅":"—"),ue+='<div class="card cal-app" data-aid="'+he.id+'" '+ke+' style="flex:1 1 320px;cursor:pointer"><div class="small muted">'+f(he.start)+"–"+f(he.end)+" · "+De(he.type||"")+"</div><div><b>"+De(he.client||"")+"</b></div>"+(Ye?'<div class="small">'+Ye+"</div>":"")+(he.notes?'<div class="small muted">'+De(he.notes)+"</div>":"")+"</div>"}ue+="</div>"}var nt=(L||[]).filter(function(je){return je.date===X});if(nt.length){ue+='<div class="row" style="margin-top:8px">';for(var at=0;at<nt.length;at++){var Ze=nt[at],Xe=Ze.part==="morning"?"mattina":"pomeriggio";ue+='<div class="card slotBtn" data-start="'+Ze.start+'" data-end="'+Ze.end+'" style="flex:1 1 280px;cursor:pointer"><div class="small">'+Xe+" · "+f(Ze.start)+"–"+f(Ze.end)+"</div></div>"}ue+="</div>"}if(pe.style.display="block",pe.innerHTML=ue,pe.querySelectorAll(".cal-app").forEach(function(je){je.addEventListener("click",function(Qe){Qe.stopPropagation(),Je("bp_edit_aid",je.getAttribute("data-aid")),we()})}),pe.querySelectorAll(".slotBtn").forEach(function(je){je.addEventListener("click",function(Qe){Qe.stopPropagation(),Je("bp_prefill_slot",{start:je.getAttribute("data-start"),end:je.getAttribute("data-end")}),we(),me("Slot precompilato negli appuntamenti")})}),window.scrollTo({top:pe.getBoundingClientRect().top+window.scrollY-80,behavior:"smooth"}),typeof window.wireICSInsideDayBox=="function")try{window.wireICSInsideDayBox()}catch(je){}})});var be=document.getElementById("cal_free_slots"),Be=(function(){var K=new Date;return K.getFullYear()+"-"+He(K.getMonth()+1)+"-"+He(K.getDate())})(),Oe=(L||[]).filter(function(K){return String(K.date||"").slice(0,10)>=Be});if(Oe.length){var tt='<b>Slot liberi ≥ 4h (da oggi in poi)</b> · <span class="badge">Tot: '+Oe.length+"</span>";tt+='<div class="row" style="margin-top:8px">';for(var N=0;N<Oe.length&&N<80;N++){var e=Oe[N],V=e.part==="morning"?"mattina":"pomeriggio";tt+='<div class="card slotBtn" data-start="'+e.start+'" data-end="'+e.end+'" style="flex:1 1 280px;cursor:pointer"><div class="small"><b>'+ot(e.start)+"</b> · "+V+'</div><div class="small">'+f(e.start)+"–"+f(e.end)+"</div></div>"}tt+="</div>",be.style.display="block",be.innerHTML=tt,be.querySelectorAll(".slotBtn").forEach(function(K){K.addEventListener("click",function(){Je("bp_prefill_slot",{start:K.getAttribute("data-start"),end:K.getAttribute("data-end")}),we(),me("Slot precompilato negli appuntamenti")})})}else be.style.display="block",be.innerHTML='<b>Slot liberi ≥ 4h (da oggi in poi)</b> · <span class="badge">Tot: 0</span><div class="muted" style="margin-top:6px">Nessuno slot libero disponibile.</div>';try{window.injectTodayCSS&&window.injectTodayCSS()}catch(K){}try{window.hookCalendar?window.hookCalendar():(window.markToday&&window.markToday(),window.clampSlotCounters&&window.clampSlotCounters())}catch(K){}}).catch(function(w){logger.error(w),me("Errore calendario")})}function C(){var q=document.getElementById("cal_month").value,B=parseInt(q.split("-")[0],10),E=parseInt(q.split("-")[1],10),w={only_free:document.getElementById("only_free").checked,only_4h:document.getElementById("only_4h").checked};P(B,E,w)}document.getElementById("cal_refresh").onclick=C;var g=document.getElementById("cal_add");g&&(g.onclick=function(){we()}),document.getElementById("cal_month").onchange=C;function G(q){var B=document.getElementById("cal_month");if(B){var E=B.value.split("-"),w=+E[0],M=+E[1];M+=q,M<=0?(M=12,w--):M>12&&(M=1,w++),B.value=w+"-"+He(M),C()}}var I=document.getElementById("cal_prev"),R=document.getElementById("cal_next");I&&(I.onclick=function(){G(-1)}),R&&(R.onclick=function(){G(1)}),document.getElementById("only_free").onchange=C,document.getElementById("only_4h").onchange=C,C()}function ye(){if(!Te())return s();document.title="Battle Plan – BP",p.innerHTML=Re()+'<div class="wrap"><div class="card"><b>Da inviare</b><div id="bp_to_send" class="grid" style="margin-top:8px"></div></div><div class="card" id="bp_sent_box" style="margin-top:8px"><div id="bp_sent_head" style="display:flex;align-items:center;justify-content:space-between;cursor:pointer"><b>BP inviati (periodi in essere)</b><span id="bp_sent_chev" class="chev">▸</span></div><div id="bp_sent" class="row" style="margin-top:8px;display:none"></div></div><div class="card" style="margin-top:8px"><b>Crea/Aggiorna BP</b><div class="row" style="margin-top:8px"><div><label>Tipo</label><select id="p_type"><option value="settimanale">Settimanale (lun–dom)</option><option value="mensile">Mensile</option><option value="trimestrale">Trimestrale</option><option value="semestrale">Semestrale</option><option value="annuale">Annuale</option></select></div><div id="wrap_week" style="display:none"><label>Settimana ISO (1–53)</label><input type="number" id="p_week" min="1" max="53" value="'+Ae(new Date)+'"></div><div id="wrap_month" style="display:none"><label>Mese</label><select id="p_month"><option value="1">Gennaio</option><option value="2">Febbraio</option><option value="3">Marzo</option><option value="4">Aprile</option><option value="5">Maggio</option><option value="6">Giugno</option><option value="7">Luglio</option><option value="8">Agosto</option><option value="9">Settembre</option><option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option></select></div><div id="wrap_quarter" style="display:none"><label>Trimestre</label><select id="p_quarter"><option value="1">T1</option><option value="2">T2</option><option value="3">T3</option><option value="4">T4</option></select></div><div id="wrap_semester" style="display:none"><label>Semestre</label><select id="p_sem"><option value="1">1° semestre</option><option value="2">2° semestre</option></select></div><div><label>Anno</label><input type="number" id="p_year" min="2000" max="2100" value="'+new Date().getFullYear()+'"></div></div><div class="row"><div class="small muted">Modalità: <b id="p_mode_lbl">Previsionale</b> · <button class="ghost" id="btnImport" style="padding:4px 8px">Importa da agenda</button></div></div><div class="row" style="align-items:center"><div class="small"><b>Periodo selezionato:</b> <span id="p_label" class="neon">—</span></div><input type="hidden" id="p_start"><input type="hidden" id="p_end"></div><div class="row small" style="margin-top:6px;opacity:.9"><div><b>Previsionale</b></div><div><b>Consuntivo</b></div><div><b>Avanzamento</b></div></div><div class="row" id="p_rows" style="margin-top:4px"></div><div class="row" style="margin-top:8px;align-items:center;gap:8px;justify-content:space-between"><div id="p_delete_zone"></div><div class="right"><button id="btnSaveP">Salva BP</button></div></div></div><div class="card"><b>BP salvati</b><div id="p_list" class="row" style="margin-top:8px"></div></div></div>',Fe();var f=!1,h=null,$=[],_=null,z=Te()||{};function P(N){return String(N).replace(/[&<>'"]/g,V=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[V])}function C(N){if(!N)return"";var V=new Date(N);return V.getFullYear()+"-"+("0"+(V.getMonth()+1)).slice(-2)+"-"+("0"+V.getDate()).slice(-2)}function g(N){var V=new Date(N);return("0"+V.getDate()).slice(-2)+"/"+("0"+(V.getMonth()+1)).slice(-2)+"/"+V.getFullYear()}function G(N){var V=Number(N)||0;return V.toLocaleString("it-IT")+"€"}function I(N){var V=document.createElement("div");return V.innerHTML=N.trim(),V.firstChild}function R(N){return!!(N&&N.indicatorsCons&&Object.keys(N.indicatorsCons).length>0)}function q(){return z&&z.grade?Promise.resolve(z):Ie("/api/usernames").then(function(N){var V=String((Te()||{}).id||""),K=(N&&N.users||[]).find(function(X){return String(X.id)===V});return K&&K.grade&&(z.grade=K.grade),z}).catch(function(){return z})}function B(){var N=z&&z.grade||(Te()||{}).grade;return N==="senior"?"senior":"junior"}q();var E=document.getElementById("p_type"),w=document.getElementById("p_year"),M=document.getElementById("wrap_week"),O=document.getElementById("wrap_month"),L=document.getElementById("wrap_quarter"),T=document.getElementById("wrap_semester"),H=document.getElementById("p_week"),S=document.getElementById("p_month"),k=document.getElementById("p_quarter"),a=document.getElementById("p_sem"),n=document.getElementById("p_label"),t=document.getElementById("p_start"),e=document.getElementById("p_end"),o=document.getElementById("p_mode_lbl"),b=document.getElementById("btnImport");function v(N){f=!!N,o.textContent=f?"Consuntivo":"Previsionale",b.style.display=f?"none":"";var V=document.querySelectorAll("[data-row]");V.forEach(function(K){var X=K.querySelector("[data-prev]"),Q=K.querySelector("[data-cons]"),pe=K.querySelector("[data-bar]");if(f){if(X){X.removeAttribute("hidden");var ue=X.querySelector("input");ue&&(ue.setAttribute("readonly","readonly"),ue.classList.add("disabled"))}if(Q){Q.removeAttribute("hidden");var xe=Q.querySelector("input");xe&&(xe.removeAttribute("readonly"),xe.classList.remove("disabled"))}pe&&pe.removeAttribute("hidden")}else{if(X){X.removeAttribute("hidden");var he=X.querySelector("input");he&&(he.removeAttribute("readonly"),he.classList.remove("disabled"))}Q&&Q.setAttribute("hidden","hidden"),pe&&pe.setAttribute("hidden","hidden")}}),Y()}function c(){var N=E.value;M.style.display=N==="settimanale"?"":"none",O.style.display=N==="mensile"?"":"none",L.style.display=N==="trimestrale"?"":"none",T.style.display=N==="semestrale"?"":"none",u()}function u(){var N=E.value,V=parseInt(w.value,10),K,X,Q;if(N==="settimanale"){var pe=Math.max(1,Math.min(53,parseInt(H.value||"1",10))),ue=et(V,pe);K=ue.start,X=ue.end,Q="Sett. "+pe+" · "+g(K)+" → "+g(X)}else if(N==="mensile"){var xe=parseInt(S.value,10);K=new Date(V,xe-1,1),X=new Date(V,xe,0),Q=K.toLocaleString("it-IT",{month:"long",year:"numeric"})+" · "+g(K)+" → "+g(X)}else if(N==="trimestrale"){var he=parseInt(k.value,10);K=new Date(V,(he-1)*3,1),X=new Date(V,he*3,0),Q="Trimestre "+he+" "+V+" · "+g(K)+" → "+g(X)}else if(N==="semestrale"){var ke=parseInt(a.value,10);K=new Date(V,ke===1?0:6,1),X=new Date(V,ke===1?6:12,0),Q=(ke===1?"1°":"2°")+" semestre "+V+" · "+g(K)+" → "+g(X)}else K=new Date(V,0,1),X=new Date(V,11,31),Q="Anno "+V+" · "+g(K)+" → "+g(X);t.value=C(K),e.value=C(X),n.textContent=Q,v(!1),h=null,_=null,m(),Y()}function l(N){for(var V="",K=0;K<N.length;K++){var X=N[K],Q=/^(VSS|VSDPersonale|VSDIndiretto|GI)$/i.test(X);V+='<div class="row" data-row="'+X+'"><div data-prev><label>'+X+' (Prev)</label><input type="number" step="1" id="prev_'+X+'" placeholder="'+(Q?"€":"n")+'"></div><div data-cons><label>'+X+' (Cons)</label><input type="number" step="1" id="cons_'+X+'" placeholder="'+(Q?"€":"n")+'"></div><div data-bar class="small"><div style="height:10px;background:rgba(255,255,255,.12);border-radius:999px;overflow:hidden"><div id="bar_'+X+'" style="height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2));"></div></div><div id="pct_'+X+'" class="small muted">0%</div></div></div>'}document.getElementById("p_rows").innerHTML=V,v(!1),r(),i()}function i(){for(var N=0;N<$.length;N++){var V=$[N],K=document.getElementById("prev_"+V),X=document.getElementById("cons_"+V);if(!(!K||!X)){var Q=Number(K.value||0),pe=Number(X.value||0),ue=Q>0?Math.round(pe/Q*100):pe>0?100:0;ue=Math.max(0,Math.min(200,ue));var xe=document.getElementById("bar_"+V),he=document.getElementById("pct_"+V);xe&&(xe.style.width=Math.min(ue,100)+"%"),he&&(he.textContent=ue+"%")}}}function r(){for(var N=0;N<$.length;N++)(function(V){var K=document.getElementById("prev_"+V),X=document.getElementById("cons_"+V);K&&(K.oninput=i),X&&(X.oninput=i)})($[N])}function d(){for(var N=0;N<$.length;N++){var V=document.getElementById("prev_"+$[N]);V&&(V.value="")}i()}function m(){for(var N=0;N<$.length;N++){var V=document.getElementById("cons_"+$[N]);V&&(V.value="")}i()}function y(N){for(var V in N){var K=document.getElementById("prev_"+V);K&&(K.value=String(N[V]||0))}i()}function A(N){for(var V in N){var K=document.getElementById("cons_"+V);K&&(K.value=String(N[V]||0))}i()}function J(){if(!f){var N=t.value,V=e.value;if(!N||!V){me("Seleziona il periodo");return}Ie("/api/appointments").then(function(K){for(var X=K.appointments||[],Q=new Date(N),pe=new Date(V),ue={VSS:0,VSDPersonale:0,VSDIndiretto:0,GI:0,Telefonate:0,AppFissati:0,AppFatti:0,CorsiLeadership:0,iProfile:0,MBS:0,NNCF:0},xe=0;xe<X.length;xe++){var he=X[xe],ke=new Date(he.start);ke>=Q&&ke<=pe&&(ue.VSS+=Number(he.vss||0),ue.VSDPersonale+=Number(he.vsdPersonal||0),ue.VSDIndiretto+=Number(he.vsdIndiretto||0),ue.Telefonate+=Number(he.telefonate||0),ue.AppFissati+=Number(he.appFissati||0),he.nncf&&(ue.AppFatti+=1,ue.NNCF+=1))}y(ue),me("Previsionale compilato dalla tua agenda"),st(),window.addXP(10)}).catch(function(){me("Errore import agenda")})}}function ae(N,V){N=Object.assign({},N||{});var K=Number(N.GI||0),X=Number(N.VSDPersonale||0),Q=K*.15,pe=X*(String(V)==="senior"?.25:.2);return N.ProvvGI=Math.round(Q*100)/100,N.ProvvVSD=Math.round(pe*100)/100,N.TotProvvigioni=Math.round((N.ProvvGI+N.ProvvVSD)*100)/100,N}function x(N,V,K){return fetch(V,{method:N,headers:K?{"Content-Type":"application/json"}:void 0,body:K?JSON.stringify(K):void 0}).then(function(X){return X.ok?X.json().catch(function(){return{}}):Promise.reject(new Error("HTTP "+X.status))})}function U(N){for(var V=encodeURIComponent(N),K=[function(){return x("POST","/api/periods/delete",{id:N})},function(){return x("POST","/api/periods",{id:N,_delete:!0})},function(){return x("POST","/api/periods/"+V,{_method:"DELETE"})},function(){return x("DELETE","/api/periods/"+V,null)},function(){return x("DELETE","/api/periods?id="+V,null)}],X=Promise.reject(new Error("start")),Q=0;Q<K.length;Q++)(function(pe){X=X.catch(pe)})(K[Q]);return X.catch(function(pe){throw logger.warn("Delete fallback: tutte le route fallite",pe),pe})}function se(N){return _?{id:h||_.id,type:_.type,startDate:C(_.startDate),endDate:C(_.endDate),indicatorsPrev:Object.assign({},_.indicatorsPrev||{}),indicatorsCons:N!=null?N:Object.assign({},_.indicatorsCons||{})}:null}function Y(){var N=document.getElementById("p_delete_zone");if(N){if(!h){N.innerHTML="";return}var V=!!(_&&R(_)),K="";V&&(K+='<button id="btnDelCons" class="ghost" style="border-color:#7d1731;color:#7d1731">Elimina Consuntivo</button> '),K+='<button id="btnDelBP" class="ghost" style="border-color:#7d1731;color:#7d1731">Elimina BP</button>',N.innerHTML=K;var X=document.getElementById("btnDelBP");X&&(X.onclick=function(){confirm("Eliminare definitivamente questo BP?")&&(X.disabled=!0,U(h).then(function(){me("BP eliminato");try{document.dispatchEvent(new Event("bp:deleted"))}catch(pe){}h=null,_=null,d(),m(),v(!1),u(),ce()}).catch(function(){me("Endpoint delete non disponibile")}).finally(function(){X.disabled=!1}))});var Q=document.getElementById("btnDelCons");Q&&(Q.onclick=function(){if(confirm("Rimuovere solo il Consuntivo?")){Q.disabled=!0;var pe=se({});if(!pe){Q.disabled=!1;return}var ue=B();pe.indicatorsPrev=ae(pe.indicatorsPrev,ue),pe.indicatorsCons={},qe("/api/periods",pe).then(function(){me("Consuntivo eliminato");try{document.dispatchEvent(new Event("bp:saved"))}catch(xe){}_&&(_.indicatorsCons={}),v(!0),ce(),Y()}).catch(function(){me("Errore eliminazione Consuntivo")}).finally(function(){Q.disabled=!1})}})}}function le(){var N=E.value,V=t.value,K=e.value;if(!V||!K){me("Seleziona il periodo");return}for(var X={},Q={},pe=0;pe<$.length;pe++){var ue=$[pe];X[ue]=Number(document.getElementById("prev_"+ue).value||0),f&&(Q[ue]=Number(document.getElementById("cons_"+ue).value||0))}var xe=B();X=ae(X,xe),f&&(Q=ae(Q,xe));var he={type:N,startDate:V,endDate:K,indicatorsPrev:X};f&&(he.indicatorsCons=Q),h&&(he.id=h),qe("/api/periods",he).then(function(ke){me("BP salvato"),f?window.addXP(20):window.addXP(10),st();try{document.dispatchEvent(new Event("bp:saved"))}catch(ze){}ce(),!h&&ke&&ke.id&&(h=ke.id),h&&_&&(_.indicatorsPrev=X,f&&(_.indicatorsCons=Q)),Y()}).catch(function(){me("Errore salvataggio BP")})}function ce(){Ie("/api/periods").then(function(N){var V=N.periods||[];V.sort(function(he,ke){return new Date(ke.startDate)-new Date(he.startDate)});for(var K="",X=0;X<V.length;X++){var Q=V[X],pe=rt(Q.type,Q.startDate)+" · "+g(Q.startDate)+" → "+g(Q.endDate);K+='<div class="card" style="flex:1 1 360px"><div><b>'+P(pe)+'</b></div><div class="small">Prev VSS '+G((Q.indicatorsPrev||{}).VSS||0)+" · Cons "+G((Q.indicatorsCons||{}).VSS||0)+'</div><div class="right" style="margin-top:6px"><button class="ghost" data-edit="'+Q.id+'">Modifica previs.</button><button data-cons="'+Q.id+'">Consuntivo…</button></div></div>'}document.getElementById("p_list").innerHTML=K||'<div class="muted">Nessun BP</div>',document.querySelectorAll("[data-edit]").forEach(function(he){he.addEventListener("click",function(){var ke=he.getAttribute("data-edit"),ze=(N.periods||[]).find(function(Ye){return Ye.id===ke});ze&&ge(ze,!1)})}),document.querySelectorAll("[data-cons]").forEach(function(he){he.addEventListener("click",function(){var ke=he.getAttribute("data-cons"),ze=(N.periods||[]).find(function(Ye){return Ye.id===ke});ze&&ge(ze,!0)})}),tt(V);var ue=lt("bp_open_period",null);if(ue){it("bp_open_period");var xe=V.find(function(he){return he.id===ue.id});xe&&ge(xe,ue.mode===!0)}})}function ge(N,V){_=N||null,E.value=N.type;var K=new Date(N.startDate),X=K.getFullYear();if(w.value=String(X),N.type==="settimanale")H.value=String(Ae(K));else if(N.type==="mensile")S.value=String(K.getMonth()+1);else if(N.type==="trimestrale"){var Q=Math.floor(K.getMonth()/3)+1;k.value=String(Q)}else N.type==="semestrale"&&(a.value=K.getMonth()<6?"1":"2");c(),d(),m(),y(N.indicatorsPrev||{}),A(N.indicatorsCons||{}),v(!!V),h=N.id||null,Y(),me(V?"Compila il consuntivo":"Modifica previsionale"),window.scrollTo({top:0,behavior:"smooth"})}function Se(N,V){V=V||new Date;var K=V.getFullYear();if(N==="settimanale"){var X=et(K,Ae(V));return{start:X.start,end:X.end}}return N==="mensile"?{start:ft(V),end:gt(V)}:N==="trimestrale"?{start:ut(V),end:ht(V)}:N==="semestrale"?{start:pt(V),end:wt(V)}:{start:bt(V),end:ct(V)}}function be(N,V){return V=V||new Date,N==="settimanale"?Gt(V):N==="mensile"?Wt(V):N==="trimestrale"?$t(V):N==="semestrale"?Kt(V):Jt(V)}function Be(N){var V=et(new Date().getFullYear(),Ae(new Date)),K=V.start,X=Math.floor((new Date(N)-K)/(1e3*60*60*24));return X<=13}function Oe(N,V,K,X,Q,pe){var ue=rt(V,K),xe=I('<div class="card" style="position:relative"><div class="small muted">'+P(N)+"</div><div><b>"+P(ue)+'</b></div><div class="small muted">'+g(K)+" → "+g(X)+'</div><div class="right" style="margin-top:6px"><button class="ghost" type="button" data-sug="1">'+P(Q)+"</button></div></div>");return xe.querySelector("[data-sug]").addEventListener("click",pe),xe}function tt(N){var V=document.getElementById("bp_to_send"),K=document.getElementById("bp_sent");V.innerHTML="",K.innerHTML="";function X(Pe,Ve,Me){return N.find(function($e){return $e.type===Pe&&C($e.startDate)===C(Ve)&&C($e.endDate)===C(Me)})}var Q=new Date,pe=Q.getDay(),ue=pe===5||pe===6||pe===0,xe=gt(Q),he=ht(Q),ke=wt(Q),ze=ct(Q),Ye=ue&&Be(xe),nt=ue&&Be(he),at=ue&&Be(ke),Ze=ue&&Be(ze);["settimanale","mensile","trimestrale","semestrale","annuale"].forEach(function(Pe){var Ve=Se(Pe,Q),Me=X(Pe,Ve.start,Ve.end);if(Me){var $e=I('<div class="card" style="flex:1 1 360px"><div><b>'+P(rt(Pe,Ve.start))+'</b></div><div class="small muted">'+g(Ve.start)+" → "+g(Ve.end)+'</div><div class="right" style="margin-top:6px"><button class="ghost" type="button" data-mid="'+Me.id+'">Modifica</button></div></div>');$e.querySelector("[data-mid]").addEventListener("click",function(){ge(Me,!1)}),K.appendChild($e)}});function Xe(Pe,Ve,Me){var $e=X(Pe,Me.start,Me.end),vt=X(Pe,Ve.start,Ve.end);$e?V.appendChild(Oe("Previsionale",Pe,Me.start,Me.end,"Modifica",function(){ge($e,!1)})):V.appendChild(Oe("Previsionale",Pe,Me.start,Me.end,"Compila",function(){if(E.value=Pe,w.value=String(Me.start.getFullYear()),Pe==="settimanale")H.value=String(Ae(Me.start));else if(Pe==="mensile")S.value=String(Me.start.getMonth()+1);else if(Pe==="trimestrale"){var Lt=Math.floor(Me.start.getMonth()/3)+1;k.value=String(Lt)}else Pe==="semestrale"&&(a.value=Me.start.getMonth()<6?"1":"2");c()})),vt&&!R(vt)&&V.appendChild(Oe("Consuntivo",Pe,Ve.start,Ve.end,"Consuntivo",function(){ge(vt,!0)}))}if(ue){var je=Se("settimanale",Q),Qe=be("settimanale",Q);Xe("settimanale",je,Qe)}if(Ye){var xt=Se("mensile",Q),Et=be("mensile",Q);Xe("mensile",xt,Et)}if(nt){var Dt=Se("trimestrale",Q),Tt=be("trimestrale",Q);Xe("trimestrale",Dt,Tt)}if(at){var Bt=Se("semestrale",Q),kt=be("semestrale",Q);Xe("semestrale",Bt,kt)}if(Ze){var Pt=Se("annuale",Q),At=be("annuale",Q);Xe("annuale",Pt,At)}V.children.length||(V.innerHTML='<div class="muted">Nessun suggerimento attivo in questo momento</div>');var Mt=document.getElementById("bp_sent_head"),Nt=document.getElementById("bp_sent_chev");Mt.onclick=function(){var Pe=document.getElementById("bp_sent"),Ve=Pe.style.display!=="none";Pe.style.display=Ve?"none":"",Nt.textContent=Ve?"▸":"▾"}}Ie("/api/settings").then(function(N){$=N&&N.indicators||["VSS","VSDPersonale","VSDIndiretto","GI","Telefonate","AppFissati","AppFatti","CorsiLeadership","iProfile","MBS","NNCF"],l($)}).catch(function(){$=["VSS","VSDPersonale","GI","NNCF"],l($)}),E.onchange=c,w.oninput=u,H.oninput=u,S.onchange=u,k.onchange=u,a.onchange=u,b.onclick=J,document.getElementById("btnSaveP").onclick=le,c(),ce()}function we(){if(!Te())return s();if(document.title="Battle Plan – Appuntamenti",!document.getElementById("appts_css")){const i=document.createElement("style");i.id="appts_css",i.textContent="\n      .appt-type .seg, #a_nncf.seg{\n        padding:8px 12px;border:1px solid #bcd7ff;border-radius:12px;\n        background:#eef5ff;color:#1463ff;cursor:pointer;user-select:none;\n        transition:.15s;\n      }\n      .appt-type .seg.active, #a_nncf.seg.active{\n        background:var(--accent);color:#fff;border-color:var(--accent);\n        box-shadow:0 0 0 2px rgba(20,99,255,.08) inset;\n      }\n      #a_list .grid3{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}\n    ",document.head.appendChild(i)}p.innerHTML=Re()+'<div class="wrap"><div class="card"><b id="a_form_title">Nuovo appuntamento</b><div class="row" style="margin-top:8px;align-items:flex-end;gap:12px;flex-wrap:wrap"><div style="min-width:320px"><label>Cliente *</label><div style="display:flex;gap:8px;align-items:center"><input id="a_client" list="clientList" placeholder="Denominazione" style="flex:1"><datalist id="clientList"></datalist><button id="a_nncf" class="seg" data-active="0" aria-pressed="false">NNCF</button></div></div><div><label>Data/ora inizio</label><input id="a_start" type="datetime-local"></div><div><label>Ora fine</label><input id="a_end" type="time"></div><div><label>Durata (min)</label><input id="a_dur" type="number" placeholder="60" min="1"></div></div><div class="row" style="margin-top:8px"><div style="flex:1"><label>Descrizione appuntamento</label><textarea id="a_desc" rows="2"></textarea></div></div><div class="row" style="align-items:flex-end;gap:12px;flex-wrap:wrap"><div class="appt-type"><label>Tipo</label><div><button type="button" id="t_vendita" class="seg">Vendita</button><button type="button" id="t_mezza"   class="seg" data-vsd="1000">Mezza giornata</button><button type="button" id="t_full"    class="seg" data-vsd="2000">Giornata intera</button><button type="button" id="t_form"    class="seg">Formazione</button><button type="button" id="t_mbs"     class="seg">MBS</button><button type="button" id="t_sotto"   class="seg">Sottoprodotti</button></div><input id="a_type" type="hidden" value="vendita"></div><div id="row_vss"><label>VSS</label><input id="a_vss" type="number" step="1" placeholder="0"></div><div id="row_vsd_p"><label>VSD personale</label><input id="a_vsd" type="number" step="1" placeholder="0"></div><div id="row_vsd_i" style="display:none"><label>VSD indiretto</label><input id="a_vsd_i" type="number" step="1" placeholder="0"></div><div id="row_tel" style="display:none"><label>Telefonate</label><input id="a_tel" type="number" step="1" placeholder="0"></div><div id="row_app" style="display:none"><label>Appunt. fissati</label><input id="a_app" type="number" step="1" placeholder="0"></div></div><div class="row" style="margin-top:8px;gap:8px;align-items:center"><div><button id="btnSaveA">Salva</button></div><div><button id="btnSaveExportA" class="ghost">Salva ed esporta</button></div><div class="right" style="margin-left:auto"><button id="btnDeleteA" class="danger" style="display:none">Elimina</button></div></div></div><div class="card"><b>Elenco appuntamenti</b><div class="row" style="margin-top:8px;align-items:flex-end;gap:12px;flex-wrap:wrap"><div><label>Vista</label><select id="af_type"><option value="sett">Settimana</option><option value="mese">Mese</option></select></div><div id="af_week_wrap"><label>Settimana ISO</label><input id="af_week" type="number" min="1" max="53" value="'+Ae(new Date)+'"></div><div id="af_month_wrap" style="display:none"><label>Mese</label><select id="af_month"><option value="1">Gennaio</option><option value="2">Febbraio</option><option value="3">Marzo</option><option value="4">Aprile</option><option value="5">Maggio</option><option value="6">Giugno</option><option value="7">Luglio</option><option value="8">Agosto</option><option value="9">Settembre</option><option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option></select></div><div><label>Anno</label><input id="af_year" type="number" min="2000" max="2100" value="'+new Date().getFullYear()+'"></div><div class="right" style="margin-left:auto;display:flex;gap:8px"><button id="af_prev" class="ghost">◀</button><button id="af_next" class="ghost">▶</button></div></div><div id="a_list" style="margin-top:8px"></div></div></div>',Fe();function f(i){return String(i).replace(/[&<>'"]/g,r=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[r])}function h(i){var r=Number(i)||0;return r.toLocaleString("it-IT")+"€"}function $(i){var r=new Date(i);return("0"+r.getDate()).slice(-2)+"/"+("0"+(r.getMonth()+1)).slice(-2)+"/"+r.getFullYear()}function _(i){if(!i)return"";const r=new Date(i);return isNaN(r)?"":r.toISOString()}function z(i){if(!i)return"";const r=new Date(i);return isNaN(r)?"":new Date(r.getTime()-r.getTimezoneOffset()*6e4).toISOString().slice(0,16)}function P(i){return i=String(i||"").toLowerCase(),i.indexOf("mezza")>-1?240:i.indexOf("giorn")>-1||i.indexOf("formaz")>-1||i.indexOf("mbs")>-1?570:i.indexOf("sottoprod")>-1?240:90}const C=document.getElementById("a_nncf");C.addEventListener("click",()=>{const i=C.getAttribute("data-active")!=="1";C.setAttribute("data-active",i?"1":"0"),C.setAttribute("aria-pressed",i?"true":"false"),C.classList.toggle("active",i),i&&w(document.getElementById("t_vendita"))});const g=document.getElementById("t_vendita"),G=document.getElementById("t_mezza"),I=document.getElementById("t_full"),R=document.getElementById("t_form"),q=document.getElementById("t_mbs"),B=document.getElementById("t_sotto"),E=[g,G,I,R,q,B];function w(i){E.forEach(x=>x.classList.toggle("active",x===i));const r=document.getElementById("a_type"),d=document.getElementById("a_client"),m=document.getElementById("row_vss"),y=document.getElementById("row_vsd_p"),A=document.getElementById("row_vsd_i"),J=document.getElementById("row_tel"),ae=document.getElementById("row_app");document.getElementById("a_vss").value="",document.getElementById("a_vsd").value="",document.getElementById("a_vsd_i").value="",document.getElementById("a_tel").value="",document.getElementById("a_app").value="",m.style.display="",y.style.display="",A.style.display="none",J.style.display="none",ae.style.display="none",d.disabled=!1,C.style.display="",C.setAttribute("data-active","0"),C.setAttribute("aria-pressed","false"),C.classList.remove("active"),(d.value==="Formazione"||d.value==="MBS"||d.value==="Sottoprodotti")&&(d.value=""),i===g?(r.value="vendita",M(90)):i===G?(r.value="mezza",M(240),document.getElementById("a_vsd").value="1000"):i===I?(r.value="giornata",M(570),document.getElementById("a_vsd").value="2000"):i===R?(r.value="formazione",M(570),d.value="Formazione",d.disabled=!0,m.style.display="none",y.style.display="none",C.style.display="none"):i===q?(r.value="MBS",M(570),d.value="MBS",d.disabled=!0,m.style.display="none",y.style.display="none",A.style.display="",document.getElementById("a_vsd_i").value="2000",C.style.display="none"):i===B&&(r.value="sottoprodotti",M(240),d.value="Sottoprodotti",d.disabled=!0,m.style.display="none",y.style.display="none",J.style.display="",ae.style.display="",C.style.display="none")}function M(i){const r=document.getElementById("a_dur");r.value=String(i),O()}E.forEach(i=>i.addEventListener("click",r=>{r.preventDefault(),w(i)})),w(g);function O(){const i=document.getElementById("a_start").value,r=parseInt(document.getElementById("a_dur").value||"0",10);if(!i||!isFinite(r)||r<=0){document.getElementById("a_end").value="";return}const d=new Date(i),m=new Date(d.getTime()+r*6e4);document.getElementById("a_end").value=("0"+m.getHours()).slice(-2)+":"+("0"+m.getMinutes()).slice(-2)}function L(){const i=document.getElementById("a_start").value,r=document.getElementById("a_end").value;if(!i||!r)return;const d=new Date(i),m=r.split(":");if(m.length<2)return;const y=new Date(d);y.setHours(parseInt(m[0],10)||0,parseInt(m[1],10)||0,0,0),y<d&&y.setDate(y.getDate()+1);let A=Math.round((y-d)/6e4);document.getElementById("a_dur").value=String(Math.max(1,A))}document.getElementById("a_start").addEventListener("change",O),document.getElementById("a_dur").addEventListener("input",O),document.getElementById("a_end").addEventListener("change",L),Ie("/api/clients").then(i=>{const r=i&&i.clients||[],d=document.getElementById("clientList");d&&(d.innerHTML=r.map(m=>'<option value="'+f(m.name)+'"></option>').join(""))});let T=null;function H(){T=null,document.getElementById("a_form_title").textContent="Nuovo appuntamento",document.getElementById("a_client").value="",document.getElementById("a_start").value="",document.getElementById("a_end").value="",document.getElementById("a_dur").value="",document.getElementById("a_vss").value="",document.getElementById("a_vsd").value="",document.getElementById("a_vsd_i").value="",document.getElementById("a_tel").value="",document.getElementById("a_app").value="",document.getElementById("a_desc").value="",document.getElementById("a_client").disabled=!1,C.style.display="",C.setAttribute("data-active","0"),C.setAttribute("aria-pressed","false"),C.classList.remove("active"),w(g),document.getElementById("btnDeleteA").style.display="none"}function S(i){T=i.id,document.getElementById("a_form_title").textContent="Modifica appuntamento";var r=String(i.type||"vendita").toLowerCase();r.indexOf("mezza")>-1?w(G):r.indexOf("giorn")>-1?w(I):r.indexOf("formaz")>-1?w(R):r.indexOf("mbs")>-1?w(q):r.indexOf("sottoprod")>-1?w(B):w(g),document.getElementById("a_client").value=i.client||"",document.getElementById("a_start").value=z(i.start);const d=new Date(i.start);let m=i.end?new Date(i.end):null,y=Number(i.durationMinutes);m instanceof Date&&!isNaN(m)&&m>=d?y=Math.max(1,Math.round((m-d)/6e4)):isFinite(y)&&y>0?m=new Date(d.getTime()+y*6e4):(y=P(i.type||"vendita"),m=new Date(d.getTime()+y*6e4)),document.getElementById("a_dur").value=String(y),document.getElementById("a_end").value=("0"+m.getHours()).slice(-2)+":"+("0"+m.getMinutes()).slice(-2),document.getElementById("a_vss").value=i.vss||"",document.getElementById("a_vsd").value=i.vsdPersonal||i.vsd||"",document.getElementById("a_vsd_i").value=i.vsdIndiretto||"",document.getElementById("a_tel").value=i.telefonate||"",document.getElementById("a_app").value=i.appFissati||"",document.getElementById("a_desc").value=i.notes||"";const A=!!i.nncf;C.setAttribute("data-active",A?"1":"0"),C.setAttribute("aria-pressed",A?"true":"false"),C.classList.toggle("active",A),document.getElementById("btnDeleteA").style.display=""}function k(){let i=(document.getElementById("a_client").value||"").trim();const r=document.getElementById("a_type").value;if(!i){const ae=String(r||"").toLowerCase();if(ae==="formazione"||ae==="mbs"||ae==="sottoprodotti")i=r;else return me("Cliente obbligatorio"),null}const d=document.getElementById("a_start").value;if(!d)return me("Data/ora obbligatorie"),null;let m=parseInt(document.getElementById("a_dur").value||"60",10);(!isFinite(m)||m<=0)&&(m=60);const y=document.getElementById("a_end").value;let A;if(y){const ae=new Date(d),x=y.split(":"),U=new Date(ae);U.setHours(parseInt(x[0],10)||0,parseInt(x[1],10)||0,0,0),U<ae&&U.setDate(U.getDate()+1),A=U.toISOString(),m=Math.max(1,Math.round((U-ae)/6e4)),document.getElementById("a_dur").value=String(m)}else A=new Date(new Date(d).getTime()+m*6e4).toISOString();const J=document.getElementById("a_desc").value||"";return{id:T||void 0,client:i,start:_(d),end:A,durationMinutes:m,type:r,vss:Number(document.getElementById("a_vss").value||0),vsdPersonal:Number(document.getElementById("a_vsd").value||0),vsdIndiretto:Number(document.getElementById("a_vsd_i").value||0),telefonate:Number(document.getElementById("a_tel").value||0),appFissati:Number(document.getElementById("a_app").value||0),notes:J,nncf:C.getAttribute("data-active")==="1"}}function a(i){const r=k();if(!r)return;const d=!T;qe("/api/appointments",r).then(()=>{if(me("Appuntamento salvato"),typeof haptics<"u"&&haptics.try("success"),document.dispatchEvent(new Event("appt:saved")),d)try{document.dispatchEvent(new Event("appt:created"))}catch(m){}if(i&&window.BP&&BP.ICS&&typeof BP.ICS.downloadIcsForAppointment=="function")if(BP.ICS.downloadIcsForAppointment(r)){typeof haptics<"u"&&haptics.try("medium");try{document.dispatchEvent(new Event("ics:exported"))}catch(y){}me(".ics esportato")}else me("Export .ics non disponibile");H(),l()}).catch(()=>me("Errore salvataggio"))}function n(){if(!T||!confirm("Eliminare l'appuntamento?"))return;const i=k();fetch("/api/appointments?id="+encodeURIComponent(T),{method:"DELETE",headers:{Authorization:"Bearer "+dt()}}).then(r=>{if(!r.ok)throw new Error("HTTP "+r.status);return r.json()}).then(()=>{me("Eliminato"),typeof showUndo=="function"&&i&&showUndo("Appuntamento eliminato",function(){return qe("/api/appointments",i)},5e3),H(),l()}).catch(()=>me("Errore eliminazione"))}document.getElementById("btnSaveA").onclick=()=>a(!1),document.getElementById("btnSaveExportA").onclick=()=>a(!0),document.getElementById("btnDeleteA").onclick=n;function t(){const i=document.getElementById("af_type").value,r=parseInt(document.getElementById("af_year").value,10);if(i==="sett"){const d=Math.max(1,Math.min(53,parseInt(document.getElementById("af_week").value||Ae(new Date),10))),m=et(r,d);return{s:new Date(m.start),e:new Date(m.end)}}else{const d=parseInt(document.getElementById("af_month").value||new Date().getMonth()+1,10);return{s:new Date(r,d-1,1),e:new Date(r,d,0,23,59,59,999)}}}function e(i){const r=document.getElementById("af_type").value,d=parseInt(document.getElementById("af_year").value,10);if(r==="sett"){const m=parseInt(document.getElementById("af_week").value,10),y=new Date(et(d,m).start);y.setDate(y.getDate()+7*i),document.getElementById("af_year").value=y.getFullYear(),document.getElementById("af_week").value=Ae(y)}else{const m=parseInt(document.getElementById("af_month").value,10),y=new Date(d,m-1,1);y.setMonth(y.getMonth()+i),document.getElementById("af_year").value=y.getFullYear(),document.getElementById("af_month").value=y.getMonth()+1}l()}document.getElementById("af_prev").onclick=()=>e(-1),document.getElementById("af_next").onclick=()=>e(1);const o=document.getElementById("af_type"),b=document.getElementById("af_week"),v=document.getElementById("af_month"),c=document.getElementById("af_year");o.onchange=function(){const i=o.value;document.getElementById("af_week_wrap").style.display=i==="sett"?"":"none",document.getElementById("af_month_wrap").style.display=i==="mese"?"":"none",l()},[b,v,c].forEach(i=>{i&&(i.onchange=l)});function u(i){const r=new Date(i.start);let d=i.end?new Date(i.end):null;if(!(d instanceof Date)||isNaN(d)||d<r){const J=isFinite(i.durationMinutes)?Number(i.durationMinutes):P(i.type||"vendita");d=new Date(r.getTime()+J*6e4)}const m=$(r)+" "+("0"+r.getHours()).slice(-2)+":"+("0"+r.getMinutes()).slice(-2)+"–"+("0"+d.getHours()).slice(-2)+":"+("0"+d.getMinutes()).slice(-2);var y,A=String(i.type||"").toLowerCase();return A.indexOf("mbs")>-1?y="VSD ind "+h(i.vsdIndiretto||0):A.indexOf("sottoprod")>-1?y="Tel "+Le(i.telefonate||0)+" · AppFissati "+Le(i.appFissati||0):A.indexOf("formaz")>-1?y="":y="VSS "+h(i.vss||0)+" · VSD "+h(i.vsdPersonal||0)+" · NNCF "+(i.nncf?"✅":"—"),'<div class="card" data-aid="'+f(String(i.id||""))+'" style="flex:1 1 320px;cursor:pointer"><div class="small muted">'+f(m)+" · "+f(i.type||"vendita")+'</div><div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><div><b>'+f(i.client||"")+'</b></div><button class="ghost btn-ics" title="Esporta" data-ics="'+f(String(i.id||""))+'">📅</button></div>'+(y?'<div class="small">'+y+"</div>":"")+"</div>"}function l(){Ie("/api/appointments").then(i=>{const r=i&&i.appointments||[],d=t(),m=d.s.getTime(),y=d.e.getTime(),A=r.filter(ce=>{const ge=new Date(ce.start).getTime();return ge>=m&&ge<=y}).sort((ce,ge)=>new Date(ce.start)-new Date(ge.start)),J=new Date,ae=A.filter(ce=>new Date(ce.start)>=J),x=A.filter(ce=>new Date(ce.start)<J),U=document.getElementById("a_list");let se="";se+="<div><b>Prossimi</b></div>",se+=ae.length?'<div class="grid3">'+ae.map(u).join("")+"</div>":'<div class="muted" style="margin:6px 0 12px">Nessun appuntamento futuro</div>';const Y="past_"+Math.random().toString(36).slice(2,8);se+='<div id="'+Y+'_head" style="margin-top:12px;display:flex;align-items:center;justify-content:space-between;cursor:pointer"><b>Passati</b><span class="chev">▸</span></div><div id="'+Y+'_box" style="display:none;margin-top:8px">'+(x.length?'<div class="grid3">'+x.map(u).join("")+"</div>":'<div class="muted">Nessun appuntamento passato</div>')+"</div>",U.innerHTML=se,(function(){const ce=document.getElementById(Y+"_head"),ge=document.getElementById(Y+"_box"),Se=ce.querySelector(".chev");ce.onclick=function(){const be=ge.style.display==="none";ge.style.display=be?"":"none",Se.textContent=be?"▾":"▸"}})();const le=A;U.querySelectorAll("[data-ics]").forEach(ce=>{ce.addEventListener("click",ge=>{ge.stopPropagation();const Se=ce.getAttribute("data-ics"),be=le.find(Be=>String(Be.id)===String(Se));if(!be){me("Appuntamento non trovato");return}if(window.BP&&BP.ICS&&typeof BP.ICS.downloadIcsForAppointment=="function")if(BP.ICS.downloadIcsForAppointment(be)){typeof haptics<"u"&&haptics.try("medium");try{document.dispatchEvent(new Event("ics:exported"))}catch(Oe){}me("Esportato")}else me("Export .ics non disponibile");else me("Export .ics non disponibile")})}),U.querySelectorAll(".card[data-aid]").forEach(ce=>{ce.addEventListener("click",()=>{const ge=ce.getAttribute("data-aid"),Se=le.find(be=>String(be.id)===String(ge));Se&&(S(Se),window.scrollTo({top:0,behavior:"smooth"}))})})})}try{const i=lt("bp_prefill_slot",null);if(i&&i.start){const r=new Date(i.start),d=new Date(i.end||i.start),m=new Date(r.getTime()-r.getTimezoneOffset()*6e4).toISOString().slice(0,16);document.getElementById("a_start").value=m,document.getElementById("a_dur").value=String(Math.max(1,Math.round((d-r)/6e4))),O(),me("Slot precompilato negli appuntamenti")}it("bp_prefill_slot")}catch(i){}try{const i=lt("bp_edit_aid",null);i&&Ie("/api/appointments").then(r=>{const m=(r&&r.appointments||[]).find(y=>String(y.id)===String(i));m&&(S(m),window.scrollTo({top:0,behavior:"smooth"}))}).finally(()=>{try{it("bp_edit_aid")}catch(r){}})}catch(i){}document.getElementById("btnSaveA").onclick=()=>a(!1),document.getElementById("btnSaveExportA").onclick=()=>a(!0),document.getElementById("btnDeleteA").onclick=n,Ie("/api/clients").then(()=>{}),l()}function re(){if(!Te())return s();document.title="Battle Plan – Classifiche",p.innerHTML=Re()+('<div class="wrap"><div class="card"><div class="row"><div><label>Vista</label><select id="lb_tab"><option value="per_indicator">Per indicatore</option><option value="overall">Generale (score)</option></select></div><div><label>Modalità</label><select id="lb_mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div><div id="lb_ind_wrap"><label>Indicatore</label><select id="lb_indicator"><option value="VSS">VSS</option><option value="VSDPersonale">VSD</option><option value="GI">GI</option><option value="NNCF">NNCF</option></select></div></div>'+D("lb")+'</div><div class="card"><b id="lb_title">Classifica</b><div id="lb_podium" style="margin:10px 0"></div><div id="lb_table"></div></div></div>'),Fe();function f(I){if(!I)return"";var R=new Date(I);return R.getFullYear()+"-"+("0"+(R.getMonth()+1)).slice(-2)+"-"+("0"+R.getDate()).slice(-2)}function h(I){return I==="ytd"||I==="ltm"?"mensile":I}document.getElementById("lb_tab").onchange=function(){var I=this.value;document.getElementById("lb_ind_wrap").style.display=I==="per_indicator"?"":"none",_()},j("lb",_),document.getElementById("lb_mode").onchange=_,document.getElementById("lb_indicator").onchange=_;function $(){var I=W("lb"),R=f(I.start),q=f(I.end),B=h(I.type||"mensile");return"&from="+encodeURIComponent(R)+"&to="+encodeURIComponent(q)+"&type="+encodeURIComponent(B)}function _(){var I=document.getElementById("lb_tab").value,R=$(),q=document.getElementById("lb_mode").value;if(I==="overall")Ie("/api/leaderboard_overall?mode="+encodeURIComponent(q)+R).then(G);else{var B=document.getElementById("lb_indicator").value;Ie("/api/leaderboard?indicator="+encodeURIComponent(B)+"&mode="+encodeURIComponent(q)+R).then(function(E){g(E,B)})}}function z(I){return I===0?"🥇":I===1?"🥈":I===2?"🥉":I+1+"."}function P(I){var R=document.getElementById("lb_podium");if(!I||!I.length){R.innerHTML="";return}for(var q=I.slice(0,3),B='<div class="row" style="align-items:flex-end">',E=0;E<q.length;E++){var w=80-E*15;B+='<div class="card" style="flex:1 1 120px;height:'+w+'px;display:flex;align-items:flex-end;justify-content:center"><div>'+De(z(E)+" "+q[E].name)+"</div></div>"}B+="</div>",R.innerHTML=B}function C(I,R,q){var B=Math.min(100,Math.max(0,Math.round(q)));return'<div class="card lb-card" style="flex:1 1 280px"><div class="big">'+De(I)+'</div><div class="small muted">'+De(R)+'</div><div class="lb-bar"><div style="width:'+B+'%"></div></div></div>'}function g(I,R){document.getElementById("lb_title").textContent="Classifica – "+R;var q=I.ranking||[];if(P(q),!q.length){document.getElementById("lb_table").innerHTML='<div class="muted">Nessun dato</div>';return}for(var B='<div class="row">',E=q[0].total||1,w=0;w<q.length;w++){var M=q[w];B+=C(z(w)+" "+M.name,"Totale: "+Le(M.total),M.total/E*100)}B+="</div>",document.getElementById("lb_table").innerHTML=B}function G(I){document.getElementById("lb_title").textContent="Classifica generale";var R=I.ranking||[];if(P(R),!R.length){document.getElementById("lb_table").innerHTML='<div class="muted">Nessun dato</div>';return}for(var q=R[0].score||0,B='<div class="row">',E=0;E<R.length;E++){var w=R[E];B+=C(z(E)+" "+w.name,"Score: "+Le(w.score)+"/100",q?w.score/q*100:0)}B+="</div>",document.getElementById("lb_table").innerHTML=B}_()}(function(){function f(){var h=document.getElementById("bp-overlay");return h||(h=document.createElement("div"),h.id="bp-overlay",h.className="hidden",h.setAttribute("role","dialog"),h.setAttribute("aria-modal","true"),h.innerHTML='<div class="bp-overlay-backdrop" id="bp-overlay-backdrop"></div><div class="bp-overlay-panel" id="bp-overlay-panel"></div>',document.body.appendChild(h),document.getElementById("bp-overlay-backdrop").addEventListener("click",hideOverlay)),h}window.showOverlay=function(h){var $=f(),_=document.getElementById("bp-overlay-panel");_.innerHTML=h||"",$.classList.remove("hidden");var z=_.querySelector("input, textarea, select, button");z&&setTimeout(function(){try{z.focus()}catch(P){}},0)},window.hideOverlay=function(){var h=document.getElementById("bp-overlay");h&&h.classList.add("hidden")}})();function oe(){if(!Te())return s();document.title="Battle Plan – Clienti",p.innerHTML=Re()+'<div class="wrap"><div class="card"><b>Nuovo cliente</b><div class="row" style="margin-top:8px"><div><label>Ragione sociale</label><input id="cl_name" type="text" placeholder="Es. Rossi S.r.l."></div><div><label>Stato</label><select id="cl_new_state"><option value="potenziale">Potenziale</option><option value="lead non chiuso">Lead non chiuso</option><option value="attivo">Attivo</option></select></div><div><label>Consulente</label><select id="cl_new_owner"><option value="">—</option></select></div><div class="right"><button id="cl_add">Aggiungi</button></div></div></div><div class="card"><b>Filtri elenco</b><div class="row" style="margin-top:8px"><div><label>Stato</label><select id="cl_f_state"><option value="">Tutti</option><option value="attivo">Attivo</option><option value="lead non chiuso">Lead non chiuso</option><option value="potenziale">Potenziale</option></select></div><div><label>Consulente</label><select id="cl_f_cons"><option value="">Tutti</option></select></div><div><label>Ordina per</label><select id="cl_order"><option value="az">Ragione sociale (A→Z)</option><option value="last_desc">Ultimo appuntamento (recenti prima)</option></select></div><div class="right"><button class="ghost" id="cl_f_apply">Applica</button></div></div></div><div class="card"><b>Elenco clienti</b><div id="cl_list" class="row" style="margin-top:8px"></div></div></div>',Fe();function f(){const _=(document.getElementById("cl_name").value||"").trim();if(!_){me("Nome obbligatorio");return}const z=document.getElementById("cl_new_state"),P=document.getElementById("cl_new_owner"),C={name:_};z&&(C.status=z.value),P&&P.value&&(C.consultantId=P.value),qe("/api/clients",C).then(function(){document.getElementById("cl_name").value="",$(),st(),window.addXP(5)}).catch(function(g){logger.error(g),me("Errore creazione cliente")})}function h(){Ie("/api/usernames").then(function(_){const z=_&&_.users||[],P=document.getElementById("cl_f_cons"),C=document.getElementById("cl_new_owner");P&&(P.innerHTML='<option value="">Tutti</option>'+z.map(function(g){return'<option value="'+g.id+'">'+De(g.name)+(g.grade?" ("+g.grade+")":"")+"</option>"}).join("")),C&&(C.innerHTML='<option value="">—</option>'+z.map(function(g){return'<option value="'+g.id+'">'+De(g.name)+(g.grade?" ("+g.grade+")":"")+"</option>"}).join(""))}).catch(function(_){logger.error(_)})}function $(){Ie("/api/clients").then(function(_){const z=_&&_.clients||[],P=document.getElementById("cl_f_state").value,C=document.getElementById("cl_f_cons").value;function g(R){return String(R||"").trim().toLowerCase()}const I=z.filter(function(R){return!(P&&g(R.status)!==g(P)||C&&String(R.consultantId||"")!==String(C))}).map(function(R){const q=De(R.name||""),B=De(R.status||"potenziale"),E=R.consultantName?De(R.consultantName):"unknown",w=String(R.id||"");return'<div class="card" data-clid="'+w+'" data-name-lower="'+q.toLowerCase()+'" data-status="'+B+'" data-consultant-id="'+De(String(R.consultantId||""))+'" style="flex:1 1 380px"><div><b>'+q+'</b></div><div class="small">Stato: <b class="cl-status">'+B+'</b></div><div class="small">Consulente: <b class="cl-cons">'+E+'</b></div><div class="small muted">Ultimo appuntamento: <span class="last-appt">—</span></div><div class="right" style="margin-top:6px"><button class="ghost" data-del="'+w+'">Rimuovi</button></div></div>'}).join("");document.getElementById("cl_list").innerHTML=I||'<div class="muted">Nessun cliente</div>',document.querySelectorAll("[data-del]").forEach(function(R){R.addEventListener("click",function(){const q=R.getAttribute("data-del");confirm("Rimuovere il cliente?")&&fetch("/api/clients?id="+encodeURIComponent(q),{method:"DELETE",headers:{Authorization:"Bearer "+dt()}}).then(function(B){if(!B.ok)throw new Error("HTTP "+B.status);return B.json()}).then(function(){me("Cliente rimosso"),$()}).catch(function(B){logger.error(B),me("Errore rimozione")})})}),window.BPFinal&&typeof BPFinal.ensureClientSection=="function"?BPFinal.ensureClientSection():setTimeout(function(){const R=document.getElementById("cl_list"),q=Array.from(R.children).filter(B=>B.classList.contains("card"));q.sort((B,E)=>String(B.getAttribute("data-name-lower")||"").localeCompare(String(E.getAttribute("data-name-lower")||"")));for(const B of q)R.appendChild(B)},0)})}document.getElementById("cl_add").onclick=f,document.getElementById("cl_f_apply").onclick=$,h(),$(),typeof kickFinal=="function"&&kickFinal("clients")}function ve(){if(!Te())return s();document.title="Battle Plan – Squadra";var f=Re()+'<div class="wrap">'+('<div class="card"><b>Vista Amministratore</b><div id="t_adminbar" class="row" style="margin-top:8px;display:flex;align-items:flex-end;gap:16px;flex-wrap:wrap"><div><label>Modalità</label><select id="t_mode" name="mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div><div id="t_unified_wrap">'+D("t")+'</div></div></div><div class="card"><b>Riepilogo per utente</b><div id="t_users" class="row" style="margin-top:8px"></div></div><div class="card"><b>Aggregato Squadra</b><div id="t_agg" class="row" style="margin-top:8px"></div><div class="row" style="margin-top:12px;align-items:flex-end;gap:16px;flex-wrap:wrap"><div><label>Indicatore grafico</label><select id="t_ind"><option value="VSS">VSS</option><option value="VSDPersonale">VSD Personale</option><option value="VSDIndiretto">VSD Indiretto</option><option value="VSDTotale">VSD Totale</option><option value="GI">GI</option><option value="NNCF">NNCF</option><option value="provv_gi">Provv GI</option><option value="provv_vsd">Provv VSD</option><option value="tot_provv" selected>Tot Provvigioni</option></select></div><div><label>Consulente</label><select id="t_cons"><option value="">Tutti</option></select></div></div><div style="margin-top:8px"><canvas id="t_chart" height="160"></canvas></div></div>')+"</div>";p.innerHTML=f,Fe(),(function(){var H=document.getElementById("t_adminbar"),S=document.getElementById("t_unified_wrap");if(!(!H||!S)){var k=S.querySelector(".row");k&&(Array.from(k.children).forEach(function(a){a.classList.remove("right"),a.style.marginTop="0",H.appendChild(a)}),S.remove())}})();function h(T){return T=Number(T||0),isFinite(T)?T:0}function $(T){if(!T)return"";var H=new Date(T);return H.getFullYear()+"-"+("0"+(H.getMonth()+1)).slice(-2)+"-"+("0"+H.getDate()).slice(-2)}function _(T){return T=String(T||"mensile").toLowerCase(),T.indexOf("sett")===0?"settimanale":T.indexOf("mes")===0?"mensile":T.indexOf("tri")===0?"trimestrale":T.indexOf("sem")===0?"semestrale":T.indexOf("ann")===0?"annuale":"mensile"}function z(){var T=W("t"),H=$(T.start),S=$(T.end),k=_(T.type);return"&from="+encodeURIComponent(H)+"&to="+encodeURIComponent(S)+"&type="+encodeURIComponent(k)}function P(T){switch(String(T)){case"provv_gi":return"ProvvGI";case"provv_vsd":return"ProvvVSD";case"tot_provv":return"TotProvvigioni";default:return T}}function C(T){var H=Number(T)||0;return H.toLocaleString("it-IT")+"€"}function g(T){var H=Number(T)||0;return String(Math.round(H))}function G(T){return String(T).replace(/[&<>'"]/g,H=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[H])}var I=null;function R(T,H){return H==="settimanale"?window.isoWeekNum?window.isoWeekNum(T):Math.ceil(T.getDate()/7):H==="mensile"||H==="ytd"||H==="ltm"?T.getMonth()+1:H==="trimestrale"?Math.floor(T.getMonth()/3)+1:H==="semestrale"?T.getMonth()<6?1:2:T.getFullYear()}function q(T,H){var S=document.getElementById("t_chart");if(S){var k=M(H),a=typeof F=="function"?F(H,k):T.map(function(c){return R(c.x,H)}),n=T.map(function(c){return c.y});if(typeof Chart>"u"){var o=S.getContext("2d");S.width=S.clientWidth||600,S.height=S.clientHeight||160,o.clearRect(0,0,S.width,S.height);var t=Math.max(1,...n),e=n.length>1?(S.width-8)/(n.length-1):0;o.beginPath(),o.lineWidth=2,o.strokeStyle="#2e6cff",n.forEach(function(u,l){var i=4+l*e,r=S.height-6-u/t*(S.height-12);l?o.lineTo(i,r):o.moveTo(i,r)}),o.stroke(),o.fillStyle="#2e6cff",n.forEach(function(u,l){var i=4+l*e,r=S.height-6-u/t*(S.height-12);o.beginPath(),o.arc(i,r,2,0,Math.PI*2),o.fill()});return}var o=S.getContext("2d"),b=typeof window.computeTickOptions=="function"?window.computeTickOptions(a,S.width||600):{autoSkip:!0,maxRotation:0,minRotation:0};if(I)I.data.labels=a,I.data.datasets[0].data=n,I.options.scales.x.ticks=b,I.update();else{var v=typeof Chart.getChart=="function"?Chart.getChart(S):null;v&&v.destroy(),I=new Chart(o,{type:"line",data:{labels:a,datasets:[{label:"",data:n,tension:.3,pointRadius:3,pointHoverRadius:5}]},options:{responsive:!1,maintainAspectRatio:!1,animation:!1,animations:!1,plugins:{legend:{display:!1}},scales:{x:{grid:{display:!1},ticks:b},y:{beginAtZero:!0}}}})}}}function B(T){return'<div class="card" style="flex:1 1 360px"><div style="display:flex;align-items:center;gap:8px"><div><b>'+G(T.name||"User #"+T.userId)+"</b></div>"+(T.grade?'<span class="chip small">'+G(T.grade)+"</span>":"")+'</div><div class="small" style="margin-top:6px">VSS '+C(T.vss||0)+'</div><div class="small">VSD Pers. '+C(T.vsdP||0)+'</div><div class="small">VSD Ind. '+C(T.vsdI||0)+'</div><div class="small">VSD Tot. '+C((T.vsdP||0)+(T.vsdI||0))+'</div><div class="small">GI '+C(T.gi||0)+'</div><div class="small">NNCF '+g(T.nncf||0)+'</div><div class="small muted" style="margin-top:6px">Provv GI '+C(T.provvGi||0)+'</div><div class="small muted">Provv VSD '+C(T.provvVsd||0)+'</div><div class="small"><b>Tot Provvigioni '+C(T.provvTot||0)+"</b></div></div>"}function E(T){return'<div class="card" style="flex:1 1 460px"><div class="neon" style="font-weight:900">Totali squadra</div><div class="small" style="margin-top:6px">VSS '+C(T.vss)+'</div><div class="small">VSD Pers. '+C(T.vsdP)+'</div><div class="small">VSD Ind. '+C(T.vsdI)+'</div><div class="small">VSD Tot. '+C(T.vsdP+T.vsdI)+'</div><div class="small">GI '+C(T.gi)+'</div><div class="small">NNCF '+g(T.nncf)+'</div><div class="small muted" style="margin-top:6px">Provv GI '+C(T.provvGi)+'</div><div class="small muted">Provv VSD '+C(T.provvVsd)+'</div><div class="small"><b>Tot Provvigioni '+C(T.provvTot)+"</b></div></div>"}function w(){var T=(document.getElementById("t_mode")||{}).value||"consuntivo",H=z();Promise.all([Ie("/api/usernames"),Ie("/api/leaderboard?indicator="+encodeURIComponent("VSS")+H+"&mode="+encodeURIComponent(T)),Ie("/api/leaderboard?indicator="+encodeURIComponent("VSDPersonale")+H+"&mode="+encodeURIComponent(T)),Ie("/api/leaderboard?indicator="+encodeURIComponent("VSDIndiretto")+H+"&mode="+encodeURIComponent(T)),Ie("/api/leaderboard?indicator="+encodeURIComponent("GI")+H+"&mode="+encodeURIComponent(T)),Ie("/api/leaderboard?indicator="+encodeURIComponent("NNCF")+H+"&mode="+encodeURIComponent(T)),Ie("/api/leaderboard?indicator="+encodeURIComponent("ProvvGI")+H+"&mode="+encodeURIComponent(T)),Ie("/api/leaderboard?indicator="+encodeURIComponent("ProvvVSD")+H+"&mode="+encodeURIComponent(T))]).then(function(S){var k=S[0]||{},a=S[1]&&(S[1].rows||S[1].ranking)||[],n=S[2]&&(S[2].rows||S[2].ranking)||[],t=S[3]&&(S[3].rows||S[3].ranking)||[],e=S[4]&&(S[4].rows||S[4].ranking)||[],o=S[5]&&(S[5].rows||S[5].ranking)||[],b=S[6]&&(S[6].rows||S[6].ranking)||[],v=S[7]&&(S[7].rows||S[7].ranking)||[],c=(k.users||[]).map(function(Y){return{id:String(Y.id),name:Y.name||Y.email||"User #"+Y.id,grade:Y.grade==="senior"?"senior":"junior"}}),u=document.getElementById("t_cons");u&&(u.innerHTML='<option value="">Tutti</option>'+c.map(function(Y){return'<option value="'+Y.id+'">'+G(Y.name)+"</option>"}).join(""));function l(Y){for(var le={},ce=0;ce<Y.length;ce++){var ge=Y[ce],Se=String(ge.userId||ge.id||ge.uid||""),be=h(ge.total||ge.value||ge.sum||0);Se&&(le[Se]=be)}return le}var i=l(a),r=l(n),d=l(t),m=l(e),y=l(o),A=l(b),J=l(v),ae=c.map(function(Y){var le=h(i[Y.id]),ce=h(r[Y.id]),ge=h(d[Y.id]),Se=h(m[Y.id]),be=h(y[Y.id]),Be=h(A[Y.id]),Oe=h(J[Y.id]);return{userId:Y.id,name:Y.name,grade:Y.grade,vss:le,vsdP:ce,vsdI:ge,gi:Se,nncf:be,provvGi:Be,provvVsd:Oe,provvTot:Be+Oe}}),x=document.getElementById("t_users");x&&(x.innerHTML=ae.length?ae.map(B).join(""):'<div class="muted">Nessun dato</div>');var U=ae.reduce(function(Y,le){return Y.vss+=le.vss,Y.vsdP+=le.vsdP,Y.vsdI+=le.vsdI,Y.gi+=le.gi,Y.nncf+=le.nncf,Y.provvGi+=le.provvGi,Y.provvVsd+=le.provvVsd,Y.provvTot+=le.provvTot,Y},{vss:0,vsdP:0,vsdI:0,gi:0,nncf:0,provvGi:0,provvVsd:0,provvTot:0}),se=document.getElementById("t_agg");se&&(se.innerHTML=E(U)),L()}).catch(function(S){logger.error(S),me("Errore caricamento squadra")})}function M(T){return(typeof te=="function"?te(T,new Date):[]).map(function(H){return{s:H.s,e:H.e}})}function O(T,H,S,k){var a=k||W("t"),n=String(a.type||"mensile").toLowerCase(),t=n==="ytd"||n==="ltm"?"mensile":n,e=M(n);function o(c,u){var l=new Date(u.startDate).getTime(),i=new Date(u.endDate).getTime();return l>=c.s&&i<=c.e}function b(c,u){if(!c)return 0;if(u==="VSDTotale")return Number(c.VSDPersonale||0)+Number(c.VSDIndiretto||0);if(u==="ProvvGI")return Number(c.ProvvGI||0);if(u==="ProvvVSD")return Number(c.ProvvVSD||0);if(u==="TotProvvigioni"){var l=c.TotProvvigioni;return Number(l!=null?l:Number(c.ProvvGI||0)+Number(c.ProvvVSD||0))}return Number(c[u]||0)}var v=(function(){var c=e.length?$(new Date(e[0].s)):$(new Date),u=e.length?$(new Date(e[e.length-1].e)):$(new Date),l="?global=1&type="+encodeURIComponent(t)+"&from="+encodeURIComponent(c)+"&to="+encodeURIComponent(u);return S&&(l+="&userId="+encodeURIComponent(S)),l})();return Ie("/api/periods"+v).catch(function(){return Ie("/api/periods"+v.replace("?global=1",""))}).then(function(c){var u=c&&c.periods||[],l=u.filter(function(r){return!(r.type!==t||S&&String(r.userId||r.uid||"")!==String(S))}),i=e.map(function(r){for(var d=0,m=0;m<l.length;m++){var y=l[m];if(o(r,y)){var A=H==="previsionale"?y.indicatorsPrev||{}:y.indicatorsCons||{};d+=b(A,P(T))}}return{x:new Date(r.s),y:Math.round(d*100)/100}});return i})}function L(){var T=document.getElementById("t_ind").value,H=document.getElementById("t_mode").value||"consuntivo",S=document.getElementById("t_cons").value||"",k=W("t"),a=k.type,n=P(T);z()+(S?"&userId="+encodeURIComponent(S):"")+("&indicator="+encodeURIComponent(n))+("&mode="+encodeURIComponent(H));var t=O(n,H,S||null,k);t.then(function(e){q(e,a)}).catch(function(e){logger.error(e),q([],a)})}j("t",function(){typeof haptic=="function"&&haptic("light"),w()}),document.getElementById("t_mode").onchange=function(){typeof haptic=="function"&&haptic("light"),w()},document.getElementById("t_ind").onchange=function(){typeof haptic=="function"&&haptic("light"),L()},document.getElementById("t_cons").onchange=function(){typeof haptic=="function"&&haptic("light"),L()},w()}function de(){if(!Te())return s();var f=Te().role==="admin";document.title="Battle Plan – Provvigioni",p.innerHTML=Re()+'<div class="wrap"><div class="card"><b>Calcolo provvigioni</b><div class="row" style="margin-top:8px; gap:12px; flex-wrap:wrap">'+(f?'<div><label>Utente</label><select id="comm_user"><option value="__all">Tutta la squadra</option></select></div>':"")+'<div><label>Modalità</label><select id="comm_mode" name="mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div></div>'+D("comm")+'</div><div class="card"><b>Indicatori periodo</b><div id="comm_total" class="row" style="margin-top:8px; gap:12px; flex-wrap:wrap"></div></div><div class="card"><b>Provvigioni – ripartizione</b><div class="small muted">Confronto tra Provvigioni GI e Provvigioni VSD sul periodo selezionato</div><div class="row" style="margin-top:8px; align-items:center; gap:16px; flex-wrap:wrap"><canvas id="cm_pie_provv" width="260" height="260" style="max-width:260px; max-height:260px"></canvas><div id="cm_pie_legend" class="small"></div></div></div><div class="card"><b>Dettaglio</b><div id="comm_rows" class="row" style="margin-top:8px; gap:12px; flex-wrap:wrap"></div></div></div>',Fe();function h(B){return document.getElementById(B)}function $(B){if(!B)return"";var E=new Date(B);return E.getFullYear()+"-"+("0"+(E.getMonth()+1)).slice(-2)+"-"+("0"+E.getDate()).slice(-2)}function _(B){var E=Number(B)||0;return E.toLocaleString("it-IT")+"€"}function z(B){return B=Number(B==null?"":B),isFinite(B)?B:0}function P(B){return B?B.TotProvvigioni!=null?z(B.TotProvvigioni):z(B.ProvvGI)+z(B.ProvvVSD):0}function C(B,E){return'<div class="card" style="flex:1 1 180px"><div class="small muted">'+De(B)+'</div><div style="font-weight:700; font-size:20px; margin-top:4px">'+E+"</div></div>"}function g(B){return""+C("VSD personale",_(B.vsd||0))+C("GI",_(B.gi||0))+C("Provv. VSD",_(B.provv_vsd||0))+C("Provv. GI",_(B.provv_gi||0))+C("Totale Provvigioni",_(B.provv_total||0))}function G(B){return B.length?B.map(function(E){return'<div class="card" style="flex:1 1 320px"><div><b>'+De(E.name)+'</b></div><div class="small" style="margin-top:4px">GI '+_(E.gi||0)+" · VSD "+_(E.vsd||0)+'</div><div class="small muted" style="margin-top:2px">Provv. GI '+_(E.provv_gi||0)+" · Provv. VSD "+_(E.provv_vsd||0)+'</div><div class="small" style="margin-top:6px"><b>Totale: '+_(E.provv_total||0)+"</b></div></div>"}).join(""):'<div class="muted">Nessun dato</div>'}function I(B,E,w){var M=document.getElementById("cm_pie_provv"),O=document.getElementById("cm_pie_legend");if(!M||!M.getContext){O&&(O.innerHTML="");return}var L=M.getContext("2d"),T=M.width,H=M.height,S=T/2,k=H/2,a=Math.min(T,H)/2-8;L.clearRect(0,0,T,H);var n=Math.max(0,B||0),t=Math.max(0,E||0),e=n+t,o=w>0?Math.round(e/w*100):null;if(e<=0){L.beginPath(),L.arc(S,k,a,0,Math.PI*2),L.strokeStyle="#ccd0d5",L.lineWidth=10,L.setLineDash([6,6]),L.stroke(),L.setLineDash([]),L.globalCompositeOperation="destination-out",L.beginPath(),L.arc(S,k,a*.55,0,Math.PI*2),L.fill(),L.globalCompositeOperation="source-over",L.fillStyle="#111",L.textAlign="center",L.textBaseline="middle",L.font="bold 20px system-ui, -apple-system, Segoe UI, Roboto, sans-serif",L.fillText(o==null?"—":o+"%",S,k),O&&(O.innerHTML='<div class="muted">Nessuna provvigione nel periodo</div>');return}var b=[{label:"Provv. GI",value:n,color:"#4F8EF7"},{label:"Provv. VSD",value:t,color:"#F79F4F"}],v=-Math.PI/2;b.forEach(function(l){var i=l.value/e*Math.PI*2;L.beginPath(),L.moveTo(S,k),L.arc(S,k,a,v,v+i),L.closePath(),L.fillStyle=l.color,L.fill(),v+=i}),L.globalCompositeOperation="destination-out",L.beginPath(),L.arc(S,k,a*.55,0,Math.PI*2),L.fill(),L.globalCompositeOperation="source-over",L.fillStyle="#111",L.textAlign="center",L.textBaseline="middle",L.font="bold 20px system-ui, -apple-system, Segoe UI, Roboto, sans-serif",L.fillText(o==null?"—":o+"%",S,k);var c=Math.round(n/e*100),u=Math.round(t/e*100);O&&(O.innerHTML='<div class="row" style="gap:16px; flex-wrap:wrap"><div class="row" style="gap:8px; align-items:center"><span style="display:inline-block;width:12px;height:12px;background:#4F8EF7;border-radius:3px"></span><span><b>Provv. GI</b> '+_(n)+" · "+c+'%</span></div><div class="row" style="gap:8px; align-items:center"><span style="display:inline-block;width:12px;height:12px;background:#F79F4F;border-radius:3px"></span><span><b>Provv. VSD</b> '+_(t)+" · "+u+"%</span></div></div>")}function R(){var B=W("comm"),E=h("comm_mode").value||"consuntivo",w=f?h("comm_user").value||"__all":String(Te().id),M=new Date(B.start).getTime(),O=new Date(B.end).getTime(),L=ee(B.type||"mensile"),T=(function(){var H=$(new Date(M)),S=$(new Date(O)),k="?type="+encodeURIComponent(L)+"&from="+encodeURIComponent(H)+"&to="+encodeURIComponent(S);return f&&w&&w!=="__all"&&(k+="&userId="+encodeURIComponent(w)),k})();Ie("/api/periods"+T).then(function(H){var S=H&&H.periods||[],k=S.filter(function(t){if(t.type!==L)return!1;var e=new Date(t.startDate).getTime(),o=new Date(t.endDate).getTime();return!(e<M||o>O||f&&w!=="__all"&&String(t.userId||t.uid||"")!==String(w)||!f&&String(t.userId||t.uid||"")!==String(Te().id))}),a={gi:0,vsd:0,provv_gi:0,provv_vsd:0,provv_total:0},n={};k.forEach(function(t){var e=E==="previsionale"?t.indicatorsPrev||{}:t.indicatorsCons||{},o=String(t.userId||t.uid||""),b=t.userName||t.name||"User "+o,v=z(e.GI),c=z(e.VSDPersonale),u=z(e.ProvvGI),l=z(e.ProvvVSD),i=P(e);a.gi+=v,a.vsd+=c,a.provv_gi+=u,a.provv_vsd+=l,a.provv_total+=i,n[o]||(n[o]={userId:o,name:b,gi:0,vsd:0,provv_gi:0,provv_vsd:0,provv_total:0}),n[o].gi+=v,n[o].vsd+=c,n[o].provv_gi+=u,n[o].provv_vsd+=l,n[o].provv_total+=i}),h("comm_total").innerHTML=g(a),h("comm_rows").innerHTML=G(Object.values(n).sort(function(t,e){return(e.provv_total||0)-(t.provv_total||0)})),I(a.provv_gi||0,a.provv_vsd||0,a.gi||0)}).catch(function(H){logger.error(H),me("Errore nel caricamento dati")})}function q(){f&&Ie("/api/usernames").then(function(B){var E=h("comm_user");if(E){for(var w='<option value="__all">Tutta la squadra</option>',M=B&&B.users||[],O=0;O<M.length;O++){var L=M[O];w+='<option value="'+L.id+'">'+De(L.name||"User "+L.id)+"</option>"}E.innerHTML=w}})}j("comm",function(){R()}),h("comm_mode").onchange=function(){haptic("light"),R()},f&&(h("comm_user").onchange=function(){haptic("light"),R()}),q(),R()}function Ce(){if(!Te())return s();document.title="Battle Plan – Vendite e Riordini",p.innerHTML=Re()+'\n    <div class="wrap">\n\n      <div class="card">\n        <b>Filtro</b>\n        <div class="row" style="margin-top:6px;align-items:flex-end;gap:16px;flex-wrap:wrap">\n          <div>\n            <label>Consulente</label>\n            <select id="vr_cons"><option value="">Tutti</option></select>\n          </div>\n        </div>\n        '.concat(D("vr"),'\n      </div>\n\n      <div class="card">\n        <b>Vendite e Riordini</b>\n        <div class="table" style="overflow:auto">\n          <table class="simple" style="min-width:980px">\n            <thead>\n              <tr>\n                <th>Data</th>\n                <th>Cliente</th>\n                <th>Consulente</th>\n              </tr>\n            </thead>\n            <tbody id="vr_rows">\n              <tr><td colspan="3" class="muted">Nessun dato</td></tr>\n            </tbody>\n          </table>\n        </div>\n      </div>\n\n    </div>'),Fe(),j("vr",()=>{})}function fe(){if(!Te())return s();document.title="Battle Plan – GI & Scadenzario",p.innerHTML=Re()+'\n  <div class="wrap">\n\n    <div class="card">\n      <b>Filtro</b>\n      <div class="row" style="margin-top:6px;align-items:flex-end;gap:16px;flex-wrap:wrap">\n        <div>\n          <label>Consulente</label>\n          <select id="gi_cons"><option value="">Tutti</option></select>\n        </div>\n      </div>\n      '.concat(D("gi"),'\n    </div>\n\n    <div class="card">\n      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">\n        <b>Vendite (GI)</b>\n        <button class="ghost" id="gi_add">Nuova vendita</button>\n      </div>\n      <div class="table" style="overflow:auto">\n        <table class="simple" style="min-width:980px">\n          <thead>\n            <tr>\n              <th>Data vendita</th>\n              <th>Cliente</th>\n              <th>Consulente</th>\n              <th>Servizi</th>\n              <th style="text-align:right">Tot. VSS</th>\n              <th>Piano pagamenti</th>\n              <th></th>\n            </tr>\n          </thead>\n          <tbody id="gi_rows"></tbody>\n        </table>\n      </div>\n    </div>\n\n  </div>'),Fe();const f=E=>document.getElementById(E),h=E=>String(E||"").replace(/[&<>'"]/g,w=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[w]),$=E=>(Number(E)||0).toLocaleString("it-IT")+"€",_=E=>{const w=new Date(E);return w.getFullYear()+"-"+("0"+(w.getMonth()+1)).slice(-2)+"-"+("0"+w.getDate()).slice(-2)};function z(){const E=window.readUnifiedRange&&window.readUnifiedRange("gi")||{};if(!E||!E.start||!E.end){const w=new Date,M=new Date(w.getFullYear(),0,1),O=new Date(w.getFullYear(),11,31,23,59,59);return{from:_(M),to:_(O)}}return{from:_(E.start),to:_(E.end)}}let P=[];function C(){return Ie("/api/clients").then(E=>(P=E&&E.clients||[],Ie("/api/usernames"))).then(E=>{const w=E&&E.users||[],M=f("gi_cons");M&&(M.innerHTML='<option value="">Tutti</option>'+w.map(O=>'<option value="'+h(String(O.id))+'">'+h(O.name)+"</option>").join(""))})}function g(E){const w=Array.isArray(E.schedule)?E.schedule.slice():[];if(!w.length)return'<span class="muted">—</span>';const M=w.find(S=>S.kind==="deposit"||/acconto/i.test(S.note||"")),O=w.filter(S=>S!==M),L=M?"Acconto: "+$(M.amount):"";if(!O.length)return L||'<span class="muted">—</span>';const T=Math.round(O[0].amount||0),H=O.every(S=>Math.abs(Math.round(S.amount||0)-T)<=1);return(L?L+" + ":"")+(H?O.length+" rate da "+$(T):"piano personalizzato")}function G(E){return'<tr data-id="'+h(String(E.id))+'"><td>'+new Date(E.date||E.createdAt).toLocaleDateString("it-IT")+"</td><td>"+h(E.clientName||"")+"</td><td>"+h(E.consultantName||"")+"</td><td>"+h(E.services||"")+'</td><td style="text-align:right"><b>'+$(E.vssTotal||0)+"</b></td><td>"+g(E)+'</td><td class="right"><button class="ghost" data-edit="'+h(String(E.id))+'">Modifica</button></td></tr>'}function I(){const E=z(),w=(f("gi_cons")||{}).value||"",M="?from="+encodeURIComponent(E.from)+"&to="+encodeURIComponent(E.to)+(w?"&userId="+encodeURIComponent(w):"");Ie("/api/gi"+M).then(O=>{let L=O&&O.sales||[];L.sort((T,H)=>+new Date(H.date||H.createdAt||0)-+new Date(T.date||T.createdAt||0)),f("gi_rows").innerHTML=L.length?L.map(G).join(""):'<tr><td colspan="7" class="muted">Nessuna vendita</td></tr>',q()}).catch(O=>{logger.error(O),me("Errore caricamento GI")})}function R(E){const w=E.sale||{},M=Array.isArray(w.schedule)?w.schedule.slice():[],O=M.find(d=>d.kind==="deposit"||/acconto/i.test(d.note||"")),L=M.filter(d=>d!==O),T=L.length>0?L.every(d=>Math.abs((+d.amount||0)-(+L[0].amount||0))<=1):!0,H=L.length&&T?"rate":"manual",S=_(new Date),k='<div class="modal"><div class="card gi-modal"><style>.gi-modal{min-width:min(760px,96vw);max-width:980px;max-height:86vh;overflow:auto}@media (max-width:740px){ .gi-grid{display:block} .gi-col{width:100%} .gi-modal{min-width:96vw} }.gi-grid{display:flex; gap:12px; flex-wrap:wrap} .gi-col{flex:1; min-width:240px}.gi-section{border-top:1px solid var(--hair, rgba(0,0,0,.12)); padding-top:10px; margin-top:10px}.pilltabs{display:flex; gap:12px; align-items:center} .pilltabs label{display:flex; align-items:center; gap:6px; cursor:pointer}.mrow{display:flex; gap:8px; align-items:center; flex-wrap:wrap}.mini input[type=number]{width:120px}.gi-rlist{margin-top:6px; max-height:200px; overflow:auto; border:1px dashed rgba(0,0,0,.15); border-radius:8px; padding:6px}.gi-r{display:flex; gap:6px; align-items:center; padding:4px 0}.gi-foot{display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:12px}</style><div style="display:flex;justify-content:space-between;align-items:center"><b>'+(E.title||(w.id?"Modifica vendita":"Nuova vendita"))+'</b><button class="ghost" id="m_close">Chiudi</button></div><div class="gi-grid"><div class="gi-col"><label>Data</label><input id="m_date" type="date" value="'+h(_(w.date||S))+'"></div><div class="gi-col"><label>Cliente</label><select id="gi_client_select"><option value="">Caricamento…</option></select></div><div class="gi-col"><label>Totale VSS</label><input id="m_vss" type="number" step="1" value="'+h(Number(w.vssTotal||0))+'"></div></div><div class="gi-section"><label>Servizi</label><textarea id="m_srv" rows="2">'+h(w.services||"")+'</textarea></div><div class="gi-section"><b>Acconto</b><div class="mrow mini" style="margin-top:6px"><label><input id="acc_enable" type="checkbox" '+(O?"checked":"")+'> Abilita</label><label>Tipo</label><select id="acc_type"><option value="abs">Valore assoluto</option><option value="perc">Percentuale</option></select><label>Valore</label><input id="acc_value" type="number" step="1" value="'+(O?h(Number(O._fromPerc?O._rawPerc:O.amount)):"0")+'"><label>Scadenza</label><input id="acc_date" type="date" value="'+h(_(O?O.dueDate:w.date||S))+'"><label>Nota</label><input id="acc_note" placeholder="es. Acconto" value="'+h(O&&O.note||"Acconto")+'"></div></div><div class="gi-section"><b>Modalità pagamenti</b><div class="pilltabs" style="margin:6px 0 8px"><label><input type="radio" name="pmode" value="rate" '+(H==="rate"?"checked":"")+'> Rateale</label><label><input type="radio" name="pmode" value="manual" '+(H!=="rate"?"checked":"")+'> Scaglioni manuali</label></div><div id="p_rate" style="display:'+(H==="rate"?"block":"none")+'"><div class="mrow mini"><label>N° rate</label><input id="rt_n" type="number" value="'+h(L.length||12)+'"><label>Frequenza</label><select id="rt_freq"><option value="M">Mensile</option><option value="Q">Trimestrale</option><option value="W">Settimanale</option><option value="Y">Annuale</option></select><label>Prima scadenza</label><input id="rt_first" type="date" value="'+h(L[0]?_(L[0].dueDate):_(w.date||S))+'"><button class="ghost" id="rt_build">Ricalcola rate</button></div><div id="rt_preview" class="gi-rlist muted small">—</div></div><div id="p_manual" style="display:'+(H!=="rate"?"block":"none")+'"><div class="mrow mini"><button class="ghost" id="mn_add">Aggiungi scaglione</button></div><div id="mn_list" class="gi-rlist"></div></div></div><div class="gi-foot"><div><div id="tot_prog" class="small muted">Programmato: 0€</div><div id="tot_chk"  class="small muted">Totale VSS: 0€</div></div><div style="display:flex;gap:8px">'+(w.id?'<button class="ghost danger" id="m_del">Elimina</button>':"")+'<button id="m_save">Salva</button></div></div></div></div>';showOverlay(k);const a=document.documentElement.style.overflow;document.documentElement.style.overflow="hidden";function n(){document.documentElement.style.overflow=a,hideOverlay()}(function(){const m=f("gi_client_select");m.innerHTML='<option value="">— seleziona cliente —</option>'+P.map(A=>'<option value="'+h(A.id)+'">'+h(A.name)+"</option>").join("");const y=w.clientId||w.client_id||"";if(y&&(m.value=String(y)),!m.value&&w.clientName){const A=P.find(J=>String(J.name).trim().toLowerCase()===String(w.clientName).trim().toLowerCase());A&&(m.value=String(A.id))}})(),O&&O._fromPerc&&(f("acc_type").value="perc"),Array.from(document.querySelectorAll('input[name="pmode"]')).forEach(d=>{d.addEventListener("change",()=>{const m=document.querySelector('input[name="pmode"]:checked').value==="rate";f("p_rate").style.display=m?"block":"none",f("p_manual").style.display=m?"none":"block",r()})});function t(d,m){const y=new Date(d);return y.setMonth(y.getMonth()+m),y}function e(d,m){const y=new Date(d);return y.setDate(y.getDate()+m*7),y}function o(d,m){const y=new Date(d);return y.setMonth(y.getMonth()+m*3),y}function b(d,m){const y=new Date(d);return y.setFullYear(y.getFullYear()+m),y}function v(){const d=Math.max(1,Number(f("rt_n").value||0)),m=f("rt_freq").value,y=new Date(f("rt_first").value||S),A=Math.max(0,Number(f("m_vss").value||0)),J=l(),ae=Math.max(0,A-J),x=Math.round(ae/d),U=[];for(let se=0;se<d;se++){let Y;m==="M"?Y=t(y,se):m==="Q"?Y=o(y,se):m==="W"?Y=e(y,se):Y=b(y,se),U.push({dueDate:Y.toISOString(),amount:x,note:"Rata "+(se+1)+"/"+d,kind:"installment"})}return c(U),U}function c(d){f("rt_preview").innerHTML=d.map(m=>"<div>"+new Date(m.dueDate).toLocaleDateString("it-IT")+" · "+$(m.amount)+' <span class="muted">'+h(m.note||"")+"</span></div>").join(""),f("rt_preview")._data=d,r()}function u(d){const m=f("mn_list");m.innerHTML="",d.forEach((y,A)=>{const J=document.createElement("div");J.className="gi-r",J.innerHTML='<input type="date" data-k="dueDate" value="'+h(_(y.dueDate))+'"><input type="number" step="1" data-k="amount" value="'+h(Number(y.amount||0))+'" style="width:120px"><input type="text" data-k="note"   value="'+h(y.note||"")+'" placeholder="nota" style="flex:1"><button class="ghost" data-del="'+A+'">✕</button>',m.appendChild(J)}),m.querySelectorAll("[data-del]").forEach(y=>{y.onclick=()=>{const A=Number(y.getAttribute("data-del")),J=m._data||[];J.splice(A,1),u(J)}}),m.oninput=()=>{const y=m._data||[];Array.from(m.children).forEach((J,ae)=>{const x=y[ae];if(!x)return;const U=J.querySelector('[data-k="dueDate"]').value,se=Number(J.querySelector('[data-k="amount"]').value||0),Y=J.querySelector('[data-k="note"]').value;x.dueDate=new Date(U).toISOString(),x.amount=Math.round(se),x.note=Y}),r()},m._data=d,r()}if(f("m_date").value=h(_(w.date||S)),f("m_vss").value=h(Number(w.vssTotal||0)),f("m_srv").value=h(w.services||""),f("acc_type").value=O&&O._fromPerc?"perc":"abs",f("acc_value").value=O?O._fromPerc?O._rawPerc:O.amount:0,f("acc_date").value=h(_(O?O.dueDate:w.date||S)),f("acc_note").value=O?h(O.note||"Acconto"):"Acconto",H==="rate"){const d=L.length||12;f("rt_n").value=d,f("rt_first").value=L[0]?h(_(L[0].dueDate)):h(_(w.date||S)),c(L.length?L:v())}else u(L);f("rt_build").onclick=()=>c(v()),f("mn_add").onclick=()=>{const m=f("mn_list")._data||[];m.push({dueDate:new Date().toISOString(),amount:0,note:"",kind:"manual"}),u(m)},f("m_close").onclick=n;function l(){if(!f("acc_enable").checked)return 0;const d=Math.max(0,Number(f("m_vss").value||0)),m=f("acc_type").value,y=Number(f("acc_value").value||0);return Math.round(m==="perc"?d*(y/100):y)}function i(){const d=[];if(f("acc_enable").checked){const y=l();d.push({dueDate:new Date(f("acc_date").value||S).toISOString(),amount:y,note:f("acc_note").value||"Acconto",kind:"deposit",_fromPerc:f("acc_type").value==="perc",_rawPerc:Number(f("acc_value").value||0)})}if(document.querySelector('input[name="pmode"]:checked').value==="rate"){const y=(f("rt_preview")._data||[]).map(A=>Object.assign({},A));return d.concat(y)}else{const y=(f("mn_list")._data||[]).map(A=>Object.assign({kind:"manual"},A));return d.concat(y)}}function r(){const d=Math.max(0,Number(f("m_vss").value||0)),m=i(),y=Math.round(m.reduce((A,J)=>A+Number(J.amount||0),0));f("tot_prog").textContent="Programmato: "+$(y),f("tot_chk").textContent="Totale VSS: "+$(d)+(y===d?" OK":" (manca "+$(d-y)+")"),f("m_save").disabled=y!==d||!f("gi_client_select").value}if(["m_vss","acc_enable","acc_type","acc_value","acc_date","rt_n","rt_freq","rt_first"].forEach(d=>{const m=f(d);m&&m.addEventListener("input",r)}),f("gi_client_select").addEventListener("change",r),r(),f("m_save").onclick=()=>{const d=f("gi_client_select").value||"",m=P.find(A=>String(A.id)===String(d));if(!m){me("Seleziona un cliente");return}const y={id:w.id||void 0,date:new Date(f("m_date").value||S).toISOString(),clientId:m.id,clientName:m.name,vssTotal:Math.round(Number(f("m_vss").value||0)),services:f("m_srv").value||"",schedule:i()};Promise.resolve(qe("/api/gi",y)).then(()=>{n(),haptic("light"),I()}).catch(A=>{logger.error(A),me("Errore salvataggio")})},w.id){const d=f("m_del");d&&(d.onclick=async()=>{if(confirm("Eliminare definitivamente questa vendita?"))try{await qe("/api/gi/delete",{id:w.id}).catch(()=>qe("/api/gi",{id:w.id,_delete:1})),n(),me("Vendita eliminata"),I()}catch(m){logger.error(m),me("Errore eliminazione")}})}}function q(){document.querySelectorAll("[data-edit]").forEach(E=>{E.addEventListener("click",()=>{const w=E.getAttribute("data-edit");B(w)})})}document.addEventListener("gi:edit",function(E){const w=E&&E.detail&&E.detail.id;w&&B(w)}),f("gi_add").onclick=()=>{R({title:"Nuova vendita"})};function B(E){Ie("/api/gi?from=1900-01-01&to=2999-12-31").then(w=>{const M=(w&&w.sales||[]).find(O=>String(O.id)===String(E));if(!M){me("Vendita non trovata");return}R({title:"Modifica vendita",sale:M})})}j("gi",()=>{haptic("light"),I()}),(f("gi_cons")||{}).onchange=()=>{haptic("light"),I()},C().then(I)}window.viewGI=window.viewGI||fe;function _e(){if(!Te())return s();document.title="Battle Plan – Report",p.innerHTML=Re()+'<div class="wrap"><div class="card"><b>Sezioni da includere</b><div id="rep_toggles" class="row" style="margin-top:8px; gap:8px; flex-wrap:wrap"><button class="pill" data-type="mensile" id="tog_mese">Mese</button><button class="pill" data-type="trimestrale" id="tog_trimestre">Trimestre</button><button class="pill" data-type="semestrale" id="tog_semestre">Semestre</button><button class="pill" data-type="annuale" id="tog_anno">Anno</button></div></div><div class="card"><b>Report</b><div class="row" style="margin-top:8px"><div style="min-width:320px"><label>Oggetto email</label><input id="report_subject" placeholder="Report BP"></div></div><div class="row" style="margin-top:8px; flex-wrap:wrap"><div style="flex:1 1 100%; min-width:0"><label>Corpo email</label><textarea id="report_body" rows="12" placeholder="Testo del report…" style="width:100%; box-sizing:border-box; overflow:auto; resize:vertical; max-height:70vh; white-space:pre-wrap; word-break:break-word"></textarea></div></div><div class="row" id="report-actions" style="gap:8px;margin-top:8px;flex-wrap:wrap"><button class="ghost" id="rep_copy">Copia report</button><span style="flex:0 0 8px"></span><button class="ghost" id="rep_gmail_web">Gmail Web</button><button class="ghost" id="rep_gmail_app">Gmail App</button></div></div></div>',Fe();var f=[],h={mensile:!1,trimestrale:!1,semestrale:!1,annuale:!1},$=[{k:"VSS",money:!0,label:"VSS"},{k:"VSDPersonale",money:!0,label:"VSDPersonale"},{k:"VSDIndiretto",money:!0,label:"VSDIndiretto"},{k:"GI",money:!0,label:"GI"},{k:"Telefonate",money:!1,label:"Telefonate"},{k:"AppFissati",money:!1,label:"AppFissati"},{k:"AppFatti",money:!1,label:"AppFatti"},{k:"CorsiLeadership",money:!1,label:"CorsiLeadership"},{k:"iProfile",money:!1,label:"iProfile"},{k:"MBS",money:!1,label:"MBS"},{k:"NNCF",money:!1,label:"NNCF"}];function _(x){return document.getElementById(x)}var z=_("report_body");function P(x,U){var se=new Date(x.getTime());return se.setDate(se.getDate()+U),se}function C(x){return et(x.getFullYear(),Ae(x))}function g(x){var U=C(x);return C(P(U.start,7))}function G(x){var U=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];return U[x.getMonth()]}function I(x){return Math.floor(x.getMonth()/3)+1}function R(x){return x.getMonth()<6?1:2}function q(x){var U=x.getDay();return U===5||U===6||U===0}function B(x,U){return x==="mensile"?{start:ft(U),end:gt(U)}:x==="trimestrale"?{start:ut(U),end:ht(U)}:x==="semestrale"?{start:pt(U),end:wt(U)}:{start:bt(U),end:ct(U)}}function E(x,U){return U>=P(x,-7)&&U<=P(x,5)}function w(x,U){var se=B(x,U),Y=B(x,P(se.start,-1)),le=B(x,P(se.end,1)),ce=E(Y.end,U),ge=E(se.end,U);return ce&&!ge?{closing:Y,next:se}:{closing:se,next:le}}function M(x,U,se){for(var Y=0;Y<f.length;Y++){var le=f[Y];if(le.type===x&&Ne(le.startDate)===Ne(U)&&Ne(le.endDate)===Ne(se))return le}return null}function O(x,U){var se=x&&x[U];return Number(se||0)}function L(x){return Le(x)+"€"}function T(x,U){var se=$.some(function(Y){return Y.k===x&&Y.money});return se?L(U):Le(U)}function H(x,U){return x>U?"↑":x<U?"↓":"="}function S(x,U,se,Y){var le=M(U,se,Y)||{},ce=le.indicatorsPrev||{},ge=le.indicatorsCons||{},Se=[x,""];return $.forEach(function(be){var Be=O(ce,be.k),Oe=O(ge,be.k);Se.push(be.label+" "+T(be.k,Oe)+" vs "+T(be.k,Be)+" di previsionali ("+H(Oe,Be)+")")}),Se.push("Note:"),Se.join("\n")}function k(x,U,se,Y){var le=M(U,se,Y)||{},ce=le.indicatorsPrev||{},ge=[x,""];return $.forEach(function(Se){ge.push(Se.label+" "+T(Se.k,O(ce,Se.k)))}),ge.push("Possibili note:"),ge.join("\n")}function a(x){return"BP CONSUNTIVO SETT. "+Ae(x)+" "+x.getFullYear()}function n(x){return"BP PREVISIONALE SETT. "+Ae(x)+" "+x.getFullYear()}function t(x){return"BP CONSUNTIVO "+G(x)+" "+x.getFullYear()}function e(x){var U=G(x);return"BP PREVISIONALE "+U+" "+x.getFullYear()}function o(x){return"BP CONSUNTIVO T"+I(x)+" "+x.getFullYear()}function b(x){return"BP PREVISIONALE T"+I(x)+" "+x.getFullYear()}function v(x){return"BP CONSUNTIVO S"+R(x)+" "+x.getFullYear()}function c(x){return"BP PREVISIONALE S"+R(x)+" "+x.getFullYear()}function u(x){return"BP CONSUNTIVO "+x.getFullYear()}function l(x){return"BP PREVISIONALE "+x.getFullYear()}function i(){var x=new Date,U=[];if(q(x)){var se=C(x),Y=g(x);U.push(S(a(se.start),"settimanale",se.start,se.end)),U.push(k(n(Y.start),"settimanale",Y.start,Y.end))}function le(ce,ge,Se){var be=w(ce,x);U.push(S(ge(be.closing.start),ce,be.closing.start,be.closing.end)),U.push(k(Se(be.next.start),ce,be.next.start,be.next.end))}h.mensile&&le("mensile",t,e),h.trimestrale&&le("trimestrale",o,b),h.semestrale&&le("semestrale",v,c),h.annuale&&le("annuale",u,l),z.value=U.join("\n\n")+(U.length?"\n":"")}function r(x,U){x.classList.toggle("active",!!U),x.style.opacity=U?"1":"0.65"}function d(){r(_("tog_mese"),h.mensile),r(_("tog_trimestre"),h.trimestrale),r(_("tog_semestre"),h.semestrale),r(_("tog_anno"),h.annuale)}function m(){var x=new Date;function U(se){var Y=B(se,x),le=B(se,P(Y.start,-1));return E(Y.end,x)||E(le.end,x)}h.mensile=U("mensile"),h.trimestrale=U("trimestrale"),h.semestrale=U("semestrale"),h.annuale=U("annuale"),d()}function y(){function x(U){var se=U.currentTarget.getAttribute("data-type");h[se]=!h[se],d(),i()}_("tog_mese").onclick=x,_("tog_trimestre").onclick=x,_("tog_semestre").onclick=x,_("tog_anno").onclick=x}function A(x){return encodeURIComponent(String(x||""))}function J(){var x=_("rep_gmail_web"),U=_("rep_gmail_app"),se=_("rep_copy");se&&(se.onclick=function(){try{navigator.clipboard.writeText(z.value||"");var Y=se.textContent;se.textContent="Copiato!",setTimeout(function(){se.textContent=Y},1200)}catch(le){}}),!(!x||!U)&&Ie("/api/users_emails").then(function(Y){var le=(Y&&Y.emails||(Y&&Y.users||[]).map(function(Se){return Se.email})).filter(Boolean).join(",");function ce(){return _("report_subject").value||"Report BP"}function ge(){return z.value||""}x.onclick=function(){try{navigator.clipboard.writeText(ge())}catch(be){}var Se="https://mail.google.com/mail/?view=cm&fs=1&tf=1&su="+A(ce())+"&cc="+A(le)+"&body="+A(ge());window.open(Se,"_blank"),document.dispatchEvent(new Event("report:composed"))},U.onclick=function(){try{navigator.clipboard.writeText(ge())}catch(be){}var Se="googlegmail:///co?subject="+A(ce())+"&cc="+A(le)+"&body="+A(ge());location.href=Se,document.dispatchEvent(new Event("report:composed")),setTimeout(function(){document.hidden||(location.href="mailto:?subject="+A(ce())+"&cc="+A(le)+"&body="+A(ge()),document.dispatchEvent(new Event("report:composed")))},1200)}})}function ae(){Ie("/api/periods").then(function(x){f=x&&x.periods||[],m(),y(),i(),J()})}ae()}function Ue(){var f=Te();if(!f)return s();if(document.title="Battle Plan – Utenti",f.role!=="admin"){p.innerHTML=Re()+'<div class="wrap"><div class="card"><b>Il mio profilo</b><div class="row" style="margin-top:8px"><div><label>Nome</label><input id="p_name" type="text" value="'+De(f.name||"")+'"></div><div><label>Email</label><input id="p_email" type="email" value="'+De(f.email||"")+'"></div></div><div class="row"><div><label>Nuova password</label><input id="p_pwd" type="password" placeholder="Lascia vuoto per non cambiare"></div><div class="right" style="align-self:flex-end"><button id="p_save">Aggiorna</button></div></div><div class="row"><div><label>Ruolo</label><input value="'+De(f.role||"consultant")+'" disabled></div><div><label>Grade</label><input value="'+De(f.grade||"junior")+'" disabled></div></div></div></div>',Fe(),Ge("#p_save").onclick=function(){var _=Ge("#p_name").value.trim(),z=Ge("#p_email").value.trim(),P=Ge("#p_pwd").value,C={id:f.id,name:_,email:z};P&&(C.password=P),qe("/api/users",C).then(function(){me("Profilo aggiornato"),window.addXP(3);var g=Te();g&&(g.name=_,g.email=z,localStorage.setItem("user",JSON.stringify(g)));try{document.dispatchEvent(new Event("user:profile-updated"))}catch(G){}}).catch(function(g){logger.error(g),me("Errore aggiornamento")})};return}p.innerHTML=Re()+'<div class="wrap"><div class="card"><b>Gestione utenti</b><div id="users_list" class="row" style="margin-top:8px"></div></div></div>',Fe();function h(_){var z=De(_.name||_.email||"user_"+_.id),P=_.grade==="senior"?"senior":"junior",C=_.role==="admin"?"admin":"consultant";return'<div class="card" style="flex:1 1 380px"><div><b>'+z+'</b> <span class="small muted">('+De(C)+')</span></div><div class="row" style="margin-top:6px"><div><label>Nome</label><input data-nfor="'+_.id+'" type="text" value="'+De(_.name||"")+'"></div><div><label>Email</label><input data-efor="'+_.id+'" type="email" value="'+De(_.email||"")+'"></div></div><div class="row"><div><label>Nuova password</label><input data-pfor="'+_.id+'" type="password" placeholder="(opzionale)"></div><div><label>Grade</label><select data-gfor="'+_.id+'"><option value="junior"'+(P==="junior"?" selected":"")+'>Junior</option><option value="senior"'+(P==="senior"?" selected":"")+'>Senior</option></select></div><div><label>Ruolo</label><select data-rfor="'+_.id+'"><option value="consultant"'+(C==="consultant"?" selected":"")+'>Consulente</option><option value="admin"'+(C==="admin"?" selected":"")+'>Admin</option></select></div><div class="right" style="align-self:flex-end"><button class="ghost" data-save="'+_.id+'">Aggiorna</button> <button class="danger" data-del="'+_.id+'" title="Elimina utente">Elimina</button></div></div></div>'}function $(){Ie("/api/users").then(function(_){var z=_&&_.users||[],P=Ge("#users_list");P&&(P.innerHTML=z.map(h).join(""),yt("[data-save]").forEach(function(C){C.addEventListener("click",function(){var g=C.getAttribute("data-save"),G=(Ge('input[data-nfor="'+g+'"]')||{}).value||"",I=(Ge('input[data-efor="'+g+'"]')||{}).value||"",R=(Ge('select[data-gfor="'+g+'"]')||{}).value||"junior",q=(Ge('select[data-rfor="'+g+'"]')||{}).value||"consultant",B=Ge('input[data-pfor="'+g+'"]'),E=B?B.value:"",w={id:g,name:G,email:I,grade:R,role:q};E&&(w.password=E),qe("/api/users",w).then(function(){me("Aggiornato"),window.addXP(5),B&&(B.value="")}).catch(function(M){logger.error(M),me("Errore aggiornamento")})})}),yt("[data-del]").forEach(function(C){C.addEventListener("click",function(){var g=C.getAttribute("data-del");confirm("Eliminare definitivamente questo utente?")&&fetch("/api/users?id="+encodeURIComponent(g),{method:"DELETE",headers:{Authorization:"Bearer "+dt()}}).then(function(G){if(!G.ok)throw new Error("HTTP "+G.status);return G.json()}).then(function(){me("Utente eliminato"),$()}).catch(function(G){logger.error(G),me("Errore eliminazione")})})}))})}$()}window.viewHome=ie,window.viewCalendar=ne,window.viewPeriods=ye,window.viewAppointments=we,window.viewLeaderboard=re,window.viewClients=oe,window.viewTeam=ve,window.viewCommissions=de,window.viewVendite=Ce,window.viewReport=_e,window.viewUsers=Ue,window.toggleDrawer=mt,window.logout=Rt,window.rerenderTopbarSoon=tn,document.addEventListener("DOMContentLoaded",function(){Te()?(Fe(),ie()):s()})})();export{nn as __vite_legacy_guard};
