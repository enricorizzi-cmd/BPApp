!function(){function e(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */var n,a,i="function"==typeof Symbol?Symbol:{},o=i.iterator||"@@iterator",r=i.toStringTag||"@@toStringTag";function l(e,i,o,r){var l=i&&i.prototype instanceof s?i:s,c=Object.create(l.prototype);return t(c,"_invoke",function(e,t,i){var o,r,l,s=0,c=i||[],u=!1,p={p:0,n:0,v:n,a:v,f:v.bind(n,4),d:function(e,t){return o=e,r=0,l=n,p.n=t,d}};function v(e,t){for(r=e,l=t,a=0;!u&&s&&!i&&a<c.length;a++){var i,o=c[a],v=p.p,m=o[2];e>3?(i=m===t)&&(l=o[(r=o[4])?5:(r=3,3)],o[4]=o[5]=n):o[0]<=v&&((i=e<2&&v<o[1])?(r=0,p.v=t,p.n=o[1]):v<m&&(i=e<3||o[0]>t||t>m)&&(o[4]=e,o[5]=t,p.n=m,r=0))}if(i||e>1)return d;throw u=!0,t}return function(i,c,m){if(s>1)throw TypeError("Generator is already running");for(u&&1===c&&v(c,m),r=c,l=m;(a=r<2?n:l)||!u;){o||(r?r<3?(r>1&&(p.n=-1),v(r,l)):p.n=l:p.v=l);try{if(s=2,o){if(r||(i="next"),a=o[i]){if(!(a=a.call(o,l)))throw TypeError("iterator result is not an object");if(!a.done)return a;l=a.value,r<2&&(r=0)}else 1===r&&(a=o.return)&&a.call(o),r<2&&(l=TypeError("The iterator does not provide a '"+i+"' method"),r=1);o=n}else if((a=(u=p.n<0)?l:e.call(t,p))!==d)break}catch(a){o=n,r=1,l=a}finally{s=1}}return{value:a,done:u}}}(e,o,r),!0),c}var d={};function s(){}function c(){}function u(){}a=Object.getPrototypeOf;var p=[][o]?a(a([][o]())):(t(a={},o,function(){return this}),a),v=u.prototype=s.prototype=Object.create(p);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,u):(e.__proto__=u,t(e,r,"GeneratorFunction")),e.prototype=Object.create(v),e}return c.prototype=u,t(v,"constructor",u),t(u,"constructor",c),c.displayName="GeneratorFunction",t(u,r,"GeneratorFunction"),t(v),t(v,r,"Generator"),t(v,o,function(){return this}),t(v,"toString",function(){return"[object Generator]"}),(e=function(){return{w:l,m:m}})()}function t(e,n,a,i){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}t=function(e,n,a,i){function r(n,a){t(e,n,function(e){return this._invoke(n,a,e)})}n?o?o(e,n,{value:a,enumerable:!i,configurable:!i,writable:!i}):e[n]=a:(r("next",0),r("throw",1),r("return",2))},t(e,n,a,i)}function n(e){return function(e){if(Array.isArray(e))return u(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||c(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function a(e){return a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a(e)}function i(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var a,i,o,r,l=[],d=!0,s=!1;try{if(o=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;d=!1}else for(;!(d=(a=o.call(n)).done)&&(l.push(a.value),l.length!==t);d=!0);}catch(e){s=!0,i=e}finally{try{if(!d&&null!=n.return&&(r=n.return(),Object(r)!==r))return}finally{if(s)throw i}}return l}}(e,t)||c(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function o(e,t,n,a,i,o,r){try{var l=e[o](r),d=l.value}catch(e){return void n(e)}l.done?t(d):Promise.resolve(d).then(a,i)}function r(e){return function(){var t=this,n=arguments;return new Promise(function(a,i){var r=e.apply(t,n);function l(e){o(r,a,i,l,d,"next",e)}function d(e){o(r,a,i,l,d,"throw",e)}l(void 0)})}}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,a)}return n}function d(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=a(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t||"default");if("object"!=a(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==a(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=c(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var a=0,i=function(){};return{s:i,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,r=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return r=e.done,e},e:function(e){l=!0,o=e},f:function(){try{r||null==n.return||n.return()}finally{if(l)throw o}}}}function c(e,t){if(e){if("string"==typeof e)return u(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?u(e,t):void 0}}function u(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,a=Array(t);n<t;n++)a[n]=e[n];return a}System.register([],function(t,o){"use strict";return{execute:function(){var t,o=document.createElement("style");function c(e,t){localStorage.setItem(e,"string"==typeof t?t:JSON.stringify(t))}function u(e,t){var n=localStorage.getItem(e);if(null==n)return t;try{return JSON.parse(n)}catch(a){return n}}function p(e){localStorage.removeItem(e)}function v(){return localStorage.getItem("bp_token")||sessionStorage.getItem("bp_token")||""}function m(){return u("bp_user",null)||null}function g(){p("bp_token"),sessionStorage.removeItem("bp_token"),p("bp_user"),location.href="/?v=13"}function f(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t.method=t.method||"GET";var n=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach(function(t){d(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}({},t.headers||{}),a=v();return a&&(n.Authorization="Bearer "+a),null!=t.body&&"string"!=typeof t.body&&(n["Content-Type"]="application/json; charset=utf-8",t.body=JSON.stringify(t.body)),t.headers=n,fetch(e,t).then(b)}function b(e){return y.apply(this,arguments)}function y(){return(y=r(e().m(function t(n){var a;return e().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,n.text();case 1:if(a=e.v,n.ok){e.n=2;break}throw h(a,n);case 2:return e.a(2,w(a,n))}},t)}))).apply(this,arguments)}function h(e,t){try{var n=JSON.parse(e).error||"";return new Error(n||t.statusText||"HTTP "+t.status)}catch(a){return new Error(t.statusText||"HTTP "+t.status)}}function w(e,t){try{if(-1!==(t.headers.get("content-type")||"").toLowerCase().indexOf("application/json"))return e?JSON.parse(e):{}}catch(n){}return e}function _(e,t){return f(e,Object.assign({method:"GET"},{}))}function x(e,t){return f(e,{method:"POST",body:t||{}})}function I(e){return(e<10?"0":"")+e}function S(e){var t=new Date(e);return I(t.getDate())+"/"+I(t.getMonth()+1)+"/"+t.getFullYear()}function E(e){var t=new Date(e);return t.getFullYear()+"-"+I(t.getMonth()+1)+"-"+I(t.getDate())}function D(e){var t=new Date(e);return I(t.getHours())+":"+I(t.getMinutes())}function B(e){var t=new Date(e);return new Date(t.getFullYear(),t.getMonth(),1)}function T(e){var t=new Date(e);return new Date(t.getFullYear(),t.getMonth()+1,0,23,59,59,999)}function P(e){var t=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate())),n=t.getUTCDay()||7;t.setUTCDate(t.getUTCDate()+4-n);var a=new Date(Date.UTC(t.getUTCFullYear(),0,1));return Math.ceil(((t-a)/864e5+1)/7)}function C(e){var t=new Date(e),n=Math.floor(t.getMonth()/3);return new Date(t.getFullYear(),3*n,1)}function k(e){var t=C(e);return new Date(t.getFullYear(),t.getMonth()+3,0,23,59,59,999)}function M(e){var t=new Date(e),n=t.getMonth()<6?0:6;return new Date(t.getFullYear(),n,1)}function A(e){var t=M(e);return new Date(t.getFullYear(),t.getMonth()+6,0,23,59,59,999)}function N(e){var t=new Date(e);return new Date(t.getFullYear(),0,1)}function L(e){var t=new Date(e);return new Date(t.getFullYear(),11,31,23,59,59,999)}function F(e,t){var n=function(e,t){var n=new Date(e,0,1+7*(t-1)),a=n.getDay()||7,i=new Date(n);return i.setDate(n.getDate()-(a-1)),i.setHours(0,0,0,0),i}(e,t),a=new Date(n);return a.setDate(n.getDate()+6),a.setHours(23,59,59,999),{start:n,end:a}}function V(e){var t=function(e){var t=new Date(e);t.setHours(0,0,0,0);var n=(t.getDay()+6)%7;return t.setDate(t.getDate()-n),t}(e);t.setDate(t.getDate()+7);var n=new Date(t);return n.setDate(t.getDate()+6),n.setHours(23,59,59,999),{start:t,end:n}}function O(e,t){var n=new Date(t);return"settimanale"===e?"Sett. "+P(new Date(t))+" "+n.getFullYear():"mensile"===e?n.toLocaleString("it-IT",{month:"long",year:"numeric"}):"trimestrale"===e?"Trimestre "+(Math.floor(n.getMonth()/3)+1)+" "+n.getFullYear():"semestrale"===e?(n.getMonth()<6?"1Â°":"2Â°")+" semestre "+n.getFullYear():"annuale"===e?"Anno "+n.getFullYear():"ytd"===e?"YTD "+n.getFullYear():"ltm"===e?"Ultimi 12 mesi":e}function R(e){var n=(t||(t=document.getElementById("toast-container"))||((t=document.createElement("div")).id="toast-container",t.setAttribute("role","status"),t.setAttribute("aria-live","polite"),document.body.appendChild(t)),t),a=document.createElement("div");a.className="toast",a.setAttribute("role","alert"),a.textContent=e,n.appendChild(a),setTimeout(function(){try{a.remove(),n.children.length||(n.remove(),t=null)}catch(e){}},2200)}function U(){if(!window.matchMedia||!window.matchMedia("(prefers-reduced-motion: reduce)").matches){var e=document.createElement("div");e.className="confetti",document.body.appendChild(e);for(var t=0;t<26;t++){var n=document.createElement("span");n.style.position="absolute",n.style.left=2+4*t+"%",n.style.top="0",n.style.width="6px",n.style.height="10px",n.style.background="hsl("+14*t+",90%,60%)",n.style.opacity="0.95",e.appendChild(n),function(e,t){setTimeout(function(){e.animate&&e.animate([{transform:"translateY(-20px) rotate(0deg)"},{transform:"translateY(110vh) rotate(540deg)"}],{duration:1200+800*Math.random(),easing:"cubic-bezier(.2,.6,.2,1)"})},t)}(n,35*t)}setTimeout(function(){try{e.remove()}catch(t){}},2500)}}function j(e){return String(e).replace(/[&<>'"]/g,function(e){return{"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"}[e]})}function H(e){return(Number(e)||0).toLocaleString("it-IT")+"â‚¬"}function z(e){var t=Number(e)||0;return String(Math.round(t))}function G(){var e=m();if(!e)return"";var t="admin"===e.role;return'<div class="topbar"><div class="brand"><button class="hamb" id="hamb" aria-label="Apri menu" aria-controls="drawer" aria-expanded="false"><span></span><span></span><span></span></button><div class="logo">BATTLE PLAN</div></div><div class="nav right">'+('<span class="badge">Lvl '+(window.level?window.level():"")+" Â· XP "+(window.getXP?window.getXP():"")+"</span>")+'<button class="ghost" onclick="viewHome()">Dashboard</button><button class="ghost" onclick="viewCalendar()">Calendario</button><button class="ghost" onclick="viewPeriods()">BP</button><button class="ghost" onclick="viewAppointments()">Appuntamenti</button><button class="ghost" onclick="viewLeaderboard()">Classifiche</button><button class="ghost" onclick="viewCommissions()">Provvigioni</button><button class="ghost" onclick="viewVendite()">Vendite e Riordini</button><button class="ghost" onclick="viewGI()">GI &amp; Scadenzario</button><button class="ghost" onclick="viewReport()">Report</button><button class="ghost" onclick="viewClients()">Clienti</button><button class="ghost" onclick="viewTeam()">Squadra</button>'+(t?'<button class="ghost" onclick="viewUsers()">Utenti</button>':"")+'<button onclick="logout()">Logout</button></div></div>'+('<div id="drawer" class="drawer" role="dialog" aria-modal="true" aria-label="Menu"><div class="row"><button class="ghost" onclick="viewHome();toggleDrawer(false)">Dashboard</button><button class="ghost" onclick="viewCalendar();toggleDrawer(false)">Calendario</button><button class="ghost" onclick="viewPeriods();toggleDrawer(false)">BP</button><button class="ghost" onclick="viewAppointments();toggleDrawer(false)">Appuntamenti</button><button class="ghost" onclick="viewLeaderboard();toggleDrawer(false)">Classifiche</button><button class="ghost" onclick="viewCommissions();toggleDrawer(false)">Provvigioni</button><button class="ghost" onclick="viewVendite();toggleDrawer(false)">Vendite e Riordini</button><button class="ghost" onclick="viewGI();toggleDrawer(false)">GI &amp; Scadenzario</button><button class="ghost" onclick="viewReport();toggleDrawer(false)">Report</button><button class="ghost" onclick="viewClients();toggleDrawer(false)">Clienti</button><button class="ghost" onclick="viewTeam();toggleDrawer(false)">Squadra</button>'+(t?'<button class="ghost" onclick="viewUsers();toggleDrawer(false)">Utenti</button>':"")+'<button onclick="logout()">Logout</button></div></div>')}function Y(){if(m()){if(!document.getElementById("bp_nav_contrast_css")){var e=document.createElement("style");e.id="bp_nav_contrast_css",e.textContent="\n      @media (min-width: 1024px){\n        .topbar .nav .ghost{\n          background: rgba(255,255,255,.06);\n          border: 1px solid rgba(255,255,255,.18);\n        }\n        .topbar .nav .ghost:hover{\n          background: rgba(255,255,255,.12);\n        }\n      }\n    ",document.head.appendChild(e)}var t=document.getElementById("app"),n=document.querySelector(".topbar"),a=G();n?n.outerHTML=a:t&&t.insertAdjacentHTML("afterbegin",a);try{!function(){if(!document.getElementById("bp-mobile-drawer-fix")){var e=document.createElement("style");e.id="bp-mobile-drawer-fix",e.textContent="\n  @media (max-width:980px){\n    .topbar{\n      background: rgba(20,24,34,.90) !important;\n      border-bottom: 1px solid rgba(255,255,255,.08) !important;\n    }\n    .drawer{\n      background: rgba(20,24,34,.96) !important;\n      box-shadow: 14px 0 28px rgba(0,0,0,.45) !important;\n      width: 86vw !important;\n      overflow-y: auto !important;\n    }\n    .drawer .row{ gap:10px !important; }\n    .drawer button{\n      background: rgba(255,255,255,.10) !important;\n      border: 1px solid rgba(255,255,255,.22) !important;\n      color: #fff !important;\n      padding: 12px 14px !important;\n      font-weight: 700 !important;\n      border-radius: 12px !important;\n      -webkit-tap-highlight-color: transparent;\n    }\n    .drawer button:hover{\n      background: rgba(255,255,255,.14) !important;\n      border-color: rgba(255,255,255,.30) !important;\n    }\n    .drawer button.ghost{\n      background: rgba(255,255,255,.10) !important;\n      box-shadow: none !important;\n    }\n  }",document.head.appendChild(e)}}()}catch(l){}try{!function(){if(!document.getElementById("bp-mobile-light-fix")){var e=document.createElement("style");e.id="bp-mobile-light-fix",e.textContent="\n    @media (max-width:980px) and (prefers-color-scheme: light){\n      .topbar{\n        background:#fff !important;\n        border-bottom:1px solid rgba(0,0,0,.08) !important;\n        box-shadow:none !important;\n      }\n      .topbar .brand .logo{\n        color:#0f172a !important;\n        font-weight:900 !important;\n        letter-spacing:.4px;\n        text-shadow:none !important;\n        opacity:1 !important;\n      }\n      .topbar .hamb span{ background:#0f172a !important; }\n      .card{\n        background:#fff !important;\n        background-image:none !important;\n        box-shadow:none !important;\n      }\n      .drawer{\n        background:#fff !important;\n        box-shadow:14px 0 28px rgba(0,0,0,.10) !important;\n      }\n      .drawer button{\n        color:#0f172a !important;\n        background:rgba(0,0,0,.04) !important;\n        border:1px solid rgba(0,0,0,.12) !important;\n      }\n      .drawer button:hover{\n        background:rgba(0,0,0,.08) !important;\n      }\n    }\n  ",document.head.appendChild(e)}}()}catch(d){}try{!function(){if(!document.getElementById("bp-badge-light-css")){var e=document.createElement("style");e.id="bp-badge-light-css",e.textContent="\n    @media (prefers-color-scheme: light){\n      .badge{\n        background: linear-gradient(180deg, #eef2ff, #f8fafc) !important;\n        border: 1px solid #c7d2fe !important;\n        color: #0f172a !important;\n        font-weight: 700 !important;\n        padding: 6px 10px !important;\n        border-radius: 9999px !important;\n        letter-spacing: .2px !important;\n        box-shadow: 0 1px 0 rgba(15,23,42,.05) inset !important;\n      }\n      .chip, .tag{\n        background: #ffffff !important;\n        border: 1px solid #cbd5e1 !important;\n        color: #0f172a !important;\n        font-weight: 600 !important;\n        border-radius: 9999px !important;\n      }\n      .card .badge{\n        background: #fff !important;\n      }\n    }\n  ",document.head.appendChild(e)}}()}catch(s){}if(!document.getElementById("bp-unified-filters-css")){var i=document.createElement("style");i.id="bp-unified-filters-css",i.textContent="\n      /* Nested inputs align in two columns inside unified filters */\n      .uf .row .row{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }\n\n      @media (max-width: 980px){\n        .uf input, .uf select{ min-width: 0; width: 100%; }\n        .uf .row > div{ flex: 1 1 180px; min-width: 0; }\n\n        /* Squadra admin bar: grid on small screens */\n        #t_adminbar{ display:grid !important; grid-template-columns: 1fr 1fr; align-items:end; gap:10px; }\n        #t_adminbar > div{ min-width: 0; }\n        #t_adminbar .row{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }\n      }\n\n      @media (max-width: 560px){\n        #t_adminbar{ grid-template-columns: 1fr; }\n      }\n    ",document.head.appendChild(i)}var o=document.getElementById("hamb");o&&(o.onclick=function(){W()});var r=document.getElementById("drawer");r&&r.addEventListener("click",function(e){"drawer"===e.target.id&&W(!1)}),document.removeEventListener("keydown",q,!1),document.addEventListener("keydown",q,!1)}}function q(e){if(e&&"Escape"===e.key){var t=document.getElementById("drawer");t&&t.classList.contains("open")&&W(!1)}}function W(e){var t=document.getElementById("drawer");if(t){var n="boolean"==typeof e?e:!t.classList.contains("open");t.classList.toggle("open",n);var a=document.getElementById("hamb");a&&a.setAttribute("aria-expanded",String(n)),document.body.classList.toggle("no-scroll",n)}}o.textContent='#bp-overlay{position:fixed;top:0;right:0;bottom:0;left:0;display:none;align-items:center;justify-content:center;z-index:10000}#bp-overlay:not(.hidden){display:flex}#bp-overlay .bp-overlay-backdrop{position:absolute;top:0;right:0;bottom:0;left:0;background:rgba(0,0,0,.35)}#bp-overlay .bp-overlay-panel{position:relative;max-width:min(92vw,560px);width:auto;background:#fff;color:#111;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.3);padding:16px;margin:12px}#bp-overlay .row{display:flex;gap:12px}#bp-overlay input[type=date],#bp-overlay input[type=number],#bp-overlay input[type=text],#bp-overlay textarea,#bp-overlay select{width:100%}.chip-nncf{display:inline-flex;align-items:center;gap:.35rem;padding:.2rem .5rem;border-radius:999px;border:1px solid var(--acc,#888);cursor:pointer;user-select:none;margin-left:.5rem;font-size:.9em}.chip-nncf input{accent-color:var(--acc,#444);width:1rem;height:1rem}.today{outline:2px solid var(--acc,#0aa);outline-offset:-2px;border-radius:.5rem;position:relative}.today:after{content:"Oggi";position:absolute;top:2px;right:4px;font-size:.7em;color:var(--acc,#0aa)}.btn-ghost{background:transparent;border:1px solid #999;border-radius:.5rem;padding:.35rem .6rem;cursor:pointer}.btn-ghost:hover{background:rgba(0,0,0,.04)}.btn-ics{padding:2px 4px;font-size:1.1rem;line-height:1}.kpi-mini canvas{max-height:180px}\n/*$vite$:1*/',document.head.appendChild(o);var X=null;function $(){clearTimeout(X),X=setTimeout(Y,60)}function Z(e){return document.querySelector(e)}function J(e){return Array.from(document.querySelectorAll(e))}!function(){var e=window.BP=window.BP||{},t=e.ICS=e.ICS||{};function n(e){if(!e)return"";if(/[Zz]|[+\-]\d{2}:\d{2}$/.test(String(e)))return new Date(e).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z").slice(0,15)+"Z";var t=i(String(e).split("T"),2),n=t[0],a=t[1],o=void 0===a?"00:00":a,r=i(n.split("-").map(Number),3),l=r[0],d=r[1],s=r[2],c=i(o.split(":").map(Number),2),u=c[0],p=c[1];return new Date(l,d-1,s,u,p,0,0).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z").slice(0,15)+"Z"}function a(e){return(e||"").replace(/\\/g,"\\\\").replace(/;/g,"\\;").replace(/,/g,"\\,").replace(/\n/g,"\\n")}function o(e){var t=(e&&e.id||"bp-"+Date.now())+"@bpapp",i=e&&e.client?"Appuntamento Â· "+e.client:"Appuntamento",o=n(e&&e.start),r=n(e&&e.end),l=n((new Date).toISOString().slice(0,16)),d=[];e&&e.type&&d.push("Tipo: "+e.type),e&&e.vss&&d.push("VSS: "+e.vss),e&&e.vsdPersonal&&d.push("VSD Personale: "+e.vsdPersonal),e&&e.notes&&d.push("Note: "+e.notes);var s=a(d.join("\n")),c=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//BPApp//Calendario//IT","CALSCALE:GREGORIAN","METHOD:PUBLISH","BEGIN:VEVENT","UID:"+t,"DTSTAMP:"+l,o?"DTSTART:"+o:"",r?"DTEND:"+r:"","SUMMARY:"+a(i),s?"DESCRIPTION:"+s:"","END:VEVENT","END:VCALENDAR"].filter(Boolean),u=[];return c.forEach(function(e){return u.push.apply(u,function(e){if(e.length<=74)return[e];for(var t=[],n=0;n<e.length;){var a=e.slice(n,n+74);t.push(0===n?a:" "+a),n+=74}return t}(e))}),u.join("\r\n")}t.makeIcsForAppointment=o,t.downloadIcsForAppointment=function(e){try{var t=o(e),n=e&&e.start?String(e.start).split("T")[0]:"evento",a=(e&&e.client||"appuntamento").trim().replace(/[^\w\-]+/g,"_").slice(0,40),i="bp_".concat(a,"_").concat(n,".ics");if(function(){try{var e=navigator.userAgent||navigator.vendor||"",t=/iP(ad|hone|od)/.test(e),n=/^((?!chrome|android|crios|fxios|edgi).)*safari/i.test(e);return t||n}catch(a){return!1}}())try{var r="data:text/calendar;charset=utf-8,"+encodeURIComponent(t),l=document.createElement("a");return l.href=r,l.setAttribute("target","_blank"),l.setAttribute("download",i),document.body.appendChild(l),l.click(),l.remove(),!0}catch(c){try{return window.location.assign("data:text/calendar;charset=utf-8,"+encodeURIComponent(t)),!0}catch(u){try{logger.error(u)}catch(p){}return!1}}var d=new Blob([t],{type:"text/calendar;charset=utf-8"}),s=document.createElement("a");return s.href=URL.createObjectURL(d),s.download=i,document.body.appendChild(s),s.click(),setTimeout(function(){try{URL.revokeObjectURL(s.href)}catch(p){}s.remove()},50),!0}catch(v){try{logger.error(v)}catch(p){}return!1}},window.icsFromAppt=window.icsFromAppt||function(e){return o(e)},window.downloadICS=window.downloadICS||function(e,t){try{var n=window.__icsSanitize?__icsSanitize(e):e||"evento";/\.ics$/i.test(n)||(n+=".ics");var a=new Blob([t],{type:"text/calendar;charset=utf-8"}),i=document.createElement("a");i.href=URL.createObjectURL(a),i.download=n,document.body.appendChild(i),i.click(),setTimeout(function(){URL.revokeObjectURL(i.href),i.remove()},50)}catch(o){logger.error(o)}}}(),function(){var t,i=document.getElementById("app");function o(){document.title="Battle Plan â€“ Login";i.innerHTML='<div class="hero" id="hero"><div class="layer glow"></div><div class="layer grid"></div><div class="title">Pianifica. Eroga. Vinci. <span class="small muted">BP â€“ stile gaming</span></div></div><div class="wrap"><div class="grid"><div class="card"><h3>Accedi</h3><form id="loginForm" autocomplete="on"><div class="row"><div><label>Email</label><input id="li_email" name="email" type="email" autocomplete="username" required></div><div><label>Password</label><input id="li_password" name="password" type="password" autocomplete="current-password" required></div></div><div class="row"><label class="small"><input type="checkbox" id="li_remember" checked> Rimani collegato</label></div><div class="right" style="margin-top:8px"><button type="submit" id="btnLogin">Accedi</button></div></form></div><div class="card"><h3>Registrati</h3><form id="regForm" autocomplete="on"><div class="row"><div><label>Nome</label><input id="re_name" name="name" type="text" required></div><div><label>Email</label><input id="re_email" name="email" type="email" autocomplete="username" required></div><div><label>Password</label><input id="re_password" name="new-password" type="password" autocomplete="new-password" required></div></div><div class="right" style="margin-top:8px"><button type="submit" id="btnRegister">Registrati</button></div></form></div></div></div>';var e=document.getElementById("hero");e&&e.addEventListener("pointermove",function(t){var n=e.getBoundingClientRect();e.style.setProperty("--gx",(t.clientX-n.left)/n.width*100+"%"),e.style.setProperty("--gy",(t.clientY-n.top)/n.height*100+"%")});var t=document.getElementById("loginForm"),n=document.getElementById("regForm");t.addEventListener("submit",function(e){e.preventDefault();var t=document.getElementById("btnLogin");t.disabled=!0;var n=document.getElementById("li_email").value.trim().toLowerCase(),a=document.getElementById("li_password").value,i=document.getElementById("li_remember").checked;x("/api/login",{email:n,password:a}).then(function(e){if("string"==typeof e)try{e=JSON.parse(e)}catch(t){}!function(e,t){t?c("bp_token",e):sessionStorage.setItem("bp_token",e)}(e.token,i),c("bp_user",e.user),R("Bentornato "+e.user.name+"!"),window.addXP(10),q(),Y(),window.BPPush&&window.BPPush.subscribe()},function(e){R("Credenziali errate"),logger.error(e)}).catch(function(e){logger.error(e)}).finally(function(){t.disabled=!1})}),n.addEventListener("submit",function(e){e.preventDefault();var t=document.getElementById("btnRegister");t.disabled=!0,x("/api/register",{name:document.getElementById("re_name").value.trim(),email:document.getElementById("re_email").value.trim().toLowerCase(),password:document.getElementById("re_password").value}).then(function(){R("Registrazione ok. Ora accedi"),U(),window.addXP(20),window.scrollTo({top:0,behavior:"smooth"})}).catch(function(e){R("Email giÃ  registrata?"),logger.error(e)}).finally(function(){t.disabled=!1})})}function l(e){var t=(new Date).getFullYear(),n=(new Date).getMonth()+1;return'<div class="uf"><div class="row"><div><label>GranularitÃ </label><select id="'+e+'_gran"><option value="settimanale">Settimanale</option><option value="mensile" selected>Mensile</option><option value="trimestrale">Trimestrale</option><option value="semestrale">Semestrale</option><option value="annuale">Annuale</option><option value="ytd">Anno corrente (YTD)</option><option value="ltm">Ultimi 12 mesi (LTM)</option></select></div><div id="'+e+'_wrap_week" style="display:none"><label>Settimana ISO</label><div class="row"><input type="number" id="'+e+'_week" min="1" max="53" value="'+P(new Date)+'"><input type="number" id="'+e+'_year_w" min="2000" max="2100" value="'+t+'"></div></div><div id="'+e+'_wrap_month"><label>Mese</label><div class="row"><input type="number" id="'+e+'_month" min="1" max="12" value="'+n+'"><input type="number" id="'+e+'_year_m" min="2000" max="2100" value="'+t+'"></div></div><div id="'+e+'_wrap_quarter" style="display:none"><label>Trimestre</label><div class="row"><input type="number" id="'+e+'_quarter" min="1" max="4" value="'+Math.floor((n-1)/3)+'1"><input type="number" id="'+e+'_year_q" min="2000" max="2100" value="'+t+'"></div></div><div id="'+e+'_wrap_sem" style="display:none"><label>Semestre</label><div class="row"><select id="'+e+'_sem"><option value="1">1Â°</option><option value="2">2Â°</option></select><input type="number" id="'+e+'_year_s" min="2000" max="2100" value="'+t+'"></div></div><div id="'+e+'_wrap_year" style="display:none"><label>Anno</label><input type="number" id="'+e+'_year" min="2000" max="2100" value="'+t+'"></div><div style="align-self:flex-end"><button id="'+e+'_refresh" class="ghost">Aggiorna</button></div></div></div>'}function d(e){return"d"===e||"dash"===e?"dash":"cm"===e||"comm"===e?"comm":"tg"===e||"t"===e||"team"===e?"t":e}function f(e,t){function n(){var t=document.getElementById(e+"_gran").value;["week","month","quarter","sem","year"].forEach(function(t){var n=document.getElementById(e+"_wrap_"+t);n&&(n.style.display="none")}),"settimanale"===t?document.getElementById(e+"_wrap_week").style.display="":"mensile"===t?document.getElementById(e+"_wrap_month").style.display="":"trimestrale"===t?document.getElementById(e+"_wrap_quarter").style.display="":"semestrale"===t?document.getElementById(e+"_wrap_sem").style.display="":"annuale"===t&&(document.getElementById(e+"_wrap_year").style.display="")}["gran","week","year_w","month","year_m","quarter","year_q","sem","year_s","year"].forEach(function(a){var i=document.getElementById(e+"_"+a);i&&(i.onchange=function(){n(),t&&t(),window.emitUnifiedRangeChange(d(e))},i.oninput=function(){n()})});var a=document.getElementById(e+"_refresh");a&&(a.onclick=function(){t&&t(),window.emitUnifiedRangeChange(d(e))}),n()}function b(e){var t=new Date;function n(t,n){var a=document.getElementById(e+"_"+t),i=a?parseInt(a.value,10):NaN;return isFinite(i)?i:n}var a=document.getElementById(e+"_gran"),i=a?a.value:"mensile",o={type:i,start:null,end:null};if("settimanale"===i){var r=F(n("year_w",t.getFullYear()),Math.max(1,Math.min(53,n("week",P(t)))));return o.start=r.start,o.end=r.end,o}if("mensile"===i){var l=n("year_m",t.getFullYear()),d=Math.max(1,Math.min(12,n("month",t.getMonth()+1)));return o.start=new Date(l,d-1,1),o.end=new Date(l,d,0,23,59,59,999),o}if("trimestrale"===i){var s=n("year_q",t.getFullYear()),c=Math.max(1,Math.min(4,n("quarter",Math.floor(t.getMonth()/3)+1)));return o.start=new Date(s,3*(c-1),1),o.end=new Date(s,3*c,0,23,59,59,999),o}if("semestrale"===i){var u=n("year_s",t.getFullYear()),p=n("sem",t.getMonth()<6?1:2);return o.start=new Date(u,1===p?0:6,1),o.end=new Date(u,1===p?6:12,0,23,59,59,999),o}if("annuale"===i){var v=n("year",t.getFullYear());return o.start=new Date(v,0,1),o.end=new Date(v,11,31,23,59,59,999),o}if("ytd"===i){var m=new Date(t.getFullYear(),t.getMonth()+1,0,23,59,59,999);return o.start=new Date(t.getFullYear(),0,1),o.end=m,o}if("ltm"===i){var g=new Date(t.getFullYear(),t.getMonth()+1,0,23,59,59,999),f=new Date(g.getFullYear(),g.getMonth()-11,1);return o.start=f,o.end=g,o}return o.type="mensile",o.start=new Date(t.getFullYear(),t.getMonth(),1),o.end=new Date(t.getFullYear(),t.getMonth()+1,0,23,59,59,999),o}function y(e){return"ytd"===e||"ltm"===e?"mensile":e}function h(e,t){var n=y(e||"mensile"),a=t?new Date(t):new Date,i=a.getUTCFullYear(),o=[];function r(e,t){o.push({s:e.getTime(),e:t.getTime()})}function l(e,t,n){return new Date(Date.UTC(e,t,n))}function d(e){return new Date(e.getTime()+864e5-1)}function s(e,t){return new Date(Date.UTC(e,t+1,0))}if("settimanale"===n){var c=new Date(Date.UTC(a.getUTCFullYear(),a.getUTCMonth(),a.getUTCDate())),u=(c.getUTCDay()+6)%7;c.setUTCDate(c.getUTCDate()-u);for(var p=52;p>=0;p--){(h=new Date(c)).setUTCDate(c.getUTCDate()-7*p),(w=new Date(h)).setUTCDate(h.getUTCDate()+6),w.setUTCHours(23,59,59,999),r(h,w)}return o}if("mensile"===n){for(var v=new Date(Date.UTC(a.getUTCFullYear(),a.getUTCMonth(),1)),m=23;m>=0;m--){var g=new Date(Date.UTC(v.getUTCFullYear(),v.getUTCMonth()-m,1));r(g,d(s(g.getUTCFullYear(),g.getUTCMonth())))}return o}if("trimestrale"===n){for(var f=Math.floor(a.getUTCMonth()/3),b=11;b>=0;b--){var h,w,_=f-b,x=i+Math.floor(_/4),I=(_%4+4)%4;r(h=l(x,3*I,1),w=d(new Date(Date.UTC(x,3*I+3,0))))}return o}if("semestrale"===n){for(var S=a.getUTCMonth()<6?0:1,E=5;E>=0;E--){var D=S-E,B=i+Math.floor(D/2),T=0===(D%2+2)%2?0:6;r(l(B,T,1),d(new Date(Date.UTC(B,T+6,0))))}return o}for(var P=2;P>=0;P--){var C=i-P;r(l(C,0,1),d(new Date(Date.UTC(C,12,0))))}return o}function w(e,t){var n=y(e||"mensile");return(t||[]).map(function(e){var t=new Date(e.s);return"settimanale"===n?"W"+P(t)+" "+t.getUTCFullYear():"mensile"===n?String(t.getUTCMonth()+1).padStart(2,"0")+"/"+t.getUTCFullYear():"trimestrale"===n?"Q"+(Math.floor(t.getUTCMonth()/3)+1)+" "+t.getUTCFullYear():"semestrale"===n?(t.getUTCMonth()<6?"S1 ":"S2 ")+t.getUTCFullYear():String(t.getUTCFullYear())})}function q(){if(!m())return o();function e(e,t){var n=document.getElementById(e);n&&(n.textContent=t)}function t(e){return(Number(e)||0).toLocaleString("it-IT")+"â‚¬"}function a(e){var t=Number(e)||0;return String(Math.round(t))}function r(e){return String(e).replace(/[&<>'"]/g,function(e){return{"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"}[e]})}function d(e){return(h(e,new Date)||[]).map(function(e){return{s:e.s,e:e.e}})}function s(e,t,n,a){var i=a||b("dash"),o=String(i.type||"mensile").toLowerCase(),r="ytd"===o||"ltm"===o?"mensile":o,l=d(o);function s(e,t){var n=new Date(t.startDate).getTime(),a=new Date(t.endDate).getTime();return n>=e.s&&a<=e.e}function c(e,t){if(!e)return 0;if("VSDTotale"===t)return Number(e.VSDPersonale||0)+Number(e.VSDIndiretto||0);if("ProvvGI"===t)return Number(e.ProvvGI||0);if("ProvvVSD"===t)return Number(e.ProvvVSD||0);if("TotProvvigioni"===t){var n=e.TotProvvigioni;return Number(null!=n?n:Number(e.ProvvGI||0)+Number(e.ProvvVSD||0))}return Number(e[t]||0)}return _("/api/periods?global=1").catch(function(){return _("/api/periods")}).then(function(a){var i=(a&&a.periods||[]).filter(function(e){return e.type===r&&(!n||String(e.userId||e.uid||"")===String(n))}),o=function(e){switch(String(e)){case"provv_gi":return"ProvvGI";case"provv_vsd":return"ProvvVSD";case"tot_provv":return"TotProvvigioni";default:return e}}(e);return l.map(function(e){for(var n=0,a=0;a<i.length;a++){var r=i[a];if(s(e,r))n+=c("previsionale"===t?r.indicatorsPrev||{}:r.indicatorsCons||{},o)}return{x:new Date(e.s),y:Math.round(100*n)/100}})})}function u(){var n=(document.getElementById("dash_mode")||{}).value||"consuntivo",i=b("dash"),o=new Date(i.start).getTime(),r=new Date(i.end).getTime(),l=(document.getElementById("dash_cons")||{}).value||"";function d(e){return e=Number(null==e?"":e),isFinite(e)?e:0}function s(e){if(!e)return 0;for(var t=["VSDIndiretto","vsdIndiretto","VSD_indiretto","VSDI"],n=0;n<t.length;n++)if(null!=e[t[n]])return d(e[t[n]]);return null!=e.VSDTotale&&null!=e.VSDPersonale?d(e.VSDTotale)-d(e.VSDPersonale):0}function c(e){return e?null!=e.TotProvvigioni?d(e.TotProvvigioni):d(e.ProvvGI)+d(e.ProvvVSD):0}return _("/api/periods").then(function(i){for(var u=i&&i.periods||[],p={VSS:0,VSDPersonale:0,VSDIndiretto:0,GI:0,NNCF:0,PROVV:0},v=0;v<u.length;v++){var m=u[v];if(!l||String(m.userId||m.uid||"")===String(l)){var g=new Date(m.startDate).getTime(),f=new Date(m.endDate).getTime();if(!(g<o||f>r)){var b="previsionale"===n?m.indicatorsPrev||{}:m.indicatorsCons||{};p.VSS+=d(b.VSS),p.VSDPersonale+=d(b.VSDPersonale),p.VSDIndiretto+=s(b),p.GI+=d(b.GI),p.NNCF+=d(b.NNCF),p.PROVV+=c(b)}}}e("kpi_vss",t(p.VSS)),e("kpi_vsd",t(p.VSDPersonale)),e("kpi_vsd_ind",t(p.VSDIndiretto)),e("kpi_gi",t(p.GI)),e("kpi_nncf",a(p.NNCF)),e("kpi_provv",t(p.PROVV))})}function p(){var e=(document.getElementById("dash_mode")||{}).value||"consuntivo",t=(document.getElementById("dash_cons")||{}).value||"",a=b("dash"),i=String(a.type||"mensile").toLowerCase(),o=d(i),r=w(i,o);function l(e,t){var a=e.map(function(e){return e.y});!function(e,t,a){var i=document.getElementById(e);if(i)if("function"!=typeof window.drawFullLine){var o=i.getContext("2d");i.width=i.clientWidth||320,i.height=i.clientHeight||80,o.clearRect(0,0,i.width,i.height);var r=Math.max.apply(Math,[1].concat(n(a))),l=a.length>1?(i.width-8)/(a.length-1):0;o.strokeStyle="#2e6cff",o.lineWidth=2,o.beginPath();for(var d=0;d<a.length;d++){var s=4+d*l,c=i.height-6-a[d]/r*(i.height-12);0===d?o.moveTo(s,c):o.lineTo(s,c)}o.stroke()}else window.drawFullLine(e,t,a)}(t,r,a)}Promise.all([s("VSS",e,t||null,a),s("VSDPersonale",e,t||null,a),s("VSDIndiretto",e,t||null,a),s("GI",e,t||null,a),s("NNCF",e,t||null,a),s("TotProvvigioni",e,t||null,a)]).then(function(e){l(e[0],"d_mini_vss"),l(e[1],"d_mini_vsdpersonale"),l(e[2],"d_mini_vsdindiretto"),l(e[3],"d_mini_gi"),l(e[4],"d_mini_nncf"),l(e[5],"d_mini_provv")}).catch(function(e){logger.error(e)})}function v(){var e=(document.getElementById("dash_cons")||{}).value||"";function n(e){return'<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px">'+e+"</div>"}function i(e){var n=new Date(e.start),i=new Date(e.end);(!(i instanceof Date)||isNaN(i)||i<n)&&(i=new Date(n.getTime()+6e4*function(e){return(e=String(e||"").toLowerCase()).indexOf("mezza")>-1?240:e.indexOf("giorn")>-1||e.indexOf("formaz")>-1||e.indexOf("mbs")>-1?570:e.indexOf("sottoprod")>-1?240:(e.indexOf("vend"),90)}(e.type||"vendita")));var o,l=S(n)+" "+D(n)+"â€“"+("0"+i.getHours()).slice(-2)+":"+("0"+i.getMinutes()).slice(-2),d=e.nncf?" Â· NNCF âœ…":"",s=String(e.type||"").toLowerCase();return o=s.indexOf("mbs")>-1?"VSD ind "+t(e.vsdIndiretto||0):s.indexOf("sottoprod")>-1?"Tel "+a(e.telefonate||0)+" Â· AppFissati "+a(e.appFissati||0):s.indexOf("formaz")>-1?"":"VSS "+t(e.vss||0)+" Â· VSD "+t(e.vsdPersonal||0)+d,'<div class="card lastApp" data-aid="'+r(String(e.id||""))+'" style="cursor:pointer"><div class="small muted">'+r(l)+" Â· "+r(e.type||"manuale")+'</div><div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><div><b>'+r(e.client||"")+'</b></div><div class="row" style="gap:6px"><button class="ghost btn-ics" title="Esporta .ics" data-ics="'+r(String(e.id||""))+'">ðŸ“…</button></div></div>'+(o?'<div class="small">'+o+"</div>":"")+"</div>"}function o(e){return e=Number(e||0),isFinite(e)?e:0}!function(){var e=document.getElementById("lastApps");if(e){var t=e.parentElement;if(!document.getElementById("nextApps")){var n=document.createElement("div");n.className="card",n.innerHTML='<b>Prossimi appuntamenti (oggi + domani)</b><div id="nextApps" style="margin-top:8px"></div>',t.parentElement.insertBefore(n,t)}}}(),Promise.all([_("/api/appointments"),_("/api/periods")]).then(function(l){var d=l[0]&&l[0].appointments||[],s=l[1]&&l[1].periods||[];!function(){var t=document.getElementById("nextApps");if(t){var a=new Date,o=new Date(a.getFullYear(),a.getMonth(),a.getDate(),0,0,0,0),r=new Date(a.getFullYear(),a.getMonth(),a.getDate()+2,0,0,0,0),l=d.filter(function(t){var n=new Date(t.start).getTime(),a=n>=o.getTime()&&n<r.getTime(),i=!e||String(t.userId||t.uid||"")===String(e);return a&&i}).sort(function(e,t){return new Date(e.start)-new Date(t.start)});t.innerHTML=l.length?n(l.map(i).join("")):'<div class="muted">Nessun appuntamento tra oggi e domani</div>',t.querySelectorAll(".lastApp[data-aid]").forEach(function(e){e.addEventListener("click",function(){try{c("bp_edit_aid",e.getAttribute("data-aid"))}catch(t){}Q()})}),t.querySelectorAll("button[data-ics]").forEach(function(e){e.addEventListener("click",function(t){t.stopPropagation();var n=e.getAttribute("data-ics"),a=l.find(function(e){return String(e.id)===String(n)})||d.find(function(e){return String(e.id)===String(n)});if(a)if(window.BP&&BP.ICS&&"function"==typeof BP.ICS.downloadIcsForAppointment)if(BP.ICS.downloadIcsForAppointment(a)){"function"==typeof haptic&&haptic("medium");try{document.dispatchEvent(new Event("ics:exported"))}catch(i){}R(".ics esportato")}else R("Export .ics non disponibile");else R("Export .ics non disponibile");else R("Appuntamento non trovato")})})}}(),function(){var t=document.getElementById("lastApps");if(t){var a=d.filter(function(t){return!e||String(t.userId||t.uid||"")===String(e)}).sort(function(e,t){return new Date(t.start)-new Date(e.start)}).slice(0,6);t.innerHTML=a.length?n(a.map(i).join("")):'<div class="muted">Nessun appuntamento</div>',t.querySelectorAll(".lastApp[data-aid]").forEach(function(e){e.addEventListener("click",function(){try{c("bp_edit_aid",e.getAttribute("data-aid"))}catch(t){}Q()})}),t.querySelectorAll("button[data-ics]").forEach(function(e){e.addEventListener("click",function(t){t.stopPropagation();var n=e.getAttribute("data-ics"),i=a.find(function(e){return String(e.id)===String(n)})||d.find(function(e){return String(e.id)===String(n)});if(i)if(window.BP&&BP.ICS&&"function"==typeof BP.ICS.downloadIcsForAppointment)if(BP.ICS.downloadIcsForAppointment(i)){"function"==typeof haptic&&haptic("medium");try{document.dispatchEvent(new Event("ics:exported"))}catch(o){}R(".ics esportato")}else R("Export .ics non disponibile");else R("Export .ics non disponibile");else R("Appuntamento non trovato")})})}}(),function(){var i=document.getElementById("lastBPs");if(i){var l=s.filter(function(t){return!e||String(t.userId||t.uid||"")===String(e)}).sort(function(e,t){return new Date(t.endDate)-new Date(e.endDate)}).slice(0,3).map(function(e){var n=O(e.type,e.startDate),i=e.indicatorsPrev||{},l=e.indicatorsCons||{},d=function(e){return e&&Object.keys(e).length>0}(l),s=d?l:i,c=o(s.VSS),u=o(s.VSDPersonale),p=o(s.VSDIndiretto),v=o(s.GI),m=o(s.NNCF),g=u+p;return'<div class="card lastBP" data-pid="'+r(String(e.id||""))+'" style="cursor:pointer;flex:1 1 320px"><div style="display:flex;align-items:center;gap:8px"><div><b>'+r(n)+'</b></div><span class="chip small">'+(d?"Consuntivo":"Previsionale")+'</span></div><div class="row" style="margin-top:6px;gap:8px;flex-wrap:wrap"><span class="chip small">VSS <b>'+t(c)+'</b></span><span class="chip small">VSD <b>'+t(g)+'</b> <span class="muted">(P '+t(u)+" Â· I "+t(p)+')</span></span><span class="chip small">GI <b>'+t(v)+'</b></span><span class="chip small">NNCF <b>'+a(m)+"</b></span></div></div>"}).join("");i.innerHTML=l?n(l):'<div class="muted">Nessun BP</div>',i.querySelectorAll(".lastBP[data-pid]").forEach(function(e){e.addEventListener("click",function(){try{c("bp_open_period",{id:e.getAttribute("data-pid"),mode:!1})}catch(t){}X()})})}}()}).catch(function(e){logger.error(e)})}document.title="Battle Plan â€“ Dashboard",i.innerHTML=G()+'<div class="wrap"><div class="card"><b>Filtro</b><div class="row" style="margin-top:6px;align-items:flex-end;gap:16px;flex-wrap:wrap"><div><label>ModalitÃ </label><select id="dash_mode" name="mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div><div><label>Consulente</label><select id="dash_cons"><option value="">Tutti</option></select></div></div>'+l("dash")+'</div><div class="grid" id="kpiGrid"><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>VSS</b><span id="kpi_vss" class="big">â€”</span></div><canvas id="d_mini_vss" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>VSD personale</b><span id="kpi_vsd" class="big">â€”</span></div><canvas id="d_mini_vsdpersonale" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>VSD indiretto</b><span id="kpi_vsd_ind" class="big">â€”</span></div><canvas id="d_mini_vsdindiretto" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>GI</b><span id="kpi_gi" class="big">â€”</span></div><canvas id="d_mini_gi" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>NNCF</b><span id="kpi_nncf" class="big">â€”</span></div><canvas id="d_mini_nncf" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>Tot Provvigioni</b><span id="kpi_provv" class="big">â€”</span></div><canvas id="d_mini_provv" width="320" height="90"></canvas></div></div><div class="card"><b>Ultimi appuntamenti</b><div id="lastApps" class="row" style="margin-top:8px"></div></div><div class="card"><b>Ultimi BP inviati</b><div id="lastBPs" class="row" style="margin-top:8px"></div></div></div>',Y(),_("/api/usernames").then(function(e){var t=e&&e.users||[],n=document.getElementById("dash_cons");n&&(n.innerHTML='<option value="">Tutti</option>'+t.map(function(e){return'<option value="'+r(String(e.id))+'">'+r(e.name||e.email||"User #"+e.id)+"</option>"}).join(""))}).catch(function(){}),f("dash",function(){"function"==typeof haptic&&haptic("light"),u(),p(),v()});var g=document.getElementById("dash_mode");g&&(g.onchange=function(){"function"==typeof haptic&&haptic("light"),u(),p(),v()});var y=document.getElementById("dash_cons");y&&(y.onchange=function(){"function"==typeof haptic&&haptic("light"),u(),p(),v()}),u(),p(),v(),"function"==typeof kickFinal&&kickFinal("dashboard")}function X(){if(!m())return o();document.title="Battle Plan â€“ BP",i.innerHTML=G()+'<div class="wrap"><div class="card"><b>Da inviare</b><div id="bp_to_send" class="grid" style="margin-top:8px"></div></div><div class="card" id="bp_sent_box" style="margin-top:8px"><div id="bp_sent_head" style="display:flex;align-items:center;justify-content:space-between;cursor:pointer"><b>BP inviati (periodi in essere)</b><span id="bp_sent_chev" class="chev">â–¸</span></div><div id="bp_sent" class="row" style="margin-top:8px;display:none"></div></div><div class="card" style="margin-top:8px"><b>Crea/Aggiorna BP</b><div class="row" style="margin-top:8px"><div><label>Tipo</label><select id="p_type"><option value="settimanale">Settimanale (lunâ€“dom)</option><option value="mensile">Mensile</option><option value="trimestrale">Trimestrale</option><option value="semestrale">Semestrale</option><option value="annuale">Annuale</option></select></div><div id="wrap_week" style="display:none"><label>Settimana ISO (1â€“53)</label><input type="number" id="p_week" min="1" max="53" value="'+P(new Date)+'"></div><div id="wrap_month" style="display:none"><label>Mese</label><select id="p_month"><option value="1">Gennaio</option><option value="2">Febbraio</option><option value="3">Marzo</option><option value="4">Aprile</option><option value="5">Maggio</option><option value="6">Giugno</option><option value="7">Luglio</option><option value="8">Agosto</option><option value="9">Settembre</option><option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option></select></div><div id="wrap_quarter" style="display:none"><label>Trimestre</label><select id="p_quarter"><option value="1">T1</option><option value="2">T2</option><option value="3">T3</option><option value="4">T4</option></select></div><div id="wrap_semester" style="display:none"><label>Semestre</label><select id="p_sem"><option value="1">1Â° semestre</option><option value="2">2Â° semestre</option></select></div><div><label>Anno</label><input type="number" id="p_year" min="2000" max="2100" value="'+(new Date).getFullYear()+'"></div></div><div class="row"><div class="small muted">ModalitÃ : <b id="p_mode_lbl">Previsionale</b> Â· <button class="ghost" id="btnImport" style="padding:4px 8px">Importa da agenda</button></div></div><div class="row" style="align-items:center"><div class="small"><b>Periodo selezionato:</b> <span id="p_label" class="neon">â€”</span></div><input type="hidden" id="p_start"><input type="hidden" id="p_end"></div><div class="row small" style="margin-top:6px;opacity:.9"><div><b>Previsionale</b></div><div><b>Consuntivo</b></div><div><b>Avanzamento</b></div></div><div class="row" id="p_rows" style="margin-top:4px"></div><div class="row" style="margin-top:8px;align-items:center;gap:8px;justify-content:space-between"><div id="p_delete_zone"></div><div class="right"><button id="btnSaveP">Salva BP</button></div></div></div><div class="card"><b>BP salvati</b><div id="p_list" class="row" style="margin-top:8px"></div></div></div>',Y();var e=!1,t=null,n=[],a=null,r=m()||{};function l(e){return String(e).replace(/[&<>'"]/g,function(e){return{"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"}[e]})}function d(e){if(!e)return"";var t=new Date(e);return t.getFullYear()+"-"+("0"+(t.getMonth()+1)).slice(-2)+"-"+("0"+t.getDate()).slice(-2)}function s(e){var t=new Date(e);return("0"+t.getDate()).slice(-2)+"/"+("0"+(t.getMonth()+1)).slice(-2)+"/"+t.getFullYear()}function c(e){return(Number(e)||0).toLocaleString("it-IT")+"â‚¬"}function v(e){var t=document.createElement("div");return t.innerHTML=e.trim(),t.firstChild}function g(e){return!!(e&&e.indicatorsCons&&Object.keys(e.indicatorsCons).length>0)}function f(){return"senior"===(r&&r.grade||(m()||{}).grade)?"senior":"junior"}r&&r.grade?Promise.resolve(r):_("/api/usernames").then(function(e){var t=String((m()||{}).id||""),n=(e&&e.users||[]).find(function(e){return String(e.id)===t});return n&&n.grade&&(r.grade=n.grade),r}).catch(function(){return r});var b=document.getElementById("p_type"),y=document.getElementById("p_year"),h=document.getElementById("wrap_week"),w=document.getElementById("wrap_month"),I=document.getElementById("wrap_quarter"),S=document.getElementById("wrap_semester"),E=document.getElementById("p_week"),D=document.getElementById("p_month"),j=document.getElementById("p_quarter"),H=document.getElementById("p_sem"),z=document.getElementById("p_label"),q=document.getElementById("p_start"),W=document.getElementById("p_end"),X=document.getElementById("p_mode_lbl"),$=document.getElementById("btnImport");function Z(t){e=!!t,X.textContent=e?"Consuntivo":"Previsionale",$.style.display=e?"none":"",document.querySelectorAll("[data-row]").forEach(function(t){var n=t.querySelector("[data-prev]"),a=t.querySelector("[data-cons]"),i=t.querySelector("[data-bar]");if(e){if(n){n.removeAttribute("hidden");var o=n.querySelector("input");o&&(o.setAttribute("readonly","readonly"),o.classList.add("disabled"))}if(a){a.removeAttribute("hidden");var r=a.querySelector("input");r&&(r.removeAttribute("readonly"),r.classList.remove("disabled"))}i&&i.removeAttribute("hidden")}else{if(n){n.removeAttribute("hidden");var l=n.querySelector("input");l&&(l.removeAttribute("readonly"),l.classList.remove("disabled"))}a&&a.setAttribute("hidden","hidden"),i&&i.setAttribute("hidden","hidden")}}),re()}function J(){var e=b.value;h.style.display="settimanale"===e?"":"none",w.style.display="mensile"===e?"":"none",I.style.display="trimestrale"===e?"":"none",S.style.display="semestrale"===e?"":"none",Q()}function Q(){var e,n,i,o=b.value,r=parseInt(y.value,10);if("settimanale"===o){var l=Math.max(1,Math.min(53,parseInt(E.value||"1",10))),c=F(r,l);e=c.start,n=c.end,i="Sett. "+l+" Â· "+s(e)+" â†’ "+s(n)}else if("mensile"===o){var u=parseInt(D.value,10);e=new Date(r,u-1,1),n=new Date(r,u,0),i=e.toLocaleString("it-IT",{month:"long",year:"numeric"})+" Â· "+s(e)+" â†’ "+s(n)}else if("trimestrale"===o){var p=parseInt(j.value,10);e=new Date(r,3*(p-1),1),n=new Date(r,3*p,0),i="Trimestre "+p+" "+r+" Â· "+s(e)+" â†’ "+s(n)}else if("semestrale"===o){var v=parseInt(H.value,10);e=new Date(r,1===v?0:6,1),n=new Date(r,1===v?6:12,0),i=(1===v?"1Â°":"2Â°")+" semestre "+r+" Â· "+s(e)+" â†’ "+s(n)}else e=new Date(r,0,1),n=new Date(r,11,31),i="Anno "+r+" Â· "+s(e)+" â†’ "+s(n);q.value=d(e),W.value=d(n),z.textContent=i,Z(!1),t=null,a=null,ne(),re()}function K(e){for(var t="",a=0;a<e.length;a++){var i=e[a],o=/^(VSS|VSDPersonale|VSDIndiretto|GI)$/i.test(i);t+='<div class="row" data-row="'+i+'"><div data-prev><label>'+i+' (Prev)</label><input type="number" step="1" id="prev_'+i+'" placeholder="'+(o?"â‚¬":"n")+'"></div><div data-cons><label>'+i+' (Cons)</label><input type="number" step="1" id="cons_'+i+'" placeholder="'+(o?"â‚¬":"n")+'"></div><div data-bar class="small"><div style="height:10px;background:rgba(255,255,255,.12);border-radius:999px;overflow:hidden"><div id="bar_'+i+'" style="height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2));"></div></div><div id="pct_'+i+'" class="small muted">0%</div></div></div>'}document.getElementById("p_rows").innerHTML=t,Z(!1),function(){for(var e=0;e<n.length;e++)(function(e){var t=document.getElementById("prev_"+e),n=document.getElementById("cons_"+e);t&&(t.oninput=ee),n&&(n.oninput=ee)})(n[e])}(),ee()}function ee(){for(var e=0;e<n.length;e++){var t=n[e],a=document.getElementById("prev_"+t),i=document.getElementById("cons_"+t);if(a&&i){var o=Number(a.value||0),r=Number(i.value||0),l=o>0?Math.round(r/o*100):r>0?100:0;l=Math.max(0,Math.min(200,l));var d=document.getElementById("bar_"+t),s=document.getElementById("pct_"+t);d&&(d.style.width=Math.min(l,100)+"%"),s&&(s.textContent=l+"%")}}}function te(){for(var e=0;e<n.length;e++){var t=document.getElementById("prev_"+n[e]);t&&(t.value="")}ee()}function ne(){for(var e=0;e<n.length;e++){var t=document.getElementById("cons_"+n[e]);t&&(t.value="")}ee()}function ae(e){for(var t in e){var n=document.getElementById("prev_"+t);n&&(n.value=String(e[t]||0))}ee()}function ie(e,t){e=Object.assign({},e||{});var n=.15*Number(e.GI||0),a=Number(e.VSDPersonale||0)*("senior"===String(t)?.25:.2);return e.ProvvGI=Math.round(100*n)/100,e.ProvvVSD=Math.round(100*a)/100,e.TotProvvigioni=Math.round(100*(e.ProvvGI+e.ProvvVSD))/100,e}function oe(e,t,n){return fetch(t,{method:e,headers:n?{"Content-Type":"application/json"}:void 0,body:n?JSON.stringify(n):void 0}).then(function(e){return e.ok?e.json().catch(function(){return{}}):Promise.reject(new Error("HTTP "+e.status))})}function re(){var e=document.getElementById("p_delete_zone");if(e)if(t){var n="";!(!a||!g(a))&&(n+='<button id="btnDelCons" class="ghost" style="border-color:#7d1731;color:#7d1731">Elimina Consuntivo</button> '),n+='<button id="btnDelBP" class="ghost" style="border-color:#7d1731;color:#7d1731">Elimina BP</button>',e.innerHTML=n;var i=document.getElementById("btnDelBP");i&&(i.onclick=function(){confirm("Eliminare definitivamente questo BP?")&&(i.disabled=!0,function(e){for(var t=encodeURIComponent(e),n=[function(){return oe("POST","/api/periods/delete",{id:e})},function(){return oe("POST","/api/periods",{id:e,_delete:!0})},function(){return oe("POST","/api/periods/"+t,{_method:"DELETE"})},function(){return oe("DELETE","/api/periods/"+t,null)},function(){return oe("DELETE","/api/periods?id="+t,null)}],a=Promise.reject(new Error("start")),i=0;i<n.length;i++)(function(e){a=a.catch(e)})(n[i]);return a.catch(function(e){throw logger.warn("Delete fallback: tutte le route fallite",e),e})}(t).then(function(){R("BP eliminato"),t=null,a=null,te(),ne(),Z(!1),Q(),le()}).catch(function(){R("Endpoint delete non disponibile")}).finally(function(){i.disabled=!1}))});var o=document.getElementById("btnDelCons");o&&(o.onclick=function(){if(confirm("Rimuovere solo il Consuntivo?")){o.disabled=!0;var e,n=(e={},a?{id:t||a.id,type:a.type,startDate:d(a.startDate),endDate:d(a.endDate),indicatorsPrev:Object.assign({},a.indicatorsPrev||{}),indicatorsCons:null!=e?e:Object.assign({},a.indicatorsCons||{})}:null);if(n){var i=f();n.indicatorsPrev=ie(n.indicatorsPrev,i),n.indicatorsCons={},x("/api/periods",n).then(function(){R("Consuntivo eliminato"),a&&(a.indicatorsCons={}),Z(!0),le(),re()}).catch(function(){R("Errore eliminazione Consuntivo")}).finally(function(){o.disabled=!1})}else o.disabled=!1}})}else e.innerHTML=""}function le(){_("/api/periods").then(function(e){var t=e.periods||[];t.sort(function(e,t){return new Date(t.startDate)-new Date(e.startDate)});for(var n="",a=0;a<t.length;a++){var i=t[a];n+='<div class="card" style="flex:1 1 360px"><div><b>'+l(O(i.type,i.startDate)+" Â· "+s(i.startDate)+" â†’ "+s(i.endDate))+'</b></div><div class="small">Prev VSS '+c((i.indicatorsPrev||{}).VSS||0)+" Â· Cons "+c((i.indicatorsCons||{}).VSS||0)+'</div><div class="right" style="margin-top:6px"><button class="ghost" data-edit="'+i.id+'">Modifica previs.</button><button data-cons="'+i.id+'">Consuntivoâ€¦</button></div></div>'}document.getElementById("p_list").innerHTML=n||'<div class="muted">Nessun BP</div>',document.querySelectorAll("[data-edit]").forEach(function(t){t.addEventListener("click",function(){var n=t.getAttribute("data-edit"),a=(e.periods||[]).find(function(e){return e.id===n});a&&de(a,!1)})}),document.querySelectorAll("[data-cons]").forEach(function(t){t.addEventListener("click",function(){var n=t.getAttribute("data-cons"),a=(e.periods||[]).find(function(e){return e.id===n});a&&de(a,!0)})}),function(e){var t=document.getElementById("bp_to_send"),n=document.getElementById("bp_sent");function a(t,n,a){return e.find(function(e){return e.type===t&&d(e.startDate)===d(n)&&d(e.endDate)===d(a)})}t.innerHTML="",n.innerHTML="";var i=new Date,o=i.getDay(),r=5===o||6===o||0===o,c=T(i),u=k(i),p=A(i),m=L(i),f=r&&ue(c),h=r&&ue(u),w=r&&ue(p),_=r&&ue(m);function x(e,n,i){var o=a(e,i.start,i.end),r=a(e,n.start,n.end);o?t.appendChild(pe("Previsionale",e,i.start,i.end,"Modifica",function(){de(o,!1)})):t.appendChild(pe("Previsionale",e,i.start,i.end,"Compila",function(){if(b.value=e,y.value=String(i.start.getFullYear()),"settimanale"===e)E.value=String(P(i.start));else if("mensile"===e)D.value=String(i.start.getMonth()+1);else if("trimestrale"===e){var t=Math.floor(i.start.getMonth()/3)+1;j.value=String(t)}else"semestrale"===e&&(H.value=i.start.getMonth()<6?"1":"2");J()})),r&&!g(r)&&t.appendChild(pe("Consuntivo",e,n.start,n.end,"Consuntivo",function(){de(r,!0)}))}if(["settimanale","mensile","trimestrale","semestrale","annuale"].forEach(function(e){var t=se(e,i),o=a(e,t.start,t.end);if(o){var r=v('<div class="card" style="flex:1 1 360px"><div><b>'+l(O(e,t.start))+'</b></div><div class="small muted">'+s(t.start)+" â†’ "+s(t.end)+'</div><div class="right" style="margin-top:6px"><button class="ghost" type="button" data-mid="'+o.id+'">Modifica</button></div></div>');r.querySelector("[data-mid]").addEventListener("click",function(){de(o,!1)}),n.appendChild(r)}}),r){x("settimanale",se("settimanale",i),ce("settimanale",i))}if(f){x("mensile",se("mensile",i),ce("mensile",i))}if(h){x("trimestrale",se("trimestrale",i),ce("trimestrale",i))}if(w){x("semestrale",se("semestrale",i),ce("semestrale",i))}if(_){x("annuale",se("annuale",i),ce("annuale",i))}t.children.length||(t.innerHTML='<div class="muted">Nessun suggerimento attivo in questo momento</div>');var I=document.getElementById("bp_sent_head"),S=document.getElementById("bp_sent_chev");I.onclick=function(){var e=document.getElementById("bp_sent"),t="none"!==e.style.display;e.style.display=t?"none":"",S.textContent=t?"â–¸":"â–¾"}}(t);var o=u("bp_open_period",null);if(o){p("bp_open_period");var r=t.find(function(e){return e.id===o.id});r&&de(r,!0===o.mode)}})}function de(e,n){a=e||null,b.value=e.type;var i=new Date(e.startDate),o=i.getFullYear();if(y.value=String(o),"settimanale"===e.type)E.value=String(P(i));else if("mensile"===e.type)D.value=String(i.getMonth()+1);else if("trimestrale"===e.type){var r=Math.floor(i.getMonth()/3)+1;j.value=String(r)}else"semestrale"===e.type&&(H.value=i.getMonth()<6?"1":"2");J(),te(),ne(),ae(e.indicatorsPrev||{}),function(e){for(var t in e){var n=document.getElementById("cons_"+t);n&&(n.value=String(e[t]||0))}ee()}(e.indicatorsCons||{}),Z(!!n),t=e.id||null,re(),R(n?"Compila il consuntivo":"Modifica previsionale"),window.scrollTo({top:0,behavior:"smooth"})}function se(e,t){var n=(t=t||new Date).getFullYear();if("settimanale"===e){var a=F(n,P(t));return{start:a.start,end:a.end}}return"mensile"===e?{start:B(t),end:T(t)}:"trimestrale"===e?{start:C(t),end:k(t)}:"semestrale"===e?{start:M(t),end:A(t)}:{start:N(t),end:L(t)}}function ce(e,t){return t=t||new Date,"settimanale"===e?V(t):"mensile"===e?(n=t,{start:a=new Date(n.getFullYear(),n.getMonth()+1,1),end:new Date(a.getFullYear(),a.getMonth()+1,0,23,59,59,999)}):"trimestrale"===e?function(e){var t=C(new Date(e.getFullYear(),e.getMonth()+3,1));return{start:t,end:new Date(t.getFullYear(),t.getMonth()+3,0,23,59,59,999)}}(t):"semestrale"===e?function(e){var t=M(new Date(e.getFullYear(),e.getMonth()+6,1));return{start:t,end:new Date(t.getFullYear(),t.getMonth()+6,0,23,59,59,999)}}(t):function(e){var t=N(new Date(e.getFullYear()+1,0,1));return{start:t,end:L(t)}}(t);var n,a}function ue(e){var t=F((new Date).getFullYear(),P(new Date)).start;return Math.floor((new Date(e)-t)/864e5)<=13}function pe(e,t,n,a,i,o){var r=O(t,n),d=v('<div class="card" style="position:relative"><div class="small muted">'+l(e)+"</div><div><b>"+l(r)+'</b></div><div class="small muted">'+s(n)+" â†’ "+s(a)+'</div><div class="right" style="margin-top:6px"><button class="ghost" type="button" data-sug="1">'+l(i)+"</button></div></div>");return d.querySelector("[data-sug]").addEventListener("click",o),d}_("/api/settings").then(function(e){K(n=e&&e.indicators||["VSS","VSDPersonale","VSDIndiretto","GI","Telefonate","AppFissati","AppFatti","CorsiLeadership","iProfile","MBS","NNCF"])}).catch(function(){K(n=["VSS","VSDPersonale","GI","NNCF"])}),b.onchange=J,y.oninput=Q,E.oninput=Q,D.onchange=Q,j.onchange=Q,H.onchange=Q,$.onclick=function(){if(!e){var t=q.value,n=W.value;t&&n?_("/api/appointments").then(function(e){for(var a=e.appointments||[],i=new Date(t),o=new Date(n),r={VSS:0,VSDPersonale:0,VSDIndiretto:0,GI:0,Telefonate:0,AppFissati:0,AppFatti:0,CorsiLeadership:0,iProfile:0,MBS:0,NNCF:0},l=0;l<a.length;l++){var d=a[l],s=new Date(d.start);s>=i&&s<=o&&(r.VSS+=Number(d.vss||0),r.VSDPersonale+=Number(d.vsdPersonal||0),d.nncf&&(r.NNCF+=1))}ae(r),R("Previsionale compilato dalla tua agenda"),U(),window.addXP(10)}).catch(function(){R("Errore import agenda")}):R("Seleziona il periodo")}},document.getElementById("btnSaveP").onclick=function(){var i=b.value,o=q.value,r=W.value;if(o&&r){for(var l={},d={},s=0;s<n.length;s++){var c=n[s];l[c]=Number(document.getElementById("prev_"+c).value||0),e&&(d[c]=Number(document.getElementById("cons_"+c).value||0))}var u=f();l=ie(l,u),e&&(d=ie(d,u));var p={type:i,startDate:o,endDate:r,indicatorsPrev:l};e&&(p.indicatorsCons=d),t&&(p.id=t),x("/api/periods",p).then(function(n){R("BP salvato"),e?window.addXP(20):window.addXP(10),U();try{document.dispatchEvent(new Event("bp:saved"))}catch(i){}le(),!t&&n&&n.id&&(t=n.id),t&&a&&(a.indicatorsPrev=l,e&&(a.indicatorsCons=d)),re()}).catch(function(){R("Errore salvataggio BP")})}else R("Seleziona il periodo")},J(),le()}function Q(){if(!m())return o();if(document.title="Battle Plan â€“ Appuntamenti",!document.getElementById("appts_css")){var e=document.createElement("style");e.id="appts_css",e.textContent="\n      .appt-type .seg, #a_nncf.seg{\n        padding:8px 12px;border:1px solid #bcd7ff;border-radius:12px;\n        background:#eef5ff;color:#1463ff;cursor:pointer;user-select:none;\n        transition:.15s;\n      }\n      .appt-type .seg.active, #a_nncf.seg.active{\n        background:var(--accent);color:#fff;border-color:var(--accent);\n        box-shadow:0 0 0 2px rgba(20,99,255,.08) inset;\n      }\n      #a_list .grid3{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}\n    ",document.head.appendChild(e)}function t(e){return String(e).replace(/[&<>'"]/g,function(e){return{"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"}[e]})}function n(e){return(Number(e)||0).toLocaleString("it-IT")+"â‚¬"}function a(e){if(!e)return"";var t=new Date(e);return isNaN(t)?"":t.toISOString()}function r(e){return(e=String(e||"").toLowerCase()).indexOf("mezza")>-1?240:e.indexOf("giorn")>-1||e.indexOf("formaz")>-1||e.indexOf("mbs")>-1?570:e.indexOf("sottoprod")>-1?240:90}i.innerHTML=G()+'<div class="wrap"><div class="card"><b id="a_form_title">Nuovo appuntamento</b><div class="row" style="margin-top:8px;align-items:flex-end;gap:12px;flex-wrap:wrap"><div style="min-width:320px"><label>Cliente *</label><div style="display:flex;gap:8px;align-items:center"><input id="a_client" list="clientList" placeholder="Denominazione" style="flex:1"><datalist id="clientList"></datalist><button id="a_nncf" class="seg" data-active="0" aria-pressed="false">NNCF</button></div></div><div><label>Data/ora inizio</label><input id="a_start" type="datetime-local"></div><div><label>Ora fine</label><input id="a_end" type="time"></div><div><label>Durata (min)</label><input id="a_dur" type="number" placeholder="60" min="1"></div></div><div class="row" style="margin-top:8px"><div style="flex:1"><label>Descrizione appuntamento</label><textarea id="a_desc" rows="2"></textarea></div></div><div class="row" style="align-items:flex-end;gap:12px;flex-wrap:wrap"><div class="appt-type"><label>Tipo</label><div><button type="button" id="t_vendita" class="seg">Vendita</button><button type="button" id="t_mezza"   class="seg" data-vsd="1000">Mezza giornata</button><button type="button" id="t_full"    class="seg" data-vsd="2000">Giornata intera</button><button type="button" id="t_form"    class="seg">Formazione</button><button type="button" id="t_mbs"     class="seg">MBS</button><button type="button" id="t_sotto"   class="seg">Sottoprodotti</button></div><input id="a_type" type="hidden" value="vendita"></div><div id="row_vss"><label>VSS</label><input id="a_vss" type="number" step="1" placeholder="0"></div><div id="row_vsd_p"><label>VSD personale</label><input id="a_vsd" type="number" step="1" placeholder="0"></div><div id="row_vsd_i" style="display:none"><label>VSD indiretto</label><input id="a_vsd_i" type="number" step="1" placeholder="0"></div><div id="row_tel" style="display:none"><label>Telefonate</label><input id="a_tel" type="number" step="1" placeholder="0"></div><div id="row_app" style="display:none"><label>Appunt. fissati</label><input id="a_app" type="number" step="1" placeholder="0"></div></div><div class="row" style="margin-top:8px;gap:8px;align-items:center"><div><button id="btnSaveA">Salva</button></div><div><button id="btnSaveExportA" class="ghost">Salva ed esporta</button></div><div class="right" style="margin-left:auto"><button id="btnDeleteA" class="danger" style="display:none">Elimina</button></div></div></div><div class="card"><b>Elenco appuntamenti</b><div class="row" style="margin-top:8px;align-items:flex-end;gap:12px;flex-wrap:wrap"><div><label>Vista</label><select id="af_type"><option value="sett">Settimana</option><option value="mese">Mese</option></select></div><div id="af_week_wrap"><label>Settimana ISO</label><input id="af_week" type="number" min="1" max="53" value="'+P(new Date)+'"></div><div id="af_month_wrap" style="display:none"><label>Mese</label><select id="af_month"><option value="1">Gennaio</option><option value="2">Febbraio</option><option value="3">Marzo</option><option value="4">Aprile</option><option value="5">Maggio</option><option value="6">Giugno</option><option value="7">Luglio</option><option value="8">Agosto</option><option value="9">Settembre</option><option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option></select></div><div><label>Anno</label><input id="af_year" type="number" min="2000" max="2100" value="'+(new Date).getFullYear()+'"></div><div class="right" style="margin-left:auto;display:flex;gap:8px"><button id="af_prev" class="ghost">â—€</button><button id="af_next" class="ghost">â–¶</button></div></div><div id="a_list" style="margin-top:8px"></div></div></div>',Y();var l=document.getElementById("a_nncf");l.addEventListener("click",function(){var e="1"!==l.getAttribute("data-active");l.setAttribute("data-active",e?"1":"0"),l.setAttribute("aria-pressed",e?"true":"false"),l.classList.toggle("active",e),e&&h(document.getElementById("t_vendita"))});var d=document.getElementById("t_vendita"),s=document.getElementById("t_mezza"),c=document.getElementById("t_full"),g=document.getElementById("t_form"),f=document.getElementById("t_mbs"),b=document.getElementById("t_sotto"),y=[d,s,c,g,f,b];function h(e){y.forEach(function(t){return t.classList.toggle("active",t===e)});var t=document.getElementById("a_type"),n=document.getElementById("a_client"),a=document.getElementById("row_vss"),i=document.getElementById("row_vsd_p"),o=document.getElementById("row_vsd_i"),r=document.getElementById("row_tel"),u=document.getElementById("row_app");document.getElementById("a_vss").value="",document.getElementById("a_vsd").value="",document.getElementById("a_vsd_i").value="",document.getElementById("a_tel").value="",document.getElementById("a_app").value="",a.style.display="",i.style.display="",o.style.display="none",r.style.display="none",u.style.display="none",n.disabled=!1,l.style.display="",l.setAttribute("data-active","0"),l.setAttribute("aria-pressed","false"),l.classList.remove("active"),"Formazione"!==n.value&&"MBS"!==n.value&&"Sottoprodotti"!==n.value||(n.value=""),e===d?(t.value="vendita",w(90)):e===s?(t.value="mezza",w(240),document.getElementById("a_vsd").value="1000"):e===c?(t.value="giornata",w(570),document.getElementById("a_vsd").value="2000"):e===g?(t.value="formazione",w(570),n.value="Formazione",n.disabled=!0,a.style.display="none",i.style.display="none",l.style.display="none"):e===f?(t.value="MBS",w(570),n.value="MBS",n.disabled=!0,a.style.display="none",i.style.display="none",o.style.display="",document.getElementById("a_vsd_i").value="2000",l.style.display="none"):e===b&&(t.value="sottoprodotti",w(240),n.value="Sottoprodotti",n.disabled=!0,a.style.display="none",i.style.display="none",r.style.display="",u.style.display="",l.style.display="none")}function w(e){document.getElementById("a_dur").value=String(e),I()}function I(){var e=document.getElementById("a_start").value,t=parseInt(document.getElementById("a_dur").value||"0",10);if(!e||!isFinite(t)||t<=0)document.getElementById("a_end").value="";else{var n=new Date(e),a=new Date(n.getTime()+6e4*t);document.getElementById("a_end").value=("0"+a.getHours()).slice(-2)+":"+("0"+a.getMinutes()).slice(-2)}}y.forEach(function(e){return e.addEventListener("click",function(t){t.preventDefault(),h(e)})}),h(d),document.getElementById("a_start").addEventListener("change",I),document.getElementById("a_dur").addEventListener("input",I),document.getElementById("a_end").addEventListener("change",function(){var e=document.getElementById("a_start").value,t=document.getElementById("a_end").value;if(e&&t){var n=new Date(e),a=t.split(":");if(!(a.length<2)){var i=new Date(n);i.setHours(parseInt(a[0],10)||0,parseInt(a[1],10)||0,0,0),i<n&&i.setDate(i.getDate()+1);var o=Math.round((i-n)/6e4);document.getElementById("a_dur").value=String(Math.max(1,o))}}}),_("/api/clients").then(function(e){var n=e&&e.clients||[],a=document.getElementById("clientList");a&&(a.innerHTML=n.map(function(e){return'<option value="'+t(e.name)+'"></option>'}).join(""))});var S=null;function E(){S=null,document.getElementById("a_form_title").textContent="Nuovo appuntamento",document.getElementById("a_client").value="",document.getElementById("a_start").value="",document.getElementById("a_end").value="",document.getElementById("a_dur").value="",document.getElementById("a_vss").value="",document.getElementById("a_vsd").value="",document.getElementById("a_vsd_i").value="",document.getElementById("a_tel").value="",document.getElementById("a_app").value="",document.getElementById("a_desc").value="",document.getElementById("a_client").disabled=!1,l.style.display="",l.setAttribute("data-active","0"),l.setAttribute("aria-pressed","false"),l.classList.remove("active"),h(d),document.getElementById("btnDeleteA").style.display="none"}function D(e){S=e.id,document.getElementById("a_form_title").textContent="Modifica appuntamento";var t=String(e.type||"vendita").toLowerCase();t.indexOf("mezza")>-1?h(s):t.indexOf("giorn")>-1?h(c):t.indexOf("formaz")>-1?h(g):t.indexOf("mbs")>-1?h(f):t.indexOf("sottoprod")>-1?h(b):h(d),document.getElementById("a_client").value=e.client||"",document.getElementById("a_start").value=function(e){if(!e)return"";var t=new Date(e);return isNaN(t)?"":new Date(t.getTime()-6e4*t.getTimezoneOffset()).toISOString().slice(0,16)}(e.start);var n=new Date(e.start),a=e.end?new Date(e.end):null,i=Number(e.durationMinutes);a instanceof Date&&!isNaN(a)&&a>=n?i=Math.max(1,Math.round((a-n)/6e4)):(isFinite(i)&&i>0||(i=r(e.type||"vendita")),a=new Date(n.getTime()+6e4*i)),document.getElementById("a_dur").value=String(i),document.getElementById("a_end").value=("0"+a.getHours()).slice(-2)+":"+("0"+a.getMinutes()).slice(-2),document.getElementById("a_vss").value=e.vss||"",document.getElementById("a_vsd").value=e.vsdPersonal||e.vsd||"",document.getElementById("a_vsd_i").value=e.vsdIndiretto||"",document.getElementById("a_tel").value=e.telefonate||"",document.getElementById("a_app").value=e.appFissati||"",document.getElementById("a_desc").value=e.notes||"";var o=!!e.nncf;l.setAttribute("data-active",o?"1":"0"),l.setAttribute("aria-pressed",o?"true":"false"),l.classList.toggle("active",o),document.getElementById("btnDeleteA").style.display=""}function B(){var e=(document.getElementById("a_client").value||"").trim(),t=document.getElementById("a_type").value;if(!e){var n=String(t||"").toLowerCase();if("formazione"!==n&&"mbs"!==n&&"sottoprodotti"!==n)return R("Cliente obbligatorio"),null;e=t}var i=document.getElementById("a_start").value;if(!i)return R("Data/ora obbligatorie"),null;var o=parseInt(document.getElementById("a_dur").value||"60",10);(!isFinite(o)||o<=0)&&(o=60);var r,d=document.getElementById("a_end").value;if(d){var s=new Date(i),c=d.split(":"),u=new Date(s);u.setHours(parseInt(c[0],10)||0,parseInt(c[1],10)||0,0,0),u<s&&u.setDate(u.getDate()+1),r=u.toISOString(),o=Math.max(1,Math.round((u-s)/6e4)),document.getElementById("a_dur").value=String(o)}else{r=new Date(new Date(i).getTime()+6e4*o).toISOString()}var p=document.getElementById("a_desc").value||"";return{id:S||void 0,client:e,start:a(i),end:r,durationMinutes:o,type:t,vss:Number(document.getElementById("a_vss").value||0),vsdPersonal:Number(document.getElementById("a_vsd").value||0),vsdIndiretto:Number(document.getElementById("a_vsd_i").value||0),telefonate:Number(document.getElementById("a_tel").value||0),appFissati:Number(document.getElementById("a_app").value||0),notes:p,nncf:"1"===l.getAttribute("data-active")}}function T(e){var t=B();if(t){var n=!S;x("/api/appointments",t).then(function(){if(R("Appuntamento salvato"),"undefined"!=typeof haptics&&haptics.try("success"),document.dispatchEvent(new Event("appt:saved")),n)try{document.dispatchEvent(new Event("appt:created"))}catch(a){}if(e&&window.BP&&BP.ICS&&"function"==typeof BP.ICS.downloadIcsForAppointment)if(BP.ICS.downloadIcsForAppointment(t)){"undefined"!=typeof haptics&&haptics.try("medium");try{document.dispatchEvent(new Event("ics:exported"))}catch(a){}R(".ics esportato")}else R("Export .ics non disponibile");E(),O()}).catch(function(){return R("Errore salvataggio")})}}function C(){if(S&&confirm("Eliminare l'appuntamento?")){var e=B();fetch("/api/appointments?id="+encodeURIComponent(S),{method:"DELETE",headers:{Authorization:"Bearer "+v()}}).then(function(e){if(!e.ok)throw new Error("HTTP "+e.status);return e.json()}).then(function(){R("Eliminato"),"function"==typeof showUndo&&e&&showUndo("Appuntamento eliminato",function(){return x("/api/appointments",e)},5e3),E(),O()}).catch(function(){return R("Errore eliminazione")})}}function k(e){var t=document.getElementById("af_type").value,n=parseInt(document.getElementById("af_year").value,10);if("sett"===t){var a=parseInt(document.getElementById("af_week").value,10),i=new Date(F(n,a).start);i.setDate(i.getDate()+7*e),document.getElementById("af_year").value=i.getFullYear(),document.getElementById("af_week").value=P(i)}else{var o=parseInt(document.getElementById("af_month").value,10),r=new Date(n,o-1,1);r.setMonth(r.getMonth()+e),document.getElementById("af_year").value=r.getFullYear(),document.getElementById("af_month").value=r.getMonth()+1}O()}document.getElementById("btnSaveA").onclick=function(){return T(!1)},document.getElementById("btnSaveExportA").onclick=function(){return T(!0)},document.getElementById("btnDeleteA").onclick=C,document.getElementById("af_prev").onclick=function(){return k(-1)},document.getElementById("af_next").onclick=function(){return k(1)};var M=document.getElementById("af_type"),A=document.getElementById("af_week"),N=document.getElementById("af_month"),L=document.getElementById("af_year");function V(e){var a=new Date(e.start),i=e.end?new Date(e.end):null;if(!(i instanceof Date)||isNaN(i)||i<a){var o=isFinite(e.durationMinutes)?Number(e.durationMinutes):r(e.type||"vendita");i=new Date(a.getTime()+6e4*o)}var l,d,s=("0"+(l=new Date(a)).getDate()).slice(-2)+"/"+("0"+(l.getMonth()+1)).slice(-2)+"/"+l.getFullYear()+" "+("0"+a.getHours()).slice(-2)+":"+("0"+a.getMinutes()).slice(-2)+"â€“"+("0"+i.getHours()).slice(-2)+":"+("0"+i.getMinutes()).slice(-2),c=String(e.type||"").toLowerCase();return d=c.indexOf("mbs")>-1?"VSD ind "+n(e.vsdIndiretto||0):c.indexOf("sottoprod")>-1?"Tel "+z(e.telefonate||0)+" Â· AppFissati "+z(e.appFissati||0):c.indexOf("formaz")>-1?"":"VSS "+n(e.vss||0)+" Â· VSD "+n(e.vsdPersonal||0)+" Â· NNCF "+(e.nncf?"âœ…":"â€”"),'<div class="card" data-aid="'+t(String(e.id||""))+'" style="flex:1 1 320px;cursor:pointer"><div class="small muted">'+t(s)+" Â· "+t(e.type||"vendita")+'</div><div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><div><b>'+t(e.client||"")+'</b></div><button class="ghost btn-ics" title="Esporta" data-ics="'+t(String(e.id||""))+'">ðŸ“…</button></div>'+(d?'<div class="small">'+d+"</div>":"")+"</div>"}function O(){_("/api/appointments").then(function(e){var t=e&&e.appointments||[],n=function(){var e=document.getElementById("af_type").value,t=parseInt(document.getElementById("af_year").value,10);if("sett"===e){var n=F(t,Math.max(1,Math.min(53,parseInt(document.getElementById("af_week").value||P(new Date),10))));return{s:new Date(n.start),e:new Date(n.end)}}var a=parseInt(document.getElementById("af_month").value||(new Date).getMonth()+1,10);return{s:new Date(t,a-1,1),e:new Date(t,a,0,23,59,59,999)}}(),a=n.s.getTime(),i=n.e.getTime(),o=t.filter(function(e){var t=new Date(e.start).getTime();return t>=a&&t<=i}).sort(function(e,t){return new Date(e.start)-new Date(t.start)}),r=new Date,l=o.filter(function(e){return new Date(e.start)>=r}),d=o.filter(function(e){return new Date(e.start)<r}),s=document.getElementById("a_list"),c="";c+="<div><b>Prossimi</b></div>",c+=l.length?'<div class="grid3">'+l.map(V).join("")+"</div>":'<div class="muted" style="margin:6px 0 12px">Nessun appuntamento futuro</div>';var u,p,v,m="past_"+Math.random().toString(36).slice(2,8);c+='<div id="'+m+'_head" style="margin-top:12px;display:flex;align-items:center;justify-content:space-between;cursor:pointer"><b>Passati</b><span class="chev">â–¸</span></div><div id="'+m+'_box" style="display:none;margin-top:8px">'+(d.length?'<div class="grid3">'+d.map(V).join("")+"</div>":'<div class="muted">Nessun appuntamento passato</div>')+"</div>",s.innerHTML=c,u=document.getElementById(m+"_head"),p=document.getElementById(m+"_box"),v=u.querySelector(".chev"),u.onclick=function(){var e="none"===p.style.display;p.style.display=e?"":"none",v.textContent=e?"â–¾":"â–¸"};var g=o;s.querySelectorAll("[data-ics]").forEach(function(e){e.addEventListener("click",function(t){t.stopPropagation();var n=e.getAttribute("data-ics"),a=g.find(function(e){return String(e.id)===String(n)});if(a)if(window.BP&&BP.ICS&&"function"==typeof BP.ICS.downloadIcsForAppointment)if(BP.ICS.downloadIcsForAppointment(a)){"undefined"!=typeof haptics&&haptics.try("medium");try{document.dispatchEvent(new Event("ics:exported"))}catch(i){}R("Esportato")}else R("Export .ics non disponibile");else R("Export .ics non disponibile");else R("Appuntamento non trovato")})}),s.querySelectorAll(".card[data-aid]").forEach(function(e){e.addEventListener("click",function(){var t=e.getAttribute("data-aid"),n=g.find(function(e){return String(e.id)===String(t)});n&&(D(n),window.scrollTo({top:0,behavior:"smooth"}))})})})}M.onchange=function(){var e=M.value;document.getElementById("af_week_wrap").style.display="sett"===e?"":"none",document.getElementById("af_month_wrap").style.display="mese"===e?"":"none",O()},[A,N,L].forEach(function(e){e&&(e.onchange=O)});try{var U=u("bp_prefill_slot",null);if(U&&U.start){var j=new Date(U.start),H=new Date(U.end||U.start),q=new Date(j.getTime()-6e4*j.getTimezoneOffset()).toISOString().slice(0,16);document.getElementById("a_start").value=q,document.getElementById("a_dur").value=String(Math.max(1,Math.round((H-j)/6e4))),I(),R("Slot precompilato negli appuntamenti")}p("bp_prefill_slot")}catch(X){}try{var W=u("bp_edit_aid",null);W&&_("/api/appointments").then(function(e){var t=(e&&e.appointments||[]).find(function(e){return String(e.id)===String(W)});t&&(D(t),window.scrollTo({top:0,behavior:"smooth"}))}).finally(function(){try{p("bp_edit_aid")}catch(X){}})}catch(X){}document.getElementById("btnSaveA").onclick=function(){return T(!1)},document.getElementById("btnSaveExportA").onclick=function(){return T(!0)},document.getElementById("btnDeleteA").onclick=C,_("/api/clients").then(function(){}),O()}window.$1=window.$1||Z,window.$all=window.$all||J,window.addXP=window.addXP||function(){},"object"!==a(window.logger)&&(window.logger=["debug","info","log","warn","error"].reduce(function(e,t){return e[t]=(console[t]||console.log).bind(console),e},{})),"function"!=typeof window.haptic&&(window.haptic=function(){}),function(){var e=window.__miniCharts=window.__miniCharts||{};function t(e,t){try{var a=Array.isArray(e)?e.length:0;if(!a)return{autoSkip:!0,maxRotation:0,minRotation:0};var i=Math.max.apply(Math,[0].concat(n(e.map(function(e){return String(e||"").length}))));return a*Math.max(28,Math.min(90,Math.round(7*i)))>1.2*(t||320)?{autoSkip:!0,maxRotation:45,minRotation:45,callback:function(e){return String(e||"")}}:{autoSkip:!0,maxRotation:0,minRotation:0,callback:function(e){return String(e||"")}}}catch(o){return{autoSkip:!0,maxRotation:0,minRotation:0}}}window.computeTickOptions=t,window.drawFullLine=function(a,i,o){var r=document.getElementById(a);if(r)if(r.width=r.clientWidth||r.width||320,r.height=r.clientHeight||r.height||80,"undefined"!=typeof Chart){var l=String(a),d=t(i,r.width||320);if(e[l]&&e[l].canvas!==r){try{e[l].destroy()}catch(u){}delete e[l]}if(e[l]){var s=e[l];s.data.labels=i,s.data.datasets[0].data=o,s.options.scales.x.ticks=t(i,r.width||320),s.update()}else{var c=r.getContext("2d");e[l]=new Chart(c,{type:"line",data:{labels:i,datasets:[{label:"",data:o,borderColor:"#2e6cff",backgroundColor:"rgba(46,108,255,0.10)",borderWidth:2,tension:.3,pointRadius:3,pointHoverRadius:5,fill:!1}]},options:{responsive:!1,maintainAspectRatio:!1,animation:!1,animations:!1,plugins:{legend:{display:!1}},scales:{x:{grid:{display:!1},ticks:d},y:{beginAtZero:!0}}}})}}else!function(e,t,a){var i=e.getContext("2d");e.width=e.clientWidth||320,e.height=e.clientHeight||80,i.clearRect(0,0,e.width,e.height);var o=Math.max.apply(Math,[1].concat(n(a))),r=a.length>1?(e.width-8)/(a.length-1):0;i.strokeStyle="#2e6cff",i.lineWidth=2,i.beginPath();for(var l=0;l<a.length;l++){var d=4+l*r,s=e.height-6-a[l]/o*(e.height-12);0===l?i.moveTo(d,s):i.lineTo(d,s)}i.stroke(),i.fillStyle="#2e6cff";for(var c=0;c<a.length;c++){var u=4+c*r,p=e.height-6-a[c]/o*(e.height-12);i.beginPath(),i.arc(u,p,2,0,2*Math.PI),i.fill()}}(r,0,o)}}(),t=[],window.onUnifiedRangeChange=function(e){"function"==typeof e&&t.push(e)},window.emitUnifiedRangeChange=function(e){for(var n=0,a=t;n<a.length;n++){var i=a[n];try{i(e)}catch(o){logger.error(o)}}},window.effectivePeriodType=y,window.showOverlay=function(e){var t=function(){var e=document.getElementById("bp-overlay");return e||((e=document.createElement("div")).id="bp-overlay",e.className="hidden",e.setAttribute("role","dialog"),e.setAttribute("aria-modal","true"),e.innerHTML='<div class="bp-overlay-backdrop" id="bp-overlay-backdrop"></div><div class="bp-overlay-panel" id="bp-overlay-panel"></div>',document.body.appendChild(e),document.getElementById("bp-overlay-backdrop").addEventListener("click",hideOverlay)),e}(),n=document.getElementById("bp-overlay-panel");n.innerHTML=e||"",t.classList.remove("hidden");var a=n.querySelector("input, textarea, select, button");a&&setTimeout(function(){try{a.focus()}catch(e){}},0)},window.hideOverlay=function(){var e=document.getElementById("bp-overlay");e&&e.classList.add("hidden")},window.viewGI=window.viewGI||function(){if(!m())return o();document.title="Battle Plan â€“ GI & Scadenzario",i.innerHTML=G()+'\n  <div class="wrap">\n\n    <div class="card">\n      <b>Filtro</b>\n      <div class="row" style="margin-top:6px;align-items:flex-end;gap:16px;flex-wrap:wrap">\n        <div>\n          <label>Consulente</label>\n          <select id="gi_cons"><option value="">Tutti</option></select>\n        </div>\n      </div>\n      '.concat(l("gi"),'\n    </div>\n\n    <div class="card">\n      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">\n        <b>Vendite (GI)</b>\n        <button class="ghost" id="gi_add">Nuova vendita</button>\n      </div>\n      <div class="table" style="overflow:auto">\n        <table class="simple" style="min-width:980px">\n          <thead>\n            <tr>\n              <th>Data vendita</th>\n              <th>Cliente</th>\n              <th>Consulente</th>\n              <th>Servizi</th>\n              <th style="text-align:right">Tot. VSS</th>\n              <th>Piano pagamenti</th>\n              <th></th>\n            </tr>\n          </thead>\n          <tbody id="gi_rows"></tbody>\n        </table>\n      </div>\n    </div>\n\n  </div>'),Y();var t=function(e){return document.getElementById(e)},n=function(e){return String(e||"").replace(/[&<>'"]/g,function(e){return{"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"}[e]})},a=function(e){return(Number(e)||0).toLocaleString("it-IT")+"â‚¬"},d=function(e){var t=new Date(e);return t.getFullYear()+"-"+("0"+(t.getMonth()+1)).slice(-2)+"-"+("0"+t.getDate()).slice(-2)},s=[];function c(e){return'<tr data-id="'+n(String(e.id))+'"><td>'+new Date(e.date||e.createdAt).toLocaleDateString("it-IT")+"</td><td>"+n(e.clientName||"")+"</td><td>"+n(e.consultantName||"")+"</td><td>"+n(e.services||"")+'</td><td style="text-align:right"><b>'+a(e.vssTotal||0)+"</b></td><td>"+function(e){var t=Array.isArray(e.schedule)?e.schedule.slice():[];if(!t.length)return'<span class="muted">â€”</span>';var n=t.find(function(e){return"deposit"===e.kind||/acconto/i.test(e.note||"")}),i=t.filter(function(e){return e!==n}),o=n?"Acconto: "+a(n.amount):"";if(!i.length)return o||'<span class="muted">â€”</span>';var r=Math.round(i[0].amount||0);return(o?o+" + ":"")+(i.every(function(e){return Math.abs(Math.round(e.amount||0)-r)<=1})?i.length+" rate da "+a(r):"piano personalizzato")}(e)+'</td><td class="right"><button class="ghost" data-edit="'+n(String(e.id))+'">Modifica</button></td></tr>'}function u(){var e=function(){var e=window.readUnifiedRange&&window.readUnifiedRange("gi")||{};if(!e||!e.start||!e.end){var t=new Date,n=new Date(t.getFullYear(),0,1),a=new Date(t.getFullYear(),11,31,23,59,59);return{from:d(n),to:d(a)}}return{from:d(e.start),to:d(e.end)}}(),n=(t("gi_cons")||{}).value||"";_("/api/gi"+("?from="+encodeURIComponent(e.from)+"&to="+encodeURIComponent(e.to)+(n?"&userId="+encodeURIComponent(n):""))).then(function(e){var n=e&&e.sales||[];n.sort(function(e,t){return+new Date(t.date||t.createdAt||0)-+new Date(e.date||e.createdAt||0)}),t("gi_rows").innerHTML=n.length?n.map(c).join(""):'<tr><td colspan="7" class="muted">Nessuna vendita</td></tr>',document.querySelectorAll("[data-edit]").forEach(function(e){e.addEventListener("click",function(){v(e.getAttribute("data-edit"))})})}).catch(function(e){logger.error(e),R("Errore caricamento GI")})}function p(i){var o=i.sale||{},l=Array.isArray(o.schedule)?o.schedule.slice():[],c=l.find(function(e){return"deposit"===e.kind||/acconto/i.test(e.note||"")}),p=l.filter(function(e){return e!==c}),v=!(p.length>0)||p.every(function(e){return Math.abs((+e.amount||0)-(+p[0].amount||0))<=1}),m=p.length&&v?"rate":"manual",g=d(new Date),f='<div class="modal"><div class="card gi-modal"><style>.gi-modal{min-width:min(760px,96vw);max-width:980px;max-height:86vh;overflow:auto}@media (max-width:740px){ .gi-grid{display:block} .gi-col{width:100%} .gi-modal{min-width:96vw} }.gi-grid{display:flex; gap:12px; flex-wrap:wrap} .gi-col{flex:1; min-width:240px}.gi-section{border-top:1px solid var(--hair, rgba(0,0,0,.12)); padding-top:10px; margin-top:10px}.pilltabs{display:flex; gap:12px; align-items:center} .pilltabs label{display:flex; align-items:center; gap:6px; cursor:pointer}.mrow{display:flex; gap:8px; align-items:center; flex-wrap:wrap}.mini input[type=number]{width:120px}.gi-rlist{margin-top:6px; max-height:200px; overflow:auto; border:1px dashed rgba(0,0,0,.15); border-radius:8px; padding:6px}.gi-r{display:flex; gap:6px; align-items:center; padding:4px 0}.gi-foot{display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:12px}</style><div style="display:flex;justify-content:space-between;align-items:center"><b>'+(i.title||(o.id?"Modifica vendita":"Nuova vendita"))+'</b><button class="ghost" id="m_close">Chiudi</button></div><div class="gi-grid"><div class="gi-col"><label>Data</label><input id="m_date" type="date" value="'+n(d(o.date||g))+'"></div><div class="gi-col"><label>Cliente</label><select id="gi_client_select"><option value="">Caricamentoâ€¦</option></select></div><div class="gi-col"><label>Totale VSS</label><input id="m_vss" type="number" step="1" value="'+n(Number(o.vssTotal||0))+'"></div></div><div class="gi-section"><label>Servizi</label><textarea id="m_srv" rows="2">'+n(o.services||"")+'</textarea></div><div class="gi-section"><b>Acconto</b><div class="mrow mini" style="margin-top:6px"><label><input id="acc_enable" type="checkbox" '+(c?"checked":"")+'> Abilita</label><label>Tipo</label><select id="acc_type"><option value="abs">Valore assoluto</option><option value="perc">Percentuale</option></select><label>Valore</label><input id="acc_value" type="number" step="1" value="'+(c?n(Number(c._fromPerc?c._rawPerc:c.amount)):"0")+'"><label>Scadenza</label><input id="acc_date" type="date" value="'+n(d(c?c.dueDate:o.date||g))+'"><label>Nota</label><input id="acc_note" placeholder="es. Acconto" value="'+n(c&&c.note||"Acconto")+'"></div></div><div class="gi-section"><b>ModalitÃ  pagamenti</b><div class="pilltabs" style="margin:6px 0 8px"><label><input type="radio" name="pmode" value="rate" '+("rate"===m?"checked":"")+'> Rateale</label><label><input type="radio" name="pmode" value="manual" '+("rate"!==m?"checked":"")+'> Scaglioni manuali</label></div><div id="p_rate" style="display:'+("rate"===m?"block":"none")+'"><div class="mrow mini"><label>NÂ° rate</label><input id="rt_n" type="number" value="'+n(p.length||12)+'"><label>Frequenza</label><select id="rt_freq"><option value="M">Mensile</option><option value="Q">Trimestrale</option><option value="W">Settimanale</option><option value="Y">Annuale</option></select><label>Prima scadenza</label><input id="rt_first" type="date" value="'+n(p[0]?d(p[0].dueDate):d(o.date||g))+'"><button class="ghost" id="rt_build">Ricalcola rate</button></div><div id="rt_preview" class="gi-rlist muted small">â€”</div></div><div id="p_manual" style="display:'+("rate"!==m?"block":"none")+'"><div class="mrow mini"><button class="ghost" id="mn_add">Aggiungi scaglione</button></div><div id="mn_list" class="gi-rlist"></div></div></div><div class="gi-foot"><div><div id="tot_prog" class="small muted">Programmato: 0â‚¬</div><div id="tot_chk"  class="small muted">Totale VSS: 0â‚¬</div></div><div style="display:flex;gap:8px">'+(o.id?'<button class="ghost danger" id="m_del">Elimina</button>':"")+'<button id="m_save">Salva</button></div></div></div></div>';showOverlay(f);var b=document.documentElement.style.overflow;function y(){document.documentElement.style.overflow=b,hideOverlay()}function h(e,t){var n=new Date(e);return n.setMonth(n.getMonth()+t),n}function w(e,t){var n=new Date(e);return n.setDate(n.getDate()+7*t),n}function _(e,t){var n=new Date(e);return n.setMonth(n.getMonth()+3*t),n}function I(e,t){var n=new Date(e);return n.setFullYear(n.getFullYear()+t),n}function S(){for(var e=Math.max(1,Number(t("rt_n").value||0)),n=t("rt_freq").value,a=new Date(t("rt_first").value||g),i=Math.max(0,Number(t("m_vss").value||0)),o=T(),r=Math.max(0,i-o),l=Math.round(r/e),d=[],s=0;s<e;s++){var c=void 0;c="M"===n?h(a,s):"Q"===n?_(a,s):"W"===n?w(a,s):I(a,s),d.push({dueDate:c.toISOString(),amount:l,note:"Rata "+(s+1)+"/"+e,kind:"installment"})}return E(d),d}function E(e){t("rt_preview").innerHTML=e.map(function(e){return"<div>"+new Date(e.dueDate).toLocaleDateString("it-IT")+" Â· "+a(e.amount)+' <span class="muted">'+n(e.note||"")+"</span></div>"}).join(""),t("rt_preview")._data=e,C()}function D(e){var a=t("mn_list");a.innerHTML="",e.forEach(function(e,t){var i=document.createElement("div");i.className="gi-r",i.innerHTML='<input type="date" data-k="dueDate" value="'+n(d(e.dueDate))+'"><input type="number" step="1" data-k="amount" value="'+n(Number(e.amount||0))+'" style="width:120px"><input type="text" data-k="note"   value="'+n(e.note||"")+'" placeholder="nota" style="flex:1"><button class="ghost" data-del="'+t+'">âœ•</button>',a.appendChild(i)}),a.querySelectorAll("[data-del]").forEach(function(e){e.onclick=function(){var t=Number(e.getAttribute("data-del")),n=a._data||[];n.splice(t,1),D(n)}}),a.oninput=function(){var e=a._data||[];Array.from(a.children).forEach(function(t,n){var a=e[n];if(a){var i=t.querySelector('[data-k="dueDate"]').value,o=Number(t.querySelector('[data-k="amount"]').value||0),r=t.querySelector('[data-k="note"]').value;a.dueDate=new Date(i).toISOString(),a.amount=Math.round(o),a.note=r}}),C()},a._data=e,C()}if(document.documentElement.style.overflow="hidden",function(){var e=t("gi_client_select");e.innerHTML='<option value="">â€” seleziona cliente â€”</option>'+s.map(function(e){return'<option value="'+n(e.id)+'">'+n(e.name)+"</option>"}).join("");var a=o.clientId||o.client_id||"";if(a&&(e.value=String(a)),!e.value&&o.clientName){var i=s.find(function(e){return String(e.name).trim().toLowerCase()===String(o.clientName).trim().toLowerCase()});i&&(e.value=String(i.id))}}(),c&&c._fromPerc&&(t("acc_type").value="perc"),Array.from(document.querySelectorAll('input[name="pmode"]')).forEach(function(e){e.addEventListener("change",function(){var e="rate"===document.querySelector('input[name="pmode"]:checked').value;t("p_rate").style.display=e?"block":"none",t("p_manual").style.display=e?"none":"block",C()})}),t("m_date").value=n(d(o.date||g)),t("m_vss").value=n(Number(o.vssTotal||0)),t("m_srv").value=n(o.services||""),t("acc_type").value=c&&c._fromPerc?"perc":"abs",t("acc_value").value=c?c._fromPerc?c._rawPerc:c.amount:0,t("acc_date").value=n(d(c?c.dueDate:o.date||g)),t("acc_note").value=c?n(c.note||"Acconto"):"Acconto","rate"===m){var B=p.length||12;t("rt_n").value=B,t("rt_first").value=p[0]?n(d(p[0].dueDate)):n(d(o.date||g)),E(p.length?p:S())}else D(p);function T(){if(!t("acc_enable").checked)return 0;var e=Math.max(0,Number(t("m_vss").value||0)),n=t("acc_type").value,a=Number(t("acc_value").value||0);return Math.round("perc"===n?e*(a/100):a)}function P(){var e=[];if(t("acc_enable").checked){var n=T();e.push({dueDate:new Date(t("acc_date").value||g).toISOString(),amount:n,note:t("acc_note").value||"Acconto",kind:"deposit",_fromPerc:"perc"===t("acc_type").value,_rawPerc:Number(t("acc_value").value||0)})}if("rate"===document.querySelector('input[name="pmode"]:checked').value){var a=(t("rt_preview")._data||[]).map(function(e){return Object.assign({},e)});return e.concat(a)}var i=(t("mn_list")._data||[]).map(function(e){return Object.assign({kind:"manual"},e)});return e.concat(i)}function C(){var e=Math.max(0,Number(t("m_vss").value||0)),n=P(),i=Math.round(n.reduce(function(e,t){return e+Number(t.amount||0)},0));t("tot_prog").textContent="Programmato: "+a(i),t("tot_chk").textContent="Totale VSS: "+a(e)+(i===e?" OK":" (manca "+a(e-i)+")"),t("m_save").disabled=i!==e||!t("gi_client_select").value}if(t("rt_build").onclick=function(){return E(S())},t("mn_add").onclick=function(){var e=t("mn_list")._data||[];e.push({dueDate:(new Date).toISOString(),amount:0,note:"",kind:"manual"}),D(e)},t("m_close").onclick=y,["m_vss","acc_enable","acc_type","acc_value","acc_date","rt_n","rt_freq","rt_first"].forEach(function(e){var n=t(e);n&&n.addEventListener("input",C)}),t("gi_client_select").addEventListener("change",C),C(),t("m_save").onclick=function(){var e=t("gi_client_select").value||"",n=s.find(function(t){return String(t.id)===String(e)});if(n){var a={id:o.id||void 0,date:new Date(t("m_date").value||g).toISOString(),clientId:n.id,clientName:n.name,vssTotal:Math.round(Number(t("m_vss").value||0)),services:t("m_srv").value||"",schedule:P()};Promise.resolve(x("/api/gi",a)).then(function(){y(),haptic("light"),u()}).catch(function(e){logger.error(e),R("Errore salvataggio")})}else R("Seleziona un cliente")},o.id){var k=t("m_del");k&&(k.onclick=r(e().m(function t(){var n;return e().w(function(e){for(;;)switch(e.p=e.n){case 0:if(confirm("Eliminare definitivamente questa vendita?")){e.n=1;break}return e.a(2);case 1:return e.p=1,e.n=2,x("/api/gi/delete",{id:o.id}).catch(function(){return x("/api/gi",{id:o.id,_delete:1})});case 2:y(),R("Vendita eliminata"),u(),e.n=4;break;case 3:e.p=3,n=e.v,logger.error(n),R("Errore eliminazione");case 4:return e.a(2)}},t,null,[[1,3]])})))}}function v(e){_("/api/gi?from=1900-01-01&to=2999-12-31").then(function(t){var n=(t&&t.sales||[]).find(function(t){return String(t.id)===String(e)});n?p({title:"Modifica vendita",sale:n}):R("Vendita non trovata")})}document.addEventListener("gi:edit",function(e){var t=e&&e.detail&&e.detail.id;t&&v(t)}),t("gi_add").onclick=function(){p({title:"Nuova vendita"})},f("gi",function(){haptic("light"),u()}),(t("gi_cons")||{}).onchange=function(){haptic("light"),u()},_("/api/clients").then(function(e){return s=e&&e.clients||[],_("/api/usernames")}).then(function(e){var a=e&&e.users||[],i=t("gi_cons");i&&(i.innerHTML='<option value="">Tutti</option>'+a.map(function(e){return'<option value="'+n(String(e.id))+'">'+n(e.name)+"</option>"}).join(""))}).then(u)},window.viewHome=q,window.viewCalendar=function(){if(!m())return o();function e(e){return D(e)}if(document.title="Battle Plan â€“ Calendario",!document.getElementById("cal_dynamic_css")){var t=document.createElement("style");t.id="cal_dynamic_css",t.textContent="\n      /* ============== CALENDAR ============== */\n      #cal_container{ overflow-x:auto; -webkit-overflow-scrolling:touch; }\n      #cal_container .calendar{ min-width: 860px; }\n\n      .calendar{ display:grid; grid-template-columns: 44px repeat(7, 1fr); gap:10px; }\n      .calendar .weekLabel{ color:var(--muted); font-size:12px; display:flex; align-items:center; justify-content:center; }\n\n      .calendar .day{\n        min-height:120px; background: var(--card);\n        border:2px solid var(--hair2); border-radius:14px; padding:8px;\n        display:flex; flex-direction:column; gap:3px; overflow:hidden;\n      }\n      .calendar .day.today{\n        outline: 2px solid var(--accent);\n        box-shadow: 0 0 0 2px rgba(0,0,0,.06) inset;\n      }\n      .calendar .day .dnum{ font-weight:800; }\n      .calendar .day .small{\n        font-size:12px; line-height:1.15;\n        white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:100%;\n      }\n      .calendar .day .tag{ padding:2px 6px; border-radius:999px; border:1px solid var(--hair2); font-size:11px; align-self:flex-start; }\n      .calendar .day.busy0{ border-color:#27ae60; background:rgba(39,174,96,.08); }\n      .calendar .day.busy1{ border-color:#ff9f1a; background:rgba(255,159,26,.10); }\n      .calendar .day.busy2{ border-color:#7d1731; background:rgba(125,23,49,.12); }\n      .calendar .day.dense .small{ font-size:11px; line-height:1.1; }\n      .calendar .day.dense .tag{ transform:scale(.9); transform-origin:left top; }\n\n      @media (max-width: 900px){\n        .calendar{ grid-template-columns: 36px repeat(7, 1fr); }\n        .calendar .weekLabel{ display:flex !important; font-size:11px; }\n        .calendar .day{ min-height:92px; padding:6px; }\n        .calendar .day .dnum{ font-size:16px; }\n        .calendar .day .small{ white-space: normal !important; overflow: visible !important; text-overflow: clip !important; }\n        .calendar .day.dense .small{ font-size:clamp(9px,2.4vw,11px); }\n        .calendar .day .tag{ font-size:10px; }\n      }\n\n      .cal-filters .chip{\n        display:inline-flex; align-items:center; gap:6px;\n        padding:6px 10px; border-radius:999px; border:1px solid var(--hair2);\n      }\n    ",document.head.appendChild(t)}var n=E(B(new Date)).slice(0,7);function a(){var t=document.getElementById("cal_month").value;!function(t,n,a){Promise.all([_("/api/appointments"),_("/api/availability?from="+t+"-"+I(n)+"-01&to="+t+"-"+I(n)+"-"+I(new Date(t,n,0).getDate()))]).then(function(i){var o=i[0]&&i[0].appointments?i[0].appointments:[],r=(i[1]||{slots:[]}).slots||[],l=new Date(t,n-1,1),d=new Date(t,n,0,23,59,59,999);function s(e,t){for(var n={vss:0,vsd:0,vsdI:0,telefonate:0,appFissati:0,nncf:0,count:0},a=0;a<o.length;a++){var i=o[a],r=new Date(i.start);r>=e&&r<=t&&(n.vss+=Number(i.vss||0),n.vsd+=Number(i.vsdPersonal||0),n.vsdI+=Number(i.vsdIndiretto||0),n.telefonate+=Number(i.telefonate||0),n.appFissati+=Number(i.appFissati||0),n.nncf+=i.nncf?1:0,n.count+=1)}return n}function u(e,t,n){var a=document.getElementById("cal_results");if(a){var i=n?'<div class="right"><button id="res_reset" class="ghost">Torna al mese</button></div>':"";if(a.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center"><b>Risultati Â· '+t+"</b>"+i+'</div><div class="row" style="margin-top:8px;gap:8px;flex-wrap:wrap"><span class="chip small">VSS <b>'+H(e.vss)+'</b></span><span class="chip small">VSD <b>'+H(e.vsd)+'</b></span><span class="chip small">VSD ind <b>'+H(e.vsdI)+'</b></span><span class="chip small">Tel <b>'+z(e.telefonate)+'</b></span><span class="chip small">AppFiss <b>'+z(e.appFissati)+'</b></span><span class="chip small">NNCF <b>'+z(e.nncf)+'</b></span><span class="chip small">N. app <b>'+z(e.count)+"</b></span></div>",a.style.display="block",n){var o=document.getElementById("res_reset");o&&(o.onclick=function(){u(s(l,d),b,!1)})}}}for(var p={},v=0;v<o.length;v++){var m=o[v];if(!((X=new Date(m.start))<l||X>d)){var g=E(X);p[g]||(p[g]={vss:0,vsd:0,vsdI:0,telefonate:0,appFissati:0,nncf:0,mins:0,count:0,items:[]}),p[g].vss+=Number(m.vss||0),p[g].vsd+=Number(m.vsdPersonal||0),p[g].vsdI+=Number(m.vsdIndiretto||0),p[g].telefonate+=Number(m.telefonate||0),p[g].appFissati+=Number(m.appFissati||0),p[g].nncf+=m.nncf?1:0,p[g].mins+=Number(m.durationMinutes||0),p[g].count+=1,p[g].items.push(m)}}var f=["Lun","Mar","Mer","Gio","Ven","Sab","Dom"],b=new Date(t,n-1,1).toLocaleString("it-IT",{month:"long",year:"numeric"}),y='<div class="card"><b class="neon">'+b+"</b></div>";y+='<div class="calendar">',y+='<div class="weekLabel">W</div>';for(var h=0;h<7;h++)y+='<div class="weekLabel">'+f[h]+"</div>";var w=new Date(t,n-1,1),_=(w.getDay()+6)%7,x=new Date(w);x.setDate(w.getDate()-_);for(var D=0;D<6;D++){var B=new Date(x),T="W"+P(B);y+='<div class="weekLabel" data-ws="'+E(B)+'" style="cursor:pointer">'+T+"</div>";for(var C=0;C<7;C++){var k=x.getMonth()===n-1,M=(g=E(x),p[g]||{vss:0,vsd:0,vsdI:0,telefonate:0,appFissati:0,nncf:0,mins:0,count:0,items:[]}),A=x.getDay(),N=0===A||6===A,L=!N&&r.some(function(e){return e.date===g});if(k&&a){if(a.only_free&&M.count>0){y+="<div></div>",x.setDate(x.getDate()+1);continue}if(a.only_4h&&!L){y+="<div></div>",x.setDate(x.getDate()+1);continue}}if(k){var F="";N?M.count>0&&(F="busy2"):F=0===M.count?"busy0":L?"busy1":"busy2";var V="",O=0;N&&0===M.count||(M.vss>0&&(V+='<div class="small">VSS '+H(M.vss)+"</div>",O++),M.vsd>0&&(V+='<div class="small">VSD '+H(M.vsd)+"</div>",O++),M.vsdI>0&&(V+='<div class="small">VSD ind '+H(M.vsdI)+"</div>",O++),M.telefonate>0&&(V+='<div class="small">Tel '+z(M.telefonate)+"</div>",O++),M.appFissati>0&&(V+='<div class="small">AppFiss '+z(M.appFissati)+"</div>",O++),M.nncf>0&&(V+='<div class="small">NNCF '+z(M.nncf)+"</div>",O++),M.count>0&&(V+='<div class="small">App. '+z(M.count)+"</div>",O++),L&&(V+='<div class="tag" style="margin-top:4px">slot â‰¥4h</div>',O++)),y+='<div class="day '+F+(O>=3?" dense":"")+(L?" slot-free":"")+'" data-day="'+g+'" title="Settimana '+P(x)+'"><div class="dnum">'+x.getDate()+"</div>"+(V||"")+"</div>"}else y+="<div></div>";x.setDate(x.getDate()+1)}}y+="</div>",document.getElementById("cal_container").innerHTML=y,u(s(l,d),b,!1),document.querySelectorAll(".calendar .weekLabel[data-ws]").forEach(function(e){e.addEventListener("click",function(){var t=e.getAttribute("data-ws"),n=new Date(t),a=new Date(n);a.setDate(a.getDate()+6),a.setHours(23,59,59,999);var i="Settimana W"+P(n)+" Â· "+S(n)+"â€“"+S(a);u(s(n,a),i,!0)})}),document.querySelectorAll(".day[data-day]").forEach(function(t){t.addEventListener("click",function(){var n=t.getAttribute("data-day"),a=p[n]&&p[n].items?p[n].items.slice():[];a.sort(function(e,t){return new Date(e.start)-new Date(t.start)});var i=document.getElementById("cal_day_box"),o="<b>Appuntamenti del "+n.split("-").reverse().join("/")+"</b>";if(a.length){o+='<div class="row" style="margin-top:8px">';for(var l=0;l<a.length;l++){var d,s=a[l],u=' data-start="'+s.start+'" data-end="'+s.end+'" data-title="'+j(s.client||"Appuntamento")+'" ',v=String(s.type||"").toLowerCase();d=v.indexOf("mbs")>-1?"VSD ind "+H(s.vsdIndiretto||0):v.indexOf("sottoprod")>-1?"Tel "+z(s.telefonate||0)+" Â· AppFissati "+z(s.appFissati||0):v.indexOf("formaz")>-1?"":"VSS "+H(s.vss)+" Â· VSD "+H(s.vsdPersonal)+" Â· NNCF "+(s.nncf?"âœ…":"â€”"),o+='<div class="card cal-app" data-aid="'+s.id+'" '+u+' style="flex:1 1 320px;cursor:pointer"><div class="small muted">'+e(s.start)+"â€“"+e(s.end)+" Â· "+j(s.type||"")+"</div><div><b>"+j(s.client||"")+"</b></div>"+(d?'<div class="small">'+d+"</div>":"")+(s.notes?'<div class="small muted">'+j(s.notes)+"</div>":"")+"</div>"}o+="</div>"}else o+='<div class="muted" style="margin-top:6px">Nessun appuntamento</div>';var m=(r||[]).filter(function(e){return e.date===n});if(m.length){o+='<div class="row" style="margin-top:8px">';for(var g=0;g<m.length;g++){var f=m[g],b="morning"===f.part?"mattina":"pomeriggio";o+='<div class="card slotBtn" data-start="'+f.start+'" data-end="'+f.end+'" style="flex:1 1 280px;cursor:pointer"><div class="small">'+b+" Â· "+e(f.start)+"â€“"+e(f.end)+"</div></div>"}o+="</div>"}if(i.style.display="block",i.innerHTML=o,i.querySelectorAll(".cal-app").forEach(function(e){e.addEventListener("click",function(t){t.stopPropagation(),c("bp_edit_aid",e.getAttribute("data-aid")),Q()})}),i.querySelectorAll(".slotBtn").forEach(function(e){e.addEventListener("click",function(t){t.stopPropagation(),c("bp_prefill_slot",{start:e.getAttribute("data-start"),end:e.getAttribute("data-end")}),Q(),R("Slot precompilato negli appuntamenti")})}),window.scrollTo({top:i.getBoundingClientRect().top+window.scrollY-80,behavior:"smooth"}),"function"==typeof window.wireICSInsideDayBox)try{window.wireICSInsideDayBox()}catch(y){}})});var U=document.getElementById("cal_free_slots"),G=function(){var e=new Date;return e.getFullYear()+"-"+I(e.getMonth()+1)+"-"+I(e.getDate())}(),Y=(r||[]).filter(function(e){return String(e.date||"").slice(0,10)>=G});if(Y.length){var q='<b>Slot liberi â‰¥ 4h (da oggi in poi)</b> Â· <span class="badge">Tot: '+Y.length+"</span>";q+='<div class="row" style="margin-top:8px">';for(var W=0;W<Y.length&&W<80;W++){var X,$="morning"===(X=Y[W]).part?"mattina":"pomeriggio";q+='<div class="card slotBtn" data-start="'+X.start+'" data-end="'+X.end+'" style="flex:1 1 280px;cursor:pointer"><div class="small"><b>'+S(X.start)+"</b> Â· "+$+'</div><div class="small">'+e(X.start)+"â€“"+e(X.end)+"</div></div>"}q+="</div>",U.style.display="block",U.innerHTML=q,U.querySelectorAll(".slotBtn").forEach(function(e){e.addEventListener("click",function(){c("bp_prefill_slot",{start:e.getAttribute("data-start"),end:e.getAttribute("data-end")}),Q(),R("Slot precompilato negli appuntamenti")})})}else U.style.display="block",U.innerHTML='<b>Slot liberi â‰¥ 4h (da oggi in poi)</b> Â· <span class="badge">Tot: 0</span><div class="muted" style="margin-top:6px">Nessuno slot libero disponibile.</div>';try{window.injectTodayCSS&&window.injectTodayCSS()}catch(Z){}try{window.hookCalendar?window.hookCalendar():(window.markToday&&window.markToday(),window.clampSlotCounters&&window.clampSlotCounters())}catch(Z){}}).catch(function(e){logger.error(e),R("Errore calendario")})}(parseInt(t.split("-")[0],10),parseInt(t.split("-")[1],10),{only_free:document.getElementById("only_free").checked,only_4h:document.getElementById("only_4h").checked})}i.innerHTML=G()+'<div class="wrap"><div class="card"><div class="row" style="align-items:flex-end;gap:12px;flex-wrap:wrap"><div class="row" style="align-items:flex-end;gap:8px"><button id="cal_prev" class="ghost" title="Mese precedente">â—€</button><div><label>Mese</label><input type="month" id="cal_month" value="'+n+'"></div><button id="cal_next" class="ghost" title="Mese successivo">â–¶</button></div><div class="cal-filters"><label class="chip small"><input type="checkbox" id="only_free"> Solo giorni liberi</label> <label class="chip small"><input type="checkbox" id="only_4h"> Solo slot â‰¥ 4h</label></div><button id="cal_add" class="ghost">Aggiungi appuntamento</button><div class="right" style="margin-left:auto"><button id="cal_refresh" class="ghost">Aggiorna</button></div></div></div><div id="cal_container"></div><div id="cal_results" class="card" style="margin-top:8px;display:none"></div><div id="cal_day_box" class="card" style="margin-top:8px;display:none"></div><div class="card" id="cal_free_slots" style="margin-top:8px;display:none"></div></div>',Y(),document.getElementById("cal_refresh").onclick=a;var r=document.getElementById("cal_add");function l(e){var t=document.getElementById("cal_month");if(t){var n=t.value.split("-"),i=+n[0],o=+n[1];(o+=e)<=0?(o=12,i--):o>12&&(o=1,i++),t.value=i+"-"+I(o),a()}}r&&(r.onclick=function(){Q()}),document.getElementById("cal_month").onchange=a;var d=document.getElementById("cal_prev"),s=document.getElementById("cal_next");d&&(d.onclick=function(){l(-1)}),s&&(s.onclick=function(){l(1)}),document.getElementById("only_free").onchange=a,document.getElementById("only_4h").onchange=a,a()},window.viewPeriods=X,window.viewAppointments=Q,window.viewLeaderboard=function(){if(!m())return o();function e(e){if(!e)return"";var t=new Date(e);return t.getFullYear()+"-"+("0"+(t.getMonth()+1)).slice(-2)+"-"+("0"+t.getDate()).slice(-2)}function t(){var t,i,o,l,s,c=document.getElementById("lb_tab").value,u=(i=b("lb"),o=e(i.start),l=e(i.end),s="ytd"===(t=i.type||"mensile")||"ltm"===t?"mensile":t,"&from="+encodeURIComponent(o)+"&to="+encodeURIComponent(l)+"&type="+encodeURIComponent(s)),p=document.getElementById("lb_mode").value;if("overall"===c)_("/api/leaderboard_overall?mode="+encodeURIComponent(p)+u).then(d);else{var v=document.getElementById("lb_indicator").value;_("/api/leaderboard?indicator="+encodeURIComponent(v)+"&mode="+encodeURIComponent(p)+u).then(function(e){!function(e,t){document.getElementById("lb_title").textContent="Classifica â€“ "+t;var i=e.ranking||[];if(a(i),!i.length)return void(document.getElementById("lb_table").innerHTML='<div class="muted">Nessun dato</div>');for(var o='<div class="row">',l=i[0].total||1,d=0;d<i.length;d++){var s=i[d];o+=r(n(d)+" "+s.name,"Totale: "+z(s.total),s.total/l*100)}o+="</div>",document.getElementById("lb_table").innerHTML=o}(e,v)})}}function n(e){return 0===e?"ðŸ¥‡":1===e?"ðŸ¥ˆ":2===e?"ðŸ¥‰":e+1+"."}function a(e){var t=document.getElementById("lb_podium");if(e&&e.length){for(var a=e.slice(0,3),i='<div class="row" style="align-items:flex-end">',o=0;o<a.length;o++){i+='<div class="card" style="flex:1 1 120px;height:'+(80-15*o)+'px;display:flex;align-items:flex-end;justify-content:center"><div>'+j(n(o)+" "+a[o].name)+"</div></div>"}i+="</div>",t.innerHTML=i}else t.innerHTML=""}function r(e,t,n){var a=Math.min(100,Math.max(0,Math.round(n)));return'<div class="card lb-card" style="flex:1 1 280px"><div class="big">'+j(e)+'</div><div class="small muted">'+j(t)+'</div><div class="lb-bar"><div style="width:'+a+'%"></div></div></div>'}function d(e){document.getElementById("lb_title").textContent="Classifica generale";var t=e.ranking||[];if(a(t),t.length){for(var i=t[0].score||0,o='<div class="row">',l=0;l<t.length;l++){var d=t[l];o+=r(n(l)+" "+d.name,"Score: "+z(d.score)+"/100",i?d.score/i*100:0)}o+="</div>",document.getElementById("lb_table").innerHTML=o}else document.getElementById("lb_table").innerHTML='<div class="muted">Nessun dato</div>'}document.title="Battle Plan â€“ Classifiche",i.innerHTML=G()+'<div class="wrap"><div class="card"><div class="row"><div><label>Vista</label><select id="lb_tab"><option value="per_indicator">Per indicatore</option><option value="overall">Generale (score)</option></select></div><div><label>ModalitÃ </label><select id="lb_mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div><div id="lb_ind_wrap"><label>Indicatore</label><select id="lb_indicator"><option value="VSS">VSS</option><option value="VSDPersonale">VSD</option><option value="GI">GI</option><option value="NNCF">NNCF</option></select></div></div>'+l("lb")+'</div><div class="card"><b id="lb_title">Classifica</b><div id="lb_podium" style="margin:10px 0"></div><div id="lb_table"></div></div></div>',Y(),document.getElementById("lb_tab").onchange=function(){var e=this.value;document.getElementById("lb_ind_wrap").style.display="per_indicator"===e?"":"none",t()},f("lb",t),document.getElementById("lb_mode").onchange=t,document.getElementById("lb_indicator").onchange=t,t()},window.viewClients=function(){if(!m())return o();function e(){_("/api/clients").then(function(t){var n=t&&t.clients||[],a=document.getElementById("cl_f_state").value,i=document.getElementById("cl_f_cons").value;function o(e){return String(e||"").trim().toLowerCase()}var r=n.filter(function(e){return(!a||o(e.status)===o(a))&&(!i||String(e.consultantId||"")===String(i))}).map(function(e){var t=j(e.name||""),n=j(e.status||"potenziale"),a=e.consultantName?j(e.consultantName):"unknown",i=String(e.id||"");return'<div class="card" data-clid="'+i+'" data-name-lower="'+t.toLowerCase()+'" data-status="'+n+'" data-consultant-id="'+j(String(e.consultantId||""))+'" style="flex:1 1 380px"><div><b>'+t+'</b></div><div class="small">Stato: <b class="cl-status">'+n+'</b></div><div class="small">Consulente: <b class="cl-cons">'+a+'</b></div><div class="small muted">Ultimo appuntamento: <span class="last-appt">â€”</span></div><div class="right" style="margin-top:6px"><button class="ghost" data-del="'+i+'">Rimuovi</button></div></div>'}).join("");document.getElementById("cl_list").innerHTML=r||'<div class="muted">Nessun cliente</div>',document.querySelectorAll("[data-del]").forEach(function(t){t.addEventListener("click",function(){var n=t.getAttribute("data-del");confirm("Rimuovere il cliente?")&&fetch("/api/clients?id="+encodeURIComponent(n),{method:"DELETE",headers:{Authorization:"Bearer "+v()}}).then(function(e){if(!e.ok)throw new Error("HTTP "+e.status);return e.json()}).then(function(){R("Cliente rimosso"),e()}).catch(function(e){logger.error(e),R("Errore rimozione")})})}),window.BPFinal&&"function"==typeof BPFinal.ensureClientSection?BPFinal.ensureClientSection():setTimeout(function(){var e=document.getElementById("cl_list"),t=Array.from(e.children).filter(function(e){return e.classList.contains("card")});t.sort(function(e,t){return String(e.getAttribute("data-name-lower")||"").localeCompare(String(t.getAttribute("data-name-lower")||""))});var n,a=s(t);try{for(a.s();!(n=a.n()).done;){var i=n.value;e.appendChild(i)}}catch(o){a.e(o)}finally{a.f()}},0)})}document.title="Battle Plan â€“ Clienti",i.innerHTML=G()+'<div class="wrap"><div class="card"><b>Nuovo cliente</b><div class="row" style="margin-top:8px"><div><label>Ragione sociale</label><input id="cl_name" type="text" placeholder="Es. Rossi S.r.l."></div><div><label>Stato</label><select id="cl_new_state"><option value="potenziale">Potenziale</option><option value="lead non chiuso">Lead non chiuso</option><option value="attivo">Attivo</option></select></div><div><label>Consulente</label><select id="cl_new_owner"><option value="">â€”</option></select></div><div class="right"><button id="cl_add">Aggiungi</button></div></div></div><div class="card"><b>Filtri elenco</b><div class="row" style="margin-top:8px"><div><label>Stato</label><select id="cl_f_state"><option value="">Tutti</option><option value="attivo">Attivo</option><option value="lead non chiuso">Lead non chiuso</option><option value="potenziale">Potenziale</option></select></div><div><label>Consulente</label><select id="cl_f_cons"><option value="">Tutti</option></select></div><div><label>Ordina per</label><select id="cl_order"><option value="az">Ragione sociale (Aâ†’Z)</option><option value="last_desc">Ultimo appuntamento (recenti prima)</option></select></div><div class="right"><button class="ghost" id="cl_f_apply">Applica</button></div></div></div><div class="card"><b>Elenco clienti</b><div id="cl_list" class="row" style="margin-top:8px"></div></div></div>',Y(),document.getElementById("cl_add").onclick=function(){var t=(document.getElementById("cl_name").value||"").trim();if(t){var n=document.getElementById("cl_new_state"),a=document.getElementById("cl_new_owner"),i={name:t};n&&(i.status=n.value),a&&a.value&&(i.consultantId=a.value),x("/api/clients",i).then(function(){document.getElementById("cl_name").value="",e(),U(),window.addXP(5)}).catch(function(e){logger.error(e),R("Errore creazione cliente")})}else R("Nome obbligatorio")},document.getElementById("cl_f_apply").onclick=e,_("/api/usernames").then(function(e){var t=e&&e.users||[],n=document.getElementById("cl_f_cons"),a=document.getElementById("cl_new_owner");n&&(n.innerHTML='<option value="">Tutti</option>'+t.map(function(e){return'<option value="'+e.id+'">'+j(e.name)+(e.grade?" ("+e.grade+")":"")+"</option>"}).join("")),a&&(a.innerHTML='<option value="">â€”</option>'+t.map(function(e){return'<option value="'+e.id+'">'+j(e.name)+(e.grade?" ("+e.grade+")":"")+"</option>"}).join(""))}).catch(function(e){logger.error(e)}),e(),"function"==typeof kickFinal&&kickFinal("clients")},window.viewTeam=function(){if(!m())return o();document.title="Battle Plan â€“ Squadra";var e=G()+'<div class="wrap"><div class="card"><b>Vista Amministratore</b><div id="t_adminbar" class="row" style="margin-top:8px;display:flex;align-items:flex-end;gap:16px;flex-wrap:wrap"><div><label>ModalitÃ </label><select id="t_mode" name="mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div><div id="t_unified_wrap">'+l("t")+'</div></div></div><div class="card"><b>Riepilogo per utente</b><div id="t_users" class="row" style="margin-top:8px"></div></div><div class="card"><b>Aggregato Squadra</b><div id="t_agg" class="row" style="margin-top:8px"></div><div class="row" style="margin-top:12px;align-items:flex-end;gap:16px;flex-wrap:wrap"><div><label>Indicatore grafico</label><select id="t_ind"><option value="VSS">VSS</option><option value="VSDPersonale">VSD Personale</option><option value="VSDIndiretto">VSD Indiretto</option><option value="VSDTotale">VSD Totale</option><option value="GI">GI</option><option value="NNCF">NNCF</option><option value="provv_gi">Provv GI</option><option value="provv_vsd">Provv VSD</option><option value="tot_provv" selected>Tot Provvigioni</option></select></div><div><label>Consulente</label><select id="t_cons"><option value="">Tutti</option></select></div></div><div style="margin-top:8px"><canvas id="t_chart" height="160"></canvas></div></div></div>';function t(e){return e=Number(e||0),isFinite(e)?e:0}function a(e){if(!e)return"";var t=new Date(e);return t.getFullYear()+"-"+("0"+(t.getMonth()+1)).slice(-2)+"-"+("0"+t.getDate()).slice(-2)}function r(){var e,t=b("t"),n=a(t.start),i=a(t.end),o=(e=t.type,0===(e=String(e||"mensile").toLowerCase()).indexOf("sett")?"settimanale":0===e.indexOf("mes")?"mensile":0===e.indexOf("tri")?"trimestrale":0===e.indexOf("sem")?"semestrale":0===e.indexOf("ann")?"annuale":"mensile");return"&from="+encodeURIComponent(n)+"&to="+encodeURIComponent(i)+"&type="+encodeURIComponent(o)}function d(e){switch(String(e)){case"provv_gi":return"ProvvGI";case"provv_vsd":return"ProvvVSD";case"tot_provv":return"TotProvvigioni";default:return e}}function s(e){return(Number(e)||0).toLocaleString("it-IT")+"â‚¬"}function c(e){var t=Number(e)||0;return String(Math.round(t))}function u(e){return String(e).replace(/[&<>'"]/g,function(e){return{"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"}[e]})}i.innerHTML=e,Y(),function(){var e=document.getElementById("t_adminbar"),t=document.getElementById("t_unified_wrap");if(e&&t){var n=t.querySelector(".row");n&&(Array.from(n.children).forEach(function(t){t.classList.remove("right"),t.style.marginTop="0",e.appendChild(t)}),t.remove())}}();var p=null;function v(e,t){var a=document.getElementById("t_chart");if(a){var i=x(t),o=w(t,i),r=e.map(function(e){return e.y});if("undefined"==typeof Chart){var l=a.getContext("2d");a.width=a.clientWidth||600,a.height=a.clientHeight||160,l.clearRect(0,0,a.width,a.height);var d=Math.max.apply(Math,[1].concat(n(r))),s=r.length>1?(a.width-8)/(r.length-1):0;return l.beginPath(),l.lineWidth=2,l.strokeStyle="#2e6cff",r.forEach(function(e,t){var n=4+t*s,i=a.height-6-e/d*(a.height-12);t?l.lineTo(n,i):l.moveTo(n,i)}),l.stroke(),l.fillStyle="#2e6cff",void r.forEach(function(e,t){var n=4+t*s,i=a.height-6-e/d*(a.height-12);l.beginPath(),l.arc(n,i,2,0,2*Math.PI),l.fill()})}l=a.getContext("2d");var c="function"==typeof window.computeTickOptions?window.computeTickOptions(o,a.width||600):{autoSkip:!0,maxRotation:0,minRotation:0};if(p)p.data.labels=o,p.data.datasets[0].data=r,p.options.scales.x.ticks=c,p.update();else{var u="function"==typeof Chart.getChart?Chart.getChart(a):null;u&&u.destroy(),p=new Chart(l,{type:"line",data:{labels:o,datasets:[{label:"",data:r,tension:.3,pointRadius:3,pointHoverRadius:5}]},options:{responsive:!1,maintainAspectRatio:!1,animation:!1,animations:!1,plugins:{legend:{display:!1}},scales:{x:{grid:{display:!1},ticks:c},y:{beginAtZero:!0}}}})}}}function g(e){return'<div class="card" style="flex:1 1 360px"><div style="display:flex;align-items:center;gap:8px"><div><b>'+u(e.name||"User #"+e.userId)+"</b></div>"+(e.grade?'<span class="chip small">'+u(e.grade)+"</span>":"")+'</div><div class="small" style="margin-top:6px">VSS '+s(e.vss||0)+'</div><div class="small">VSD Pers. '+s(e.vsdP||0)+'</div><div class="small">VSD Ind. '+s(e.vsdI||0)+'</div><div class="small">VSD Tot. '+s((e.vsdP||0)+(e.vsdI||0))+'</div><div class="small">GI '+s(e.gi||0)+'</div><div class="small">NNCF '+c(e.nncf||0)+'</div><div class="small muted" style="margin-top:6px">Provv GI '+s(e.provvGi||0)+'</div><div class="small muted">Provv VSD '+s(e.provvVsd||0)+'</div><div class="small"><b>Tot Provvigioni '+s(e.provvTot||0)+"</b></div></div>"}function y(){var e=(document.getElementById("t_mode")||{}).value||"consuntivo",n=r();Promise.all([_("/api/usernames"),_("/api/leaderboard?indicator="+encodeURIComponent("VSS")+n+"&mode="+encodeURIComponent(e)),_("/api/leaderboard?indicator="+encodeURIComponent("VSDPersonale")+n+"&mode="+encodeURIComponent(e)),_("/api/leaderboard?indicator="+encodeURIComponent("VSDIndiretto")+n+"&mode="+encodeURIComponent(e)),_("/api/leaderboard?indicator="+encodeURIComponent("GI")+n+"&mode="+encodeURIComponent(e)),_("/api/leaderboard?indicator="+encodeURIComponent("NNCF")+n+"&mode="+encodeURIComponent(e)),_("/api/leaderboard?indicator="+encodeURIComponent("ProvvGI")+n+"&mode="+encodeURIComponent(e)),_("/api/leaderboard?indicator="+encodeURIComponent("ProvvVSD")+n+"&mode="+encodeURIComponent(e))]).then(function(e){var n=e[0]||{},a=e[1]&&(e[1].rows||e[1].ranking)||[],i=e[2]&&(e[2].rows||e[2].ranking)||[],o=e[3]&&(e[3].rows||e[3].ranking)||[],r=e[4]&&(e[4].rows||e[4].ranking)||[],l=e[5]&&(e[5].rows||e[5].ranking)||[],d=e[6]&&(e[6].rows||e[6].ranking)||[],p=e[7]&&(e[7].rows||e[7].ranking)||[],v=(n.users||[]).map(function(e){return{id:String(e.id),name:e.name||e.email||"User #"+e.id,grade:"senior"===e.grade?"senior":"junior"}}),m=document.getElementById("t_cons");function f(e){for(var n={},a=0;a<e.length;a++){var i=e[a],o=String(i.userId||i.id||i.uid||""),r=t(i.total||i.value||i.sum||0);o&&(n[o]=r)}return n}m&&(m.innerHTML='<option value="">Tutti</option>'+v.map(function(e){return'<option value="'+e.id+'">'+u(e.name)+"</option>"}).join(""));var b=f(a),y=f(i),h=f(o),w=f(r),_=f(l),x=f(d),S=f(p),E=v.map(function(e){var n=t(b[e.id]),a=t(y[e.id]),i=t(h[e.id]),o=t(w[e.id]),r=t(_[e.id]),l=t(x[e.id]),d=t(S[e.id]);return{userId:e.id,name:e.name,grade:e.grade,vss:n,vsdP:a,vsdI:i,gi:o,nncf:r,provvGi:l,provvVsd:d,provvTot:l+d}}),D=document.getElementById("t_users");D&&(D.innerHTML=E.length?E.map(g).join(""):'<div class="muted">Nessun dato</div>');var B=E.reduce(function(e,t){return e.vss+=t.vss,e.vsdP+=t.vsdP,e.vsdI+=t.vsdI,e.gi+=t.gi,e.nncf+=t.nncf,e.provvGi+=t.provvGi,e.provvVsd+=t.provvVsd,e.provvTot+=t.provvTot,e},{vss:0,vsdP:0,vsdI:0,gi:0,nncf:0,provvGi:0,provvVsd:0,provvTot:0}),T=document.getElementById("t_agg");T&&(T.innerHTML=function(e){return'<div class="card" style="flex:1 1 460px"><div class="neon" style="font-weight:900">Totali squadra</div><div class="small" style="margin-top:6px">VSS '+s(e.vss)+'</div><div class="small">VSD Pers. '+s(e.vsdP)+'</div><div class="small">VSD Ind. '+s(e.vsdI)+'</div><div class="small">VSD Tot. '+s(e.vsdP+e.vsdI)+'</div><div class="small">GI '+s(e.gi)+'</div><div class="small">NNCF '+c(e.nncf)+'</div><div class="small muted" style="margin-top:6px">Provv GI '+s(e.provvGi)+'</div><div class="small muted">Provv VSD '+s(e.provvVsd)+'</div><div class="small"><b>Tot Provvigioni '+s(e.provvTot)+"</b></div></div>"}(B)),I()}).catch(function(e){logger.error(e),R("Errore caricamento squadra")})}function x(e){return h(e,new Date).map(function(e){return{s:e.s,e:e.e}})}function I(){var e=document.getElementById("t_ind").value,t=document.getElementById("t_mode").value||"consuntivo",n=document.getElementById("t_cons").value||"",a=b("t"),i=a.type,o=d(e);r(),n&&encodeURIComponent(n),encodeURIComponent(o),encodeURIComponent(t);var l=function(e,t,n,a){var i=a||b("t"),o=String(i.type||"mensile").toLowerCase(),r="ytd"===o||"ltm"===o?"mensile":o,l=x(o);function s(e,t){var n=new Date(t.startDate).getTime(),a=new Date(t.endDate).getTime();return n>=e.s&&a<=e.e}function c(e,t){if(!e)return 0;if("VSDTotale"===t)return Number(e.VSDPersonale||0)+Number(e.VSDIndiretto||0);if("ProvvGI"===t)return Number(e.ProvvGI||0);if("ProvvVSD"===t)return Number(e.ProvvVSD||0);if("TotProvvigioni"===t){var n=e.TotProvvigioni;return Number(null!=n?n:Number(e.ProvvGI||0)+Number(e.ProvvVSD||0))}return Number(e[t]||0)}return _("/api/periods?global=1").catch(function(){return _("/api/periods")}).then(function(a){var i=(a&&a.periods||[]).filter(function(e){return e.type===r&&(!n||String(e.userId||e.uid||"")===String(n))});return l.map(function(n){for(var a=0,o=0;o<i.length;o++){var r=i[o];s(n,r)&&(a+=c("previsionale"===t?r.indicatorsPrev||{}:r.indicatorsCons||{},d(e)))}return{x:new Date(n.s),y:Math.round(100*a)/100}})})}(o,t,n||null,a);l.then(function(e){v(e,i)}).catch(function(e){logger.error(e),v([],i)})}f("t",function(){"function"==typeof haptic&&haptic("light"),y()}),document.getElementById("t_mode").onchange=function(){"function"==typeof haptic&&haptic("light"),y()},document.getElementById("t_ind").onchange=function(){"function"==typeof haptic&&haptic("light"),I()},document.getElementById("t_cons").onchange=function(){"function"==typeof haptic&&haptic("light"),I()},y()},window.viewCommissions=function(){if(!m())return o();var e="admin"===m().role;function t(e){return document.getElementById(e)}function n(e){return(Number(e)||0).toLocaleString("it-IT")+"â‚¬"}function a(e){return e=Number(null==e?"":e),isFinite(e)?e:0}function r(e,t){return'<div class="card" style="flex:1 1 180px"><div class="small muted">'+j(e)+'</div><div style="font-weight:700; font-size:20px; margin-top:4px">'+t+"</div></div>"}function d(){var i=b("comm"),o=t("comm_mode").value||"consuntivo",l=e?t("comm_user").value||"__all":String(m().id),d=new Date(i.start).getTime(),s=new Date(i.end).getTime();_("/api/periods").then(function(i){var c,u,p=(i&&i.periods||[]).filter(function(t){var n=new Date(t.startDate).getTime(),a=new Date(t.endDate).getTime();return!(n<d||a>s)&&((!e||"__all"===l||String(t.userId||t.uid||"")===String(l))&&!(!e&&String(t.userId||t.uid||"")!==String(m().id)))}),v={gi:0,vsd:0,provv_gi:0,provv_vsd:0,provv_total:0},g={};p.forEach(function(e){var t="previsionale"===o?e.indicatorsPrev||{}:e.indicatorsCons||{},n=String(e.userId||e.uid||""),i=e.userName||e.name||"User "+n,r=a(t.GI),l=a(t.VSDPersonale),d=a(t.ProvvGI),s=a(t.ProvvVSD),c=function(e){return e?null!=e.TotProvvigioni?a(e.TotProvvigioni):a(e.ProvvGI)+a(e.ProvvVSD):0}(t);v.gi+=r,v.vsd+=l,v.provv_gi+=d,v.provv_vsd+=s,v.provv_total+=c,g[n]||(g[n]={userId:n,name:i,gi:0,vsd:0,provv_gi:0,provv_vsd:0,provv_total:0}),g[n].gi+=r,g[n].vsd+=l,g[n].provv_gi+=d,g[n].provv_vsd+=s,g[n].provv_total+=c}),t("comm_total").innerHTML=""+r("VSD personale",n((c=v).vsd||0))+r("GI",n(c.gi||0))+r("Provv. VSD",n(c.provv_vsd||0))+r("Provv. GI",n(c.provv_gi||0))+r("Totale Provvigioni",n(c.provv_total||0)),t("comm_rows").innerHTML=(u=Object.values(g).sort(function(e,t){return(t.provv_total||0)-(e.provv_total||0)})).length?u.map(function(e){return'<div class="card" style="flex:1 1 320px"><div><b>'+j(e.name)+'</b></div><div class="small" style="margin-top:4px">GI '+n(e.gi||0)+" Â· VSD "+n(e.vsd||0)+'</div><div class="small muted" style="margin-top:2px">Provv. GI '+n(e.provv_gi||0)+" Â· Provv. VSD "+n(e.provv_vsd||0)+'</div><div class="small" style="margin-top:6px"><b>Totale: '+n(e.provv_total||0)+"</b></div></div>"}).join(""):'<div class="muted">Nessun dato</div>',function(e,t,a){var i=document.getElementById("cm_pie_provv"),o=document.getElementById("cm_pie_legend");if(i&&i.getContext){var r=i.getContext("2d"),l=i.width,d=i.height,s=l/2,c=d/2,u=Math.min(l,d)/2-8;r.clearRect(0,0,l,d);var p=Math.max(0,e||0),v=Math.max(0,t||0),m=p+v,g=a>0?Math.round(m/a*100):null;if(m<=0)return r.beginPath(),r.arc(s,c,u,0,2*Math.PI),r.strokeStyle="#ccd0d5",r.lineWidth=10,r.setLineDash([6,6]),r.stroke(),r.setLineDash([]),r.globalCompositeOperation="destination-out",r.beginPath(),r.arc(s,c,.55*u,0,2*Math.PI),r.fill(),r.globalCompositeOperation="source-over",r.fillStyle="#111",r.textAlign="center",r.textBaseline="middle",r.font="bold 20px system-ui, -apple-system, Segoe UI, Roboto, sans-serif",r.fillText(null==g?"â€”":g+"%",s,c),void(o&&(o.innerHTML='<div class="muted">Nessuna provvigione nel periodo</div>'));var f=[{label:"Provv. GI",value:p,color:"#4F8EF7"},{label:"Provv. VSD",value:v,color:"#F79F4F"}],b=-Math.PI/2;f.forEach(function(e){var t=e.value/m*Math.PI*2;r.beginPath(),r.moveTo(s,c),r.arc(s,c,u,b,b+t),r.closePath(),r.fillStyle=e.color,r.fill(),b+=t}),r.globalCompositeOperation="destination-out",r.beginPath(),r.arc(s,c,.55*u,0,2*Math.PI),r.fill(),r.globalCompositeOperation="source-over",r.fillStyle="#111",r.textAlign="center",r.textBaseline="middle",r.font="bold 20px system-ui, -apple-system, Segoe UI, Roboto, sans-serif",r.fillText(null==g?"â€”":g+"%",s,c);var y=Math.round(p/m*100),h=Math.round(v/m*100);o&&(o.innerHTML='<div class="row" style="gap:16px; flex-wrap:wrap"><div class="row" style="gap:8px; align-items:center"><span style="display:inline-block;width:12px;height:12px;background:#4F8EF7;border-radius:3px"></span><span><b>Provv. GI</b> '+n(p)+" Â· "+y+'%</span></div><div class="row" style="gap:8px; align-items:center"><span style="display:inline-block;width:12px;height:12px;background:#F79F4F;border-radius:3px"></span><span><b>Provv. VSD</b> '+n(v)+" Â· "+h+"%</span></div></div>")}else o&&(o.innerHTML="")}(v.provv_gi||0,v.provv_vsd||0,v.gi||0)}).catch(function(e){logger.error(e),R("Errore nel caricamento dati")})}document.title="Battle Plan â€“ Provvigioni",i.innerHTML=G()+'<div class="wrap"><div class="card"><b>Calcolo provvigioni</b><div class="row" style="margin-top:8px; gap:12px; flex-wrap:wrap">'+(e?'<div><label>Utente</label><select id="comm_user"><option value="__all">Tutta la squadra</option></select></div>':"")+'<div><label>ModalitÃ </label><select id="comm_mode" name="mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div></div>'+l("comm")+'</div><div class="card"><b>Indicatori periodo</b><div id="comm_total" class="row" style="margin-top:8px; gap:12px; flex-wrap:wrap"></div></div><div class="card"><b>Provvigioni â€“ ripartizione</b><div class="small muted">Confronto tra Provvigioni GI e Provvigioni VSD sul periodo selezionato</div><div class="row" style="margin-top:8px; align-items:center; gap:16px; flex-wrap:wrap"><canvas id="cm_pie_provv" width="260" height="260" style="max-width:260px; max-height:260px"></canvas><div id="cm_pie_legend" class="small"></div></div></div><div class="card"><b>Dettaglio</b><div id="comm_rows" class="row" style="margin-top:8px; gap:12px; flex-wrap:wrap"></div></div></div>',Y(),f("comm",function(){d()}),t("comm_mode").onchange=function(){haptic("light"),d()},e&&(t("comm_user").onchange=function(){haptic("light"),d()}),e&&_("/api/usernames").then(function(e){var n=t("comm_user");if(n){for(var a='<option value="__all">Tutta la squadra</option>',i=e&&e.users||[],o=0;o<i.length;o++){var r=i[o];a+='<option value="'+r.id+'">'+j(r.name||"User "+r.id)+"</option>"}n.innerHTML=a}}),d()},window.viewVendite=function(){if(!m())return o();document.title="Battle Plan â€“ Vendite e Riordini",i.innerHTML=G()+'\n    <div class="wrap">\n\n      <div class="card">\n        <b>Filtro</b>\n        <div class="row" style="margin-top:6px;align-items:flex-end;gap:16px;flex-wrap:wrap">\n          <div>\n            <label>Consulente</label>\n            <select id="vr_cons"><option value="">Tutti</option></select>\n          </div>\n        </div>\n        '.concat(l("vr"),'\n      </div>\n\n      <div class="card">\n        <b>Vendite e Riordini</b>\n        <div class="table" style="overflow:auto">\n          <table class="simple" style="min-width:980px">\n            <thead>\n              <tr>\n                <th>Data</th>\n                <th>Cliente</th>\n                <th>Consulente</th>\n              </tr>\n            </thead>\n            <tbody id="vr_rows">\n              <tr><td colspan="3" class="muted">Nessun dato</td></tr>\n            </tbody>\n          </table>\n        </div>\n      </div>\n\n    </div>'),Y(),f("vr",function(){})},window.viewReport=function(){if(!m())return o();document.title="Battle Plan â€“ Report",i.innerHTML=G()+'<div class="wrap"><div class="card"><b>Sezioni da includere</b><div id="rep_toggles" class="row" style="margin-top:8px; gap:8px; flex-wrap:wrap"><button class="pill" data-type="mensile" id="tog_mese">Mese</button><button class="pill" data-type="trimestrale" id="tog_trimestre">Trimestre</button><button class="pill" data-type="semestrale" id="tog_semestre">Semestre</button><button class="pill" data-type="annuale" id="tog_anno">Anno</button></div></div><div class="card"><b>Report</b><div class="row" style="margin-top:8px"><div style="min-width:320px"><label>Oggetto email</label><input id="report_subject" placeholder="Report BP"></div></div><div class="row" style="margin-top:8px; flex-wrap:wrap"><div style="flex:1 1 100%; min-width:0"><label>Corpo email</label><textarea id="report_body" rows="12" placeholder="Testo del reportâ€¦" style="width:100%; box-sizing:border-box; overflow:auto; resize:vertical; max-height:70vh; white-space:pre-wrap; word-break:break-word"></textarea></div></div><div class="row" id="report-actions" style="gap:8px;margin-top:8px;flex-wrap:wrap"><button class="ghost" id="rep_copy">Copia report</button><span style="flex:0 0 8px"></span><button class="ghost" id="rep_gmail_web">Gmail Web</button><button class="ghost" id="rep_gmail_app">Gmail App</button></div></div></div>',Y();var e=[],t={mensile:!1,trimestrale:!1,semestrale:!1,annuale:!1},n=[{k:"VSS",money:!0,label:"VSS"},{k:"VSDPersonale",money:!0,label:"VSDPersonale"},{k:"VSDIndiretto",money:!0,label:"VSDIndiretto"},{k:"GI",money:!0,label:"GI"},{k:"Telefonate",money:!1,label:"Telefonate"},{k:"AppFissati",money:!1,label:"AppFissati"},{k:"AppFatti",money:!1,label:"AppFatti"},{k:"CorsiLeadership",money:!1,label:"CorsiLeadership"},{k:"iProfile",money:!1,label:"iProfile"},{k:"MBS",money:!1,label:"MBS"},{k:"NNCF",money:!1,label:"NNCF"}];function a(e){return document.getElementById(e)}var r=a("report_body");function l(e,t){var n=new Date(e.getTime());return n.setDate(n.getDate()+t),n}function d(e){return F(e.getFullYear(),P(e))}function s(e){return["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"][e.getMonth()]}function c(e){return Math.floor(e.getMonth()/3)+1}function u(e){return e.getMonth()<6?1:2}function p(e,t){return"mensile"===e?{start:B(t),end:T(t)}:"trimestrale"===e?{start:C(t),end:k(t)}:"semestrale"===e?{start:M(t),end:A(t)}:{start:N(t),end:L(t)}}function v(e,t){return t>=l(e,-7)&&t<=l(e,5)}function g(t,n,a){for(var i=0;i<e.length;i++){var o=e[i];if(o.type===t&&(E(o.startDate)===E(n)&&E(o.endDate)===E(a)))return o}return null}function f(e,t){var n=e&&e[t];return Number(n||0)}function b(e,t){return n.some(function(t){return t.k===e&&t.money})?function(e){return z(e)+"â‚¬"}(t):z(t)}function y(e,t,a,i){var o=g(t,a,i)||{},r=o.indicatorsPrev||{},l=o.indicatorsCons||{},d=[e,""];return n.forEach(function(e){var t=f(r,e.k),n=f(l,e.k);d.push(e.label+" "+b(e.k,n)+" vs "+b(e.k,t)+" di previsionali ("+function(e,t){return e>t?"â†‘":e<t?"â†“":"="}(n,t)+")")}),d.push("Note:"),d.join("\n")}function h(e,t,a,i){var o=(g(t,a,i)||{}).indicatorsPrev||{},r=[e,""];return n.forEach(function(e){r.push(e.label+" "+b(e.k,f(o,e.k)))}),r.push("Possibili note:"),r.join("\n")}function w(e){return"BP CONSUNTIVO "+s(e)+" "+e.getFullYear()}function x(e){return"BP PREVISIONALE "+s(e)+" "+e.getFullYear()}function I(e){return"BP CONSUNTIVO T"+c(e)+" "+e.getFullYear()}function S(e){return"BP PREVISIONALE T"+c(e)+" "+e.getFullYear()}function D(e){return"BP CONSUNTIVO S"+u(e)+" "+e.getFullYear()}function V(e){return"BP PREVISIONALE S"+u(e)+" "+e.getFullYear()}function O(e){return"BP CONSUNTIVO "+e.getFullYear()}function R(e){return"BP PREVISIONALE "+e.getFullYear()}function U(){var e,n=new Date,a=[];if(function(e){var t=e.getDay();return 5===t||6===t||0===t}(n)){var i=d(n),o=function(e){var t=d(e);return d(l(t.start,7))}(n);a.push(y("BP CONSUNTIVO SETT. "+P(e=i.start)+" "+e.getFullYear(),"settimanale",i.start,i.end)),a.push(h(function(e){return"BP PREVISIONALE SETT. "+P(e)+" "+e.getFullYear()}(o.start),"settimanale",o.start,o.end))}function s(e,t,i){var o=function(e,t){var n=p(e,t),a=p(e,l(n.start,-1)),i=p(e,l(n.end,1)),o=v(a.end,t),r=v(n.end,t);return o&&!r?{closing:a,next:n}:{closing:n,next:i}}(e,n);a.push(y(t(o.closing.start),e,o.closing.start,o.closing.end)),a.push(h(i(o.next.start),e,o.next.start,o.next.end))}t.mensile&&s("mensile",w,x),t.trimestrale&&s("trimestrale",I,S),t.semestrale&&s("semestrale",D,V),t.annuale&&s("annuale",O,R),r.value=a.join("\n\n")+(a.length?"\n":"")}function j(e,t){e.classList.toggle("active",!!t),e.style.opacity=t?"1":"0.65"}function H(){j(a("tog_mese"),t.mensile),j(a("tog_trimestre"),t.trimestrale),j(a("tog_semestre"),t.semestrale),j(a("tog_anno"),t.annuale)}function q(e){return encodeURIComponent(String(e||""))}_("/api/periods").then(function(n){var i,o,d;e=n&&n.periods||[],function(){var e=new Date;function n(t){var n=p(t,e),a=p(t,l(n.start,-1));return v(n.end,e)||v(a.end,e)}t.mensile=n("mensile"),t.trimestrale=n("trimestrale"),t.semestrale=n("semestrale"),t.annuale=n("annuale"),H()}(),function(){function e(e){var n=e.currentTarget.getAttribute("data-type");t[n]=!t[n],H(),U()}a("tog_mese").onclick=e,a("tog_trimestre").onclick=e,a("tog_semestre").onclick=e,a("tog_anno").onclick=e}(),U(),i=a("rep_gmail_web"),o=a("rep_gmail_app"),(d=a("rep_copy"))&&(d.onclick=function(){try{navigator.clipboard.writeText(r.value||"");var e=d.textContent;d.textContent="Copiato!",setTimeout(function(){d.textContent=e},1200)}catch(t){}}),i&&o&&_("/api/users_emails").then(function(e){var t=(e&&e.emails||(e&&e.users||[]).map(function(e){return e.email})).filter(Boolean).join(",");function n(){return a("report_subject").value||"Report BP"}function l(){return r.value||""}i.onclick=function(){try{navigator.clipboard.writeText(l())}catch(a){}var e="https://mail.google.com/mail/?view=cm&fs=1&tf=1&su="+q(n())+"&cc="+q(t)+"&body="+q(l());window.open(e,"_blank"),document.dispatchEvent(new Event("report:composed"))},o.onclick=function(){try{navigator.clipboard.writeText(l())}catch(a){}var e="googlegmail:///co?subject="+q(n())+"&cc="+q(t)+"&body="+q(l());location.href=e,document.dispatchEvent(new Event("report:composed")),setTimeout(function(){document.hidden||(location.href="mailto:?subject="+q(n())+"&cc="+q(t)+"&body="+q(l()),document.dispatchEvent(new Event("report:composed")))},1200)}})})},window.viewUsers=function(){var e=m();if(!e)return o();if(document.title="Battle Plan â€“ Utenti","admin"!==e.role)return i.innerHTML=G()+'<div class="wrap"><div class="card"><b>Il mio profilo</b><div class="row" style="margin-top:8px"><div><label>Nome</label><input id="p_name" type="text" value="'+j(e.name||"")+'"></div><div><label>Email</label><input id="p_email" type="email" value="'+j(e.email||"")+'"></div></div><div class="row"><div><label>Nuova password</label><input id="p_pwd" type="password" placeholder="Lascia vuoto per non cambiare"></div><div class="right" style="align-self:flex-end"><button id="p_save">Aggiorna</button></div></div><div class="row"><div><label>Ruolo</label><input value="'+j(e.role||"consultant")+'" disabled></div><div><label>Grade</label><input value="'+j(e.grade||"junior")+'" disabled></div></div></div></div>',Y(),void(Z("#p_save").onclick=function(){var t=Z("#p_name").value.trim(),n=Z("#p_email").value.trim(),a=Z("#p_pwd").value,i={id:e.id,name:t,email:n};a&&(i.password=a),x("/api/users",i).then(function(){R("Profilo aggiornato"),window.addXP(3);var e=m();e&&(e.name=t,e.email=n,localStorage.setItem("user",JSON.stringify(e)));try{document.dispatchEvent(new Event("user:profile-updated"))}catch(a){}}).catch(function(e){logger.error(e),R("Errore aggiornamento")})});function t(e){var t=j(e.name||e.email||"user_"+e.id),n="senior"===e.grade?"senior":"junior",a="admin"===e.role?"admin":"consultant";return'<div class="card" style="flex:1 1 380px"><div><b>'+t+'</b> <span class="small muted">('+j(a)+')</span></div><div class="row" style="margin-top:6px"><div><label>Nome</label><input data-nfor="'+e.id+'" type="text" value="'+j(e.name||"")+'"></div><div><label>Email</label><input data-efor="'+e.id+'" type="email" value="'+j(e.email||"")+'"></div></div><div class="row"><div><label>Nuova password</label><input data-pfor="'+e.id+'" type="password" placeholder="(opzionale)"></div><div><label>Grade</label><select data-gfor="'+e.id+'"><option value="junior"'+("junior"===n?" selected":"")+'>Junior</option><option value="senior"'+("senior"===n?" selected":"")+'>Senior</option></select></div><div><label>Ruolo</label><select data-rfor="'+e.id+'"><option value="consultant"'+("consultant"===a?" selected":"")+'>Consulente</option><option value="admin"'+("admin"===a?" selected":"")+'>Admin</option></select></div><div class="right" style="align-self:flex-end"><button class="ghost" data-save="'+e.id+'">Aggiorna</button> <button class="danger" data-del="'+e.id+'" title="Elimina utente">Elimina</button></div></div></div>'}i.innerHTML=G()+'<div class="wrap"><div class="card"><b>Gestione utenti</b><div id="users_list" class="row" style="margin-top:8px"></div></div></div>',Y(),function e(){_("/api/users").then(function(n){var a=n&&n.users||[],i=Z("#users_list");i&&(i.innerHTML=a.map(t).join(""),J("[data-save]").forEach(function(e){e.addEventListener("click",function(){var t=e.getAttribute("data-save"),n=(Z('input[data-nfor="'+t+'"]')||{}).value||"",a=(Z('input[data-efor="'+t+'"]')||{}).value||"",i=(Z('select[data-gfor="'+t+'"]')||{}).value||"junior",o=(Z('select[data-rfor="'+t+'"]')||{}).value||"consultant",r=Z('input[data-pfor="'+t+'"]'),l=r?r.value:"",d={id:t,name:n,email:a,grade:i,role:o};l&&(d.password=l),x("/api/users",d).then(function(){R("Aggiornato"),window.addXP(5),r&&(r.value="")}).catch(function(e){logger.error(e),R("Errore aggiornamento")})})}),J("[data-del]").forEach(function(t){t.addEventListener("click",function(){var n=t.getAttribute("data-del");confirm("Eliminare definitivamente questo utente?")&&fetch("/api/users?id="+encodeURIComponent(n),{method:"DELETE",headers:{Authorization:"Bearer "+v()}}).then(function(e){if(!e.ok)throw new Error("HTTP "+e.status);return e.json()}).then(function(){R("Utente eliminato"),e()}).catch(function(e){logger.error(e),R("Errore eliminazione")})})}))})}()},window.toggleDrawer=W,window.logout=g,window.rerenderTopbarSoon=$,document.addEventListener("DOMContentLoaded",function(){m()?(Y(),q()):o()})}()}}})}();
