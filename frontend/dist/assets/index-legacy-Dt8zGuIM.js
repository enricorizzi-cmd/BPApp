!function(){function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(e){return function(e){if(Array.isArray(e))return p(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||u(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function n(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var a,i,r,o,l=[],s=!0,d=!1;try{if(r=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;s=!1}else for(;!(s=(a=r.call(n)).done)&&(l.push(a.value),l.length!==t);s=!0);}catch(e){d=!0,i=e}finally{try{if(!s&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(d)throw i}}return l}}(e,t)||u(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function a(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function l(n,a,r,o){var l=a&&a.prototype instanceof d?a:d,c=Object.create(l.prototype);return i(c,"_invoke",function(n,a,i){var r,o,l,d=0,c=i||[],u=!1,p={p:0,n:0,v:e,a:v,f:v.bind(e,4),d:function(t,n){return r=t,o=0,l=e,p.n=n,s}};function v(n,a){for(o=n,l=a,t=0;!u&&d&&!i&&t<c.length;t++){var i,r=c[t],v=p.p,m=r[2];n>3?(i=m===a)&&(l=r[(o=r[4])?5:(o=3,3)],r[4]=r[5]=e):r[0]<=v&&((i=n<2&&v<r[1])?(o=0,p.v=a,p.n=r[1]):v<m&&(i=n<3||r[0]>a||a>m)&&(r[4]=n,r[5]=a,p.n=m,o=0))}if(i||n>1)return s;throw u=!0,a}return function(i,c,m){if(d>1)throw TypeError("Generator is already running");for(u&&1===c&&v(c,m),o=c,l=m;(t=o<2?e:l)||!u;){r||(o?o<3?(o>1&&(p.n=-1),v(o,l)):p.n=l:p.v=l);try{if(d=2,r){if(o||(i="next"),t=r[i]){if(!(t=t.call(r,l)))throw TypeError("iterator result is not an object");if(!t.done)return t;l=t.value,o<2&&(o=0)}else 1===o&&(t=r.return)&&t.call(r),o<2&&(l=TypeError("The iterator does not provide a '"+i+"' method"),o=1);r=e}else if((t=(u=p.n<0)?l:n.call(a,p))!==s)break}catch(t){r=e,o=1,l=t}finally{d=1}}return{value:t,done:u}}}(n,r,o),!0),c}var s={};function d(){}function c(){}function u(){}t=Object.getPrototypeOf;var p=[][r]?t(t([][r]())):(i(t={},r,function(){return this}),t),v=u.prototype=d.prototype=Object.create(p);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,u):(e.__proto__=u,i(e,o,"GeneratorFunction")),e.prototype=Object.create(v),e}return c.prototype=u,i(v,"constructor",u),i(u,"constructor",c),c.displayName="GeneratorFunction",i(u,o,"GeneratorFunction"),i(v),i(v,o,"Generator"),i(v,r,function(){return this}),i(v,"toString",function(){return"[object Generator]"}),(a=function(){return{w:l,m:m}})()}function i(e,t,n,a){var r=Object.defineProperty;try{r({},"",{})}catch(e){r=0}i=function(e,t,n,a){function o(t,n){i(e,t,function(e){return this._invoke(t,n,e)})}t?r?r(e,t,{value:n,enumerable:!a,configurable:!a,writable:!a}):e[t]=n:(o("next",0),o("throw",1),o("return",2))},i(e,t,n,a)}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach(function(t){l(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function l(t,n,a){return(n=function(t){var n=function(t,n){if("object"!=e(t)||!t)return t;var a=t[Symbol.toPrimitive];if(void 0!==a){var i=a.call(t,n||"default");if("object"!=e(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===n?String:Number)(t)}(t,"string");return"symbol"==e(n)?n:n+""}(n))in t?Object.defineProperty(t,n,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[n]=a,t}function s(e,t,n,a,i,r,o){try{var l=e[r](o),s=l.value}catch(e){return void n(e)}l.done?t(s):Promise.resolve(s).then(a,i)}function d(e){return function(){var t=this,n=arguments;return new Promise(function(a,i){var r=e.apply(t,n);function o(e){s(r,a,i,o,l,"next",e)}function l(e){s(r,a,i,o,l,"throw",e)}o(void 0)})}}function c(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=u(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var a=0,i=function(){};return{s:i,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,o=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){l=!0,r=e},f:function(){try{o||null==n.return||n.return()}finally{if(l)throw r}}}}function u(e,t){if(e){if("string"==typeof e)return p(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?p(e,t):void 0}}function p(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,a=Array(t);n<t;n++)a[n]=e[n];return a}System.register([],function(i,r){"use strict";return{execute:function(){var i,r,l,s,u,p,v=document.createElement("style");v.textContent='#bp-overlay{position:fixed;top:0;right:0;bottom:0;left:0;display:none;align-items:center;justify-content:center;z-index:10000}#bp-overlay:not(.hidden){display:flex}#bp-overlay .bp-overlay-backdrop{position:absolute;top:0;right:0;bottom:0;left:0;background:rgba(0,0,0,.35)}#bp-overlay .bp-overlay-panel{position:relative;max-width:min(92vw,560px);width:auto;background:#fff;color:#111;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.3);padding:16px;margin:12px}#bp-overlay .row{display:flex;gap:12px}#bp-overlay input[type=date],#bp-overlay input[type=number],#bp-overlay input[type=text],#bp-overlay textarea,#bp-overlay select{width:100%}.chip-nncf{display:inline-flex;align-items:center;gap:.35rem;padding:.2rem .5rem;border-radius:999px;border:1px solid var(--acc,#888);cursor:pointer;user-select:none;margin-left:.5rem;font-size:.9em}.chip-nncf input{accent-color:var(--acc,#444);width:1rem;height:1rem}.today{outline:2px solid var(--acc,#0aa);outline-offset:-2px;border-radius:.5rem;position:relative}.today:after{content:"Oggi";position:absolute;top:2px;right:4px;font-size:.7em;color:var(--acc,#0aa)}.btn-ghost{background:transparent;border:1px solid #999;border-radius:.5rem;padding:.35rem .6rem;cursor:pointer}.btn-ghost:hover{background:rgba(0,0,0,.04)}.btn-ics{padding:2px 4px;font-size:1.1rem;line-height:1}.kpi-mini canvas{max-height:180px}\n/*$vite$:1*/',document.head.appendChild(v),"undefined"!=typeof window&&("function"!=typeof window.effectivePeriodType&&(window.effectivePeriodType=function(e){return e?"ytd"===(e=String(e).toLowerCase())||"ltm"===e?"mensile":e:""}),"function"!=typeof window.isoWeekNum&&(window.isoWeekNum=function(e){var t=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate())),n=t.getUTCDay()||7;t.setUTCDate(t.getUTCDate()+4-n);var a=new Date(Date.UTC(t.getUTCFullYear(),0,1));return Math.ceil(((t-a)/864e5+1)/7)})),i=window.fetch.bind(window),window.fetch=function(e,t){var n="string"==typeof e?e:e&&e.url||"";if("string"!=typeof n||!n.startsWith("/api/")&&!n.startsWith(location.origin+"/api/"))return i(e,t);var a=function(){try{var e=JSON.parse(localStorage.getItem("user")||"{}");if(e&&(e.token||e.jwt||e.accessToken))return e.token||e.jwt||e.accessToken}catch(o){}for(var t=0,n=["token","authToken","jwt","bp_token","accessToken","id_token"];t<n.length;t++){var a=n[t],i=localStorage.getItem(a)||sessionStorage.getItem(a);if(i){try{var r=JSON.parse(i);if(r&&(r.token||r.jwt||r.accessToken))return r.token||r.jwt||r.accessToken}catch(o){}if(i=String(i).replace(/^"+|"+$/g,""),/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+$/.test(i))return i}}return null}(),r=Object.assign({},t);return r.headers=new Headers(r&&r.headers||{}),a&&!r.headers.has("Authorization")&&r.headers.set("Authorization","Bearer "+a),i(e,r)},function(){function e(){for(var e=function(e){return String(e).replace(/^"+|"+$/g,"")},t=function(e){return/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+$/.test(e||"")},n=0,a=["token","authToken","jwt","bp_token","accessToken","id_token"];n<a.length;n++){var i=a[n],r=localStorage.getItem(i)||sessionStorage.getItem(i);if(r){try{var o=JSON.parse(r);if(o&&(o.token||o.jwt||o.accessToken))return o.token||o.jwt||o.accessToken}catch(s){}if(t(r=e(r)))return r}}try{var l=JSON.parse(localStorage.getItem("user")||"{}");if(l&&(l.token||l.jwt||l.accessToken))return l.token||l.jwt||l.accessToken}catch(s){}return null}function t(e,t,n){return new Date(Date.UTC(e,t,n))}function n(e){return new Date(e.getTime()+864e5-1)}function i(e,t){return new Date(Date.UTC(e,t+1,0))}void 0===window.users&&(window.users=[]),function(){var t=d(a().m(function t(){var i,r,l,s;return a().w(function(t){for(;;)switch(t.p=t.n){case 0:if(t.p=0,!window.GET){t.n=2;break}return t.n=1,window.GET("/api/usernames");case 1:return(i=t.v)&&Array.isArray(i.users)&&(window.users=i.users),t.a(2);case 2:return r=e(),t.n=3,fetch("/api/usernames",{headers:o({Accept:"application/json"},r?{Authorization:"Bearer "+r}:{})});case 3:if(401!==(l=t.v).status){t.n=4;break}return setTimeout(n,800),t.a(2);case 4:if(!l.ok){t.n=6;break}return t.n=5,l.json();case 5:(s=t.v)&&Array.isArray(s.users)&&(window.users=s.users);case 6:t.n=8;break;case 7:t.p=7,t.v,setTimeout(n,1200);case 8:return t.a(2)}},t,null,[[0,7]])}));function n(){return t.apply(this,arguments)}return n}()(),"function"!=typeof window.buildBuckets&&(window.buildBuckets=function(e,a){var r=String(e||"mensile").toLowerCase(),o=effectivePeriodType(r),l=a?new Date(a):new Date,s=l.getUTCFullYear(),d=[];function c(e,t){d.push({s:e.getTime(),e:t.getTime()})}if("settimanale"===o){var u=new Date(Date.UTC(l.getUTCFullYear(),l.getUTCMonth(),l.getUTCDate())),p=(u.getUTCDay()+6)%7;u.setUTCDate(u.getUTCDate()-p);for(var v=52;v>=0;v--){(y=new Date(u)).setUTCDate(u.getUTCDate()-7*v),(w=new Date(y)).setUTCDate(y.getUTCDate()+6),w.setUTCHours(23,59,59,999),c(y,w)}return d}if("mensile"===o){for(var m=new Date(Date.UTC(l.getUTCFullYear(),l.getUTCMonth(),1)),f=23;f>=0;f--){var g=new Date(Date.UTC(m.getUTCFullYear(),m.getUTCMonth()-f,1));c(g,n(i(g.getUTCFullYear(),g.getUTCMonth())))}return d}if("trimestrale"===o){for(var b=Math.floor(l.getUTCMonth()/3),h=11;h>=0;h--){var y,w,_=b-h,S=s+Math.floor(_/4),x=(_%4+4)%4;c(y=t(S,3*x,1),w=n(new Date(Date.UTC(S,3*x+3,0))))}return d}if("semestrale"===o){for(var I=l.getUTCMonth()<6?0:1,E=5;E>=0;E--){var C=I-E,D=s+Math.floor(C/2),k=0===(C%2+2)%2?0:6;c(t(D,k,1),n(new Date(Date.UTC(D,k+6,0))))}return d}for(var T=2;T>=0;T--){var B=s-T;c(t(B,0,1),n(new Date(Date.UTC(B,12,0))))}return d}),"function"!=typeof window.labelsForBuckets&&(window.labelsForBuckets=function(e,t){var n=effectivePeriodType(e||"mensile");return(t||[]).map(function(e){var t=new Date(e.s);return"settimanale"===n?"W"+isoWeekNum(t):"mensile"===n?String(t.getUTCMonth()+1).padStart(2,"0")+"/"+t.getUTCFullYear():"trimestrale"===n?"Q"+(Math.floor(t.getUTCMonth()/3)+1)+" "+t.getUTCFullYear():"semestrale"===n?(t.getUTCMonth()<6?"S1 ":"S2 ")+t.getUTCFullYear():String(t.getUTCFullYear())})}),"function"!=typeof window.sumIndicator&&(window.sumIndicator=function(e,t,n){var a,i,r="previsionale"===String(t).toLowerCase()?e.indicatorsPrev||{}:e.indicatorsCons||{};if("VSDTotale"===n)return Number(r.VSDPersonale||0)+Number(r.VSDIndiretto||0);var o=Number(null!==(a=null!==(i=r[n])&&void 0!==i?i:r[n.toUpperCase()])&&void 0!==a?a:0);return Number.isFinite(o)?o:0})}(),function(e){var t=["localhost","127.0.0.1"].includes(e.location.hostname),n=e.pino?e.pino({level:t?"debug":"info"}):console,a={info:function(){var e;return n.info?n.info.apply(n,arguments):(e=console).log.apply(e,arguments)},error:function(){var e;return n.error?n.error.apply(n,arguments):(e=console).error.apply(e,arguments)},warn:function(){var e;return n.warn?n.warn.apply(n,arguments):(e=console).warn.apply(e,arguments)},debug:function(){var e;return n.debug?n.debug.apply(n,arguments):(e=console).debug.apply(e,arguments)}};e.logger=a}(window),window.BP_PHRASES=((u={lite:r=["Ottimo, {name}! ðŸŽ¯","Ben fatto, {name}! ðŸ™Œ","Avanti cosÃ¬, {name}! ðŸš€","Perfetto, {name}! ðŸ¤©","Bel colpo, {name}! ðŸ’¥","Ci siamo, {name}! ðŸ‘Œ","Grande {name}! ðŸ§±","Pezzo dopo pezzo, {name}! ðŸ§©","Molto bene, {name}! ðŸ‘","Stai andando bene, {name}! âž¡ï¸"],mid:l=["Che figata, {name}! ðŸ”¥","Ma cosa dico grandeâ€¦ grandissimo, {name}! ðŸ’ª","Super, {name}! âœ¨","Non ti ferma nessuno, {name}!! ðŸŽï¸","Stai andando alla grande, {name}! ðŸ“ˆ","Gran progressione, {name}! â©","Il ritmo Ã¨ giusto, {name}! ðŸ¥","Questa spinge, {name}! ðŸ§¨","Bello tosto, {name}! ðŸ›¡ï¸","Gran focus, {name}! ðŸŽ¯"],mega:s=["BOOM! {name}, questo Ã¨ livello PRO! ðŸ†","Risultato pazzesco, {name}! ðŸ¤¯","Clamoroso {name}, cosÃ¬ si fa! âš¡","Ãˆ ufficiale: {name} ON FIRE! ðŸ”¥ðŸ”¥","Top di gamma, {name}! ðŸ¥‡","Mostruoso upgrade, {name}! ðŸš€","Record personale in vista, {name}! ðŸ§ ","Spacchi tutto, {name}! ðŸ’£","Da incorniciare, {name}! ðŸ–¼ï¸","Questo alza lâ€™asticella, {name}! ðŸ“"]}).standard=r,u.rilevante=l,u.grande=s,u.pick=function(e,t){var n=u[e]||r,a=t||JSON.parse(localStorage.getItem("bp_user")||"{}").name||"campione";return(n[Math.floor(Math.random()*n.length)]||"Grande!").replace(/\{name\}/g,a)},u.random=function(e){var t=[r,l,s],n=t[Math.floor(Math.random()*t.length)];return u.pick(n===s?"mega":n===l?"rilevante":"standard",e)},u),((p=window.BP=window.BP||{}).Haptics=p.Haptics||{}).impact=function(e){var t;if(t=navigator.userAgent||navigator.vendor||"",/android|iphone|ipad|ipod|mobile/i.test(t)&&"vibrate"in navigator)try{switch(e){case"light":navigator.vibrate(12);break;case"heavy":navigator.vibrate([10,30,10]);break;default:navigator.vibrate(18)}}catch(n){}},function(){var e=window.BP=window.BP||{},t=e.Undo=e.Undo||{},n=document.createElement("div");n.className="bp-undo-host",document.body.appendChild(n);var a=document.createElement("style");a.textContent="\n  .bp-undo-host{\n    position: fixed; left:50%; transform: translateX(-50%);\n    bottom: 20px; z-index: 1201; display:flex; flex-direction:column; gap:8px;\n  }\n  .bp-undo{\n    min-width: 280px; max-width: 540px;\n    background: rgba(15,19,28,.95);\n    border:1px solid rgba(255,255,255,.18);\n    border-radius: 12px; padding: 10px 12px;\n    box-shadow: 0 10px 24px rgba(0,0,0,.35);\n    display:flex; align-items:center; gap:10px;\n    animation: bpUndoPop .16s ease-out;\n  }\n  .bp-undo .lbl{ font-weight:700; }\n  .bp-undo .spacer{ flex:1; }\n  .bp-undo button{ white-space:nowrap; }\n  @keyframes bpUndoPop{ from{ transform: translate(-50%, 4px); opacity:0 } to{ transform: translate(-50%, 0); opacity:1 } }\n  ",document.head.appendChild(a),t.push=function(e){var t=document.createElement("div");t.className="bp-undo",t.innerHTML='\n      <div class="lbl">'.concat(e&&e.label||"Operazione eseguita",'</div>\n      <div class="spacer"></div>\n      <button type="button" class="ghost" data-undo>Annulla</button>\n    '),n.appendChild(t);var a=!1,i=setTimeout(function(){a||(a=!0,t.remove())},e&&e.timeoutMs||5e3);t.querySelector("[data-undo]").addEventListener("click",function(){if(!a){a=!0,clearTimeout(i);try{e&&e.onUndo&&e.onUndo()}catch(n){}t.remove()}})}}(),function(){var e=window.BP=window.BP||{},t=e.ClientsHelpers=e.ClientsHelpers||{};function n(e){return String(e||"").trim().toLowerCase()}t.withLastAppointment=function(e,t){var a=function(e){var t={};return(e||[]).forEach(function(e){var a=n(e.client);if(a){var i=e.start||e.end;if(i){var r=t[a];(!r||new Date(i)>new Date(r))&&(t[a]=i)}}}),t}(t);return(e||[]).map(function(e){var t=a[n(e.name)]||null;return o(o({},e),{},{lastAppointment:t})})},t.filter=function(e,t){var n=t.status,a=t.consultantId,i=t.consultantName,r=function(e){return String(e||"").trim().toLowerCase()},o=function(e){var t=r(e).replace(/\s+/g,"_").replace(/-/g,"_");return"lead_non_chiuso"===t||"lead_non-chiuso"===t?"lead_non_chiuso":t},l=e||[];if(n&&"tutti"!==n&&(l=l.filter(function(e){return o(e.status)===o(n)})),a)l=l.filter(function(e){return(e.consultantId||"")===String(a)});else if(i){var s=r(i);l=l.filter(function(e){return r(e.consultantName)===s})}return l}}(),function(){var e=window.BP=window.BP||{},t=e.Targets=e.Targets||{},n=["VSS","VSDPersonale","VSDIndiretto","GI"],a=["NNCF","AppFatti","Telefonate"],i=n.concat(a),r={senior:{VSS:3e4,VSDPersonale:15e3,VSDIndiretto:5e3,GI:15e3,NNCF:1,AppFatti:4,Telefonate:0},junior:{VSS:15e3,VSDPersonale:5e3,VSDIndiretto:5e3,GI:1e4,NNCF:4,AppFatti:30,Telefonate:300}};function l(e,t){var n=Number(e||0),a=Number(t||0);return a?Math.ceil(n/a)*a:Math.ceil(n)}function s(e){return n.indexOf(e)>=0}function d(e){var t="senior"===String(e||"junior").toLowerCase()?"senior":"junior";return o({},r[t])}t.MONEY_KEYS=n,t.COUNT_KEYS=a,t.ALL_KEYS=i,t.getMonthly=d,t.getForPeriod=function(e,t){var n,a=function(e){switch(String(e||"mensile").toLowerCase()){case"settimanale":return 1/4;case"mensile":default:return 1;case"trimestrale":return 3;case"semestrale":return 6;case"annuale":return 12}}(t),r=d(e),o={},u=c(i);try{for(u.s();!(n=u.n()).done;){var p=n.value,v=Number(r[p]||0)*a;s(p)?"settimanale"===String(t).toLowerCase()?o[p]=l(v,500):o[p]=l(v,5e3):o[p]=Math.ceil(v)}}catch(m){u.e(m)}finally{u.f()}return o},t.compare=function(e,t){var n,a={},r=c(i);try{for(r.s();!(n=r.n()).done;){var o=n.value,l=Number((e||{})[o]||0),s=Number((t||{})[o]||0),d=l-s,u=s>0?Math.round(l/s*100):l>0?100:0;a[o]={value:l,target:s,delta:d,pct:Math.max(0,u)}}}catch(p){r.e(p)}finally{r.f()}return a},t.summarize=function(e){var t,n=[],a=c(i);try{for(a.s();!(t=a.n()).done;){var r=(e||{})[t.value];r&&r.target>0&&n.push(Number(r.pct||0))}}catch(l){a.e(l)}finally{a.f()}if(!n.length)return 0;var o=n.reduce(function(e,t){return e+t},0)/n.length;return Math.round(o)}}(),function(){var e=window.BP=window.BP||{},t=e.ICS=e.ICS||{};function n(e){try{logger.warn("[BP ICS bulk disabled] chiamata a:",e)}catch(t){}}t.createCalendarForRange=function(){return n("createCalendarForRange()"),null},t.downloadForRange=function(){return n("downloadForRange()"),!1}}(),function(){var e=window.BP=window.BP||{},t=e.ClientStatus=e.ClientStatus||{},n="bp_banner_seen";function i(){try{return JSON.parse(localStorage.getItem(n)||"{}")}catch(e){return{}}}function r(e){return l.apply(this,arguments)}function l(){return(l=d(a().m(function e(t){var n,i;return a().w(function(e){for(;;)switch(e.n){case 0:return n=window.authToken||"",e.n=1,fetch(t,{headers:n?{Authorization:"Bearer "+n}:{}});case 1:if((i=e.v).ok){e.n=2;break}throw new Error("GET "+t+" failed");case 2:return e.a(2,i.json())}},e)}))).apply(this,arguments)}function s(e,t){return c.apply(this,arguments)}function c(){return(c=d(a().m(function e(t,n){var i,r;return a().w(function(e){for(;;)switch(e.n){case 0:return i=window.authToken||"",e.n=1,fetch(t,{method:"POST",headers:o({"Content-Type":"application/json"},i?{Authorization:"Bearer "+i}:{}),body:JSON.stringify(n||{})});case 1:if((r=e.v).ok){e.n=2;break}throw new Error("POST "+t+" failed");case 2:return e.a(2,r.json())}},e)}))).apply(this,arguments)}function u(e){return p.apply(this,arguments)}function p(){return(p=d(a().m(function e(t){var n,i;return a().w(function(e){for(;;)switch(e.n){case 0:if(n=t.clientId,i=t.status,n){e.n=1;break}throw new Error("missing clientId");case 1:return e.a(2,s("/api/clients",{id:n,status:String(i||"")}))}},e)}))).apply(this,arguments)}function v(e){return m.apply(this,arguments)}function m(){return(m=d(a().m(function e(t){var n,i,r,o,l,s;return a().w(function(e){for(;;)switch(e.n){case 0:return n=t.clientName,i=t.status,r=window.authToken||"",e.n=1,fetch("/api/clients",{method:"GET",headers:{Authorization:"Bearer "+r}}).then(function(e){return e.json()}).catch(function(){return{clients:[]}});case 1:if(o=e.v,l=String(n||"").trim().toLowerCase(),s=(o.clients||[]).find(function(e){return String(e.name||"").trim().toLowerCase()===l})){e.n=2;break}throw new Error("client not found by name");case 2:return e.a(2,u({clientId:s.id,status:i}))}},e)}))).apply(this,arguments)}function v(e){return f.apply(this,arguments)}function f(){return(f=d(a().m(function e(t){var n,i,o,l,d,c,p;return a().w(function(e){for(;;)switch(e.n){case 0:if(n=t.clientName,i=t.status,o=String(n||"").trim()){e.n=1;break}throw new Error("missing clientName");case 1:return e.n=2,r("/api/clients");case 2:if(l=e.v,!(d=(l.clients||[]).find(function(e){return String(e.name||"").toLowerCase()===o.toLowerCase()}))){e.n=3;break}return e.a(2,u({clientId:d.id,status:i}));case 3:return e.n=4,s("/api/clients",{name:o});case 4:return e.n=5,r("/api/clients");case 5:if(c=e.v,p=(c.clients||[]).find(function(e){return String(e.name||"").toLowerCase()===o.toLowerCase()})){e.n=6;break}throw new Error("client creation failed");case 6:return e.a(2,u({clientId:p.id,status:i}))}},e)}))).apply(this,arguments)}t.setClientStatusByName=v,function(){if(!document.getElementById("bp-clientstatus-css")){var e=document.createElement("style");e.id="bp-clientstatus-css",e.textContent="\n.bp-banner-client{\n  position: fixed; left:50%; transform:translateX(-50%);\n  top: 70px; z-index: 1200;\n  background: rgba(20,24,34,.95);\n  color: #fff;\n  border: 1px solid rgba(255,255,255,.18);\n  box-shadow: 0 10px 24px rgba(0,0,0,.35);\n  border-radius:14px; padding:10px; min-width:280px;\n  animation: bpBannerPop .18s ease-out;\n}\n.bp-banner-inner{ display:flex; flex-direction:column; gap:6px; }\n.bp-banner-title{ font-weight:800; }\n.bp-banner-sub{ font-size:12px; opacity:.92; }\n.bp-banner-actions{ display:flex; gap:8px; margin-top:6px; justify-content:flex-end; }\n@keyframes bpBannerPop{ from{ transform:translate(-50%, -6px); opacity:0 } to{ transform:translate(-50%, 0); opacity:1 } }\n",document.head.appendChild(e)}}(),t.hasSeen=function(e){return!!i()[e]},t.markSeen=function(e){var t=i();t[e]=!0,function(e){try{localStorage.setItem(n,JSON.stringify(e||{}))}catch(t){}}(t)},t.renderBecameClientBanner=function(e,t){var n=e.appointment,a=e.clientName,i=n||{},r=a||i.client||"Cliente",o=document.createElement("div");return o.className="bp-banner-client",o.innerHTML='\n      <div class="bp-banner-inner">\n        <div class="bp-banner-title">Ãˆ diventato cliente?</div>\n        <div class="bp-banner-sub">Appuntamento con <b>'.concat(String(r).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),'</b></div>\n        <div class="bp-banner-actions">\n          <button type="button" data-yes>SÃ¬</button>\n          <button type="button" class="ghost" data-no>No</button>\n        </div>\n      </div>\n    '),o.querySelector("[data-yes]").addEventListener("click",function(){return t&&t(!0,i)}),o.querySelector("[data-no]").addEventListener("click",function(){return t&&t(!1,i)}),o},t.setClientStatus=u,t.setClientStatusByName=v}(),function(){function e(e){try{fetch("/api/client_error",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o({url:location.href,info:{ua:navigator.userAgent}},e))})}catch(t){}}window.addEventListener("error",function(t){try{e({message:t.message,stack:t.error&&t.error.stack||null})}catch(n){}}),window.addEventListener("unhandledrejection",function(t){try{e({message:"unhandledrejection",stack:t.reason&&t.reason.stack||String(t.reason)})}catch(n){}})}(),function(){function e(e){return String(e||"event").normalize("NFKD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9._-]+/g,"_").replace(/^_+|_+$/g,"").slice(0,80)||"event"}if(window.saveICS&&!window.__icsSanitized){var t=window.saveICS;window.saveICS=function(n,a){try{n=e(n)}catch(i){}return t(n,a)},window.__icsSanitized=!0}window.__icsSanitize=e}();var m,f,g=window.BP&&BP.Haptics&&BP.Haptics.impact?BP.Haptics.impact:function(){};function b(e,t){localStorage.setItem(e,"string"==typeof t?t:JSON.stringify(t))}function h(e,t){var n=localStorage.getItem(e);if(null==n)return t;try{return JSON.parse(n)}catch(a){return n}}function y(e){localStorage.removeItem(e)}function w(){return localStorage.getItem("bp_token")||sessionStorage.getItem("bp_token")||""}function _(){return h("bp_user",null)||null}function S(){y("bp_token"),sessionStorage.removeItem("bp_token"),y("bp_user"),location.href="/?v=13"}function x(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t.method=t.method||"GET";var n=o({},t.headers||{}),a=w();return a&&(n.Authorization="Bearer "+a),null!=t.body&&"string"!=typeof t.body&&(n["Content-Type"]="application/json; charset=utf-8",t.body=JSON.stringify(t.body)),t.headers=n,fetch(e,t).then(I)}function I(e){return E.apply(this,arguments)}function E(){return(E=d(a().m(function e(t){var n;return a().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,t.text();case 1:if(n=e.v,t.ok){e.n=2;break}throw C(n,t);case 2:return e.a(2,D(n,t))}},e)}))).apply(this,arguments)}function C(e,t){try{var n=JSON.parse(e).error||"";return new Error(n||t.statusText||"HTTP "+t.status)}catch(a){return new Error(t.statusText||"HTTP "+t.status)}}function D(e,t){try{if(-1!==(t.headers.get("content-type")||"").toLowerCase().indexOf("application/json"))return e?JSON.parse(e):{}}catch(n){}return e}function k(e,t){return x(e,Object.assign({method:"GET"},{}))}function T(e,t){return x(e,{method:"POST",body:t||{}})}function B(e){return(e<10?"0":"")+e}function P(e){var t=new Date(e);return B(t.getDate())+"/"+B(t.getMonth()+1)+"/"+t.getFullYear()}function A(e){var t=new Date(e);return t.getFullYear()+"-"+B(t.getMonth()+1)+"-"+B(t.getDate())}function M(e){var t=new Date(e);return B(t.getHours())+":"+B(t.getMinutes())}function N(e){var t=new Date(e);return new Date(t.getFullYear(),t.getMonth(),1)}function L(e){var t=new Date(e);return new Date(t.getFullYear(),t.getMonth()+1,0,23,59,59,999)}function F(e){var t=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate())),n=t.getUTCDay()||7;t.setUTCDate(t.getUTCDate()+4-n);var a=new Date(Date.UTC(t.getUTCFullYear(),0,1));return Math.ceil(((t-a)/864e5+1)/7)}function U(e){var t=new Date(e),n=Math.floor(t.getMonth()/3);return new Date(t.getFullYear(),3*n,1)}function O(e){var t=U(e);return new Date(t.getFullYear(),t.getMonth()+3,0,23,59,59,999)}function V(e){var t=new Date(e),n=t.getMonth()<6?0:6;return new Date(t.getFullYear(),n,1)}function R(e){var t=V(e);return new Date(t.getFullYear(),t.getMonth()+6,0,23,59,59,999)}function j(e){var t=new Date(e);return new Date(t.getFullYear(),0,1)}function z(e){var t=new Date(e);return new Date(t.getFullYear(),11,31,23,59,59,999)}function q(e,t){var n=function(e,t){var n=new Date(e,0,1+7*(t-1)),a=n.getDay()||7,i=new Date(n);return i.setDate(n.getDate()-(a-1)),i.setHours(0,0,0,0),i}(e,t),a=new Date(n);return a.setDate(n.getDate()+6),a.setHours(23,59,59,999),{start:n,end:a}}function G(e){var t=function(e){var t=new Date(e);t.setHours(0,0,0,0);var n=(t.getDay()+6)%7;return t.setDate(t.getDate()-n),t}(e);t.setDate(t.getDate()+7);var n=new Date(t);return n.setDate(t.getDate()+6),n.setHours(23,59,59,999),{start:t,end:n}}function H(e,t){var n=new Date(t);return"settimanale"===e?"Sett. "+F(new Date(t))+" "+n.getFullYear():"mensile"===e?n.toLocaleString("it-IT",{month:"long",year:"numeric"}):"trimestrale"===e?"Trimestre "+(Math.floor(n.getMonth()/3)+1)+" "+n.getFullYear():"semestrale"===e?(n.getMonth()<6?"1Â°":"2Â°")+" semestre "+n.getFullYear():"annuale"===e?"Anno "+n.getFullYear():"ytd"===e?"YTD "+n.getFullYear():"ltm"===e?"Ultimi 12 mesi":e}function Y(e){var t=(f||(f=document.getElementById("toast-container"))||((f=document.createElement("div")).id="toast-container",f.setAttribute("role","status"),f.setAttribute("aria-live","polite"),document.body.appendChild(f)),f),n=document.createElement("div");n.className="toast",n.setAttribute("role","alert"),n.textContent=e,t.appendChild(n),setTimeout(function(){try{n.remove(),t.children.length||(t.remove(),f=null)}catch(e){}},2200)}function W(){if(!window.matchMedia||!window.matchMedia("(prefers-reduced-motion: reduce)").matches){var e=document.createElement("div");e.className="confetti",document.body.appendChild(e);for(var t=0;t<26;t++){var n=document.createElement("span");n.style.position="absolute",n.style.left=2+4*t+"%",n.style.top="0",n.style.width="6px",n.style.height="10px",n.style.background="hsl("+14*t+",90%,60%)",n.style.opacity="0.95",e.appendChild(n),function(e,t){setTimeout(function(){e.animate&&e.animate([{transform:"translateY(-20px) rotate(0deg)"},{transform:"translateY(110vh) rotate(540deg)"}],{duration:1200+800*Math.random(),easing:"cubic-bezier(.2,.6,.2,1)"})},t)}(n,35*t)}setTimeout(function(){try{e.remove()}catch(t){}},2500)}}function J(e){return String(e).replace(/[&<>'"]/g,function(e){return{"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"}[e]})}function Z(e){return(Number(e)||0).toLocaleString("it-IT")+"â‚¬"}function $(e){var t=Number(e)||0;return String(Math.round(t))}function X(){var e=_();if(!e)return"";var t="admin"===e.role;return'<div class="topbar"><div class="brand"><button class="hamb" id="hamb" aria-label="Apri menu" aria-controls="drawer" aria-expanded="false"><span></span><span></span><span></span></button><div class="logo">BATTLE PLAN</div></div><div class="nav right">'+('<span class="badge">Lvl '+(window.level?window.level():"")+" Â· XP "+(window.getXP?window.getXP():"")+"</span>")+'<button class="ghost" onclick="viewHome()">Dashboard</button><button class="ghost" onclick="viewCalendar()">Calendario</button><button class="ghost" onclick="viewPeriods()">BP</button><button class="ghost" onclick="viewAppointments()">Appuntamenti</button><button class="ghost" onclick="viewLeaderboard()">Classifiche</button><button class="ghost" onclick="viewCommissions()">Provvigioni</button><button class="ghost" onclick="viewVendite()">Vendite e Riordini</button><button class="ghost" onclick="viewGI()">GI &amp; Scadenzario</button><button class="ghost" onclick="viewReport()">Report</button><button class="ghost" onclick="viewClients()">Clienti</button><button class="ghost" onclick="viewTeam()">Squadra</button>'+(t?'<button class="ghost" onclick="viewUsers()">Utenti</button>':"")+'<button onclick="logout()">Logout</button></div></div>'+('<div id="drawer" class="drawer" role="dialog" aria-modal="true" aria-label="Menu"><div class="row"><button class="ghost" onclick="viewHome();toggleDrawer(false)">Dashboard</button><button class="ghost" onclick="viewCalendar();toggleDrawer(false)">Calendario</button><button class="ghost" onclick="viewPeriods();toggleDrawer(false)">BP</button><button class="ghost" onclick="viewAppointments();toggleDrawer(false)">Appuntamenti</button><button class="ghost" onclick="viewLeaderboard();toggleDrawer(false)">Classifiche</button><button class="ghost" onclick="viewCommissions();toggleDrawer(false)">Provvigioni</button><button class="ghost" onclick="viewVendite();toggleDrawer(false)">Vendite e Riordini</button><button class="ghost" onclick="viewGI();toggleDrawer(false)">GI &amp; Scadenzario</button><button class="ghost" onclick="viewReport();toggleDrawer(false)">Report</button><button class="ghost" onclick="viewClients();toggleDrawer(false)">Clienti</button><button class="ghost" onclick="viewTeam();toggleDrawer(false)">Squadra</button>'+(t?'<button class="ghost" onclick="viewUsers();toggleDrawer(false)">Utenti</button>':"")+'<button onclick="logout()">Logout</button></div></div>')}function K(){if(_()){if(!document.getElementById("bp_nav_contrast_css")){var e=document.createElement("style");e.id="bp_nav_contrast_css",e.textContent="\n      @media (min-width: 1024px){\n        .topbar .nav .ghost{\n          background: rgba(255,255,255,.06);\n          border: 1px solid rgba(255,255,255,.18);\n        }\n        .topbar .nav .ghost:hover{\n          background: rgba(255,255,255,.12);\n        }\n      }\n    ",document.head.appendChild(e)}var t=document.getElementById("app"),n=document.querySelector(".topbar"),a=X();n?n.outerHTML=a:t&&t.insertAdjacentHTML("afterbegin",a);try{!function(){if(!document.getElementById("bp-mobile-drawer-fix")){var e=document.createElement("style");e.id="bp-mobile-drawer-fix",e.textContent="\n  @media (max-width:980px){\n    .topbar{\n      background: rgba(20,24,34,.90) !important;\n      border-bottom: 1px solid rgba(255,255,255,.08) !important;\n    }\n    .drawer{\n      background: rgba(20,24,34,.96) !important;\n      box-shadow: 14px 0 28px rgba(0,0,0,.45) !important;\n      width: 86vw !important;\n      overflow-y: auto !important;\n    }\n    .drawer .row{ gap:10px !important; }\n    .drawer button{\n      background: rgba(255,255,255,.10) !important;\n      border: 1px solid rgba(255,255,255,.22) !important;\n      color: #fff !important;\n      padding: 12px 14px !important;\n      font-weight: 700 !important;\n      border-radius: 12px !important;\n      -webkit-tap-highlight-color: transparent;\n    }\n    .drawer button:hover{\n      background: rgba(255,255,255,.14) !important;\n      border-color: rgba(255,255,255,.30) !important;\n    }\n    .drawer button.ghost{\n      background: rgba(255,255,255,.10) !important;\n      box-shadow: none !important;\n    }\n  }",document.head.appendChild(e)}}()}catch(l){}try{!function(){if(!document.getElementById("bp-mobile-light-fix")){var e=document.createElement("style");e.id="bp-mobile-light-fix",e.textContent="\n    @media (max-width:980px) and (prefers-color-scheme: light){\n      .topbar{\n        background:#fff !important;\n        border-bottom:1px solid rgba(0,0,0,.08) !important;\n        box-shadow:none !important;\n      }\n      .topbar .brand .logo{\n        color:#0f172a !important;\n        font-weight:900 !important;\n        letter-spacing:.4px;\n        text-shadow:none !important;\n        opacity:1 !important;\n      }\n      .topbar .hamb span{ background:#0f172a !important; }\n      .card{\n        background:#fff !important;\n        background-image:none !important;\n        box-shadow:none !important;\n      }\n      .drawer{\n        background:#fff !important;\n        box-shadow:14px 0 28px rgba(0,0,0,.10) !important;\n      }\n      .drawer button{\n        color:#0f172a !important;\n        background:rgba(0,0,0,.04) !important;\n        border:1px solid rgba(0,0,0,.12) !important;\n      }\n      .drawer button:hover{\n        background:rgba(0,0,0,.08) !important;\n      }\n    }\n  ",document.head.appendChild(e)}}()}catch(s){}try{!function(){if(!document.getElementById("bp-badge-light-css")){var e=document.createElement("style");e.id="bp-badge-light-css",e.textContent="\n    @media (prefers-color-scheme: light){\n      .badge{\n        background: linear-gradient(180deg, #eef2ff, #f8fafc) !important;\n        border: 1px solid #c7d2fe !important;\n        color: #0f172a !important;\n        font-weight: 700 !important;\n        padding: 6px 10px !important;\n        border-radius: 9999px !important;\n        letter-spacing: .2px !important;\n        box-shadow: 0 1px 0 rgba(15,23,42,.05) inset !important;\n      }\n      .chip, .tag{\n        background: #ffffff !important;\n        border: 1px solid #cbd5e1 !important;\n        color: #0f172a !important;\n        font-weight: 600 !important;\n        border-radius: 9999px !important;\n      }\n      .card .badge{\n        background: #fff !important;\n      }\n    }\n  ",document.head.appendChild(e)}}()}catch(d){}if(!document.getElementById("bp-unified-filters-css")){var i=document.createElement("style");i.id="bp-unified-filters-css",i.textContent="\n      /* Nested inputs align in two columns inside unified filters */\n      .uf .row .row{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }\n\n      @media (max-width: 980px){\n        .uf input, .uf select{ min-width: 0; width: 100%; }\n        .uf .row > div{ flex: 1 1 180px; min-width: 0; }\n\n        /* Squadra admin bar: grid on small screens */\n        #t_adminbar{ display:grid !important; grid-template-columns: 1fr 1fr; align-items:end; gap:10px; }\n        #t_adminbar > div{ min-width: 0; }\n        #t_adminbar .row{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }\n      }\n\n      @media (max-width: 560px){\n        #t_adminbar{ grid-template-columns: 1fr; }\n      }\n    ",document.head.appendChild(i)}var r=document.getElementById("hamb");r&&(r.onclick=function(){ee()});var o=document.getElementById("drawer");o&&o.addEventListener("click",function(e){"drawer"===e.target.id&&ee(!1)}),document.removeEventListener("keydown",Q,!1),document.addEventListener("keydown",Q,!1)}}function Q(e){if(e&&"Escape"===e.key){var t=document.getElementById("drawer");t&&t.classList.contains("open")&&ee(!1)}}function ee(e){var t=document.getElementById("drawer");if(t){var n="boolean"==typeof e?e:!t.classList.contains("open");t.classList.toggle("open",n);var a=document.getElementById("hamb");a&&a.setAttribute("aria-expanded",String(n)),document.body.classList.toggle("no-scroll",n)}}!function(){function e(e){return String(e||"").replace(/[&<>'"]/g,function(e){return{"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"}[e]})}function i(e){if(window.showOverlay)window.showOverlay(e);else{var t=document.createElement("div");t.id="bp_overlay",t.innerHTML=e,document.body.appendChild(t)}}function r(){if(window.hideOverlay)window.hideOverlay();else{var e=document.getElementById("bp_overlay");e&&e.remove()}}function l(e){return s.apply(this,arguments)}function s(){return(s=d(a().m(function e(t){var n,i,r,o;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,N("/api/clients");case 1:return n=e.v,i=n&&n.clients||[],r=String(t||"").trim().toLowerCase(),o=i.find(function(e){return String(e.name||"").trim().toLowerCase()===r}),e.a(2,o?o.id:null);case 2:return e.p=2,e.v,e.a(2,null)}},e,null,[[0,2]])}))).apply(this,arguments)}function u(e,t){return p.apply(this,arguments)}function p(){return(p=d(a().m(function e(t,n){var i,r,o,s;return a().w(function(e){for(;;)switch(e.n){case 0:if(Number(n)>0){e.n=1;break}return e.a(2,null);case 1:if(i=new Date(t.end||t.start||Date.now()).toISOString(),r=t.clientId||null){e.n=3;break}return e.n=2,l(t.client);case 2:r=e.v;case 3:return o={date:i,vssTotal:Number(n)||0,services:t.services||"",consultantId:t.userId||(JSON.parse(localStorage.getItem("user")||"{}")||{}).id,clientId:r||void 0,clientName:t.client||void 0},e.n=4,F("/api/gi",o);case 4:return s=e.v,e.a(2,s&&(s.id||s.sale&&s.sale.id)||null)}},e)}))).apply(this,arguments)}function v(e){return m.apply(this,arguments)}function m(){return(m=d(a().m(function t(n){var o,l,s,c,u,p;return a().w(function(t){for(;;)switch(t.p=t.n){case 0:if("function"!=typeof viewGI||!document.querySelector("#gi_rows")){t.n=1;break}return document.dispatchEvent(new CustomEvent("gi:edit",{detail:{id:n}})),t.a(2);case 1:if("function"!=typeof viewGI){t.n=2;break}try{viewGI()}catch(v){}return setTimeout(function(){return document.dispatchEvent(new CustomEvent("gi:edit",{detail:{id:n}}))},350),t.a(2);case 2:return t.p=2,u=function(t){var n=c("pb_rates");if(!t||!t.length)return n.textContent="Nessuna rata",void(n._data=[]);n.innerHTML=t.map(function(t){var n=new Date(t.dueDate).toLocaleDateString("it-IT");return"<div>".concat(n," Â· ").concat(Number(t.amount||0).toLocaleString("it-IT"),'â‚¬ <span class="muted">').concat(e(t.note||""),"</span></div>")}).join(""),n._data=t},t.n=3,N("/api/gi?from=1900-01-01&to=2999-12-31");case 3:if(o=t.v,l=(o&&o.sales||[]).find(function(e){return String(e.id)===String(n)})){t.n=4;break}return A("Vendita non trovata"),t.a(2);case 4:s=(new Date).toISOString().slice(0,10),i('<div class="bp-modal"><div class="hd"><b>Builder pagamenti â€“ '+e(l.clientName||"Cliente")+'</b><button class="ghost" id="pb_x">Chiudi</button></div><div class="bd"><div class="row"><div style="flex:1"><label>Totale VSS</label><input id="pb_vss" type="number" value="'+Number(l.vssTotal||0)+'"></div></div><div class="row" style="margin-top:8px;gap:12px"><div><label>Regola rapida</label><select id="pb_rule"><option value="0">Manuale</option><option value="50-25-25">50% + 25% / 30-60gg</option><option value="20+12">20% + 12 rate mensili</option></select></div><div><label>Prima scadenza</label><input id="pb_first" type="date" value="'+s+'"></div></div><div style="margin-top:8px"><label>Rate</label><div id="pb_rates" class="small muted">Nessuna rata</div></div><div class="right"><button class="ghost" id="pb_apply">Ricalcola</button><button id="pb_save">Salva</button></div></div></div>'),c=function(e){return document.getElementById(e)},c("pb_apply").onclick=function(){var e=c("pb_rule").value||"0",t=Math.max(0,Number(c("pb_vss").value||0)),n=new Date(c("pb_first").value||new Date),a=[],i=function(e,t,n){return a.push({dueDate:new Date(e).toISOString(),amount:Math.round(t),note:n||""})};if("50-25-25"===e){i(n,.5*t,"Acconto 50%");var r=new Date(n);r.setDate(r.getDate()+30),i(r,.25*t,"Saldo 25% a 30gg");var o=new Date(n);o.setDate(o.getDate()+60),i(o,.25*t,"Saldo 25% a 60gg")}else if("20+12"===e){i(n,.2*t,"Acconto 20%");for(var l=.8*t/12,s=0;s<12;s++){var d=new Date(n);d.setMonth(d.getMonth()+s+1),i(d,l,"Rata "+(s+1)+"/12")}}u(a)},c("pb_save").onclick=d(a().m(function e(){var t,n,i;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:return t=Math.max(0,Number(c("pb_vss").value||0)),n=c("pb_rates")._data||[],e.p=1,e.n=2,F("/api/gi",{id:l.id,vssTotal:t,schedule:n});case 2:try{document.dispatchEvent(new CustomEvent("payments:defined",{detail:{id:l.id,vssTotal:t,schedule:n}}))}catch(v){}A("Piano pagamenti salvato"),r(),e.n=4;break;case 3:e.p=3,i=e.v,logger.error(i),A("Errore salvataggio");case 4:return e.a(2)}},e,null,[[1,3]])})),c("pb_x").onclick=r,t.n=6;break;case 5:t.p=5,p=t.v,logger.error(p);case 6:return t.a(2)}},t,null,[[2,5]])}))).apply(this,arguments)}function f(t){var n=t.client||"Cliente",o=Number(t.vss||t.vsdPersonal||0)||0;i('<div class="bp-modal"><div class="hd"><b>VSS per '+e(n)+'</b><button class="ghost" id="qvss_x">Chiudi</button></div><div class="bd"><div><label>Valore VSS</label><input id="qvss_val" type="number" step="1" value="'+o+'"></div><div class="small muted" style="margin-top:6px">Modifica consentita solo per VSS</div><div class="right"><button id="qvss_ok">Salva</button></div></div></div>'),document.getElementById("qvss_x").onclick=r,document.getElementById("qvss_ok").onclick=d(a().m(function e(){var n,i,o;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,n=Math.max(0,Number(document.getElementById("qvss_val").value||0)),e.n=1,F("/api/appointments",{id:t.id,vss:n});case 1:return e.n=2,u(t,n);case 2:i=e.v,r(),A("VSS salvato"),i&&v(i);try{i&&document.dispatchEvent(new CustomEvent("gi:created",{detail:{id:i}}))}catch(a){}document.dispatchEvent(new Event("bp:saved")),e.n=4;break;case 3:e.p=3,o=e.v,logger.error(o),A("Errore salvataggio VSS");case 4:return e.a(2)}},e,null,[[0,3]])}))}function b(){return b=d(a().m(function e(t){var n;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,!t.nncf){e.n=2;break}return e.n=1,function(){var e=d(a().m(function e(){var n,i,r,o;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,N("/api/clients");case 1:if(n=e.v,i=n&&n.clients||[],r=String(t.client||"").trim().toLowerCase(),!(o=i.find(function(e){return String(e.name||"").trim().toLowerCase()===r}))){e.n=2;break}return e.n=2,F("/api/clients",{id:o.id,status:"attivo"});case 2:e.n=4;break;case 3:e.p=3,e.v;case 4:return e.a(2)}},e,null,[[0,3]])}));return function(){return e.apply(this,arguments)}}()();case 1:document.dispatchEvent(new Event("client:converted"));case 2:f(t),e.n=4;break;case 3:e.p=3,n=e.v,logger.error(n);case 4:return e.a(2)}},e,null,[[0,3]])})),b.apply(this,arguments)}function h(){return(h=d(a().m(function e(t){var n,i,r,o,l;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,!t.nncf){e.n=5;break}return e.p=1,e.n=2,N("/api/clients");case 2:if(n=e.v,i=n&&n.clients||[],r=String(t.client||"").trim().toLowerCase(),!(o=i.find(function(e){return String(e.name||"").trim().toLowerCase()===r}))){e.n=3;break}return e.n=3,F("/api/clients",{id:o.id,status:"lead non chiuso"});case 3:e.n=5;break;case 4:e.p=4,e.v;case 5:return e.n=6,F("/api/appointments",{id:t.id,vss:0});case 6:A("Ok, segnato come non venduto"),e.n=8;break;case 7:e.p=7,l=e.v,logger.error(l),A("Errore aggiornamento");case 8:return e.a(2)}},e,null,[[1,4],[0,7]])}))).apply(this,arguments)}function y(e){for(var t=0,n=["#".concat(e,"_mode"),"#dash_mode","#comm_mode",'[data-scope="'.concat(e,'"] [name="mode"]'),"#".concat(e,' select[name="mode"]'),'#dashboard select[name="mode"]','select[name="mode"]'];t<n.length;t++){var a=n[t],i=document.querySelector(a);if(i&&i.value)return i.value}return"consuntivo"}if(window.bpAuthToken||(window.bpAuthToken=function(){try{var e=localStorage.getItem("bp_user")||sessionStorage.getItem("bp_user");if(e)try{var t=JSON.parse(e);if(t&&(t.token||t.jwt||t.accessToken))return t.token||t.jwt||t.accessToken}catch(p){}}catch(p){}for(var n=0,a=["bp_token","authToken","token","jwt","accessToken","id_token","auth","authorization","session","user"];n<a.length;n++){var i=a[n];try{var r=localStorage.getItem(i)||sessionStorage.getItem(i);if(!r)continue;try{var o=JSON.parse(r);if(o&&(o.token||o.jwt||o.accessToken))return o.token||o.jwt||o.accessToken}catch(p){}if(/^[A-Za-z0-9\-_]+\.[A-Za-z0-9\-_]+\.[A-Za-z0-9\-_]+$/.test(r))return r}catch(p){}}try{for(var l=0;l<localStorage.length;l++){var s=localStorage.key(l),d=localStorage.getItem(s);if(d){try{var c=JSON.parse(d);if(c&&(c.token||c.jwt||c.accessToken))return c.token||c.jwt||c.accessToken}catch(p){}if(/^[A-Za-z0-9\-_]+\.[A-Za-z0-9\-_]+\.[A-Za-z0-9\-_]+$/.test(d))return d}}}catch(p){}try{var u=JSON.parse(localStorage.getItem("user")||"{}");if(u&&(u.token||u.jwt||u.accessToken))return u.token||u.jwt||u.accessToken}catch(p){}return null}),window.GET||(window.GET=function(){var e=d(a().m(function e(t){var n,i,r,l,s;return a().w(function(e){for(;;)switch(e.n){case 0:return n=window.bpAuthToken&&window.bpAuthToken()||null,e.n=1,fetch(t,{headers:o({Accept:"application/json"},n?{Authorization:"Bearer "+n}:{})});case 1:if(204!==(i=e.v).status){e.n=2;break}return e.a(2,null);case 2:if((i.headers.get("content-type")||"").includes("application/json")){e.n=4;break}return r=i.ok,l=i.status,e.n=3,i.text();case 3:return s=e.v,e.a(2,{ok:r,status:l,text:s});case 4:return e.a(2,i.json())}},e)}));return function(t){return e.apply(this,arguments)}}()),window.POST||(window.POST=function(){var e=d(a().m(function e(t,n){var i,r,l,s,d;return a().w(function(e){for(;;)switch(e.n){case 0:return i=window.bpAuthToken&&window.bpAuthToken()||null,e.n=1,fetch(t,{method:"POST",headers:o({"Content-Type":"application/json"},i?{Authorization:"Bearer "+i}:{}),body:JSON.stringify(n||{})});case 1:if(204!==(r=e.v).status){e.n=2;break}return e.a(2,null);case 2:if((r.headers.get("content-type")||"").includes("application/json")){e.n=4;break}return l=r.ok,s=r.status,e.n=3,r.text();case 3:return d=e.v,e.a(2,{ok:l,status:s,text:d});case 4:return e.a(2,r.json())}},e)}));return function(t,n){return e.apply(this,arguments)}}()),"undefined"!=typeof window&&"function"==typeof window.initPostSaleBanners&&window.initPostSaleBanners(g),function(){if(!document.getElementById("bp-qvss-css")){var e=document.createElement("style");e.id="bp-qvss-css",e.textContent='\n    #bp_overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);\n      display:flex;align-items:center;justify-content:center;z-index:9999;padding:16px}\n    .bp-modal{max-width:620px;width:clamp(300px,92vw,620px);background:var(--card,#fff);\n      color:var(--text,#111);border-radius:14px;border:1px solid rgba(0,0,0,.12);\n      box-shadow:0 12px 34px rgba(0,0,0,.35)}\n    .bp-modal .hd{display:flex;align-items:center;justify-content:space-between;padding:12px 14px}\n    .bp-modal .bd{padding:10px 14px 14px}\n    .bp-modal .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}\n    .bp-modal .right{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}\n    .bp-modal input[type="number"], .bp-modal input[type="date"], .bp-modal select, .bp-modal textarea{\n      width:100%;padding:8px;border:1px solid rgba(0,0,0,.18);border-radius:10px}\n    @media (prefers-color-scheme:dark){\n      .bp-modal{background:rgba(15,18,28,.98);color:#fff;border-color:rgba(255,255,255,.14)}\n      .bp-modal input, .bp-modal select, .bp-modal textarea{background:rgba(255,255,255,.04);color:#fff;border-color:rgba(255,255,255,.18)}\n    }\n  ',document.head.appendChild(e)}}(),window.pipelineYes=function(e){return b.apply(this,arguments)},window.pipelineNo=function(e){return h.apply(this,arguments)},function(){function e(e){try{document.documentElement.style.overflow=e?"hidden":""}catch(t){}}function t(e){return n.apply(this,arguments)}function n(){return(n=d(a().m(function e(t){var n,i,r,o;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:if(t){e.n=1;break}return e.a(2,null);case 1:return e.p=1,e.n=2,N("/api/clients");case 2:return n=e.v,i=n&&n.clients||[],r=String(t).trim().toLowerCase(),o=i.find(function(e){return String(e.name||"").trim().toLowerCase()===r}),e.a(2,o?o.id:null);case 3:return e.p=3,e.v,e.a(2,null)}},e,null,[[1,3]])}))).apply(this,arguments)}function i(e,t){return r.apply(this,arguments)}function r(){return(r=d(a().m(function e(n,i){var r;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.n=1,t(n);case 1:if(r=e.v){e.n=2;break}return e.a(2);case 2:return e.p=2,e.n=3,F("/api/clients",{id:r,status:i});case 3:e.n=5;break;case 4:e.p=4,e.v;case 5:return e.a(2)}},e,null,[[2,4]])}))).apply(this,arguments)}function o(e,t){return l.apply(this,arguments)}function l(){return(l=d(a().m(function e(t,n){return a().w(function(e){for(;;)if(0===e.n)return e.a(2,F("/api/appointments",{id:t,vss:Math.max(0,Number(n||0))}))},e)}))).apply(this,arguments)}function s(e,t){return c.apply(this,arguments)}function c(){return(c=d(a().m(function e(n,i){var r,o,l;return a().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,t(n.client||"");case 1:return r=e.v,o={date:new Date(n.end||n.start||Date.now()).toISOString(),clientId:r||void 0,clientName:n.client||"",vssTotal:Math.max(0,Number(i||0)),services:n.services||"",schedule:[]},e.n=2,F("/api/gi",o);case 2:return l=e.v,e.a(2,l&&(l.id||l.sale&&l.sale.id||Array.isArray(l.sales)&&l.sales[0]&&l.sales[0].id)||null)}},e)}))).apply(this,arguments)}function u(e){return p.apply(this,arguments)}function p(){return(p=d(a().m(function e(t){var n;return a().w(function(e){for(;;)switch(e.n){case 0:if(t){e.n=1;break}return e.a(2);case 1:try{"function"==typeof window.viewGI&&window.viewGI()}catch(a){}n=0,function e(){if(document.getElementById("gi_rows")||n>40)try{var i=new CustomEvent("gi:edit",{detail:{id:t}});document.dispatchEvent(i)}catch(a){}else n++,setTimeout(e,100)}();case 2:return e.a(2)}},e)}))).apply(this,arguments)}function v(t,n){!function(){if(!document.getElementById("bp-center-css")){var e=document.createElement("style");e.id="bp-center-css",e.textContent="\n      #bp_overlay{display:flex;align-items:center;justify-content:center}\n      .bp-modal-card{min-width:min(560px,96vw);max-width:680px;max-height:86vh;overflow:auto}\n      @media (max-width:640px){ .bp-modal-card{min-width:96vw} }\n      .bp-modal-foot{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}\n    ",document.head.appendChild(e)}}(),e(!0);var i,r=Math.max(0,Number(t.vss||0)),l='<div class="modal"><div class="card bp-modal-card"><div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><b>VSS per '+(t.client?(i=t.client,String(i||"").replace(/[&<>'"]/g,function(e){return{"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"}[e]})):"appuntamento")+'</b><button class="ghost" id="qvss_x">Chiudi</button></div><div style="margin-top:8px"><label>Valore VSS</label><input id="qvss_val" type="number" step="1" value="'+r+'"><div class="small muted" style="margin-top:6px">Modifica consentita solo per VSS</div></div><div class="bp-modal-foot"><button id="qvss_ok">Salva</button></div></div></div>';function c(){e(!1),hideOverlay()}showOverlay(l);var p=document.getElementById("qvss_val");document.getElementById("qvss_x").onclick=c,document.getElementById("qvss_ok").onclick=d(a().m(function e(){var n,i,r;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,n=Math.max(0,Number(p.value||0)),e.n=1,o(t.id,n);case 1:return e.n=2,s(t,n);case 2:if(i=e.v,c(),i)try{document.dispatchEvent(new CustomEvent("gi:created",{detail:{id:i}}))}catch(a){}"function"==typeof window.coachSay&&ie("medium"),u(i),e.n=4;break;case 3:e.p=3,r=e.v,logger.error(r),A("Errore salvataggio VSS");case 4:return e.a(2)}},e,null,[[0,3]])}))}window.pipelineYes=function(){var e=d(a().m(function e(t){var n;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,!t.nncf){e.n=1;break}return e.n=1,i(t.client,"cliente");case 1:v(t),e.n=3;break;case 2:e.p=2,n=e.v,logger.error(n);case 3:return e.a(2)}},e,null,[[0,2]])}));return function(t){return e.apply(this,arguments)}}(),window.pipelineNo=function(){var e=d(a().m(function e(t){var n;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,!t.nncf){e.n=1;break}return e.n=1,i(t.client,"lead non chiuso");case 1:return e.n=2,o(t.id,0);case 2:g("light"),A("Segnato VSS 0"),e.n=4;break;case 3:e.p=3,n=e.v,logger.error(n);case 4:return e.a(2)}},e,null,[[0,3]])}));return function(t){return e.apply(this,arguments)}}()}(),function(){function e(e){return encodeURIComponent(String(e||""))}function t(){try{var e=document.getElementById("rep_label");if(e&&e.textContent)return e.textContent.trim()}catch(r){}var t=(document.getElementById("rep_type")||{}).value||"mensile",n=new Date,a=String(n.getMonth()+1).padStart(2,"0"),i=n.getFullYear();return"settimanale"===t?"Settimana ISO "+(isoWeekNum?isoWeekNum(n):"corrente")+" "+i:"trimestrale"===t?"Q"+(Math.floor(n.getMonth()/3)+1)+" "+i:"semestrale"===t?"Semestre "+(n.getMonth()<6?"1Â°":"2Â°")+" "+i:"annuale"===t?"Anno "+i:"Mese "+a+"/"+i}function n(){return i.apply(this,arguments)}function i(){return(i=d(a().m(function e(){var t,n;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,N("/api/usernames");case 1:return t=e.v,n=t&&t.users||[],e.a(2,n.map(function(e){return e.email}).filter(Boolean).join(","));case 2:return e.p=2,e.v,e.a(2,"")}},e,null,[[0,2]])}))).apply(this,arguments)}function r(){var e=document.getElementById("report_subject");return e&&e.value&&e.value.trim()?e.value.trim():"Report BP â€“ "+t()}function o(){var e=document.getElementById("report_body");return e&&e.value&&e.value.trim()?e.value:"Ciao,\n\ndi seguito il report del periodo "+t()+".\n\nâ€“ VSS\nâ€“ VSD\nâ€“ GI\nâ€“ NNCF\n\nA presto."}function l(){return(l=d(a().m(function t(){var i,l,s,d,c;return a().w(function(t){for(;;)switch(t.p=t.n){case 0:if(i=document.getElementById("rep_gmail_web"),l=document.getElementById("rep_gmail_app"),i||l){t.n=1;break}return t.a(2);case 1:return t.n=2,n();case 2:return s=t.v,d=r(),c=o(),t.p=3,t.n=4,navigator.clipboard.writeText(c);case 4:t.n=6;break;case 5:t.p=5,t.v;case 6:i&&(i.onclick=function(){var t="https://mail.google.com/mail/?view=cm&fs=1&tf=1&su="+e(d)+"&cc="+e(s)+"&body="+e(c);window.open(t,"_blank");try{document.dispatchEvent(new Event("report:composed"))}catch(n){}}),l&&(l.onclick=function(){var t="googlegmail:///co?subject="+e(d)+"&cc="+e(s)+"&body="+e(c);location.href=t;try{document.dispatchEvent(new Event("report:composed"))}catch(n){}setTimeout(function(){if(!document.hidden){location.href="mailto:?subject="+e(d)+"&cc="+e(s)+"&body="+e(c);try{document.dispatchEvent(new Event("report:composed"))}catch(n){}}},1200)});case 7:return t.a(2)}},t,null,[[3,5]])}))).apply(this,arguments)}window.wireReportButtons=function(){return l.apply(this,arguments)}}(),function(){function e(e){for(var t,n,a=(t=new Date,(n=t instanceof Date?t:new Date(t||Date.now())).getFullYear()+"-"+("0"+(n.getMonth()+1)).slice(-2)+"-"+("0"+n.getDate()).slice(-2)),i=e.querySelectorAll("[data-date], [data-day]"),r=0;r<i.length;r++){var o=i[r],l=o.getAttribute("data-date")||o.getAttribute("data-day")||"";if(l)String(l).slice(0,10)===a&&o.classList.add("today")}}function t(){var t=document.getElementById("calendar")||document.querySelector(".calendar")||document;e(t),function(e){if("function"!=typeof window.attachICSButtons)for(var t=e.querySelectorAll("[data-appt], [data-start][data-title], .appt, .calendar-appt"),n=0;n<t.length;n++){var a=t[n];if(!a.querySelector(".bp-ics")){var i=a.getAttribute("data-start")||"",r=a.getAttribute("data-end")||"",o=a.getAttribute("data-title")||a.getAttribute("data-client")||"Appuntamento";if(i){var l=document.createElement("a");l.href="#",l.className="bp-ics btn-ics",l.textContent="ðŸ“…",l.style.marginLeft="6px",l.onclick=function(e){e.preventDefault();try{var t=e.currentTarget.parentElement||document.body,n=t.getAttribute("data-start")||i,a=t.getAttribute("data-end")||r||n,l=t.getAttribute("data-title")||t.getAttribute("data-client")||o,s=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//BP//Calendar//IT","BEGIN:VEVENT","UID:"+Date.now()+"@bp","DTSTAMP:"+(new Date).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z"),"DTSTART:"+new Date(n).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z"),"DTEND:"+new Date(a).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z"),"SUMMARY:"+l,"END:VEVENT","END:VCALENDAR"].join("\r\n"),d=new Blob([s],{type:"text/calendar"}),c=URL.createObjectURL(d),u=document.createElement("a");u.href=c,u.download=(l||"appuntamento")+".ics",document.body.appendChild(u),u.click(),setTimeout(function(){URL.revokeObjectURL(c);try{u.remove()}catch(e){}},0)}catch(p){logger.error(p)}},a.appendChild(l)}}}else try{window.attachICSButtons(e)}catch(s){logger.error(s)}}(t)}window.hookCalendar=t,function(e){if("complete"===document.readyState||"interactive"===document.readyState)return e();document.addEventListener("DOMContentLoaded",e,{once:!0})}(t);var n=document.getElementById("calendar")||document.querySelector(".calendar");n&&!n.__bpCalObs&&(n.__bpCalObs=!0,new MutationObserver(function(){try{t()}catch(e){}}).observe(n,{childList:!0,subtree:!0}))}(),function(){var e=!1;function t(){if(!e){e=!0;var t=document.createElement("style");t.setAttribute("data-bp-today","1"),t.textContent='.today{outline:2px solid var(--accent, #5dd3ff); outline-offset:-2px; border-radius:8px; position:relative;}.today::after{content:"OGGI"; position:absolute; top:6px; right:8px; font-size:10px; font-weight:700; color:#fff; background:var(--accent, #5dd3ff); padding:2px 6px; border-radius:6px;}',document.head.appendChild(t)}}window.injectTodayCSS=t,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",t,{once:!0}):t()}(),function(){function e(){var e=function(){try{return JSON.parse(localStorage.getItem("user")||"{}")}catch(e){return{}}}();return e&&"admin"===e.role}function t(e,t){return(t||document).querySelector(e)}function i(e,t){return Array.prototype.slice.call((t||document).querySelectorAll(e))}function r(){return o.apply(this,arguments)}function o(){return(o=d(a().m(function e(){var t,n,i,r,o,l,s,d;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,N("/api/appointments");case 1:t=e.v,n=t&&t.appointments||[],i={},r=0;case 2:if(!(r<n.length)){e.n=5;break}if(o=n[r],l=String(o.client||"").trim().toLowerCase()){e.n=3;break}return e.a(3,4);case 3:s=new Date(o.start||o.end||0).getTime(),(!i[l]||s>i[l])&&(i[l]=s);case 4:r++,e.n=2;break;case 5:return e.a(2,i);case 6:return e.p=6,d=e.v,logger.error(d),e.a(2,{})}},e,null,[[0,6]])}))).apply(this,arguments)}function l(){return s.apply(this,arguments)}function s(){return(s=d(a().m(function e(){var n,o;return a().w(function(e){for(;;)switch(e.n){case 0:if(n=document.getElementById("cl_list")){e.n=1;break}return e.a(2);case 1:return e.n=2,r();case 2:o=e.v,i(".card",n).forEach(function(e){var n=t("b",e);if(n){var a=(n.textContent||"").trim().toLowerCase();if(a){var i,r=o[a],l=t(".bp-lastapp",e),s="Ultimo appuntamento: "+(r?!(i=new Date(r))||isNaN(i)?"â€”":("0"+i.getDate()).slice(-2)+"/"+("0"+(i.getMonth()+1)).slice(-2)+"/"+i.getFullYear():"â€”");if(l)l.textContent=s;else{var d=document.createElement("div");d.className="small muted bp-lastapp",d.textContent=s,e.appendChild(d)}}}});case 3:return e.a(2)}},e)}))).apply(this,arguments)}function c(){return u.apply(this,arguments)}function u(){return u=d(a().m(function r(){var o,l,s,c,u,p,v,m;return a().w(function(r){for(;;)switch(r.n){case 0:if(m=function(e){var n=t("b",e),a=(n&&n.textContent||"").trim().toLowerCase();return p.find(function(e){return String(e.name||"").trim().toLowerCase()===a})},e()){r.n=1;break}return r.a(2);case 1:if(o=document.getElementById("cl_list")){r.n=2;break}return r.a(2);case 2:return r.n=3,Promise.all([N("/api/clients"),N("/api/usernames")]);case 3:if(l=r.v,s=n(l,2),c=s[0],u=s[1],p=c&&c.clients||[],v=u&&u.users||[],!o.__bpInlineReady){r.n=4;break}return r.a(2);case 4:o.__bpInlineReady=!0,i(".card",o).forEach(function(e){if(!e.__bpInline){e.__bpInline=!0;var n=m(e);if(n){var r=document.createElement("div");r.style.display="flex",r.style.gap="8px",r.style.marginTop="6px";var o=document.createElement("button");o.className="ghost",o.textContent="Modifica",r.appendChild(o),e.appendChild(r);var l=document.createElement("div");l.style.display="none",l.style.marginTop="8px",l.innerHTML='<div class="row" style="gap:8px"><div><label>Nome</label><input class="bp-ed-name" type="text" value="'+(n.name||"")+'"></div><div><label>Stato</label><select class="bp-ed-state"><option value="prospect" '+("prospect"===n.status?"selected":"")+'>Prospect</option><option value="attivo" '+("attivo"===n.status?"selected":"")+'>Attivo</option><option value="cliente" '+("cliente"===n.status?"selected":"")+'>Cliente</option></select></div><div><label>Consulente</label><select class="bp-ed-consulente"></select></div><div style="align-self:flex-end"><button class="ghost bp-ed-save">Salva</button></div></div>',e.appendChild(l),t(".bp-ed-consulente",l).innerHTML='<option value="">â€”</option>'+v.map(function(e){return'<option value="'+e.id+'" '+(String(n.consultantId||"")===String(e.id)?"selected":"")+">"+(e.name||"User "+e.id)+"</option>"}).join(""),o.onclick=function(){l.style.display="none"===l.style.display?"block":"none"},t(".bp-ed-save",l).onclick=function(){var r=d(a().m(function r(o){var s,d,c,u,p,m;return a().w(function(a){for(;;)switch(a.p=a.n){case 0:return o.preventDefault(),a.p=1,s={id:n.id,name:t(".bp-ed-name",l).value.trim(),status:t(".bp-ed-state",l).value,consultantId:t(".bp-ed-consulente",l).value||null},a.n=2,F("/api/clients",s);case 2:(d=t("b",e))&&(d.textContent=s.name),(c=t(".small",e))&&/Stato:/.test(c.textContent||"")&&(c.innerHTML="Stato: <b>"+s.status+"</b>"),(u=i(".small",e).find(function(e){return/Consulente:/.test(e.textContent||"")}))&&(p=v.find(function(e){return String(e.id)===String(s.consultantId||"")}),u.innerHTML="Consulente: <b>"+(p?p.name||"User "+p.id:"â€”")+"</b>"),g("medium"),a.n=4;break;case 3:a.p=3,m=a.v,logger.error(m),g("heavy");case 4:return a.a(2)}},r,null,[[1,3]])}));return function(e){return r.apply(this,arguments)}}()}}});case 5:return r.a(2)}},r)})),u.apply(this,arguments)}function p(){var e=document.getElementById("cl_list");e&&(l(),c(),e.__bpCliObs||(e.__bpCliObs=!0,new MutationObserver(function(){l(),c()}).observe(e,{childList:!0,subtree:!0})))}window.applyClientsLastAppointment=l,window.ensureClientInlineEdit=c,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",p,{once:!0}):p()}(),!window.__BP_FINAL_READY__){window.__BP_FINAL_READY__=!0;var w=function(e,t){return(t||document).querySelector(e)},_=function(e,t,n){return e&&e.addEventListener(t,n,!1)},S=function(e,t){try{return JSON.parse(e)}catch(n){return t}},x=function(e){return e<10?"0"+e:""+e},I=function(){var e=new Date;return"".concat(e.getFullYear(),"-").concat(x(e.getMonth()+1),"-").concat(x(e.getDate()))};window.drawFullLine&&window.drawFullLine.__patched||(window.drawFullLine=function(e,t,n){var a=document.getElementById(e);if(a){if(window.Chart)try{a.__chart&&"function"==typeof a.__chart.destroy&&a.__chart.destroy();var i={type:"line",data:{labels:t,datasets:[{data:n,tension:.35,pointRadius:2,borderWidth:2}]},options:{responsive:!0,plugins:{legend:{display:!1}},scales:{x:{display:!0},y:{display:!0}}}};return void(a.__chart=new Chart(a.getContext("2d"),i))}catch(r){}O(e,0,n)}},window.drawFullLine.__patched=!0);var E,C,D="undefined"!=typeof window?window.__periodsCache||(window.__periodsCache={}):{};"function"!=typeof window.todayKey&&(window.todayKey=function(){var e=new Date;return e.getFullYear()+"-"+("0"+(e.getMonth()+1)).slice(-2)+"-"+("0"+e.getDate()).slice(-2)}),window.markToday=window.markToday||K,window.clampSlotCounters=window.clampSlotCounters||Q,window.wireICSInsideDayBox=window.wireICSInsideDayBox||function(){try{var e=document.getElementById("cal_day_box");if(!e)return;for(var t=e.querySelectorAll(".cal-app"),n=0;n<t.length;n++){var a=t[n];if(!a.querySelector("[data-ics-inline]")){var i=a.getAttribute("data-start")||"",r=a.getAttribute("data-end")||"";a.getAttribute("data-title")||a.querySelector("b")&&a.querySelector("b").textContent.trim();if(i&&r&&window.BP&&BP.ICS&&"function"==typeof BP.ICS.downloadIcsForAppointment){var o=document.createElement("button");o.className="ghost btn-ics",o.textContent="ðŸ“…",o.setAttribute("data-ics-inline","1"),o.style.marginTop="6px",o.addEventListener("click",function(e){e.stopPropagation();var t=e.currentTarget.parentElement,n=t.getAttribute("data-start"),a=t.getAttribute("data-end"),i={client:t.getAttribute("data-title")||(t.querySelector("b")?t.querySelector("b").textContent.trim():"Appuntamento"),start:n,end:a,type:"manuale",vss:0,vsdPersonal:0,nncf:!1};try{BP.ICS.downloadIcsForAppointment(i),g("medium")}catch(r){}}),a.appendChild(o)}}}}catch(l){}},function(){function e(e){return encodeURIComponent(String(e||""))}function t(){var e=document.getElementById("report_subject");return e&&e.value.trim()||"Report BP"}function n(){var e=document.getElementById("report_body");return e&&e.value||""}function a(){var a=document.getElementById("rep_gmail_web"),i=document.getElementById("rep_gmail_app");(a||i)&&N("/api/users_emails").then(function(e){return e&&Array.isArray(e.emails)?e.emails.filter(Boolean):e&&Array.isArray(e.users)?e.users.map(function(e){return e.email}).filter(Boolean):[]}).catch(function(){return N("/api/usernames").then(function(e){return(e&&e.users||[]).map(function(e){return e.email}).filter(Boolean)}).catch(function(){return[]})}).then(function(r){var o=(r||[]).join(",");a&&(a.onclick=function(){try{navigator.clipboard&&navigator.clipboard.writeText(n())}catch(a){}window.open("https://mail.google.com/mail/?view=cm&fs=1&tf=1&su="+e(t())+"&cc="+e(o)+"&body="+e(n()),"_blank")}),i&&(i.onclick=function(){try{navigator.clipboard&&navigator.clipboard.writeText(n())}catch(a){}location.href="googlegmail:///co?subject="+e(t())+"&cc="+e(o)+"&body="+e(n()),setTimeout(function(){if(!document.hidden){var a="mailto:?subject="+e(t())+"&cc="+e(o)+"&body="+e(n());location.href=a}},1200)})})}(window.BPFinal=window.BPFinal||{}).wireReportButtons=a,window.wireReportButtons||(window.wireReportButtons=a)}(),E={ts:0,map:null},C=null,window.BPFinal=window.BPFinal||{},BPFinal.getLastApptMap=function(){var e=Date.now();return E.map&&e-E.ts<15e3?Promise.resolve(E.map):C||(C=N("/api/appointments?global=1").then(function(e){return function(e){var t,n=Object.create(null),a=c(e||[]);try{for(a.s();!(t=a.n()).done;){var i=t.value,r=String(i.client||"").toLowerCase();if(r){var o=+new Date(i.end||i.start||0);(!n[r]||o>n[r])&&(n[r]=o)}}}catch(l){a.e(l)}finally{a.f()}return n}(e&&e.appointments||[])}).then(function(e){return E={ts:Date.now(),map:e},e}).catch(function(){return{}}).finally(function(){C=null}))},BPFinal.enrichClientCards=function(){var e=document.getElementById("cl_list");e&&BPFinal.getLastApptMap().then(function(t){var n,a=c(e.querySelectorAll(".card[data-clid], .card"));try{for(a.s();!(n=a.n()).done;){var i=n.value,r=i.querySelector("b"),o=(r?r.textContent:i.getAttribute("data-name")||"").trim().toLowerCase(),l=t[o]||0,s=i.querySelector(".last-appt, .client-last");if(s)if(l){var d=new Date(l),u=("0"+d.getDate()).slice(-2),p=("0"+(d.getMonth()+1)).slice(-2),v=d.getFullYear();s.textContent="".concat(u,"/").concat(p,"/").concat(v)}else s.textContent="â€”";i.setAttribute("data-last-ts",String(l||0)),!i.getAttribute("data-name-lower")&&o&&i.setAttribute("data-name-lower",o)}}catch(m){a.e(m)}finally{a.f()}})},BPFinal.enableClientsInlineAdmin=function(){var e=document.getElementById("cl_list");if(e&&!e.__bp_inline_admin_wired){e.__bp_inline_admin_wired=!0;var t=null,n=["attivo","lead non chiuso","potenziale"];e.querySelectorAll(".card[data-clid], .card").forEach(a),new MutationObserver(function(e){var t,n=c(e);try{for(n.s();!(t=n.n()).done;){var i,r=c(t.value.addedNodes);try{for(r.s();!(i=r.n()).done;){var o=i.value;1===o.nodeType&&o.matches(".card[data-clid], .card")&&a(o),1===o.nodeType&&o.querySelectorAll&&o.querySelectorAll(".card[data-clid], .card").forEach(a)}}catch(l){r.e(l)}finally{r.f()}}}catch(l){n.e(l)}finally{n.f()}}).observe(e,{childList:!0,subtree:!0})}function a(e){if(e&&1===e.nodeType&&!e.querySelector("[data-edit-client]")){e.style.position="relative";var a=document.createElement("button");a.className="ghost small",a.textContent="Modifica",a.title="Modifica cliente",a.setAttribute("data-edit-client","1"),a.style.position="absolute",a.style.right="8px",a.style.top="8px",a.style.zIndex="2",a.style.cursor="pointer",e.appendChild(a),a.addEventListener("click",function(){var a=e.getAttribute("data-clid")||e.dataset.clid||"",i=e.querySelector("b"),r=e.querySelector(".cl-status, .client-status"),o=e.querySelector(".cl-cons, .client-owner"),l={name:i?i.textContent.trim():"",status:String(r&&r.textContent||e.getAttribute("data-status")||"potenziale").toLowerCase(),consId:e.getAttribute("data-consultant-id")||"",consText:o?o.textContent:"â€”"},s=document.createElement("input");s.type="text",s.value=l.name,s.style.width="100%",i&&i.replaceWith(s);var d=document.createElement("select");d.innerHTML=n.map(function(e){return'<option value="'.concat(e,'">').concat(e.charAt(0).toUpperCase()+e.slice(1),"</option>")}).join(""),d.value=n.includes(l.status)?l.status:"potenziale",r&&(r.textContent="",r.appendChild(d)),(t?Promise.resolve(t):N("/api/usernames").then(function(e){return t=e&&e.users||[]}).catch(function(){return[]})).then(function(t){var n=document.createElement("select");n.innerHTML='<option value="">â€”</option>'+t.map(function(e){return'<option value="'.concat(e.id,'">').concat(e.name||"User "+e.id).concat(e.grade?" ("+e.grade+")":"","</option>")}).join(""),l.consId&&(n.value=String(l.consId)),o&&(o.textContent="",o.appendChild(n));var i=document.createElement("div");i.className="row",i.style.marginTop="8px";var c=document.createElement("button");c.textContent="Salva";var u=document.createElement("button");u.textContent="Annulla",u.className="ghost",i.appendChild(c),i.appendChild(u),e.appendChild(i),u.addEventListener("click",function(){var e=document.createElement("b");e.textContent=l.name,s.replaceWith(e),r&&(r.textContent=l.status),o.textContent=l.consText||"â€”",i.remove()}),c.addEventListener("click",function(){var t={id:a,name:s.value.trim(),status:d.value},c=n.value?String(n.value):"";c&&(t.consultantId=c),F("/api/clients",t).then(function(){A("Cliente aggiornato"),"function"==typeof addXP&&addXP(4);var a=document.createElement("b");a.textContent=t.name||l.name,s.replaceWith(a),r&&(r.textContent=t.status),c?(o.textContent=n.options[n.selectedIndex].textContent||"#"+c,e.setAttribute("data-consultant-id",c)):(o.textContent="â€”",e.setAttribute("data-consultant-id","")),e.setAttribute("data-status",t.status),i.remove()}).catch(function(e){logger.error(e),A("Errore aggiornamento cliente")})})})})}}},BPFinal.applyClientSort=function(){var e=document.getElementById("cl_list");if(e){var t=document.getElementById("cl_order"),n=t?t.value:"az",a=Array.from(e.children).filter(function(e){return e.classList.contains("card")});if(a.length){"last_desc"===n?a.sort(function(e,t){return(+t.getAttribute("data-last-ts")||0)-(+e.getAttribute("data-last-ts")||0)}):a.sort(function(e,t){return String(e.getAttribute("data-name-lower")||"").localeCompare(String(t.getAttribute("data-name-lower")||""))});var i,r=c(a);try{for(r.s();!(i=r.n()).done;){var o=i.value;e.appendChild(o)}}catch(l){r.e(l)}finally{r.f()}}}},BPFinal.ensureClientFilters=function(){var e=document.getElementById("cl_f_apply");e&&!e.__bp_wired&&(e.__bp_wired=!0,e.addEventListener("click",function(){setTimeout(function(){BPFinal.enrichClientCards(),BPFinal.applyClientSort()},0)}));var t=document.getElementById("cl_order");t&&!t.__bp_wired&&(t.__bp_wired=!0,t.addEventListener("change",function(){return BPFinal.applyClientSort()}))},BPFinal.wireCreateClientExtras=function(){var e=document.getElementById("cl_add");e&&!e.__bp_wired&&(e.__bp_wired=!0,e.addEventListener("click",function(e){var t=document.getElementById("cl_name"),n=document.getElementById("cl_new_state"),a=document.getElementById("cl_new_owner");if(t){var i=(t.value||"").trim();if(i&&(n||a)){e.stopPropagation(),e.preventDefault();var r={name:i};n&&(r.status=n.value),a&&a.value&&(r.consultantId=a.value),F("/api/clients",r).then(function(){A("Cliente aggiunto"),addXP&&addXP(5),t.value="",setTimeout(function(){BPFinal.enrichClientCards(),BPFinal.applyClientSort()},150)}).catch(function(){return A("Errore creazione cliente")})}}},!0))},BPFinal.ensureClientSection=function(){BPFinal.ensureClientFilters(),BPFinal.wireCreateClientExtras(),BPFinal.enrichClientCards(),BPFinal.enableClientsInlineAdmin(),BPFinal.applyClientSort()};var k=document.createElement("div");k.style.cssText="position:fixed;top:14px;left:50%;transform:translateX(-50%);z-index:1200;display:flex;flex-direction:column;gap:6px;pointer-events:none;",document.documentElement.appendChild(k);var T=document.createElement("style");T.textContent="\n    .bp-coach{background:rgba(20,24,34,.92);color:#fff;border:1px solid rgba(255,255,255,.16);\n      border-radius:12px;padding:8px 10px;font-weight:700;box-shadow:0 12px 24px rgba(0,0,0,.35);opacity:.98;transform:translateY(0);transition:all .18s;}\n    @keyframes bpCoachPop{from{transform:translateY(-6px);opacity:0}to{transform:translateY(0);opacity:1}}\n  ",document.head.appendChild(T),window.coachSay=window.coachSay||ie;try{window.BP=window.BP||{},window.BP.Coach=window.BP.Coach||{},window.BP.Coach.say=window.BP.Coach.say||function(e,t){try{var n=String(e||"").toLowerCase(),a=t&&t.intensity||("low"===n||"medium"===n||"high"===n?n:void 0);a||(a="bp_saved"===n||"client_converted"===n||"gi_created"===n?"high":"appointment_created"===n||"payments_defined"===n||"report_composed"===n?"medium":"low"),ie(a)}catch(i){ie("medium")}}}catch(re){}!function(){var t="bp-nncf-banner",n="bp_seen_nncf_appt";function a(){if(!document.getElementById("bp-nncf-css")){var e="\n      #".concat(t,"{\n        position: fixed; left: 16px; right:16px; bottom: 16px; z-index: 9999;\n        background: var(--card, rgba(15,18,28,.96));\n        border: 1px solid var(--hair2, rgba(255,255,255,.12));\n        border-radius: 14px; box-shadow: 0 8px 28px rgba(0,0,0,.35);\n        padding: 12px; display:flex; align-items:center; gap:12px; backdrop-filter: blur(6px);\n      }\n      #").concat(t," .msg{ flex:1; }\n      #").concat(t," .row{ display:flex; gap:8px; align-items:center; }\n      #").concat(t," .ghost{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.18); }\n      @media (prefers-color-scheme: light){\n        #").concat(t,"{ background:#fff; border-color: rgba(0,0,0,.12); }\n        #").concat(t," .ghost{ background:rgba(0,0,0,.04); border-color: rgba(0,0,0,.12); }\n      }\n    "),n=document.createElement("style");n.id="bp-nncf-css",n.textContent=e,document.head.appendChild(n)}}function i(e,t){return e?(e=String(e).trim().toLowerCase(),N("/api/clients").then(function(n){var a=(n&&n.clients||[]).find(function(t){return String(t.name||"").trim().toLowerCase()===e});if(!a)throw new Error("Cliente non trovato: "+e);return F("/api/clients",{id:a.id,status:t})})):Promise.reject(new Error("Nome cliente mancante"))}function r(){var r=localStorage.getItem(n)||"";return N("/api/appointments").then(function(o){var l=Date.now(),s=(o&&o.appointments||[]).filter(function(e){if(!e||!e.nncf)return!1;var t=+new Date(e.end||e.start||0);return t&&t<l-6e4}).sort(function(e,t){return+new Date(t.end||t.start||0)-+new Date(e.end||e.start||0)});if(s.length){var d=s[0],c=String(d.id||d.end||"");c&&r&&String(r)===c||function(r){if(!document.getElementById(t)){a();var o=r.client||"Cliente",l=document.createElement("div");l.id=t,l.innerHTML='<div class="msg"><b>Ãˆ diventato cliente?</b> '+e(o)+'</div><div class="row"><button class="ghost" id="bp_nncf_yes">SÃ¬</button><button class="ghost" id="bp_nncf_notyet">Non ancora</button><button id="bp_nncf_close">Chiudi</button></div>',document.body.appendChild(l),document.getElementById("bp_nncf_yes").onclick=function(){i(o,"cliente").then(function(){A("Stato cliente aggiornato")}).catch(function(){A("Impossibile aggiornare lo stato")}).finally(function(){s(),d()})},document.getElementById("bp_nncf_notyet").onclick=function(){i(o,"prospect").catch(function(){}).finally(function(){s(),d()})},document.getElementById("bp_nncf_close").onclick=function(){s(),d()}}function s(){try{localStorage.setItem(n,String(r.id||r.end||Date.now()))}catch(re){}}function d(){try{l.remove()}catch(re){}}}(d)}}).catch(function(e){})}var o=window.BPFinal=window.BPFinal||{};o.injectBannerCSS=a,o.updateClientStatusByName=i,o.scanNNCF=r,window.scanNNCF||(window.scanNNCF=r)}(),window.showUndo=window.showUndo||function(e,t,n){try{var a=document.getElementById("bp_undo_bar");a||((a=document.createElement("div")).id="bp_undo_bar",a.style.position="fixed",a.style.left="16px",a.style.bottom="16px",a.style.zIndex="9999",a.style.background="rgba(20,22,28,0.95)",a.style.color="#fff",a.style.padding="10px 12px",a.style.borderRadius="10px",a.style.boxShadow="0 8px 24px rgba(0,0,0,.25)",a.style.display="flex",a.style.alignItems="center",a.style.gap="12px",document.body.appendChild(a)),a.innerHTML="<span>"+e+'</span><button id="bp_undo_btn" class="ghost" style="background:#fff;color:#111;border-radius:8px;padding:6px 10px">Annulla</button>';var i=document.getElementById("bp_undo_btn"),r=setTimeout(function(){try{a.remove()}catch(e){}},n||5e3);i.onclick=function(){clearTimeout(r);try{a.remove()}catch(e){}"function"==typeof t&&Promise.resolve(t()).then(function(){g("medium");try{document.dispatchEvent(new Event("undo:performed"))}catch(re){}}).catch(function(){g("heavy")})},g("light")}catch(o){logger.error(o)}},window.pushUndo=window.pushUndo||function(e){if(e&&"function"==typeof e.undo){var t=e.label||"Annulla ultima operazione";window.showUndo(t,e.undo,e.ttl||5e3)}},window.wireCoachUndoHaptics=function(){function e(){try{window.__periodsCache&&Object.keys(window.__periodsCache).forEach(function(e){delete window.__periodsCache[e]}),delete window.periods}catch(re){}}document.addEventListener("bp:saved",function(){window.coachSay&&ie("high"),g("heavy"),e()}),document.addEventListener("bp:deleted",function(){window.coachSay&&ie("medium"),g("medium"),e()}),document.addEventListener("appt:saved",function(){window.coachSay&&ie("medium"),g("medium")}),document.addEventListener("ics:exported",function(){window.coachSay&&ie("low"),g("light")}),document.addEventListener("report:composed",function(){window.coachSay&&ie("medium"),g("medium")}),document.addEventListener("client:converted",function(){window.coachSay&&ie("high"),g("heavy")}),document.addEventListener("gi:created",function(){window.coachSay&&ie("high"),g("heavy")}),document.addEventListener("payments:defined",function(){window.coachSay&&ie("medium"),g("medium")}),document.addEventListener("user:profile-updated",function(){window.coachSay&&ie("low"),g("light")}),document.addEventListener("appt:created",function(){window.coachSay&&ie("medium"),g("medium")}),document.addEventListener("undo:performed",function(){window.coachSay&&ie("low"),g("light")}),document.addEventListener("kpi:goal-80",function(){window.coachSay&&ie("medium"),g("medium")}),document.addEventListener("kpi:goal-reached",function(){window.coachSay&&ie("high"),g("heavy")}),document.addEventListener("click",function(e){try{for(var t=e.target,n=0;n<3&&t;n++){if(t.matches&&(t.matches('[data-close], [aria-label*="Chiudi" i], [aria-label*="Close" i]')||(t.id||"").toLowerCase().includes("close")||(t.className||"").toLowerCase().includes("close")||/^\s*(chiudi|close)\s*$/i.test(t.textContent||""))){window.coachSay&&ie("low"),g("light");break}t=t.parentElement}}catch(re){}},!0);var t=document.getElementById("app")||document.body;t&&!t.__undoWired&&(t.__undoWired=!0,t.addEventListener("click",function(e){var t=e.target.closest("[data-delete], .btn-delete");if(t){var n=t.getAttribute("href"),i=t.getAttribute("data-id");(n||i)&&(e.preventDefault(),showUndo("Eliminato â€” Annulla",d(a().m(function e(){var t,r;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,!n){e.n=2;break}return t=n+(n.indexOf("?")>=0?"&":"?")+"undo=1",e.n=1,N(t);case 1:e.n=3;break;case 2:if(!i){e.n=3;break}return e.n=3,F("/api/restore",{id:i});case 3:location.reload(),e.n=5;break;case 4:e.p=4,r=e.v,logger.error(r);case 5:return e.a(2)}},e,null,[[0,4]])}))))}},!0))},window.wireHapticsUI=function(){var e=document.body;if(!e.__hapticsWired){e.__hapticsWired=!0,e.addEventListener("click",function(e){var t=e.target.closest('button, .button, .btn, .ghost, [role="button"], a.button, a.btn, [data-action]');if(t){var n="light";t.classList.contains("danger")||"1"===t.getAttribute("data-danger")?n="heavy":(t.classList.contains("primary")||"1"===t.getAttribute("data-primary"))&&(n="medium"),g(n)}},!0),e.addEventListener("change",function(e){var t=e.target;t&&t.matches('select, input[type="checkbox"], input[type="radio"], input[type="range"]')&&g("light")},!0);var t=document.querySelector("[data-drawer-toggle], #menuToggle, .menu-toggle");t&&!t.__hW&&(t.__hW=!0,t.addEventListener("click",function(){g("light")},!0))}},window.recomputeDashboardMini=H,window.recomputeCommsMini=W,window.recomputeTeamChart=Z,window.ensureTeamUserSelect=ee,window.attachICSButtons="function"==typeof attachICSButtons?attachICSButtons:function(){},window.addSaveAndExport="function"==typeof addSaveAndExport?addSaveAndExport:function(){},window.BPFinal=window.BPFinal||{},function(e){function t(t,n){"function"==typeof n&&(e[t]=n,window[t]||(window[t]=n))}void 0!==H&&t("recomputeDashboardMini",H),void 0!==W&&t("recomputeCommsMini",W),void 0!==Z&&t("recomputeTeamChart",Z),"undefined"!=typeof viewGI&&t("viewGI",viewGI),void 0!==ee&&t("ensureTeamUserSelect",ee),"undefined"!=typeof attachICSButtons&&t("attachICSButtons",attachICSButtons),"undefined"!=typeof addSaveAndExport&&t("addSaveAndExport",addSaveAndExport),void 0!==ie&&t("coachSay",ie),"undefined"!=typeof ensureClientFilters&&t("ensureClientFilters",ensureClientFilters),"undefined"!=typeof enrichClientCards&&t("enrichClientCards",enrichClientCards),"undefined"!=typeof wireReportButtons&&t("wireReportButtons",wireReportButtons),"undefined"!=typeof scanNNCF&&t("scanNNCF",scanNNCF),"undefined"!=typeof ensureNNCFChip&&t("ensureNNCFChip",ensureNNCFChip),void 0!==K&&t("markToday",K),void 0!==Q&&t("clampSlotCounters",Q),"undefined"!=typeof filterPastAppointments&&t("filterPastAppointments",filterPastAppointments),"undefined"!=typeof openWeb&&t("openWeb",openWeb),"undefined"!=typeof openApp&&t("openApp",openApp),"undefined"!=typeof notifyConversion&&t("notifyConversion",notifyConversion),"undefined"!=typeof icsFromAppt&&t("icsFromAppt",icsFromAppt),"undefined"!=typeof downloadICS&&t("downloadICS",downloadICS),void 0!==N&&t("GET",N),void 0!==F&&t("POST",F)}(window.BPFinal);var B,P=new MutationObserver(function(){"function"==typeof ensureNNCFChip&&ensureNNCFChip(),"function"==typeof addSaveAndExport&&addSaveAndExport(),"function"==typeof attachICSButtons&&attachICSButtons(),"function"==typeof wireReportButtons&&wireReportButtons(),"function"==typeof ensureClientFilters&&ensureClientFilters(),"function"==typeof enrichClientCards&&enrichClientCards(),ee(),ne(),"function"==typeof filterPastAppointments&&filterPastAppointments(document.body),K()});B=d(a().m(function e(){var t,n;return a().w(function(e){for(;;)switch(e.n){case 0:return"function"==typeof injectTodayCSS&&injectTodayCSS(),K(),Q(),X(),e.n=1,H();case 1:return e.n=2,W();case 2:return e.n=3,Z();case 3:"function"==typeof wireHapticsUI&&wireHapticsUI(),"function"==typeof wireCoachUndoHaptics&&wireCoachUndoHaptics(),"function"==typeof scanNNCF&&scanNNCF();try{t="bpCoachGreetedDate",n=(new Date).toISOString().slice(0,10),(localStorage.getItem(t)||"")!==n&&"function"==typeof window.coachSay&&(localStorage.setItem(t,n),ie("low"))}catch(re){}P.observe(document.body,{childList:!0,subtree:!0}),window.onUnifiedRangeChange&&window.onUnifiedRangeChange(function(e){var t="d"===e?"dash":"cm"===e?"comm":"tg"===e?"t":e;"dash"===t&&(H(),"function"==typeof renderDashboard&&renderDashboard()),"comm"===t&&W(),"t"!==t&&"team"!==t||Z()});case 4:return e.a(2)}},e)})),"loading"!==document.readyState?B():document.addEventListener("DOMContentLoaded",B)}function A(e){try{(window.showToast?window.showToast:alert)(e)}catch(re){alert(e)}}function M(){for(var e=function(e){if(!e)return null;e=String(e).replace(/^"+|"+$/g,"");try{var t=JSON.parse(e);if(t&&(t.token||t.jwt||t.accessToken))return t.token||t.jwt||t.accessToken}catch(re){}return/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+$/.test(e)?e:null},t=0;t<localStorage.length;t++){var n=e(localStorage.getItem(localStorage.key(t)));if(n)return n}for(var a=0,i=["token","authToken","jwt","bp_token","accessToken","id_token","auth","authorization","bp.jwt","_token","session","user"];a<i.length;a++){var r=i[a],o=e(localStorage.getItem(r)||sessionStorage.getItem(r));if(o)return o}try{var l=S(localStorage.getItem("user")||"{}",{});if(l&&(l.token||l.jwt||l.accessToken))return l.token||l.jwt||l.accessToken}catch(re){}return null}function N(e){return L.apply(this,arguments)}function L(){return L=d(a().m(function e(t){var n,i,r,l=arguments;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=l.length>1&&void 0!==l[1]?l[1]:{},"function"!=typeof window.GET||n.forceFetch){e.n=4;break}return e.p=1,e.n=2,window.GET(t);case 2:return e.a(2,e.v);case 3:e.p=3,e.v;case 4:return i=M(),e.n=5,fetch(t,{headers:o({Accept:"application/json"},i?{Authorization:"Bearer "+i}:{})});case 5:if(401!==(r=e.v).status||!window.GET){e.n=6;break}return e.a(2,window.GET(t));case 6:if(204!==r.status){e.n=7;break}return e.a(2,null);case 7:return e.a(2,r.json())}},e,null,[[1,3]])})),L.apply(this,arguments)}function F(e,t){return U.apply(this,arguments)}function U(){return U=d(a().m(function e(t,n){var i,r,l,s=arguments;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:if(i=s.length>2&&void 0!==s[2]?s[2]:{},"function"!=typeof window.POST||i.forceFetch){e.n=4;break}return e.p=1,e.n=2,window.POST(t,n);case 2:return e.a(2,e.v);case 3:e.p=3,e.v;case 4:return r=M(),e.n=5,fetch(t,{method:"POST",headers:o({"Content-Type":"application/json"},r?{Authorization:"Bearer "+r}:{}),body:JSON.stringify(n||{})});case 5:if((l=e.v).ok||401!==l.status||!window.POST){e.n=6;break}return e.a(2,window.POST(t,n));case 6:if(204!==l.status){e.n=7;break}return e.a(2,null);case 7:return e.a(2,l.json())}},e,null,[[1,3]])})),U.apply(this,arguments)}function O(e,n,a){var i=document.getElementById(e);if(i){var r=i.getContext("2d"),o=i.width=Math.max(220,i.clientWidth||320),l=i.height=Math.max(80,i.clientHeight||80);r.clearRect(0,0,o,l);var s=Array.isArray(a)?a.map(function(e){return+e||0}):[];if(s.length){var d=Math.max.apply(Math,t(s)),c=Math.min.apply(Math,t(s)),u=d-c===0?.2*(d||1):.2*(d-c),p=d+u,v=Math.max(0,c-u),m=s.length>1?(o-8)/(s.length-1):0,f=function(e){return 4+e*m},g=function(e){return l-6-(e-v)/(p-v||1)*(l-12)};r.lineWidth=2,r.strokeStyle="#2e6cff",r.beginPath(),r.moveTo(f(0),g(s[0]));for(var b=1;b<s.length;b++)r.lineTo(f(b),g(s[b]));r.stroke(),r.fillStyle="#2e6cff";for(var h=0;h<s.length;h++)r.beginPath(),r.arc(f(h),g(s[h]),2,0,2*Math.PI),r.fill()}}}function V(e){try{var t=new Date(e);return t.getUTCFullYear()+"-"+String(t.getUTCMonth()+1).padStart(2,"0")+"-"+String(t.getUTCDate()).padStart(2,"0")}catch(re){return""}}function R(e){try{return"function"==typeof effectivePeriodType?effectivePeriodType(String(e||"mensile").toLowerCase()):String(e||"mensile").toLowerCase()}catch(re){return String(e||"mensile").toLowerCase()}}function j(e){return z.apply(this,arguments)}function z(){return(z=d(a().m(function e(t){var n,i,r,o,l,s,d,c,u,p,v,m,f,g;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:if(t){e.n=6;break}if(!Array.isArray(window.periods)||!window.periods.length){e.n=1;break}return e.a(2,window.periods);case 1:return e.p=1,e.n=2,N("/api/periods?global=1");case 2:if(!(n=e.v)||!Array.isArray(n.periods)){e.n=3;break}return window.periods=n.periods,e.a(2,n.periods);case 3:e.n=5;break;case 4:e.p=4,e.v;case 5:return e.a(2,window.periods||[]);case 6:if(l=null,"string"==typeof t?(s=window.readUnifiedRange&&window.readUnifiedRange(t)||{type:"mensile",end:new Date},i=s.type||"mensile",(d=window.buildBuckets?window.buildBuckets(i,s.end):[])&&d.length?(r=V(new Date(d[0].s)),o=V(new Date(d[d.length-1].e))):s.start&&s.end?(r=V(new Date(s.start)),o=V(new Date(s.end))):(c=new Date,r=V(c),o=V(c))):(i=(u=t||{}).type||"mensile",r=u.from||V(new Date),o=u.to||V(new Date),l=u.userId||null),p=R(i),v=[p,r,o,l||""].join("|"),!D[v]){e.n=7;break}return e.a(2,D[v]);case 7:return m=["?global=1","type="+encodeURIComponent(p),"from="+encodeURIComponent(r),"to="+encodeURIComponent(o)].concat(l?["userId="+encodeURIComponent(l)]:[]).join("&").replace("?&","?"),e.p=8,e.n=9,N("/api/periods"+m).catch(function(){return N("/api/periods"+m.replace("?global=1","?").replace("??","?"))});case 9:return f=e.v,g=f&&Array.isArray(f.periods)?f.periods:[],D[v]=g,e.a(2,g);case 10:return e.p=10,e.v,e.a(2,[])}},e,null,[[8,10],[1,4]])}))).apply(this,arguments)}function q(e,t,n){var a="previsionale"===String(t).toLowerCase()?e.indicatorsPrev||{}:e.indicatorsCons||{},i=Number(a[n]||0);return Number.isFinite(i)?i:0}function G(e,t,n){if("function"==typeof window.drawFullLine)return window.drawFullLine(e,t,n);O(e,0,n)}function H(){return Y.apply(this,arguments)}function Y(){return(Y=d(a().m(function e(){var t,n,i,r,o,l,s,d,c,u,p;return a().w(function(e){for(;;)switch(e.n){case 0:return t=window.readUnifiedRange&&window.readUnifiedRange("dash")||{type:"mensile",end:new Date},n=t.type||"mensile",i=y("dash"),r=window.buildBuckets?window.buildBuckets(n,t.end):[],e.n=1,j("dash");case 1:o=e.v,l=window.labelsFor?window.labelsFor(n,r):r.map(function(e,t){return String(t+1)}),["VSS","VSDPersonale","GI","NNCF"].forEach(function(e){var t=r.map(function(t){var a=0;return o.forEach(function(r){if(r.type===effectivePeriodType(n)){var o=new Date(r.startDate).getTime(),l=new Date(r.endDate).getTime();o>=t.s&&l<=t.e&&(a+=q(r,i,e))}}),Math.round(a)});G("d_mini_"+e.toLowerCase(),l,t)});try{window.BP&&BP.Targets&&"function"==typeof BP.Targets.getForPeriod&&(s=JSON.parse(localStorage.getItem("user")||"{}")||{},d="senior"===String(s.grade||"junior").toLowerCase()?"senior":"junior",c=BP.Targets.getForPeriod(d,effectivePeriodType(n))||{},p={},(u=["VSS","VSDPersonale","GI","NNCF"]).forEach(function(e){var t=0,a=r[r.length-1];a&&(o.forEach(function(r){if(r.type===effectivePeriodType(n)){var o=new Date(r.startDate).getTime(),l=new Date(r.endDate).getTime();o>=a.s&&l<=a.e&&(t+=q(r,i,e))}}),p[e]=Math.round(t))}),window.__bpCoachKpiFired=window.__bpCoachKpiFired||{},u.forEach(function(e){var t=Number(c[e]||0);if(!(t<=0)){var a=Number(p[e]||0),i=Math.round(a/t*100),r=effectivePeriodType(n)+"_"+e;if(i>=100&&!window.__bpCoachKpiFired[r+"_100"]){window.__bpCoachKpiFired[r+"_100"]=!0;try{document.dispatchEvent(new CustomEvent("kpi:goal-reached",{detail:{key:e,value:a,target:t}}))}catch(re){}}else if(i>=80&&!window.__bpCoachKpiFired[r+"_80"]){window.__bpCoachKpiFired[r+"_80"]=!0;try{document.dispatchEvent(new CustomEvent("kpi:goal-80",{detail:{key:e,value:a,target:t}}))}catch(re){}}}}))}catch(re){}case 2:return e.a(2)}},e)}))).apply(this,arguments)}function W(){return J.apply(this,arguments)}function J(){return(J=d(a().m(function e(){var t,n,i,r,o,l,s,d;return a().w(function(e){for(;;)switch(e.n){case 0:return t="comm",n=window.readUnifiedRange&&(window.readUnifiedRange(t)||window.readUnifiedRange("cm"))||{type:"mensile",end:new Date},i=n.type||"mensile",r=y&&y(t)||y&&y("cm")||"cons",o=window.buildBuckets?window.buildBuckets(i,n.end):[],e.n=1,j("comm");case 1:l=e.v,s=window.labelsFor?window.labelsFor(i,o):o.map(function(e,t){return String(t+1)}),d=o.map(function(e){var t=0;return l.forEach(function(n){if(n.type===effectivePeriodType(i)){var a=new Date(n.startDate).getTime(),o=new Date(n.endDate).getTime();a>=e.s&&o<=e.e&&(t+=q(n,r,"VSDPersonale"))}}),Math.round(t)}),G("cm_mini_vsd",s,d);case 2:return e.a(2)}},e)}))).apply(this,arguments)}function Z(){return $.apply(this,arguments)}function $(){return($=d(a().m(function e(){var t,n,i,r,o,l,s,d,c,u,p,v;return a().w(function(e){for(;;)switch(e.n){case 0:return s=function(e){try{var t=new Date(e);return t.getUTCFullYear()+"-"+String(t.getUTCMonth()+1).padStart(2,"0")+"-"+String(t.getUTCDate()).padStart(2,"0")}catch(re){return""}},t=window.readUnifiedRange&&(window.readUnifiedRange("t")||window.readUnifiedRange("tg"))||{type:"mensile",end:new Date},n=t.type||"mensile",i=y&&y("t")||y&&y("tg")||"cons",r=(w("#tg_user")||{}).value||"",o=(w("#tg_ind")||{}).value||"VSS",l=window.buildBuckets?window.buildBuckets(n,t.end):[],d=l.length?s(new Date(l[0].s)):s(new Date),c=l.length?s(new Date(l[l.length-1].e)):s(new Date),e.n=1,j({type:n,from:d,to:c,userId:r||null});case 1:u=e.v,p=window.labelsFor?window.labelsFor(n,l):l.map(function(e,t){return String(t+1)}),v=l.map(function(e){var t=0;return u.forEach(function(a){if(a.type===effectivePeriodType(n)&&(!r||String(a.userId)===String(r))){var l=new Date(a.startDate).getTime(),s=new Date(a.endDate).getTime();l>=e.s&&s<=e.e&&(t+=q(a,i,o))}}),Math.round(t)}),G("tg_chart",p,v);case 2:return e.a(2)}},e)}))).apply(this,arguments)}function X(){_(w("#dash_mode"),"change",function(){g("light"),window.recomputeDashboard&&recomputeDashboard(),window.recomputeDashboardMini&&H()}),_(w("#d_mode"),"change",function(){g("light"),window.recomputeDashboard&&recomputeDashboard(),window.recomputeDashboardMini&&H()}),_(w("#comm_mode"),"change",function(){g("light"),window.recomputeCommsMini&&W()}),_(w("#cm_mode"),"change",function(){g("light"),window.recomputeCommsMini&&W()});var e=w("#tg_user");e&&e.options.length<=1&&N("/api/usernames").then(function(t){(t&&t.users||[]).forEach(function(t){var n=document.createElement("option");n.value=t.id,n.textContent=(t.name||"User "+t.id)+(t.grade?" â€“ "+t.grade:""),e.appendChild(n)})}).catch(function(e){return logger.error(e)});var t=function(){window.recomputeTeamChart&&Z(),window.recomputeTeamAggChart&&recomputeTeamAggChart()};_(w("#t_mode"),"change",function(){g("light"),t()}),["#t_y","#t_m","#t_q","#t_from","#t_to"].forEach(function(e){var n=w(e);n&&_(n,"change",t)}),e&&_(e,"change",function(){g("light"),window.recomputeTeamChart&&Z()});var n=w("#t_ind");n&&_(n,"change",function(){g("light"),window.recomputeTeamAggChart&&recomputeTeamAggChart()}),w("#tg_chart")&&window.recomputeTeamChart&&Z(),w("#t_chart")&&window.recomputeTeamAggChart&&recomputeTeamAggChart()}function K(){try{var e=I(),t=document.querySelector('.calendar .day[data-day="'+e+'"], .calendar .day[data-date="'+e+'"]');if(!t)for(var n=parseInt(e.slice(8,10),10),a=document.querySelectorAll(".calendar .day"),i=0;i<a.length;i++){var r=a[i];if(parseInt((r.getAttribute("data-day")||r.getAttribute("data-date")||"").slice(8,10)||r.textContent.trim(),10)===n){t=r;break}}t&&t.classList.add("today")}catch(re){}}function Q(){try{for(var e=I(),t=document.querySelectorAll(".calendar .day[data-day], .calendar .day[data-date]"),n=0;n<t.length;n++){var a=t[n],i=(a.getAttribute("data-day")||a.getAttribute("data-date")||"").slice(0,10);i&&i<e&&a.classList.remove("slot-free")}}catch(re){}}function ee(){return te.apply(this,arguments)}function te(){return(te=d(a().m(function e(){var t,n;return a().w(function(e){for(;;)switch(e.n){case 0:if((t=w("#tg_user"))&&!(t.options.length>1)){e.n=1;break}return e.a(2);case 1:return e.n=2,N("/api/usernames").catch(function(){return null});case 2:((n=e.v)&&n.users||[]).forEach(function(e){var n=document.createElement("option");n.value=e.id,n.textContent=e.name+(e.grade?" ("+e.grade+")":""),t.appendChild(n)});case 3:return e.a(2)}},e)}))).apply(this,arguments)}function ne(){var e=w("#users, .users");if(e&&!e.__userEditWired){e.__userEditWired=!0,e.addEventListener("click",function(e){var t,n,i=e.target.closest("[data-edit-user]");if(i){var r=i.closest("[data-user-id]"),o=null==r?void 0:r.getAttribute("data-user-id"),l=(null==r||null===(t=r.querySelector(".u-name"))||void 0===t?void 0:t.textContent)||"",s=(null==r||null===(n=r.querySelector(".u-email"))||void 0===n?void 0:n.textContent)||"",c=document.createElement("div");c.className="modal",c.innerHTML='<div class="card"><h3>Modifica utente</h3><label>Nome <input id="u_name" value="'+l+'"></label><label>Email <input id="u_email" value="'+s+'"></label><label>Password <input id="u_pass" type="password" placeholder="(lascia vuoto per non cambiare)"></label><div class="row right"><button id="u_ok" class="btn-ghost">Salva</button><button id="u_x" class="btn-ghost">Chiudi</button></div></div>',document.body.appendChild(c),w("#u_x",c).onclick=function(){return c.remove()},w("#u_ok",c).onclick=d(a().m(function e(){var t,n;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,t={id:o,name:w("#u_name",c).value,email:w("#u_email",c).value},(n=w("#u_pass",c).value.trim())&&(t.password=n),e.n=1,F("/api/users",t);case 1:A("Utente aggiornato"),c.remove(),location.reload(),e.n=3;break;case 2:e.p=2,e.v,A("Errore aggiornamento utente");case 3:return e.a(2)}},e,null,[[0,2]])}))}});var t=w("#btnProfile")||w("[data-edit-self]");t&&!t.__wired&&(t.__wired=!0,t.onclick=function(){var e=S(localStorage.getItem("user")||"{}",{}),t=document.createElement("div");t.className="modal",t.innerHTML='<div class="card"><h3>Profilo</h3><label>Nome <input id="me_name" value="'+(e.name||"")+'"></label><label>Email <input id="me_email" value="'+(e.email||"")+'"></label><label>Password <input id="me_pass" type="password" placeholder="(nuova password)"></label><div class="row right"><button id="me_ok" class="btn-ghost">Salva</button><button id="me_x" class="btn-ghost">Chiudi</button></div></div>',document.body.appendChild(t),w("#me_x",t).onclick=function(){return t.remove()},w("#me_ok",t).onclick=d(a().m(function n(){var i,r;return a().w(function(n){for(;;)switch(n.p=n.n){case 0:return n.p=0,i={id:e.id,name:w("#me_name",t).value,email:w("#me_email",t).value},(r=w("#me_pass",t).value.trim())&&(i.password=r),n.n=1,F("/api/users",i);case 1:A("Profilo aggiornato"),t.remove(),location.reload(),n.n=3;break;case 2:n.p=2,n.v,A("Errore aggiornamento profilo");case 3:return n.a(2)}},n,null,[[0,2]])}))})}}function ae(e){var t=S(localStorage.getItem("user")||"{}",{}).name||"campione",n=window.BP&&window.BP.Phrases?window.BP.Phrases:null,a=[];return(a=n?"high"===e?n.high||n.standard||[]:"low"===e?n.low||n.standard||[]:n.medium||n.standard||[]:["Grande {{name}}!","Che figata, {{name}}!","Super!","Non ti ferma nessuno!!","Grandissimo!"]).length||(a=["Grande {{name}}!"]),a[Math.floor(Math.random()*a.length)].replace(/{{\s*name\s*}}/gi,t)}function ie(e){var t=document.createElement("div");t.className="bp-coach",t.textContent=ae(e||"medium"),k.appendChild(t),setTimeout(function(){t.style.opacity="0",t.style.transform="translateY(-4px)"},2200),setTimeout(function(){t.remove()},2420)}}(),function(){if(window.GET){var e=window.GET;window.GET=function(t){try{if("string"==typeof t&&0===t.indexOf("/api/leaderboard")){if(!(0===t.indexOf("/api/leaderboard_overall"))&&-1===t.indexOf("indicator="))return Promise.resolve({ranking:[]});if(window.readUnifiedRange){var n=window.readUnifiedRange("lb")||{},a="ytd"===n.type||"ltm"===n.type?"mensile":n.type;a&&(t+=(t.includes("?")?"&":"?")+"type="+encodeURIComponent(a))}var i=document.getElementById("lb_mode"),r=i?i.value:"consuntivo";t+=(t.includes("?")?"&":"?")+"mode="+encodeURIComponent(r)}}catch(o){}return e.apply(this,arguments)}}}(),void 0!==(m="undefined"!=typeof window?window:void 0)&&(m.initPostSaleBanners=function(e){var t=window.BANNERS_LOOKBACK_DAYS||7,n="nncf",i="sale",r=function(e,t){return"bp_snooze_".concat(t,"_").concat(e)},o=function(e,t){return"bp_done_".concat(t,"_").concat(e)},l=function(e,t){try{var n=localStorage.getItem(r(e,t));return n&&new Date(n).getTime()>Date.now()}catch(a){return!1}},s=function(e,t){try{var n=new Date;n.setDate(n.getDate()+1),localStorage.setItem(r(e,t),n.toISOString())}catch(a){}},c=function(e,t){try{return"1"===localStorage.getItem(o(e,t))}catch(n){return!1}},u=function(e,t){try{localStorage.setItem(o(e,t),"1")}catch(n){}},p=window.BPFinal&&BPFinal.GET||window.GET,v=window.BPFinal&&BPFinal.POST||window.POST,m=window.toast||function(e){return alert(e)};function f(e){return String(e||"").replace(/[&<>\"]/g,function(e){return{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[e]})}var g=[],b=!1;function h(e){g.push(e),y()}function y(){if(!b){var e=g.shift();if(e){b=!0,function(){if(!document.getElementById("bp-banner-css")){var e=document.createElement("style");e.id="bp-banner-css",e.textContent="\n      #bp_banner_host{position:fixed;left:16px;right:16px;bottom:16px;z-index:9999;display:flex;justify-content:center;pointer-events:none}\n      .bp-banner-card{pointer-events:auto;width:100%;max-width:720px;background:var(--card,#fff);color:var(--text,#111);\n        border:1px solid rgba(0,0,0,.12);border-radius:14px;box-shadow:0 10px 28px rgba(0,0,0,.28);padding:12px;display:flex;gap:12px;align-items:center;opacity:0;transform:translateY(8px);transition:opacity .2s,transform .2s}\n      .bp-banner-card.show{opacity:1;transform:none}\n      .bp-banner-card .msg{flex:1}.bp-banner-card .row{display:flex;gap:8px;align-items:center}\n      .bp-banner-card .ghost{background:rgba(0,0,0,.06);border:1px solid rgba(0,0,0,.12)}\n      @media (prefers-color-scheme: dark){ .bp-banner-card{background:rgba(15,18,28,.96);color:#fff;border-color:rgba(255,255,255,.16)}\n        .bp-banner-card .ghost{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.18)}}\n    ",document.head.appendChild(e)}}();var t,n=((t=document.getElementById("bp_banner_host"))||((t=document.createElement("div")).id="bp_banner_host",document.body.appendChild(t)),t);n.innerHTML="";var a=e(function(){n.innerHTML="",b=!1,setTimeout(y,40)});n.appendChild(a),requestAnimationFrame(function(){return a.classList.add("show")})}}}function w(e,t){return _.apply(this,arguments)}function _(){return(_=d(a().m(function e(t,n){var i,r,o;return a().w(function(e){for(;;)switch(e.n){case 0:if(t){e.n=1;break}return e.a(2);case 1:return e.n=2,p("/api/clients");case 2:if(i=e.v,r=i&&i.clients||[],o=r.find(function(e){return String(e.name||"").trim().toLowerCase()===String(t).trim().toLowerCase()})){e.n=3;break}return e.a(2);case 3:return e.n=4,v("/api/clients",{id:o.id,status:n});case 4:return e.a(2)}},e)}))).apply(this,arguments)}function S(t,n){var i=Number(t.vss||t.vsdPersonal||0)||0,r=t.client||"Cliente",o=document.createElement("div");o.className="modal",o.innerHTML='\n      <div class="card" style="min-width:min(380px,96vw);max-width:480px">\n        <div style="display:flex;justify-content:space-between;align-items:center">\n          <b>VSS per '.concat(f(r),'</b>\n          <button class="ghost" id="vss_x">Chiudi</button>\n        </div>\n        <div class="row" style="margin-top:8px;gap:8px;align-items:flex-end;flex-wrap:wrap">\n          <div style="min-width:200px">\n            <label>Valore VSS</label>\n            <input id="vss_val" type="number" step="1" value="').concat(i,'">\n          </div>\n          <div class="muted small">Modifica consentita solo per VSS</div>\n        </div>\n        <div class="right" style="margin-top:12px">\n          <button id="vss_ok">Salva</button>\n        </div>\n      </div>'),document.body.appendChild(o);var l=function(){try{o.remove()}catch(e){}};o.querySelector("#vss_x").onclick=l,o.querySelector("#vss_ok").onclick=d(a().m(function i(){var r,s,d,c,u;return a().w(function(a){for(;;)switch(a.p=a.n){case 0:return a.p=0,r=Math.max(0,Number(o.querySelector("#vss_val").value||0)),a.n=1,v("/api/appointments",{id:t.id,vss:r});case 1:if(e("medium"),m("Appuntamento aggiornato"),l(),!(r>0)){a.n=5;break}return a.p=2,a.n=3,x(t,r);case 3:(s=a.v)&&(s.id||s._id)&&(d=s.id||s._id,document.dispatchEvent(new CustomEvent("gi:edit",{detail:{id:d}}))),a.n=5;break;case 4:a.p=4,c=a.v,logger.error(c);case 5:n&&"function"==typeof n.onSaved&&n.onSaved(r),a.n=7;break;case 6:a.p=6,u=a.v,logger.error(u),m("Errore salvataggio VSS");case 7:return a.a(2)}},i,null,[[2,4],[0,6]])}))}function x(e,t){return I.apply(this,arguments)}function I(){return(I=d(a().m(function e(t,n){var i,r;return a().w(function(e){for(;;)switch(e.n){case 0:return i={apptId:t.id,date:new Date(t.end||t.start||Date.now()).toISOString(),clientName:t.client||"Cliente",vssTotal:Math.round(Number(n||0)),services:t.services||t.note||"",consultantId:t.userId||t.ownerId||null},e.n=1,v("/api/gi",i);case 1:return r=e.v,e.a(2,r&&(r.sale||r.gi||r.data)||r)}},e)}))).apply(this,arguments)}function E(e){return function(t){var n=document.createElement("div");return n.className="bp-banner-card",n.setAttribute("role","alertdialog"),n.setAttribute("aria-live","assertive"),n.innerHTML='<div class="msg"><b>Allora, hai venduto a '.concat(f(e.client||"Cliente"),'?</b>\n           <div class="small muted">Appuntamento di vendita concluso</div></div>\n         <div class="row">\n           <button class="ghost" data-act="later">Posticipa</button>\n           <button class="ghost" data-act="no">No</button>\n           <button data-act="yes">SÃ¬</button>\n         </div>'),n.querySelector('[data-act="yes"]').onclick=function(){t(),S(e,{onSaved:function(){return u(e.id,i)}})},n.querySelector('[data-act="no"]').onclick=d(a().m(function n(){return a().w(function(n){for(;;)switch(n.p=n.n){case 0:return t(),n.p=1,n.n=2,v("/api/appointments",{id:e.id,vss:0});case 2:u(e.id,i),m("Registrato: nessuna vendita"),n.n=4;break;case 3:n.p=3,n.v;case 4:return n.a(2)}},n,null,[[1,3]])})),n.querySelector('[data-act="later"]').onclick=function(){s(e.id,i),m("Te lo ripropongo domani"),t()},n}}function C(e){return function(t){var i=document.createElement("div");return i.className="bp-banner-card",i.setAttribute("role","alertdialog"),i.setAttribute("aria-live","assertive"),i.innerHTML='<div class="msg"><b>Ãˆ diventato cliente?</b> '.concat(f(e.client||""),'</div>\n         <div class="row">\n           <button class="ghost" data-act="later">Posticipa</button>\n           <button class="ghost" data-act="no">No</button>\n           <button data-act="yes">SÃ¬</button>\n         </div>'),i.querySelector('[data-act="yes"]').onclick=d(a().m(function i(){return a().w(function(a){for(;;)switch(a.p=a.n){case 0:return t(),a.p=1,a.n=2,w(e.client,"attivo");case 2:a.n=4;break;case 3:a.p=3,a.v;case 4:S(e,{onSaved:function(){return u(e.id,n)}});case 5:return a.a(2)}},i,null,[[1,3]])})),i.querySelector('[data-act="no"]').onclick=d(a().m(function i(){return a().w(function(a){for(;;)switch(a.p=a.n){case 0:return t(),a.p=1,a.n=2,w(e.client,"lead non chiuso");case 2:return a.n=3,v("/api/appointments",{id:e.id,vss:0});case 3:u(e.id,n),m("Aggiornato: Lead non chiuso, VSS=0"),a.n=5;break;case 4:a.p=4,a.v;case 5:return a.a(2)}},i,null,[[1,4]])})),i.querySelector('[data-act="later"]').onclick=function(){s(e.id,n),m("Te lo ripropongo domani"),t()},i}}function D(){return k.apply(this,arguments)}function k(){return(k=d(a().m(function e(){var r,o,s,d;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,p("/api/appointments");case 1:r=e.v,o=Date.now(),s=o-24*t*60*60*1e3,(d=r&&r.appointments||[]).sort(function(e,t){return+new Date(t.end||t.start||0)-+new Date(e.end||e.start||0)}),d.forEach(function(e){try{var t=+new Date(e.end||e.start||0);if(!t||t>o||t<s)return;var a="vendita"===String(e.type||"").toLowerCase()||Number(e.vss||0)>0||Number(e.vsdPersonal||0)>0;if(e.nncf){if(c(e.id,n)||l(e.id,n))return;h(C(e))}else if(a){if(c(e.id,i)||l(e.id,i))return;h(E(e))}}catch(r){}}),e.n=3;break;case 2:e.p=2,e.v;case 3:return e.a(2)}},e,null,[[0,2]])}))).apply(this,arguments)}window.scanBanners=D,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",D,{once:!0}):D();try{document.addEventListener("appt:saved",function(){setTimeout(D,50)})}catch(T){}try{document.addEventListener("visibilitychange",function(){document.hidden||setTimeout(D,50)})}catch(T){}try{setInterval(function(){D()},6e4)}catch(T){}}),function(){function e(){try{var e=JSON.parse(localStorage.getItem("bp_user")||"null")||{};if(e.token)return e.token}catch(t){}return localStorage.getItem("bp_token")||localStorage.getItem("authToken")||localStorage.getItem("token")||""}function t(e){for(var t=(e+"=".repeat((4-e.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),n=atob(t),a=new Uint8Array(n.length),i=0;i<n.length;i++)a[i]=n.charCodeAt(i);return a}function n(e){return i.apply(this,arguments)}function i(){return(i=d(a().m(function t(n){var i,r;return a().w(function(t){for(;;)switch(t.p=t.n){case 0:if(i=e()){t.n=1;break}return t.a(2);case 1:return t.p=1,t.n=2,fetch("/api/push/subscribe",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+i},body:JSON.stringify(n)});case 2:t.n=4;break;case 3:t.p=3,r=t.v,logger.warn("[BP] push subscribe error",r);case 4:return t.a(2)}},t,null,[[1,3]])}))).apply(this,arguments)}function r(){return o.apply(this,arguments)}function o(){return(o=d(a().m(function e(){var i,r,o,l,s,d;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,navigator.serviceWorker.ready;case 1:return i=e.v,e.n=2,i.pushManager.getSubscription();case 2:if(r=e.v){e.n=7;break}return e.n=3,fetch("/api/push/publicKey");case 3:return o=e.v,e.n=4,o.json();case 4:if(l=e.v,s=l.publicKey||l.key||""){e.n=5;break}return e.a(2);case 5:return e.n=6,i.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:t(s)});case 6:r=e.v;case 7:return e.n=8,n(r.toJSON());case 8:e.n=10;break;case 9:e.p=9,d=e.v,logger.warn("[BP] push subscribe fail",d);case 10:return e.a(2)}},e,null,[[0,9]])}))).apply(this,arguments)}function l(){return s.apply(this,arguments)}function s(){return(s=d(a().m(function e(){return a().w(function(e){for(;;)switch(e.p=e.n){case 0:if("granted"!==Notification.permission){e.n=1;break}return e.a(2,r());case 1:if("default"!==Notification.permission){e.n=6;break}return e.p=2,e.n=3,Notification.requestPermission();case 3:if("granted"!==e.v){e.n=4;break}return e.a(2,r());case 4:e.n=6;break;case 5:e.p=5,e.v;case 6:return e.a(2)}},e,null,[[2,5]])}))).apply(this,arguments)}"serviceWorker"in navigator&&"PushManager"in window&&(window.BPPush={init:l,subscribe:r},window.addEventListener("load",l))}();var te=null;function ne(){clearTimeout(te),te=setTimeout(K,60)}function ae(e){return document.querySelector(e)}function ie(e){return Array.from(document.querySelectorAll(e))}!function(){var e=window.BP=window.BP||{},t=e.ICS=e.ICS||{};function a(e){if(!e)return"";if(/[Zz]|[+\-]\d{2}:\d{2}$/.test(String(e)))return new Date(e).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z").slice(0,15)+"Z";var t=n(String(e).split("T"),2),a=t[0],i=t[1],r=void 0===i?"00:00":i,o=n(a.split("-").map(Number),3),l=o[0],s=o[1],d=o[2],c=n(r.split(":").map(Number),2),u=c[0],p=c[1];return new Date(l,s-1,d,u,p,0,0).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z").slice(0,15)+"Z"}function i(e){return(e||"").replace(/\\/g,"\\\\").replace(/;/g,"\\;").replace(/,/g,"\\,").replace(/\n/g,"\\n")}function r(e){var t=(e&&e.id||"bp-"+Date.now())+"@bpapp",n=e&&e.client?"Appuntamento Â· "+e.client:"Appuntamento",r=a(e&&e.start),o=a(e&&e.end),l=a((new Date).toISOString().slice(0,16)),s=[];e&&e.type&&s.push("Tipo: "+e.type),e&&e.vss&&s.push("VSS: "+e.vss),e&&e.vsdPersonal&&s.push("VSD Personale: "+e.vsdPersonal),e&&e.notes&&s.push("Note: "+e.notes);var d=i(s.join("\n")),c=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//BPApp//Calendario//IT","CALSCALE:GREGORIAN","METHOD:PUBLISH","BEGIN:VEVENT","UID:"+t,"DTSTAMP:"+l,r?"DTSTART:"+r:"",o?"DTEND:"+o:"","SUMMARY:"+i(n),d?"DESCRIPTION:"+d:"","END:VEVENT","END:VCALENDAR"].filter(Boolean),u=[];return c.forEach(function(e){return u.push.apply(u,function(e){if(e.length<=74)return[e];for(var t=[],n=0;n<e.length;){var a=e.slice(n,n+74);t.push(0===n?a:" "+a),n+=74}return t}(e))}),u.join("\r\n")}t.makeIcsForAppointment=r,t.downloadIcsForAppointment=function(e){try{var t=r(e),n=e&&e.start?String(e.start).split("T")[0]:"evento",a=(e&&e.client||"appuntamento").trim().replace(/[^\w\-]+/g,"_").slice(0,40),i="bp_".concat(a,"_").concat(n,".ics");if(function(){try{var e=navigator.userAgent||navigator.vendor||"",t=/iP(ad|hone|od)/.test(e),n=/^((?!chrome|android|crios|fxios|edgi).)*safari/i.test(e);return t||n}catch(a){return!1}}())try{var o="data:text/calendar;charset=utf-8,"+encodeURIComponent(t),l=document.createElement("a");return l.href=o,l.setAttribute("target","_blank"),l.setAttribute("download",i),document.body.appendChild(l),l.click(),l.remove(),!0}catch(c){try{return window.location.assign("data:text/calendar;charset=utf-8,"+encodeURIComponent(t)),!0}catch(u){try{logger.error(u)}catch(p){}return!1}}var s=new Blob([t],{type:"text/calendar;charset=utf-8"}),d=document.createElement("a");return d.href=URL.createObjectURL(s),d.download=i,document.body.appendChild(d),d.click(),setTimeout(function(){try{URL.revokeObjectURL(d.href)}catch(p){}d.remove()},50),!0}catch(v){try{logger.error(v)}catch(p){}return!1}},window.icsFromAppt=window.icsFromAppt||function(e){return r(e)},window.downloadICS=window.downloadICS||function(e,t){try{var n=window.__icsSanitize?__icsSanitize(e):e||"evento";/\.ics$/i.test(n)||(n+=".ics");var a=new Blob([t],{type:"text/calendar;charset=utf-8"}),i=document.createElement("a");i.href=URL.createObjectURL(a),i.download=n,document.body.appendChild(i),i.click(),setTimeout(function(){URL.revokeObjectURL(i.href),i.remove()},50)}catch(r){logger.error(r)}}}(),function(){var n,i=document.getElementById("app");function r(){document.title="Battle Plan â€“ Login";i.innerHTML='<div class="hero" id="hero"><div class="layer glow"></div><div class="layer grid"></div><div class="title">Pianifica. Eroga. Vinci. <span class="small muted">BP â€“ stile gaming</span></div></div><div class="wrap"><div class="grid"><div class="card"><h3>Accedi</h3><form id="loginForm" autocomplete="on"><div class="row"><div><label>Email</label><input id="li_email" name="email" type="email" autocomplete="username" required></div><div><label>Password</label><input id="li_password" name="password" type="password" autocomplete="current-password" required></div></div><div class="row"><label class="small"><input type="checkbox" id="li_remember" checked> Rimani collegato</label></div><div class="right" style="margin-top:8px"><button type="submit" id="btnLogin">Accedi</button></div></form></div><div class="card"><h3>Registrati</h3><form id="regForm" autocomplete="on"><div class="row"><div><label>Nome</label><input id="re_name" name="name" type="text" required></div><div><label>Email</label><input id="re_email" name="email" type="email" autocomplete="username" required></div><div><label>Password</label><input id="re_password" name="new-password" type="password" autocomplete="new-password" required></div></div><div class="right" style="margin-top:8px"><button type="submit" id="btnRegister">Registrati</button></div></form></div></div></div>';var e=document.getElementById("hero");e&&e.addEventListener("pointermove",function(t){var n=e.getBoundingClientRect();e.style.setProperty("--gx",(t.clientX-n.left)/n.width*100+"%"),e.style.setProperty("--gy",(t.clientY-n.top)/n.height*100+"%")});var t=document.getElementById("loginForm"),n=document.getElementById("regForm");t.addEventListener("submit",function(e){e.preventDefault();var t=document.getElementById("btnLogin");t.disabled=!0;var n=document.getElementById("li_email").value.trim().toLowerCase(),a=document.getElementById("li_password").value,i=document.getElementById("li_remember").checked;T("/api/login",{email:n,password:a}).then(function(e){if("string"==typeof e)try{e=JSON.parse(e)}catch(t){}!function(e,t){t?b("bp_token",e):sessionStorage.setItem("bp_token",e)}(e.token,i),b("bp_user",e.user),Y("Bentornato "+e.user.name+"!"),window.addXP(10),f(),K(),window.BPPush&&window.BPPush.subscribe()},function(e){Y("Credenziali errate"),logger.error(e)}).catch(function(e){logger.error(e)}).finally(function(){t.disabled=!1})}),n.addEventListener("submit",function(e){e.preventDefault();var t=document.getElementById("btnRegister");t.disabled=!0,T("/api/register",{name:document.getElementById("re_name").value.trim(),email:document.getElementById("re_email").value.trim().toLowerCase(),password:document.getElementById("re_password").value}).then(function(){Y("Registrazione ok. Ora accedi"),W(),window.addXP(20),window.scrollTo({top:0,behavior:"smooth"})}).catch(function(e){Y("Email giÃ  registrata?"),logger.error(e)}).finally(function(){t.disabled=!1})})}function o(e){var t=(new Date).getFullYear(),n=(new Date).getMonth()+1;return'<div class="uf"><div class="row"><div><label>GranularitÃ </label><select id="'+e+'_gran"><option value="settimanale">Settimanale</option><option value="mensile" selected>Mensile</option><option value="trimestrale">Trimestrale</option><option value="semestrale">Semestrale</option><option value="annuale">Annuale</option><option value="ytd">Anno corrente (YTD)</option><option value="ltm">Ultimi 12 mesi (LTM)</option></select></div><div id="'+e+'_wrap_week" style="display:none"><label>Settimana ISO</label><div class="row"><input type="number" id="'+e+'_week" min="1" max="53" value="'+F(new Date)+'"><input type="number" id="'+e+'_year_w" min="2000" max="2100" value="'+t+'"></div></div><div id="'+e+'_wrap_month"><label>Mese</label><div class="row"><input type="number" id="'+e+'_month" min="1" max="12" value="'+n+'"><input type="number" id="'+e+'_year_m" min="2000" max="2100" value="'+t+'"></div></div><div id="'+e+'_wrap_quarter" style="display:none"><label>Trimestre</label><div class="row"><input type="number" id="'+e+'_quarter" min="1" max="4" value="'+Math.floor((n-1)/3)+'1"><input type="number" id="'+e+'_year_q" min="2000" max="2100" value="'+t+'"></div></div><div id="'+e+'_wrap_sem" style="display:none"><label>Semestre</label><div class="row"><select id="'+e+'_sem"><option value="1">1Â°</option><option value="2">2Â°</option></select><input type="number" id="'+e+'_year_s" min="2000" max="2100" value="'+t+'"></div></div><div id="'+e+'_wrap_year" style="display:none"><label>Anno</label><input type="number" id="'+e+'_year" min="2000" max="2100" value="'+t+'"></div><div style="align-self:flex-end"><button id="'+e+'_refresh" class="ghost">Aggiorna</button></div></div></div>'}function l(e){return"d"===e||"dash"===e?"dash":"cm"===e||"comm"===e?"comm":"tg"===e||"t"===e||"team"===e?"t":e}function s(e,t){function n(){var t=document.getElementById(e+"_gran").value;["week","month","quarter","sem","year"].forEach(function(t){var n=document.getElementById(e+"_wrap_"+t);n&&(n.style.display="none")}),"settimanale"===t?document.getElementById(e+"_wrap_week").style.display="":"mensile"===t?document.getElementById(e+"_wrap_month").style.display="":"trimestrale"===t?document.getElementById(e+"_wrap_quarter").style.display="":"semestrale"===t?document.getElementById(e+"_wrap_sem").style.display="":"annuale"===t&&(document.getElementById(e+"_wrap_year").style.display="")}["gran","week","year_w","month","year_m","quarter","year_q","sem","year_s","year"].forEach(function(a){var i=document.getElementById(e+"_"+a);i&&(i.onchange=function(){n(),t&&t(),window.emitUnifiedRangeChange(l(e))},i.oninput=function(){n()})});var a=document.getElementById(e+"_refresh");a&&(a.onclick=function(){t&&t(),window.emitUnifiedRangeChange(l(e))}),n()}function u(e){var t=new Date;function n(t,n){var a=document.getElementById(e+"_"+t),i=a?parseInt(a.value,10):NaN;return isFinite(i)?i:n}var a=document.getElementById(e+"_gran"),i=a?a.value:"mensile",r={type:i,start:null,end:null};if("settimanale"===i){var o=q(n("year_w",t.getFullYear()),Math.max(1,Math.min(53,n("week",F(t)))));return r.start=o.start,r.end=o.end,r}if("mensile"===i){var l=n("year_m",t.getFullYear()),s=Math.max(1,Math.min(12,n("month",t.getMonth()+1)));return r.start=new Date(l,s-1,1),r.end=new Date(l,s,0,23,59,59,999),r}if("trimestrale"===i){var d=n("year_q",t.getFullYear()),c=Math.max(1,Math.min(4,n("quarter",Math.floor(t.getMonth()/3)+1)));return r.start=new Date(d,3*(c-1),1),r.end=new Date(d,3*c,0,23,59,59,999),r}if("semestrale"===i){var u=n("year_s",t.getFullYear()),p=n("sem",t.getMonth()<6?1:2);return r.start=new Date(u,1===p?0:6,1),r.end=new Date(u,1===p?6:12,0,23,59,59,999),r}if("annuale"===i){var v=n("year",t.getFullYear());return r.start=new Date(v,0,1),r.end=new Date(v,11,31,23,59,59,999),r}if("ytd"===i){var m=new Date(t.getFullYear(),t.getMonth()+1,0,23,59,59,999);return r.start=new Date(t.getFullYear(),0,1),r.end=m,r}if("ltm"===i){var f=new Date(t.getFullYear(),t.getMonth()+1,0,23,59,59,999),g=new Date(f.getFullYear(),f.getMonth()-11,1);return r.start=g,r.end=f,r}return r.type="mensile",r.start=new Date(t.getFullYear(),t.getMonth(),1),r.end=new Date(t.getFullYear(),t.getMonth()+1,0,23,59,59,999),r}function p(e){return"ytd"===e||"ltm"===e?"mensile":e}function v(e,t){var n=p(e||"mensile"),a=t?new Date(t):new Date,i=a.getUTCFullYear(),r=[];function o(e,t){r.push({s:e.getTime(),e:t.getTime()})}function l(e,t,n){return new Date(Date.UTC(e,t,n))}function s(e){return new Date(e.getTime()+864e5-1)}function d(e,t){return new Date(Date.UTC(e,t+1,0))}if("settimanale"===n){var c=new Date(Date.UTC(a.getUTCFullYear(),a.getUTCMonth(),a.getUTCDate())),u=(c.getUTCDay()+6)%7;c.setUTCDate(c.getUTCDate()-u);for(var v=52;v>=0;v--){(y=new Date(c)).setUTCDate(c.getUTCDate()-7*v),(w=new Date(y)).setUTCDate(y.getUTCDate()+6),w.setUTCHours(23,59,59,999),o(y,w)}return r}if("mensile"===n){for(var m=new Date(Date.UTC(a.getUTCFullYear(),a.getUTCMonth(),1)),f=23;f>=0;f--){var g=new Date(Date.UTC(m.getUTCFullYear(),m.getUTCMonth()-f,1));o(g,s(d(g.getUTCFullYear(),g.getUTCMonth())))}return r}if("trimestrale"===n){for(var b=Math.floor(a.getUTCMonth()/3),h=11;h>=0;h--){var y,w,_=b-h,S=i+Math.floor(_/4),x=(_%4+4)%4;o(y=l(S,3*x,1),w=s(new Date(Date.UTC(S,3*x+3,0))))}return r}if("semestrale"===n){for(var I=a.getUTCMonth()<6?0:1,E=5;E>=0;E--){var C=I-E,D=i+Math.floor(C/2),k=0===(C%2+2)%2?0:6;o(l(D,k,1),s(new Date(Date.UTC(D,k+6,0))))}return r}for(var T=2;T>=0;T--){var B=i-T;o(l(B,0,1),s(new Date(Date.UTC(B,12,0))))}return r}function m(e,t){var n=p(e||"mensile");return(t||[]).map(function(e){var t=new Date(e.s);return"settimanale"===n?"W"+F(t)+" "+t.getUTCFullYear():"mensile"===n?String(t.getUTCMonth()+1).padStart(2,"0")+"/"+t.getUTCFullYear():"trimestrale"===n?"Q"+(Math.floor(t.getUTCMonth()/3)+1)+" "+t.getUTCFullYear():"semestrale"===n?(t.getUTCMonth()<6?"S1 ":"S2 ")+t.getUTCFullYear():String(t.getUTCFullYear())})}function f(){if(!_())return r();function e(e,t){var n=document.getElementById(e);n&&(n.textContent=t)}function n(e){return(Number(e)||0).toLocaleString("it-IT")+"â‚¬"}function a(e){var t=Number(e)||0;return String(Math.round(t))}function l(e){return String(e).replace(/[&<>'"]/g,function(e){return{"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"}[e]})}function d(e){return(v(e,new Date)||[]).map(function(e){return{s:e.s,e:e.e}})}function c(e,t,n,a){var i=a||u("dash"),r=String(i.type||"mensile").toLowerCase(),o="ytd"===r||"ltm"===r?"mensile":r,l=d(r);function s(e,t){var n=new Date(t.startDate).getTime(),a=new Date(t.endDate).getTime();return n>=e.s&&a<=e.e}function c(e,t){if(!e)return 0;if("VSDTotale"===t)return Number(e.VSDPersonale||0)+Number(e.VSDIndiretto||0);if("ProvvGI"===t)return Number(e.ProvvGI||0);if("ProvvVSD"===t)return Number(e.ProvvVSD||0);if("TotProvvigioni"===t){var n=e.TotProvvigioni;return Number(null!=n?n:Number(e.ProvvGI||0)+Number(e.ProvvVSD||0))}return Number(e[t]||0)}var p,v,m,f=(p=l.length?A(new Date(l[0].s)):A(new Date),v=l.length?A(new Date(l[l.length-1].e)):A(new Date),m="?global=1&type="+encodeURIComponent(o)+"&from="+encodeURIComponent(p)+"&to="+encodeURIComponent(v),n&&(m+="&userId="+encodeURIComponent(n)),m);return k("/api/periods"+f).catch(function(){return k("/api/periods"+f.replace("?global=1",""))}).then(function(a){var i=(a&&a.periods||[]).filter(function(e){return e.type===o&&(!n||String(e.userId||e.uid||"")===String(n))}),r=function(e){switch(String(e)){case"provv_gi":return"ProvvGI";case"provv_vsd":return"ProvvVSD";case"tot_provv":return"TotProvvigioni";default:return e}}(e);return l.map(function(e){for(var n=0,a=0;a<i.length;a++){var o=i[a];if(s(e,o))n+=c("previsionale"===t?o.indicatorsPrev||{}:o.indicatorsCons||{},r)}return{x:new Date(e.s),y:Math.round(100*n)/100}})})}function f(){var t,i,r,o=(document.getElementById("dash_mode")||{}).value||"consuntivo",l=u("dash"),s=p(l.type||"mensile"),d=new Date(l.start).getTime(),c=new Date(l.end).getTime(),v=(document.getElementById("dash_cons")||{}).value||"";function m(e){return e=Number(null==e?"":e),isFinite(e)?e:0}function f(e){if(!e)return 0;for(var t=["VSDIndiretto","vsdIndiretto","VSD_indiretto","VSDI"],n=0;n<t.length;n++)if(null!=e[t[n]])return m(e[t[n]]);return null!=e.VSDTotale&&null!=e.VSDPersonale?m(e.VSDTotale)-m(e.VSDPersonale):0}function g(e){return e?null!=e.TotProvvigioni?m(e.TotProvvigioni):m(e.ProvvGI)+m(e.ProvvVSD):0}return k("/api/periods"+(t=A(new Date(d)),i=A(new Date(c)),r="?type="+encodeURIComponent(s)+"&from="+encodeURIComponent(t)+"&to="+encodeURIComponent(i),v&&(r+="&userId="+encodeURIComponent(v)),r)).then(function(t){for(var i=t&&t.periods||[],r={VSS:0,VSDPersonale:0,VSDIndiretto:0,GI:0,NNCF:0,PROVV:0},l=0;l<i.length;l++){var u=i[l];if(String(u.type)===String(s)&&(!v||String(u.userId||u.uid||"")===String(v))){var p=new Date(u.startDate).getTime(),b=new Date(u.endDate).getTime();if(!(p<d||b>c)){var h="previsionale"===o?u.indicatorsPrev||{}:u.indicatorsCons||{};r.VSS+=m(h.VSS),r.VSDPersonale+=m(h.VSDPersonale),r.VSDIndiretto+=f(h),r.GI+=m(h.GI),r.NNCF+=m(h.NNCF),r.PROVV+=g(h)}}}e("kpi_vss",n(r.VSS)),e("kpi_vsd",n(r.VSDPersonale)),e("kpi_vsd_ind",n(r.VSDIndiretto)),e("kpi_gi",n(r.GI)),e("kpi_nncf",a(r.NNCF)),e("kpi_provv",n(r.PROVV))})}function h(){var e=(document.getElementById("dash_mode")||{}).value||"consuntivo",n=(document.getElementById("dash_cons")||{}).value||"",a=u("dash"),i=String(a.type||"mensile").toLowerCase(),r=d(i),o=m(i,r);function l(e,n){var a=e.map(function(e){return e.y});!function(e,n,a){var i=document.getElementById(e);if(i)if("function"!=typeof window.drawFullLine){var r=i.getContext("2d");i.width=i.clientWidth||320,i.height=i.clientHeight||80,r.clearRect(0,0,i.width,i.height);var o=Math.max.apply(Math,[1].concat(t(a))),l=a.length>1?(i.width-8)/(a.length-1):0;r.strokeStyle="#2e6cff",r.lineWidth=2,r.beginPath();for(var s=0;s<a.length;s++){var d=4+s*l,c=i.height-6-a[s]/o*(i.height-12);0===s?r.moveTo(d,c):r.lineTo(d,c)}r.stroke()}else window.drawFullLine(e,n,a)}(n,o,a)}Promise.all([c("VSS",e,n||null,a),c("VSDPersonale",e,n||null,a),c("VSDIndiretto",e,n||null,a),c("GI",e,n||null,a),c("NNCF",e,n||null,a),c("TotProvvigioni",e,n||null,a)]).then(function(e){l(e[0],"d_mini_vss"),l(e[1],"d_mini_vsdpersonale"),l(e[2],"d_mini_vsdindiretto"),l(e[3],"d_mini_gi"),l(e[4],"d_mini_nncf"),l(e[5],"d_mini_provv")}).catch(function(e){logger.error(e)})}function y(){var e=(document.getElementById("dash_cons")||{}).value||"";function t(e){return'<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px">'+e+"</div>"}function i(e){var t=new Date(e.start),i=new Date(e.end);(!(i instanceof Date)||isNaN(i)||i<t)&&(i=new Date(t.getTime()+6e4*function(e){return(e=String(e||"").toLowerCase()).indexOf("mezza")>-1?240:e.indexOf("giorn")>-1||e.indexOf("formaz")>-1||e.indexOf("mbs")>-1?570:e.indexOf("sottoprod")>-1?240:(e.indexOf("vend"),90)}(e.type||"vendita")));var r,o=P(t)+" "+M(t)+"â€“"+("0"+i.getHours()).slice(-2)+":"+("0"+i.getMinutes()).slice(-2),s=e.nncf?" Â· NNCF âœ…":"",d=String(e.type||"").toLowerCase();return r=d.indexOf("mbs")>-1?"VSD ind "+n(e.vsdIndiretto||0):d.indexOf("sottoprod")>-1?"Tel "+a(e.telefonate||0)+" Â· AppFissati "+a(e.appFissati||0):d.indexOf("formaz")>-1?"":"VSS "+n(e.vss||0)+" Â· VSD "+n(e.vsdPersonal||0)+s,'<div class="card lastApp" data-aid="'+l(String(e.id||""))+'" style="cursor:pointer"><div class="small muted">'+l(o)+" Â· "+l(e.type||"manuale")+'</div><div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><div><b>'+l(e.client||"")+'</b></div><div class="row" style="gap:6px"><button class="ghost btn-ics" title="Esporta .ics" data-ics="'+l(String(e.id||""))+'">ðŸ“…</button></div></div>'+(r?'<div class="small">'+r+"</div>":"")+"</div>"}function r(e){return e=Number(e||0),isFinite(e)?e:0}!function(){var e=document.getElementById("lastApps");if(e){var t=e.parentElement;if(!document.getElementById("nextApps")){var n=document.createElement("div");n.className="card",n.innerHTML='<b>Prossimi appuntamenti (oggi + domani)</b><div id="nextApps" style="margin-top:8px"></div>',t.parentElement.insertBefore(n,t)}}}();var o,s,d,c=(o=A(new Date(rDash.start)),s=A(new Date(rDash.end)),d="?type="+encodeURIComponent(typeDash)+"&from="+encodeURIComponent(o)+"&to="+encodeURIComponent(s),e&&(d+="&userId="+encodeURIComponent(e)),d);Promise.all([k("/api/appointments"),k("/api/periods"+c)]).then(function(o){var s=o[0]&&o[0].appointments||[],d=o[1]&&o[1].periods||[],c=u("dash")||{},v=p(c.type||"mensile");!function(){var n=document.getElementById("nextApps");if(n){var a=new Date,r=new Date(a.getFullYear(),a.getMonth(),a.getDate(),0,0,0,0),o=new Date(a.getFullYear(),a.getMonth(),a.getDate()+2,0,0,0,0),l=s.filter(function(t){var n=new Date(t.start).getTime(),a=n>=r.getTime()&&n<o.getTime(),i=!e||String(t.userId||t.uid||"")===String(e);return a&&i}).sort(function(e,t){return new Date(e.start)-new Date(t.start)});n.innerHTML=l.length?t(l.map(i).join("")):'<div class="muted">Nessun appuntamento tra oggi e domani</div>',n.querySelectorAll(".lastApp[data-aid]").forEach(function(e){e.addEventListener("click",function(){try{b("bp_edit_aid",e.getAttribute("data-aid"))}catch(t){}x()})}),n.querySelectorAll("button[data-ics]").forEach(function(e){e.addEventListener("click",function(t){t.stopPropagation();var n=e.getAttribute("data-ics"),a=l.find(function(e){return String(e.id)===String(n)})||s.find(function(e){return String(e.id)===String(n)});if(a)if(window.BP&&BP.ICS&&"function"==typeof BP.ICS.downloadIcsForAppointment)if(BP.ICS.downloadIcsForAppointment(a)){"function"==typeof haptic&&haptic("medium");try{document.dispatchEvent(new Event("ics:exported"))}catch(i){}Y(".ics esportato")}else Y("Export .ics non disponibile");else Y("Export .ics non disponibile");else Y("Appuntamento non trovato")})})}}(),function(){var n=document.getElementById("lastApps");if(n){var a=s.filter(function(t){return!e||String(t.userId||t.uid||"")===String(e)}).sort(function(e,t){return new Date(t.start)-new Date(e.start)}).slice(0,6);n.innerHTML=a.length?t(a.map(i).join("")):'<div class="muted">Nessun appuntamento</div>',n.querySelectorAll(".lastApp[data-aid]").forEach(function(e){e.addEventListener("click",function(){try{b("bp_edit_aid",e.getAttribute("data-aid"))}catch(t){}x()})}),n.querySelectorAll("button[data-ics]").forEach(function(e){e.addEventListener("click",function(t){t.stopPropagation();var n=e.getAttribute("data-ics"),i=a.find(function(e){return String(e.id)===String(n)})||s.find(function(e){return String(e.id)===String(n)});if(i)if(window.BP&&BP.ICS&&"function"==typeof BP.ICS.downloadIcsForAppointment)if(BP.ICS.downloadIcsForAppointment(i)){"function"==typeof haptic&&haptic("medium");try{document.dispatchEvent(new Event("ics:exported"))}catch(r){}Y(".ics esportato")}else Y("Export .ics non disponibile");else Y("Export .ics non disponibile");else Y("Appuntamento non trovato")})})}}(),function(){var i=document.getElementById("lastBPs");if(i){var o=d.filter(function(t){return String(t.type)===String(v)&&(!e||String(t.userId||t.uid||"")===String(e))}).sort(function(e,t){return new Date(t.endDate)-new Date(e.endDate)}).slice(0,3).map(function(e){var t=H(e.type,e.startDate),i=e.indicatorsPrev||{},o=e.indicatorsCons||{},s=function(e){return e&&Object.keys(e).length>0}(o),d=s?o:i,c=r(d.VSS),u=r(d.VSDPersonale),p=r(d.VSDIndiretto),v=r(d.GI),m=r(d.NNCF),f=u+p;return'<div class="card lastBP" data-pid="'+l(String(e.id||""))+'" style="cursor:pointer;flex:1 1 320px"><div style="display:flex;align-items:center;gap:8px"><div><b>'+l(t)+'</b></div><span class="chip small">'+(s?"Consuntivo":"Previsionale")+'</span></div><div class="row" style="margin-top:6px;gap:8px;flex-wrap:wrap"><span class="chip small">VSS <b>'+n(c)+'</b></span><span class="chip small">VSD <b>'+n(f)+'</b> <span class="muted">(P '+n(u)+" Â· I "+n(p)+')</span></span><span class="chip small">GI <b>'+n(v)+'</b></span><span class="chip small">NNCF <b>'+a(m)+"</b></span></div></div>"}).join("");i.innerHTML=o?t(o):'<div class="muted">Nessun BP</div>',i.querySelectorAll(".lastBP[data-pid]").forEach(function(e){e.addEventListener("click",function(){try{b("bp_open_period",{id:e.getAttribute("data-pid"),mode:!1})}catch(t){}g()})})}}()}).catch(function(e){logger.error(e)})}document.title="Battle Plan â€“ Dashboard",i.innerHTML=X()+'<div class="wrap"><div class="card"><b>Filtro</b><div class="row" style="margin-top:6px;align-items:flex-end;gap:16px;flex-wrap:wrap"><div><label>ModalitÃ </label><select id="dash_mode" name="mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div><div><label>Consulente</label><select id="dash_cons"><option value="">Tutti</option></select></div></div>'+o("dash")+'</div><div class="grid" id="kpiGrid"><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>VSS</b><span id="kpi_vss" class="big">â€”</span></div><canvas id="d_mini_vss" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>VSD personale</b><span id="kpi_vsd" class="big">â€”</span></div><canvas id="d_mini_vsdpersonale" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>VSD indiretto</b><span id="kpi_vsd_ind" class="big">â€”</span></div><canvas id="d_mini_vsdindiretto" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>GI</b><span id="kpi_gi" class="big">â€”</span></div><canvas id="d_mini_gi" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>NNCF</b><span id="kpi_nncf" class="big">â€”</span></div><canvas id="d_mini_nncf" width="320" height="90"></canvas></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><b>Tot Provvigioni</b><span id="kpi_provv" class="big">â€”</span></div><canvas id="d_mini_provv" width="320" height="90"></canvas></div></div><div class="card"><b>Ultimi appuntamenti</b><div id="lastApps" class="row" style="margin-top:8px"></div></div><div class="card"><b>Ultimi BP inviati</b><div id="lastBPs" class="row" style="margin-top:8px"></div></div></div>',K(),k("/api/usernames").then(function(e){var t=e&&e.users||[],n=document.getElementById("dash_cons");n&&(n.innerHTML='<option value="">Tutti</option>'+t.map(function(e){return'<option value="'+l(String(e.id))+'">'+l(e.name||e.email||"User #"+e.id)+"</option>"}).join(""))}).catch(function(){}),s("dash",function(){"function"==typeof haptic&&haptic("light"),f(),h(),y()});var w=document.getElementById("dash_mode");w&&(w.onchange=function(){"function"==typeof haptic&&haptic("light"),f(),h(),y()});var S=document.getElementById("dash_cons");S&&(S.onchange=function(){"function"==typeof haptic&&haptic("light"),f(),h(),y()}),f(),h(),y(),"function"==typeof kickFinal&&kickFinal("dashboard")}function g(){if(!_())return r();document.title="Battle Plan â€“ BP",i.innerHTML=X()+'<div class="wrap"><div class="card"><b>Da inviare</b><div id="bp_to_send" class="grid" style="margin-top:8px"></div></div><div class="card" id="bp_sent_box" style="margin-top:8px"><div id="bp_sent_head" style="display:flex;align-items:center;justify-content:space-between;cursor:pointer"><b>BP inviati (periodi in essere)</b><span id="bp_sent_chev" class="chev">â–¸</span></div><div id="bp_sent" class="row" style="margin-top:8px;display:none"></div></div><div class="card" style="margin-top:8px"><b>Crea/Aggiorna BP</b><div class="row" style="margin-top:8px"><div><label>Tipo</label><select id="p_type"><option value="settimanale">Settimanale (lunâ€“dom)</option><option value="mensile">Mensile</option><option value="trimestrale">Trimestrale</option><option value="semestrale">Semestrale</option><option value="annuale">Annuale</option></select></div><div id="wrap_week" style="display:none"><label>Settimana ISO (1â€“53)</label><input type="number" id="p_week" min="1" max="53" value="'+F(new Date)+'"></div><div id="wrap_month" style="display:none"><label>Mese</label><select id="p_month"><option value="1">Gennaio</option><option value="2">Febbraio</option><option value="3">Marzo</option><option value="4">Aprile</option><option value="5">Maggio</option><option value="6">Giugno</option><option value="7">Luglio</option><option value="8">Agosto</option><option value="9">Settembre</option><option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option></select></div><div id="wrap_quarter" style="display:none"><label>Trimestre</label><select id="p_quarter"><option value="1">T1</option><option value="2">T2</option><option value="3">T3</option><option value="4">T4</option></select></div><div id="wrap_semester" style="display:none"><label>Semestre</label><select id="p_sem"><option value="1">1Â° semestre</option><option value="2">2Â° semestre</option></select></div><div><label>Anno</label><input type="number" id="p_year" min="2000" max="2100" value="'+(new Date).getFullYear()+'"></div></div><div class="row"><div class="small muted">ModalitÃ : <b id="p_mode_lbl">Previsionale</b> Â· <button class="ghost" id="btnImport" style="padding:4px 8px">Importa da agenda</button></div></div><div class="row" style="align-items:center"><div class="small"><b>Periodo selezionato:</b> <span id="p_label" class="neon">â€”</span></div><input type="hidden" id="p_start"><input type="hidden" id="p_end"></div><div class="row small" style="margin-top:6px;opacity:.9"><div><b>Previsionale</b></div><div><b>Consuntivo</b></div><div><b>Avanzamento</b></div></div><div class="row" id="p_rows" style="margin-top:4px"></div><div class="row" style="margin-top:8px;align-items:center;gap:8px;justify-content:space-between"><div id="p_delete_zone"></div><div class="right"><button id="btnSaveP">Salva BP</button></div></div></div><div class="card"><b>BP salvati</b><div id="p_list" class="row" style="margin-top:8px"></div></div></div>',K();var e=!1,t=null,n=[],a=null,o=_()||{};function l(e){return String(e).replace(/[&<>'"]/g,function(e){return{"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"}[e]})}function s(e){if(!e)return"";var t=new Date(e);return t.getFullYear()+"-"+("0"+(t.getMonth()+1)).slice(-2)+"-"+("0"+t.getDate()).slice(-2)}function d(e){var t=new Date(e);return("0"+t.getDate()).slice(-2)+"/"+("0"+(t.getMonth()+1)).slice(-2)+"/"+t.getFullYear()}function c(e){return(Number(e)||0).toLocaleString("it-IT")+"â‚¬"}function u(e){var t=document.createElement("div");return t.innerHTML=e.trim(),t.firstChild}function p(e){return!!(e&&e.indicatorsCons&&Object.keys(e.indicatorsCons).length>0)}function v(){return"senior"===(o&&o.grade||(_()||{}).grade)?"senior":"junior"}o&&o.grade?Promise.resolve(o):k("/api/usernames").then(function(e){var t=String((_()||{}).id||""),n=(e&&e.users||[]).find(function(e){return String(e.id)===t});return n&&n.grade&&(o.grade=n.grade),o}).catch(function(){return o});var m=document.getElementById("p_type"),f=document.getElementById("p_year"),g=document.getElementById("wrap_week"),b=document.getElementById("wrap_month"),w=document.getElementById("wrap_quarter"),S=document.getElementById("wrap_semester"),x=document.getElementById("p_week"),I=document.getElementById("p_month"),E=document.getElementById("p_quarter"),C=document.getElementById("p_sem"),D=document.getElementById("p_label"),B=document.getElementById("p_start"),P=document.getElementById("p_end"),A=document.getElementById("p_mode_lbl"),M=document.getElementById("btnImport");function J(t){e=!!t,A.textContent=e?"Consuntivo":"Previsionale",M.style.display=e?"none":"",document.querySelectorAll("[data-row]").forEach(function(t){var n=t.querySelector("[data-prev]"),a=t.querySelector("[data-cons]"),i=t.querySelector("[data-bar]");if(e){if(n){n.removeAttribute("hidden");var r=n.querySelector("input");r&&(r.setAttribute("readonly","readonly"),r.classList.add("disabled"))}if(a){a.removeAttribute("hidden");var o=a.querySelector("input");o&&(o.removeAttribute("readonly"),o.classList.remove("disabled"))}i&&i.removeAttribute("hidden")}else{if(n){n.removeAttribute("hidden");var l=n.querySelector("input");l&&(l.removeAttribute("readonly"),l.classList.remove("disabled"))}a&&a.setAttribute("hidden","hidden"),i&&i.setAttribute("hidden","hidden")}}),oe()}function Z(){var e=m.value;g.style.display="settimanale"===e?"":"none",b.style.display="mensile"===e?"":"none",w.style.display="trimestrale"===e?"":"none",S.style.display="semestrale"===e?"":"none",$()}function $(){var e,n,i,r=m.value,o=parseInt(f.value,10);if("settimanale"===r){var l=Math.max(1,Math.min(53,parseInt(x.value||"1",10))),c=q(o,l);e=c.start,n=c.end,i="Sett. "+l+" Â· "+d(e)+" â†’ "+d(n)}else if("mensile"===r){var u=parseInt(I.value,10);e=new Date(o,u-1,1),n=new Date(o,u,0),i=e.toLocaleString("it-IT",{month:"long",year:"numeric"})+" Â· "+d(e)+" â†’ "+d(n)}else if("trimestrale"===r){var p=parseInt(E.value,10);e=new Date(o,3*(p-1),1),n=new Date(o,3*p,0),i="Trimestre "+p+" "+o+" Â· "+d(e)+" â†’ "+d(n)}else if("semestrale"===r){var v=parseInt(C.value,10);e=new Date(o,1===v?0:6,1),n=new Date(o,1===v?6:12,0),i=(1===v?"1Â°":"2Â°")+" semestre "+o+" Â· "+d(e)+" â†’ "+d(n)}else e=new Date(o,0,1),n=new Date(o,11,31),i="Anno "+o+" Â· "+d(e)+" â†’ "+d(n);B.value=s(e),P.value=s(n),D.textContent=i,J(!1),t=null,a=null,ne(),oe()}function Q(e){for(var t="",a=0;a<e.length;a++){var i=e[a],r=/^(VSS|VSDPersonale|VSDIndiretto|GI)$/i.test(i);t+='<div class="row" data-row="'+i+'"><div data-prev><label>'+i+' (Prev)</label><input type="number" step="1" id="prev_'+i+'" placeholder="'+(r?"â‚¬":"n")+'"></div><div data-cons><label>'+i+' (Cons)</label><input type="number" step="1" id="cons_'+i+'" placeholder="'+(r?"â‚¬":"n")+'"></div><div data-bar class="small"><div style="height:10px;background:rgba(255,255,255,.12);border-radius:999px;overflow:hidden"><div id="bar_'+i+'" style="height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2));"></div></div><div id="pct_'+i+'" class="small muted">0%</div></div></div>'}document.getElementById("p_rows").innerHTML=t,J(!1),function(){for(var e=0;e<n.length;e++)(function(e){var t=document.getElementById("prev_"+e),n=document.getElementById("cons_"+e);t&&(t.oninput=ee),n&&(n.oninput=ee)})(n[e])}(),ee()}function ee(){for(var e=0;e<n.length;e++){var t=n[e],a=document.getElementById("prev_"+t),i=document.getElementById("cons_"+t);if(a&&i){var r=Number(a.value||0),o=Number(i.value||0),l=r>0?Math.round(o/r*100):o>0?100:0;l=Math.max(0,Math.min(200,l));var s=document.getElementById("bar_"+t),d=document.getElementById("pct_"+t);s&&(s.style.width=Math.min(l,100)+"%"),d&&(d.textContent=l+"%")}}}function te(){for(var e=0;e<n.length;e++){var t=document.getElementById("prev_"+n[e]);t&&(t.value="")}ee()}function ne(){for(var e=0;e<n.length;e++){var t=document.getElementById("cons_"+n[e]);t&&(t.value="")}ee()}function ae(e){for(var t in e){var n=document.getElementById("prev_"+t);n&&(n.value=String(e[t]||0))}ee()}function ie(e,t){e=Object.assign({},e||{});var n=.15*Number(e.GI||0),a=Number(e.VSDPersonale||0)*("senior"===String(t)?.25:.2);return e.ProvvGI=Math.round(100*n)/100,e.ProvvVSD=Math.round(100*a)/100,e.TotProvvigioni=Math.round(100*(e.ProvvGI+e.ProvvVSD))/100,e}function re(e,t,n){return fetch(t,{method:e,headers:n?{"Content-Type":"application/json"}:void 0,body:n?JSON.stringify(n):void 0}).then(function(e){return e.ok?e.json().catch(function(){return{}}):Promise.reject(new Error("HTTP "+e.status))})}function oe(){var e=document.getElementById("p_delete_zone");if(e)if(t){var n="";!(!a||!p(a))&&(n+='<button id="btnDelCons" class="ghost" style="border-color:#7d1731;color:#7d1731">Elimina Consuntivo</button> '),n+='<button id="btnDelBP" class="ghost" style="border-color:#7d1731;color:#7d1731">Elimina BP</button>',e.innerHTML=n;var i=document.getElementById("btnDelBP");i&&(i.onclick=function(){confirm("Eliminare definitivamente questo BP?")&&(i.disabled=!0,function(e){for(var t=encodeURIComponent(e),n=[function(){return re("POST","/api/periods/delete",{id:e})},function(){return re("POST","/api/periods",{id:e,_delete:!0})},function(){return re("POST","/api/periods/"+t,{_method:"DELETE"})},function(){return re("DELETE","/api/periods/"+t,null)},function(){return re("DELETE","/api/periods?id="+t,null)}],a=Promise.reject(new Error("start")),i=0;i<n.length;i++)(function(e){a=a.catch(e)})(n[i]);return a.catch(function(e){throw logger.warn("Delete fallback: tutte le route fallite",e),e})}(t).then(function(){Y("BP eliminato");try{document.dispatchEvent(new Event("bp:deleted"))}catch(e){}t=null,a=null,te(),ne(),J(!1),$(),le()}).catch(function(){Y("Endpoint delete non disponibile")}).finally(function(){i.disabled=!1}))});var r=document.getElementById("btnDelCons");r&&(r.onclick=function(){if(confirm("Rimuovere solo il Consuntivo?")){r.disabled=!0;var e,n=(e={},a?{id:t||a.id,type:a.type,startDate:s(a.startDate),endDate:s(a.endDate),indicatorsPrev:Object.assign({},a.indicatorsPrev||{}),indicatorsCons:null!=e?e:Object.assign({},a.indicatorsCons||{})}:null);if(n){var i=v();n.indicatorsPrev=ie(n.indicatorsPrev,i),n.indicatorsCons={},T("/api/periods",n).then(function(){Y("Consuntivo eliminato");try{document.dispatchEvent(new Event("bp:saved"))}catch(e){}a&&(a.indicatorsCons={}),J(!0),le(),oe()}).catch(function(){Y("Errore eliminazione Consuntivo")}).finally(function(){r.disabled=!1})}else r.disabled=!1}})}else e.innerHTML=""}function le(){k("/api/periods").then(function(e){var t=e.periods||[];t.sort(function(e,t){return new Date(t.startDate)-new Date(e.startDate)});for(var n="",a=0;a<t.length;a++){var i=t[a];n+='<div class="card" style="flex:1 1 360px"><div><b>'+l(H(i.type,i.startDate)+" Â· "+d(i.startDate)+" â†’ "+d(i.endDate))+'</b></div><div class="small">Prev VSS '+c((i.indicatorsPrev||{}).VSS||0)+" Â· Cons "+c((i.indicatorsCons||{}).VSS||0)+'</div><div class="right" style="margin-top:6px"><button class="ghost" data-edit="'+i.id+'">Modifica previs.</button><button data-cons="'+i.id+'">Consuntivoâ€¦</button></div></div>'}document.getElementById("p_list").innerHTML=n||'<div class="muted">Nessun BP</div>',document.querySelectorAll("[data-edit]").forEach(function(t){t.addEventListener("click",function(){var n=t.getAttribute("data-edit"),a=(e.periods||[]).find(function(e){return e.id===n});a&&se(a,!1)})}),document.querySelectorAll("[data-cons]").forEach(function(t){t.addEventListener("click",function(){var n=t.getAttribute("data-cons"),a=(e.periods||[]).find(function(e){return e.id===n});a&&se(a,!0)})}),function(e){var t=document.getElementById("bp_to_send"),n=document.getElementById("bp_sent");function a(t,n,a){return e.find(function(e){return e.type===t&&s(e.startDate)===s(n)&&s(e.endDate)===s(a)})}t.innerHTML="",n.innerHTML="";var i=new Date,r=i.getDay(),o=5===r||6===r||0===r,c=L(i),v=O(i),g=R(i),b=z(i),h=o&&ue(c),y=o&&ue(v),w=o&&ue(g),_=o&&ue(b);function S(e,n,i){var r=a(e,i.start,i.end),o=a(e,n.start,n.end);r?t.appendChild(pe("Previsionale",e,i.start,i.end,"Modifica",function(){se(r,!1)})):t.appendChild(pe("Previsionale",e,i.start,i.end,"Compila",function(){if(m.value=e,f.value=String(i.start.getFullYear()),"settimanale"===e)x.value=String(F(i.start));else if("mensile"===e)I.value=String(i.start.getMonth()+1);else if("trimestrale"===e){var t=Math.floor(i.start.getMonth()/3)+1;E.value=String(t)}else"semestrale"===e&&(C.value=i.start.getMonth()<6?"1":"2");Z()})),o&&!p(o)&&t.appendChild(pe("Consuntivo",e,n.start,n.end,"Consuntivo",function(){se(o,!0)}))}if(["settimanale","mensile","trimestrale","semestrale","annuale"].forEach(function(e){var t=de(e,i),r=a(e,t.start,t.end);if(r){var o=u('<div class="card" style="flex:1 1 360px"><div><b>'+l(H(e,t.start))+'</b></div><div class="small muted">'+d(t.start)+" â†’ "+d(t.end)+'</div><div class="right" style="margin-top:6px"><button class="ghost" type="button" data-mid="'+r.id+'">Modifica</button></div></div>');o.querySelector("[data-mid]").addEventListener("click",function(){se(r,!1)}),n.appendChild(o)}}),o){S("settimanale",de("settimanale",i),ce("settimanale",i))}if(h){S("mensile",de("mensile",i),ce("mensile",i))}if(y){S("trimestrale",de("trimestrale",i),ce("trimestrale",i))}if(w){S("semestrale",de("semestrale",i),ce("semestrale",i))}if(_){S("annuale",de("annuale",i),ce("annuale",i))}t.children.length||(t.innerHTML='<div class="muted">Nessun suggerimento attivo in questo momento</div>');var D=document.getElementById("bp_sent_head"),k=document.getElementById("bp_sent_chev");D.onclick=function(){var e=document.getElementById("bp_sent"),t="none"!==e.style.display;e.style.display=t?"none":"",k.textContent=t?"â–¸":"â–¾"}}(t);var r=h("bp_open_period",null);if(r){y("bp_open_period");var o=t.find(function(e){return e.id===r.id});o&&se(o,!0===r.mode)}})}function se(e,n){a=e||null,m.value=e.type;var i=new Date(e.startDate),r=i.getFullYear();if(f.value=String(r),"settimanale"===e.type)x.value=String(F(i));else if("mensile"===e.type)I.value=String(i.getMonth()+1);else if("trimestrale"===e.type){var o=Math.floor(i.getMonth()/3)+1;E.value=String(o)}else"semestrale"===e.type&&(C.value=i.getMonth()<6?"1":"2");Z(),te(),ne(),ae(e.indicatorsPrev||{}),function(e){for(var t in e){var n=document.getElementById("cons_"+t);n&&(n.value=String(e[t]||0))}ee()}(e.indicatorsCons||{}),J(!!n),t=e.id||null,oe(),Y(n?"Compila il consuntivo":"Modifica previsionale"),window.scrollTo({top:0,behavior:"smooth"})}function de(e,t){var n=(t=t||new Date).getFullYear();if("settimanale"===e){var a=q(n,F(t));return{start:a.start,end:a.end}}return"mensile"===e?{start:N(t),end:L(t)}:"trimestrale"===e?{start:U(t),end:O(t)}:"semestrale"===e?{start:V(t),end:R(t)}:{start:j(t),end:z(t)}}function ce(e,t){return t=t||new Date,"settimanale"===e?G(t):"mensile"===e?(n=t,{start:a=new Date(n.getFullYear(),n.getMonth()+1,1),end:new Date(a.getFullYear(),a.getMonth()+1,0,23,59,59,999)}):"trimestrale"===e?function(e){var t=U(new Date(e.getFullYear(),e.getMonth()+3,1));return{start:t,end:new Date(t.getFullYear(),t.getMonth()+3,0,23,59,59,999)}}(t):"semestrale"===e?function(e){var t=V(new Date(e.getFullYear(),e.getMonth()+6,1));return{start:t,end:new Date(t.getFullYear(),t.getMonth()+6,0,23,59,59,999)}}(t):function(e){var t=j(new Date(e.getFullYear()+1,0,1));return{start:t,end:z(t)}}(t);var n,a}function ue(e){var t=q((new Date).getFullYear(),F(new Date)).start;return Math.floor((new Date(e)-t)/864e5)<=13}function pe(e,t,n,a,i,r){var o=H(t,n),s=u('<div class="card" style="position:relative"><div class="small muted">'+l(e)+"</div><div><b>"+l(o)+'</b></div><div class="small muted">'+d(n)+" â†’ "+d(a)+'</div><div class="right" style="margin-top:6px"><button class="ghost" type="button" data-sug="1">'+l(i)+"</button></div></div>");return s.querySelector("[data-sug]").addEventListener("click",r),s}k("/api/settings").then(function(e){Q(n=e&&e.indicators||["VSS","VSDPersonale","VSDIndiretto","GI","Telefonate","AppFissati","AppFatti","CorsiLeadership","iProfile","MBS","NNCF"])}).catch(function(){Q(n=["VSS","VSDPersonale","GI","NNCF"])}),m.onchange=Z,f.oninput=$,x.oninput=$,I.onchange=$,E.onchange=$,C.onchange=$,M.onclick=function(){if(!e){var t=B.value,n=P.value;t&&n?k("/api/appointments").then(function(e){for(var a=e.appointments||[],i=new Date(t),r=new Date(n),o={VSS:0,VSDPersonale:0,VSDIndiretto:0,GI:0,Telefonate:0,AppFissati:0,AppFatti:0,CorsiLeadership:0,iProfile:0,MBS:0,NNCF:0},l=0;l<a.length;l++){var s=a[l],d=new Date(s.start);d>=i&&d<=r&&(o.VSS+=Number(s.vss||0),o.VSDPersonale+=Number(s.vsdPersonal||0),o.VSDIndiretto+=Number(s.vsdIndiretto||0),o.Telefonate+=Number(s.telefonate||0),o.AppFissati+=Number(s.appFissati||0),s.nncf&&(o.AppFatti+=1,o.NNCF+=1))}ae(o),Y("Previsionale compilato dalla tua agenda"),W(),window.addXP(10)}).catch(function(){Y("Errore import agenda")}):Y("Seleziona il periodo")}},document.getElementById("btnSaveP").onclick=function(){var i=m.value,r=B.value,o=P.value;if(r&&o){for(var l={},s={},d=0;d<n.length;d++){var c=n[d];l[c]=Number(document.getElementById("prev_"+c).value||0),e&&(s[c]=Number(document.getElementById("cons_"+c).value||0))}var u=v();l=ie(l,u),e&&(s=ie(s,u));var p={type:i,startDate:r,endDate:o,indicatorsPrev:l};e&&(p.indicatorsCons=s),t&&(p.id=t),T("/api/periods",p).then(function(n){Y("BP salvato"),e?window.addXP(20):window.addXP(10),W();try{document.dispatchEvent(new Event("bp:saved"))}catch(i){}le(),!t&&n&&n.id&&(t=n.id),t&&a&&(a.indicatorsPrev=l,e&&(a.indicatorsCons=s)),oe()}).catch(function(){Y("Errore salvataggio BP")})}else Y("Seleziona il periodo")},Z(),le()}function x(){if(!_())return r();if(document.title="Battle Plan â€“ Appuntamenti",!document.getElementById("appts_css")){var e=document.createElement("style");e.id="appts_css",e.textContent="\n      .appt-type .seg, #a_nncf.seg{\n        padding:8px 12px;border:1px solid #bcd7ff;border-radius:12px;\n        background:#eef5ff;color:#1463ff;cursor:pointer;user-select:none;\n        transition:.15s;\n      }\n      .appt-type .seg.active, #a_nncf.seg.active{\n        background:var(--accent);color:#fff;border-color:var(--accent);\n        box-shadow:0 0 0 2px rgba(20,99,255,.08) inset;\n      }\n      #a_list .grid3{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}\n    ",document.head.appendChild(e)}function t(e){return String(e).replace(/[&<>'"]/g,function(e){return{"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"}[e]})}function n(e){return(Number(e)||0).toLocaleString("it-IT")+"â‚¬"}function a(e){if(!e)return"";var t=new Date(e);return isNaN(t)?"":t.toISOString()}function o(e){return(e=String(e||"").toLowerCase()).indexOf("mezza")>-1?240:e.indexOf("giorn")>-1||e.indexOf("formaz")>-1||e.indexOf("mbs")>-1?570:e.indexOf("sottoprod")>-1?240:90}i.innerHTML=X()+'<div class="wrap"><div class="card"><b id="a_form_title">Nuovo appuntamento</b><div class="row" style="margin-top:8px;align-items:flex-end;gap:12px;flex-wrap:wrap"><div style="min-width:320px"><label>Cliente *</label><div style="display:flex;gap:8px;align-items:center"><input id="a_client" list="clientList" placeholder="Denominazione" style="flex:1"><datalist id="clientList"></datalist><button id="a_nncf" class="seg" data-active="0" aria-pressed="false">NNCF</button></div></div><div><label>Data/ora inizio</label><input id="a_start" type="datetime-local"></div><div><label>Ora fine</label><input id="a_end" type="time"></div><div><label>Durata (min)</label><input id="a_dur" type="number" placeholder="60" min="1"></div></div><div class="row" style="margin-top:8px"><div style="flex:1"><label>Descrizione appuntamento</label><textarea id="a_desc" rows="2"></textarea></div></div><div class="row" style="align-items:flex-end;gap:12px;flex-wrap:wrap"><div class="appt-type"><label>Tipo</label><div><button type="button" id="t_vendita" class="seg">Vendita</button><button type="button" id="t_mezza"   class="seg" data-vsd="1000">Mezza giornata</button><button type="button" id="t_full"    class="seg" data-vsd="2000">Giornata intera</button><button type="button" id="t_form"    class="seg">Formazione</button><button type="button" id="t_mbs"     class="seg">MBS</button><button type="button" id="t_sotto"   class="seg">Sottoprodotti</button></div><input id="a_type" type="hidden" value="vendita"></div><div id="row_vss"><label>VSS</label><input id="a_vss" type="number" step="1" placeholder="0"></div><div id="row_vsd_p"><label>VSD personale</label><input id="a_vsd" type="number" step="1" placeholder="0"></div><div id="row_vsd_i" style="display:none"><label>VSD indiretto</label><input id="a_vsd_i" type="number" step="1" placeholder="0"></div><div id="row_tel" style="display:none"><label>Telefonate</label><input id="a_tel" type="number" step="1" placeholder="0"></div><div id="row_app" style="display:none"><label>Appunt. fissati</label><input id="a_app" type="number" step="1" placeholder="0"></div></div><div class="row" style="margin-top:8px;gap:8px;align-items:center"><div><button id="btnSaveA">Salva</button></div><div><button id="btnSaveExportA" class="ghost">Salva ed esporta</button></div><div class="right" style="margin-left:auto"><button id="btnDeleteA" class="danger" style="display:none">Elimina</button></div></div></div><div class="card"><b>Elenco appuntamenti</b><div class="row" style="margin-top:8px;align-items:flex-end;gap:12px;flex-wrap:wrap"><div><label>Vista</label><select id="af_type"><option value="sett">Settimana</option><option value="mese">Mese</option></select></div><div id="af_week_wrap"><label>Settimana ISO</label><input id="af_week" type="number" min="1" max="53" value="'+F(new Date)+'"></div><div id="af_month_wrap" style="display:none"><label>Mese</label><select id="af_month"><option value="1">Gennaio</option><option value="2">Febbraio</option><option value="3">Marzo</option><option value="4">Aprile</option><option value="5">Maggio</option><option value="6">Giugno</option><option value="7">Luglio</option><option value="8">Agosto</option><option value="9">Settembre</option><option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option></select></div><div><label>Anno</label><input id="af_year" type="number" min="2000" max="2100" value="'+(new Date).getFullYear()+'"></div><div class="right" style="margin-left:auto;display:flex;gap:8px"><button id="af_prev" class="ghost">â—€</button><button id="af_next" class="ghost">â–¶</button></div></div><div id="a_list" style="margin-top:8px"></div></div></div>',K();var l=document.getElementById("a_nncf");l.addEventListener("click",function(){var e="1"!==l.getAttribute("data-active");l.setAttribute("data-active",e?"1":"0"),l.setAttribute("aria-pressed",e?"true":"false"),l.classList.toggle("active",e),e&&f(document.getElementById("t_vendita"))});var s=document.getElementById("t_vendita"),d=document.getElementById("t_mezza"),c=document.getElementById("t_full"),u=document.getElementById("t_form"),p=document.getElementById("t_mbs"),v=document.getElementById("t_sotto"),m=[s,d,c,u,p,v];function f(e){m.forEach(function(t){return t.classList.toggle("active",t===e)});var t=document.getElementById("a_type"),n=document.getElementById("a_client"),a=document.getElementById("row_vss"),i=document.getElementById("row_vsd_p"),r=document.getElementById("row_vsd_i"),o=document.getElementById("row_tel"),f=document.getElementById("row_app");document.getElementById("a_vss").value="",document.getElementById("a_vsd").value="",document.getElementById("a_vsd_i").value="",document.getElementById("a_tel").value="",document.getElementById("a_app").value="",a.style.display="",i.style.display="",r.style.display="none",o.style.display="none",f.style.display="none",n.disabled=!1,l.style.display="",l.setAttribute("data-active","0"),l.setAttribute("aria-pressed","false"),l.classList.remove("active"),"Formazione"!==n.value&&"MBS"!==n.value&&"Sottoprodotti"!==n.value||(n.value=""),e===s?(t.value="vendita",g(90)):e===d?(t.value="mezza",g(240),document.getElementById("a_vsd").value="1000"):e===c?(t.value="giornata",g(570),document.getElementById("a_vsd").value="2000"):e===u?(t.value="formazione",g(570),n.value="Formazione",n.disabled=!0,a.style.display="none",i.style.display="none",l.style.display="none"):e===p?(t.value="MBS",g(570),n.value="MBS",n.disabled=!0,a.style.display="none",i.style.display="none",r.style.display="",document.getElementById("a_vsd_i").value="2000",l.style.display="none"):e===v&&(t.value="sottoprodotti",g(240),n.value="Sottoprodotti",n.disabled=!0,a.style.display="none",i.style.display="none",o.style.display="",f.style.display="",l.style.display="none")}function g(e){document.getElementById("a_dur").value=String(e),b()}function b(){var e=document.getElementById("a_start").value,t=parseInt(document.getElementById("a_dur").value||"0",10);if(!e||!isFinite(t)||t<=0)document.getElementById("a_end").value="";else{var n=new Date(e),a=new Date(n.getTime()+6e4*t);document.getElementById("a_end").value=("0"+a.getHours()).slice(-2)+":"+("0"+a.getMinutes()).slice(-2)}}m.forEach(function(e){return e.addEventListener("click",function(t){t.preventDefault(),f(e)})}),f(s),document.getElementById("a_start").addEventListener("change",b),document.getElementById("a_dur").addEventListener("input",b),document.getElementById("a_end").addEventListener("change",function(){var e=document.getElementById("a_start").value,t=document.getElementById("a_end").value;if(e&&t){var n=new Date(e),a=t.split(":");if(!(a.length<2)){var i=new Date(n);i.setHours(parseInt(a[0],10)||0,parseInt(a[1],10)||0,0,0),i<n&&i.setDate(i.getDate()+1);var r=Math.round((i-n)/6e4);document.getElementById("a_dur").value=String(Math.max(1,r))}}}),k("/api/clients").then(function(e){var n=e&&e.clients||[],a=document.getElementById("clientList");a&&(a.innerHTML=n.map(function(e){return'<option value="'+t(e.name)+'"></option>'}).join(""))});var S=null;function x(){S=null,document.getElementById("a_form_title").textContent="Nuovo appuntamento",document.getElementById("a_client").value="",document.getElementById("a_start").value="",document.getElementById("a_end").value="",document.getElementById("a_dur").value="",document.getElementById("a_vss").value="",document.getElementById("a_vsd").value="",document.getElementById("a_vsd_i").value="",document.getElementById("a_tel").value="",document.getElementById("a_app").value="",document.getElementById("a_desc").value="",document.getElementById("a_client").disabled=!1,l.style.display="",l.setAttribute("data-active","0"),l.setAttribute("aria-pressed","false"),l.classList.remove("active"),f(s),document.getElementById("btnDeleteA").style.display="none"}function I(e){S=e.id,document.getElementById("a_form_title").textContent="Modifica appuntamento";var t=String(e.type||"vendita").toLowerCase();t.indexOf("mezza")>-1?f(d):t.indexOf("giorn")>-1?f(c):t.indexOf("formaz")>-1?f(u):t.indexOf("mbs")>-1?f(p):t.indexOf("sottoprod")>-1?f(v):f(s),document.getElementById("a_client").value=e.client||"",document.getElementById("a_start").value=function(e){if(!e)return"";var t=new Date(e);return isNaN(t)?"":new Date(t.getTime()-6e4*t.getTimezoneOffset()).toISOString().slice(0,16)}(e.start);var n=new Date(e.start),a=e.end?new Date(e.end):null,i=Number(e.durationMinutes);a instanceof Date&&!isNaN(a)&&a>=n?i=Math.max(1,Math.round((a-n)/6e4)):(isFinite(i)&&i>0||(i=o(e.type||"vendita")),a=new Date(n.getTime()+6e4*i)),document.getElementById("a_dur").value=String(i),document.getElementById("a_end").value=("0"+a.getHours()).slice(-2)+":"+("0"+a.getMinutes()).slice(-2),document.getElementById("a_vss").value=e.vss||"",document.getElementById("a_vsd").value=e.vsdPersonal||e.vsd||"",document.getElementById("a_vsd_i").value=e.vsdIndiretto||"",document.getElementById("a_tel").value=e.telefonate||"",document.getElementById("a_app").value=e.appFissati||"",document.getElementById("a_desc").value=e.notes||"";var r=!!e.nncf;l.setAttribute("data-active",r?"1":"0"),l.setAttribute("aria-pressed",r?"true":"false"),l.classList.toggle("active",r),document.getElementById("btnDeleteA").style.display=""}function E(){var e=(document.getElementById("a_client").value||"").trim(),t=document.getElementById("a_type").value;if(!e){var n=String(t||"").toLowerCase();if("formazione"!==n&&"mbs"!==n&&"sottoprodotti"!==n)return Y("Cliente obbligatorio"),null;e=t}var i=document.getElementById("a_start").value;if(!i)return Y("Data/ora obbligatorie"),null;var r=parseInt(document.getElementById("a_dur").value||"60",10);(!isFinite(r)||r<=0)&&(r=60);var o,s=document.getElementById("a_end").value;if(s){var d=new Date(i),c=s.split(":"),u=new Date(d);u.setHours(parseInt(c[0],10)||0,parseInt(c[1],10)||0,0,0),u<d&&u.setDate(u.getDate()+1),o=u.toISOString(),r=Math.max(1,Math.round((u-d)/6e4)),document.getElementById("a_dur").value=String(r)}else{o=new Date(new Date(i).getTime()+6e4*r).toISOString()}var p=document.getElementById("a_desc").value||"";return{id:S||void 0,client:e,start:a(i),end:o,durationMinutes:r,type:t,vss:Number(document.getElementById("a_vss").value||0),vsdPersonal:Number(document.getElementById("a_vsd").value||0),vsdIndiretto:Number(document.getElementById("a_vsd_i").value||0),telefonate:Number(document.getElementById("a_tel").value||0),appFissati:Number(document.getElementById("a_app").value||0),notes:p,nncf:"1"===l.getAttribute("data-active")}}function C(e){var t=E();if(t){var n=!S;T("/api/appointments",t).then(function(){if(Y("Appuntamento salvato"),"undefined"!=typeof haptics&&haptics.try("success"),document.dispatchEvent(new Event("appt:saved")),n)try{document.dispatchEvent(new Event("appt:created"))}catch(a){}if(e&&window.BP&&BP.ICS&&"function"==typeof BP.ICS.downloadIcsForAppointment)if(BP.ICS.downloadIcsForAppointment(t)){"undefined"!=typeof haptics&&haptics.try("medium");try{document.dispatchEvent(new Event("ics:exported"))}catch(a){}Y(".ics esportato")}else Y("Export .ics non disponibile");x(),U()}).catch(function(){return Y("Errore salvataggio")})}}function D(){if(S&&confirm("Eliminare l'appuntamento?")){var e=E();fetch("/api/appointments?id="+encodeURIComponent(S),{method:"DELETE",headers:{Authorization:"Bearer "+w()}}).then(function(e){if(!e.ok)throw new Error("HTTP "+e.status);return e.json()}).then(function(){Y("Eliminato"),"function"==typeof showUndo&&e&&showUndo("Appuntamento eliminato",function(){return T("/api/appointments",e)},5e3),x(),U()}).catch(function(){return Y("Errore eliminazione")})}}function B(e){var t=document.getElementById("af_type").value,n=parseInt(document.getElementById("af_year").value,10);if("sett"===t){var a=parseInt(document.getElementById("af_week").value,10),i=new Date(q(n,a).start);i.setDate(i.getDate()+7*e),document.getElementById("af_year").value=i.getFullYear(),document.getElementById("af_week").value=F(i)}else{var r=parseInt(document.getElementById("af_month").value,10),o=new Date(n,r-1,1);o.setMonth(o.getMonth()+e),document.getElementById("af_year").value=o.getFullYear(),document.getElementById("af_month").value=o.getMonth()+1}U()}document.getElementById("btnSaveA").onclick=function(){return C(!1)},document.getElementById("btnSaveExportA").onclick=function(){return C(!0)},document.getElementById("btnDeleteA").onclick=D,document.getElementById("af_prev").onclick=function(){return B(-1)},document.getElementById("af_next").onclick=function(){return B(1)};var P=document.getElementById("af_type"),A=document.getElementById("af_week"),M=document.getElementById("af_month"),N=document.getElementById("af_year");function L(e){var a=new Date(e.start),i=e.end?new Date(e.end):null;if(!(i instanceof Date)||isNaN(i)||i<a){var r=isFinite(e.durationMinutes)?Number(e.durationMinutes):o(e.type||"vendita");i=new Date(a.getTime()+6e4*r)}var l,s,d=("0"+(l=new Date(a)).getDate()).slice(-2)+"/"+("0"+(l.getMonth()+1)).slice(-2)+"/"+l.getFullYear()+" "+("0"+a.getHours()).slice(-2)+":"+("0"+a.getMinutes()).slice(-2)+"â€“"+("0"+i.getHours()).slice(-2)+":"+("0"+i.getMinutes()).slice(-2),c=String(e.type||"").toLowerCase();return s=c.indexOf("mbs")>-1?"VSD ind "+n(e.vsdIndiretto||0):c.indexOf("sottoprod")>-1?"Tel "+$(e.telefonate||0)+" Â· AppFissati "+$(e.appFissati||0):c.indexOf("formaz")>-1?"":"VSS "+n(e.vss||0)+" Â· VSD "+n(e.vsdPersonal||0)+" Â· NNCF "+(e.nncf?"âœ…":"â€”"),'<div class="card" data-aid="'+t(String(e.id||""))+'" style="flex:1 1 320px;cursor:pointer"><div class="small muted">'+t(d)+" Â· "+t(e.type||"vendita")+'</div><div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><div><b>'+t(e.client||"")+'</b></div><button class="ghost btn-ics" title="Esporta" data-ics="'+t(String(e.id||""))+'">ðŸ“…</button></div>'+(s?'<div class="small">'+s+"</div>":"")+"</div>"}function U(){k("/api/appointments").then(function(e){var t=e&&e.appointments||[],n=function(){var e=document.getElementById("af_type").value,t=parseInt(document.getElementById("af_year").value,10);if("sett"===e){var n=q(t,Math.max(1,Math.min(53,parseInt(document.getElementById("af_week").value||F(new Date),10))));return{s:new Date(n.start),e:new Date(n.end)}}var a=parseInt(document.getElementById("af_month").value||(new Date).getMonth()+1,10);return{s:new Date(t,a-1,1),e:new Date(t,a,0,23,59,59,999)}}(),a=n.s.getTime(),i=n.e.getTime(),r=t.filter(function(e){var t=new Date(e.start).getTime();return t>=a&&t<=i}).sort(function(e,t){return new Date(e.start)-new Date(t.start)}),o=new Date,l=r.filter(function(e){return new Date(e.start)>=o}),s=r.filter(function(e){return new Date(e.start)<o}),d=document.getElementById("a_list"),c="";c+="<div><b>Prossimi</b></div>",c+=l.length?'<div class="grid3">'+l.map(L).join("")+"</div>":'<div class="muted" style="margin:6px 0 12px">Nessun appuntamento futuro</div>';var u,p,v,m="past_"+Math.random().toString(36).slice(2,8);c+='<div id="'+m+'_head" style="margin-top:12px;display:flex;align-items:center;justify-content:space-between;cursor:pointer"><b>Passati</b><span class="chev">â–¸</span></div><div id="'+m+'_box" style="display:none;margin-top:8px">'+(s.length?'<div class="grid3">'+s.map(L).join("")+"</div>":'<div class="muted">Nessun appuntamento passato</div>')+"</div>",d.innerHTML=c,u=document.getElementById(m+"_head"),p=document.getElementById(m+"_box"),v=u.querySelector(".chev"),u.onclick=function(){var e="none"===p.style.display;p.style.display=e?"":"none",v.textContent=e?"â–¾":"â–¸"};var f=r;d.querySelectorAll("[data-ics]").forEach(function(e){e.addEventListener("click",function(t){t.stopPropagation();var n=e.getAttribute("data-ics"),a=f.find(function(e){return String(e.id)===String(n)});if(a)if(window.BP&&BP.ICS&&"function"==typeof BP.ICS.downloadIcsForAppointment)if(BP.ICS.downloadIcsForAppointment(a)){"undefined"!=typeof haptics&&haptics.try("medium");try{document.dispatchEvent(new Event("ics:exported"))}catch(i){}Y("Esportato")}else Y("Export .ics non disponibile");else Y("Export .ics non disponibile");else Y("Appuntamento non trovato")})}),d.querySelectorAll(".card[data-aid]").forEach(function(e){e.addEventListener("click",function(){var t=e.getAttribute("data-aid"),n=f.find(function(e){return String(e.id)===String(t)});n&&(I(n),window.scrollTo({top:0,behavior:"smooth"}))})})})}P.onchange=function(){var e=P.value;document.getElementById("af_week_wrap").style.display="sett"===e?"":"none",document.getElementById("af_month_wrap").style.display="mese"===e?"":"none",U()},[A,M,N].forEach(function(e){e&&(e.onchange=U)});try{var O=h("bp_prefill_slot",null);if(O&&O.start){var V=new Date(O.start),R=new Date(O.end||O.start),j=new Date(V.getTime()-6e4*V.getTimezoneOffset()).toISOString().slice(0,16);document.getElementById("a_start").value=j,document.getElementById("a_dur").value=String(Math.max(1,Math.round((R-V)/6e4))),b(),Y("Slot precompilato negli appuntamenti")}y("bp_prefill_slot")}catch(G){}try{var z=h("bp_edit_aid",null);z&&k("/api/appointments").then(function(e){var t=(e&&e.appointments||[]).find(function(e){return String(e.id)===String(z)});t&&(I(t),window.scrollTo({top:0,behavior:"smooth"}))}).finally(function(){try{y("bp_edit_aid")}catch(G){}})}catch(G){}document.getElementById("btnSaveA").onclick=function(){return C(!1)},document.getElementById("btnSaveExportA").onclick=function(){return C(!0)},document.getElementById("btnDeleteA").onclick=D,k("/api/clients").then(function(){}),U()}window.$1=window.$1||ae,window.$all=window.$all||ie,window.addXP=window.addXP||function(){},"object"!==e(window.logger)&&(window.logger=["debug","info","log","warn","error"].reduce(function(e,t){return e[t]=(console[t]||console.log).bind(console),e},{})),"function"!=typeof window.haptic&&(window.haptic=function(){}),function(){var e=window.__miniCharts=window.__miniCharts||{};function n(e,n){try{var a=Array.isArray(e)?e.length:0;if(!a)return{autoSkip:!0,maxRotation:0,minRotation:0};var i=Math.max.apply(Math,[0].concat(t(e.map(function(e){return String(e||"").length}))));return a*Math.max(28,Math.min(90,Math.round(7*i)))>1.2*(n||320)?{autoSkip:!0,maxRotation:45,minRotation:45,callback:function(e){return String(e||"")}}:{autoSkip:!0,maxRotation:0,minRotation:0,callback:function(e){return String(e||"")}}}catch(r){return{autoSkip:!0,maxRotation:0,minRotation:0}}}window.computeTickOptions=n,window.drawFullLine=function(a,i,r){var o=document.getElementById(a);if(o)if(o.width=o.clientWidth||o.width||320,o.height=o.clientHeight||o.height||80,"undefined"!=typeof Chart){var l=String(a),s=n(i,o.width||320);if(e[l]&&e[l].canvas!==o){try{e[l].destroy()}catch(u){}delete e[l]}if(e[l]){var d=e[l];d.data.labels=i,d.data.datasets[0].data=r,d.options.scales.x.ticks=n(i,o.width||320),d.update()}else{var c=o.getContext("2d");e[l]=new Chart(c,{type:"line",data:{labels:i,datasets:[{label:"",data:r,borderColor:"#2e6cff",backgroundColor:"rgba(46,108,255,0.10)",borderWidth:2,tension:.3,pointRadius:3,pointHoverRadius:5,fill:!1}]},options:{responsive:!1,maintainAspectRatio:!1,animation:!1,animations:!1,plugins:{legend:{display:!1}},scales:{x:{grid:{display:!1},ticks:s},y:{beginAtZero:!0}}}})}}else!function(e,n,a){var i=e.getContext("2d");e.width=e.clientWidth||320,e.height=e.clientHeight||80,i.clearRect(0,0,e.width,e.height);var r=Math.max.apply(Math,[1].concat(t(a))),o=a.length>1?(e.width-8)/(a.length-1):0;i.strokeStyle="#2e6cff",i.lineWidth=2,i.beginPath();for(var l=0;l<a.length;l++){var s=4+l*o,d=e.height-6-a[l]/r*(e.height-12);0===l?i.moveTo(s,d):i.lineTo(s,d)}i.stroke(),i.fillStyle="#2e6cff";for(var c=0;c<a.length;c++){var u=4+c*o,p=e.height-6-a[c]/r*(e.height-12);i.beginPath(),i.arc(u,p,2,0,2*Math.PI),i.fill()}}(o,0,r)}}(),n=[],window.onUnifiedRangeChange=function(e){"function"==typeof e&&n.push(e)},window.emitUnifiedRangeChange=function(e){for(var t=0,a=n;t<a.length;t++){var i=a[t];try{i(e)}catch(r){logger.error(r)}}},window.effectivePeriodType=p,window.showOverlay=function(e){var t=function(){var e=document.getElementById("bp-overlay");return e||((e=document.createElement("div")).id="bp-overlay",e.className="hidden",e.setAttribute("role","dialog"),e.setAttribute("aria-modal","true"),e.innerHTML='<div class="bp-overlay-backdrop" id="bp-overlay-backdrop"></div><div class="bp-overlay-panel" id="bp-overlay-panel"></div>',document.body.appendChild(e),document.getElementById("bp-overlay-backdrop").addEventListener("click",hideOverlay)),e}(),n=document.getElementById("bp-overlay-panel");n.innerHTML=e||"",t.classList.remove("hidden");var a=n.querySelector("input, textarea, select, button");a&&setTimeout(function(){try{a.focus()}catch(e){}},0)},window.hideOverlay=function(){var e=document.getElementById("bp-overlay");e&&e.classList.add("hidden")},window.viewGI=window.viewGI||function(){if(!_())return r();document.title="Battle Plan â€“ GI & Scadenzario",i.innerHTML=X()+'\n  <div class="wrap">\n\n    <div class="card">\n      <b>Filtro</b>\n      <div class="row" style="margin-top:6px;align-items:flex-end;gap:16px;flex-wrap:wrap">\n        <div>\n          <label>Consulente</label>\n          <select id="gi_cons"><option value="">Tutti</option></select>\n        </div>\n      </div>\n      '.concat(o("gi"),'\n    </div>\n\n    <div class="card">\n      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">\n        <b>Vendite (GI)</b>\n        <button class="ghost" id="gi_add">Nuova vendita</button>\n      </div>\n      <div class="table" style="overflow:auto">\n        <table class="simple" style="min-width:980px">\n          <thead>\n            <tr>\n              <th>Data vendita</th>\n              <th>Cliente</th>\n              <th>Consulente</th>\n              <th>Servizi</th>\n              <th style="text-align:right">Tot. VSS</th>\n              <th>Piano pagamenti</th>\n              <th></th>\n            </tr>\n          </thead>\n          <tbody id="gi_rows"></tbody>\n        </table>\n      </div>\n    </div>\n\n  </div>'),K();var e=function(e){return document.getElementById(e)},t=function(e){return String(e||"").replace(/[&<>'"]/g,function(e){return{"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"}[e]})},n=function(e){return(Number(e)||0).toLocaleString("it-IT")+"â‚¬"},l=function(e){var t=new Date(e);return t.getFullYear()+"-"+("0"+(t.getMonth()+1)).slice(-2)+"-"+("0"+t.getDate()).slice(-2)},c=[];function u(e){return'<tr data-id="'+t(String(e.id))+'"><td>'+new Date(e.date||e.createdAt).toLocaleDateString("it-IT")+"</td><td>"+t(e.clientName||"")+"</td><td>"+t(e.consultantName||"")+"</td><td>"+t(e.services||"")+'</td><td style="text-align:right"><b>'+n(e.vssTotal||0)+"</b></td><td>"+function(e){var t=Array.isArray(e.schedule)?e.schedule.slice():[];if(!t.length)return'<span class="muted">â€”</span>';var a=t.find(function(e){return"deposit"===e.kind||/acconto/i.test(e.note||"")}),i=t.filter(function(e){return e!==a}),r=a?"Acconto: "+n(a.amount):"";if(!i.length)return r||'<span class="muted">â€”</span>';var o=Math.round(i[0].amount||0);return(r?r+" + ":"")+(i.every(function(e){return Math.abs(Math.round(e.amount||0)-o)<=1})?i.length+" rate da "+n(o):"piano personalizzato")}(e)+'</td><td class="right"><button class="ghost" data-edit="'+t(String(e.id))+'">Modifica</button></td></tr>'}function p(){var t=function(){var e=window.readUnifiedRange&&window.readUnifiedRange("gi")||{};if(!e||!e.start||!e.end){var t=new Date,n=new Date(t.getFullYear(),0,1),a=new Date(t.getFullYear(),11,31,23,59,59);return{from:l(n),to:l(a)}}return{from:l(e.start),to:l(e.end)}}(),n=(e("gi_cons")||{}).value||"";k("/api/gi"+("?from="+encodeURIComponent(t.from)+"&to="+encodeURIComponent(t.to)+(n?"&userId="+encodeURIComponent(n):""))).then(function(t){var n=t&&t.sales||[];n.sort(function(e,t){return+new Date(t.date||t.createdAt||0)-+new Date(e.date||e.createdAt||0)}),e("gi_rows").innerHTML=n.length?n.map(u).join(""):'<tr><td colspan="7" class="muted">Nessuna vendita</td></tr>',document.querySelectorAll("[data-edit]").forEach(function(e){e.addEventListener("click",function(){m(e.getAttribute("data-edit"))})})}).catch(function(e){logger.error(e),Y("Errore caricamento GI")})}function v(i){var r=i.sale||{},o=Array.isArray(r.schedule)?r.schedule.slice():[],s=o.find(function(e){return"deposit"===e.kind||/acconto/i.test(e.note||"")}),u=o.filter(function(e){return e!==s}),v=!(u.length>0)||u.every(function(e){return Math.abs((+e.amount||0)-(+u[0].amount||0))<=1}),m=u.length&&v?"rate":"manual",f=l(new Date),g='<div class="modal"><div class="card gi-modal"><style>.gi-modal{min-width:min(760px,96vw);max-width:980px;max-height:86vh;overflow:auto}@media (max-width:740px){ .gi-grid{display:block} .gi-col{width:100%} .gi-modal{min-width:96vw} }.gi-grid{display:flex; gap:12px; flex-wrap:wrap} .gi-col{flex:1; min-width:240px}.gi-section{border-top:1px solid var(--hair, rgba(0,0,0,.12)); padding-top:10px; margin-top:10px}.pilltabs{display:flex; gap:12px; align-items:center} .pilltabs label{display:flex; align-items:center; gap:6px; cursor:pointer}.mrow{display:flex; gap:8px; align-items:center; flex-wrap:wrap}.mini input[type=number]{width:120px}.gi-rlist{margin-top:6px; max-height:200px; overflow:auto; border:1px dashed rgba(0,0,0,.15); border-radius:8px; padding:6px}.gi-r{display:flex; gap:6px; align-items:center; padding:4px 0}.gi-foot{display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:12px}</style><div style="display:flex;justify-content:space-between;align-items:center"><b>'+(i.title||(r.id?"Modifica vendita":"Nuova vendita"))+'</b><button class="ghost" id="m_close">Chiudi</button></div><div class="gi-grid"><div class="gi-col"><label>Data</label><input id="m_date" type="date" value="'+t(l(r.date||f))+'"></div><div class="gi-col"><label>Cliente</label><select id="gi_client_select"><option value="">Caricamentoâ€¦</option></select></div><div class="gi-col"><label>Totale VSS</label><input id="m_vss" type="number" step="1" value="'+t(Number(r.vssTotal||0))+'"></div></div><div class="gi-section"><label>Servizi</label><textarea id="m_srv" rows="2">'+t(r.services||"")+'</textarea></div><div class="gi-section"><b>Acconto</b><div class="mrow mini" style="margin-top:6px"><label><input id="acc_enable" type="checkbox" '+(s?"checked":"")+'> Abilita</label><label>Tipo</label><select id="acc_type"><option value="abs">Valore assoluto</option><option value="perc">Percentuale</option></select><label>Valore</label><input id="acc_value" type="number" step="1" value="'+(s?t(Number(s._fromPerc?s._rawPerc:s.amount)):"0")+'"><label>Scadenza</label><input id="acc_date" type="date" value="'+t(l(s?s.dueDate:r.date||f))+'"><label>Nota</label><input id="acc_note" placeholder="es. Acconto" value="'+t(s&&s.note||"Acconto")+'"></div></div><div class="gi-section"><b>ModalitÃ  pagamenti</b><div class="pilltabs" style="margin:6px 0 8px"><label><input type="radio" name="pmode" value="rate" '+("rate"===m?"checked":"")+'> Rateale</label><label><input type="radio" name="pmode" value="manual" '+("rate"!==m?"checked":"")+'> Scaglioni manuali</label></div><div id="p_rate" style="display:'+("rate"===m?"block":"none")+'"><div class="mrow mini"><label>NÂ° rate</label><input id="rt_n" type="number" value="'+t(u.length||12)+'"><label>Frequenza</label><select id="rt_freq"><option value="M">Mensile</option><option value="Q">Trimestrale</option><option value="W">Settimanale</option><option value="Y">Annuale</option></select><label>Prima scadenza</label><input id="rt_first" type="date" value="'+t(u[0]?l(u[0].dueDate):l(r.date||f))+'"><button class="ghost" id="rt_build">Ricalcola rate</button></div><div id="rt_preview" class="gi-rlist muted small">â€”</div></div><div id="p_manual" style="display:'+("rate"!==m?"block":"none")+'"><div class="mrow mini"><button class="ghost" id="mn_add">Aggiungi scaglione</button></div><div id="mn_list" class="gi-rlist"></div></div></div><div class="gi-foot"><div><div id="tot_prog" class="small muted">Programmato: 0â‚¬</div><div id="tot_chk"  class="small muted">Totale VSS: 0â‚¬</div></div><div style="display:flex;gap:8px">'+(r.id?'<button class="ghost danger" id="m_del">Elimina</button>':"")+'<button id="m_save">Salva</button></div></div></div></div>';showOverlay(g);var b=document.documentElement.style.overflow;function h(){document.documentElement.style.overflow=b,hideOverlay()}function y(e,t){var n=new Date(e);return n.setMonth(n.getMonth()+t),n}function w(e,t){var n=new Date(e);return n.setDate(n.getDate()+7*t),n}function _(e,t){var n=new Date(e);return n.setMonth(n.getMonth()+3*t),n}function S(e,t){var n=new Date(e);return n.setFullYear(n.getFullYear()+t),n}function x(){for(var t=Math.max(1,Number(e("rt_n").value||0)),n=e("rt_freq").value,a=new Date(e("rt_first").value||f),i=Math.max(0,Number(e("m_vss").value||0)),r=D(),o=Math.max(0,i-r),l=Math.round(o/t),s=[],d=0;d<t;d++){var c=void 0;c="M"===n?y(a,d):"Q"===n?_(a,d):"W"===n?w(a,d):S(a,d),s.push({dueDate:c.toISOString(),amount:l,note:"Rata "+(d+1)+"/"+t,kind:"installment"})}return I(s),s}function I(a){e("rt_preview").innerHTML=a.map(function(e){return"<div>"+new Date(e.dueDate).toLocaleDateString("it-IT")+" Â· "+n(e.amount)+' <span class="muted">'+t(e.note||"")+"</span></div>"}).join(""),e("rt_preview")._data=a,B()}function E(n){var a=e("mn_list");a.innerHTML="",n.forEach(function(e,n){var i=document.createElement("div");i.className="gi-r",i.innerHTML='<input type="date" data-k="dueDate" value="'+t(l(e.dueDate))+'"><input type="number" step="1" data-k="amount" value="'+t(Number(e.amount||0))+'" style="width:120px"><input type="text" data-k="note"   value="'+t(e.note||"")+'" placeholder="nota" style="flex:1"><button class="ghost" data-del="'+n+'">âœ•</button>',a.appendChild(i)}),a.querySelectorAll("[data-del]").forEach(function(e){e.onclick=function(){var t=Number(e.getAttribute("data-del")),n=a._data||[];n.splice(t,1),E(n)}}),a.oninput=function(){var e=a._data||[];Array.from(a.children).forEach(function(t,n){var a=e[n];if(a){var i=t.querySelector('[data-k="dueDate"]').value,r=Number(t.querySelector('[data-k="amount"]').value||0),o=t.querySelector('[data-k="note"]').value;a.dueDate=new Date(i).toISOString(),a.amount=Math.round(r),a.note=o}}),B()},a._data=n,B()}if(document.documentElement.style.overflow="hidden",function(){var n=e("gi_client_select");n.innerHTML='<option value="">â€” seleziona cliente â€”</option>'+c.map(function(e){return'<option value="'+t(e.id)+'">'+t(e.name)+"</option>"}).join("");var a=r.clientId||r.client_id||"";if(a&&(n.value=String(a)),!n.value&&r.clientName){var i=c.find(function(e){return String(e.name).trim().toLowerCase()===String(r.clientName).trim().toLowerCase()});i&&(n.value=String(i.id))}}(),s&&s._fromPerc&&(e("acc_type").value="perc"),Array.from(document.querySelectorAll('input[name="pmode"]')).forEach(function(t){t.addEventListener("change",function(){var t="rate"===document.querySelector('input[name="pmode"]:checked').value;e("p_rate").style.display=t?"block":"none",e("p_manual").style.display=t?"none":"block",B()})}),e("m_date").value=t(l(r.date||f)),e("m_vss").value=t(Number(r.vssTotal||0)),e("m_srv").value=t(r.services||""),e("acc_type").value=s&&s._fromPerc?"perc":"abs",e("acc_value").value=s?s._fromPerc?s._rawPerc:s.amount:0,e("acc_date").value=t(l(s?s.dueDate:r.date||f)),e("acc_note").value=s?t(s.note||"Acconto"):"Acconto","rate"===m){var C=u.length||12;e("rt_n").value=C,e("rt_first").value=u[0]?t(l(u[0].dueDate)):t(l(r.date||f)),I(u.length?u:x())}else E(u);function D(){if(!e("acc_enable").checked)return 0;var t=Math.max(0,Number(e("m_vss").value||0)),n=e("acc_type").value,a=Number(e("acc_value").value||0);return Math.round("perc"===n?t*(a/100):a)}function k(){var t=[];if(e("acc_enable").checked){var n=D();t.push({dueDate:new Date(e("acc_date").value||f).toISOString(),amount:n,note:e("acc_note").value||"Acconto",kind:"deposit",_fromPerc:"perc"===e("acc_type").value,_rawPerc:Number(e("acc_value").value||0)})}if("rate"===document.querySelector('input[name="pmode"]:checked').value){var a=(e("rt_preview")._data||[]).map(function(e){return Object.assign({},e)});return t.concat(a)}var i=(e("mn_list")._data||[]).map(function(e){return Object.assign({kind:"manual"},e)});return t.concat(i)}function B(){var t=Math.max(0,Number(e("m_vss").value||0)),a=k(),i=Math.round(a.reduce(function(e,t){return e+Number(t.amount||0)},0));e("tot_prog").textContent="Programmato: "+n(i),e("tot_chk").textContent="Totale VSS: "+n(t)+(i===t?" OK":" (manca "+n(t-i)+")"),e("m_save").disabled=i!==t||!e("gi_client_select").value}if(e("rt_build").onclick=function(){return I(x())},e("mn_add").onclick=function(){var t=e("mn_list")._data||[];t.push({dueDate:(new Date).toISOString(),amount:0,note:"",kind:"manual"}),E(t)},e("m_close").onclick=h,["m_vss","acc_enable","acc_type","acc_value","acc_date","rt_n","rt_freq","rt_first"].forEach(function(t){var n=e(t);n&&n.addEventListener("input",B)}),e("gi_client_select").addEventListener("change",B),B(),e("m_save").onclick=function(){var t=e("gi_client_select").value||"",n=c.find(function(e){return String(e.id)===String(t)});if(n){var a={id:r.id||void 0,date:new Date(e("m_date").value||f).toISOString(),clientId:n.id,clientName:n.name,vssTotal:Math.round(Number(e("m_vss").value||0)),services:e("m_srv").value||"",schedule:k()};Promise.resolve(T("/api/gi",a)).then(function(){h(),haptic("light"),p()}).catch(function(e){logger.error(e),Y("Errore salvataggio")})}else Y("Seleziona un cliente")},r.id){var P=e("m_del");P&&(P.onclick=d(a().m(function e(){var t;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:if(confirm("Eliminare definitivamente questa vendita?")){e.n=1;break}return e.a(2);case 1:return e.p=1,e.n=2,T("/api/gi/delete",{id:r.id}).catch(function(){return T("/api/gi",{id:r.id,_delete:1})});case 2:h(),Y("Vendita eliminata"),p(),e.n=4;break;case 3:e.p=3,t=e.v,logger.error(t),Y("Errore eliminazione");case 4:return e.a(2)}},e,null,[[1,3]])})))}}function m(e){k("/api/gi?from=1900-01-01&to=2999-12-31").then(function(t){var n=(t&&t.sales||[]).find(function(t){return String(t.id)===String(e)});n?v({title:"Modifica vendita",sale:n}):Y("Vendita non trovata")})}document.addEventListener("gi:edit",function(e){var t=e&&e.detail&&e.detail.id;t&&m(t)}),e("gi_add").onclick=function(){v({title:"Nuova vendita"})},s("gi",function(){haptic("light"),p()}),(e("gi_cons")||{}).onchange=function(){haptic("light"),p()},k("/api/clients").then(function(e){return c=e&&e.clients||[],k("/api/usernames")}).then(function(n){var a=n&&n.users||[],i=e("gi_cons");i&&(i.innerHTML='<option value="">Tutti</option>'+a.map(function(e){return'<option value="'+t(String(e.id))+'">'+t(e.name)+"</option>"}).join(""))}).then(p)},window.viewHome=f,window.viewCalendar=function(){if(!_())return r();function e(e){return M(e)}if(document.title="Battle Plan â€“ Calendario",!document.getElementById("cal_dynamic_css")){var t=document.createElement("style");t.id="cal_dynamic_css",t.textContent="\n      /* ============== CALENDAR ============== */\n      #cal_container{ overflow-x:auto; -webkit-overflow-scrolling:touch; }\n      #cal_container .calendar{ min-width: 860px; }\n\n      .calendar{ display:grid; grid-template-columns: 44px repeat(7, 1fr); gap:10px; }\n      .calendar .weekLabel{ color:var(--muted); font-size:12px; display:flex; align-items:center; justify-content:center; }\n\n      .calendar .day{\n        min-height:120px; background: var(--card);\n        border:2px solid var(--hair2); border-radius:14px; padding:8px;\n        display:flex; flex-direction:column; gap:3px; overflow:hidden;\n      }\n      .calendar .day.today{\n        outline: 2px solid var(--accent);\n        box-shadow: 0 0 0 2px rgba(0,0,0,.06) inset;\n      }\n      .calendar .day .dnum{ font-weight:800; }\n      .calendar .day .small{\n        font-size:12px; line-height:1.15;\n        white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:100%;\n      }\n      .calendar .day .tag{ padding:2px 6px; border-radius:999px; border:1px solid var(--hair2); font-size:11px; align-self:flex-start; }\n      .calendar .day.busy0{ border-color:#27ae60; background:rgba(39,174,96,.08); }\n      .calendar .day.busy1{ border-color:#ff9f1a; background:rgba(255,159,26,.10); }\n      .calendar .day.busy2{ border-color:#7d1731; background:rgba(125,23,49,.12); }\n      .calendar .day.dense .small{ font-size:11px; line-height:1.1; }\n      .calendar .day.dense .tag{ transform:scale(.9); transform-origin:left top; }\n\n      @media (max-width: 900px){\n        .calendar{ grid-template-columns: 36px repeat(7, 1fr); }\n        .calendar .weekLabel{ display:flex !important; font-size:11px; }\n        .calendar .day{ min-height:92px; padding:6px; }\n        .calendar .day .dnum{ font-size:16px; }\n        .calendar .day .small{ white-space: normal !important; overflow: visible !important; text-overflow: clip !important; }\n        .calendar .day.dense .small{ font-size:clamp(9px,2.4vw,11px); }\n        .calendar .day .tag{ font-size:10px; }\n      }\n\n      .cal-filters .chip{\n        display:inline-flex; align-items:center; gap:6px;\n        padding:6px 10px; border-radius:999px; border:1px solid var(--hair2);\n      }\n    ",document.head.appendChild(t)}var n=A(N(new Date)).slice(0,7);function a(){var t=document.getElementById("cal_month").value;!function(t,n,a){Promise.all([k("/api/appointments"),k("/api/availability?from="+t+"-"+B(n)+"-01&to="+t+"-"+B(n)+"-"+B(new Date(t,n,0).getDate()))]).then(function(i){var r=i[0]&&i[0].appointments?i[0].appointments:[],o=(i[1]||{slots:[]}).slots||[],l=new Date(t,n-1,1),s=new Date(t,n,0,23,59,59,999);function d(e,t){for(var n={vss:0,vsd:0,vsdI:0,telefonate:0,appFissati:0,nncf:0,count:0},a=0;a<r.length;a++){var i=r[a],o=new Date(i.start);o>=e&&o<=t&&(n.vss+=Number(i.vss||0),n.vsd+=Number(i.vsdPersonal||0),n.vsdI+=Number(i.vsdIndiretto||0),n.telefonate+=Number(i.telefonate||0),n.appFissati+=Number(i.appFissati||0),n.nncf+=i.nncf?1:0,n.count+=1)}return n}function c(e,t,n){var a=document.getElementById("cal_results");if(a){var i=n?'<div class="right"><button id="res_reset" class="ghost">Torna al mese</button></div>':"";if(a.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center"><b>Risultati Â· '+t+"</b>"+i+'</div><div class="row" style="margin-top:8px;gap:8px;flex-wrap:wrap"><span class="chip small">VSS <b>'+Z(e.vss)+'</b></span><span class="chip small">VSD <b>'+Z(e.vsd)+'</b></span><span class="chip small">VSD ind <b>'+Z(e.vsdI)+'</b></span><span class="chip small">Tel <b>'+$(e.telefonate)+'</b></span><span class="chip small">AppFiss <b>'+$(e.appFissati)+'</b></span><span class="chip small">NNCF <b>'+$(e.nncf)+'</b></span><span class="chip small">N. app <b>'+$(e.count)+"</b></span></div>",a.style.display="block",n){var r=document.getElementById("res_reset");r&&(r.onclick=function(){c(d(l,s),g,!1)})}}}for(var u={},p=0;p<r.length;p++){var v=r[p];if(!((H=new Date(v.start))<l||H>s)){var m=A(H);u[m]||(u[m]={vss:0,vsd:0,vsdI:0,telefonate:0,appFissati:0,nncf:0,mins:0,count:0,items:[]}),u[m].vss+=Number(v.vss||0),u[m].vsd+=Number(v.vsdPersonal||0),u[m].vsdI+=Number(v.vsdIndiretto||0),u[m].telefonate+=Number(v.telefonate||0),u[m].appFissati+=Number(v.appFissati||0),u[m].nncf+=v.nncf?1:0,u[m].mins+=Number(v.durationMinutes||0),u[m].count+=1,u[m].items.push(v)}}var f=["Lun","Mar","Mer","Gio","Ven","Sab","Dom"],g=new Date(t,n-1,1).toLocaleString("it-IT",{month:"long",year:"numeric"}),h='<div class="card"><b class="neon">'+g+"</b></div>";h+='<div class="calendar">',h+='<div class="weekLabel">W</div>';for(var y=0;y<7;y++)h+='<div class="weekLabel">'+f[y]+"</div>";var w=new Date(t,n-1,1),_=(w.getDay()+6)%7,S=new Date(w);S.setDate(w.getDate()-_);for(var I=0;I<6;I++){var E=new Date(S),C="W"+F(E);h+='<div class="weekLabel" data-ws="'+A(E)+'" style="cursor:pointer">'+C+"</div>";for(var D=0;D<7;D++){var k=S.getMonth()===n-1,T=(m=A(S),u[m]||{vss:0,vsd:0,vsdI:0,telefonate:0,appFissati:0,nncf:0,mins:0,count:0,items:[]}),M=S.getDay(),N=0===M||6===M,L=!N&&o.some(function(e){return e.date===m});if(k&&a){if(a.only_free&&T.count>0){h+="<div></div>",S.setDate(S.getDate()+1);continue}if(a.only_4h&&!L){h+="<div></div>",S.setDate(S.getDate()+1);continue}}if(k){var U="";N?T.count>0&&(U="busy2"):U=0===T.count?"busy0":L?"busy1":"busy2";var O="",V=0;N&&0===T.count||(T.vss>0&&(O+='<div class="small">VSS '+Z(T.vss)+"</div>",V++),T.vsd>0&&(O+='<div class="small">VSD '+Z(T.vsd)+"</div>",V++),T.vsdI>0&&(O+='<div class="small">VSD ind '+Z(T.vsdI)+"</div>",V++),T.telefonate>0&&(O+='<div class="small">Tel '+$(T.telefonate)+"</div>",V++),T.appFissati>0&&(O+='<div class="small">AppFiss '+$(T.appFissati)+"</div>",V++),T.nncf>0&&(O+='<div class="small">NNCF '+$(T.nncf)+"</div>",V++),T.count>0&&(O+='<div class="small">App. '+$(T.count)+"</div>",V++),L&&(O+='<div class="tag" style="margin-top:4px">slot â‰¥4h</div>',V++)),h+='<div class="day '+U+(V>=3?" dense":"")+(L?" slot-free":"")+'" data-day="'+m+'" title="Settimana '+F(S)+'"><div class="dnum">'+S.getDate()+"</div>"+(O||"")+"</div>"}else h+="<div></div>";S.setDate(S.getDate()+1)}}h+="</div>",document.getElementById("cal_container").innerHTML=h,c(d(l,s),g,!1),document.querySelectorAll(".calendar .weekLabel[data-ws]").forEach(function(e){e.addEventListener("click",function(){var t=e.getAttribute("data-ws"),n=new Date(t),a=new Date(n);a.setDate(a.getDate()+6),a.setHours(23,59,59,999);var i="Settimana W"+F(n)+" Â· "+P(n)+"â€“"+P(a);c(d(n,a),i,!0)})}),document.querySelectorAll(".day[data-day]").forEach(function(t){t.addEventListener("click",function(){var n=t.getAttribute("data-day"),a=u[n]&&u[n].items?u[n].items.slice():[];a.sort(function(e,t){return new Date(e.start)-new Date(t.start)});var i=document.getElementById("cal_day_box"),r="<b>Appuntamenti del "+n.split("-").reverse().join("/")+"</b>";if(a.length){r+='<div class="row" style="margin-top:8px">';for(var l=0;l<a.length;l++){var s,d=a[l],c=' data-start="'+d.start+'" data-end="'+d.end+'" data-title="'+J(d.client||"Appuntamento")+'" ',p=String(d.type||"").toLowerCase();s=p.indexOf("mbs")>-1?"VSD ind "+Z(d.vsdIndiretto||0):p.indexOf("sottoprod")>-1?"Tel "+$(d.telefonate||0)+" Â· AppFissati "+$(d.appFissati||0):p.indexOf("formaz")>-1?"":"VSS "+Z(d.vss)+" Â· VSD "+Z(d.vsdPersonal)+" Â· NNCF "+(d.nncf?"âœ…":"â€”"),r+='<div class="card cal-app" data-aid="'+d.id+'" '+c+' style="flex:1 1 320px;cursor:pointer"><div class="small muted">'+e(d.start)+"â€“"+e(d.end)+" Â· "+J(d.type||"")+"</div><div><b>"+J(d.client||"")+"</b></div>"+(s?'<div class="small">'+s+"</div>":"")+(d.notes?'<div class="small muted">'+J(d.notes)+"</div>":"")+"</div>"}r+="</div>"}else r+='<div class="muted" style="margin-top:6px">Nessun appuntamento</div>';var v=(o||[]).filter(function(e){return e.date===n});if(v.length){r+='<div class="row" style="margin-top:8px">';for(var m=0;m<v.length;m++){var f=v[m],g="morning"===f.part?"mattina":"pomeriggio";r+='<div class="card slotBtn" data-start="'+f.start+'" data-end="'+f.end+'" style="flex:1 1 280px;cursor:pointer"><div class="small">'+g+" Â· "+e(f.start)+"â€“"+e(f.end)+"</div></div>"}r+="</div>"}if(i.style.display="block",i.innerHTML=r,i.querySelectorAll(".cal-app").forEach(function(e){e.addEventListener("click",function(t){t.stopPropagation(),b("bp_edit_aid",e.getAttribute("data-aid")),x()})}),i.querySelectorAll(".slotBtn").forEach(function(e){e.addEventListener("click",function(t){t.stopPropagation(),b("bp_prefill_slot",{start:e.getAttribute("data-start"),end:e.getAttribute("data-end")}),x(),Y("Slot precompilato negli appuntamenti")})}),window.scrollTo({top:i.getBoundingClientRect().top+window.scrollY-80,behavior:"smooth"}),"function"==typeof window.wireICSInsideDayBox)try{window.wireICSInsideDayBox()}catch(h){}})});var R=document.getElementById("cal_free_slots"),j=function(){var e=new Date;return e.getFullYear()+"-"+B(e.getMonth()+1)+"-"+B(e.getDate())}(),z=(o||[]).filter(function(e){return String(e.date||"").slice(0,10)>=j});if(z.length){var q='<b>Slot liberi â‰¥ 4h (da oggi in poi)</b> Â· <span class="badge">Tot: '+z.length+"</span>";q+='<div class="row" style="margin-top:8px">';for(var G=0;G<z.length&&G<80;G++){var H,W="morning"===(H=z[G]).part?"mattina":"pomeriggio";q+='<div class="card slotBtn" data-start="'+H.start+'" data-end="'+H.end+'" style="flex:1 1 280px;cursor:pointer"><div class="small"><b>'+P(H.start)+"</b> Â· "+W+'</div><div class="small">'+e(H.start)+"â€“"+e(H.end)+"</div></div>"}q+="</div>",R.style.display="block",R.innerHTML=q,R.querySelectorAll(".slotBtn").forEach(function(e){e.addEventListener("click",function(){b("bp_prefill_slot",{start:e.getAttribute("data-start"),end:e.getAttribute("data-end")}),x(),Y("Slot precompilato negli appuntamenti")})})}else R.style.display="block",R.innerHTML='<b>Slot liberi â‰¥ 4h (da oggi in poi)</b> Â· <span class="badge">Tot: 0</span><div class="muted" style="margin-top:6px">Nessuno slot libero disponibile.</div>';try{window.injectTodayCSS&&window.injectTodayCSS()}catch(X){}try{window.hookCalendar?window.hookCalendar():(window.markToday&&window.markToday(),window.clampSlotCounters&&window.clampSlotCounters())}catch(X){}}).catch(function(e){logger.error(e),Y("Errore calendario")})}(parseInt(t.split("-")[0],10),parseInt(t.split("-")[1],10),{only_free:document.getElementById("only_free").checked,only_4h:document.getElementById("only_4h").checked})}i.innerHTML=X()+'<div class="wrap"><div class="card"><div class="row" style="align-items:flex-end;gap:12px;flex-wrap:wrap"><div class="row" style="align-items:flex-end;gap:8px"><button id="cal_prev" class="ghost" title="Mese precedente">â—€</button><div><label>Mese</label><input type="month" id="cal_month" value="'+n+'"></div><button id="cal_next" class="ghost" title="Mese successivo">â–¶</button></div><div class="cal-filters"><label class="chip small"><input type="checkbox" id="only_free"> Solo giorni liberi</label> <label class="chip small"><input type="checkbox" id="only_4h"> Solo slot â‰¥ 4h</label></div><button id="cal_add" class="ghost">Aggiungi appuntamento</button><div class="right" style="margin-left:auto"><button id="cal_refresh" class="ghost">Aggiorna</button></div></div></div><div id="cal_container"></div><div id="cal_results" class="card" style="margin-top:8px;display:none"></div><div id="cal_day_box" class="card" style="margin-top:8px;display:none"></div><div class="card" id="cal_free_slots" style="margin-top:8px;display:none"></div></div>',K(),document.getElementById("cal_refresh").onclick=a;var o=document.getElementById("cal_add");function l(e){var t=document.getElementById("cal_month");if(t){var n=t.value.split("-"),i=+n[0],r=+n[1];(r+=e)<=0?(r=12,i--):r>12&&(r=1,i++),t.value=i+"-"+B(r),a()}}o&&(o.onclick=function(){x()}),document.getElementById("cal_month").onchange=a;var s=document.getElementById("cal_prev"),d=document.getElementById("cal_next");s&&(s.onclick=function(){l(-1)}),d&&(d.onclick=function(){l(1)}),document.getElementById("only_free").onchange=a,document.getElementById("only_4h").onchange=a,a()},window.viewPeriods=g,window.viewAppointments=x,window.viewLeaderboard=function(){if(!_())return r();function e(e){if(!e)return"";var t=new Date(e);return t.getFullYear()+"-"+("0"+(t.getMonth()+1)).slice(-2)+"-"+("0"+t.getDate()).slice(-2)}function t(){var t,i,r,o,s,c=document.getElementById("lb_tab").value,p=(i=u("lb"),r=e(i.start),o=e(i.end),s="ytd"===(t=i.type||"mensile")||"ltm"===t?"mensile":t,"&from="+encodeURIComponent(r)+"&to="+encodeURIComponent(o)+"&type="+encodeURIComponent(s)),v=document.getElementById("lb_mode").value;if("overall"===c)k("/api/leaderboard_overall?mode="+encodeURIComponent(v)+p).then(d);else{var m=document.getElementById("lb_indicator").value;k("/api/leaderboard?indicator="+encodeURIComponent(m)+"&mode="+encodeURIComponent(v)+p).then(function(e){!function(e,t){document.getElementById("lb_title").textContent="Classifica â€“ "+t;var i=e.ranking||[];if(a(i),!i.length)return void(document.getElementById("lb_table").innerHTML='<div class="muted">Nessun dato</div>');for(var r='<div class="row">',o=i[0].total||1,s=0;s<i.length;s++){var d=i[s];r+=l(n(s)+" "+d.name,"Totale: "+$(d.total),d.total/o*100)}r+="</div>",document.getElementById("lb_table").innerHTML=r}(e,m)})}}function n(e){return 0===e?"ðŸ¥‡":1===e?"ðŸ¥ˆ":2===e?"ðŸ¥‰":e+1+"."}function a(e){var t=document.getElementById("lb_podium");if(e&&e.length){for(var a=e.slice(0,3),i='<div class="row" style="align-items:flex-end">',r=0;r<a.length;r++){i+='<div class="card" style="flex:1 1 120px;height:'+(80-15*r)+'px;display:flex;align-items:flex-end;justify-content:center"><div>'+J(n(r)+" "+a[r].name)+"</div></div>"}i+="</div>",t.innerHTML=i}else t.innerHTML=""}function l(e,t,n){var a=Math.min(100,Math.max(0,Math.round(n)));return'<div class="card lb-card" style="flex:1 1 280px"><div class="big">'+J(e)+'</div><div class="small muted">'+J(t)+'</div><div class="lb-bar"><div style="width:'+a+'%"></div></div></div>'}function d(e){document.getElementById("lb_title").textContent="Classifica generale";var t=e.ranking||[];if(a(t),t.length){for(var i=t[0].score||0,r='<div class="row">',o=0;o<t.length;o++){var s=t[o];r+=l(n(o)+" "+s.name,"Score: "+$(s.score)+"/100",i?s.score/i*100:0)}r+="</div>",document.getElementById("lb_table").innerHTML=r}else document.getElementById("lb_table").innerHTML='<div class="muted">Nessun dato</div>'}document.title="Battle Plan â€“ Classifiche",i.innerHTML=X()+'<div class="wrap"><div class="card"><div class="row"><div><label>Vista</label><select id="lb_tab"><option value="per_indicator">Per indicatore</option><option value="overall">Generale (score)</option></select></div><div><label>ModalitÃ </label><select id="lb_mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div><div id="lb_ind_wrap"><label>Indicatore</label><select id="lb_indicator"><option value="VSS">VSS</option><option value="VSDPersonale">VSD</option><option value="GI">GI</option><option value="NNCF">NNCF</option></select></div></div>'+o("lb")+'</div><div class="card"><b id="lb_title">Classifica</b><div id="lb_podium" style="margin:10px 0"></div><div id="lb_table"></div></div></div>',K(),document.getElementById("lb_tab").onchange=function(){var e=this.value;document.getElementById("lb_ind_wrap").style.display="per_indicator"===e?"":"none",t()},s("lb",t),document.getElementById("lb_mode").onchange=t,document.getElementById("lb_indicator").onchange=t,t()},window.viewClients=function(){if(!_())return r();function e(){k("/api/clients").then(function(t){var n=t&&t.clients||[],a=document.getElementById("cl_f_state").value,i=document.getElementById("cl_f_cons").value;function r(e){return String(e||"").trim().toLowerCase()}var o=n.filter(function(e){return(!a||r(e.status)===r(a))&&(!i||String(e.consultantId||"")===String(i))}).map(function(e){var t=J(e.name||""),n=J(e.status||"potenziale"),a=e.consultantName?J(e.consultantName):"unknown",i=String(e.id||"");return'<div class="card" data-clid="'+i+'" data-name-lower="'+t.toLowerCase()+'" data-status="'+n+'" data-consultant-id="'+J(String(e.consultantId||""))+'" style="flex:1 1 380px"><div><b>'+t+'</b></div><div class="small">Stato: <b class="cl-status">'+n+'</b></div><div class="small">Consulente: <b class="cl-cons">'+a+'</b></div><div class="small muted">Ultimo appuntamento: <span class="last-appt">â€”</span></div><div class="right" style="margin-top:6px"><button class="ghost" data-del="'+i+'">Rimuovi</button></div></div>'}).join("");document.getElementById("cl_list").innerHTML=o||'<div class="muted">Nessun cliente</div>',document.querySelectorAll("[data-del]").forEach(function(t){t.addEventListener("click",function(){var n=t.getAttribute("data-del");confirm("Rimuovere il cliente?")&&fetch("/api/clients?id="+encodeURIComponent(n),{method:"DELETE",headers:{Authorization:"Bearer "+w()}}).then(function(e){if(!e.ok)throw new Error("HTTP "+e.status);return e.json()}).then(function(){Y("Cliente rimosso"),e()}).catch(function(e){logger.error(e),Y("Errore rimozione")})})}),window.BPFinal&&"function"==typeof BPFinal.ensureClientSection?BPFinal.ensureClientSection():setTimeout(function(){var e=document.getElementById("cl_list"),t=Array.from(e.children).filter(function(e){return e.classList.contains("card")});t.sort(function(e,t){return String(e.getAttribute("data-name-lower")||"").localeCompare(String(t.getAttribute("data-name-lower")||""))});var n,a=c(t);try{for(a.s();!(n=a.n()).done;){var i=n.value;e.appendChild(i)}}catch(r){a.e(r)}finally{a.f()}},0)})}document.title="Battle Plan â€“ Clienti",i.innerHTML=X()+'<div class="wrap"><div class="card"><b>Nuovo cliente</b><div class="row" style="margin-top:8px"><div><label>Ragione sociale</label><input id="cl_name" type="text" placeholder="Es. Rossi S.r.l."></div><div><label>Stato</label><select id="cl_new_state"><option value="potenziale">Potenziale</option><option value="lead non chiuso">Lead non chiuso</option><option value="attivo">Attivo</option></select></div><div><label>Consulente</label><select id="cl_new_owner"><option value="">â€”</option></select></div><div class="right"><button id="cl_add">Aggiungi</button></div></div></div><div class="card"><b>Filtri elenco</b><div class="row" style="margin-top:8px"><div><label>Stato</label><select id="cl_f_state"><option value="">Tutti</option><option value="attivo">Attivo</option><option value="lead non chiuso">Lead non chiuso</option><option value="potenziale">Potenziale</option></select></div><div><label>Consulente</label><select id="cl_f_cons"><option value="">Tutti</option></select></div><div><label>Ordina per</label><select id="cl_order"><option value="az">Ragione sociale (Aâ†’Z)</option><option value="last_desc">Ultimo appuntamento (recenti prima)</option></select></div><div class="right"><button class="ghost" id="cl_f_apply">Applica</button></div></div></div><div class="card"><b>Elenco clienti</b><div id="cl_list" class="row" style="margin-top:8px"></div></div></div>',K(),document.getElementById("cl_add").onclick=function(){var t=(document.getElementById("cl_name").value||"").trim();if(t){var n=document.getElementById("cl_new_state"),a=document.getElementById("cl_new_owner"),i={name:t};n&&(i.status=n.value),a&&a.value&&(i.consultantId=a.value),T("/api/clients",i).then(function(){document.getElementById("cl_name").value="",e(),W(),window.addXP(5)}).catch(function(e){logger.error(e),Y("Errore creazione cliente")})}else Y("Nome obbligatorio")},document.getElementById("cl_f_apply").onclick=e,k("/api/usernames").then(function(e){var t=e&&e.users||[],n=document.getElementById("cl_f_cons"),a=document.getElementById("cl_new_owner");n&&(n.innerHTML='<option value="">Tutti</option>'+t.map(function(e){return'<option value="'+e.id+'">'+J(e.name)+(e.grade?" ("+e.grade+")":"")+"</option>"}).join("")),a&&(a.innerHTML='<option value="">â€”</option>'+t.map(function(e){return'<option value="'+e.id+'">'+J(e.name)+(e.grade?" ("+e.grade+")":"")+"</option>"}).join(""))}).catch(function(e){logger.error(e)}),e(),"function"==typeof kickFinal&&kickFinal("clients")},window.viewTeam=function(){if(!_())return r();document.title="Battle Plan â€“ Squadra";var e=X()+'<div class="wrap"><div class="card"><b>Vista Amministratore</b><div id="t_adminbar" class="row" style="margin-top:8px;display:flex;align-items:flex-end;gap:16px;flex-wrap:wrap"><div><label>ModalitÃ </label><select id="t_mode" name="mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div><div id="t_unified_wrap">'+o("t")+'</div></div></div><div class="card"><b>Riepilogo per utente</b><div id="t_users" class="row" style="margin-top:8px"></div></div><div class="card"><b>Aggregato Squadra</b><div id="t_agg" class="row" style="margin-top:8px"></div><div class="row" style="margin-top:12px;align-items:flex-end;gap:16px;flex-wrap:wrap"><div><label>Indicatore grafico</label><select id="t_ind"><option value="VSS">VSS</option><option value="VSDPersonale">VSD Personale</option><option value="VSDIndiretto">VSD Indiretto</option><option value="VSDTotale">VSD Totale</option><option value="GI">GI</option><option value="NNCF">NNCF</option><option value="provv_gi">Provv GI</option><option value="provv_vsd">Provv VSD</option><option value="tot_provv" selected>Tot Provvigioni</option></select></div><div><label>Consulente</label><select id="t_cons"><option value="">Tutti</option></select></div></div><div style="margin-top:8px"><canvas id="t_chart" height="160"></canvas></div></div></div>';function n(e){return e=Number(e||0),isFinite(e)?e:0}function a(e){if(!e)return"";var t=new Date(e);return t.getFullYear()+"-"+("0"+(t.getMonth()+1)).slice(-2)+"-"+("0"+t.getDate()).slice(-2)}function l(){var e,t=u("t"),n=a(t.start),i=a(t.end),r=(e=t.type,0===(e=String(e||"mensile").toLowerCase()).indexOf("sett")?"settimanale":0===e.indexOf("mes")?"mensile":0===e.indexOf("tri")?"trimestrale":0===e.indexOf("sem")?"semestrale":0===e.indexOf("ann")?"annuale":"mensile");return"&from="+encodeURIComponent(n)+"&to="+encodeURIComponent(i)+"&type="+encodeURIComponent(r)}function d(e){switch(String(e)){case"provv_gi":return"ProvvGI";case"provv_vsd":return"ProvvVSD";case"tot_provv":return"TotProvvigioni";default:return e}}function c(e){return(Number(e)||0).toLocaleString("it-IT")+"â‚¬"}function p(e){var t=Number(e)||0;return String(Math.round(t))}function f(e){return String(e).replace(/[&<>'"]/g,function(e){return{"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"}[e]})}i.innerHTML=e,K(),function(){var e=document.getElementById("t_adminbar"),t=document.getElementById("t_unified_wrap");if(e&&t){var n=t.querySelector(".row");n&&(Array.from(n.children).forEach(function(t){t.classList.remove("right"),t.style.marginTop="0",e.appendChild(t)}),t.remove())}}();var g=null;function b(e,n){var a=document.getElementById("t_chart");if(a){var i=w(n),r=m(n,i),o=e.map(function(e){return e.y});if("undefined"==typeof Chart){var l=a.getContext("2d");a.width=a.clientWidth||600,a.height=a.clientHeight||160,l.clearRect(0,0,a.width,a.height);var s=Math.max.apply(Math,[1].concat(t(o))),d=o.length>1?(a.width-8)/(o.length-1):0;return l.beginPath(),l.lineWidth=2,l.strokeStyle="#2e6cff",o.forEach(function(e,t){var n=4+t*d,i=a.height-6-e/s*(a.height-12);t?l.lineTo(n,i):l.moveTo(n,i)}),l.stroke(),l.fillStyle="#2e6cff",void o.forEach(function(e,t){var n=4+t*d,i=a.height-6-e/s*(a.height-12);l.beginPath(),l.arc(n,i,2,0,2*Math.PI),l.fill()})}l=a.getContext("2d");var c="function"==typeof window.computeTickOptions?window.computeTickOptions(r,a.width||600):{autoSkip:!0,maxRotation:0,minRotation:0};if(g)g.data.labels=r,g.data.datasets[0].data=o,g.options.scales.x.ticks=c,g.update();else{var u="function"==typeof Chart.getChart?Chart.getChart(a):null;u&&u.destroy(),g=new Chart(l,{type:"line",data:{labels:r,datasets:[{label:"",data:o,tension:.3,pointRadius:3,pointHoverRadius:5}]},options:{responsive:!1,maintainAspectRatio:!1,animation:!1,animations:!1,plugins:{legend:{display:!1}},scales:{x:{grid:{display:!1},ticks:c},y:{beginAtZero:!0}}}})}}}function h(e){return'<div class="card" style="flex:1 1 360px"><div style="display:flex;align-items:center;gap:8px"><div><b>'+f(e.name||"User #"+e.userId)+"</b></div>"+(e.grade?'<span class="chip small">'+f(e.grade)+"</span>":"")+'</div><div class="small" style="margin-top:6px">VSS '+c(e.vss||0)+'</div><div class="small">VSD Pers. '+c(e.vsdP||0)+'</div><div class="small">VSD Ind. '+c(e.vsdI||0)+'</div><div class="small">VSD Tot. '+c((e.vsdP||0)+(e.vsdI||0))+'</div><div class="small">GI '+c(e.gi||0)+'</div><div class="small">NNCF '+p(e.nncf||0)+'</div><div class="small muted" style="margin-top:6px">Provv GI '+c(e.provvGi||0)+'</div><div class="small muted">Provv VSD '+c(e.provvVsd||0)+'</div><div class="small"><b>Tot Provvigioni '+c(e.provvTot||0)+"</b></div></div>"}function y(){var e=(document.getElementById("t_mode")||{}).value||"consuntivo",t=l();Promise.all([k("/api/usernames"),k("/api/leaderboard?indicator="+encodeURIComponent("VSS")+t+"&mode="+encodeURIComponent(e)),k("/api/leaderboard?indicator="+encodeURIComponent("VSDPersonale")+t+"&mode="+encodeURIComponent(e)),k("/api/leaderboard?indicator="+encodeURIComponent("VSDIndiretto")+t+"&mode="+encodeURIComponent(e)),k("/api/leaderboard?indicator="+encodeURIComponent("GI")+t+"&mode="+encodeURIComponent(e)),k("/api/leaderboard?indicator="+encodeURIComponent("NNCF")+t+"&mode="+encodeURIComponent(e)),k("/api/leaderboard?indicator="+encodeURIComponent("ProvvGI")+t+"&mode="+encodeURIComponent(e)),k("/api/leaderboard?indicator="+encodeURIComponent("ProvvVSD")+t+"&mode="+encodeURIComponent(e))]).then(function(e){var t=e[0]||{},a=e[1]&&(e[1].rows||e[1].ranking)||[],i=e[2]&&(e[2].rows||e[2].ranking)||[],r=e[3]&&(e[3].rows||e[3].ranking)||[],o=e[4]&&(e[4].rows||e[4].ranking)||[],l=e[5]&&(e[5].rows||e[5].ranking)||[],s=e[6]&&(e[6].rows||e[6].ranking)||[],d=e[7]&&(e[7].rows||e[7].ranking)||[],u=(t.users||[]).map(function(e){return{id:String(e.id),name:e.name||e.email||"User #"+e.id,grade:"senior"===e.grade?"senior":"junior"}}),v=document.getElementById("t_cons");function m(e){for(var t={},a=0;a<e.length;a++){var i=e[a],r=String(i.userId||i.id||i.uid||""),o=n(i.total||i.value||i.sum||0);r&&(t[r]=o)}return t}v&&(v.innerHTML='<option value="">Tutti</option>'+u.map(function(e){return'<option value="'+e.id+'">'+f(e.name)+"</option>"}).join(""));var g=m(a),b=m(i),y=m(r),w=m(o),_=m(l),x=m(s),I=m(d),E=u.map(function(e){var t=n(g[e.id]),a=n(b[e.id]),i=n(y[e.id]),r=n(w[e.id]),o=n(_[e.id]),l=n(x[e.id]),s=n(I[e.id]);return{userId:e.id,name:e.name,grade:e.grade,vss:t,vsdP:a,vsdI:i,gi:r,nncf:o,provvGi:l,provvVsd:s,provvTot:l+s}}),C=document.getElementById("t_users");C&&(C.innerHTML=E.length?E.map(h).join(""):'<div class="muted">Nessun dato</div>');var D=E.reduce(function(e,t){return e.vss+=t.vss,e.vsdP+=t.vsdP,e.vsdI+=t.vsdI,e.gi+=t.gi,e.nncf+=t.nncf,e.provvGi+=t.provvGi,e.provvVsd+=t.provvVsd,e.provvTot+=t.provvTot,e},{vss:0,vsdP:0,vsdI:0,gi:0,nncf:0,provvGi:0,provvVsd:0,provvTot:0}),k=document.getElementById("t_agg");k&&(k.innerHTML=function(e){return'<div class="card" style="flex:1 1 460px"><div class="neon" style="font-weight:900">Totali squadra</div><div class="small" style="margin-top:6px">VSS '+c(e.vss)+'</div><div class="small">VSD Pers. '+c(e.vsdP)+'</div><div class="small">VSD Ind. '+c(e.vsdI)+'</div><div class="small">VSD Tot. '+c(e.vsdP+e.vsdI)+'</div><div class="small">GI '+c(e.gi)+'</div><div class="small">NNCF '+p(e.nncf)+'</div><div class="small muted" style="margin-top:6px">Provv GI '+c(e.provvGi)+'</div><div class="small muted">Provv VSD '+c(e.provvVsd)+'</div><div class="small"><b>Tot Provvigioni '+c(e.provvTot)+"</b></div></div>"}(D)),S()}).catch(function(e){logger.error(e),Y("Errore caricamento squadra")})}function w(e){return v(e,new Date).map(function(e){return{s:e.s,e:e.e}})}function S(){var e=document.getElementById("t_ind").value,t=document.getElementById("t_mode").value||"consuntivo",n=document.getElementById("t_cons").value||"",i=u("t"),r=i.type,o=d(e);l(),n&&encodeURIComponent(n),encodeURIComponent(o),encodeURIComponent(t);var s=function(e,t,n,i){var r=i||u("t"),o=String(r.type||"mensile").toLowerCase(),l="ytd"===o||"ltm"===o?"mensile":o,s=w(o);function c(e,t){var n=new Date(t.startDate).getTime(),a=new Date(t.endDate).getTime();return n>=e.s&&a<=e.e}function p(e,t){if(!e)return 0;if("VSDTotale"===t)return Number(e.VSDPersonale||0)+Number(e.VSDIndiretto||0);if("ProvvGI"===t)return Number(e.ProvvGI||0);if("ProvvVSD"===t)return Number(e.ProvvVSD||0);if("TotProvvigioni"===t){var n=e.TotProvvigioni;return Number(null!=n?n:Number(e.ProvvGI||0)+Number(e.ProvvVSD||0))}return Number(e[t]||0)}var v,m,f,g=(v=s.length?a(new Date(s[0].s)):a(new Date),m=s.length?a(new Date(s[s.length-1].e)):a(new Date),f="?global=1&type="+encodeURIComponent(l)+"&from="+encodeURIComponent(v)+"&to="+encodeURIComponent(m),n&&(f+="&userId="+encodeURIComponent(n)),f);return k("/api/periods"+g).catch(function(){return k("/api/periods"+g.replace("?global=1",""))}).then(function(a){var i=(a&&a.periods||[]).filter(function(e){return e.type===l&&(!n||String(e.userId||e.uid||"")===String(n))});return s.map(function(n){for(var a=0,r=0;r<i.length;r++){var o=i[r];c(n,o)&&(a+=p("previsionale"===t?o.indicatorsPrev||{}:o.indicatorsCons||{},d(e)))}return{x:new Date(n.s),y:Math.round(100*a)/100}})})}(o,t,n||null,i);s.then(function(e){b(e,r)}).catch(function(e){logger.error(e),b([],r)})}s("t",function(){"function"==typeof haptic&&haptic("light"),y()}),document.getElementById("t_mode").onchange=function(){"function"==typeof haptic&&haptic("light"),y()},document.getElementById("t_ind").onchange=function(){"function"==typeof haptic&&haptic("light"),S()},document.getElementById("t_cons").onchange=function(){"function"==typeof haptic&&haptic("light"),S()},y()},window.viewCommissions=function(){if(!_())return r();var e="admin"===_().role;function t(e){return document.getElementById(e)}function n(e){if(!e)return"";var t=new Date(e);return t.getFullYear()+"-"+("0"+(t.getMonth()+1)).slice(-2)+"-"+("0"+t.getDate()).slice(-2)}function a(e){return(Number(e)||0).toLocaleString("it-IT")+"â‚¬"}function l(e){return e=Number(null==e?"":e),isFinite(e)?e:0}function d(e,t){return'<div class="card" style="flex:1 1 180px"><div class="small muted">'+J(e)+'</div><div style="font-weight:700; font-size:20px; margin-top:4px">'+t+"</div></div>"}function c(){var i,r,o,s=u("comm"),c=t("comm_mode").value||"consuntivo",v=e?t("comm_user").value||"__all":String(_().id),m=new Date(s.start).getTime(),f=new Date(s.end).getTime(),g=p(s.type||"mensile");k("/api/periods"+(i=n(new Date(m)),r=n(new Date(f)),o="?type="+encodeURIComponent(g)+"&from="+encodeURIComponent(i)+"&to="+encodeURIComponent(r),e&&v&&"__all"!==v&&(o+="&userId="+encodeURIComponent(v)),o)).then(function(n){var i,r,o=(n&&n.periods||[]).filter(function(t){if(t.type!==g)return!1;var n=new Date(t.startDate).getTime(),a=new Date(t.endDate).getTime();return!(n<m||a>f)&&((!e||"__all"===v||String(t.userId||t.uid||"")===String(v))&&!(!e&&String(t.userId||t.uid||"")!==String(_().id)))}),s={gi:0,vsd:0,provv_gi:0,provv_vsd:0,provv_total:0},u={};o.forEach(function(e){var t="previsionale"===c?e.indicatorsPrev||{}:e.indicatorsCons||{},n=String(e.userId||e.uid||""),a=e.userName||e.name||"User "+n,i=l(t.GI),r=l(t.VSDPersonale),o=l(t.ProvvGI),d=l(t.ProvvVSD),p=function(e){return e?null!=e.TotProvvigioni?l(e.TotProvvigioni):l(e.ProvvGI)+l(e.ProvvVSD):0}(t);s.gi+=i,s.vsd+=r,s.provv_gi+=o,s.provv_vsd+=d,s.provv_total+=p,u[n]||(u[n]={userId:n,name:a,gi:0,vsd:0,provv_gi:0,provv_vsd:0,provv_total:0}),u[n].gi+=i,u[n].vsd+=r,u[n].provv_gi+=o,u[n].provv_vsd+=d,u[n].provv_total+=p}),t("comm_total").innerHTML=""+d("VSD personale",a((i=s).vsd||0))+d("GI",a(i.gi||0))+d("Provv. VSD",a(i.provv_vsd||0))+d("Provv. GI",a(i.provv_gi||0))+d("Totale Provvigioni",a(i.provv_total||0)),t("comm_rows").innerHTML=(r=Object.values(u).sort(function(e,t){return(t.provv_total||0)-(e.provv_total||0)})).length?r.map(function(e){return'<div class="card" style="flex:1 1 320px"><div><b>'+J(e.name)+'</b></div><div class="small" style="margin-top:4px">GI '+a(e.gi||0)+" Â· VSD "+a(e.vsd||0)+'</div><div class="small muted" style="margin-top:2px">Provv. GI '+a(e.provv_gi||0)+" Â· Provv. VSD "+a(e.provv_vsd||0)+'</div><div class="small" style="margin-top:6px"><b>Totale: '+a(e.provv_total||0)+"</b></div></div>"}).join(""):'<div class="muted">Nessun dato</div>',function(e,t,n){var i=document.getElementById("cm_pie_provv"),r=document.getElementById("cm_pie_legend");if(i&&i.getContext){var o=i.getContext("2d"),l=i.width,s=i.height,d=l/2,c=s/2,u=Math.min(l,s)/2-8;o.clearRect(0,0,l,s);var p=Math.max(0,e||0),v=Math.max(0,t||0),m=p+v,f=n>0?Math.round(m/n*100):null;if(m<=0)return o.beginPath(),o.arc(d,c,u,0,2*Math.PI),o.strokeStyle="#ccd0d5",o.lineWidth=10,o.setLineDash([6,6]),o.stroke(),o.setLineDash([]),o.globalCompositeOperation="destination-out",o.beginPath(),o.arc(d,c,.55*u,0,2*Math.PI),o.fill(),o.globalCompositeOperation="source-over",o.fillStyle="#111",o.textAlign="center",o.textBaseline="middle",o.font="bold 20px system-ui, -apple-system, Segoe UI, Roboto, sans-serif",o.fillText(null==f?"â€”":f+"%",d,c),void(r&&(r.innerHTML='<div class="muted">Nessuna provvigione nel periodo</div>'));var g=[{label:"Provv. GI",value:p,color:"#4F8EF7"},{label:"Provv. VSD",value:v,color:"#F79F4F"}],b=-Math.PI/2;g.forEach(function(e){var t=e.value/m*Math.PI*2;o.beginPath(),o.moveTo(d,c),o.arc(d,c,u,b,b+t),o.closePath(),o.fillStyle=e.color,o.fill(),b+=t}),o.globalCompositeOperation="destination-out",o.beginPath(),o.arc(d,c,.55*u,0,2*Math.PI),o.fill(),o.globalCompositeOperation="source-over",o.fillStyle="#111",o.textAlign="center",o.textBaseline="middle",o.font="bold 20px system-ui, -apple-system, Segoe UI, Roboto, sans-serif",o.fillText(null==f?"â€”":f+"%",d,c);var h=Math.round(p/m*100),y=Math.round(v/m*100);r&&(r.innerHTML='<div class="row" style="gap:16px; flex-wrap:wrap"><div class="row" style="gap:8px; align-items:center"><span style="display:inline-block;width:12px;height:12px;background:#4F8EF7;border-radius:3px"></span><span><b>Provv. GI</b> '+a(p)+" Â· "+h+'%</span></div><div class="row" style="gap:8px; align-items:center"><span style="display:inline-block;width:12px;height:12px;background:#F79F4F;border-radius:3px"></span><span><b>Provv. VSD</b> '+a(v)+" Â· "+y+"%</span></div></div>")}else r&&(r.innerHTML="")}(s.provv_gi||0,s.provv_vsd||0,s.gi||0)}).catch(function(e){logger.error(e),Y("Errore nel caricamento dati")})}document.title="Battle Plan â€“ Provvigioni",i.innerHTML=X()+'<div class="wrap"><div class="card"><b>Calcolo provvigioni</b><div class="row" style="margin-top:8px; gap:12px; flex-wrap:wrap">'+(e?'<div><label>Utente</label><select id="comm_user"><option value="__all">Tutta la squadra</option></select></div>':"")+'<div><label>ModalitÃ </label><select id="comm_mode" name="mode"><option value="consuntivo">Consuntivo</option><option value="previsionale">Previsionale</option></select></div></div>'+o("comm")+'</div><div class="card"><b>Indicatori periodo</b><div id="comm_total" class="row" style="margin-top:8px; gap:12px; flex-wrap:wrap"></div></div><div class="card"><b>Provvigioni â€“ ripartizione</b><div class="small muted">Confronto tra Provvigioni GI e Provvigioni VSD sul periodo selezionato</div><div class="row" style="margin-top:8px; align-items:center; gap:16px; flex-wrap:wrap"><canvas id="cm_pie_provv" width="260" height="260" style="max-width:260px; max-height:260px"></canvas><div id="cm_pie_legend" class="small"></div></div></div><div class="card"><b>Dettaglio</b><div id="comm_rows" class="row" style="margin-top:8px; gap:12px; flex-wrap:wrap"></div></div></div>',K(),s("comm",function(){c()}),t("comm_mode").onchange=function(){haptic("light"),c()},e&&(t("comm_user").onchange=function(){haptic("light"),c()}),e&&k("/api/usernames").then(function(e){var n=t("comm_user");if(n){for(var a='<option value="__all">Tutta la squadra</option>',i=e&&e.users||[],r=0;r<i.length;r++){var o=i[r];a+='<option value="'+o.id+'">'+J(o.name||"User "+o.id)+"</option>"}n.innerHTML=a}}),c()},window.viewVendite=function(){if(!_())return r();document.title="Battle Plan â€“ Vendite e Riordini",i.innerHTML=X()+'\n    <div class="wrap">\n\n      <div class="card">\n        <b>Filtro</b>\n        <div class="row" style="margin-top:6px;align-items:flex-end;gap:16px;flex-wrap:wrap">\n          <div>\n            <label>Consulente</label>\n            <select id="vr_cons"><option value="">Tutti</option></select>\n          </div>\n        </div>\n        '.concat(o("vr"),'\n      </div>\n\n      <div class="card">\n        <b>Vendite e Riordini</b>\n        <div class="table" style="overflow:auto">\n          <table class="simple" style="min-width:980px">\n            <thead>\n              <tr>\n                <th>Data</th>\n                <th>Cliente</th>\n                <th>Consulente</th>\n              </tr>\n            </thead>\n            <tbody id="vr_rows">\n              <tr><td colspan="3" class="muted">Nessun dato</td></tr>\n            </tbody>\n          </table>\n        </div>\n      </div>\n\n    </div>'),K(),s("vr",function(){})},window.viewReport=function(){if(!_())return r();document.title="Battle Plan â€“ Report",i.innerHTML=X()+'<div class="wrap"><div class="card"><b>Sezioni da includere</b><div id="rep_toggles" class="row" style="margin-top:8px; gap:8px; flex-wrap:wrap"><button class="pill" data-type="mensile" id="tog_mese">Mese</button><button class="pill" data-type="trimestrale" id="tog_trimestre">Trimestre</button><button class="pill" data-type="semestrale" id="tog_semestre">Semestre</button><button class="pill" data-type="annuale" id="tog_anno">Anno</button></div></div><div class="card"><b>Report</b><div class="row" style="margin-top:8px"><div style="min-width:320px"><label>Oggetto email</label><input id="report_subject" placeholder="Report BP"></div></div><div class="row" style="margin-top:8px; flex-wrap:wrap"><div style="flex:1 1 100%; min-width:0"><label>Corpo email</label><textarea id="report_body" rows="12" placeholder="Testo del reportâ€¦" style="width:100%; box-sizing:border-box; overflow:auto; resize:vertical; max-height:70vh; white-space:pre-wrap; word-break:break-word"></textarea></div></div><div class="row" id="report-actions" style="gap:8px;margin-top:8px;flex-wrap:wrap"><button class="ghost" id="rep_copy">Copia report</button><span style="flex:0 0 8px"></span><button class="ghost" id="rep_gmail_web">Gmail Web</button><button class="ghost" id="rep_gmail_app">Gmail App</button></div></div></div>',K();var e=[],t={mensile:!1,trimestrale:!1,semestrale:!1,annuale:!1},n=[{k:"VSS",money:!0,label:"VSS"},{k:"VSDPersonale",money:!0,label:"VSDPersonale"},{k:"VSDIndiretto",money:!0,label:"VSDIndiretto"},{k:"GI",money:!0,label:"GI"},{k:"Telefonate",money:!1,label:"Telefonate"},{k:"AppFissati",money:!1,label:"AppFissati"},{k:"AppFatti",money:!1,label:"AppFatti"},{k:"CorsiLeadership",money:!1,label:"CorsiLeadership"},{k:"iProfile",money:!1,label:"iProfile"},{k:"MBS",money:!1,label:"MBS"},{k:"NNCF",money:!1,label:"NNCF"}];function a(e){return document.getElementById(e)}var o=a("report_body");function l(e,t){var n=new Date(e.getTime());return n.setDate(n.getDate()+t),n}function s(e){return q(e.getFullYear(),F(e))}function d(e){return["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"][e.getMonth()]}function c(e){return Math.floor(e.getMonth()/3)+1}function u(e){return e.getMonth()<6?1:2}function p(e,t){return"mensile"===e?{start:N(t),end:L(t)}:"trimestrale"===e?{start:U(t),end:O(t)}:"semestrale"===e?{start:V(t),end:R(t)}:{start:j(t),end:z(t)}}function v(e,t){return t>=l(e,-7)&&t<=l(e,5)}function m(t,n,a){for(var i=0;i<e.length;i++){var r=e[i];if(r.type===t&&(A(r.startDate)===A(n)&&A(r.endDate)===A(a)))return r}return null}function f(e,t){var n=e&&e[t];return Number(n||0)}function g(e,t){return n.some(function(t){return t.k===e&&t.money})?function(e){return $(e)+"â‚¬"}(t):$(t)}function b(e,t,a,i){var r=m(t,a,i)||{},o=r.indicatorsPrev||{},l=r.indicatorsCons||{},s=[e,""];return n.forEach(function(e){var t=f(o,e.k),n=f(l,e.k);s.push(e.label+" "+g(e.k,n)+" vs "+g(e.k,t)+" di previsionali ("+function(e,t){return e>t?"â†‘":e<t?"â†“":"="}(n,t)+")")}),s.push("Note:"),s.join("\n")}function h(e,t,a,i){var r=(m(t,a,i)||{}).indicatorsPrev||{},o=[e,""];return n.forEach(function(e){o.push(e.label+" "+g(e.k,f(r,e.k)))}),o.push("Possibili note:"),o.join("\n")}function y(e){return"BP CONSUNTIVO "+d(e)+" "+e.getFullYear()}function w(e){return"BP PREVISIONALE "+d(e)+" "+e.getFullYear()}function S(e){return"BP CONSUNTIVO T"+c(e)+" "+e.getFullYear()}function x(e){return"BP PREVISIONALE T"+c(e)+" "+e.getFullYear()}function I(e){return"BP CONSUNTIVO S"+u(e)+" "+e.getFullYear()}function E(e){return"BP PREVISIONALE S"+u(e)+" "+e.getFullYear()}function C(e){return"BP CONSUNTIVO "+e.getFullYear()}function D(e){return"BP PREVISIONALE "+e.getFullYear()}function T(){var e,n=new Date,a=[];if(function(e){var t=e.getDay();return 5===t||6===t||0===t}(n)){var i=s(n),r=function(e){var t=s(e);return s(l(t.start,7))}(n);a.push(b("BP CONSUNTIVO SETT. "+F(e=i.start)+" "+e.getFullYear(),"settimanale",i.start,i.end)),a.push(h(function(e){return"BP PREVISIONALE SETT. "+F(e)+" "+e.getFullYear()}(r.start),"settimanale",r.start,r.end))}function d(e,t,i){var r=function(e,t){var n=p(e,t),a=p(e,l(n.start,-1)),i=p(e,l(n.end,1)),r=v(a.end,t),o=v(n.end,t);return r&&!o?{closing:a,next:n}:{closing:n,next:i}}(e,n);a.push(b(t(r.closing.start),e,r.closing.start,r.closing.end)),a.push(h(i(r.next.start),e,r.next.start,r.next.end))}t.mensile&&d("mensile",y,w),t.trimestrale&&d("trimestrale",S,x),t.semestrale&&d("semestrale",I,E),t.annuale&&d("annuale",C,D),o.value=a.join("\n\n")+(a.length?"\n":"")}function B(e,t){e.classList.toggle("active",!!t),e.style.opacity=t?"1":"0.65"}function P(){B(a("tog_mese"),t.mensile),B(a("tog_trimestre"),t.trimestrale),B(a("tog_semestre"),t.semestrale),B(a("tog_anno"),t.annuale)}function M(e){return encodeURIComponent(String(e||""))}k("/api/periods").then(function(n){var i,r,s;e=n&&n.periods||[],function(){var e=new Date;function n(t){var n=p(t,e),a=p(t,l(n.start,-1));return v(n.end,e)||v(a.end,e)}t.mensile=n("mensile"),t.trimestrale=n("trimestrale"),t.semestrale=n("semestrale"),t.annuale=n("annuale"),P()}(),function(){function e(e){var n=e.currentTarget.getAttribute("data-type");t[n]=!t[n],P(),T()}a("tog_mese").onclick=e,a("tog_trimestre").onclick=e,a("tog_semestre").onclick=e,a("tog_anno").onclick=e}(),T(),i=a("rep_gmail_web"),r=a("rep_gmail_app"),(s=a("rep_copy"))&&(s.onclick=function(){try{navigator.clipboard.writeText(o.value||"");var e=s.textContent;s.textContent="Copiato!",setTimeout(function(){s.textContent=e},1200)}catch(t){}}),i&&r&&k("/api/users_emails").then(function(e){var t=(e&&e.emails||(e&&e.users||[]).map(function(e){return e.email})).filter(Boolean).join(",");function n(){return a("report_subject").value||"Report BP"}function l(){return o.value||""}i.onclick=function(){try{navigator.clipboard.writeText(l())}catch(a){}var e="https://mail.google.com/mail/?view=cm&fs=1&tf=1&su="+M(n())+"&cc="+M(t)+"&body="+M(l());window.open(e,"_blank"),document.dispatchEvent(new Event("report:composed"))},r.onclick=function(){try{navigator.clipboard.writeText(l())}catch(a){}var e="googlegmail:///co?subject="+M(n())+"&cc="+M(t)+"&body="+M(l());location.href=e,document.dispatchEvent(new Event("report:composed")),setTimeout(function(){document.hidden||(location.href="mailto:?subject="+M(n())+"&cc="+M(t)+"&body="+M(l()),document.dispatchEvent(new Event("report:composed")))},1200)}})})},window.viewUsers=function(){var e=_();if(!e)return r();if(document.title="Battle Plan â€“ Utenti","admin"!==e.role)return i.innerHTML=X()+'<div class="wrap"><div class="card"><b>Il mio profilo</b><div class="row" style="margin-top:8px"><div><label>Nome</label><input id="p_name" type="text" value="'+J(e.name||"")+'"></div><div><label>Email</label><input id="p_email" type="email" value="'+J(e.email||"")+'"></div></div><div class="row"><div><label>Nuova password</label><input id="p_pwd" type="password" placeholder="Lascia vuoto per non cambiare"></div><div class="right" style="align-self:flex-end"><button id="p_save">Aggiorna</button></div></div><div class="row"><div><label>Ruolo</label><input value="'+J(e.role||"consultant")+'" disabled></div><div><label>Grade</label><input value="'+J(e.grade||"junior")+'" disabled></div></div></div></div>',K(),void(ae("#p_save").onclick=function(){var t=ae("#p_name").value.trim(),n=ae("#p_email").value.trim(),a=ae("#p_pwd").value,i={id:e.id,name:t,email:n};a&&(i.password=a),T("/api/users",i).then(function(){Y("Profilo aggiornato"),window.addXP(3);var e=_();e&&(e.name=t,e.email=n,localStorage.setItem("user",JSON.stringify(e)));try{document.dispatchEvent(new Event("user:profile-updated"))}catch(a){}}).catch(function(e){logger.error(e),Y("Errore aggiornamento")})});function t(e){var t=J(e.name||e.email||"user_"+e.id),n="senior"===e.grade?"senior":"junior",a="admin"===e.role?"admin":"consultant";return'<div class="card" style="flex:1 1 380px"><div><b>'+t+'</b> <span class="small muted">('+J(a)+')</span></div><div class="row" style="margin-top:6px"><div><label>Nome</label><input data-nfor="'+e.id+'" type="text" value="'+J(e.name||"")+'"></div><div><label>Email</label><input data-efor="'+e.id+'" type="email" value="'+J(e.email||"")+'"></div></div><div class="row"><div><label>Nuova password</label><input data-pfor="'+e.id+'" type="password" placeholder="(opzionale)"></div><div><label>Grade</label><select data-gfor="'+e.id+'"><option value="junior"'+("junior"===n?" selected":"")+'>Junior</option><option value="senior"'+("senior"===n?" selected":"")+'>Senior</option></select></div><div><label>Ruolo</label><select data-rfor="'+e.id+'"><option value="consultant"'+("consultant"===a?" selected":"")+'>Consulente</option><option value="admin"'+("admin"===a?" selected":"")+'>Admin</option></select></div><div class="right" style="align-self:flex-end"><button class="ghost" data-save="'+e.id+'">Aggiorna</button> <button class="danger" data-del="'+e.id+'" title="Elimina utente">Elimina</button></div></div></div>'}i.innerHTML=X()+'<div class="wrap"><div class="card"><b>Gestione utenti</b><div id="users_list" class="row" style="margin-top:8px"></div></div></div>',K(),function e(){k("/api/users").then(function(n){var a=n&&n.users||[],i=ae("#users_list");i&&(i.innerHTML=a.map(t).join(""),ie("[data-save]").forEach(function(e){e.addEventListener("click",function(){var t=e.getAttribute("data-save"),n=(ae('input[data-nfor="'+t+'"]')||{}).value||"",a=(ae('input[data-efor="'+t+'"]')||{}).value||"",i=(ae('select[data-gfor="'+t+'"]')||{}).value||"junior",r=(ae('select[data-rfor="'+t+'"]')||{}).value||"consultant",o=ae('input[data-pfor="'+t+'"]'),l=o?o.value:"",s={id:t,name:n,email:a,grade:i,role:r};l&&(s.password=l),T("/api/users",s).then(function(){Y("Aggiornato"),window.addXP(5),o&&(o.value="")}).catch(function(e){logger.error(e),Y("Errore aggiornamento")})})}),ie("[data-del]").forEach(function(t){t.addEventListener("click",function(){var n=t.getAttribute("data-del");confirm("Eliminare definitivamente questo utente?")&&fetch("/api/users?id="+encodeURIComponent(n),{method:"DELETE",headers:{Authorization:"Bearer "+w()}}).then(function(e){if(!e.ok)throw new Error("HTTP "+e.status);return e.json()}).then(function(){Y("Utente eliminato"),e()}).catch(function(e){logger.error(e),Y("Errore eliminazione")})})}))})}()},window.toggleDrawer=ee,window.logout=S,window.rerenderTopbarSoon=ne,document.addEventListener("DOMContentLoaded",function(){_()?(K(),f()):r()})}()}}})}();
